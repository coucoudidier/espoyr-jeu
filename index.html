 <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># ESPOYR Multijoueur V3 - Comptabilit√© Bancaire BCE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --green: #10b981; --green-dark: #059669;
            --orange: #f59e0b; --red: #ef4444;
            --blue: #3b82f6; --purple: #8b5cf6; --gray: #6b7280;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            min-height: 100vh; padding: 10px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .card {
            background: white; border-radius: 16px;
            padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        h1 { color: var(--green); text-align: center; margin-bottom: 8px; font-size: 1.8rem; }
        h2 { color: var(--green-dark); margin-bottom: 12px; font-size: 1.2rem; }
        .subtitle { text-align: center; color: var(--gray); margin-bottom: 20px; font-size: 0.9rem; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 10px;
            font-size: 0.95rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: linear-gradient(135deg, var(--green), var(--green-dark)); color: white; }
        .btn-secondary { background: linear-gradient(135deg, var(--blue), #2563eb); color: white; }
        .btn-orange { background: linear-gradient(135deg, var(--orange), #d97706); color: white; }
        .btn-full { width: 100%; justify-content: center; }
        input, select {
            width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb;
            border-radius: 10px; font-size: 1rem; margin-bottom: 12px;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: inner-spin-button;
            opacity: 1;
            height: 30px;
            cursor: pointer;
        }
        input:focus, select:focus { outline: none; border-color: var(--green); }
        .code-display {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 3px solid var(--orange); border-radius: 12px;
            padding: 15px; text-align: center; margin: 15px 0;
        }
        .code-display .code {
            font-size: 2rem; font-weight: bold; color: #92400e;
            letter-spacing: 6px; font-family: monospace;
        }
        .players-list { display: flex; flex-direction: column; gap: 8px; margin: 10px 0; }
        .player-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; background: #f3f4f6;
            border-radius: 10px; font-size: 0.9rem;
        }
        .player-item.me { background: #dcfce7; border: 2px solid var(--green); }
        .player-item.current-turn {
            background: #fef3c7; border: 2px solid var(--orange);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
        }
        .player-avatar { font-size: 1.5rem; }
        /* Robots: style distinct pour ne pas √™tre confondus avec les humains */
        .player-item.bot {
            background: #f3f4f6;
            border-color: #9ca3af;
        }
        .bot-badge {
            display: inline-block;
            margin-left: 6px;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 700;
            background: #111827;
            color: #ffffff;
            vertical-align: middle;
        }
        .player-info { flex: 1; }
        .player-name { font-weight: 600; color: #1f2937; }
        .player-stats { font-size: 0.8rem; color: var(--gray); }
        .player-badge { padding: 3px 8px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
        .badge-host { background: var(--purple); color: white; }
        .badge-ready { background: var(--green); color: white; }
        
        /* PLATEAU */
        .board-container {
            display: flex; flex-wrap: wrap; gap: 6px; justify-content: center;
            padding: 10px; background: #f9fafb; border-radius: 12px; margin: 10px 0;
        }
       .case {
            width: calc(14.28% - 6px); min-width: 70px; max-width: 90px;
            aspect-ratio: 1; background: white; border: none;
            border-radius: 8px; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start; padding-top: 4px; font-size: 0.65rem;
            position: relative; cursor: pointer; transition: all 0.2s;
        }
        .case:hover { transform: scale(1.08); box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10; }
        .case.start { background: linear-gradient(135deg, #dcfce7, #bbf7d0); }
        .case.activite { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #d97706; }
        .case.activite.owned { border-width: 3px; border-color: #059669; }
        .case.chance { background: linear-gradient(135deg, #dbeafe, #bfdbfe); }
        .case.frais { background: linear-gradient(135deg, #fee2e2, #fecaca); }
        .case.taxe { background: linear-gradient(135deg, #f3e8ff, #e9d5ff); }
        .case.malchance { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .case.ligne2 { background: linear-gradient(135deg, #fce7f3, #fbcfe8); }
        .case-number { position: absolute; top: 2px; left: 4px; font-size: 0.55rem; color: #9ca3af; font-weight: bold; }
     .case-icon { font-size: 1.3rem; margin-top: -2px; }
        .case-name { font-size: 0.55rem; text-align: center; color: #4b5563; line-height: 1; margin: 0; }
        .case-price { font-size: 0.5rem; color: var(--green-dark); font-weight: bold; margin: 0; }
        .case-hash {
            position: absolute; top: 2px; right: 3px; background: var(--green);
            color: white; font-size: 0.5rem; padding: 1px 3px; border-radius: 3px; font-weight: bold;
        }
        .players-on-case {
            position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 3px;
        }
        .player-marker {
            width: 16px; height: 16px; border-radius: 50%;
            border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .owner-indicator { position: absolute; bottom: 2px; right: 2px; font-size: 0.6rem; }
        .case.current {
            transform: scale(1.08);
            box-shadow: 0 0 30px rgba(245,158,11,0.8), 0 0 60px rgba(245,158,11,0.4);
            border: 3px solid var(--orange) !important;
            z-index: 10;
            animation: casePulse 0.3s ease-in-out;
        }
        .case.passing {
            animation: casePass 0.15s ease-in-out;
            z-index: 5;
        }
        @keyframes casePass {
            0% { transform: scale(1); }
            50% { transform: scale(0.85); box-shadow: 0 0 15px rgba(59,130,246,0.6); }
            100% { transform: scale(1); }
        }
        @keyframes casePulse {
            0% { transform: scale(1); box-shadow: 0 0 10px rgba(245,158,11,0.3); }
            50% { transform: scale(1.12); box-shadow: 0 0 40px rgba(245,158,11,1); }
            100% { transform: scale(1.08); box-shadow: 0 0 30px rgba(245,158,11,0.8); }
        }
        
        /* LAYOUT JEU */
        .game-layout { display: grid; grid-template-columns: 1fr 300px; gap: 15px; }
        @media (max-width: 900px) {
            .game-layout { grid-template-columns: 1fr; }
            .case { width: calc(16.66% - 6px); min-width: 55px; }
        }
        
        .dice-area { text-align: center; padding: 15px; background: #f9fafb; border-radius: 12px; margin: 10px 0; }
        .my-balance-bar {
            display: flex; justify-content: center; gap: 16px; align-items: center;
            padding: 8px 14px; margin-bottom: 8px; border-radius: 10px;
            background: linear-gradient(135deg, #f0fdf4, #ecfdf5);
            border: 2px solid #bbf7d0;
            font-size: 1.1rem; font-weight: 700;
            transition: all 0.3s ease;
        }
        .my-balance-bar .bal-euro { color: #1e40af; }
        .my-balance-bar .bal-hash { color: #059669; }
        .my-balance-bar.flash-green {
            animation: balanceFlashGreen 1.2s ease-out;
        }
        .my-balance-bar.flash-red {
            animation: balanceFlashRed 1.2s ease-out;
        }
        .my-balance-bar .bal-delta {
            font-size: 0.85rem; font-weight: 600;
            animation: deltaFloat 1.5s ease-out forwards;
            position: absolute; top: -18px; right: 10px;
            pointer-events: none;
        }
        @keyframes balanceFlashGreen {
            0% { background: #22c55e; border-color: #16a34a; transform: scale(1.05); }
            30% { background: #86efac; }
            100% { background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-color: #bbf7d0; transform: scale(1); }
        }
        @keyframes balanceFlashRed {
            0% { background: #fca5a5; border-color: #ef4444; transform: scale(1.05); }
            30% { background: #fecaca; }
            100% { background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-color: #bbf7d0; transform: scale(1); }
        }
        @keyframes deltaFloat {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }
        .dice { font-size: 3.5rem; margin: 8px 0; display: inline-block; }
        .dice.rolling { animation: roll 0.1s infinite; }
        @keyframes roll {
            0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); }
            75% { transform: rotate(-10deg); } 100% { transform: rotate(0deg); }
        }
        
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; background: #f3f4f6; border-radius: 10px;
            margin-bottom: 10px; font-size: 0.85rem;
        }
        .turn-indicator { font-weight: 600; color: var(--green-dark); }
        
        /* JOURNAL COMPTABLE */
        .journal-box {
            height: 200px; overflow-y: auto; border: 2px solid #e5e7eb;
            border-radius: 10px; padding: 8px; background: #fafafa;
            font-size: 0.75rem; font-family: monospace;
        }
        .journal-entry {
            padding: 4px 6px; margin-bottom: 4px; background: white;
            border-radius: 4px; border-left: 3px solid var(--green);
        }
        .journal-entry.debit { border-left-color: var(--red); }
        .journal-entry.credit { border-left-color: var(--green); }
        
        /* CHAT */
        .chat-box {
            height: 120px; overflow-y: auto; border: 2px solid #e5e7eb;
            border-radius: 10px; padding: 8px; margin-bottom: 8px;
            background: #fafafa; font-size: 0.85rem;
        }
        .chat-message { margin-bottom: 6px; padding: 6px 10px; background: white; border-radius: 8px; }
        .chat-message .sender { font-weight: 600; color: var(--green-dark); }
        .chat-message.system { background: #fef3c7; font-style: italic; color: #92400e; }
        
        /* ‚ïê‚ïê‚ïê TOASTS LIVE (style TikTok) ‚ïê‚ïê‚ïê */
        .live-toast-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            max-width: 90vw;
        }
        .live-toast {
            background: rgba(0, 0, 0, 0.82);
            color: white;
            padding: 10px 22px;
            border-radius: 25px;
            font-size: 0.92rem;
            font-weight: 500;
            text-align: center;
            max-width: 85vw;
            pointer-events: none;
            animation: toastSlideIn 0.35s cubic-bezier(0.16, 1, 0.3, 1), toastFadeOut 0.6s ease-in 3.2s forwards;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }
        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateY(25px) scale(0.85); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes toastFadeOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to { opacity: 0; transform: translateY(-15px) scale(0.95); }
        }
        .chat-input { display: flex; gap: 8px; }
        .chat-input input { flex: 1; margin-bottom: 0; font-size: 0.85rem; padding: 8px 10px; }
        
        .hidden { display: none !important; }
        .connection-status {
            position: fixed; top: 8px; right: 8px; padding: 6px 12px;
            border-radius: 20px; font-size: 0.75rem; font-weight: 600; z-index: 100;
        }
        .connection-status.connected { background: #dcfce7; color: var(--green-dark); }
        .connection-status.disconnected { background: #fee2e2; color: var(--red); }
        
        .divider { display: flex; align-items: center; margin: 20px 0; color: var(--gray); }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: #e5e7eb; }
        .divider span { padding: 0 12px; font-size: 0.85rem; }
        
        .error-message {
            background: #fee2e2; color: #dc2626; padding: 10px 12px;
            border-radius: 10px; margin-bottom: 12px; display: none; font-size: 0.9rem;
        }
        .loading {
            display: inline-block; width: 18px; height: 18px;
            border: 3px solid #f3f3f3; border-top: 3px solid var(--green);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal {
            background: white; border-radius: 16px; padding: 20px;
            max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        .modal h3 { color: var(--green-dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .modal-buttons .btn { flex: 1; min-width: 100px; }
        
        /* TABS */
        .tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab {
            padding: 8px 15px; background: #f3f4f6; border: none;
            border-radius: 8px 8px 0 0; cursor: pointer; font-size: 0.85rem;
        }
        .tab.active { background: var(--green); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .avatar-btn {
            width: 45px; height: 45px; font-size: 1.6rem;
            border: 3px solid #e5e7eb; border-radius: 10px;
            background: white; cursor: pointer; transition: all 0.2s;
        }
        .avatar-btn:hover { transform: scale(1.1); }
        .avatar-btn.selected { border-color: var(--green); background: #dcfce7; }
        
        /* BILAN */
        .bilan-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
        .bilan-table th, .bilan-table td { padding: 5px 8px; border: 1px solid #e5e7eb; }
        .bilan-table th { background: #f3f4f6; text-align: left; }
        .bilan-table .actif { background: #dcfce7; }
        .bilan-table .passif { background: #fee2e2; }
        .bilan-table .total { font-weight: bold; background: #fef3c7; }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">‚ö™ D√©connect√©</div>
    
    <div class="container">
        <!-- √âCRAN ACCUEIL -->
        <div id="homeScreen" class="card">
            <h1><img src="logo__g1_jaune_rond.png" alt="Logo ESPOYR" style="height: 1.5em; vertical-align: middle; margin-right: 8px;">ESPOYR</h1>
            <p class="subtitle">Jeu collaboratif d'√©conomie - V3 Comptabilit√© compl√®te</p>
            <div class="error-message" id="errorMessage"></div>
            
            <div style="margin-bottom: 15px; text-align: center;">
                <a href="https://docs.google.com/document/d/1fTV-keDtwbxwTQPUuj4JCEN-sUBkqvRx/edit?usp=sharing&ouid=114447202650775631504&rtpof=true&sd=true" 
                   target="_blank" rel="noopener noreferrer"
                   style="display: inline-block; padding: 10px 20px; background: #f0fdf4; border: 2px solid #059669; border-radius: 8px; color: #065f46; font-weight: 600; text-decoration: none; font-size: 0.95rem;">
                    üìñ Explications d√©taill√©es et r√®gles
                </a>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 6px; font-size: 0.9rem;">Introduit ton Pr√©nom :</label>
                <input type="text" id="playerName" placeholder="Entre ton pr√©nom..." maxlength="15">
            </div>
           
            
            <button class="btn btn-primary btn-full" onclick="createGame()" style="margin-bottom: 12px;">
                ‚ûï Cr√©er une nouvelle partie
            </button>
            
           
            
            <div class="divider"><span>ou rejoindre</span></div>
            
            <div style="margin-top: 12px;">
                <input type="text" id="gameCode" placeholder="Code (ex: ABC123)" maxlength="6" 
                       style="text-transform: uppercase; text-align: center; font-size: 1.2rem; letter-spacing: 3px;">
                <input type="text" id="resumeTicket" placeholder="Ticket de reprise (optionnel)" 
                       style="margin-top: 8px; text-align: center; font-size: 0.95rem;">

                <button class="btn btn-secondary btn-full" onclick="joinGame()">üö™ Rejoindre une partie</button>
            </div>
        </div>
        
        <!-- √âCRAN LOBBY -->
        <div id="lobbyScreen" class="card hidden">
            <h2>üéÆ Salle d'attente</h2>
            <div class="code-display">
                <div style="font-size: 0.85rem; color: #92400e; margin-bottom: 4px;">Code de la partie :</div>
                <div class="code" id="lobbyCode">------</div>
            </div>
            <h3 style="color: var(--gray); margin-bottom: 8px; font-size: 0.95rem;">Joueurs (<span id="playerCount">0</span>/4)</h3>
            <div class="players-list" id="lobbyPlayers"></div>
            <div id="hostControls" class="hidden" style="margin-top: 15px;">
                <button class="btn btn-primary btn-full" onclick="startGame()" id="startGameBtn" disabled>üöÄ Lancer</button>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button class="btn" style="flex:1; background: #dbeafe; color: #2563eb;" onclick="showAddBotModal()">ü§ñ Robot</button>
                    <button class="btn" style="flex:1; background: #fef3c7; color: #92400e;" onclick="showConfigModal()">‚öôÔ∏è Config</button>
                </div>
            </div>
            <div id="waitingMessage" style="text-align: center; margin-top: 15px; color: var(--gray);">
                <div class="loading"></div>
                <p style="margin-top: 8px; font-size: 0.9rem;">En attente du lancement...</p>
            </div>
            <button class="btn" onclick="leaveGame()" style="margin-top: 15px; background: #f3f4f6; color: var(--gray); font-size: 0.85rem;">‚Üê Quitter</button>
        </div>
        
        <!-- √âCRAN JEU -->
        <div id="gameScreen" class="card hidden">
            <div class="status-bar">
                <div>üîÑ Tour <strong id="turnNumber">1</strong></div>
                <div class="turn-indicator" id="turnIndicator">üéØ ...</div>
                <div>üìä Phase <strong id="phaseNumber">1</strong></div>
                <div id="sensIndicator" style="font-size: 0.8rem;">‚û°Ô∏è</div>
                <button id="forceNextBtn" class="btn" style="padding: 4px 8px; font-size: 0.7rem; background: #fef3c7; display: none;" onclick="forceNextTurn()" title="Forcer tour suivant (si bloqu√©)">‚è≠Ô∏è</button>
                <button class="btn" style="padding: 4px 8px; font-size: 0.7rem; background: #f3f4f6;" onclick="saveGame()">üíæ</button>
            </div>
            
            <!-- CONTR√îLES: Naviguer dans l'historique (visible pour tous) -->
            <div id="hostTimeControls" style="display: flex; gap: 6px; justify-content: center; align-items: center; margin: 8px 0; padding: 8px; background: #fef3c7; border-radius: 8px;">
                <span style="font-size: 0.75rem; color: #92400e;">‚è±Ô∏è Timeline:</span>
                <button class="btn" style="padding: 4px 10px; font-size: 0.85rem; background: #fee2e2; color: #dc2626;" onclick="goToFirstEvent()" title="D√©but">‚èÆÔ∏è</button>
                <button class="btn" style="padding: 4px 10px; font-size: 0.85rem; background: #fecaca; color: #dc2626;" onclick="goBackOneEvent()" title="Reculer">‚óÄÔ∏è</button>
                <span id="eventPosition" style="padding: 4px 12px; font-size: 0.8rem; background: white; border-radius: 4px; cursor: pointer;" onclick="showTimelineModal()" title="Cliquer pour voir la timeline">0/0</span>
                <button class="btn" style="padding: 4px 10px; font-size: 0.85rem; background: #bbf7d0; color: #059669;" onclick="goForwardOneEvent()" title="Avancer">‚ñ∂Ô∏è</button>
                <button class="btn" style="padding: 4px 10px; font-size: 0.85rem; background: #dcfce7; color: #059669;" onclick="goToLastEvent()" title="Fin / Temps r√©el">‚è≠Ô∏è</button>
                <button id="forkBtn" class="btn" style="padding: 4px 10px; font-size: 0.75rem; background: #fbbf24; color: #78350f; display: none;" onclick="showForkConfirmModal()" title="Reprendre √† partir d'ici (efface le futur)">üîÄ Fork</button>
                <button class="btn" style="padding: 4px 10px; font-size: 0.75rem; background: #dbeafe; color: #2563eb;" onclick="showTimelineModal()" title="Timeline compl√®te">üìú</button>
            </div>
            
            <div class="game-layout">
                <div class="main-area">
                    <div class="board-container" id="gameBoard"></div>
                    <div class="dice-area" id="diceArea">
                        <div class="my-balance-bar" id="myBalanceBar" style="position:relative;">
                            <span class="bal-euro" id="balEuro">0,00 ‚Ç¨</span>
                            <span style="color:#d1d5db;">|</span>
                            <span class="bal-hash" id="balHash">0,00 #</span>
                        </div>
                        <div id="diceMessage" style="font-size: 0.9rem;">En attente...</div>
                        <div class="dice" id="dice">üé≤</div>
                        <button class="btn btn-orange" id="rollDiceBtn" onclick="rollDice()">üé≤ Lancer</button>
                    </div>
                    
                    <!-- ACTIONS RAPIDES -->
                    <div style="background: #f8fafc; padding: 8px; border-radius: 8px; margin: 10px 0;">
                        <p style="margin: 0 0 6px 0; font-size: 0.75rem; color: #64748b; font-weight: bold;">‚ö° ACTIONS</p>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <button class="btn" style="background: #dcfce7; color: #059669; flex: 1; font-size: 0.75rem; padding: 6px;" onclick="showQuickAdhererAAA()"><svg style="display:inline-block;width:1.1em;height:1.1em;vertical-align:middle;" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="#FDDB31" stroke="#C4A800" stroke-width="3"/><text x="50" y="58" text-anchor="middle" font-size="48" font-weight="bold" fill="#000" font-family="Arial">#</text><text x="50" y="82" text-anchor="middle" font-size="18" font-weight="bold" fill="#000" font-family="Arial">AAA</text></svg> Devenir membre AAA</button>
                            <button class="btn" style="background: #dbeafe; color: #2563eb; flex: 1; font-size: 0.75rem; padding: 6px;" onclick="showQuickEmprunter()">üí∂ Emprunter</button>
                            <button id="equiperBtn" class="btn" style="background: #fef3c7; color: #92400e; flex: 1; font-size: 0.75rem; padding: 6px;" onclick="showQuickEquiper()">üìö Formation</button>
                        </div>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px;">
                            <button class="btn" style="background: #e0e7ff; color: #4338ca; flex: 1; font-size: 0.75rem; padding: 6px;" onclick="showQuickVendre()">üè∑Ô∏è Vendre</button>
                            <button class="btn" style="background: #fce7f3; color: #be185d; flex: 1; font-size: 0.75rem; padding: 6px;" onclick="showQuickRembourser()">üí≥ Rembourser</button>
                            <button class="btn" style="background: #ede9fe; color: #5b21b6; flex: 1; font-size: 0.75rem; padding: 6px;" onclick="showSmartContractModal()">üìú Smart Contract</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0;">
                        <button class="btn" style="background: #dcfce7; color: #059669; flex: 1;" onclick="showAAAModal()"><svg style="display:inline-block;width:1.1em;height:1.1em;vertical-align:middle;" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="#FDDB31" stroke="#C4A800" stroke-width="3"/><text x="50" y="58" text-anchor="middle" font-size="48" font-weight="bold" fill="#000" font-family="Arial">#</text><text x="50" y="82" text-anchor="middle" font-size="18" font-weight="bold" fill="#000" font-family="Arial">AAA</text></svg> Pot AAA</button>
                        <button class="btn" style="background: #fee2e2; color: #dc2626; flex: 1;" onclick="showBankModal()">üè¶ Banque</button>
                        <button class="btn" style="background: #fef9c3; color: #854d0e; flex: 1;" onclick="showFailliteModal()">‚ö†Ô∏è Faillite</button>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn" style="background: #dbeafe; color: #2563eb; flex: 1;" onclick="showComptaModal()">üìí Compta</button>
                        <button class="btn" style="background: #fef3c7; color: #92400e; flex: 1;" onclick="showBilanModal()">üìä Bilan</button>
                        <button class="btn" style="background: #dcfce7; color: #065f46; flex: 1;" onclick="showReleveCompteModal()">üìã Relev√©</button>
                        <button class="btn" style="background: #f3e8ff; color: #7c3aed; flex: 1;" onclick="showSaveAnalysisModal()">üìà Audit</button>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                        <button class="btn" style="background: #f3e8ff; color: #7c3aed; flex: 1;" onclick="showCompteEtat()">üèõÔ∏è √âtat</button>
                        <button class="btn" style="background: #fef9c3; color: #854d0e; flex: 1;" onclick="showCompteExportation()">üåç Export</button>
                        <button class="btn" style="background: #e0f2fe; color: #0369a1; flex: 1;" onclick="showCompteHorsCircuit()">üõ∞Ô∏è Hors circuit</button>
                        <button class="btn" style="background: #dbeafe; color: #2563eb; flex: 1;" onclick="showCompteBanque()">üè¶ Banque</button>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                        <button class="btn" id="configBtn" style="background: #e5e7eb; color: #374151; flex: 1; display: none;" onclick="showConfigModal()">‚öôÔ∏è Config</button>
                    </div>
                </div>
                
                <div class="side-panel">
                    <h3 style="color: var(--gray); margin-bottom: 8px; font-size: 0.9rem;">üë• Joueurs</h3>
                    <div class="players-list" id="gamePlayers"></div>
                    <h3 style="color: var(--gray); margin: 12px 0 6px; font-size: 0.9rem;">üí¨ Chat</h3>
                    <div class="chat-box" id="chatBox"></div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Message..." onkeypress="if(event.key==='Enter')sendChat()">
                        <button class="btn btn-primary" onclick="sendChat()" style="padding: 8px 12px; font-size: 0.8rem;">‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="modalContainer"></div>
    <div class="live-toast-container" id="liveToastContainer"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // ========== V√âRIFICATION FIREBASE ==========
        if (typeof firebase === 'undefined') {
            document.body.innerHTML = `
                <div style="max-width: 500px; margin: 80px auto; padding: 30px; font-family: sans-serif;
                    background: #fef2f2; border: 2px solid #dc2626; border-radius: 12px; text-align: center;">
                    <h2 style="color: #dc2626;">‚ö†Ô∏è Erreur de chargement</h2>
                    <p>Le serveur Firebase n'a pas pu √™tre contact√©.</p>
                    <p style="font-size: 0.9rem; color: #6b7280;">Causes possibles :</p>
                    <ul style="text-align: left; font-size: 0.85rem; color: #6b7280;">
                        <li>Pas de connexion internet</li>
                        <li>Un bloqueur de pub bloque <code>gstatic.com</code></li>
                        <li>Un pare-feu ou proxy bloque les CDN Google</li>
                    </ul>
                    <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 25px;
                        background: #dc2626; color: white; border: none; border-radius: 8px;
                        cursor: pointer; font-size: 1rem;">üîÑ R√©essayer</button>
                </div>`;
            throw new Error('Firebase SDK non charg√© ‚Äî v√©rifiez votre connexion internet');
        }
        
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyC5hPhmhgQNY1qrFQ63XOIFNXhdy5EsDMM",
            authDomain: "espoyr--game.firebaseapp.com",
            databaseURL: "https://espoyr--game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "espoyr--game",
            storageBucket: "espoyr--game.firebasestorage.app",
            messagingSenderId: "689112154741",
            appId: "1:689112154741:web:a471dadae9becbaf3ca3eb"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // ========== PLAN COMPTABLE ==========
        const PLAN_COMPTABLE = {
            // Classe 1 - Capitaux
            100: { nom: 'Capital activit√©', classe: 1, type: 'passif' },
            101: { nom: 'Capital joueur', classe: 1, type: 'passif' },
            109: { nom: 'R√©sultat exercice', classe: 1, type: 'passif' },
            110: { nom: 'Emprunt bancaire', classe: 1, type: 'passif' },
            130: { nom: 'Pr√™t de relance', classe: 1, type: 'passif' },
            135: { nom: 'Fonds Pot AAA', classe: 1, type: 'passif' },
            160: { nom: 'Annulation emprunt', classe: 1, type: 'passif' },
            164: { nom: 'Emprunt bancaire (alias)', classe: 1, type: 'passif' },
            // Classe 2 - Immobilisations
            200: { nom: 'Immobilisation activit√©', classe: 2, type: 'actif' },
            210: { nom: '√âquipement A (durable)', classe: 2, type: 'actif' },
            211: { nom: 'Activit√©s (alias)', classe: 2, type: 'actif' },
            218: { nom: '√âquipements (alias)', classe: 2, type: 'actif' },
            220: { nom: '√âquipement B (classique)', classe: 2, type: 'actif' },
            231: { nom: 'Biens personnels', classe: 2, type: 'actif' },
            260: { nom: 'Apports activit√©s', classe: 2, type: 'actif' },
            280: { nom: 'Cr√©ances sur joueurs (Banque)', classe: 2, type: 'actif' },  // NOUVEAU
            291: { nom: 'Pr√™ts √† la client√®le', classe: 2, type: 'actif' },
            2919: { nom: 'R√©duction de valeur act√©e', classe: 2, type: 'actif' },
            // Classe 4 - Tiers
            44: { nom: 'Dette Coop AAA / ASBL', classe: 4, type: 'passif' },
            400: { nom: 'Dettes perso', classe: 4, type: 'passif' },
            401: { nom: 'Fournisseurs', classe: 4, type: 'passif' },
            410: { nom: 'Smart contract', classe: 4, type: 'passif' },
            411: { nom: 'Clients', classe: 4, type: 'actif' },
            421: { nom: 'Personnel', classe: 4, type: 'passif' },
            431: { nom: '√âtat - Taxes', classe: 4, type: 'passif' },
            468: { nom: 'Consignes Espoyr #', classe: 4, type: 'passif' },
            48: { nom: 'Cr√©ances Pot AAA', classe: 4, type: 'actif' },
            480: { nom: 'Cr√©ances Pot AAA d√©tail', classe: 4, type: 'actif' },
            489: { nom: 'Dette Pot AAA activit√©', classe: 4, type: 'passif' },
            // Classe 5 - Financiers
            500: { nom: 'Caisse ‚Ç¨', classe: 5, type: 'actif' },
            501: { nom: 'Caisse #', classe: 5, type: 'actif' },
            510: { nom: 'Caisse # activit√©', classe: 5, type: 'actif' },
            512: { nom: 'Banque', classe: 5, type: 'actif' },
            540: { nom: 'Compte Exportation', classe: 5, type: 'actif' },
            541: { nom: 'Compte √âtat', classe: 5, type: 'actif' },
            550: { nom: 'Argents hors circuit', classe: 5, type: 'actif' },
            570: { nom: 'Bons d\'achat # (consignes)', classe: 5, type: 'actif' },
            580: { nom: 'Caisse Pot AAA', classe: 5, type: 'actif' },
            // Classe 6 - Charges
            601: { nom: 'Achats activit√©s', classe: 6, type: 'charge' },
            602: { nom: 'Achats √©quipements', classe: 6, type: 'charge' },
            613: { nom: 'Frais divers', classe: 6, type: 'charge' },
            634: { nom: 'Dotation r√©duction valeur', classe: 6, type: 'charge' },
            635: { nom: 'Taxes et imp√¥ts', classe: 6, type: 'charge' },
            640: { nom: 'Taxes activit√©', classe: 6, type: 'charge' },
            641: { nom: 'Salaires bruts', classe: 6, type: 'charge' },
            645: { nom: 'Charges patronales', classe: 6, type: 'charge' },
            650: { nom: 'Int√©r√™ts bancaires', classe: 6, type: 'charge' },
            661: { nom: 'Int√©r√™ts bancaires (alias)', classe: 6, type: 'charge' },
            671: { nom: 'Charges exceptionnelles', classe: 6, type: 'charge' },
            678: { nom: 'Pertes sur cr√©ances', classe: 6, type: 'charge' },
            680: { nom: 'Moins-value vente', classe: 6, type: 'charge' },
            // Classe 7 - Produits
            700: { nom: 'Ventes / Factures', classe: 7, type: 'produit' },
            701: { nom: 'Salaires re√ßus', classe: 7, type: 'produit' },
            706: { nom: 'Travail coop√©ratif', classe: 7, type: 'produit' },
            730: { nom: 'Produit travail coop', classe: 7, type: 'produit' },
            74: { nom: 'Subventions re√ßues (bonus #)', classe: 7, type: 'produit' },
            758: { nom: 'Produits divers', classe: 7, type: 'produit' },
            760: { nom: 'Plus-value vente', classe: 7, type: 'produit' },
            762: { nom: 'Produits financiers (int√©r√™ts)', classe: 7, type: 'produit' },  // NOUVEAU
            771: { nom: 'Produits exceptionnels', classe: 7, type: 'produit' },
            778: { nom: 'Produit exceptionnel annulation', classe: 7, type: 'produit' },
            791: { nom: 'Redistribution bien commun', classe: 7, type: 'produit' },
            792: { nom: '√âconomie sp√©culative / importation', classe: 7, type: 'produit' },
            // ========== COMPTES SP√âCIFIQUES √âTAT (√âtape 1) ==========
            702: { nom: 'Produits Frais/Services', classe: 7, type: 'produit' },
            703: { nom: 'Produits Taxe case', classe: 7, type: 'produit' },
            704: { nom: 'Produits TVA', classe: 7, type: 'produit' },
            705: { nom: 'Produits Droits enregistrement', classe: 7, type: 'produit' },
            658: { nom: 'Charges comblement Export', classe: 6, type: 'charge' },
            662: { nom: 'Charges int√©r√™ts dette √âtat', classe: 6, type: 'charge' },
            165: { nom: 'Dette √âtat envers Banque', classe: 1, type: 'passif' }
        };
        
        // ========== PLAN COMPTABLE SP√âCIFIQUE BANQUE ==========
        // Mod√®le "Banque sans d√©p√¥ts" - Capital >= 10% √ó E
        const PLAN_COMPTABLE_BANQUE = {
            // ACTIF
            1010: { nom: 'R√©serves banque', type: 'actif', description: 'Liquidit√©s disponibles pour pr√™ter' },
            1200: { nom: 'Cr√©ances joueurs', type: 'actif', description: 'E = capital restant d√ª' },
            1300: { nom: 'Int√©r√™ts √† recevoir', type: 'actif', description: 'Int√©r√™ts courus non √©chus' },
            // PASSIF (pas de d√©p√¥ts clients dans ce mod√®le)
            2290: { nom: 'Provision pour pertes', type: 'passif', description: 'P = 5% √ó E (s√©curit√©)' },
            // CAPITAUX PROPRES
            3000: { nom: 'Capital banque', type: 'capitaux', description: 'Apport initial des actionnaires' },
            3100: { nom: 'R√©serves / R√©sultat', type: 'capitaux', description: 'B√©n√©fices cumul√©s' },
            // R√âSULTAT (P&L)
            4000: { nom: 'Produits int√©r√™ts', type: 'produit', description: 'Int√©r√™ts per√ßus' },
            5000: { nom: 'Dotation provision', type: 'charge', description: 'Charge de provision' }
        };
        
        // Variables banque selon document
        // E = encours de cr√©dit (capital restant d√ª)
        // t = taux d'int√©r√™t par p√©riode (CONFIG.tauxInteret)
        // i = int√©r√™ts pay√©s = t √ó E
        // c = capital rembours√©
        // C = capital r√©glementaire = 0.10 √ó E
        // P = provision = 0.05 √ó E
        
        // Table de correspondance V3 ‚Üí Comptes canoniques (alias)
        const COMPTE_ALIAS = {
            // Permet d'utiliser les anciens num√©ros V3 tout en ayant les nouveaux
            // Pour l'instant vide car les deux sont dans PLAN_COMPTABLE
        };


// introduction de physique 
    // ============================================================
// ESPOYR ‚Äî MODULE D√â & D√âPLACEMENT (remplacement complet)
// ============================================================
// √Ä coller dans le fichier HTML principal en remplacement de :
//   - rollDice()
//   - askPhysicalDiceValue()
//   - movePlayer() (si elle existe)
//   - toute logique de d√©placement existante
//
// Pr√©requis d√©j√† pr√©sents dans le fichier :
//   - CASES[] (23 cases, indices 0-22)
//   - gameRef, gameState, playersData, myPlayerId, isHost
//   - rollDiceValue()  (RNG seed√©/replay)
//   - showModal(), closeModal(), sendSystemMessage()
//   - logEvent(), GAME_SAVE
//   - gameConfig.diceMode ('AUTO' | 'PHYSIQUE')
//   - PLAYER_COLORS[], updateBoard(), updatePlayersUI()








        
        
        // ========== PLATEAU ESPOYR (23 cases) ==========
        const CASES = [
            { id: 0, type: 'start', name: 'D√©part', icon: 'üèÅ' },
            { id: 1, type: 'activite', name: 'V√™tements', icon: 'üëî', prix: 200, facture: 40, hash: true, prixEquip: 100 },
            { id: 2, type: 'ligne2', name: 'Frais culturels', icon: 'üé≠', cout: 50, description: 'Spectacles, mus√©es, activit√©s culturelles ‚Äî chacun contribue √† la vie culturelle.' },
            { id: 3, type: 'activite', name: 'Pharmacie', icon: 'üíä', prix: 220, facture: 45, hash: true, prixEquip: 110 },
            { id: 4, type: 'chance', name: 'Chance', icon: 'üçÄ' },
            { id: 5, type: 'activite', name: 'Jardin', icon: 'üåª', prix: 240, facture: 50, hash: true, prixEquip: 120 },
            { id: 6, type: 'activite', name: 'Librairie', icon: 'üìö', prix: 180, facture: 35, hash: true, prixEquip: 90 },
            { id: 7, type: 'activite', name: 'Boulangerie', icon: 'ü•ñ', prix: 200, facture: 45, hash: true, prixEquip: 100 },
            { id: 8, type: 'activite', name: 'Coiffeur', icon: '‚úÇÔ∏è', prix: 160, facture: 30, hash: true, prixEquip: 80 },
            { id: 9, type: 'frais', name: 'Frais alimentaires', icon: 'üçΩÔ∏è', cout: 50, description: 'Courses et repas ‚Äî un besoin essentiel que chacun doit assumer.' },
            { id: 10, type: 'activite', name: 'Fleuriste', icon: 'üå∏', prix: 150, facture: 28, hash: true, prixEquip: 75 },
            { id: 11, type: 'activite', name: 'Caf√©', icon: '‚òï', prix: 200, facture: 40, hash: true, prixEquip: 100 },
            { id: 12, type: 'activite', name: 'Restaurant', icon: 'üçΩÔ∏è', prix: 280, facture: 55, hash: true, prixEquip: 140 },
            { id: 13, type: 'taxe', name: 'Taxe', icon: 'üèõÔ∏è' },
            { id: 14, type: 'activite', name: 'Garage', icon: 'üîß', prix: 300, facture: 60, hash: true, prixEquip: 150 },
            { id: 15, type: 'activite', name: 'Cordonnier', icon: 'üëü', prix: 320, facture: 60, hash: true, prixEquip: 160 },
            { id: 16, type: 'activite', name: 'Bijouterie', icon: 'üíé', prix: 260, facture: 52, hash: true, prixEquip: 130 },
            { id: 17, type: 'activite', name: '√âlectricien', icon: '‚ö°', prix: 220, facture: 44, hash: true, prixEquip: 110 },
            { id: 18, type: 'malchance', name: 'Merci', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
            { id: 19, type: 'activite', name: 'Plombier', icon: 'üî©', prix: 240, facture: 48, hash: true, prixEquip: 120 },
            { id: 20, type: 'frais', name: 'Frais de soins', icon: 'ü©∫', cout: 75, description: 'Consultation, m√©dicaments ‚Äî prendre soin de sa sant√© a un co√ªt.' },
            { id: 21, type: 'activite', name: 'Entrepreneur', icon: 'üõ†Ô∏è', prix: 320, facture: 65, hash: true, prixEquip: 160 },
            { id: 22, type: 'activite', name: 'Ferme', icon: 'üêÑ', prix: 350, facture: 70, hash: true, prixEquip: 175 }
        ];
        
        // ========== HELPERS PRIX √âQUIPEMENTS ==========
        // A (üåø √âcolo) = 70% du prix activit√©
        // B (‚ùÑÔ∏è Classique) = 50% du prix activit√©
        function getPrixA(caseId) { return Math.floor((CASES[caseId]?.prix || 0) * 0.70); }
        function getPrixB(caseId) { return Math.floor((CASES[caseId]?.prix || 0) * 0.50); }
        function getDifferenceAB(caseId) { return getPrixA(caseId) - getPrixB(caseId); }
        
        // Co√ªt d'un √©quipement selon le type et la situation
        // - 1er A : 70% du prix (getPrixA)
        // - A suppl√©mentaire (2e/3e) : 50% du prix (getPrixB) ‚Üí compens√© 100% en #
        // - B : 50% du prix (getPrixB)
        // - Conversion B‚ÜíA : diff√©rence (20% du prix) ‚Üí compens√© 50% en #
        function getCoutEquipement(caseId, type, nbAActuel) {
            if (type === 'A') {
                return nbAActuel === 0 ? getPrixA(caseId) : getPrixB(caseId);
            }
            if (type === 'B') return getPrixB(caseId);
            if (type === 'B_TO_A') return getDifferenceAB(caseId);
            return 0;
        }
        
        // Bonus # re√ßu du pot AAA
        function getBonusHash(caseId, type) {
            if (type === 'A_FIRST') return getDifferenceAB(caseId);        // 100% de la diff
            if (type === 'A_ADDITIONAL') return getPrixB(caseId);          // 100% du co√ªt (=prixB)
            if (type === 'B_TO_A') return Math.floor(getDifferenceAB(caseId) * 0.50); // 50% de la diff
            return 0;
        }
        
        // Calcul facture = 5% du total investi (activit√© + tous √©quipements)
        function calculerFactureActivite(caseId, equipList) {
            const c = CASES[caseId];
            if (!c || c.type !== 'activite') return 0;
            
            const nbA = (equipList || []).filter(e => e === 'A').length;
            const nbB = (equipList || []).filter(e => e === 'B').length;
            
            let totalInvesti = c.prix;
            if (nbA > 0) totalInvesti += getPrixA(caseId);           // 1er A √† 70%
            if (nbA > 1) totalInvesti += getPrixB(caseId) * (nbA - 1); // A suivants √† 50%
            totalInvesti += getPrixB(caseId) * nbB;                    // tous les B √† 50%
            
            return Math.floor(totalInvesti * 0.05);
        }
        
        // Combinaisons valides : nbA >= nbB, max 3 total
        function isEquipConfigValide(nbA, nbB) {
            return nbA >= nbB && (nbA + nbB) <= 3;
        }
        
        // Peut-on acheter un A ?
        function peutAcheterA(caseId, equipList, joueurId) {
            const phase = gameState?.phase || 1;
            
            const nbA = (equipList || []).filter(e => e === 'A').length;
            const nbB = (equipList || []).filter(e => e === 'B').length;
            const total = nbA + nbB;
            
            if (total >= 3) return { ok: false, raison: 'Maximum 3 √©quipements atteint' };
            if (nbA >= 3) return { ok: false, raison: 'Maximum 3 A atteint' };
            
            // V√©rifier membre AAA
            const isMembre = playersData[joueurId]?.membreAAA === true;
            if (!isMembre) return { ok: false, raison: 'Il faut √™tre membre du Pot AAA' };
            
            // V√©rifier pot AAA
            const bonus = nbA === 0 ? getBonusHash(caseId, 'A_FIRST') : getBonusHash(caseId, 'A_ADDITIONAL');
            const potSolde = COMPTABILITE.potAAA?.solde || 0;
            if (potSolde < bonus) return { ok: false, raison: `Pot AAA insuffisant (${fmt(potSolde)}# < ${fmt(bonus)}#)` };
            
            // V√©rifier cash
            const cout = getCoutEquipement(caseId, 'A', nbA);
            const cash = COMPTABILITE.caisseJoueurs[joueurId]?.euro || 0;
            if (cash < cout) return { ok: false, raison: `Cash insuffisant (${fmt(cash)}‚Ç¨ < ${fmt(cout)}‚Ç¨)` };
            
            return { ok: true, cout, bonus, raison: '' };
        }
        
        // Peut-on convertir B‚ÜíA ?
        function peutConvertirBtoA(caseId, equipList, joueurId) {
            const nbB = (equipList || []).filter(e => e === 'B').length;
            if (nbB === 0) return { ok: false, raison: 'Aucun B √† convertir' };
            
            const isMembre = playersData[joueurId]?.membreAAA === true;
            if (!isMembre) return { ok: false, raison: 'Il faut √™tre membre du Pot AAA' };
            
            const bonus = getBonusHash(caseId, 'B_TO_A');
            const potSolde = COMPTABILITE.potAAA?.solde || 0;
            if (potSolde < bonus) return { ok: false, raison: `Pot AAA insuffisant (${fmt(potSolde)}# < ${fmt(bonus)}#)` };
            
            const cout = getCoutEquipement(caseId, 'B_TO_A', 0);
            const cash = COMPTABILITE.caisseJoueurs[joueurId]?.euro || 0;
            if (cash < cout) return { ok: false, raison: `Cash insuffisant (${fmt(cash)}‚Ç¨ < ${fmt(cout)}‚Ç¨)` };
            
            return { ok: true, cout, bonus, raison: '' };
        }
        
        // Peut-on acheter un B ?
        function peutAcheterB(caseId, equipList, joueurId) {
            const phase = gameState?.phase || 1;
            const nbA = (equipList || []).filter(e => e === 'A').length;
            const nbB = (equipList || []).filter(e => e === 'B').length;
            const total = nbA + nbB;
            
            // Phase 2+: interdit si √ßa violerait nbA >= nbB
            if (phase >= 2 && !isEquipConfigValide(nbA, nbB + 1)) {
                return { ok: false, raison: 'Il faut au moins autant de A que de B' };
            }
            // Phase 1: max 2B
            if (phase < 2 && nbB >= 2) return { ok: false, raison: 'Maximum 2 B en Phase 1' };
            if (total >= 3) return { ok: false, raison: 'Maximum 3 √©quipements atteint' };
            
            const cout = getPrixB(caseId);
            const cash = COMPTABILITE.caisseJoueurs[joueurId]?.euro || 0;
            if (cash < cout) return { ok: false, raison: `Cash insuffisant (${fmt(cash)}‚Ç¨ < ${fmt(cout)}‚Ç¨)` };
            
            return { ok: true, cout, bonus: 0, raison: '' };
        }
        const CHANCE_CARDS = [
            { text: "üéâ F√™te du village ! Tous re√ßoivent 60‚Ç¨", amount: 60, all: true },
            { text: "üå± Bonus √©cologique collectif +45‚Ç¨", amount: 45, all: true },
            { text: "üì¶ Bonne r√©colte ! Tous +75‚Ç¨", amount: 75, all: true },
            { text: "üéÅ Don anonyme +150‚Ç¨", amount: 150, all: false },
            { text: "üì∞ Bonne nouvelle +105‚Ç¨", amount: 105, all: false },
            { text: "üçÄ Coup de chance +150‚Ç¨", amount: 150, all: false }
        ];
        
        const MALCHANCE_CARDS = [
            { text: "üí∏ Int√©r√™ts impr√©vus -50‚Ç¨", amount: 50 },
            { text: "üè¶ Frais bancaires -120‚Ç¨", amount: 120 },
            { text: "‚è∞ P√©nalit√©s retard -150‚Ç¨", amount: 150 },
            { text: "üìã Amendes -100‚Ç¨", amount: 100 },
            { text: "üìâ D√©couvert -50‚Ç¨", amount: 50 },
            { text: "üí± Frais change -75‚Ç¨", amount: 75 }
        ];
        
        // Biens personnels acquis sur la case Merci (d√© 1-6)
        const BIENS_MALCHANCE = [
            { id: 1, nom: "Maison familiale", icon: "üè†", description: "Votre famille s'agrandit !", valeur: 3500, interets: 30, total: 4550, mensualite: 152, duree: 30 },
            { id: 2, nom: "Voiture familiale", icon: "üöó", description: "Votre vieille voiture rend l'√¢me.", valeur: 800, interets: 25, total: 1000, mensualite: 143, duree: 7 },
            { id: 3, nom: "Cheval + √©quipement", icon: "üê¥", description: "Votre enfant est passionn√© d'√©quitation !", valeur: 700, interets: 20, total: 840, mensualite: 70, duree: 12 },
            { id: 4, nom: "Maison de campagne", icon: "üè°", description: "H√©ritage familial √† racheter.", valeur: 1200, interets: 28, total: 1536, mensualite: 77, duree: 20 },
            { id: 5, nom: "Caravane", icon: "üöê", description: "Les enfants adorent !", valeur: 500, interets: 22, total: 610, mensualite: 61, duree: 10 },
            { id: 6, nom: "√âtudes enfant", icon: "üéì", description: "Votre enfant entre en √©tudes sup√©rieures.", valeur: 600, interets: 15, total: 690, mensualite: 69, duree: 10 }
        ];
        
        // Logo AAA (SVG inline jaune #FDDB31, texte noir)
        const LOGO_AAA = `<svg style="display:inline-block;width:1.1em;height:1.1em;vertical-align:middle;" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="#FDDB31" stroke="#C4A800" stroke-width="3"/><text x="50" y="58" text-anchor="middle" font-size="48" font-weight="bold" fill="#000" font-family="Arial">#</text><text x="50" y="82" text-anchor="middle" font-size="18" font-weight="bold" fill="#000" font-family="Arial">AAA</text></svg>`;
        const LOGO_AAA_SM = `<svg style="display:inline-block;width:0.9em;height:0.9em;vertical-align:middle;" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="#FDDB31" stroke="#C4A800" stroke-width="3"/><text x="50" y="58" text-anchor="middle" font-size="48" font-weight="bold" fill="#000" font-family="Arial">#</text><text x="50" y="82" text-anchor="middle" font-size="18" font-weight="bold" fill="#000" font-family="Arial">AAA</text></svg>`;
        
        const PROFILS_IA = {
            PREDATEUR: { id: 'PREDATEUR', nom: 'ü¶à Pr√©dateur', acheteToujours: true, equipeToujours: true, emprunteLibrement: true },
            PRUDENT: { id: 'PRUDENT', nom: 'üê¢ Prudent', acheteToujours: false, equipeToujours: false, emprunteLibrement: false },
            COOPERATIF: { id: 'COOPERATIF', nom: 'ü§ù Coop√©ratif', membreAAA: true, equipeParfois: true },
            EQUILIBRE: { id: 'EQUILIBRE', nom: '‚öñÔ∏è √âquilibr√©', equipeRaisonnable: true },
            INVESTISSEUR: { id: 'INVESTISSEUR', nom: 'üìà Investisseur', acheteToujours: true, equipeToujours: true },
            SOLIDAIRE: { id: 'SOLIDAIRE', nom: LOGO_AAA + ' Solidaire', membreAAA: true, equipeParfois: true }
        };
        
        // ========== TRAVAUX COOP√âRATIFS (Actions Contributives) ==========
        const TRAVAUX_COOP = [
            { id: 1, nom: 'üå± Participer au jardin communautaire', gain: 190 },
            { id: 2, nom: 'üèÉ Organiser des activit√©s physiques', gain: 195 },
            { id: 3, nom: 'üõí Travailler dans un magasin solidaire', gain: 195 },
            { id: 4, nom: 'üç≤ Pr√©parer des repas pour enfants', gain: 195 },
            { id: 5, nom: 'üßò Travail du bien-√™tre', gain: 200 },
            { id: 6, nom: 'üìä G√©rer la comptabilit√© d\'une association', gain: 200 },
            { id: 7, nom: 'üìö Aider √† l\'√©cole', gain: 205 },
            { id: 8, nom: 'üõçÔ∏è Faire les courses pour personnes √¢g√©es', gain: 205 },
            { id: 9, nom: 'üë∂ Garder un enfant malade', gain: 215 },
            { id: 10, nom: 'üí¨ Tenir compagnie √† une personne isol√©e', gain: 220 },
            { id: 11, nom: 'üéâ Aider √† l\'organisation d\'√©v√©nements', gain: 220 }
        ];
        
        const PLAYER_COLORS = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
        
        // Pourcentages salaire CONTRIBUTIF (fixe)
        const SALARY_CONTRIBUTIF = { 1: 1.00, 2: 1.00, 3: 1.00, 4: 1.00, 5: 1.00, 6: 1.00 };
        
        // Pourcentages salaire CR√âATIF (variable selon d√©)
        const SALARY_CREATIF = { 1: 1.50, 2: 0.70, 3: 1.00, 4: 0.80, 5: 1.10, 6: 0.45 };
        
        // Ancien (gard√© pour compatibilit√©)
        const SALARY_PERCENT = { 1: 0.50, 2: 0.75, 3: 1.00, 4: 1.00, 5: 1.25, 6: 1.50 };
        
        // ========== FONCTION UTILITAIRE ARRONDI ==========
        function arrondir2(n) {
            return Math.round((n || 0) * 100) / 100;
        }
        // Formatage affichage mon√©taire : 2 d√©cimales
        function fmt(n) { n = Number(n || 0); return n % 1 === 0 ? n.toFixed(0) : n.toFixed(2); }
        
        // ‚ïê‚ïê‚ïê AFFICHAGE SOLDE EN TEMPS R√âEL ‚ïê‚ïê‚ïê
        let _prevBalEuro = null;
        let _prevBalHash = null;
        
        function updateMyBalance() {
            const caisse = COMPTABILITE?.caisseJoueurs?.[myPlayerId];
            if (!caisse) return;
            const euro = caisse.euro || 0;
            const hash = caisse.espoyr || 0;
            
            const elEuro = document.getElementById('balEuro');
            const elHash = document.getElementById('balHash');
            if (!elEuro || !elHash) return;
            
            elEuro.textContent = `${fmt(euro)} ‚Ç¨`;
            elHash.textContent = `${fmt(hash)} #`;
            
            // D√©tecter le changement et flasher
            if (_prevBalEuro !== null) {
                const deltaEuro = euro - _prevBalEuro;
                const deltaHash = hash - _prevBalHash;
                if (deltaEuro !== 0 || deltaHash !== 0) {
                    const isPositive = deltaEuro > 0 || (deltaEuro === 0 && deltaHash > 0);
                    let deltaText = '';
                    if (deltaEuro !== 0) deltaText += `${deltaEuro > 0 ? '+' : ''}${fmt(deltaEuro)}‚Ç¨`;
                    if (deltaHash !== 0) deltaText += `${deltaText ? ' ' : ''}${deltaHash > 0 ? '+' : ''}${fmt(deltaHash)}#`;
                    flashBalance(isPositive ? 'green' : 'red', deltaText);
                }
            }
            _prevBalEuro = euro;
            _prevBalHash = hash;
        }
        
        function flashBalance(type, deltaText) {
            const bar = document.getElementById('myBalanceBar');
            if (!bar) return;
            
            // Retirer les anciennes animations
            bar.classList.remove('flash-green', 'flash-red');
            void bar.offsetWidth; // Force reflow
            bar.classList.add(type === 'green' ? 'flash-green' : 'flash-red');
            
            // Afficher le delta flottant
            const existing = bar.querySelector('.bal-delta');
            if (existing) existing.remove();
            
            const delta = document.createElement('span');
            delta.className = 'bal-delta';
            delta.style.color = type === 'green' ? '#16a34a' : '#dc2626';
            delta.textContent = deltaText;
            bar.appendChild(delta);
            
            setTimeout(() => { if (delta.parentNode) delta.remove(); }, 1600);
            setTimeout(() => { bar.classList.remove('flash-green', 'flash-red'); }, 1300);
        }
        
        const CONFIG = {
            salaireBase: 350,  // Net pay√© au joueur
            capitalInitial: 450,
            potAAAInitial: 1000,
            tauxInteret: 0.10, // 10% par tour
            remboursementAutoCapitalPct: 0.10, // 10% du capital rembourse automatiquement en fin de cycle
            limiteEmpruntMin: 750,
            banqueCapitalInitial: 1000, // Capital initial banque
            // Transitions de phase (bas√©es sur les passages Ligne 1, tous joueurs confondus)
            phase2_passagesMin: 6,       // Passages Ligne 1 avant Phase 2
            phase3_passagesMin: 12,      // Passages Ligne 1 avant Phase 3
            phase3_tauxEmploiMin: 50,    // % emploi en dessous duquel Phase 3 se d√©clenche
            phase3_detteMax: 1500,       // Dette totale au-dessus de laquelle Phase 3 se d√©clenche
            // Timings (en secondes) - param√©trables par l'host
            timingDecision: 60,      // Temps pour d√©cider (acheter/passer) - 1 minute
            timingEnchere: 60,       // Temps par tour d'ench√®re
            timingNegociation: 45,   // Temps pour n√©gocier
            timingBot: 2             // D√©lai avant action robot
        };
        
        // Config modifiable par l'host
        let gameConfig = { ...CONFIG };
        
        // ========== √âTAT LOCAL ==========
        let myPlayerId = null;
        let myName = '';
        let myAvatar = '‚¨ú';
        let currentGameCode = null;
        let isHost = false;
        let gameRef = null;
        let gameState = null;
        let playersData = {};

        // ========== REPRISE / TICKET JOUEUR (A+B) ==========
        const RESUME_KEY_PREFIX = 'ESPOYR_RESUME_';
        const ABSENT_AFTER_MS = 90 * 1000; // 90s : un joueur est consid√©r√© "absent" si lastSeen est trop ancien

        function getResumeKey(code) { return `${RESUME_KEY_PREFIX}${code}`; }

        function saveResume(code, data) {
            try { localStorage.setItem(getResumeKey(code), JSON.stringify(data)); } catch(e) {}
        }

        function loadResume(code) {
            try {
                const raw = localStorage.getItem(getResumeKey(code));
                return raw ? JSON.parse(raw) : null;
            } catch(e) { return null; }
        }

        function parseResumeTicket(ticketRaw) {
            if (!ticketRaw) return null;
            const t = ticketRaw.trim();
            // Formats accept√©s:
            //  - p_xxx|SECRET
            //  - p_xxx.SECRET
            //  - p_xxx:SECRET
            const sep = t.includes('|') ? '|' : (t.includes('.') ? '.' : (t.includes(':') ? ':' : null));
            if (!sep) return null;
            const [playerId, secret] = t.split(sep).map(s => (s||'').trim());
            if (!playerId || !secret) return null;
            return { playerId, secret };
        }

        async function sha256Hex(str) {
            try {
                const enc = new TextEncoder();
                const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
                return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (e) {
                // Fallback non-crypto (√©vite crash) : hash simple
                let h = 2166136261;
                for (let i = 0; i < str.length; i++) {
                    h ^= str.charCodeAt(i);
                    h = Math.imul(h, 16777619);
                }
                return ('00000000' + (h >>> 0).toString(16)).slice(-8);
            }
        }

        function generateSecret(len = 24) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789abcdefghijkmnopqrstuvwxyz';
            let out = '';
            const arr = new Uint8Array(len);
            try { crypto.getRandomValues(arr); } catch(e) {}
            for (let i = 0; i < len; i++) {
                const r = arr[i] || Math.floor(Math.random() * 256);
                out += chars[r % chars.length];
            }
            return out;
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                sendSystemMessage('üìã Ticket copi√©');
            } catch (e) {
                // fallback
                const ta = document.createElement('textarea');
                ta.value = text; document.body.appendChild(ta);
                ta.select(); document.execCommand('copy');
                document.body.removeChild(ta);
                sendSystemMessage('üìã Ticket copi√©');
            }
        }

        function downloadTextFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }


// Ticket de reprise (pour t√©l√©chargement fiable sur mobile)
let LAST_RESUME_CODE = null;
let LAST_RESUME_NAME = null;

function downloadResumeTicket() {
    try {
        const ticketEl = document.getElementById('ticketValue');
        const ticket = ticketEl ? ticketEl.textContent.trim() : '';
        const code = (LAST_RESUME_CODE || '').trim();
        const name = (LAST_RESUME_NAME || '').trim();
        const content =
            `Code partie: ${code}\n` +
            `Nom: ${name}\n` +
            `Ticket: ${ticket}\n`;
        downloadTextFile('espoyr-reprise.txt', content);
        sendSystemMessage('üíæ Ticket t√©l√©charg√©');
    } catch (e) {
        console.error('downloadResumeTicket error', e);
        // Fallback: affiche le texte √† copier
        alert("T√©l√©chargement bloqu√© par le navigateur. Copie le ticket affich√©, ou fais une capture d‚Äô√©cran.");
    }
}

        

function showMyTicketModal() {
    try {
        if (!currentGameCode) {
            alert("Aucune partie active : rejoins une partie pour afficher ton ticket.");
            return;
        }
        const saved = loadResume(currentGameCode);
        if (!saved || !saved.playerId || !saved.secret) {
            alert("Ticket introuvable sur cet appareil. Si tu es sur un autre appareil, utilise le ticket que tu avais sauvegard√©.");
            return;
        }
        const ticket = `${saved.playerId}|${saved.secret}`;
        LAST_RESUME_CODE = currentGameCode;
        LAST_RESUME_NAME = saved.name || myName || '';
        showModal(
            `<h3>üéüÔ∏è Mon ticket de reprise</h3>
             <p style="color: var(--gray); font-size: 0.9rem;">Garde ce ticket pour reprendre la partie en cas de probl√®me technique (m√™me sur un autre appareil).</p>
             <div id="ticketValue" style="background:#f3f4f6; border:1px solid #e5e7eb; padding:10px; border-radius:10px; font-family: monospace; word-break: break-all;">${ticket}</div>`,
            `<button class="btn btn-primary" onclick="copyToClipboard(document.getElementById('ticketValue').textContent)">üìã Copier</button>
             <button class="btn" onclick="downloadResumeTicket()">üíæ T√©l√©charger</button>
             <button class="btn" onclick="closeModal()">OK</button>`
        );
    } catch (e) {
        console.error('showMyTicketModal error', e);
        alert("Impossible d'afficher le ticket (erreur navigateur).");
    }
}

function isAbsent(player) {
            const last = player?.lastSeen || 0;
            return !last || (Date.now() - last > ABSENT_AFTER_MS);
        }

        let heartbeatTimer = null;
        function startHeartbeat() {
            if (!gameRef || !myPlayerId) return;
            if (heartbeatTimer) clearInterval(heartbeatTimer);
            const beat = async () => {
                try {
                    await gameRef.child(`players/${myPlayerId}`).update({
                        isConnected: true,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                } catch(e) {}
            };
            beat();
            heartbeatTimer = setInterval(beat, 15000);
        }

        window.addEventListener('beforeunload', () => {
            try {
                if (gameRef && myPlayerId) {
                    gameRef.child(`players/${myPlayerId}`).update({
                        isConnected: false,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            } catch(e) {}
        });


        
        // Tracker les √©quipements faits ce tour (1 seul par tour complet par case)
        let equipementsCeTour = {};  // { caseId: tourComplet }
        
        // Mode replay pour navigation dans l'historique
        let replayMode = false;
        let _botTimeout = null;  // Track bot setTimeout to prevent duplicates
        let _botScheduledIdx = -1;  // Which playerIndex the bot timeout is for
        let currentEventIndex = -1;  // -1 = temps r√©el
        
        // ========== SYST√àME DE SAUVEGARDE AUDIT + REPLAY ==========
        const SCHEMA_VERSION = "4.1.0"; // Ajout comptabilit√© bancaire BCE (E, C=10%E, P=5%E)
        
        // Structure de sauvegarde compl√®te
        let GAME_SAVE = {
            schemaVersion: SCHEMA_VERSION,
            gameId: null,
            createdAt: null,
            lastSavedAt: null,
            
            // RNG pour reproductibilit√©
            rng: {
                mode: "seeded",
                seed: null,
                consumed: 0,
                rolls: []  // Historique des lancers
            },
            
            // √âtat actuel du jeu (reprise imm√©diate)
            state: null,
            
            // Event Log append-only (chronologie)
            events: [],
            eventCounter: 0,
            
            // Journal comptable append-only (double √©critures)
            ledger: [],
            ledgerCounter: 0,
            
            // Snapshots (points de reprise)
            snapshots: [],
            
            // Indexes pour recherche rapide
            indexes: {
                byTurn: {},
                byPlayer: {},
                byEntity: {},
                byAction: {}
            }
        };
        
        // G√©n√©rer un seed al√©atoire
        function generateSeed() {
            return 'seed_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Convertir un seed string en nombre pour le RNG
        function seedToNumber(seedStr) {
            let hash = 0;
            for (let i = 0; i < seedStr.length; i++) {
                const char = seedStr.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }
        
        // RNG seed√© pour reproductibilit√© (utilis√© uniquement en mode replay)
        function seededRandom() {
            if (!GAME_SAVE.rng.seed) {
                GAME_SAVE.rng.seed = generateSeed();
                GAME_SAVE.rng.seedNumber = seedToNumber(GAME_SAVE.rng.seed);
            }
            
            // Simple LCG (Linear Congruential Generator)
            const a = 1664525;
            const c = 1013904223;
            const m = Math.pow(2, 32);
            
            // Utiliser le seed num√©rique + le compteur
            let seed = (GAME_SAVE.rng.seedNumber + GAME_SAVE.rng.consumed) % m;
            seed = (a * seed + c) % m;
            GAME_SAVE.rng.consumed++;
            
            return seed / m;
        }
        
        // Lancer de d√© - AL√âATOIRE en jeu normal, SEED√â en replay
        function rollDiceValue() {
            let result;
            
            // V√©rifier si on est en mode replay ET si on a un r√©sultat enregistr√©
            const isReplay = (typeof replayMode !== 'undefined') && replayMode;
            
            if (isReplay && GAME_SAVE.rng.rolls[GAME_SAVE.rng.consumed]) {
                // Mode replay : utiliser le r√©sultat enregistr√©
                result = GAME_SAVE.rng.rolls[GAME_SAVE.rng.consumed].value;
                GAME_SAVE.rng.consumed++;
                console.log(`üé≤ Replay d√©: ${result}`);
            } else {
                // Mode normal : vrai al√©atoire avec Math.random()
                result = Math.floor(Math.random() * 6) + 1;
                
                // Enregistrer pour replay futur
                GAME_SAVE.rng.rolls.push({
                    index: GAME_SAVE.rng.rolls.length,
                    value: result,
                    timestamp: new Date().toISOString()
                });
                GAME_SAVE.rng.consumed = GAME_SAVE.rng.rolls.length;
                console.log(`üé≤ Nouveau d√©: ${result}`);
            }
            
            return result;
        }
        
        // ========== EVENT LOG ==========
        function logEvent(action, actorId, payload = {}, ledgerEntryIds = []) {
            const eventId = `EVT_${String(GAME_SAVE.eventCounter++).padStart(6, '0')}`;
            const event = {
                eventId,
                ts: new Date().toISOString(),
                turn: gameState?.turn || 0,
                phase: gameState?.phase || 1,
                actorId,
                action,
                payload,
                ledgerEntryIds,
                hash: null  // Calcul√© apr√®s
            };
            
            // Hash simple pour int√©grit√©
            event.hash = simpleHash(JSON.stringify({
                eventId: event.eventId,
                action: event.action,
                payload: event.payload
            }));
            
            GAME_SAVE.events.push(event);
            
            // Indexer
            indexEvent(event);
            
            // Cr√©er un snapshot automatiquement si n√©cessaire
            maybeCreateSnapshot(action);
            
            console.log(`üìù Event ${eventId}: ${action} (Tour ${event.turn})`);
            
            return eventId;
        }
        
        // Indexer un event
        function indexEvent(event) {
            const turn = event.turn;
            const player = event.actorId;
            const action = event.action;
            
            // Index par tour
            if (!GAME_SAVE.indexes.byTurn[turn]) {
                GAME_SAVE.indexes.byTurn[turn] = { eventIds: [], ledgerIds: [] };
            }
            GAME_SAVE.indexes.byTurn[turn].eventIds.push(event.eventId);
            event.ledgerEntryIds.forEach(lid => {
                if (!GAME_SAVE.indexes.byTurn[turn].ledgerIds.includes(lid)) {
                    GAME_SAVE.indexes.byTurn[turn].ledgerIds.push(lid);
                }
            });
            
            // Index par joueur
            if (player) {
                if (!GAME_SAVE.indexes.byPlayer[player]) {
                    GAME_SAVE.indexes.byPlayer[player] = { eventIds: [], ledgerIds: [] };
                }
                GAME_SAVE.indexes.byPlayer[player].eventIds.push(event.eventId);
                event.ledgerEntryIds.forEach(lid => {
                    GAME_SAVE.indexes.byPlayer[player].ledgerIds.push(lid);
                });
            }
            
            // Index par action
            if (!GAME_SAVE.indexes.byAction[action]) {
                GAME_SAVE.indexes.byAction[action] = [];
            }
            GAME_SAVE.indexes.byAction[action].push(event.eventId);
        }
        
        // Hash simple pour int√©grit√©
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'H' + Math.abs(hash).toString(16).padStart(8, '0');
        }
        
        // ========== SNAPSHOTS ==========
        function createSnapshot(reason = 'auto') {
            const eventCount = GAME_SAVE.events.length;
            const snapshotId = `SNP_${String(GAME_SAVE.snapshots.length).padStart(4, '0')}_E${eventCount}`;
            const snapshot = {
                snapshotId,
                ts: new Date().toISOString(),
                turn: gameState?.turn || 0,
                phase: gameState?.phase || 1,
                reason,  // Pourquoi ce snapshot a √©t√© cr√©√©
                eventCursor: eventCount > 0 ? GAME_SAVE.events[eventCount - 1].eventId : null,
                eventIndex: eventCount - 1,  // Index direct pour faciliter la navigation
                ledgerCursor: GAME_SAVE.ledger.length > 0 ? GAME_SAVE.ledger[GAME_SAVE.ledger.length - 1].ledgerEntryId : null,
                state: JSON.parse(JSON.stringify({
                    gameState,
                    playersData,
                    COMPTABILITE,
                    gameConfig
                }))
            };
            
            GAME_SAVE.snapshots.push(snapshot);
            console.log(`üì∏ Snapshot cr√©√©: ${snapshotId} (${reason}) - Event ${eventCount}`);
            return snapshotId;
        }
        
        // Cr√©er un snapshot automatiquement apr√®s chaque action importante
        function maybeCreateSnapshot(reason) {
            // Cr√©er un snapshot tous les 3 events ou pour des raisons sp√©cifiques
            const eventCount = GAME_SAVE.events.length;
            const lastSnapEventIndex = GAME_SAVE.snapshots.length > 0 
                ? (GAME_SAVE.snapshots[GAME_SAVE.snapshots.length - 1].eventIndex || 0)
                : -1;
            
            // Cr√©er un snapshot si: nouveau tour, achat, ou plus de 3 events depuis le dernier
            const importantReasons = ['NEW_ROUND', 'BUY_ACTIVITY', 'BUY_EQUIPMENT', 'BANKRUPTCY', 'GAME_START'];
            if (importantReasons.includes(reason) || (eventCount - lastSnapEventIndex) >= 3) {
                createSnapshot(reason);
            }
        }
        
        // Trouver le snapshot le plus proche avant un eventId
        function findSnapshotBefore(eventId) {
            const eventIndex = GAME_SAVE.events.findIndex(e => e.eventId === eventId);
            if (eventIndex === -1) return null;
            
            // Chercher le snapshot avec eventCursor < eventId
            for (let i = GAME_SAVE.snapshots.length - 1; i >= 0; i--) {
                const snap = GAME_SAVE.snapshots[i];
                const snapEventIndex = GAME_SAVE.events.findIndex(e => e.eventId === snap.eventCursor);
                if (snapEventIndex < eventIndex) {
                    return snap;
                }
            }
            return GAME_SAVE.snapshots[0] || null;
        }
        
        // ========== COMPTABILIT√â LOCALE (synchronis√©e Firebase) ==========
        let COMPTABILITE = {
            journal: [],
            numeroEcriture: 0,
            grandLivre: {},
            caisseJoueurs: {},
            caisseActivites: {},
            parJoueur: {},  // Grand-livre par joueur (journal + balances)
            banque: {
                creancesJoueurs: 0,
                masseMonetaire: 0,
                interetsRecus: 0,
                capital: 0,
                reductionValeur: 0,  // RDV pour cr√©ances douteuses
                journal: [],  // Journal des op√©rations bancaires
                // ========== NOUVEAU: Comptabilit√© bancaire formalis√©e ==========
                // Variables selon document
                E: 0,                    // Encours de cr√©dit (capital restant d√ª)
                t: CONFIG.tauxInteret,   // Taux d'int√©r√™t par p√©riode
                cumInterets: 0,          // Int√©r√™ts cumul√©s (cum(i))
                cumCapital: 0,           // Capital rembours√© cumul√© (cum(c))
                // Contraintes prudentielles
                C_requis: 0,             // Capital r√©glementaire = 10% √ó E
                P_requis: 0,             // Provision requise = 5% √ó E
                // Grand-livre banque - mod√®le sans d√©p√¥ts clients
                grandLivre: {
                    1010: 0,  // R√©serves banque (initialement = capital)
                    1200: 0,  // Cr√©ances joueurs = E
                    1300: 0,  // Int√©r√™ts √† recevoir
                    2290: 0,  // Provision = 5% √ó E
                    3000: 0,  // Capital banque
                    3100: 0,  // R√©serves / R√©sultat
                    4000: 0,  // Produits d'int√©r√™ts
                    5000: 0   // Dotation provision
                },
                // Journal format replay
                journalBanque: [],  // {timestamp, event_type, debit_account, credit_account, amount, meta}
                // Statistiques
                totalPretsAccordes: 0,
                totalRembourse: 0,
                defauts: 0
            },
            potAAA: {
                solde: CONFIG.potAAAInitial,
                circulationHash: 0,
                membres: [],
                creances: {},
                journal: []  // Journal du Pot AAA
            },
            etat: {
                tresor: 0,
                taxesRecues: 0,
                salairesVerses: 0,
                journal: [],  // Journal de l'√âtat
                // ========== NOUVEAUX CHAMPS √âTAPE 1 ==========
                // Recettes d√©taill√©es
                recettes: {
                    tva: 0,              // TVA collect√©e (factures, √©quipements, frais)
                    droits: 0,           // Droits d'enregistrement
                    frais: 0,            // Part HT des frais
                    taxeCase: 0,         // Case Taxe
                    total: 0
                },
                // D√©penses d√©taill√©es
                depenses: {
                    salaires: 0,         // Salaires contributifs vers√©s
                    interets: 0,         // Int√©r√™ts pay√©s √† la banque
                    comblementExport: 0, // D√©couverts Export combl√©s
                    total: 0
                },
                // Dette envers la banque
                dette: {
                    capital: 0,          // Capital emprunt√© (jamais rembours√©)
                    interetsCumules: 0   // Total int√©r√™ts pay√©s depuis le d√©but
                },
                // Grand-livre √âtat (soldes par compte)
                grandLivre: {
                    500: 0,   // Caisse/Tr√©sor
                    704: 0,   // Produits TVA
                    705: 0,   // Produits Droits
                    702: 0,   // Produits Frais/Services
                    703: 0,   // Produits Taxe case
                    165: 0,   // Dette bancaire
                    641: 0,   // Charges salaires
                    662: 0,   // Charges int√©r√™ts
                    658: 0    // Charges comblement Export
                },
                // Journal format replay
                journalEtat: []
            },
            exportation: {
                solde: 0,  // Peut √™tre n√©gatif (d√©couvert)
                recettes: 0,
                salairesVerses: 0,
                journal: []  // Journal de l'Exportation
            },
            horsCircuit: {
                solde: 0,
                recettes: 0,
                journal: [],
                grandLivre: { 550: 0, 792: 0 },
                journalHorsCircuit: []
            }
        };
        
        // S'assurer que tous les champs de COMPTABILITE existent
        function normalizeComptabilite() {
            if (!COMPTABILITE.journal) COMPTABILITE.journal = [];
            if (!COMPTABILITE.grandLivre) COMPTABILITE.grandLivre = {};
            if (!COMPTABILITE.caisseJoueurs) COMPTABILITE.caisseJoueurs = {};
            if (!COMPTABILITE.caisseActivites) COMPTABILITE.caisseActivites = {};
            if (!COMPTABILITE.parJoueur) COMPTABILITE.parJoueur = {};
            if (!COMPTABILITE.banque) COMPTABILITE.banque = { creancesJoueurs: 0, masseMonetaire: 0, interetsRecus: 0, capital: 0, reductionValeur: 0, journal: [] };
            if (!COMPTABILITE.banque.journal) COMPTABILITE.banque.journal = [];
            if (COMPTABILITE.banque.reductionValeur === undefined) COMPTABILITE.banque.reductionValeur = 0;
            if (COMPTABILITE.banque.capital === undefined) COMPTABILITE.banque.capital = 0;
            // Nouveaux champs comptabilit√© bancaire formalis√©e
            if (COMPTABILITE.banque.E === undefined) COMPTABILITE.banque.E = COMPTABILITE.banque.creancesJoueurs || 0;
            if (COMPTABILITE.banque.t === undefined) COMPTABILITE.banque.t = CONFIG.tauxInteret;
            if (COMPTABILITE.banque.cumInterets === undefined) COMPTABILITE.banque.cumInterets = COMPTABILITE.banque.interetsRecus || 0;
            if (COMPTABILITE.banque.cumCapital === undefined) COMPTABILITE.banque.cumCapital = 0;
            if (COMPTABILITE.banque.C_requis === undefined) COMPTABILITE.banque.C_requis = 0.10 * (COMPTABILITE.banque.E || 0);
            if (COMPTABILITE.banque.P_requis === undefined) COMPTABILITE.banque.P_requis = arrondir2(0.05 * (COMPTABILITE.banque.E || 0));
            if (!COMPTABILITE.banque.grandLivre) {
                // Mod√®le sans d√©p√¥ts clients - pas de compte 2000
                COMPTABILITE.banque.grandLivre = { 1010: 0, 1200: 0, 1300: 0, 2290: 0, 3000: 0, 3100: 0, 4000: 0, 5000: 0 };
                COMPTABILITE.banque.grandLivre[1200] = COMPTABILITE.banque.E || 0;
            }
            if (!COMPTABILITE.banque.journalBanque) COMPTABILITE.banque.journalBanque = [];
            if (COMPTABILITE.banque.totalPretsAccordes === undefined) COMPTABILITE.banque.totalPretsAccordes = 0;
            if (COMPTABILITE.banque.totalRembourse === undefined) COMPTABILITE.banque.totalRembourse = 0;
            if (COMPTABILITE.banque.defauts === undefined) COMPTABILITE.banque.defauts = 0;
            if (!COMPTABILITE.potAAA) COMPTABILITE.potAAA = { solde: CONFIG.potAAAInitial, circulationHash: 0, membres: [], creances: {}, journal: [] };
            if (!COMPTABILITE.potAAA.membres) COMPTABILITE.potAAA.membres = [];
            if (!COMPTABILITE.potAAA.creances) COMPTABILITE.potAAA.creances = {};
            if (!COMPTABILITE.potAAA.journal) COMPTABILITE.potAAA.journal = [];
            if (!COMPTABILITE.etat) COMPTABILITE.etat = { tresor: 0, taxesRecues: 0, salairesVerses: 0, journal: [] };
            if (!COMPTABILITE.etat.journal) COMPTABILITE.etat.journal = [];
            if (COMPTABILITE.etat.salairesVerses === undefined) COMPTABILITE.etat.salairesVerses = 0;
            // ========== NOUVEAUX CHAMPS √âTAT (√âtape 1) ==========
            // Recettes d√©taill√©es
            if (!COMPTABILITE.etat.recettes) {
                COMPTABILITE.etat.recettes = {
                    tva: 0,
                    droits: 0,
                    frais: 0,
                    taxeCase: COMPTABILITE.etat.taxesRecues || 0, // Migration ancien champ
                    total: COMPTABILITE.etat.taxesRecues || 0
                };
            }
            if (COMPTABILITE.etat.recettes.tva === undefined) COMPTABILITE.etat.recettes.tva = 0;
            if (COMPTABILITE.etat.recettes.droits === undefined) COMPTABILITE.etat.recettes.droits = 0;
            if (COMPTABILITE.etat.recettes.frais === undefined) COMPTABILITE.etat.recettes.frais = 0;
            if (COMPTABILITE.etat.recettes.taxeCase === undefined) COMPTABILITE.etat.recettes.taxeCase = 0;
            if (COMPTABILITE.etat.recettes.total === undefined) COMPTABILITE.etat.recettes.total = 0;
            // D√©penses d√©taill√©es
            if (!COMPTABILITE.etat.depenses) {
                COMPTABILITE.etat.depenses = {
                    salaires: COMPTABILITE.etat.salairesVerses || 0, // Migration
                    interets: 0,
                    comblementExport: 0,
                    total: COMPTABILITE.etat.salairesVerses || 0
                };
            }
            if (COMPTABILITE.etat.depenses.salaires === undefined) COMPTABILITE.etat.depenses.salaires = 0;
            if (COMPTABILITE.etat.depenses.interets === undefined) COMPTABILITE.etat.depenses.interets = 0;
            if (COMPTABILITE.etat.depenses.comblementExport === undefined) COMPTABILITE.etat.depenses.comblementExport = 0;
            if (COMPTABILITE.etat.depenses.total === undefined) COMPTABILITE.etat.depenses.total = 0;
            // Dette √âtat
            if (!COMPTABILITE.etat.dette) {
                COMPTABILITE.etat.dette = {
                    capital: 0,
                    interetsCumules: 0
                };
            }
            if (COMPTABILITE.etat.dette.capital === undefined) COMPTABILITE.etat.dette.capital = 0;
            if (COMPTABILITE.etat.dette.interetsCumules === undefined) COMPTABILITE.etat.dette.interetsCumules = 0;
            // Grand-livre √âtat
            if (!COMPTABILITE.etat.grandLivre) {
                COMPTABILITE.etat.grandLivre = {
                    500: COMPTABILITE.etat.tresor || 0, // Migration
                    704: 0, 705: 0, 702: 0, 703: 0,
                    165: 0, 641: 0, 662: 0, 658: 0
                };
            }
            // S'assurer que tous les comptes existent
            if (COMPTABILITE.etat.grandLivre[500] === undefined) COMPTABILITE.etat.grandLivre[500] = COMPTABILITE.etat.tresor || 0;
            if (COMPTABILITE.etat.grandLivre[704] === undefined) COMPTABILITE.etat.grandLivre[704] = 0;
            if (COMPTABILITE.etat.grandLivre[705] === undefined) COMPTABILITE.etat.grandLivre[705] = 0;
            if (COMPTABILITE.etat.grandLivre[702] === undefined) COMPTABILITE.etat.grandLivre[702] = 0;
            if (COMPTABILITE.etat.grandLivre[703] === undefined) COMPTABILITE.etat.grandLivre[703] = 0;
            if (COMPTABILITE.etat.grandLivre[165] === undefined) COMPTABILITE.etat.grandLivre[165] = 0;
            if (COMPTABILITE.etat.grandLivre[641] === undefined) COMPTABILITE.etat.grandLivre[641] = 0;
            if (COMPTABILITE.etat.grandLivre[662] === undefined) COMPTABILITE.etat.grandLivre[662] = 0;
            if (COMPTABILITE.etat.grandLivre[658] === undefined) COMPTABILITE.etat.grandLivre[658] = 0;
            // Journal √âtat format replay
            if (!COMPTABILITE.etat.journalEtat) COMPTABILITE.etat.journalEtat = [];
            if (!COMPTABILITE.exportation) COMPTABILITE.exportation = { solde: 0, recettes: 0, salairesVerses: 0, journal: [] };
            if (!COMPTABILITE.exportation.journal) COMPTABILITE.exportation.journal = [];
            if (COMPTABILITE.exportation.solde === undefined) COMPTABILITE.exportation.solde = 0;
            if (!COMPTABILITE.horsCircuit) COMPTABILITE.horsCircuit = { solde: 0, recettes: 0, journal: [], grandLivre: { 550: 0, 792: 0 }, journalHorsCircuit: [] };
            if (!COMPTABILITE.horsCircuit.journal) COMPTABILITE.horsCircuit.journal = [];
            if (COMPTABILITE.horsCircuit.solde === undefined) COMPTABILITE.horsCircuit.solde = 0;
            if (COMPTABILITE.horsCircuit.recettes === undefined) COMPTABILITE.horsCircuit.recettes = 0;
            if (!COMPTABILITE.horsCircuit.grandLivre) COMPTABILITE.horsCircuit.grandLivre = { 550: 0, 792: 0 };
            if (COMPTABILITE.horsCircuit.grandLivre[550] === undefined) COMPTABILITE.horsCircuit.grandLivre[550] = COMPTABILITE.horsCircuit.solde || 0;
            if (COMPTABILITE.horsCircuit.grandLivre[792] === undefined) COMPTABILITE.horsCircuit.grandLivre[792] = COMPTABILITE.horsCircuit.recettes || 0;
            if (!COMPTABILITE.horsCircuit.journalHorsCircuit) COMPTABILITE.horsCircuit.journalHorsCircuit = [];
            if (!COMPTABILITE.exportation.journal) COMPTABILITE.exportation.journal = [];
            if (COMPTABILITE.exportation.solde === undefined) COMPTABILITE.exportation.solde = 0;
            // Dettes entre joueurs (report de paiement)
            if (!COMPTABILITE.dettesEntreJoueurs) COMPTABILITE.dettesEntreJoueurs = [];
            // Smart Contracts (pr√™ts entre joueurs, Phase 3)
            if (!COMPTABILITE.smartContracts) COMPTABILITE.smartContracts = [];
        }
        
        // ========== FONCTIONS COMPTABLES ==========
        
        // ========== √âTAPE 2 : FONCTION calculerFacture() ==========
        // Calcule la d√©composition d'une facture selon son type
        // Retourne : { ht, tva, droits, total, lignes[], destinationEtat, destinationExport }
        
        function calculerFacture(type, montantTTC, prixVente = null) {
            const TVA_TAUX = 0.21;        // 21%
            const DROITS_VENTE = 0.06;    // 6% droits enregistrement vente joueur
            const DROITS_ACTIVITE = 0.26; // 26% droits sur achat activit√©
            
            let facture = {
                type: type,
                montantTTC: montantTTC,
                ht: 0,
                tva: 0,
                droits: 0,
                total: montantTTC,
                lignes: [],
                destinationEtat: 0,
                destinationExport: 0,
                destinationProprietaire: 0,  // Pour factures entre joueurs
                destinationRedistribution: 0 // Pour achat activit√© libre (80% HT)
            };
            
            switch (type) {
                case 'frais':
                    // Frais (Frais alimentaires, Frais de soins, Frais culturels) : 100% vers √âtat
                    // Montant affich√© = TTC
                    facture.ht = Math.round((montantTTC / (1 + TVA_TAUX)) * 100) / 100;
                    facture.tva = Math.round((montantTTC - facture.ht) * 100) / 100;
                    facture.destinationEtat = montantTTC; // Tout √† l'√âtat
                    facture.lignes = [
                        { description: 'Services / Frais HT', montant: facture.ht },
                        { description: `TVA ${TVA_TAUX * 100}%`, montant: facture.tva }
                    ];
                    break;
                    
                case 'equipement':
                    // √âquipement A ou B : TVA 21% vers √âtat seul
                    // Montant affich√© = TTC
                    facture.ht = Math.round((montantTTC / (1 + TVA_TAUX)) * 100) / 100;
                    facture.tva = Math.round((montantTTC - facture.ht) * 100) / 100;
                    facture.destinationEtat = facture.tva; // Seulement TVA √† l'√âtat
                    facture.lignes = [
                        { description: '√âquipement HT', montant: facture.ht },
                        { description: `TVA ${TVA_TAUX * 100}%`, montant: facture.tva }
                    ];
                    break;
                    
                case 'activite_libre':
                    // Achat activit√© libre : facture d√©taill√©e
                    // T = montantTTC = prix affich√©
                    // Travaux (16% de T) avec TVA 21% ‚Üí 0,16T √ó 1,21 = 0,1936T
                    // Activit√© (64% de T) avec Droits 26% ‚Üí 0,64T √ó 1,26 = 0,8064T
                    // Total taxes = 20% de T ‚Üí 10% √âtat + 10% Export
                    const T = montantTTC;
                    const travauxHT = Math.round(T * 0.16 * 100) / 100;
                    const travauxTVA = Math.round(travauxHT * TVA_TAUX * 100) / 100;
                    const activiteHT = Math.round(T * 0.64 * 100) / 100;
                    const activiteDroits = Math.round(activiteHT * DROITS_ACTIVITE * 100) / 100;
                    
                    facture.ht = travauxHT + activiteHT; // 80% de T
                    facture.tva = travauxTVA;            // ~3,36% de T
                    facture.droits = activiteDroits;     // ~16,64% de T
                    
                    // R√©partition 50/50 entre √âtat et Export
                    const totalTaxes = facture.tva + facture.droits;
                    facture.destinationEtat = Math.round(totalTaxes / 2 * 100) / 100;
                    facture.destinationExport = Math.round(totalTaxes / 2 * 100) / 100;
                    facture.destinationRedistribution = facture.ht; // 80% redistribu√©
                    
                    facture.lignes = [
                        { description: '611 - Travaux HT', montant: travauxHT },
                        { description: `    TVA ${TVA_TAUX * 100}%`, montant: travauxTVA, indent: true },
                        { description: '200 - Achat activit√© HT', montant: activiteHT },
                        { description: `    Droits ${DROITS_ACTIVITE * 100}%`, montant: activiteDroits, indent: true },
                        { description: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', montant: null, separator: true },
                        { description: 'Total HT', montant: facture.ht },
                        { description: 'Total Taxes', montant: totalTaxes },
                        { description: '  ‚Üí √âtat', montant: facture.destinationEtat, detail: true },
                        { description: '  ‚Üí Export', montant: facture.destinationExport, detail: true }
                    ];
                    break;
                    
                case 'facture_joueur':
                    // Facture pay√©e √† un propri√©taire : TVA 21% extraite vers √âtat
                    // Propri√©taire re√ßoit HT, √âtat re√ßoit TVA
                    facture.ht = Math.round((montantTTC / (1 + TVA_TAUX)) * 100) / 100;
                    facture.tva = Math.round((montantTTC - facture.ht) * 100) / 100;
                    facture.destinationEtat = facture.tva;
                    facture.destinationProprietaire = facture.ht;
                    facture.lignes = [
                        { description: 'Prestation HT', montant: facture.ht },
                        { description: `TVA ${TVA_TAUX * 100}%`, montant: facture.tva },
                        { description: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', montant: null, separator: true },
                        { description: '‚Üí Propri√©taire', montant: facture.ht, detail: true },
                        { description: '‚Üí √âtat (TVA)', montant: facture.tva, detail: true }
                    ];
                    break;
                    
                case 'vente_joueur':
                    // Vente entre joueurs : prix P + 6% droits
                    // Vendeur re√ßoit P, Acheteur paie P + 6%, √âtat re√ßoit 6%
                    const prixBase = prixVente || montantTTC;
                    facture.droits = Math.round(prixBase * DROITS_VENTE * 100) / 100;
                    facture.total = prixBase + facture.droits;
                    facture.ht = prixBase;
                    facture.destinationEtat = facture.droits;
                    facture.destinationProprietaire = prixBase; // Vendeur re√ßoit le prix
                    facture.lignes = [
                        { description: 'Prix de vente', montant: prixBase },
                        { description: `Droits enregistrement ${DROITS_VENTE * 100}%`, montant: facture.droits },
                        { description: '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', montant: null, separator: true },
                        { description: 'TOTAL √Ä PAYER', montant: facture.total, bold: true },
                        { description: '‚Üí Vendeur', montant: prixBase, detail: true },
                        { description: '‚Üí √âtat (Droits)', montant: facture.droits, detail: true }
                    ];
                    break;
                    
                default:
                    console.warn(`Type de facture inconnu: ${type}`);
            }
            
            return facture;
        }
        
        // G√©n√®re le HTML d'affichage d'une facture pour un modal
        function genererHTMLFacture(facture, titre = 'FACTURE') {
            let lignesHTML = '';
            
            for (const ligne of facture.lignes) {
                if (ligne.separator) {
                    lignesHTML += `<tr><td colspan="2" style="border-top: 1px dashed #ccc;"></td></tr>`;
                } else if (ligne.montant === null) {
                    continue;
                } else {
                    const style = ligne.bold ? 'font-weight: bold;' : '';
                    const indent = ligne.indent ? 'padding-left: 20px; font-size: 0.85rem; color: #6b7280;' : '';
                    const detail = ligne.detail ? 'font-size: 0.85rem; color: #059669;' : '';
                    lignesHTML += `
                        <tr style="${style}${indent}${detail}">
                            <td style="padding: 4px 8px;">${ligne.description}</td>
                            <td style="padding: 4px 8px; text-align: right;">${ligne.montant !== null ? ligne.montant.toFixed(2) + ' ‚Ç¨' : ''}</td>
                        </tr>
                    `;
                }
            }
            
            return ` 
                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 12px; margin: 10px 0;">
                    <div style="background: #f3f4f6; padding: 8px; margin: -12px -12px 10px -12px; border-radius: 6px 6px 0 0;">
                        <p style="margin: 0; font-weight: bold; text-align: center;">üìÑ ${titre}</p>
                    </div>
                    <table style="width: 100%; border-collapse: collapse;">
                        ${lignesHTML}
                    </table>
                    <div style="background: #fef3c7; padding: 8px; margin: 10px -12px -12px -12px; border-radius: 0 0 6px 6px;">
                        <p style="margin: 0; font-weight: bold; text-align: center;">
                            TOTAL TTC : ${facture.total.toFixed(2)} ‚Ç¨
                        </p>
                    </div>
                </div>
            `;
        }
        
        // Initialiser caisse joueur
        function initCaisseJoueur(joueurId) {
            if (!COMPTABILITE.caisseJoueurs[joueurId]) {
                COMPTABILITE.caisseJoueurs[joueurId] = {
                    euro: 0, espoyr: 0, capital: 0,
                    emprunt: 0, interetsDus: 0,
                    apportsActivites: 0,
                    // Cumuls pour le compte joueur
                    salairesRecus: 0,
                    facturesRecues: 0,
                    facturesPayees: 0,
                    interetsPayes: 0,
                    taxesPayees: 0,
                    redistributionsRecues: 0,
                    journal: []
                };
            }
            // S'assurer que les cumuls existent (migration)
            const c = COMPTABILITE.caisseJoueurs[joueurId];
            if (c.salairesRecus === undefined) c.salairesRecus = 0;
            if (c.facturesRecues === undefined) c.facturesRecues = 0;
            if (c.facturesPayees === undefined) c.facturesPayees = 0;
            if (c.interetsPayes === undefined) c.interetsPayes = 0;
            if (c.taxesPayees === undefined) c.taxesPayees = 0;
            if (c.redistributionsRecues === undefined) c.redistributionsRecues = 0;
            // Biens personnels et arri√©r√©s (migration)
            if (c.impaye === undefined) c.impaye = 0;
            if (!c.biensPersonnels) c.biensPersonnels = [];
            if (!c.dettesPersonnelles) c.dettesPersonnelles = [];
        }
        
        // Initialiser comptabilit√© compl√®te joueur (grand-livre)
        function initComptabiliteJoueur(joueurId) {
            if (!COMPTABILITE.parJoueur[joueurId]) {
                COMPTABILITE.parJoueur[joueurId] = {
                    journal: [],
                    balances: {}  // { 500: { euro: 0, espoyr: 0 }, ... }
                };
            }
        }
        
        // Initialiser caisse activit√©
        function initCaisseActivite(actId) {
            if (!COMPTABILITE.caisseActivites[actId]) {
                const c = CASES[actId];
                COMPTABILITE.caisseActivites[actId] = {
                    euro: 0, espoyr: 0,
                    proprietaireId: null,
                    capital: c?.prix || 0,
                    equipements: 0,
                    recettes: 0, depenses: 0, 
                    journal: []
                };
            }
        }
        
        // Enregistrer √©criture comptable (C≈íUR DU SYST√àME)
        function enregistrerEcriture(params) {
            let {
                joueurId, libelle, compteDebit, compteCredit,
                montantEuro = 0, montantEspoyr = 0,
                activiteId = null, details = {}, contexte = null
            } = params;
            
            // R√©soudre les alias si n√©cessaire
            compteDebit

            // ===== Garde-fous Espoyr (#) =====
            // On n'autorise pas de montants # sur des comptes ‚Ç¨ (ex: 500, 700, 704) ni sur des comptes de produits (classe 7)
            if (montantEspoyr > 0) {
                const interditsPourHash = new Set([500, 700, 704]);
                if (interditsPourHash.has(compteDebit) || interditsPourHash.has(compteCredit)) {
                    console.error(`‚õî √âcriture # invalide: D${compteDebit} C${compteCredit} (comptes ‚Ç¨ interdits pour #)`);
                    return null;
                }
                // En mode '# = consigne', on interdit les comptes de produits pour les montants #
                if (PLAN_COMPTABLE[compteCredit]?.classe === 7) {
                    console.error(`‚õî √âcriture # invalide: cr√©dit produit (classe 7) interdit pour # en mode consigne. D${compteDebit} C${compteCredit}`);
                    return null;
                }
            }
            compteDebit = COMPTE_ALIAS[compteDebit] || compteDebit;
            compteCredit = COMPTE_ALIAS[compteCredit] || compteCredit;
            
            if (!PLAN_COMPTABLE[compteDebit] || !PLAN_COMPTABLE[compteCredit]) {
                console.warn(`‚ö†Ô∏è Compte invalide: D${compteDebit} C${compteCredit}`);
                return null;
            }
            
            COMPTABILITE.numeroEcriture++;
            const ecriture = {
                id: COMPTABILITE.numeroEcriture,
                timestamp: new Date().toISOString(), 
                tour: gameState?.turn || 1,
                phase: gameState?.phase || 1,
                joueurId, joueurNom: playersData[joueurId]?.name || joueurId,
                libelle,
                debit: { compte: compteDebit, nom: PLAN_COMPTABLE[compteDebit].nom, euro: montantEuro, espoyr: montantEspoyr },
                credit: { compte: compteCredit, nom: PLAN_COMPTABLE[compteCredit].nom, euro: montantEuro, espoyr: montantEspoyr },
                activiteId, details, contexte
            };
            
            COMPTABILITE.journal.push(ecriture);
            
            // ===== AJOUT AU LEDGER GAME_SAVE =====
            const ledgerEntryId = `LED_${String(GAME_SAVE.ledgerCounter++).padStart(6, '0')}`;
            
            // Cr√©er entr√©e(s) ledger (s√©par√©es par devise)
            if (montantEuro > 0) {
                const ledgerEntryEUR = {
                    ledgerEntryId: ledgerEntryId + '_EUR',
                    ts: ecriture.timestamp, 
                    turn: ecriture.tour,
                    phase: ecriture.phase,
                    type: 'COMPTA',
                    label: libelle,
                    currency: 'EUR',
                    entity: { kind: joueurId?.startsWith('bot_') ? 'BOT' : 'PLAYER', id: joueurId },
                    debit: [{ account: String(compteDebit), name: PLAN_COMPTABLE[compteDebit].nom, amount: montantEuro }],
                    credit: [{ account: String(compteCredit), name: PLAN_COMPTABLE[compteCredit].nom, amount: montantEuro }],
                    links: { ecritureId: ecriture.id, actId: activiteId, contexte },
                    balanced: true  // Auto-√©quilibr√©
                };
                GAME_SAVE.ledger.push(ledgerEntryEUR);
            }
            
            if (montantEspoyr > 0) {
                const ledgerEntryESP = {
                    ledgerEntryId: ledgerEntryId + '_ESP',
                    ts: ecriture.timestamp,
                    turn: ecriture.tour,
                    phase: ecriture.phase,
                    type: 'COMPTA',
                    label: libelle,
                    currency: 'ESP',
                    entity: { kind: joueurId?.startsWith('bot_') ? 'BOT' : 'PLAYER', id: joueurId },
                    debit: [{ account: String(compteDebit), name: PLAN_COMPTABLE[compteDebit].nom, amount: montantEspoyr }],
                    credit: [{ account: String(compteCredit), name: PLAN_COMPTABLE[compteCredit].nom, amount: montantEspoyr }],
                    links: { ecritureId: ecriture.id, actId: activiteId, contexte },
                    balanced: true
                };
                GAME_SAVE.ledger.push(ledgerEntryESP);
            }
            // ===== FIN AJOUT LEDGER =====
            
            // Grand livre
            if (!COMPTABILITE.grandLivre[compteDebit]) COMPTABILITE.grandLivre[compteDebit] = [];
            if (!COMPTABILITE.grandLivre[compteCredit]) COMPTABILITE.grandLivre[compteCredit] = [];
            COMPTABILITE.grandLivre[compteDebit].push({ ...ecriture, sens: 'debit' });
            COMPTABILITE.grandLivre[compteCredit].push({ ...ecriture, sens: 'credit' });
            
            // Journal joueur (caisseJoueurs)
            if (joueurId) {
                initCaisseJoueur(joueurId);
                COMPTABILITE.caisseJoueurs[joueurId].journal.push(ecriture);
                
                // Grand-livre joueur (parJoueur)
                initComptabiliteJoueur(joueurId);
                COMPTABILITE.parJoueur[joueurId].journal.push(ecriture);
                
                // Mise √† jour balances joueur
                if (!COMPTABILITE.parJoueur[joueurId].balances[compteDebit]) {
                    COMPTABILITE.parJoueur[joueurId].balances[compteDebit] = { euro: 0, espoyr: 0 };
                }
                if (!COMPTABILITE.parJoueur[joueurId].balances[compteCredit]) {
                    COMPTABILITE.parJoueur[joueurId].balances[compteCredit] = { euro: 0, espoyr: 0 };
                }
                COMPTABILITE.parJoueur[joueurId].balances[compteDebit].euro += montantEuro;
                COMPTABILITE.parJoueur[joueurId].balances[compteDebit].espoyr += montantEspoyr;
                COMPTABILITE.parJoueur[joueurId].balances[compteCredit].euro -= montantEuro;
                COMPTABILITE.parJoueur[joueurId].balances[compteCredit].espoyr -= montantEspoyr;
            }
            
            // Journal activit√©
            if (activiteId !== null) {
                initCaisseActivite(activiteId);
                COMPTABILITE.caisseActivites[activiteId].journal.push(ecriture);
                
                // Maj totaux analytiques
                if (PLAN_COMPTABLE[compteCredit].classe === 7) {
                    COMPTABILITE.caisseActivites[activiteId].recettes += montantEuro + montantEspoyr;
                }
                if (PLAN_COMPTABLE[compteDebit].classe === 6) {
                    COMPTABILITE.caisseActivites[activiteId].depenses += montantEuro + montantEspoyr;
                }
            }
            
            // Journaux par contexte (entit√©s)
            if (contexte === 'banque' || compteDebit === 512 || compteCredit === 512 || 
                compteDebit === 164 || compteCredit === 164 || compteDebit === 110 || compteCredit === 110) {
                COMPTABILITE.banque.journal.push(ecriture);
            }
            if (contexte === 'potAAA' || compteDebit === 580 || compteCredit === 580 || 
                compteDebit === 135 || compteCredit === 135 || compteDebit === 48 || compteCredit === 48) {
                COMPTABILITE.potAAA.journal.push(ecriture);
            }
            if (contexte === 'etat' || compteDebit === 635 || compteCredit === 635 || 
                compteDebit === 431 || compteCredit === 431 || compteDebit === 640 || compteCredit === 640 ||
                compteDebit === 541 || compteCredit === 541) {
                COMPTABILITE.etat.journal.push(ecriture);
            }
            if (contexte === 'exportation' || compteDebit === 540 || compteCredit === 540) {
                COMPTABILITE.exportation.journal.push(ecriture);
            }
            if (contexte === 'horsCircuit' || compteDebit === 550 || compteCredit === 550) {
                COMPTABILITE.horsCircuit.journal.push(ecriture);
                if (COMPTABILITE.horsCircuit.journalHorsCircuit) COMPTABILITE.horsCircuit.journalHorsCircuit.push({
                    id: ecriture.id, libelle: ecriture.libelle, montant: (ecriture.debit?.montantEuro || ecriture.credit?.montantEuro || 0),
                    tour: ecriture.tour, timestamp: ecriture.timestamp
                });
            }
            
            console.log(`üìí #${ecriture.id}: ${libelle} | D:${compteDebit} C:${compteCredit} | ${montantEuro}‚Ç¨ ${montantEspoyr}#`);
            
            // Retourner l'√©criture avec le ledgerEntryId
            ecriture.ledgerEntryId = ledgerEntryId;
            return ecriture;
        }
        
        // V√©rifier que tous les comptes utilis√©s sont d√©clar√©s dans PLAN_COMPTABLE
        function checkPlanComptableCoverage() {
            const comptesUtilises = new Set();
            
            // Scanner journal global
            COMPTABILITE.journal.forEach(e => {
                if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
            });
            
            // Scanner grand livre
            Object.keys(COMPTABILITE.grandLivre).forEach(c => comptesUtilises.add(parseInt(c)));
            
            // Scanner journaux joueurs (caisseJoueurs)
            Object.values(COMPTABILITE.caisseJoueurs).forEach(c => {
                c.journal?.forEach(e => {
                    if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                    if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
                });
            });
            
            // Scanner journaux activit√©s
            Object.values(COMPTABILITE.caisseActivites).forEach(c => {
                c.journal?.forEach(e => {
                    if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                    if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
                });
            });
            
            // Scanner parJoueur
            Object.values(COMPTABILITE.parJoueur).forEach(p => {
                p.journal?.forEach(e => {
                    if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                    if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
                });
                Object.keys(p.balances || {}).forEach(c => comptesUtilises.add(parseInt(c)));
            });
            
            // Scanner journaux entit√©s
            COMPTABILITE.banque.journal?.forEach(e => {
                if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
            });
            COMPTABILITE.potAAA.journal?.forEach(e => {
                if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
            });
            COMPTABILITE.etat.journal?.forEach(e => {
                if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
            });
            
            // Comparer avec PLAN_COMPTABLE
            const manquants = [...comptesUtilises].filter(c => !PLAN_COMPTABLE[c] && c);
            
            if (manquants.length > 0) {
                console.warn('‚ö†Ô∏è COMPTES MANQUANTS DANS PLAN_COMPTABLE:', manquants);
            } else {
                console.log('‚úÖ Tous les comptes utilis√©s sont d√©clar√©s dans PLAN_COMPTABLE');
            }
            
            return { 
                comptesUtilises: [...comptesUtilises].filter(c => c).sort((a,b) => a-b), 
                manquants,
                declares: Object.keys(PLAN_COMPTABLE).map(Number).sort((a,b) => a-b)
            };
        }
        
        // Historique des bilans (pour comparaison tour par tour)
        let historiqueBilans = [];
        
        // Calculer le bilan complet de l'√©conomie
        function calculerBilan() {
            const players = Object.values(playersData);
            const tour = gameState?.turn || 1;
            const phase = gameState?.phase || 1;
            
            // Actifs
            let totalCaisseEuro = 0;
            let totalCaisseEspoyr = 0;
            let totalActivites = 0;
            let totalEquipements = 0;
            let totalCreancesAAA = 0;
            
            // Passifs
            let totalEmprunts = 0;
            let totalCapitaux = 0;
            
            // Par joueur
            const bilansJoueurs = {};
            
            players.forEach(p => {
                const caisse = COMPTABILITE.caisseJoueurs[p.id] || {};
                const euro = caisse.euro || p.euro || 0;
                const espoyr = caisse.espoyr || p.espoyr || 0;
                const emprunt = caisse.emprunt || p.emprunt || 0;
                const capital = caisse.capital || 0;
                const apportsActivites = caisse.apportsActivites || 0;
                
                totalCaisseEuro += euro;
                totalCaisseEspoyr += espoyr;
                totalActivites += apportsActivites;
                totalEmprunts += emprunt;
                totalCapitaux += capital;
                
                // Cr√©ances AAA
                const creanceAAA = COMPTABILITE.potAAA.creances?.[p.id] || 0;
                totalCreancesAAA += creanceAAA;
                
                bilansJoueurs[p.id] = {
                    nom: p.name,
                    actif: { euro, espoyr, activites: apportsActivites },
                    passif: { emprunt, capital },
                    net: euro + espoyr + apportsActivites - emprunt,
                    creanceAAA
                };
            });
            
            // Calcul √©quipements (avec nouveaux prix)
            Object.entries(COMPTABILITE.caisseActivites).forEach(([actId, act]) => {
                const nbA = act.equipementA || 0;
                const nbB = act.equipementB || 0;
                const id = parseInt(actId);
                if (nbA > 0) totalEquipements += getPrixA(id);
                if (nbA > 1) totalEquipements += getPrixB(id) * (nbA - 1);
                totalEquipements += getPrixB(id) * nbB;
            });
            
            // Bilan global
            const actifTotal = totalCaisseEuro + totalCaisseEspoyr + totalActivites + totalEquipements;
            const passifTotal = totalEmprunts + totalCapitaux;
            
            // Bilan Banque (avec RDV)
            const reductionValeur = COMPTABILITE.banque.reductionValeur || 0;
            const bilanBanque = {
                actif: { 
                    creancesJoueurs: COMPTABILITE.banque.creancesJoueurs,
                    creancesNettes: COMPTABILITE.banque.creancesJoueurs - reductionValeur
                },
                passif: { masseMonetaire: COMPTABILITE.banque.masseMonetaire },
                interetsRecus: COMPTABILITE.banque.interetsRecus,
                reductionValeur: reductionValeur
            };
            
            // Bilan Pot AAA
            const bilanAAA = {
                actif: { creances: totalCreancesAAA },
                passif: { solde: COMPTABILITE.potAAA.solde },
                circulationHash: COMPTABILITE.potAAA.circulationHash,
                membres: COMPTABILITE.potAAA.membres?.length || 0
            };
            
            // Bilan √âtat
            const bilanEtat = {
                actif: { tresor: COMPTABILITE.etat.tresor },
                taxesRecues: COMPTABILITE.etat.taxesRecues,
                salairesVerses: COMPTABILITE.etat.salairesVerses || 0
            };
            
            // Bilan Exportation
            const bilanExportation = {
                solde: COMPTABILITE.exportation?.solde || 0,
                recettes: COMPTABILITE.exportation?.recettes || 0,
                salairesVerses: COMPTABILITE.exportation?.salairesVerses || 0
            };
            // Bilan Hors circuit
            const bilanHorsCircuit = {
                solde: COMPTABILITE.horsCircuit?.solde || 0,
                recettes: COMPTABILITE.horsCircuit?.recettes || 0
            };
            
            // Score √©conomique (indicateur de sant√©)
            const scoreEconomique = Math.round(
                (totalCaisseEuro + totalCaisseEspoyr + totalActivites) - 
                (totalEmprunts * 1.5) + 
                (COMPTABILITE.potAAA.circulationHash * 0.5)
            );
            
            const bilan = {
                timestamp: new Date().toISOString(),
                tour, phase,
                actif: {
                    caisseEuro: totalCaisseEuro,
                    caisseEspoyr: totalCaisseEspoyr,
                    activites: totalActivites,
                    equipements: totalEquipements,
                    total: actifTotal
                },
                passif: {
                    emprunts: totalEmprunts,
                    capitaux: totalCapitaux,
                    total: passifTotal
                },
                equilibre: actifTotal - passifTotal,
                bilansJoueurs,
                bilanBanque,
                bilanAAA,
                bilanEtat,
                bilanExportation,
                bilanHorsCircuit,
                scoreEconomique,
                nbEcritures: COMPTABILITE.journal.length
            };
            
            return bilan;
        }
        
        // V√©rifier l'√©quilibre du bilan (Actif = Passif)
        function verifierEquilibreBilan() {
            const bilan = calculerBilan();
            const equilibre = bilan.equilibre;
            
            if (Math.abs(equilibre) > 1) { // Tol√©rance de 1‚Ç¨ pour arrondis
                console.warn(`‚ö†Ô∏è D√âS√âQUILIBRE BILAN: Actif ${bilan.actif.total}‚Ç¨ ‚â† Passif ${bilan.passif.total}‚Ç¨ (√©cart: ${equilibre}‚Ç¨)`);
                return { equilibre: false, ecart: equilibre, bilan };
            } else {
                console.log(`‚úÖ Bilan √©quilibr√©: ${bilan.actif.total}‚Ç¨`);
                return { equilibre: true, ecart: 0, bilan };
            }
        }
        
        // Enregistrer le bilan du tour (pour historique)
        function enregistrerBilanTour() {
            const bilan = calculerBilan();
            historiqueBilans.push(bilan);
            
            // Garder les 50 derniers bilans max
            if (historiqueBilans.length > 50) {
                historiqueBilans = historiqueBilans.slice(-50);
            }
            
            console.log(`üìä Bilan Tour ${bilan.tour} enregistr√© (score: ${bilan.scoreEconomique})`);
            return bilan;
        }
        
        // Comparer deux bilans
        function comparerBilans(bilanActuel, bilanPrecedent) {
            if (!bilanPrecedent) return null;
            
            return {
                deltaTour: bilanActuel.tour - bilanPrecedent.tour,
                deltaEuro: bilanActuel.actif.caisseEuro - bilanPrecedent.actif.caisseEuro,
                deltaEspoyr: bilanActuel.actif.caisseEspoyr - bilanPrecedent.actif.caisseEspoyr,
                deltaActivites: bilanActuel.actif.activites - bilanPrecedent.actif.activites,
                deltaEmprunts: bilanActuel.passif.emprunts - bilanPrecedent.passif.emprunts,
                deltaScore: bilanActuel.scoreEconomique - bilanPrecedent.scoreEconomique,
                tendance: bilanActuel.scoreEconomique > bilanPrecedent.scoreEconomique ? 'üìà' : 
                          bilanActuel.scoreEconomique < bilanPrecedent.scoreEconomique ? 'üìâ' : '‚û°Ô∏è'
            };
        }
        
        // ========== EXPORT CSV ==========
        
        // Exporter le journal comptable en CSV
        function exportJournalCSV() {
            const headers = ['ID', 'Date', 'Tour', 'Joueur', 'Libell√©', 'Compte D√©bit', 'Nom D√©bit', 'Compte Cr√©dit', 'Nom Cr√©dit', 'Montant ‚Ç¨', 'Montant #'];
            const rows = COMPTABILITE.journal.map(e => [
                e.id,
                e.timestamp,
                e.tour,
                e.joueurNom || '',
                e.libelle || '',
                e.debit?.compte || '',
                e.debit?.nom || '',
                e.credit?.compte || '',
                e.credit?.nom || '',
                e.debit?.euro || 0,
                e.debit?.espoyr || 0
            ]);
            
            return downloadCSV('espoyr_journal.csv', headers, rows);
        }
        
        // Exporter le bilan en CSV
        function exportBilanCSV() {
            const bilan = calculerBilan();
            const players = Object.values(playersData);
            
            const headers = ['Entit√©', 'Type', 'Caisse ‚Ç¨', 'Caisse #', 'Activit√©s', 'Emprunts', 'Net'];
            const rows = [];
            
            // Lignes joueurs
            players.forEach(p => {
                const bj = bilan.bilansJoueurs[p.id] || {};
                rows.push([
                    p.name,
                    'Joueur',
                    bj.actif?.euro || 0,
                    bj.actif?.espoyr || 0,
                    bj.actif?.activites || 0,
                    bj.passif?.emprunt || 0,
                    bj.net || 0
                ]);
            });
            
            // Ligne totaux
            rows.push([
                'TOTAL JOUEURS',
                'Total',
                bilan.actif.caisseEuro,
                bilan.actif.caisseEspoyr,
                bilan.actif.activites,
                bilan.passif.emprunts,
                bilan.actif.total - bilan.passif.emprunts
            ]);
            
            // Banque
            rows.push([
                'Banque',
                'Institution',
                bilan.bilanBanque.actif.creancesJoueurs,
                0,
                0,
                bilan.bilanBanque.passif.masseMonetaire,
                bilan.bilanBanque.actif.creancesJoueurs - bilan.bilanBanque.passif.masseMonetaire
            ]);
            
            // Pot AAA
            rows.push([
                'Pot AAA',
                'Institution',
                0,
                bilan.bilanAAA.passif.solde,
                0,
                0,
                bilan.bilanAAA.passif.solde
            ]);
            
            // √âtat
            rows.push([
                '√âtat',
                'Institution',
                bilan.bilanEtat.actif.tresor,
                0,
                0,
                0,
                bilan.bilanEtat.actif.tresor
            ]);
            
            return downloadCSV('espoyr_bilan.csv', headers, rows);
        }
        
        // Exporter l'historique des bilans en CSV
        function exportHistoriqueBilansCSV() {
            if (historiqueBilans.length === 0) {
                alert('Aucun historique de bilan. Cliquez sur "üì∏ Sauver ce bilan" d\'abord.');
                return;
            }
            
            const headers = ['Tour', 'Date', 'Caisse ‚Ç¨', 'Caisse #', 'Activit√©s', '√âquipements', 'Emprunts', 'Score √©conomique'];
            const rows = historiqueBilans.map(b => [
                b.tour,
                b.timestamp,
                b.actif.caisseEuro,
                b.actif.caisseEspoyr,
                b.actif.activites,
                b.actif.equipements,
                b.passif.emprunts,
                b.scoreEconomique
            ]);
            
            return downloadCSV('espoyr_historique.csv', headers, rows);
        }
        
        // Fonction utilitaire pour t√©l√©charger un CSV
        function downloadCSV(filename, headers, rows) {
            const csvContent = [
                headers.join(';'),
                ...rows.map(row => row.map(cell => 
                    typeof cell === 'string' && cell.includes(';') ? `"${cell}"` : cell
                ).join(';'))
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`üì• Export CSV: ${filename}`);
            return true;
        }
        
        // ========== √âCRITURES SP√âCIFIQUES ==========
        
        // Capital initial joueur (D:500 C:101)
        async function comptaCapitalInitial(joueurId, montant) {
            initCaisseJoueur(joueurId);
            COMPTABILITE.caisseJoueurs[joueurId].euro = montant;
            COMPTABILITE.caisseJoueurs[joueurId].capital = montant;
            
            // ========== MOD√àLE SANS D√âP√îTS CLIENTS ==========
            // Le capital initial des joueurs est une dotation externe (pas de la banque)
            // On l'enregistre dans les statistiques mais pas dans le bilan bancaire
            
            COMPTABILITE.banque.masseMonetaire += montant;
            
            // Journal banque
            if (!COMPTABILITE.banque.journalBanque) COMPTABILITE.banque.journalBanque = [];
            COMPTABILITE.banque.journalBanque.push({
                id: COMPTABILITE.banque.journalBanque.length + 1,
                type: 'CAPITAL_INITIAL_JOUEUR',
                libelle: `Dotation initiale ${playersData[joueurId]?.name || joueurId}`,
                montant: montant,
                timestamp: Date.now()
            });
            
            return enregistrerEcriture({
                joueurId, libelle: `Capital initial ${montant}‚Ç¨`,
                compteDebit: 500, compteCredit: 101, montantEuro: montant
            });
        }
        
        // Salaire selon profil (Contributif = √âtat, Cr√©atif = Exportation)
        // Salaire - PARTIE DOUBLE COMPL√àTE
        // Contributif: √âtat paie ‚Üí Joueur re√ßoit
        // Cr√©atif: Exportation paie ‚Üí Joueur re√ßoit
        async function comptaSalaire(joueurId, montant, deSalaire = 0) {
            initCaisseJoueur(joueurId);
            const player = playersData[joueurId];
            const profil = player?.profil || 'contributif';
            const ledgerEntryIds = [];
            
            // Joueur re√ßoit le salaire
            COMPTABILITE.caisseJoueurs[joueurId].euro += montant;
            COMPTABILITE.caisseJoueurs[joueurId].salairesRecus += montant;  // Cumul
            
            if (profil === 'creatif') {
                // Cr√©atif : pay√© par l'Exportation
                COMPTABILITE.exportation.solde -= montant;
                COMPTABILITE.exportation.salairesVerses += montant;
                
                // √âcriture 1: Joueur re√ßoit le salaire
                let e = enregistrerEcriture({
                    joueurId, 
                    libelle: `Salaire cr√©atif ${montant}‚Ç¨ (d√©:${deSalaire})`,
                    compteDebit: 500,   // Caisse (actif +)
                    compteCredit: 701,  // Salaires re√ßus (produit +)
                    montantEuro: montant,
                    details: { deSalaire, profil: 'creatif' },
                    contexte: 'exportation'
                });
                if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
                
                // √âcriture 2: Exportation verse le salaire
                e = enregistrerEcriture({
                    joueurId: 'EXPORTATION', 
                    libelle: `Versement salaire ${playersData[joueurId]?.name || joueurId} ${montant}‚Ç¨`,
                    compteDebit: 641,   // Salaires bruts (charge +)
                    compteCredit: 540,  // Compte Exportation (actif -)
                    montantEuro: montant,
                    contexte: 'exportation'
                });
                if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
                
            } else {
                // Contributif : pay√© par l'√âtat
                COMPTABILITE.etat.tresor -= montant;
                COMPTABILITE.etat.salairesVerses += montant;
                COMPTABILITE.etat.depenses.salaires += montant;  // Cumul d√©penses
                COMPTABILITE.etat.depenses.total += montant;
                
                // √âcriture 1: Joueur re√ßoit le salaire
                let e = enregistrerEcriture({
                    joueurId, 
                    libelle: `Salaire contributif ${montant}‚Ç¨`,
                    compteDebit: 500,   // Caisse (actif +)
                    compteCredit: 701,  // Salaires re√ßus (produit +)
                    montantEuro: montant,
                    details: { deSalaire, profil: 'contributif' },
                    contexte: 'etat'
                });
                if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
                
                // √âcriture 2: √âtat verse le salaire
                e = enregistrerEcriture({
                    joueurId: 'ETAT', 
                    libelle: `Versement salaire ${playersData[joueurId]?.name || joueurId} ${montant}‚Ç¨`,
                    compteDebit: 641,   // Salaires bruts (charge +)
                    compteCredit: 541,  // Compte √âtat (actif -)
                    montantEuro: montant,
                    contexte: 'etat'
                });
                if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            }
            
            return { ledgerEntryIds, montant, profil };
        }
        
        // Achat activit√© - PARTIE DOUBLE COMPL√àTE
        // D:200 C:500 pour l'achat + r√©partition 10% √âtat, 10% Export, 80% redistribu√©
        async function comptaAchatActivite(joueurId, actId, prix) {
            initCaisseJoueur(joueurId);
            initCaisseActivite(actId);
            
            const players = Object.values(playersData);
            const nbJoueurs = players.length || 1;
            const ledgerEntryIds = [];
            
            // ========== √âTAPE 5a : Facture d√©taill√©e activit√© libre ==========
            const facture = calculerFacture('activite_libre', prix);
            
            // Calcul r√©partition (bas√© sur facture)
            const partEtat = facture.destinationEtat;       // 10% (TVA/2 + Droits/2)
            const partExport = facture.destinationExport;   // 10% (TVA/2 + Droits/2)
            const partRedistrib = facture.ht;               // 80% HT
            const partParJoueur = Math.floor(partRedistrib / nbJoueurs);
            
            // D√©tail taxes pour √âtat et Export
            const tvaParEntite = Math.round(facture.tva / 2 * 100) / 100;
            const droitsParEntite = Math.round(facture.droits / 2 * 100) / 100;
            
            // MAJ soldes acheteur
            COMPTABILITE.caisseJoueurs[joueurId].euro -= prix;
            COMPTABILITE.caisseJoueurs[joueurId].apportsActivites += prix;
            COMPTABILITE.caisseActivites[actId].proprietaireId = joueurId;
            COMPTABILITE.caisseActivites[actId].capital = prix;
            
            // √âcriture 1a: Acheteur - Travaux HT (611)
            const travauxHT = Math.round(prix * 0.16 * 100) / 100;
            let e = enregistrerEcriture({
                joueurId, 
                libelle: `Travaux ${CASES[actId]?.name || actId} HT`,
                compteDebit: 611,   // Travaux (charge +)
                compteCredit: 500,  // Caisse (actif -)
                montantEuro: travauxHT, 
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 1b: Acheteur - Immobilisation HT (200)
            const activiteHT = Math.round(prix * 0.64 * 100) / 100;
            e = enregistrerEcriture({
                joueurId, 
                libelle: `Achat ${CASES[actId]?.name || actId} HT`,
                compteDebit: 200,   // Immobilisation (actif +)
                compteCredit: 500,  // Caisse (actif -)
                montantEuro: activiteHT, 
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 1c: Acheteur - TVA (635)
            e = enregistrerEcriture({
                joueurId, 
                libelle: `TVA achat ${CASES[actId]?.name || actId}`,
                compteDebit: 635,   // Taxes (charge +)
                compteCredit: 500,  // Caisse (actif -)
                montantEuro: facture.tva, 
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 1d: Acheteur - Droits (640)
            e = enregistrerEcriture({
                joueurId, 
                libelle: `Droits enregistrement ${CASES[actId]?.name || actId}`,
                compteDebit: 640,   // Droits (charge +)
                compteCredit: 500,  // Caisse (actif -)
                montantEuro: facture.droits, 
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // ========== √âTAT re√ßoit 50% des taxes (TVA + Droits) ==========
            COMPTABILITE.etat.tresor += partEtat;
            COMPTABILITE.etat.taxesRecues += partEtat;
            COMPTABILITE.etat.recettes.tva += tvaParEntite;
            COMPTABILITE.etat.recettes.droits += droitsParEntite;
            COMPTABILITE.etat.recettes.total += partEtat;
            COMPTABILITE.etat.grandLivre[500] += partEtat;
            COMPTABILITE.etat.grandLivre[704] += tvaParEntite;
            COMPTABILITE.etat.grandLivre[705] += droitsParEntite;
            
            // √âcriture 2a: √âtat - Recette TVA
            e = enregistrerEcriture({
                joueurId: 'ETAT', 
                libelle: `Recette TVA activit√© ${CASES[actId]?.name || actId}`,
                compteDebit: 500,   // Caisse √âtat (actif +)
                compteCredit: 704,  // Produits TVA (produit +)
                montantEuro: tvaParEntite,
                contexte: 'etat',
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 2b: √âtat - Recette Droits
            e = enregistrerEcriture({
                joueurId: 'ETAT', 
                libelle: `Recette Droits activit√© ${CASES[actId]?.name || actId}`,
                compteDebit: 500,   // Caisse √âtat (actif +)
                compteCredit: 705,  // Produits Droits (produit +)
                montantEuro: droitsParEntite,
                contexte: 'etat',
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // ========== EXPORTATION re√ßoit 50% des taxes ==========
            COMPTABILITE.exportation.solde += partExport;
            COMPTABILITE.exportation.recettes += partExport;
            
            // √âcriture 3a: Exportation - Recette TVA
            e = enregistrerEcriture({
                joueurId: 'EXPORTATION', 
                libelle: `Recette TVA activit√© ${CASES[actId]?.name || actId}`,
                compteDebit: 540,   // Compte Export (actif +)
                compteCredit: 704,  // Produits TVA (produit +)
                montantEuro: tvaParEntite,
                contexte: 'exportation',
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 3b: Exportation - Recette Droits
            e = enregistrerEcriture({
                joueurId: 'EXPORTATION', 
                libelle: `Recette Droits activit√© ${CASES[actId]?.name || actId}`,
                compteDebit: 540,   // Compte Export (actif +)
                compteCredit: 705,  // Produits Droits (produit +)
                montantEuro: droitsParEntite,
                contexte: 'exportation',
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // ========== 80% HT ‚Üí Redistribu√© √† tous les joueurs ==========
// ========== 80% HT ‚Üí Argents hors circuit (√©conomie sp√©culative / importation) ==========
            COMPTABILITE.horsCircuit.solde += partRedistrib;
            COMPTABILITE.horsCircuit.recettes += partRedistrib;
            COMPTABILITE.horsCircuit.grandLivre[550] += partRedistrib;
            COMPTABILITE.horsCircuit.grandLivre[792] += partRedistrib;
            
            // √âcriture 3c: Hors circuit - Captation HT
            e = enregistrerEcriture({
                joueurId: 'HORS_CIRCUIT',
                libelle: `√âconomie sp√©culative / importation (HT) ${CASES[actId]?.name || actId}`,
                compteDebit: 550,   // Argents hors circuit (actif +)
                compteCredit: 792,  // √âconomie sp√©culative / importation (produit +)
                montantEuro: partRedistrib,
                contexte: 'horsCircuit',
                activiteId: actId,
                details: { source: 'achat_activite', acheteur: joueurId }
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            
            return { partEtat, partExport, partRedistrib, partParJoueur: 0, partHorsCircuit: partRedistrib, bonusHash: 0, facture, ledgerEntryIds };
        }
        
        // Achat √©quipement (D:218 C:500)
        // Achat √©quipement A - DURABLE (D:210 C:500 + bonus # du pot AAA)
        // 1er A: co√ªt=70% prix, bonus=100% de diff (A-B)
        // A suppl√©mentaire: co√ªt=50% prix, bonus=100% du co√ªt
        async function comptaAchatEquipementA(joueurId, actId) {
            initCaisseJoueur(joueurId);
            initCaisseActivite(actId);
            
            const c = CASES[actId];
            const act = COMPTABILITE.caisseActivites[actId];
            const nbAActuel = act.equipementA || 0;
            const cout = getCoutEquipement(actId, 'A', nbAActuel);
            const bonusHash = nbAActuel === 0 ? getBonusHash(actId, 'A_FIRST') : getBonusHash(actId, 'A_ADDITIONAL');
            const ledgerEntryIds = [];
            
            COMPTABILITE.caisseJoueurs[joueurId].euro -= cout;
            act.equipements = (act.equipements || 0) + 1;
            act.equipementA = (act.equipementA || 0) + 1;
            
            // √âtat re√ßoit le paiement
            COMPTABILITE.etat.tresor += cout;
            COMPTABILITE.etat.recettes.total = (COMPTABILITE.etat.recettes.total || 0) + cout;
            
            // √âcriture 1: Joueur - √âquipement
            let e = enregistrerEcriture({
                joueurId, libelle: `üåø √âquipement A ${c?.name || actId} (${fmt(cout)}‚Ç¨)`,
                compteDebit: 210, compteCredit: 500, montantEuro: cout, activiteId: actId,
                details: { type: 'equipementA', cout, bonusHash }
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 2: √âtat - Recette
            e = enregistrerEcriture({
                joueurId: 'ETAT', libelle: `Recette √©quipement A ${c?.name || actId}`,
                compteDebit: 541, compteCredit: 703, montantEuro: cout,
                contexte: 'etat', activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // Bonus # (du Pot AAA)
            if (bonusHash > 0 && (COMPTABILITE.potAAA?.solde || 0) >= bonusHash) {
                COMPTABILITE.caisseJoueurs[joueurId].espoyr = (COMPTABILITE.caisseJoueurs[joueurId].espoyr || 0) + bonusHash;
                COMPTABILITE.potAAA.solde -= bonusHash;
                COMPTABILITE.potAAA.circulationHash = (COMPTABILITE.potAAA.circulationHash || 0) + bonusHash;
                
                e = enregistrerEcriture({
                    joueurId, libelle: `Compensation # √©quipement A (+${fmt(bonusHash)}#)`,
                    compteDebit: 501, compteCredit: 468, montantEspoyr: bonusHash, activiteId: actId,
                    contexte: 'potAAA'
                });
                if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            }
            
            return { cout, bonusHash, ledgerEntryIds };
        }
        
        // Achat √©quipement B - CLASSIQUE (D:220 C:500, pas de bonus)
        // Co√ªt = 50% du prix activit√©
        async function comptaAchatEquipementB(joueurId, actId) {
            initCaisseJoueur(joueurId);
            initCaisseActivite(actId);
            
            const c = CASES[actId];
            const cout = getPrixB(actId);
            const ledgerEntryIds = [];
            
            COMPTABILITE.caisseJoueurs[joueurId].euro -= cout;
            COMPTABILITE.caisseActivites[actId].equipements = (COMPTABILITE.caisseActivites[actId].equipements || 0) + 1;
            COMPTABILITE.caisseActivites[actId].equipementB = (COMPTABILITE.caisseActivites[actId].equipementB || 0) + 1;
            
            // √âtat re√ßoit
            COMPTABILITE.etat.tresor += cout;
            COMPTABILITE.etat.recettes.total = (COMPTABILITE.etat.recettes.total || 0) + cout;
            
            // √âcriture 1: Joueur
            let e = enregistrerEcriture({
                joueurId, libelle: `‚ùÑÔ∏è √âquipement B ${c?.name || actId} (${fmt(cout)}‚Ç¨)`,
                compteDebit: 220, compteCredit: 500, montantEuro: cout, activiteId: actId,
                details: { type: 'equipementB', cout }
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 2: √âtat
            e = enregistrerEcriture({
                joueurId: 'ETAT', libelle: `Recette √©quipement B ${c?.name || actId}`,
                compteDebit: 541, compteCredit: 703, montantEuro: cout,
                contexte: 'etat', activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            return { cout, ledgerEntryIds };
        }
        
        // Conversion B‚ÜíA : paie la diff√©rence, re√ßoit 50% en #
        async function comptaConversionBtoA(joueurId, actId) {
            initCaisseJoueur(joueurId);
            initCaisseActivite(actId);
            
            const c = CASES[actId];
            const cout = getDifferenceAB(actId);
            const bonusHash = getBonusHash(actId, 'B_TO_A');
            const ledgerEntryIds = [];
            
            COMPTABILITE.caisseJoueurs[joueurId].euro -= cout;
            COMPTABILITE.caisseActivites[actId].equipementB = Math.max(0, (COMPTABILITE.caisseActivites[actId].equipementB || 0) - 1);
            COMPTABILITE.caisseActivites[actId].equipementA = (COMPTABILITE.caisseActivites[actId].equipementA || 0) + 1;
            
            // √âtat re√ßoit la diff√©rence
            COMPTABILITE.etat.tresor += cout;
            COMPTABILITE.etat.recettes.total = (COMPTABILITE.etat.recettes.total || 0) + cout;
            
            // √âcriture 1: Joueur - Conversion
            let e = enregistrerEcriture({
                joueurId, libelle: `üîÑ Conversion B‚ÜíA ${c?.name || actId} (${fmt(cout)}‚Ç¨)`,
                compteDebit: 210, compteCredit: 500, montantEuro: cout, activiteId: actId,
                details: { type: 'conversionBtoA', cout, bonusHash }
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 2: √âtat
            e = enregistrerEcriture({
                joueurId: 'ETAT', libelle: `Recette conversion B‚ÜíA ${c?.name || actId}`,
                compteDebit: 541, compteCredit: 703, montantEuro: cout,
                contexte: 'etat', activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // Bonus # (50% de la diff√©rence)
            if (bonusHash > 0 && (COMPTABILITE.potAAA?.solde || 0) >= bonusHash) {
                COMPTABILITE.caisseJoueurs[joueurId].espoyr = (COMPTABILITE.caisseJoueurs[joueurId].espoyr || 0) + bonusHash;
                COMPTABILITE.potAAA.solde -= bonusHash;
                COMPTABILITE.potAAA.circulationHash = (COMPTABILITE.potAAA.circulationHash || 0) + bonusHash;
                
                e = enregistrerEcriture({
                    joueurId, libelle: `Compensation # conversion B‚ÜíA (50% diff: +${fmt(bonusHash)}#)`,
                    compteDebit: 501, compteCredit: 468, montantEspoyr: bonusHash, activiteId: actId,
                    contexte: 'potAAA'
                });
                if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            }
            
            return { cout, bonusHash, ledgerEntryIds };
        }
        
        // Fonction legacy pour compatibilit√©
        async function comptaAchatEquipement(joueurId, actId, prix) {
            initCaisseJoueur(joueurId);
            initCaisseActivite(actId);
            COMPTABILITE.caisseJoueurs[joueurId].euro -= prix;
            COMPTABILITE.caisseActivites[actId].equipements++;
            return enregistrerEcriture({
                joueurId, libelle: `√âquipement ${CASES[actId]?.name || actId}`,
                compteDebit: 218, compteCredit: 500, montantEuro: prix, activiteId: actId
            });
        }
        
        // Paiement facture (D:613 C:500 payeur + D:500 C:700 propri√©taire)
        // Paiement facture - PARTIE DOUBLE COMPL√àTE
        // Le payeur paie une charge, le propri√©taire re√ßoit un produit
        async function comptaPaiementFacture(payeurId, proprietaireId, actId, montantEuro, montantEspoyr = 0) {
            initCaisseJoueur(payeurId);
            initCaisseJoueur(proprietaireId);
            initCaisseActivite(actId);
            
            const c = CASES[actId];
            const ledgerEntryIds = [];
            
            // ========== √âTAPE 5b : TVA extraite vers √âtat ==========
            // Montant TTC pay√©, TVA 21% extraite
            const facture = calculerFacture('facture_joueur', montantEuro);
            const montantHT = facture.ht;           // Propri√©taire re√ßoit HT
            const montantTVA = facture.tva;         // √âtat re√ßoit TVA
            
            const total = montantEuro + montantEspoyr;
            
            // MAJ soldes payeur (sort TTC de sa caisse)
            COMPTABILITE.caisseJoueurs[payeurId].euro -= montantEuro;
            COMPTABILITE.caisseJoueurs[payeurId].espoyr -= montantEspoyr;
            COMPTABILITE.caisseJoueurs[payeurId].facturesPayees += montantEuro;  // Cumul payeur
            COMPTABILITE.caisseJoueurs[payeurId].taxesPayees += montantTVA;      // Cumul TVA
            
            // MAJ soldes propri√©taire (re√ßoit HT seulement)
            COMPTABILITE.caisseJoueurs[proprietaireId].euro += montantHT;
            COMPTABILITE.caisseJoueurs[proprietaireId].espoyr += montantEspoyr;
            COMPTABILITE.caisseJoueurs[proprietaireId].facturesRecues += montantHT;  // Cumul propri√©taire
            
            // MAJ caisse activit√© (statistiques)
            COMPTABILITE.caisseActivites[actId].recettes += total;
            
            // √âcriture 1a: Payeur - charge HT
            let e = enregistrerEcriture({
                joueurId: payeurId, 
                libelle: `Paiement ${c?.name || actId} HT`,
                compteDebit: 613,   // Frais divers (charge +)
                compteCredit: 500,  // Caisse ‚Ç¨ (actif -)
                montantEuro: montantHT, 
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 1b: Payeur - TVA (charge)
            e = enregistrerEcriture({
                joueurId: payeurId, 
                libelle: `TVA ${c?.name || actId}`,
                compteDebit: 635,   // Taxes (charge +)
                compteCredit: 500,  // Caisse ‚Ç¨ (actif -)
                montantEuro: montantTVA, 
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 1c: Payeur - # si applicable
            if (montantEspoyr > 0) {
                e = enregistrerEcriture({
                    joueurId: payeurId, 
                    libelle: `Paiement # ${c?.name || actId}`,
                    compteDebit: 468,
                    compteCredit: 501,  // Caisse # (actif -)
                    montantEspoyr, 
                    activiteId: actId
                });
                if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            }
            
            // √âcriture 2: Propri√©taire - produit HT
            e = enregistrerEcriture({
                joueurId: proprietaireId, 
                libelle: `Recette ${c?.name || actId} HT`,
                compteDebit: 500,   // Caisse ‚Ç¨ (actif +)
                compteCredit: 700,  // Ventes/Factures (produit +)
                montantEuro: montantHT, 
activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 2b: Propri√©taire - r√©ception # (consigne)
            if (montantEspoyr > 0) {
                e = enregistrerEcriture({
                    joueurId: proprietaireId,
                    libelle: `R√©ception # ${c?.name || actId}`,
                    compteDebit: 501,   // Caisse # (actif +)
                    compteCredit: 468, // Consignes Espoyr # (passif +)
                    montantEspoyr,
                    activiteId: actId
                });
                if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            }

            
            // ========== √âtat re√ßoit la TVA ==========
            COMPTABILITE.etat.tresor += montantTVA;
            COMPTABILITE.etat.recettes.tva += montantTVA;
            COMPTABILITE.etat.recettes.total += montantTVA;
            COMPTABILITE.etat.grandLivre[500] += montantTVA;
            COMPTABILITE.etat.grandLivre[704] += montantTVA;
            
            // √âcriture 3: √âtat - Recette TVA
            e = enregistrerEcriture({
                joueurId: 'ETAT', 
                libelle: `Recette TVA facture ${c?.name || actId}`,
                compteDebit: 500,   // Caisse √âtat (actif +)
                compteCredit: 704,  // Produits TVA (produit +)
                montantEuro: montantTVA,
                contexte: 'etat',
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            return { montantEuro, montantHT, montantTVA, montantEspoyr, total, facture, ledgerEntryIds };
        }
        
        // ========== SURPLUS ‚Ç¨‚Üí# (√©change de moyen de paiement via 468 transit) ==========
        // Le payeur donne un surplus en ‚Ç¨ au propri√©taire et re√ßoit l'√©quivalent en #
        // Aucun impact TVA ni chiffre d'affaires ‚Äî √©change pur
        async function comptaSurplusEuroHash(payeurId, proprietaireId, actId, surplus) {
            initCaisseJoueur(payeurId);
            initCaisseJoueur(proprietaireId);
            
            const c = CASES[actId];
            const ledgerEntryIds = [];
            surplus = arrondir2(surplus);
            
            // √âcriture 1: Payeur ‚Äî ‚Ç¨ sort via transit 468
            let e = enregistrerEcriture({
                joueurId: payeurId,
                libelle: `Surplus ‚Ç¨ √©change # ${c?.name || actId}`,
                compteDebit: 468,   // Consignes Espoyr # (transit)
                compteCredit: 500,  // Caisse ‚Ç¨ (sort)
                montantEuro: surplus,
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 2: Payeur ‚Äî re√ßoit # depuis transit 468
            e = enregistrerEcriture({
                joueurId: payeurId,
                libelle: `R√©ception # surplus ${c?.name || actId}`,
                compteDebit: 501,   // Caisse # (entre)
                compteCredit: 468,  // Consignes Espoyr # (transit sold√©)
                montantEspoyr: surplus,
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 3: Propri√©taire ‚Äî re√ßoit surplus ‚Ç¨
            e = enregistrerEcriture({
                joueurId: proprietaireId,
                libelle: `R√©ception surplus ‚Ç¨ ${c?.name || actId}`,
                compteDebit: 500,   // Caisse ‚Ç¨ (entre)
                compteCredit: 468,  // Consignes Espoyr # (transit)
                montantEuro: surplus,
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 4: Propri√©taire ‚Äî donne # en retour
            e = enregistrerEcriture({
                joueurId: proprietaireId,
                libelle: `Rendu # surplus ${c?.name || actId}`,
                compteDebit: 468,   // Consignes Espoyr # (transit sold√©)
                compteCredit: 501,  // Caisse # (sort)
                montantEspoyr: surplus,
                activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // Mise √† jour caisses
            COMPTABILITE.caisseJoueurs[payeurId].euro -= surplus;
            COMPTABILITE.caisseJoueurs[payeurId].espoyr += surplus;
            COMPTABILITE.caisseJoueurs[proprietaireId].euro += surplus;
            COMPTABILITE.caisseJoueurs[proprietaireId].espoyr -= surplus;
            
            return { surplus, ledgerEntryIds };
        }
        
        // Travail coop√©ratif (D:501 C:706 pour les deux)
        async function comptaTravailCoop(travailleurId, proprietaireId, actId, gainHash) {
            initCaisseJoueur(travailleurId);
            initCaisseJoueur(proprietaireId);
            
            // Travailleur gagne #
            COMPTABILITE.caisseJoueurs[travailleurId].espoyr += gainHash;
            COMPTABILITE.potAAA.solde -= gainHash;
            COMPTABILITE.potAAA.circulationHash += gainHash;
            
            enregistrerEcriture({
                joueurId: travailleurId, libelle: `Travail coop (gain)`,
                compteDebit: 501, compteCredit: 468, montantEspoyr: gainHash, activiteId: actId
            });
            
            // Propri√©taire gagne aussi #
            COMPTABILITE.caisseJoueurs[proprietaireId].espoyr += gainHash;
            COMPTABILITE.potAAA.solde -= gainHash;
            COMPTABILITE.potAAA.circulationHash += gainHash;
            
            return enregistrerEcriture({
                joueurId: proprietaireId, libelle: `Travail coop (bonus)`,
                compteDebit: 501, compteCredit: 468, montantEspoyr: gainHash, activiteId: actId
            });
        }
        
        // Emprunt bancaire (D:512 C:164)
        // Emprunt bancaire - PARTIE DOUBLE COMPL√àTE
        // Joueur: D:500 (Caisse +) C:164 (Dette emprunt +)
        // Banque: D:280 (Cr√©ance +) C:101 (Cr√©ation mon√©taire)
        async function comptaEmprunt(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            // MAJ soldes joueur
            COMPTABILITE.caisseJoueurs[joueurId].euro += montant;
            COMPTABILITE.caisseJoueurs[joueurId].emprunt += montant;
            
            // MAJ soldes banque - √âQUILIBRE ACTIF = PASSIF
            COMPTABILITE.banque.creancesJoueurs += montant;  // ACTIF: Cr√©ances +
            COMPTABILITE.banque.capital += montant;           // PASSIF: Capital (cr√©ation mon√©taire) +
            COMPTABILITE.banque.masseMonetaire += montant;    // Statistique: masse mon√©taire en circulation
            
            // ===== NOUVEAU: Comptabilit√© bancaire formalis√©e =====
            const loanId = `LOAN_${joueurId}_${Date.now()}`;
            banqueCreerPret(joueurId, montant, loanId);
            
            const ledgerEntryIds = [];
            
            // √âcriture 1: Joueur re√ßoit l'argent et reconna√Æt la dette
            let e = enregistrerEcriture({
                joueurId, 
                libelle: `Emprunt bancaire ${montant}‚Ç¨`,
                compteDebit: 500,   // Caisse (actif +)
                compteCredit: 164,  // Emprunts (passif +)
                montantEuro: montant,
                contexte: 'banque'
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 2: Banque cr√©e la monnaie et enregistre la cr√©ance
            e = enregistrerEcriture({
                joueurId: 'BANQUE', 
                libelle: `Pr√™t √† ${playersData[joueurId]?.name || joueurId} ${montant}‚Ç¨`,
                compteDebit: 280,   // Cr√©ances sur joueurs (actif +)
                compteCredit: 101,  // Capital / Cr√©ation mon√©taire (passif +)
                montantEuro: montant,
                contexte: 'banque'
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            return { ledgerEntryIds, montant, loanId };
        }
        
        // Int√©r√™ts - PARTIE DOUBLE COMPL√àTE
        // Paiement des int√©r√™ts depuis la caisse si possible, sinon capitalisation
        // Joueur pay√©: D:661 (Charge int√©r√™ts) C:500 (Caisse -)
        // Joueur impay√©: D:661 (Charge int√©r√™ts) C:164 (Dette +)
        // Banque: D:280 (Cr√©ance +) C:762 (Produits financiers)
        async function comptaInterets(joueurId, montant) {
            initCaisseJoueur(joueurId);
            const caisse = COMPTABILITE.caisseJoueurs[joueurId];
            
            // Calcul: payer en cash si possible, sinon capitaliser
            const montantPaye = Math.min(montant, Math.max(0, caisse.euro || 0));
            const montantImpaye = montant - montantPaye;
            
            // === Partie pay√©e en cash ===
            if (montantPaye > 0) {
                // MAJ soldes joueur
                caisse.euro -= montantPaye;
                caisse.interetsPayes += montantPaye;
                
                // MAJ soldes banque
                COMPTABILITE.banque.interetsRecus += montantPaye;
                
                // Comptabilit√© bancaire formalis√©e
                banqueEncaisserInterets(joueurId, montantPaye);
                
                // √âcriture joueur: charge pay√©e
                enregistrerEcriture({
                    joueurId, 
                    libelle: `Int√©r√™ts pay√©s ${montantPaye}‚Ç¨`,
                    compteDebit: 661,   // Charges d'int√©r√™ts
                    compteCredit: 500,  // Caisse (sortie cash)
                    montantEuro: montantPaye,
                    contexte: 'banque'
                });
                
                // √âcriture banque: produit financier re√ßu
                enregistrerEcriture({
                    joueurId: 'BANQUE', 
                    libelle: `Int√©r√™ts re√ßus de ${playersData[joueurId]?.name || joueurId} ${montantPaye}‚Ç¨`,
                    compteDebit: 500,   // Caisse banque
                    compteCredit: 762,  // Produits financiers
                    montantEuro: montantPaye,
                    contexte: 'banque'
                });
            }
            
            // === Partie impay√©e (capitalis√©e) ===
            if (montantImpaye > 0) {
                // MAJ soldes joueur
                caisse.interetsDus += montantImpaye;
                caisse.emprunt += montantImpaye;  // Capitalisation: dette augmente
                
                // MAJ soldes banque
                COMPTABILITE.banque.interetsRecus += montantImpaye;
                COMPTABILITE.banque.creancesJoueurs += montantImpaye;
                
                // Comptabilit√© bancaire formalis√©e (int√©r√™ts √† recevoir)
                banqueEncaisserInterets(joueurId, montantImpaye);
                
                // √âcriture joueur: charge capitalis√©e
                enregistrerEcriture({
                    joueurId, 
                    libelle: `Int√©r√™ts capitalis√©s ${montantImpaye}‚Ç¨`,
                    compteDebit: 661,   // Charges d'int√©r√™ts
                    compteCredit: 164,  // Emprunts (dette +)
                    montantEuro: montantImpaye,
                    contexte: 'banque'
                });
                
                // √âcriture banque: cr√©ance + produit
                enregistrerEcriture({
                    joueurId: 'BANQUE', 
                    libelle: `Int√©r√™ts √† recevoir de ${playersData[joueurId]?.name || joueurId} ${montantImpaye}‚Ç¨`,
                    compteDebit: 280,   // Cr√©ances
                    compteCredit: 762,  // Produits financiers
                    montantEuro: montantImpaye,
                    contexte: 'banque'
                });
            }
            
            recalculerContraintesBanque();
            
            return { montant, montantPaye, montantImpaye };
        }
        
        // Remboursement emprunt - PARTIE DOUBLE COMPL√àTE
        // Joueur: D:164 (Dette -) C:500 (Caisse -)
        // Banque: D:101 (Destruction mon√©taire) C:280 (Cr√©ance -)
        async function comptaRemboursement(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            // MAJ soldes joueur
            COMPTABILITE.caisseJoueurs[joueurId].euro -= montant;
            COMPTABILITE.caisseJoueurs[joueurId].emprunt -= montant;
            
            // MAJ soldes banque - √âQUILIBRE ACTIF = PASSIF
            COMPTABILITE.banque.creancesJoueurs -= montant;  // ACTIF: Cr√©ances -
            COMPTABILITE.banque.capital -= montant;           // PASSIF: Capital (destruction mon√©taire) -
            COMPTABILITE.banque.masseMonetaire -= montant;    // Statistique: masse mon√©taire en circulation
            
            // ===== NOUVEAU: Comptabilit√© bancaire formalis√©e =====
            banqueRembourserCapital(joueurId, montant);
            
            const ledgerEntryIds = [];
            
            // √âcriture 1: Joueur paie et r√©duit sa dette
            let e = enregistrerEcriture({
                joueurId, 
                libelle: `Remboursement emprunt ${montant}‚Ç¨`,
                compteDebit: 164,   // Emprunts (passif -)
                compteCredit: 500,  // Caisse (actif -)
                montantEuro: montant,
                contexte: 'banque'
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 2: Banque d√©truit la monnaie et annule la cr√©ance
            e = enregistrerEcriture({
                joueurId: 'BANQUE', 
                libelle: `Remboursement de ${playersData[joueurId]?.name || joueurId} ${montant}‚Ç¨`,
                compteDebit: 101,   // Capital / Destruction mon√©taire (passif -)
                compteCredit: 280,  // Cr√©ances sur joueurs (actif -)
                montantEuro: montant,
                contexte: 'banque'
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            return { ledgerEntryIds, montant };
        }
        
        // ========== COMPTABILIT√â BANCAIRE FORMALIS√âE ==========
        // Selon document: E=encours, t=taux, i=int√©r√™ts, c=capital rembours√©, C=10%E, P=5%E
        
        // Enregistrer √©criture dans le journal banque (format replay)
        function enregistrerEcritureBanque(params) {
            const {
                event_type,
                debit_account,
                credit_account,
                amount,
                playerId = null,
                loanId = null,
                description = ''
            } = params;
            
            normalizeComptabilite();

            // Garde-fou: aucune √©criture banque ne peut √™tre cr√©√©e avec des comptes ou montants invalides
            if (debit_account == null || credit_account == null || amount == null || !isFinite(amount)) {
                console.error("‚ùå √âcriture banque invalide (ignor√©e)", { event_type, debit_account, credit_account, amount, playerId, loanId, description });
                return null;
            }

            // Calcul des m√©ta-donn√©es
            const gl_meta = COMPTABILITE.banque.grandLivre || {};
            const E = (gl_meta[1200] || 0);
            COMPTABILITE.banque.E = E; // compat
            const t = COMPTABILITE.banque.t;
            const i = t * E;
            const c = 0; // √Ä calculer selon contexte
            const C = 0.10 * E;
            const P = 0.05 * E;
            
            const entry = {
                timestamp: new Date().toISOString(),
                event_type,
                debit_account: String(debit_account),
                credit_account: String(credit_account),
                amount,
                meta: { E, t, i, c, C, P, playerId, loanId },
                description,
                turn: gameState?.turn || 0,
                phase: gameState?.phase || 0
            };
            
            COMPTABILITE.banque.journalBanque.push(entry);
            
            // MAJ grand-livre banque
            if (COMPTABILITE.banque.grandLivre[debit_account] !== undefined) {
                const compte = PLAN_COMPTABLE_BANQUE[debit_account];
                if (compte?.type === 'actif' || compte?.type === 'charge') {
                    COMPTABILITE.banque.grandLivre[debit_account] += amount;
                } else {
                    COMPTABILITE.banque.grandLivre[debit_account] -= amount;
                }
            }
            if (COMPTABILITE.banque.grandLivre[credit_account] !== undefined) {
                const compte = PLAN_COMPTABLE_BANQUE[credit_account];
                if (compte?.type === 'passif' || compte?.type === 'capitaux' || compte?.type === 'produit') {
                    COMPTABILITE.banque.grandLivre[credit_account] += amount;
                } else {
                    COMPTABILITE.banque.grandLivre[credit_account] -= amount;
                }
            }
            
            console.log(`üìí Banque: ${event_type} D:${debit_account} C:${credit_account} ${amount}‚Ç¨`);
            return entry;
        }
        
        // V√©rifier si la banque peut accorder un pr√™t (contrainte prudentielle)
        function banquePeutPreter(montantDemande) {
            normalizeComptabilite();
            const gl = COMPTABILITE.banque.grandLivre || {};
            const E_actuel = (gl[1200] || 0);
            const E_apres = E_actuel + montantDemande;
            const C_requis = 0.10 * E_apres;
            
            // Capital disponible = Capital + R√©serves
            const capitalDisponible = COMPTABILITE.banque.grandLivre[3000] + COMPTABILITE.banque.grandLivre[3100];
            
            const peutPreter = capitalDisponible >= C_requis;
            
            return {
                peutPreter,
                E_actuel,
                E_apres,
                C_requis,
                capitalDisponible,
                deficit: peutPreter ? 0 : C_requis - capitalDisponible
            };
        }
        
        // Recalculer les contraintes prudentielles
        function recalculerContraintesBanque() {
            normalizeComptabilite();
            const gl = COMPTABILITE.banque.grandLivre || {};
            // Source de v√©rit√©: le ledger 1200
            const E = (gl[1200] ?? 0);

            // Conserver la variable E pour compatibilit√©, mais ne jamais l'utiliser comme source
            COMPTABILITE.banque.E = E;
            COMPTABILITE.banque.C_requis = 0.10 * E;
            COMPTABILITE.banque.P_requis = arrondir2(0.05 * E);

            return {
                E,
                C_requis: COMPTABILITE.banque.C_requis,
                P_requis: COMPTABILITE.banque.P_requis
            };
        }
        
        // Ajuster la provision (si diff√©rence avec P_requis)
        function ajusterProvisionBanque() {
            normalizeComptabilite();
            const P_requis = COMPTABILITE.banque.P_requis;
            const P_actuel = COMPTABILITE.banque.grandLivre[2290];
            const deltaP = arrondir2(P_requis - P_actuel);
            
            if (Math.abs(deltaP) > 0.01) {
                if (deltaP > 0) {
                    // Dotation provision (charge)
                    enregistrerEcritureBanque({
                        event_type: 'PROVISION_DOTATION',
                        debit_account: 5000,  // Dotation provision (charge)
                        credit_account: 2290, // Provision pertes
                        amount: arrondir2(deltaP),
                        description: `Dotation provision +${deltaP.toFixed(2)}‚Ç¨ (P=${P_requis.toFixed(2)}‚Ç¨)`
                    });
                } else {
                    // Reprise provision (diminution)
                    enregistrerEcritureBanque({
                        event_type: 'PROVISION_REPRISE',
                        debit_account: 2290,  // Provision pertes
                        credit_account: 4000, // Produits (reprise)
                        amount: arrondir2(Math.abs(deltaP)),
                        description: `Reprise provision -${Math.abs(deltaP).toFixed(2)}‚Ç¨ (P=${P_requis.toFixed(2)}‚Ç¨)`
                    });
                }
            }
            
            return { P_requis, P_actuel, deltaP };
        }
        
        // ========== INITIALISATION DU CAPITAL BANCAIRE ==========
        function initialiserCapitalBanque(montant = null) {
            normalizeComptabilite();
            
            const capitalInitial = montant || CONFIG.banqueCapitalInitial || 1000;
            
            // V√©rifier si d√©j√† initialis√©
            if (COMPTABILITE.banque.grandLivre[3000] > 0) {
                console.log('üè¶ Capital banque d√©j√† initialis√©');
                return { alreadyInitialized: true, capital: COMPTABILITE.banque.grandLivre[3000] };
            }
            
            // Initialiser le capital banque : D:1010 R√©serves / C:3000 Capital
            COMPTABILITE.banque.grandLivre[1010] = (COMPTABILITE.banque.grandLivre[1010] || 0) + capitalInitial;
            COMPTABILITE.banque.grandLivre[3000] = (COMPTABILITE.banque.grandLivre[3000] || 0) + capitalInitial;
            
            // Journal
            if (!COMPTABILITE.banque.journalBanque) COMPTABILITE.banque.journalBanque = [];
            COMPTABILITE.banque.journalBanque.push({
                id: COMPTABILITE.banque.journalBanque.length + 1,
                type: 'BANK_INIT_CAPITAL',
                libelle: `Apport capital initial banque`,
                montant: capitalInitial,
                timestamp: Date.now()
            });
            
            console.log(`üè¶ Capital banque initialis√©: ${capitalInitial}‚Ç¨`);
            return { success: true, capital: capitalInitial };
        }
        
        // Cr√©ation d'un pr√™t (augmentation de E de +ŒîE)
        // Mod√®le sans d√©p√¥ts: D:1200 Cr√©ances, C:1010 R√©serves
        function banqueCreerPret(joueurId, montant, loanId = null) {
            normalizeComptabilite();
            
            // V√©rifier contrainte prudentielle
            const verif = banquePeutPreter(montant);
            if (!verif.peutPreter) {
                console.warn(`üè¶ Banque: Capital insuffisant pour pr√™t ${montant}‚Ç¨ (d√©ficit: ${verif.deficit.toFixed(2)}‚Ç¨)`);
            }
            
            // MAJ encours
            const E_avant = COMPTABILITE.banque.E;
            COMPTABILITE.banque.E += montant;
            COMPTABILITE.banque.totalPretsAccordes += montant;
            
            // √âcriture: Cr√©ation du pr√™t (mod√®le sans d√©p√¥ts)
            enregistrerEcritureBanque({
                event_type: 'LOAN_CREATE',
                debit_account: 1200,  // Cr√©ances joueurs (actif +)
                credit_account: 1010, // R√©serves banque (actif -)
                amount: montant,
                playerId: joueurId,
                loanId: loanId || `LOAN_${Date.now()}`,
                description: `Pr√™t √† ${playersData[joueurId]?.name || joueurId}: E ${E_avant}‚Üí${COMPTABILITE.banque.E}‚Ç¨`
            });
            
            // Recalculer contraintes
            recalculerContraintesBanque();
            
            // Ajuster provision
            ajusterProvisionBanque();
            
            return {
                success: true,
                E_avant,
                E_apres: COMPTABILITE.banque.E,
                montant,
                C_requis: COMPTABILITE.banque.C_requis,
                P_requis: COMPTABILITE.banque.P_requis
            };
        }
        
        // Paiement p√©riodique: Int√©r√™ts (i = t √ó E)
        // Les int√©r√™ts re√ßus augmentent les r√©serves: D:1010 R√©serves, C:4000 Produits
        function banqueEncaisserInterets(joueurId, montant, loanId = null) {
            normalizeComptabilite();
            
            // MAJ cumul int√©r√™ts
            COMPTABILITE.banque.cumInterets += montant;
            
            // √âcriture: Paiement des int√©r√™ts (augmente les r√©serves)
            enregistrerEcritureBanque({
                event_type: 'INTEREST_PAYMENT',
                debit_account: 1010,  // R√©serves banque (actif +)
                credit_account: 4000, // Produits d'int√©r√™ts (produit +)
                amount: montant,
                playerId: joueurId,
                loanId,
                description: `Int√©r√™ts de ${playersData[joueurId]?.name || joueurId}: ${montant}‚Ç¨ (t=${(COMPTABILITE.banque.t*100).toFixed(0)}%)`
            });
            
            return { success: true, montant, cumInterets: COMPTABILITE.banque.cumInterets };
        }
        
        // Remboursement du capital (c)
        // Le remboursement revient dans les r√©serves: D:1010 R√©serves, C:1200 Cr√©ances
        function banqueRembourserCapital(joueurId, montant, loanId = null) {
            normalizeComptabilite();
            
            const E_avant = COMPTABILITE.banque.E;
            COMPTABILITE.banque.E -= montant;
            COMPTABILITE.banque.cumCapital += montant;
            COMPTABILITE.banque.totalRembourse += montant;
            
            // √âcriture: Remboursement capital (l'argent revient dans les r√©serves)
            enregistrerEcritureBanque({
                event_type: 'CAPITAL_REPAYMENT',
                debit_account: 1010,  // R√©serves banque (actif +)
                credit_account: 1200, // Cr√©ances joueurs (actif -)
                amount: montant,
                playerId: joueurId,
                loanId,
                description: `Remboursement capital ${playersData[joueurId]?.name || joueurId}: E ${E_avant}‚Üí${COMPTABILITE.banque.E}‚Ç¨`
            });
            
            // Recalculer contraintes
            recalculerContraintesBanque();
            
            // Ajuster provision (devrait diminuer)
            ajusterProvisionBanque();
            
            return {
                success: true,
                E_avant,
                E_apres: COMPTABILITE.banque.E,
                montant,
                C_requis: COMPTABILITE.banque.C_requis,
                P_requis: COMPTABILITE.banque.P_requis
            };
        }
        
        // D√©faut de paiement (perte L)
        // Si provision suffisante: D:2290 Provision, C:1200 Encours
        // Sinon: D:5900 Perte, C:1200 Encours (ou D:3100 R√©serves)
        function banqueEnregistrerDefaut(joueurId, montantPerte, loanId = null) {
            normalizeComptabilite();
            
            const P_disponible = COMPTABILITE.banque.grandLivre[2290];
            const E_avant = COMPTABILITE.banque.E;
            
            COMPTABILITE.banque.E -= montantPerte;
            COMPTABILITE.banque.defauts += montantPerte;
            
            if (P_disponible >= montantPerte) {
                // Utiliser la provision
                enregistrerEcritureBanque({
                    event_type: 'LOAN_DEFAULT_PROVISION',
                    debit_account: 2290,  // Provision pertes (passif -)
                    credit_account: 1200, // Encours cr√©dits (actif -)
                    amount: montantPerte,
                    playerId: joueurId,
                    loanId,
                    description: `D√©faut ${playersData[joueurId]?.name || joueurId}: ${montantPerte}‚Ç¨ couvert par provision`
                });
            } else {
                // Provision insuffisante - perte sur r√©serves
                if (P_disponible > 0) {
                    // D'abord √©puiser la provision
                    enregistrerEcritureBanque({
                        event_type: 'LOAN_DEFAULT_PROVISION',
                        debit_account: 2290,
                        credit_account: 1200,
                        amount: P_disponible,
                        playerId: joueurId,
                        loanId,
                        description: `D√©faut partiel: ${P_disponible}‚Ç¨ sur provision`
                    });
                }
                
                // Le reste impacte les r√©serves
                const perteSurReserves = montantPerte - P_disponible;
                enregistrerEcritureBanque({
                    event_type: 'LOAN_DEFAULT_LOSS',
                    debit_account: 3100,  // R√©serves (capitaux -)
                    credit_account: 1200, // Encours cr√©dits (actif -)
                    amount: perteSurReserves,
                    playerId: joueurId,
                    loanId,
                    description: `D√©faut perte: ${perteSurReserves}‚Ç¨ sur r√©serves (provision √©puis√©e)`
                });
            }
            
            // Recalculer contraintes
            recalculerContraintesBanque();
            
            return {
                success: true,
                E_avant,
                E_apres: COMPTABILITE.banque.E,
                montantPerte,
                provisionUtilisee: Math.min(P_disponible, montantPerte),
                perteSurReserves: Math.max(0, montantPerte - P_disponible)
            };
        }
        
        // Calculer le bilan de la banque (mod√®le sans d√©p√¥ts clients)
        function calculerBilanBanque() {
            normalizeComptabilite();
            const gl = COMPTABILITE.banque.grandLivre;
            const E = (gl[1200] || COMPTABILITE.banque.E || 0);
            
            // Actif = R√©serves (1010) + Cr√©ances (E) + Int√©r√™ts √† recevoir (1300)
            const totalActif = (gl[1010] || 0) + E + (gl[1300] || 0);
            
            // Passif = Provisions (2290) seulement
            const totalPassif = (gl[2290] || 0);
            
            // Capitaux = Capital (3000) + R√©serves/R√©sultat (3100)
            const resultatCourant = (gl[4000] || 0) - (gl[5000] || 0);
            const totalCapitaux = (gl[3000] || 0) + (gl[3100] || 0) + resultatCourant;
            
            const bilan = {
                // ACTIF
                actif: {
                    reservesCaisse: gl[1010] || 0,
                    creancesJoueurs: E,
                    interetsARecevoir: gl[1300] || 0,
                    totalActif: totalActif
                },
                // PASSIF (sans d√©p√¥ts clients)
                passif: {
                    provisionPertes: gl[2290] || 0,
                    totalPassif: totalPassif
                },
                // CAPITAUX PROPRES
                capitaux: {
                    capital: gl[3000] || 0,
                    reserves: gl[3100] || 0,
                    resultatCourant: resultatCourant,
                    totalCapitaux: totalCapitaux
                },
                // R√âSULTAT
                resultat: {
                    produitsInterets: gl[4000] || 0,
                    dotationProvision: gl[5000] || 0,
                    resultatNet: (gl[4000] || 0) - (gl[5000] || 0)
                },
                // M√âTRIQUES
                metriques: {
                    E: E,
                    t: COMPTABILITE.banque.t,
                    cumInterets: COMPTABILITE.banque.cumInterets,
                    cumCapital: COMPTABILITE.banque.cumCapital,
                    C_requis: COMPTABILITE.banque.C_requis,
                    P_requis: COMPTABILITE.banque.P_requis,
                    ratioCapital: E > 0 ? ((gl[3000] || 0) + (gl[3100] || 0) + resultatCourant) / E : 1,
                    ratioProvision: E > 0 ? (gl[2290] || 0) / E : 0
                },
                // √âQUILIBRE: Actif = Passif + Capitaux
                equilibre: {
                    totalActif: totalActif,
                    totalPassifCapitaux: totalPassif + totalCapitaux,
                    ecart: totalActif - (totalPassif + totalCapitaux)
                }
            };
            
            return bilan;
        }
        
        // Exporter le journal banque (format replay)
        function exporterJournalBanque() {
            normalizeComptabilite();
            return {
                planComptable: PLAN_COMPTABLE_BANQUE,
                journal: COMPTABILITE.banque.journalBanque,
                bilan: calculerBilanBanque(),
                timestamp: new Date().toISOString()
            };
        }
        
        // Emprunt AAA en # (D:501 C:580 - sans int√©r√™ts)
        async function comptaEmpruntAAA(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            if (COMPTABILITE.potAAA.solde < montant) {
                console.warn('Pot AAA insuffisant');
                return null;
            }
            
            COMPTABILITE.caisseJoueurs[joueurId].espoyr += montant;
            COMPTABILITE.potAAA.solde -= montant;
            COMPTABILITE.potAAA.circulationHash += montant;
            
            // Enregistrer la cr√©ance AAA
            if (!COMPTABILITE.potAAA.creances) COMPTABILITE.potAAA.creances = {};
            COMPTABILITE.potAAA.creances[joueurId] = (COMPTABILITE.potAAA.creances[joueurId] || 0) + montant;
            
            return enregistrerEcriture({
                joueurId, libelle: `Emprunt AAA ${montant}#`,
                compteDebit: 501, compteCredit: 580, montantEspoyr: montant,
                contexte: 'potAAA'
            });
        }
        
        // Remboursement AAA en # (D:580 C:501)
        async function comptaRemboursementAAA(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            const detteAAA = COMPTABILITE.potAAA.creances?.[joueurId] || 0;
            const montantReel = Math.min(montant, detteAAA, COMPTABILITE.caisseJoueurs[joueurId].espoyr || 0);
            
            if (montantReel <= 0) return null;
            
            COMPTABILITE.caisseJoueurs[joueurId].espoyr -= montantReel;
            COMPTABILITE.potAAA.solde += montantReel;
            COMPTABILITE.potAAA.circulationHash -= montantReel;
            COMPTABILITE.potAAA.creances[joueurId] -= montantReel;
            
            return enregistrerEcriture({
                joueurId, libelle: `Remboursement AAA ${montantReel}#`,
                compteDebit: 580, compteCredit: 501, montantEspoyr: montantReel,
                contexte: 'potAAA'
            });
        }
        
        // Taxe (D:635 C:500)
        async function comptaTaxe(joueurId, montant) {
            // OBSOL√àTE - la case Taxe est maintenant informative seulement
            // Gard√© pour compatibilit√© mais ne devrait plus √™tre appel√© pour pr√©l√®vement
            initCaisseJoueur(joueurId);
            
            COMPTABILITE.caisseJoueurs[joueurId].euro -= montant;
            COMPTABILITE.etat.tresor += montant;
            COMPTABILITE.etat.taxesRecues += montant;
            
            return enregistrerEcriture({
                joueurId, libelle: `Taxe 10%`,
                compteDebit: 635, compteCredit: 500, montantEuro: montant
            });
        }
        
        // Calculer le patrimoine d'un joueur (valeur activit√©s + √©quipements, hors cash)
        function calculerPatrimoine(joueurId) {
            let totalActivites = 0;
            let totalEquipements = 0;
            
            Object.entries(COMPTABILITE.caisseActivites || {}).forEach(([actId, act]) => {
                if (act.proprietaireId === joueurId) {
                    const c = CASES[actId];
                    totalActivites += act.capital || c?.prix || 0;
                    // Valeur √©quipements: 1er A=70%, A suivants=50%, B=50%
                    const nbA = act.equipementA || 0;
                    const nbB = act.equipementB || 0;
                    if (nbA > 0) totalEquipements += getPrixA(parseInt(actId));
                    if (nbA > 1) totalEquipements += getPrixB(parseInt(actId)) * (nbA - 1);
                    totalEquipements += getPrixB(parseInt(actId)) * nbB;
                }
            });
            
            return totalActivites + totalEquipements;
        }
        
        // Taxe Ligne 3 : 10% du patrimoine (activit√©s + √©quipements) ‚Üí √âtat
        // modificateur: 1.0 = normal, 1.5 = p√©nalit√© +50%, 0.8 = r√©duction -20%
        async function comptaTaxeLigne3(joueurId, modificateur = 1.0) {
            initCaisseJoueur(joueurId);
            const caisse = COMPTABILITE.caisseJoueurs[joueurId];
            
            const patrimoine = calculerPatrimoine(joueurId);
            const taxeBase = Math.floor(patrimoine * 0.10);
            const taxe = Math.floor(taxeBase * modificateur);
            
            if (taxe <= 0) return { patrimoine: 0, taxeBase: 0, taxe: 0, modificateur, paye: 0, impaye: 0 };
            
            // Payer en cash si possible, sinon arri√©r√©s
            const disponible = Math.max(0, caisse.euro || 0);
            const paye = Math.min(disponible, taxe);
            const impaye = taxe - paye;
            
            const libModif = modificateur > 1 ? ' (p√©nalit√© +50%)' : modificateur < 1 ? ' (r√©duction -20%)' : '';
            
            if (paye > 0) {
                caisse.euro -= paye;
                caisse.taxesPayees = (caisse.taxesPayees || 0) + paye;
                COMPTABILITE.etat.tresor += paye;
                COMPTABILITE.etat.taxesRecues = (COMPTABILITE.etat.taxesRecues || 0) + paye;
                COMPTABILITE.etat.recettes.taxe = (COMPTABILITE.etat.recettes.taxe || 0) + paye;
                COMPTABILITE.etat.recettes.total = (COMPTABILITE.etat.recettes.total || 0) + paye;
                
                // √âcriture joueur: paie la taxe
                enregistrerEcriture({
                    joueurId, libelle: `Taxe Ligne 3${libModif} (${fmt(taxe)}‚Ç¨ sur ${fmt(patrimoine)}‚Ç¨)`,
                    compteDebit: 635, compteCredit: 500, montantEuro: paye,
                    contexte: 'taxeLigne3'
                });
                
                // √âcriture √âtat: re√ßoit la taxe
                enregistrerEcriture({
                    joueurId: 'ETAT', libelle: `Taxe Ligne 3 re√ßue de ${playersData[joueurId]?.name || joueurId}${libModif}`,
                    compteDebit: 541, compteCredit: 703, montantEuro: paye,
                    contexte: 'taxeLigne3'
                });
            }
            
            if (impaye > 0) {
                caisse.impaye = (caisse.impaye || 0) + impaye;
                
                // √âcriture joueur: taxe impay√©e ‚Üí arri√©r√©s
                enregistrerEcriture({
                    joueurId, libelle: `Taxe Ligne 3 impay√©e ‚Üí arri√©r√©s (${fmt(impaye)}‚Ç¨)`,
                    compteDebit: 635, compteCredit: 401, montantEuro: impaye,
                    contexte: 'taxeLigne3'
                });
                
                // √âcriture √âtat: cr√©ance sur joueur pour taxe impay√©e
                enregistrerEcriture({
                    joueurId: 'ETAT', libelle: `Cr√©ance taxe Ligne 3 sur ${playersData[joueurId]?.name || joueurId}`,
                    compteDebit: 411, compteCredit: 703, montantEuro: impaye,
                    contexte: 'taxeLigne3'
                });
            }
            
            return { patrimoine, taxeBase, taxe, modificateur, paye, impaye };
        }
        
        // Frais divers (D:613 C:500)
        async function comptaFrais(joueurId, montant, libelle) {
            initCaisseJoueur(joueurId);
            
            // ========== √âTAPE 3 : Frais ‚Üí 100% √âtat ==========
            // Calcul facture avec TVA
            const facture = calculerFacture('frais', montant);
            const ledgerEntryIds = [];
            
            // Joueur paie le montant TTC
            COMPTABILITE.caisseJoueurs[joueurId].euro -= montant;
            COMPTABILITE.caisseJoueurs[joueurId].taxesPayees += montant;  // Cumul (100% vers √âtat)
            
            // √âcriture 1: Joueur - Frais HT (charge)
            let e = enregistrerEcriture({
                joueurId, 
                libelle: `${libelle || 'Frais'} HT`,
                compteDebit: 613,   // Frais (charge +)
                compteCredit: 500,  // Caisse (actif -)
                montantEuro: facture.ht
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 2: Joueur - TVA (charge)
            e = enregistrerEcriture({
                joueurId, 
                libelle: `TVA ${libelle || 'Frais'}`,
                compteDebit: 635,   // Taxes (charge +)
                compteCredit: 500,  // Caisse (actif -)
                montantEuro: facture.tva
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âtat re√ßoit 100% (HT + TVA)
            COMPTABILITE.etat.tresor += montant;
            COMPTABILITE.etat.recettes.tva += facture.tva;
            COMPTABILITE.etat.recettes.frais += facture.ht;
            COMPTABILITE.etat.recettes.total += montant;
            COMPTABILITE.etat.grandLivre[500] += montant;
            COMPTABILITE.etat.grandLivre[704] += facture.tva;
            COMPTABILITE.etat.grandLivre[702] += facture.ht;
            
            // √âcriture 3: √âtat - Recette TVA
            e = enregistrerEcriture({
                joueurId: 'ETAT', 
                libelle: `Recette TVA ${libelle || 'Frais'}`,
                compteDebit: 500,   // Caisse √âtat (actif +)
                compteCredit: 704,  // Produits TVA (produit +)
                montantEuro: facture.tva,
                contexte: 'etat'
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 4: √âtat - Recette Frais HT
            e = enregistrerEcriture({
                joueurId: 'ETAT', 
                libelle: `Recette ${libelle || 'Frais'} HT`,
                compteDebit: 500,   // Caisse √âtat (actif +)
                compteCredit: 702,  // Produits Frais (produit +)
                montantEuro: facture.ht,
                contexte: 'etat'
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            return { facture, ledgerEntryIds };
        }
        
        // Chance/Malchance (D:500 C:771 ou D:671 C:500)
        async function comptaChance(joueurId, montant, isChance) {
            initCaisseJoueur(joueurId);
            
            if (isChance) {
                COMPTABILITE.caisseJoueurs[joueurId].euro += montant;
                COMPTABILITE.banque.masseMonetaire += montant;
                return enregistrerEcriture({
                    joueurId, libelle: `Chance +${montant}‚Ç¨`,
                    compteDebit: 500, compteCredit: 771, montantEuro: montant
                });
            } else {
                COMPTABILITE.caisseJoueurs[joueurId].euro -= montant;
                return enregistrerEcriture({
                    joueurId, libelle: `Malchance -${montant}‚Ç¨`,
                    compteDebit: 671, compteCredit: 500, montantEuro: montant
                });
            }
        }
        
        // Cotisation AAA (D:580 C:501)
        async function comptaCotisationAAA(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            COMPTABILITE.caisseJoueurs[joueurId].espoyr -= montant;
            COMPTABILITE.potAAA.solde += montant;
            COMPTABILITE.potAAA.circulationHash -= montant;
            
            return enregistrerEcriture({
                joueurId, libelle: `Cotisation AAA ${montant}#`,
                compteDebit: 580, compteCredit: 501, montantEspoyr: montant
            });
        }
        
        // Cr√©dit AAA (D:501 C:580 + cr√©ance)
        async function comptaCreditAAA(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            COMPTABILITE.caisseJoueurs[joueurId].espoyr += montant;
            COMPTABILITE.potAAA.solde -= montant;
            COMPTABILITE.potAAA.circulationHash += montant;
            
            // Cr√©ance
            if (!COMPTABILITE.potAAA.creances[joueurId]) COMPTABILITE.potAAA.creances[joueurId] = 0;
            COMPTABILITE.potAAA.creances[joueurId] += montant;
            
            return enregistrerEcriture({
                joueurId, libelle: `Cr√©dit AAA ${montant}#`,
                compteDebit: 501, compteCredit: 580, montantEspoyr: montant
            });
        }
        
        // ========== SYNCHRONISATION FIREBASE ==========
        
        async function syncComptabiliteToFirebase() {
            if (!gameRef) {
                console.warn('‚ö†Ô∏è syncComptabiliteToFirebase: gameRef non initialis√©');
                return;
            }
            
            // Au lieu d'√©craser tout, on fait une mise √† jour intelligente
            // pour √©viter les conflits entre joueurs
            try {
                await gameRef.child('comptabilite').set(COMPTABILITE);
                console.log('‚úÖ Comptabilit√© synchronis√©e');
                updateMyBalance(); // MAJ affichage solde
            } catch (err) {
                console.error('‚ùå Erreur sync compta:', err);
            }
        }
        
        // Charger la comptabilit√© AVANT de faire des modifications
        async function loadComptabiliteFromFirebase() {
            if (!gameRef) {
                console.warn('‚ö†Ô∏è loadComptabiliteFromFirebase: gameRef non initialis√©');
                return;
            }
            const snap = await gameRef.child('comptabilite').once('value');
            if (snap.exists()) {
                COMPTABILITE = snap.val();
                normalizeComptabilite();
                console.log('‚úÖ Comptabilit√© charg√©e depuis Firebase');
                // Mettre √† jour l'UI apr√®s chargement
                updatePlayersUI();
                updateMyBalance(); // MAJ affichage solde
            }
        }
        
        // S'assurer que la comptabilit√© du joueur est √† jour depuis Firebase
        async function ensurePlayerComptaLoaded() {
            if (!gameRef) return;
            
            // Recharger la comptabilit√© depuis Firebase pour avoir les derni√®res donn√©es
            const snap = await gameRef.child('comptabilite').once('value');
            if (snap.exists()) {
                const firebaseCompta = snap.val();
                
                // Fusionner les caisses joueurs (Firebase a la priorit√©)
                if (firebaseCompta.caisseJoueurs) {
                    for (const [pid, caisse] of Object.entries(firebaseCompta.caisseJoueurs)) {
                        if (!COMPTABILITE.caisseJoueurs[pid]) {
                            COMPTABILITE.caisseJoueurs[pid] = caisse;
                        }
                    }
                }
                
                // Mettre √† jour les soldes globaux
                COMPTABILITE.potAAA = firebaseCompta.potAAA || COMPTABILITE.potAAA;
                COMPTABILITE.etat = firebaseCompta.etat || COMPTABILITE.etat;
                COMPTABILITE.banque = firebaseCompta.banque || COMPTABILITE.banque;
                COMPTABILITE.exportation = firebaseCompta.exportation || COMPTABILITE.exportation;
                COMPTABILITE.horsCircuit = firebaseCompta.horsCircuit || COMPTABILITE.horsCircuit;
                
                normalizeComptabilite();
            }
        }
        
        // ========== UI HELPERS ==========
        
        function showScreen(screenId) {
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }
        
        function showError(msg) {
            const el = document.getElementById('errorMessage');
            el.textContent = msg; el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }
        
        function showModal(content, buttons = '') {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                    <div class="modal">
                        ${content}
                        ${buttons ? `<div class="modal-buttons">${buttons}</div>` : ''}
                    </div>
                </div>`;
        }
        // Choix du mode de jeu (Solo / Multi)
        function chooseGameMode() {
            return new Promise((resolve) => {
                window.__resolveGameMode = resolve;
                showModal(`
                    <h3>üéÆ Mode de jeu</h3>
                    <p style="font-size: 0.95rem; color: var(--gray); margin: 10px 0 15px 0;">
                        Voulez-vous jouer <strong>seul</strong> (test/solo) ou <strong>avec d'autres joueurs</strong> sur un autre appareil ?
                    </p>
                    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                        <button class="btn btn-primary" style="min-width:180px;" onclick="selectGameMode('SOLO')">üßç Jouer seul</button>
                        <button class="btn btn-secondary" style="min-width:180px;" onclick="selectGameMode('MULTI')">üë• Jouer en multi</button>
                        <button class="btn btn-warning" onclick="selectGameMode('DICE_HOST')">  üé≤ D√© physique (ma√Ætre du jeu)</button>

                    </div>
                    <p style="font-size: 0.85rem; color: var(--gray); margin-top: 12px; text-align:center;rollDiceBtn">
                        Les robots restent <strong>optionnels</strong> dans les deux modes.
                    </p>
                `, ``);
            });
        }

        function selectGameMode(mode) {
  closeModal();

  // ‚úÖ minPlayers doit √™tre d√©fini ici
  const minPlayers = (mode === 'SOLO') ? 1 : 2;

  // ‚úÖ diceMode par d√©faut
  let diceMode = 'AUTO';

  // üé≤ Si bouton "d√© physique"
  if (mode === 'DICE_HOST') {rollDiceBtn
    diceMode = 'PHYSIQUE';
  }

  if (typeof window.__resolveGameMode === 'function') {
    window.__resolveGameMode({ mode, minPlayers, diceMode });
  }
  window.__resolveGameMode = null;
}



        
        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }
        
        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            return Array.from({length: 6}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
        }
        
        // Avatar selectionrollDiceBtn
        document.querySelectorAll('.avatar-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.avatar-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                myAvatar = btn.dataset.avatar;
            });
        });
        
        // ========== CR√âER PARTIE ==========
        async function createGame() {
            myName = document.getElementById('playerName').value.trim();
            if (!myName) { showError('Entre ton nom !'); return; }

            // Choix Solo / Multi (le robot reste optionnel dans les deux modes)
            chooseGameMode().then(({ mode, minPlayers, diceMode }) => {
                // Stocker dans la config de partie (persist√©e en Firebase)
                const partyConfig = { ...CONFIG, mode, minPlayers, diceMode };
                gameConfig = { ...partyConfig };
                console.log('DEBUG choix mode:', { mode, minPlayers, diceMode });
                console.log('DEBUG gameConfig final:', gameConfig);


                // Afficher l'intro puis demander le profil √©conomique
                showIntroModal(() => showProfilChoiceModal(async (profil) => {

                const code = generateCode();
                currentGameCode = code;
                isHost = true;
                myPlayerId = 'p_' + Date.now() + '_' + Math.floor(Math.random()*1000);
                const secret = generateSecret(24);
                const secretHash = await sha256Hex(secret);
                myProfil = profil;
                
                // IMPORTANT: Initialiser gameRef AVANT les op√©rations comptables
                gameRef = db.ref(`parties/${code}`);
                
                // Initialiser GAME_SAVE pour audit + replay
                GAME_SAVE = {
                    schemaVersion: SCHEMA_VERSION,
                    gameId: `ESPOYR_${code}`,
                    createdAt: new Date().toISOString(),
                    lastSavedAt: null,
                    rng: {
                        mode: "seeded",
                        seed: generateSeed(),
                        consumed: 0,
                        rolls: []
                    },
                    state: null,
                    events: [],
                    eventCounter: 0,
                    ledger: [],
                    ledgerCounter: 0,
                    snapshots: [],
                    indexes: { byTurn: {}, byPlayer: {}, byEntity: {}, byAction: {} }
                };
                
                // Initialiser comptabilit√© avec exportation
                COMPTABILITE = {
                    journal: [], numeroEcriture: 0, grandLivre: {},
                    caisseJoueurs: {}, caisseActivites: {}, parJoueur: {},
                    dettesEntreJoueurs: [],  // [{debiteurId, createurId, montant, caseId, caseName, tour}]
                    smartContracts: [],      // [{debiteurId, createurId, montantEuro, montantHash, tourAccorde}]
                    banque: { creancesJoueurs: 0, masseMonetaire: 0, interetsRecus: 0, capital: 0, reductionValeur: 0, journal: [] },
                    potAAA: { solde: CONFIG.potAAAInitial, circulationHash: 0, membres: [], creances: {}, journal: [] },
                    etat: { tresor: 0, taxesRecues: 0, salairesVerses: 0, journal: [] },
                    exportation: { solde: 0, recettes: 0, salairesVerses: 0, journal: [] },
                    horsCircuit: { solde: 0, recettes: 0, journal: [], grandLivre: { 550: 0, 792: 0 }, journalHorsCircuit: [] }
                };
                
                // Cr√©er la partie dans Firebase
                await db.ref(`parties/${code}`).set({
                    code, hostId: myPlayerId, status: 'waiting',
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    config: partyConfig,
                    state: { turn: 1, phase: 1, currentPlayerIndex: 0, started: false, toursComplets: 0, passagesLigne1Total: 0 },
                    activites: {}, equipements: {},
                    comptabilite: COMPTABILITE
                });
                
                // Cr√©er le joueur
                await db.ref(`parties/${code}/players/${myPlayerId}`).set({
                    id: myPlayerId, name: myName, avatar: myAvatar,
                    position: 0, euro: CONFIG.capitalInitial, espoyr: 0, emprunt: 0,
                    isHost: true, isBot: false, membreAAA: false,
                    profil: profil,
                    passagesDepart: 0, passagesDepuisPhase2: 0,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP,
                    isConnected: true,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                    secretHash: secretHash
                });

                // Sauvegarde locale + ticket de reprise
                saveResume(code, { code, name: myName, playerId: myPlayerId, secret, avatar: myAvatar, savedAt: Date.now() });
                const ticket = `${myPlayerId}|${secret}`;
                LAST_RESUME_CODE = code;
                LAST_RESUME_NAME = myName;
                showModal(
                    `<h3>üéüÔ∏è Ticket de reprise</h3>
                     <p style="color: var(--gray); font-size: 0.9rem;">Garde ce ticket pour reprendre la partie m√™me en changeant d'appareil.</p>
                     <div id="ticketValue" style="background:#f3f4f6; padding:12px; border-radius:12px; font-family: monospace; word-break: break-all;">${ticket}</div>`,
                    `<button class="btn btn-primary" onclick="copyToClipboard(document.getElementById('ticketValue').textContent)">üìã Copier</button>
                     <button class="btn" onclick="downloadResumeTicket()">üíæ T√©l√©charger</button>
                     <button class="btn" onclick="closeModal()">OK</button>`
                );

                
                // √âcriture capital initial - gameRef est maintenant initialis√© !
                const capitalEcriture = await comptaCapitalInitial(myPlayerId, CONFIG.capitalInitial);
                
                // Synchroniser la comptabilit√© vers Firebase
                await syncComptabiliteToFirebase();
                
                // LOG EVENT: GAME_CREATE
                logEvent('GAME_CREATE', myPlayerId, {
                    gameCode: code,
                    playerName: myName,
                    profil,
                    config: partyConfig,
                    rngSeed: GAME_SAVE.rng.seed
                }, capitalEcriture?.ledgerEntryId ? [capitalEcriture.ledgerEntryId] : []);
                
                // Cr√©er snapshot initial
                createSnapshot();
                
                // S'abonner aux mises √† jour
                subscribeToGame(code);
                showScreen('lobbyScreen');
                document.getElementById('lobbyCode').textContent = code;
                document.getElementById('hostControls').classList.remove('hidden');
                document.getElementById('waitingMessage').classList.add('hidden');
                
                sendSystemMessage(`${myName} (${profil === 'creatif' ? 'üé® Cr√©atif' : 'üèõÔ∏è Contributif'}) a cr√©√© la partie !`);
            }));
            });
        }
        
        // Variable pour stocker le profil du joueur
        let myProfil = 'contributif';
        
        // Modal d'introduction du jeu (avant choix de profil)
        function showIntroModal(callback) {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal-overlay">
                    <div class="modal" style="max-height: 85vh; overflow-y: auto;">
                        <h3 style="text-align:center; font-size:1.3rem;">üéÆ ESPOYR</h3>
                        
                        <div style="background:#f0fdf4; padding:12px; border-radius:10px; margin-bottom:10px;">
                            <p style="margin:0; font-weight:bold; color:#059669;">üë§ Ta situation</p>
                            <p style="margin:6px 0 0 0; font-size:0.9rem;">
                                Imagine. Tu as 18 ans. Tu es seul¬∑e aux commandes de ton m√©nage. 
                                Personne pour payer √† ta place. Bienvenue dans la vraie vie‚Ä¶ en version jeu de plateau.
                            </p>
                        </div>
                        
                        <div style="background:#dbeafe; padding:12px; border-radius:10px; margin-bottom:10px;">
                            <p style="margin:0; font-weight:bold; color:#2563eb;">üéØ Ton objectif</p>
                            <p style="margin:6px 0 0 0; font-size:0.9rem;">
                                Ton but n'est pas seulement d'avoir de l'argent, mais de survivre √©conomiquement 
                                en construisant le mode de vie que tu choisis.
                            </p>
                        </div>
                        
                        <div style="background:#fef3c7; padding:12px; border-radius:10px; margin-bottom:10px;">
                            <p style="margin:0; font-weight:bold; color:#92400e;">üí∞ Le d√©part</p>
                            <p style="margin:6px 0 0 0; font-size:0.9rem;">
                                Au d√©but, tu touches un salaire. C'est ton filet de s√©curit√©, mais il n'est pas garanti. 
                                Des crises peuvent arriver et des √©conomies peuvent √™tre impos√©es. Tu dois apprendre √† anticiper.
                            </p>
                        </div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px;">
                            <div style="background:#e0e7ff; padding:10px; border-radius:10px;">
                                <p style="margin:0; font-weight:bold; color:#3730a3; font-size:0.9rem;">üè™ Investir</p>
                                <p style="margin:4px 0 0 0; font-size:0.85rem;">
                                    Tu peux investir et cr√©er des activit√©s : potager, ferme, atelier, service‚Ä¶ 
                                    Chaque activit√© peut te rapporter un revenu.
                                </p>
                            </div>
                            <div style="background:#f3e8ff; padding:10px; border-radius:10px;">
                                <p style="margin:0; font-weight:bold; color:#7c3aed; font-size:0.9rem;">üîß Am√©liorer</p>
                                <p style="margin:4px 0 0 0; font-size:0.85rem;">
                                    Tu peux √©quiper tes activit√©s. Cela co√ªte de l'argent, mais un bon √©quipement 
                                    peut augmenter fortement tes revenus.
                                </p>
                            </div>
                        </div>
                        
                        <div style="background:#fef2f2; padding:12px; border-radius:10px; margin-bottom:10px;">
                            <p style="margin:0; font-weight:bold; color:#dc2626;">‚ö†Ô∏è La r√©alit√©</p>
                            <p style="margin:6px 0 0 0; font-size:0.9rem;">
                                Comme dans la vraie vie, tu dois g√©rer des taxes et des frais impr√©vus. 
                                Si tu n'as pas assez de liquidit√©s, tu peux emprunter, mais chaque euro emprunt√© 
                                devra √™tre rembours√© avec des int√©r√™ts.
                            </p>
                        </div>
                        
                        <div style="background:#dcfce7; padding:12px; border-radius:10px; margin-bottom:10px;">
                            <p style="margin:0; font-weight:bold; color:#059669;">üèÜ Gagner</p>
                            <p style="margin:6px 0 0 0; font-size:0.9rem;">
                                Tu gagnes la partie si, √† la fin, ton m√©nage est stable et si tu as construit 
                                le monde id√©al que tu souhaitais.
                            </p>
                        </div>
                        
                        <div style="background:#f3f4f6; padding:12px; border-radius:10px; margin-bottom:10px; border-left:4px solid #6b7280;">
                            <p style="margin:0; font-size:0.9rem; font-style:italic; color:#374151;">
                                üí¨ Ce jeu ne r√©compense pas celui qui √©crase les autres. Il montre que chaque choix 
                                √©conomique a des cons√©quences, pour toi et pour les autres joueurs. 
                                <strong>Anticipe ou subis.</strong> üé≤
                            </p>
                        </div>
                        
                        <div class="modal-buttons">
                            <button class="btn btn-primary" style="width:100%; padding:14px; font-size:1.1rem;" 
                                onclick="closeModal(); window.__introCallback && window.__introCallback();">
                                ‚úÖ J'ai compris, c'est parti !
                            </button>
                        </div>
                    </div>
                </div>`;
            window.__introCallback = callback;
        }
        
        // Modal de choix du profil √©conomique
        function showProfilChoiceModal(callback) {
            showModal(`
                <h3>Quel est ton profil √©conomique ?</h3>
                <p style="font-size: 0.9rem; color: var(--gray); margin-bottom: 15px;">
                    Ce choix d√©termine qui paie ton salaire et comment tu es r√©mun√©r√©.
                    <strong>Clique sur ton choix :</strong>
                </p>
                
                <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 12px; cursor: pointer; border: 3px solid #2563eb; transition: all 0.2s;" 
                     onclick="selectProfil('contributif')"
                     onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(37,99,235,0.3)'"
                     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                    <p style="margin: 0; font-weight: bold; font-size: 1.1rem;">üèõÔ∏è CONTRIBUTIF</p>
                    <p style="margin: 6px 0 0 0; font-size: 0.9rem;">Salaire fixe de <strong>350‚Ç¨</strong> pay√© par l'√âtat</p>
                    <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6b7280;">‚úÖ Stable et s√©curis√©</p>
                    <p style="margin: 8px 0 0 0; text-align: center; font-size: 0.9rem; color: #2563eb; font-weight: bold;">üëÜ Cliquer pour choisir</p>
                </div>
                
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; cursor: pointer; border: 3px solid #f59e0b; transition: all 0.2s;" 
                     onclick="selectProfil('creatif')"
                     onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(245,158,11,0.3)'"
                     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                    <p style="margin: 0; font-weight: bold; font-size: 1.1rem;">üé® CR√âATIF</p>
                    <p style="margin: 6px 0 0 0; font-size: 0.9rem;">Salaire variable (<strong>45%-150%</strong>) pay√© par l'Exportation</p>
                    <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6b7280;">‚ö° Risqu√© mais potentiellement plus rentable</p>
                    <p style="margin: 8px 0 0 0; text-align: center; font-size: 0.9rem; color: #92400e; font-weight: bold;">üëÜ Cliquer pour choisir</p>
                </div>
            `, ``);
            
            // Stocker le callback
            window.profilCallback = callback;
        }
        
        function selectProfil(profil) {
            closeModal();
            if (window.profilCallback) {
                window.profilCallback(profil);
                window.profilCallback = null;
            }
        }
        
        // ========== REJOINDRE PARTIE ==========
        async function joinGame() {
            myName = document.getElementById('playerName').value.trim();
            if (!myName) { showError('Entre ton nom !'); return; }
            
            const code = document.getElementById('gameCode').value.trim().toUpperCase();
            if (!code || code.length !== 6) { showError('Code invalide !'); return; }
            
            const gameSnap = await db.ref(`parties/${code}`).once('value');
            if (!gameSnap.exists()) { showError('Partie introuvable !'); return; }
            
            const gameData = gameSnap.val();
            const playersSnap = await db.ref(`parties/${code}/players`).once('value');
            const existingPlayers = playersSnap.val() || {};
            
            
            // Reconnexion (ticket ou reprise auto)
            const ticketRaw = (document.getElementById('resumeTicket')?.value || '').trim();
            const parsedTicket = parseResumeTicket(ticketRaw);
            const saved = loadResume(code);

            // 1) si ticket fourni : priorit√©
            let resume = null;
            if (parsedTicket) {
                resume = { playerId: parsedTicket.playerId, secret: parsedTicket.secret };
            } else if (saved && saved.name === myName && saved.playerId && saved.secret) {
                // 2) reprise auto sur m√™me appareil (nom + code)
                resume = { playerId: saved.playerId, secret: saved.secret };
            }

            if (resume) {
                const pSnap = await db.ref(`parties/${code}/players/${resume.playerId}`).once('value');
                if (pSnap.exists()) {
                    const p = pSnap.val();
                    const h = await sha256Hex(resume.secret);
                    if (!p.secretHash || p.secretHash === h) {
                        // OK : reconnexion
                        currentGameCode = code;
                        myPlayerId = p.id;
                        myAvatar = p.avatar || myAvatar;
                        isHost = !!p.isHost;
                        myProfil = p.profil || 'contributif';

                        // Sauvegarde locale (renouvelle)
                        saveResume(code, { code, name: myName, playerId: myPlayerId, secret: resume.secret, avatar: myAvatar, savedAt: Date.now() });

                        gameRef = db.ref(`parties/${code}`);
                        subscribeToGame(code);
                        showLobbyOrGame(gameData);
                        startHeartbeat();
                        return;
                    }
                }
                showError('Ticket invalide (ou joueur introuvable).');
                return;
            }

            // Compatibilit√© : reconnexion par nom si ancien joueur (sans ticket)
            const existingPlayer = Object.values(existingPlayers).find(p => p.name === myName);
            if (existingPlayer) {
                currentGameCode = code;
                myPlayerId = existingPlayer.id;
                myAvatar = existingPlayer.avatar;
                isHost = existingPlayer.isHost;
                myProfil = existingPlayer.profil || 'contributif';

                // Migrer vers ticket si pas encore pr√©sent
                const secret = generateSecret(24);
                const secretHash = await sha256Hex(secret);
                try {
                    await db.ref(`parties/${code}/players/${myPlayerId}`).update({ secretHash });
                } catch(e) {}
                saveResume(code, { code, name: myName, playerId: myPlayerId, secret, avatar: myAvatar, savedAt: Date.now() });

                gameRef = db.ref(`parties/${code}`);
                subscribeToGame(code);
                showLobbyOrGame(gameData);
                startHeartbeat();

                const ticket = `${myPlayerId}|${secret}`;
                LAST_RESUME_CODE = code;
                LAST_RESUME_NAME = myName;
                showModal(
                    `<h3>üéüÔ∏è Ticket de reprise</h3>
                     <p style="color: var(--gray); font-size: 0.9rem;">Garde ce ticket pour reprendre la partie m√™me en changeant d'appareil.</p>
                     <div id="ticketValue" style="background:#f3f4f6; padding:12px; border-radius:12px; font-family: monospace; word-break: break-all;">${ticket}</div>`,
                    `<button class="btn btn-primary" onclick="copyToClipboard(document.getElementById('ticketValue').textContent)">üìã Copier</button>
                     <button class="btn" onclick="downloadResumeTicket()">üíæ T√©l√©charger</button>
                     <button class="btn" onclick="closeModal()">OK</button>`
                );
                return;
            }

if (gameData.status !== 'waiting') { showError('Partie d√©j√† commenc√©e !'); return; }
            if (playersSnap.numChildren() >= 6) { showError('Partie compl√®te (6 joueurs max) !'); return; }
            
            // Afficher l'intro puis demander le profil avant de rejoindre
            showIntroModal(() => showProfilChoiceModal(async (profil) => {
                currentGameCode = code;
                isHost = false;
                myPlayerId = 'p_' + Date.now() + '_' + Math.floor(Math.random()*1000);
                const secret = generateSecret(24);
                const secretHash = await sha256Hex(secret);
                myProfil = profil;
                
                // IMPORTANT: Initialiser gameRef AVANT les op√©rations comptables
                gameRef = db.ref(`parties/${code}`);
                
                await db.ref(`parties/${code}/players/${myPlayerId}`).set({
                    id: myPlayerId, name: myName, avatar: myAvatar,
                    position: 0, euro: CONFIG.capitalInitial, espoyr: 0, emprunt: 0,
                    isHost: false, isBot: false, membreAAA: false,
                    profil: profil,
                    passagesDepart: 0, passagesDepuisPhase2: 0,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP,
                    isConnected: true,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                    secretHash: secretHash
                });
                
                // Charger la comptabilit√© existante depuis Firebase
                await loadComptabiliteFromFirebase();
                
                // Ajouter le capital initial du nouveau joueur
                await comptaCapitalInitial(myPlayerId, CONFIG.capitalInitial);
                
                // Sauvegarder vers Firebase
                await syncComptabiliteToFirebase();
                
                // S'abonner aux updates
                subscribeToGame(code);
                showScreen('lobbyScreen');
                document.getElementById('lobbyCode').textContent = code;
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('waitingMessage').classList.remove('hidden');
                
                sendSystemMessage(`${myName} (${profil === 'creatif' ? 'üé® Cr√©atif' : 'üèõÔ∏è Contributif'}) a rejoint !`);
            }));
        }
        
        // ========== ABONNEMENT FIREBASE ==========
        function subscribeToGame(code) {
            gameRef = db.ref(`parties/${code}`);
            
            // √âtat
            gameRef.child('state').on('value', (snap) => {
                gameState = snap.val();
                
                // Mettre √† jour le sens de d√©placement
                if (gameState?.sensDeplacent) {
                    sensDeplacementGlobal = gameState.sensDeplacent;
                }
                
                if (gameState?.started && document.getElementById('gameScreen').classList.contains('hidden')) {
                    loadComptabiliteFromFirebase();
                    showScreen('gameScreen');
                }
              updateGameUI();
                if (!window._diceListenersInit) {
                    window._diceListenersInit = true;
                    ecouterDemandesDe();
                    ecouterReponsesDe();
                    console.log('üé≤ √âcouteurs de d√© activ√©s');
                }
            });
            
            // Joueurs
            gameRef.child('players').on('value', (snap) => {
                playersData = snap.val() || {};
                updatePlayersUI();
                if (Object.keys(playersData).length > 0) updateBoard();
                
                const count = Object.keys(playersData).length;
                const countEl = document.getElementById('playerCount');
                if (countEl) countEl.textContent = count;
                
                const startBtn = document.getElementById('startGameBtn');
                if (startBtn) startBtn.disabled = count < (gameConfig.minPlayers || 2);
            });
            
            // Chat
            gameRef.child('chat').orderByChild('timestamp').limitToLast(50).on('child_added', (snap) => {
                const msg = snap.val();
                addChatMessage(msg);
            });
            
            // Comptabilit√© (sync)
            gameRef.child('comptabilite').on('value', (snap) => {
                if (snap.exists()) {
                    COMPTABILITE = snap.val();
                    normalizeComptabilite();
                    updatePlayersUI();  // Mettre √† jour l'UI apr√®s sync
                    console.log('üîÑ Comptabilit√© synchronis√©e depuis Firebase');
                }
            });
            
            // Ench√®res
            gameRef.child('enchere').on('value', (snap) => {
                if (snap.exists()) {
                    enchereEnCours = snap.val();
                    // Afficher le modal d'ench√®res si pas d√©j√† affich√©
                    if (enchereEnCours && !enchereEnCours.termine) {
                        // Ne pas afficher automatiquement pour ne pas interrompre
                        // Le vendeur et les acheteurs verront via les boutons
                    }
                } else {
                    enchereEnCours = null;
                }
            });
            
            // Configuration (sync)
            gameRef.child('config').on('value', (snap) => {
                if (snap.exists()) {
                    const savedConfig = snap.val();
                    gameConfig = { ...CONFIG, ...savedConfig };
                    console.log('Config charg√©e:', gameConfig);
                }
            });
            
            // Connexion
            db.ref('.info/connected').on('value', (snap) => {
                const el = document.getElementById('connectionStatus');
                if (snap.val()) {
                    el.textContent = 'üü¢ Connect√©';
                    el.className = 'connection-status connected';
                } else {
                    el.textContent = 'üî¥ D√©connect√©';
                    el.className = 'connection-status disconnected';
                }
            });
            
            // √âcouter les n√©gociations entrantes
            listenForNegotiations();
            
            // Activer les toasts live apr√®s chargement initial des messages
            enableLiveToasts();
        }
        
        // ========== CHAT ==========
        function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            
            gameRef.child('chat').push({
                sender: myName, avatar: myAvatar, message: msg,
                timestamp: firebase.database.ServerValue.TIMESTAMP, isSystem: false
            });
            input.value = '';
        }
        
        function sendSystemMessage(msg) {
            if (!gameRef) return;
            gameRef.child('chat').push({
                sender: 'Syst√®me', avatar: 'üì¢', message: msg,
                timestamp: firebase.database.ServerValue.TIMESTAMP, isSystem: true
            });
        }
        
        function addChatMessage(msg) {
            const chatBox = document.getElementById('chatBox');
            if (!chatBox) return;
            
            const div = document.createElement('div');
            div.className = `chat-message ${msg.isSystem ? 'system' : ''}`;
            div.innerHTML = msg.isSystem 
                ? msg.message 
                : `<span class="sender">${msg.avatar} ${msg.sender}:</span> ${msg.message}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            
            // ‚ïê‚ïê‚ïê TOAST LIVE ‚Äî actions des autres joueurs ‚ïê‚ïê‚ïê
            if (msg.isSystem && liveToastsReady) {
                // V√©rifier si c'est l'action d'un AUTRE joueur (pas moi)
                const text = msg.message || '';
                const myNameStr = myName || '';
                // Si le message ne contient PAS mon nom ‚Üí c'est un autre joueur ‚Üí toast
                // Exception: messages g√©n√©riques (phase, partie) ‚Üí aussi afficher
                if (myNameStr && !text.includes(myNameStr)) {
                    showLiveToast(text);
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê TOASTS LIVE (notifications style TikTok) ‚ïê‚ïê‚ïê
        let liveToastsReady = false;
        const MAX_TOASTS = 4;
        
        function showLiveToast(text) {
            const container = document.getElementById('liveToastContainer');
            if (!container) return;
            
            // Strip HTML tags (ex: LOGO_AAA SVG) pour texte pur
            const cleanText = text.replace(/<[^>]*>/g, '').trim();
            if (!cleanText) return;
            
            // Limiter le nombre de toasts visibles
            while (container.children.length >= MAX_TOASTS) {
                container.removeChild(container.firstChild);
            }
            
            const toast = document.createElement('div');
            toast.className = 'live-toast';
            toast.textContent = cleanText;
            container.appendChild(toast);
            
            // Supprimer apr√®s animation (3.2s visible + 0.6s fade)
            setTimeout(() => {
                if (toast.parentNode) toast.parentNode.removeChild(toast);
            }, 3900);
        }
        
        // Activer les toasts apr√®s le chargement initial des messages
        function enableLiveToasts() {
            setTimeout(() => { liveToastsReady = true; }, 2500);
        }
        
        // ========== UI JOUEURS ==========
        function updatePlayersUI() {
            const playerArray = getOrderedPlayers()
            
            // Lobby
            const lobbyEl = document.getElementById('lobbyPlayers');
            if (lobbyEl) {
                lobbyEl.innerHTML = playerArray.map(p => `
                    <div class="player-item ${p.id === myPlayerId ? 'me' : ''} ${p.isBot ? 'bot' : ''}">
                        <span class="player-avatar">${p.avatar}</span>
                        <div class="player-info">
                            <div class="player-name">${p.name} ${p.isBot ? '<span class="bot-badge">ROBOT</span>' : ''}</div>
                            <div class="player-stats">${p.isHost ? 'üëë H√¥te' : 'Joueur'} - üí∞${fmt(p.euro || CONFIG.capitalInitial)}‚Ç¨</div>
                        </div>
                        ${p.isHost ? '<span class="player-badge badge-host">HOST</span>' : ''}
                    </div>
                `).join('');
            }
            
            // Game
            const gameEl = document.getElementById('gamePlayers');
            if (gameEl && gameState) {
                const currentIdx = gameState.currentPlayerIndex || 0;
                gameEl.innerHTML = playerArray.map((p, idx) => {
                    const caisse = (COMPTABILITE && COMPTABILITE.caisseJoueurs && COMPTABILITE.caisseJoueurs[p.id]) || {};
                    // Priorit√©: caisse comptable > donn√©es Firebase > capital initial
                    const euroActuel = caisse.euro !== undefined ? caisse.euro : (p.euro !== undefined ? p.euro : CONFIG.capitalInitial);
                    const espoyrActuel = caisse.espoyr || p.espoyr || 0;
                    const empruntActuel = caisse.emprunt || p.emprunt || 0;
                    const isMembre = COMPTABILITE?.potAAA?.membres?.includes(p.id) || p.membreAAA;
                    
                    return `
                    <div class="player-item ${p.id === myPlayerId ? 'me' : ''} ${idx === currentIdx ? 'current-turn' : ''} ${p.isBot ? 'bot' : ''}" 
                         onclick="showCompteJoueur('${p.id}')" style="cursor: pointer;" title="Cliquer pour voir le compte">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: ${PLAYER_COLORS[idx]}; flex-shrink: 0;"></span>
                        <span class="player-avatar">${p.avatar}</span>
                        <div class="player-info">
                            <div class="player-name">${p.name} ${isMembre ? LOGO_AAA : ''} ${p.isBot ? '<span class="bot-badge">ROBOT</span>' : ''}</div>
                            <div class="player-stats">
                                üí∞${fmt(euroActuel)}‚Ç¨ 
                                ${LOGO_AAA}${fmt(espoyrActuel)}# 
                                ${empruntActuel > 0 ? `<span style="color:#ef4444">üìã${fmt(empruntActuel)}‚Ç¨</span>` : ''}
                            </div>
                        </div>
                        ${idx === currentIdx ? '<span class="player-badge badge-ready">üéØ</span>' : ''}
                    </div>
                `}).join('');
            }
            updateMyBalance(); // MAJ barre solde au-dessus du d√©
        }
        
        // ========== LANCEMENT PARTIE ==========
        async function startGame() {
            if (!isHost) return;
            
            // Confirmation avant de commencer
            showModal(`
                <h3>üöÄ D√©marrer la partie ?</h3>
                <p style="font-size: 0.9rem; color: var(--gray); margin-bottom: 15px;">
                    ${Object.keys(playersData).length} joueur(s) pr√™t(s).
                </p>
                
                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0; font-weight: bold; color: #059669;">üéØ Nouveaut√© !</p>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem;">
                        Chaque joueur choisira son <strong>propre sens de d√©placement</strong> √† son premier lancer.
                        <br>‚û°Ô∏è Horaire ou ‚¨ÖÔ∏è Anti-horaire - c'est vous qui d√©cidez !
                    </p>
                </div>
            `, `
                <button class="btn btn-primary" onclick="confirmStartGame()">üéÆ Commencer</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            `);
        }
        
        // Variable pour le sens de d√©placement (gard√© pour compatibilit√©)
        let sensDeplacementGlobal = 1;  // 1 = horaire, -1 = anti-horaire
        
        async function confirmStartGame() {
            closeModal();
            
            // V√©rifier le nombre minimum de joueurs selon le mode (Solo/Multi)
            const minPlayers = gameConfig.minPlayers || 2;
            const nbJoueurs = Object.keys(playersData).length;
            if (nbJoueurs < minPlayers) {
                showError(`Il faut au moins ${minPlayers} joueur(s) pour d√©marrer (actuellement ${nbJoueurs}).`);
                return;
            }
            
            // S'assurer que tous les joueurs ont leur comptabilit√© initialis√©e
            await loadComptabiliteFromFirebase();
            
            // V√©rifier et initialiser la comptabilit√© de chaque joueur
            for (const [pid, player] of Object.entries(playersData)) {
                if (!COMPTABILITE.caisseJoueurs[pid] || COMPTABILITE.caisseJoueurs[pid].euro === 0) {
                    initCaisseJoueur(pid);
                    COMPTABILITE.caisseJoueurs[pid].euro = player.euro || CONFIG.capitalInitial;
                    COMPTABILITE.caisseJoueurs[pid].capital = player.euro || CONFIG.capitalInitial;
                    COMPTABILITE.banque.masseMonetaire += COMPTABILITE.caisseJoueurs[pid].euro;
                    console.log(`‚úÖ Comptabilit√© initialis√©e pour ${player.name}: ${COMPTABILITE.caisseJoueurs[pid].euro}‚Ç¨`);
                }
            }
            
            // Initialiser le capital bancaire
            try {
                initialiserCapitalBanque(CONFIG.banqueCapitalInitial);
                console.log('üè¶ Capital banque initialis√©');
            } catch (e) {
                console.warn('‚ö†Ô∏è Erreur init capital banque:', e);
            }

// M√©langer l'ordre des joueurs
        const joueurs = Object.keys(playersData);
        const melange = joueurs.sort(() => Math.random() - 0.5);
        const updates = {};
        melange.forEach((id, index) => {
            updates[`players/${id}/playOrder`] = index;
        });
        await gameRef.update(updates);



         
            
            // Sauvegarder la comptabilit√© mise √† jour
            await syncComptabiliteToFirebase();
            
            // D√©marrer la partie
            await gameRef.child('state/started').set(true);
            await gameRef.child('status').set('playing');
            
            const sensText = 'üéØ Chaque joueur choisira son sens de d√©placement';
            sendSystemMessage(`üöÄ La partie commence ! ${sensText}`);
            
            // LOG EVENT: GAME_START
            logEvent('GAME_START', myPlayerId, {
                sensPerJoueur: true,  // Nouveau mode : sens individuel
                nbJoueurs: Object.keys(playersData).length
            });
        }
        
        function leaveGame() {
            if (gameRef && myPlayerId) {
                gameRef.child(`players/${myPlayerId}`).remove();
            }
            showScreen('homeScreen');
        }
        
        // ========== ROBOTS IA ==========
        function showAddBotModal() {
            if (Object.keys(playersData).length >= 6) { alert('Partie compl√®te (6 joueurs max) !'); return; }
            
            const profilsList = Object.values(PROFILS_IA).map(p => 
                `<button class="btn" style="margin: 3px; font-size: 0.8rem;" onclick="addBot('${p.id}')">${p.nom}</button>`
            ).join('');
            
            showModal(`<h3>ü§ñ Ajouter Robot</h3><div style="display:flex;flex-wrap:wrap;">${profilsList}</div>`,
                `<button class="btn btn-secondary" onclick="closeModal()">Annuler</button>`);
        }
        
        // ========== CONFIGURATION PARTIE ==========
        async function showConfigModal() {
            // R√©cup√©rer le sens actuel du joueur
            const sensPersoSnap = await gameRef.child(`sensJoueurs/${myPlayerId}`).once('value');
            const monSens = sensPersoSnap.val() || 1;
            
            showModal(`
                <h3>‚öôÔ∏è Configuration de la partie</h3>
                <p style="font-size: 0.85rem; color: var(--gray); margin-bottom: 15px;">
                    Ces param√®tres s'appliquent √† tous les joueurs.
                </p>

                <button class="btn btn-secondary btn-full" onclick="showMyTicketModal()">üéüÔ∏è Mon ticket</button>
                
                <div style="display: grid; gap: 12px;">
                    <!-- Sens de d√©placement personnel -->
                    <div style="background: ${monSens === 1 ? '#dcfce7' : '#dbeafe'}; padding: 12px; border-radius: 8px;">
                        <label style="font-size: 0.9rem; font-weight: bold;">üéØ Ton sens de d√©placement</label>
                        <p style="font-size: 0.85rem; margin: 5px 0;">
                            Actuellement : <strong>${monSens === 1 ? '‚û°Ô∏è Sens horaire (1‚Üí2‚Üí3)' : '‚¨ÖÔ∏è Sens anti-horaire (3‚Üí2‚Üí1)'}</strong>
                        </p>
                        <div style="display: flex; gap: 10px; margin-top: 8px;">
                            <button class="btn ${monSens === 1 ? 'btn-primary' : ''}" style="flex: 1;" onclick="changerSens(1)">‚û°Ô∏è Horaire</button>
                            <button class="btn ${monSens === -1 ? 'btn-primary' : ''}" style="flex: 1;" onclick="changerSens(-1)">‚¨ÖÔ∏è Anti-horaire</button>
                        </div>
                    </div>
                    
                    <hr style="margin: 5px 0; border: none; border-top: 1px solid #e5e7eb;">
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">‚è±Ô∏è Temps de d√©cision (secondes)</label>
                        <input type="number" id="configTimingDecision" value="${gameConfig.timingDecision}" min="10" max="120" step="5" style="width: 100%; padding: 8px; margin-top: 4px;">
                        <p style="font-size: 0.75rem; color: #6b7280;">Temps pour acheter/passer sur une case</p>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">üî® Temps par ench√®re (secondes)</label>
                        <input type="number" id="configTimingEnchere" value="${gameConfig.timingEnchere}" min="30" max="180" step="10" style="width: 100%; padding: 8px; margin-top: 4px;">
                        <p style="font-size: 0.75rem; color: #6b7280;">Temps pour ench√©rir lors d'une vente</p>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">ü§ù Temps de n√©gociation (secondes)</label>
                        <input type="number" id="configTimingNego" value="${gameConfig.timingNegociation}" min="20" max="120" step="5" style="width: 100%; padding: 8px; margin-top: 4px;">
                        <p style="font-size: 0.75rem; color: #6b7280;">Temps pour n√©gocier un paiement</p>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">ü§ñ D√©lai robot (secondes)</label>
                        <input type="number" id="configTimingBot" value="${gameConfig.timingBot}" min="1" max="10" step="0.5" style="width: 100%; padding: 8px; margin-top: 4px;">
                        <p style="font-size: 0.75rem; color: #6b7280;">Pause avant action des robots</p>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">üí∞ Capital initial (‚Ç¨)</label>
                        <input type="number" id="configCapital" value="${gameConfig.capitalInitial}" min="100" max="1000" step="50" style="width: 100%; padding: 8px; margin-top: 4px;">
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">üìà Taux d'int√©r√™t (%)</label>
                        <input type="number" id="configInteret" value="${gameConfig.tauxInteret * 100}" min="0" max="50" step="5" style="width: 100%; padding: 8px; margin-top: 4px;">
                    </div>
                    
                    <hr style="margin: 5px 0; border: none; border-top: 1px solid #e5e7eb;">
                    <p style="font-size: 0.85rem; font-weight: bold; color: #b45309;">üìä Transitions de phase (passages Ligne 1)</p>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">üìä Phase 2 apr√®s (passages Ligne 1)</label>
                        <select id="configPhase2Passages" style="width: 100%; padding: 8px; margin-top: 4px;">
                            ${[4, 6, 8, 10, 12, 15].map(v => `<option value="${v}" ${v === (gameConfig.phase2_passagesMin ?? CONFIG.phase2_passagesMin) ? 'selected' : ''}>${v} passages</option>`).join('')}
                        </select>
                        <p style="font-size: 0.75rem; color: #6b7280;">Nombre de passages avant que l'√©rosion commence</p>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">üåç Phase 3 apr√®s (passages Ligne 1)</label>
                        <select id="configPhase3Passages" style="width: 100%; padding: 8px; margin-top: 4px;">
                            ${[8, 10, 12, 15, 20, 25, 30].map(v => `<option value="${v}" ${v === (gameConfig.phase3_passagesMin ?? CONFIG.phase3_passagesMin) ? 'selected' : ''}>${v} passages</option>`).join('')}
                        </select>
                        <p style="font-size: 0.75rem; color: #6b7280;">Nombre de passages max avant l'effondrement</p>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">üìâ Phase 3 si emploi < (%)</label>
                        <select id="configPhase3Emploi" style="width: 100%; padding: 8px; margin-top: 4px;">
                            ${[30, 40, 50, 60, 70].map(v => `<option value="${v}" ${v === (gameConfig.phase3_tauxEmploiMin ?? CONFIG.phase3_tauxEmploiMin) ? 'selected' : ''}>${v}%</option>`).join('')}
                        </select>
                        <p style="font-size: 0.75rem; color: #6b7280;">Taux d'emploi minimum en Phase 2</p>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">üí∏ Phase 3 si dette > (‚Ç¨)</label>
                        <select id="configPhase3Dette" style="width: 100%; padding: 8px; margin-top: 4px;">
                            ${[1000, 1500, 2000, 3000, 5000].map(v => `<option value="${v}" ${v === (gameConfig.phase3_detteMax ?? CONFIG.phase3_detteMax) ? 'selected' : ''}>${v}‚Ç¨</option>`).join('')}
                        </select>
                        <p style="font-size: 0.75rem; color: #6b7280;">Dette totale d√©clenchant l'effondrement</p>
                    </div>
                </div>
            `, `
                <button class="btn btn-primary" onclick="saveConfig()">üíæ Sauvegarder</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            `);
        }
        
        // Changer le sens de d√©placement personnel
        async function changerSens(nouveauSens) {
            await gameRef.child(`sensJoueurs/${myPlayerId}`).set(nouveauSens);
            closeModal();
            const sensText = nouveauSens === 1 ? '‚û°Ô∏è Sens horaire' : '‚¨ÖÔ∏è Sens anti-horaire';
            sendSystemMessage(`üéØ ${myName} change pour ${sensText}`);
            await updateBoard();
            showConfigModal();  // R√©ouvrir le modal pour voir le changement
        }
        
        async function saveConfig() {
            gameConfig.timingDecision = parseInt(document.getElementById('configTimingDecision').value) || 30;
            gameConfig.timingEnchere = parseInt(document.getElementById('configTimingEnchere').value) || 60;
            gameConfig.timingNegociation = parseInt(document.getElementById('configTimingNego').value) || 45;
            gameConfig.timingBot = parseFloat(document.getElementById('configTimingBot').value) || 2;
            gameConfig.capitalInitial = parseInt(document.getElementById('configCapital').value) || 450;
            gameConfig.tauxInteret = (parseInt(document.getElementById('configInteret').value) || 10) / 100;
            gameConfig.phase2_passagesMin = parseInt(document.getElementById('configPhase2Passages').value) || CONFIG.phase2_passagesMin;
            gameConfig.phase3_passagesMin = parseInt(document.getElementById('configPhase3Passages').value) || CONFIG.phase3_passagesMin;
            gameConfig.phase3_tauxEmploiMin = parseInt(document.getElementById('configPhase3Emploi').value) || CONFIG.phase3_tauxEmploiMin;
            gameConfig.phase3_detteMax = parseInt(document.getElementById('configPhase3Dette').value) || CONFIG.phase3_detteMax;
            
            // Validation : Phase 2 doit arriver avant Phase 3
            if (gameConfig.phase2_passagesMin >= gameConfig.phase3_passagesMin) {
                alert('‚ö†Ô∏è Phase 2 doit se d√©clencher AVANT Phase 3 !\nPassages Phase 2 (' + gameConfig.phase2_passagesMin + ') doit √™tre inf√©rieur √† Phase 3 (' + gameConfig.phase3_passagesMin + ')');
                return;
            }
            
            // Sauvegarder dans Firebase
            await db.ref(`parties/${currentGameCode}/config`).set(gameConfig);
            
            closeModal();
            sendSystemMessage(`‚öôÔ∏è Configuration mise √† jour par ${myName}`);
        }
        
        // Variable pour le timer de d√©cision
        let decisionTimer = null;
        let decisionTimeLeft = 0;
        
        // D√©marrer un timer de d√©cision
        function startDecisionTimer(seconds, onTimeout) {
            stopDecisionTimer();
            decisionTimeLeft = seconds;
            
            // Afficher le timer dans le modal
            updateTimerDisplay();
            
            decisionTimer = setInterval(() => {
                decisionTimeLeft--;
                updateTimerDisplay();
                
                if (decisionTimeLeft <= 0) {
                    stopDecisionTimer();
                    if (onTimeout) onTimeout();
                }
            }, 1000);
        }
        
        function stopDecisionTimer() {
            if (decisionTimer) {
                clearInterval(decisionTimer);
                decisionTimer = null;
            }
        }
        
        function updateTimerDisplay() {
            const timerEl = document.getElementById('modalTimer');
            if (timerEl) {
                const color = decisionTimeLeft <= 10 ? '#dc2626' : decisionTimeLeft <= 20 ? '#f59e0b' : '#10b981';
                timerEl.innerHTML = `<span style="color: ${color}; font-weight: bold;">‚è±Ô∏è ${decisionTimeLeft}s</span>`;
            }
        }
        
        async function addBot(profilId) {
            closeModal();
            const profil = PROFILS_IA[profilId];
            const botId = 'bot_' + Date.now();
            const botNames = ['Robot-A', 'Robot-B', 'Robot-C', 'Robot-D', 'Robot-E', 'Robot-F'];
            const botName = botNames[Object.keys(playersData).length - 1] || 'Robot';
            // Avatars robots d√©di√©s (diff√©rents des humains) pour √©viter toute confusion
            const botAvatars = ['ü§ñ', 'ü¶æ', 'üß†', '‚öôÔ∏è', 'üõ∞Ô∏è', 'üî©'];
            const botIndex = Object.values(playersData).filter(p => p && p.isBot).length;
            const botAvatar = botAvatars[botIndex % botAvatars.length];
            
            // Choisir un profil √©conomique al√©atoire pour le robot
            const botEcoProfil = Math.random() > 0.5 ? 'creatif' : 'contributif';
            
            await db.ref(`parties/${currentGameCode}/players/${botId}`).set({
                id: botId, name: botName, avatar: botAvatar,
                position: 0, euro: CONFIG.capitalInitial, espoyr: 0, emprunt: 0,
                isHost: false, isBot: true, botProfil: profilId,
                profil: botEcoProfil,  // Profil √©conomique du robot
                membreAAA: profil.membreAAA || false,
                passagesDepart: 0, passagesDepuisPhase2: 0,
                joinedAt: firebase.database.ServerValue.TIMESTAMP,
                    isConnected: true,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                  secretHash: 'bot'
            });
            
            // Si le profil est membre AAA, l'ajouter √† la liste comptable
            if (profil.membreAAA) {
                COMPTABILITE.potAAA.membres = COMPTABILITE.potAAA.membres || [];
                if (!COMPTABILITE.potAAA.membres.includes(botId)) {
                    COMPTABILITE.potAAA.membres.push(botId);
                }
            }
            
            await comptaCapitalInitial(botId, CONFIG.capitalInitial);
            await syncComptabiliteToFirebase();
            
            const profilIcon = botEcoProfil === 'creatif' ? 'üé®' : 'üèõÔ∏è';
            sendSystemMessage(`ü§ñ ${botName} (${profil.nom} ${profilIcon}) a rejoint !${profil.membreAAA ? ' ' + LOGO_AAA + ' Membre AAA' : ''}`);
        }
        
        // ========== UI JEU ==========
        function updateGameUI() {
            if (!gameState) return;
            
            document.getElementById('turnNumber').textContent = gameState.turn || 1;
            
            const phase = gameState.phase || 1;
            const phaseEl = document.getElementById('phaseNumber');
            phaseEl.textContent = phase;
            phaseEl.style.color = { 1: '#10b981', 2: '#f59e0b', 3: '#ef4444' }[phase];
            
            // Indicateur du sens de d√©placement
            const sensEl = document.getElementById('sensIndicator');
            if (sensEl) {
                const sens = gameState?.sensDeplacent || sensDeplacementGlobal || 1;
                sensEl.textContent = sens === 1 ? '‚û°Ô∏è' : '‚¨ÖÔ∏è';
                sensEl.title = sens === 1 ? 'Sens horaire (1‚Üí2‚Üí3)' : 'Sens anti-horaire (3‚Üí2‚Üí1)';
            }
            
            // Afficher/masquer le bouton Config pour l'host
            const configBtn = document.getElementById('configBtn');
            if (configBtn) {
                configBtn.style.display = isHost ? 'block' : 'none';
            }
            
            // Afficher le bouton Force Next pour l'h√¥te
            const forceNextBtn = document.getElementById('forceNextBtn');
            if (forceNextBtn) {
                // Visible uniquement pour l'h√¥te ET uniquement si le joueur dont c'est le tour est absent
                let show = false;
                try {
                    const players = getOrderedPlayers();
                    const idx = gameState.currentPlayerIndex || 0;
                    const current = players[idx];
                    show = !!isHost && !!current && isAbsent(current);
                    if (show) {
                        forceNextBtn.title = `Passer le tour (joueur absent : ${current.name || current.id})`;
                    }
                } catch(e) {}
                forceNextBtn.style.display = show ? 'inline-block' : 'none';
            }
            
            // Afficher les contr√¥les de temps et mettre √† jour la position
            const timeControls = document.getElementById('hostTimeControls');
            if (timeControls) {
                timeControls.style.display = 'flex';
                updateEventPositionDisplay();
            }
            
            // Mettre √† jour le texte du bouton √âquipement/Formation selon le profil
            const equiperBtn = document.getElementById('equiperBtn');
            if (equiperBtn && playersData[myPlayerId]) {
                const profil = playersData[myPlayerId].profil || 'contributif';
                if (profil === 'contributif') {
                    equiperBtn.innerHTML = 'üìö Formation';
                } else {
                    equiperBtn.innerHTML = 'üîß √âquipement';
                }
            }
            
           const players = getOrderedPlayers();
            const currentIdx = gameState.currentPlayerIndex || 0;
            const currentPlayer = players[currentIdx];
            
            if (currentPlayer) {
                const isMyTurn = currentPlayer.id === myPlayerId;
                const isBot = currentPlayer.isBot;
                
                document.getElementById('turnIndicator').textContent = 
                    isMyTurn ? 'üéØ TON TOUR !' : `‚è≥ ${currentPlayer.name}${isBot ? ' ü§ñ' : ''}`;
                
                const diceBtn = document.getElementById('rollDiceBtn');
                diceBtn.disabled = !isMyTurn;
                diceBtn.style.opacity = isMyTurn ? '1' : '0.5';

// Clignotement de l'onglet
if (isMyTurn) {
    if (!window._blinkInterval) {
        let blink = true;
        window._blinkInterval = setInterval(() => {
            document.title = blink ? `üéØ ${myName} - C'EST TON TOUR !` : `‚¨ú ${myName} - √Ä toi de jouer !`;
            blink = !blink;
        }, 800);
    }
} else {
    if (window._blinkInterval) {
        clearInterval(window._blinkInterval);
        window._blinkInterval = null;
    }
    document.title = `${myName} - ‚è≥ Tour de ${currentPlayer.name}`;
}







                
                
                document.getElementById('diceMessage').textContent = 
                    isMyTurn ? `üé≤ ${myName}, c'est ton tour ! Tu as ${fmt(COMPTABILITE?.caisseJoueurs?.[myPlayerId]?.euro || 0)}‚Ç¨ et ${fmt(COMPTABILITE?.caisseJoueurs?.[myPlayerId]?.espoyr || 0)}#` : `${currentPlayer.name} joue...`;
                
                // Robot joue avec le timing configurable (seulement si pas en mode replay)
              if (isBot && isHost && !replayMode) {
    // √âviter les doublons: si un timeout est d√©j√† programm√© pour ce m√™me index, ne rien faire
    if (_botScheduledIdx === currentIdx) {
        console.log(`ü§ñ Bot timeout d√©j√† programm√© pour index ${currentIdx}, ignor√©`);
    } else {
        // Annuler tout timeout bot pr√©c√©dent (changement de tour)
        if (_botTimeout) {
            clearTimeout(_botTimeout);
            _botTimeout = null;
        }
        _botScheduledIdx = currentIdx;
        const delaiBot = (gameConfig.timingBot || 2) * 1000;
        const expectedIdx = currentIdx;
        _botTimeout = setTimeout(async () => {
            _botTimeout = null;
            _botScheduledIdx = -1;
            // Guard: v√©rifier que l'index n'a pas chang√© entre-temps
            const actualIdx = gameState?.currentPlayerIndex || 0;
            if (actualIdx !== expectedIdx) {
                console.log(`ü§ñ Bot annul√©: index chang√© (${expectedIdx} ‚Üí ${actualIdx})`);
                return;
            }
            try {
                await playBotTurn(currentPlayer);
            } catch(e) {
                console.error('ü§ñ Bot bloqu√©:', e);
                sendSystemMessage(`‚ö†Ô∏è ${currentPlayer.name} est bloqu√©, tour pass√©`);
                nextTurn();
            }
        }, delaiBot);
    }
} else {
    // Ce n'est pas un bot: annuler tout timeout bot en attente
    if (_botTimeout) {
        clearTimeout(_botTimeout);
        _botTimeout = null;
        _botScheduledIdx = -1;
    }
}
            }
            
            updateBoard();
        }
        
        // ========== PLATEAU ==========
        async function updateBoard() {
            const boardEl = document.getElementById('gameBoard');
            if (!boardEl) return;
            
            const players = getOrderedPlayers();
            const activitesSnap = await gameRef.child('activites').once('value');
            const activites = activitesSnap.val() || {};
            const equipSnap = await gameRef.child('equipements').once('value');
            const equipements = equipSnap.val() || {};
            const equipTypesSnap = await gameRef.child('equipementTypes').once('value');
            const equipTypes = equipTypesSnap.val() || {};
            
            // R√©cup√©rer le sens de chaque joueur
            const sensJoueursSnap = await gameRef.child('sensJoueurs').once('value');
            const sensJoueurs = sensJoueursSnap.val() || {};
            
            // Identifier la position du joueur actuel
            const currentIdx = gameState?.currentPlayerIndex || 0;
            const currentPlayer = players[currentIdx];
            const currentPos = Number.isFinite(currentPlayer?.position) ? currentPlayer.position : null;
            
            boardEl.innerHTML = CASES.map(c => {
                const playersHere = players.filter(p => p.position === c.id);
                const owner = activites[c.id];
                const ownerPlayer = owner ? players.find(p => p.id === owner) : null;
                const nbEquip = equipements[c.id] || 0;
                const equipList = equipTypes[c.id] || [];
                const isCurrent = (currentPos !== null && c.id === currentPos);
                
                let ownerStyle = '';
                if (ownerPlayer) {
                    const idx = players.findIndex(p => p.id === owner);
                    ownerStyle = `border-color: ${PLAYER_COLORS[idx]}`;
                }
                
                // Afficher les types d'√©quipements (A, B, AA, AB, BB)
                let equipIndicator = '';
                if (equipList.length > 0) {
                    const equipStr = equipList.join('');  // "A", "B", "AA", "AB", "BB"
                    const equipColors = {
                        'A': '#059669',  // Vert (durable)
                        'B': '#f59e0b',  // Orange (classique)
                        'AA': '#047857', // Vert fonc√©
                        'AB': '#0d9488', // Teal
                        'BB': '#d97706'  // Orange fonc√©
                    };
                    const color = equipColors[equipStr] || '#6b7280';
                    equipIndicator = `<span style="background:${color};color:white;padding:1px 3px;border-radius:3px;font-size:0.6rem;font-weight:bold;">${equipStr}</span>`;
                }
                
                return `
                    <div class="case ${c.type} ${owner ? 'owned' : ''} ${isCurrent ? 'current' : ''}" style="${ownerStyle}"
                         data-case-id="${c.id}" onclick="showCaseInfo(${c.id})" title="${c.name}">
                        <span class="case-number">${c.id}</span>
                        ${(c.hash && (gameState?.phase || 1) >= 3) ? '<span class="case-hash">#</span>' : ''}
                        <span class="case-icon">${c.icon}</span>
                        <span class="case-name">${c.name}</span>
                        ${c.prix ? `<span class="case-price">${fmt(c.prix)}‚Ç¨ ${equipIndicator}</span>` : ''}
                        ${ownerPlayer ? `<span class="owner-indicator">${ownerPlayer.avatar}</span>` : ''}
                        ${playersHere.length > 0 ? `
                            <div class="players-on-case">
                                ${playersHere.map(p => {
                                    const idx = players.findIndex(pl => pl.id === p.id);
                                   const playerSens = p.sensDeplacement || sensJoueurs[p.id] || 1;
                                    const arrowSymbol = playerSens === 1 ? '‚ñ∂' : '‚óÄ';
                                   return `<div style="display: flex; flex-direction: column; align-items: center;"><div class="player-marker" style="background: ${PLAYER_COLORS[idx]};" title="${p.name}"></div><span style="font-size: 10px; line-height: 1;">${arrowSymbol}</span></div>`;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
// ============================================================
// ESPOYR ‚Äî MODULE D√â & D√âPLACEMENT (remplacement complet)
// ============================================================
// √Ä coller dans le fichier HTML principal en remplacement de :
//   - rollDice()
//   - askPhysicalDiceValue()
//   - movePlayer() (si elle existe)
//   - toute logique de d√©placement existante
//
// Pr√©requis d√©j√† pr√©sents dans le fichier :
//   - CASES[] (23 cases, indices 0-22)
//   - gameRef, gameState, playersData, myPlayerId, isHost
//   - rollDiceValue()  (RNG seed√©/replay)
//   - showModal(), closeModal(), sendSystemMessage()
//   - logEvent(), GAME_SAVE
//   - gameConfig.diceMode ('AUTO' | 'PHYSIQUE')
//   - PLAYER_COLORS[], updateBoard(), updatePlayersUI()
// ============================================================



// ‚îÄ‚îÄ‚îÄ Utilitaires ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/** Calcule la nouvelle position apr√®s un d√©placement de `pas` cases */
     const NB_CASES = CASES.length;   
function calculerNouvellePosition(posActuelle, pas, sens) {
    // sens = 1 (horaire, croissant) ou -1 (anti-horaire, d√©croissant)
    return ((posActuelle + pas * sens) % NB_CASES + NB_CASES) % NB_CASES;
}

/** V√©rifie si le joueur a d√©j√† un sens enregistr√© */
function joueurASens(idJoueur) {
    const j = playersData[idJoueur];
    const s = Number(j?.sensDeplacement);
    return s === 1 || s === -1;
}

/** Retourne le sens enregistr√© du joueur (1 ou -1), ou null */
function getSensJoueur(idJoueur) {
    const j = playersData[idJoueur];
    if (!j) return null;
    const s = Number(j.sensDeplacement);
    return (s === 1 || s === -1) ? s : null;
}

// ‚îÄ‚îÄ‚îÄ Emojis faces du d√© ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const FACES_DE = ['', '‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];

function emojiDe(val) {
    return FACES_DE[val] || 'üé≤';
}

// ‚îÄ‚îÄ‚îÄ Animation d√© virtuel (cosm√©tique) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function animerDe(valFinale) {
    return new Promise(resolve => {
        const elDe = document.getElementById('dice');
        if (!elDe) { resolve(); return; }

        elDe.classList.add('rolling');
        let compteur = 0;
        const maxTicks = 12;

        const intervalle = setInterval(() => {
            elDe.textContent = emojiDe(Math.floor(Math.random() * 6) + 1);
            compteur++;
            if (compteur >= maxTicks) {
                clearInterval(intervalle);
                elDe.classList.remove('rolling');
                elDe.textContent = emojiDe(valFinale);
                resolve();
            }
        }, 80);
    });
}

// ‚îÄ‚îÄ‚îÄ Animation d√©placement case par case ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function animerDeplacement(idJoueur, posDepart, posArrivee, sens) {
    return new Promise(resolve => {
        const etapes = [];
        let pos = posDepart;

        // Construire la liste des cases travers√©es
        while (pos !== posArrivee) {
            pos = ((pos + sens) % NB_CASES + NB_CASES) % NB_CASES;
            etapes.push(pos);
        }

        if (etapes.length === 0) { resolve(); return; }

        let i = 0;
        const intervalle = setInterval(() => {
            // Mettre en surbrillance la case travers√©e
            const elCase = document.querySelector(`.case[data-id="${etapes[i]}"]`);
            if (elCase) {
                elCase.classList.add('passing');
                setTimeout(() => elCase.classList.remove('passing'), 300);
            }
            i++;
            if (i >= etapes.length) {
                clearInterval(intervalle);
                // Mettre en surbrillance la case d'arriv√©e
                const elArrivee = document.querySelector(`.case[data-id="${posArrivee}"]`);
                if (elArrivee) elArrivee.classList.add('current');
                resolve();
            }
        }, 200);
    });
}

// ‚îÄ‚îÄ‚îÄ V√©rifier passage par la case D√©part ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function aTraverseLaCase0(posDepart, posArrivee, sens) {
    if (posDepart === posArrivee) return false;
    // Atterrir SUR la case 0 compte aussi comme passage
    if (posArrivee === 0 && posDepart !== 0) return true;
    let pos = posDepart;
    while (pos !== posArrivee) {
        pos = ((pos + sens) % NB_CASES + NB_CASES) % NB_CASES;
        if (pos === 0 && posArrivee !== 0) return true;
        if (pos === posArrivee) break;
    }
    return false;
}

// D√©tecte le franchissement de la Ligne 3 (entre case 13 Taxe et case 14 Garage)
// On franchit si on passe par la fronti√®re 13‚Üí14 (sens +) ou 14‚Üí13 (sens -)
function aTraverseLaLigne3(posDepart, posArrivee, sens) {
    if (posDepart === posArrivee) return false;
    // Phase 3 : pas de taxe Ligne 3
    if ((gameState?.phase || 1) >= 3) return false;
    
    let pos = posDepart;
    let prevPos;
    let steps = 0;
    while (pos !== posArrivee && steps < NB_CASES + 1) {
        prevPos = pos;
        pos = ((pos + sens) % NB_CASES + NB_CASES) % NB_CASES;
        steps++;
        if ((prevPos === 13 && pos === 14) || (prevPos === 14 && pos === 13)) return true;
        if (pos === posArrivee) break;
    }
    return false;
}
     // ============================================================
// ordre des joueurs
// ============================================================

function getOrderedPlayers() {
    return Object.values(playersData)
        .sort((a, b) => (a.playOrder ?? a.joinedAt ?? 0) - (b.playOrder ?? b.joinedAt ?? 0));
}



 
// ============================================================
// FLUX PRINCIPAL : rollDice()
// ============================================================
// Appel√© quand le joueur clique sur "üé≤ Lancer"
// G√®re les deux modes (AUTO / PHYSIQUE) et le premier lancer
// ============================================================

async function rollDice() {
    if (!gameState || !gameRef) return;
    
    // ‚îÄ‚îÄ Protection anti-double-lancer ‚îÄ‚îÄ
    if (turnActionInProgress) {
        console.log('üõë rollDice bloqu√©: action en cours');
        return;
    }

    const listeJoueurs = getOrderedPlayers()
    const indexActuel = gameState.currentPlayerIndex || 0;
    const joueurActuel = listeJoueurs[indexActuel];

    if (!joueurActuel) return;

    // ‚îÄ‚îÄ Seul le joueur actif (ou l'h√¥te pour un bot) peut lancer ‚îÄ‚îÄ
   const estMonTour = (joueurActuel.id === myPlayerId);
    const estTourBot = !!joueurActuel.isBot;
    if (!estMonTour && !(isHost && estTourBot)) return;

    // Verrouiller le tour
    turnActionInProgress = true;
    const btnLancer = document.getElementById('rollDiceBtn');
    if (btnLancer) btnLancer.disabled = true;

    try {
        // ‚îÄ‚îÄ SKIP TOUR : Action Contributive ‚Üí passe son tour ‚îÄ‚îÄ
        const skipSnap = await gameRef.child(`skipTurns/${joueurActuel.id}`).once('value');
        const skipCount = skipSnap.val() || 0;
        if (skipCount > 0) {
            // Int√©r√™ts d√©couvert m√™me quand on passe
            const caisseSk = COMPTABILITE.caisseJoueurs[joueurActuel.id] || {};
            if ((caisseSk.euro || 0) < 0) {
                const decouvert = Math.abs(caisseSk.euro);
                const interetsDec = arrondir2(decouvert * 0.03);
                caisseSk.euro -= interetsDec;
                await db.ref(`parties/${currentGameCode}/players/${joueurActuel.id}/euro`).set(caisseSk.euro);
                await syncComptabiliteToFirebase();
                sendSystemMessage(`üìâ ${joueurActuel.name} : int√©r√™ts d√©couvert 3% = -${fmt(interetsDec)}‚Ç¨ (solde: ${fmt(caisseSk.euro)}‚Ç¨)`);
            }
            // D√©cr√©menter et passer
            await gameRef.child(`skipTurns/${joueurActuel.id}`).set(skipCount - 1);
            sendSystemMessage(`‚è≠Ô∏è ${joueurActuel.name} passe son tour (action contributive)`);
            showModal(`
                <h3>‚è≠Ô∏è Tour pass√©</h3>
                <p><strong>${joueurActuel.avatar} ${joueurActuel.name}</strong> passe ce tour.</p>
                <p style="font-size:0.9rem;color:#6b7280;">Cons√©quence de l'action contributive effectu√©e pr√©c√©demment.</p>
                ${(caisseSk.euro || 0) < 0 ? `<p style="color:#dc2626;font-size:0.9rem;">üìâ Int√©r√™ts d√©couvert 3% appliqu√©s</p>` : ''}
            `, `<button class="btn btn-primary" onclick="closeModal(); nextTurn();">OK</button>`);
            if (btnLancer) btnLancer.disabled = false;
            // turnActionInProgress reste true ‚Üí sera reset par nextTurn()
            return;
        }

        // ‚îÄ‚îÄ INT√âR√äTS D√âCOUVERT 3% avant le lanc√© ‚îÄ‚îÄ
        const caisseAvantLancer = COMPTABILITE.caisseJoueurs[joueurActuel.id] || {};
        if ((caisseAvantLancer.euro || 0) < 0) {
            const decouvertAvant = Math.abs(caisseAvantLancer.euro);
            const interetsDecouvert = arrondir2(decouvertAvant * 0.03);
            caisseAvantLancer.euro -= interetsDecouvert;
            
            // Compteur de difficult√©s cons√©cutives (d√©clencheur social Phase 2)
            const diffSnap = await gameRef.child(`difficulteConsecutive/${joueurActuel.id}`).once('value');
            const diffCount = (diffSnap.val() || 0) + 1;
            await gameRef.child(`difficulteConsecutive/${joueurActuel.id}`).set(diffCount);
            
            await db.ref(`parties/${currentGameCode}/players/${joueurActuel.id}/euro`).set(caisseAvantLancer.euro);
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üìâ ${joueurActuel.name} : int√©r√™ts d√©couvert 3% = -${fmt(interetsDecouvert)}‚Ç¨ (solde: ${fmt(caisseAvantLancer.euro)}‚Ç¨)`);
            
            // D√©clencheur social : 2x de suite en difficult√© ‚Üí Phase 2
            const phase = gameState?.phase || 1;
            if (phase === 1 && diffCount >= 2) {
                await gameRef.child('state/phase').set(2);
                await gameRef.child(`difficulteConsecutive/${joueurActuel.id}`).set(0);
                showModal(`
                    <h3>ü§ù Transition vers la Phase 2</h3>
                    <div style="background:#dbeafe;padding:12px;border-radius:8px;">
                        <p style="margin:0;font-style:italic;color:#1e40af;line-height:1.5;">
                            "Une soci√©t√© responsable ne laisse pas ses semblables dans l'exclusion. 
                            Il y a tant d'actions contributives qui sont nobles et m√©ritent d'√™tre remplies, 
                            m√™me s'il n'y a pas de rendement √©conomique mesurable."
                        </p>
                    </div>
                    <p style="margin-top:10px;text-align:center;">
                        <strong>Les Actions Contributives sont maintenant disponibles !</strong>
                    </p>
                `, `<button class="btn btn-primary" onclick="closeModal()">ü§ù Compris</button>`);
                sendSystemMessage(`ü§ù PHASE 2 d√©clench√©e par la solidarit√© ! Les actions contributives sont disponibles.`);
                // Le joueur doit relancer ‚Üí d√©verrouiller
                if (btnLancer) btnLancer.disabled = false;
                turnActionInProgress = false;
                return; // Le joueur relancera apr√®s avoir ferm√© le modal
            }
        } else {
            // Solde positif ‚Üí reset compteur difficult√©s
            await gameRef.child(`difficulteConsecutive/${joueurActuel.id}`).set(0);
        }

            // Choix du sens AVANT le lancer
        if (!joueurASens(joueurActuel.id)) {
            await choisirSens(joueurActuel, null);
        }
        
        // ‚îÄ‚îÄ D√©terminer la valeur du d√© ‚îÄ‚îÄ
        let valeurDe;
        const modeDe = gameConfig.diceMode || 'AUTO';

        if (modeDe === 'PHYSIQUE' && isHost) {
            // MODE PHYSIQUE : l'h√¥te encode la valeur via modal graphique
            valeurDe = await demanderValeurDePhysique(joueurActuel.name);
            if (valeurDe === null) {
                // Annul√© ‚Üí r√©activer
                if (btnLancer) btnLancer.disabled = false;
                turnActionInProgress = false;
                return;
            }
        } else if (modeDe === 'PHYSIQUE' && !isHost) {
            // Un non-h√¥te ne peut pas lancer en mode physique
            // On √©crit une demande dans Firebase pour signaler √† l'h√¥te
            await gameRef.child('state/demandeDe').set({
                playerId: joueurActuel.id,
                playerName: joueurActuel.name,
                demandeLe: firebase.database.ServerValue.TIMESTAMP
            });
            document.getElementById('diceMessage').textContent =
                `‚è≥ En attente de l'h√¥te pour le d√© de ${joueurActuel.name}...`;
            if (btnLancer) btnLancer.disabled = false;
            turnActionInProgress = false;
            return;
        } else {
            // MODE AUTO : d√© virtuel automatique
            valeurDe = rollDiceValue();
        }

        // ‚îÄ‚îÄ Animer le d√© ‚îÄ‚îÄ
        await animerDe(valeurDe);
        document.getElementById('diceMessage').textContent =
            `${joueurActuel.avatar} ${joueurActuel.name} : ${emojiDe(valeurDe)} (${valeurDe})`;

        // ‚îÄ‚îÄ BONUS AAA : Si le joueur est membre, +50# cr√©√©s dans le Pot AAA ‚îÄ‚îÄ
        const isMembreAAA = COMPTABILITE.potAAA.membres?.includes(joueurActuel.id);
        if (isMembreAAA) {
            const bonusCree = await comptaBonusAAALancer(joueurActuel.id);
            sendSystemMessage(`${LOGO_AAA} +${bonusCree}# cr√©√©s dans le Pot AAA (${joueurActuel.name} membre)`);
        }

        // ‚îÄ‚îÄ D√©placement normal ‚îÄ‚îÄ
        const sens = getSensJoueur(joueurActuel.id);
        await effectuerDeplacement(joueurActuel, valeurDe, sens);

    } catch (err) {
        console.error('‚ùå Erreur rollDice:', err);
        sendSystemMessage(`‚ö†Ô∏è Erreur lors du lancer: ${err.message}`);
        // Erreur ‚Üí d√©verrouiller pour permettre de retenter
        turnActionInProgress = false;
        if (btnLancer) btnLancer.disabled = false;
    }
    // Pas de finally: le bouton reste verrouill√© jusqu'√† nextTurn()
}

// ============================================================
// CHOIX DU SENS (premier lancer uniquement)
// ============================================================

function choisirSens(joueur, valeurDe) {
    return new Promise((resolve) => {
        // Si c'est un bot, choisir al√©atoirement
        if (joueur.isBot) {
            const sens = Math.random() > 0.5 ? 1 : -1;
            confirmerSens(joueur, valeurDe, sens).then(resolve);
            return;
        }

        // Si c'est le joueur local OU l'h√¥te qui g√®re un joueur absent
        const peutChoisir = (joueur.id === myPlayerId) ||
                            (isHost && isAbsent(joueur));

        if (!peutChoisir) {
            // Attendre que le joueur choisisse (via √©couteur Firebase)
            document.getElementById('diceMessage').textContent =
                `‚è≥ ${joueur.name} choisit son sens de d√©placement...`;

            const ecouteur = gameRef.child(`players/${joueur.id}/sensDeplacement`)
                .on('value', (snap) => {
                    if (snap.val() === 1 || snap.val() === -1) {
                        gameRef.child(`players/${joueur.id}/sensDeplacement`).off('value', ecouteur);
                        // Le sens est choisi, continuer le d√©placement
                        effectuerDeplacement(joueur, valeurDe, snap.val()).then(resolve);
                    }
                });
            return;
        }

        // Afficher le modal de choix
        const posActuelle = joueur.position || 0;
        const caseHoraire = calculerNouvellePosition(posActuelle, valeurDe, 1);
        const caseAntiHoraire = calculerNouvellePosition(posActuelle, valeurDe, -1);
        const nomHoraire = CASES[caseHoraire]?.name || `Case ${caseHoraire}`;
        const nomAntiHoraire = CASES[caseAntiHoraire]?.name || `Case ${caseAntiHoraire}`;
// Avatars disponibles (retirer ceux d√©j√† pris)
        const tousAvatars = ['üè†','üöó','‚ö°','üê¢','üåø','üëΩ','üò∫','üîß'];
        const avatarsPris = Object.values(playersData)
            .filter(p => p.id !== joueur.id && p.avatar)
            .map(p => p.avatar);
        const avatarsDispos = tousAvatars.filter(a => !avatarsPris.includes(a));
        
        let avatarChoisi = joueur.avatar || avatarsDispos[0];

        showModal(`
            <h3>üß≠ Choisis ton avatar et ton sens</h3>
            <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 8px;">
                <strong>${joueur.name}</strong> ‚Äî Premier lancer
            </p>

            <div style="margin-bottom: 12px;">
                <p style="font-weight: bold; margin-bottom: 6px;">Ton avatar :</p>
                <div id="avatarGrid" style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                    ${avatarsDispos.map(a => `
                        <div onclick="document.querySelectorAll('#avatarGrid .av-btn').forEach(b=>b.style.border='2px solid #ccc'); this.style.border='3px solid #3b82f6'; window.__avatarChoisi='${a}';"
                            class="av-btn"
                            style="font-size: 1.8rem; cursor: pointer; padding: 6px 10px; border-radius: 8px;
                            border: 2px solid #ccc; background: white;">
                            ${a}
                        </div>
                    `).join('')}
                </div>
            </div>

            <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 15px;">
                ‚ö†Ô∏è Ce choix est <strong>d√©finitif</strong> pour toute la partie !
            </p>

            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <div onclick="if(!window.__avatarChoisi){alert('Choisis ton avatar !');return;}window.__callbackChoixSens(1)"
                    style="flex:1; min-width: 140px; background: #dbeafe; border: 3px solid #3b82f6;
                        border-radius: 12px; padding: 15px; cursor: pointer; text-align: center;
                        transition: all 0.2s;"
                    onmouseover="this.style.transform='scale(1.03)'"
                    onmouseout="this.style.transform='scale(1)'">
                    <p style="font-size: 1.5rem; margin: 0;">‚û°Ô∏è</p>
                    <p style="font-weight: bold; margin: 6px 0 2px 0;">Horaire</p>
                    <p style="font-size: 0.8rem; color: #6b7280;">
                        ‚Üí case ${caseHoraire} : ${CASES[caseHoraire]?.icon || ''} ${nomHoraire}
                    </p>
                </div>

                <div onclick="if(!window.__avatarChoisi){alert('Choisis ton avatar !');return;}window.__callbackChoixSens(-1)"
                    style="flex:1; min-width: 140px; background: #fef3c7; border: 3px solid #f59e0b;
                        border-radius: 12px; padding: 15px; cursor: pointer; text-align: center;
                        transition: all 0.2s;"
                    onmouseover="this.style.transform='scale(1.03)'"
                    onmouseout="this.style.transform='scale(1)'">
                    <p style="font-size: 1.5rem; margin: 0;">‚¨ÖÔ∏è</p>
                    <p style="font-weight: bold; margin: 6px 0 2px 0;">Anti-horaire</p>
                    <p style="font-size: 0.8rem; color: #6b7280;">
                        ‚Üí case ${caseAntiHoraire} : ${CASES[caseAntiHoraire]?.icon || ''} ${nomAntiHoraire}
                    </p>
                </div>
            </div>
        `, '');

        window.__avatarChoisi = null; // Forcer le joueur √† cliquer sur un avatar
        // Callback global pour le modal
       window.__callbackChoixSens = (sens) => {
            closeModal();
            window.__callbackChoixSens = null;
            const avatar = window.__avatarChoisi || joueur.avatar;
            myAvatar = avatar;
            confirmerSens(joueur, valeurDe, sens, avatar).then(resolve);
        };
    });
}

/** Sauvegarde le sens dans Firebase et encha√Æne le d√©placement */
async function confirmerSens(joueur, valeurDe, sens, avatar) {
    // Sauvegarder dans Firebase (permanent, ne changera plus)
    await gameRef.child(`players/${joueur.id}/sensDeplacement`).set(sens);
if (avatar) {
            await gameRef.child(`players/${joueur.id}/avatar`).set(avatar);
            if (playersData[joueur.id]) playersData[joueur.id].avatar = avatar;
        }
 

    // Mettre √† jour le cache local
    if (playersData[joueur.id]) {
        playersData[joueur.id].sensDeplacement = sens;
    }

    const labelSens = sens === 1 ? '‚û°Ô∏è Horaire' : '‚¨ÖÔ∏è Anti-horaire';
    sendSystemMessage(`${joueur.avatar} ${joueur.name} a choisi le sens ${labelSens}`);

    // JOURNAL √âV√âNEMENT
    logEvent('CHOIX_SENS', joueur.id, {
        sens,
        labelSens,
        valeurDe,
        position: joueur.position || 0
    });

    // Encha√Æner le d√©placement seulement si on a une valeur de d√©
        if (valeurDe !== null && valeurDe !== undefined) {
            await effectuerDeplacement(joueur, valeurDe, sens);
        }
}

// ============================================================
// D√âPLACEMENT EFFECTIF
// ============================================================

async function effectuerDeplacement(joueur, valeurDe, sens) {
    // Guard: sens invalide ‚Üí impossible de se d√©placer
    if (sens !== 1 && sens !== -1) {
        console.error(`‚ùå effectuerDeplacement: sens invalide (${sens}) pour ${joueur.name}`);
        sendSystemMessage(`‚ö†Ô∏è Erreur sens pour ${joueur.name} ‚Äî relancez le d√©`);
        return;
    }
    console.log(`üö∂ DEPLACEMENT: ${joueur.name} pos=${joueur.position} d√©=${valeurDe} sens=${sens}`);
    const posDepart = joueur.position || 0;
    const posArrivee = calculerNouvellePosition(posDepart, valeurDe, sens);

    // V√©rifier passage par la case D√©part
    const passageDepart = aTraverseLaCase0(posDepart, posArrivee, sens);
    
    // V√©rifier franchissement Ligne 3 (entre case 13 et 14)
    const passageLigne3 = aTraverseLaLigne3(posDepart, posArrivee, sens);

    // Animation case par case
    await animerDeplacement(joueur.id, posDepart, posArrivee, sens);

    // Pr√©parer les mises √† jour Firebase
    const miseAJour = {
        [`players/${joueur.id}/position`]: posArrivee,
        [`players/${joueur.id}/lastDice`]: valeurDe
    };

    if (passageDepart) {
        // Si joueur humain, handleSalary g√®re ces mises √† jour
        // Si bot ou autre, on les fait ici
        if (joueur.id !== myPlayerId) {
            const passages = (joueur.passagesDepart || 0) + 1;
            miseAJour[`players/${joueur.id}/passagesDepart`] = passages;
            
            // Incr√©menter le compteur global de passages Ligne 1
            const totalPassages = (gameState.passagesLigne1Total || 0) + 1;
            miseAJour['state/passagesLigne1Total'] = totalPassages;

            // Phase 2 : compter les passages depuis la phase 2
            if ((gameState?.phase || 1) >= 2) {
                const p2 = (joueur.passagesDepuisPhase2 || 0) + 1;
                miseAJour[`players/${joueur.id}/passagesDepuisPhase2`] = p2;
            }
        }
    }

    // √âcrire dans Firebase
    await gameRef.update(miseAJour);

    // Nettoyer la demande de d√© si pr√©sente (mode physique)
    try { await gameRef.child('state/demandeDe').remove(); } catch(e) {}

    // Mettre √† jour le cache local
    if (playersData[joueur.id]) {
        playersData[joueur.id].position = posArrivee;
        playersData[joueur.id].lastDice = valeurDe;
    }

    // JOURNAL √âV√âNEMENT
    logEvent('DEPLACEMENT', joueur.id, {
        de: posDepart,
        vers: posArrivee,
        valeurDe: valeurDe,
        sens,
        passageDepart,
        nomCase: CASES[posArrivee]?.name || `Case ${posArrivee}`
    });

    // Afficher le r√©sultat dans la zone de d√©
    const infoCase = CASES[posArrivee];
    const iconeSens = sens === 1 ? '‚û°Ô∏è' : '‚¨ÖÔ∏è';
    document.getElementById('diceMessage').textContent =
        `${iconeSens} ${joueur.avatar} ${joueur.name} ‚Üí ${infoCase?.icon || ''} ${infoCase?.name || 'Case ' + posArrivee}`;

    if (passageDepart) {
        sendSystemMessage(`üèÅ ${joueur.avatar} ${joueur.name} passe par la case D√©part !`);
    }

    // Rafra√Æchir le plateau
    updateBoard();

    // ‚îÄ‚îÄ Traiter le franchissement Ligne 3 (taxe 10% patrimoine) ‚îÄ‚îÄ
    if (passageLigne3 && joueur.id === myPlayerId) {
        console.log(`üèõÔ∏è ‚Üí Ligne 3 franchie par ${joueur.name}`);
        await handleLigne3(joueur.id);
    } else if (passageLigne3 && joueur.id !== myPlayerId) {
        // Autre joueur (bot g√©r√© dans playBotTurn) ou joueur distant
        console.log(`üèõÔ∏è ‚Üí Ligne 3 franchie par ${joueur.name} (non-local)`);
    }

    // ‚îÄ‚îÄ Traiter la case d'arriv√©e ‚îÄ‚îÄ
    console.log(`üìç ARRIVEE: ${joueur.name} case=${posArrivee} passage=${passageDepart} isMe=${joueur.id === myPlayerId}`);
    if (passageDepart && joueur.id === myPlayerId) {
        // Passage Ligne 1 pour joueur humain : salaire + int√©r√™ts + remboursement + recap modal
        console.log(`üí∞ ‚Üí handleSalary pour ${joueur.name}`);
        const currentPlayer = playersData[joueur.id] || joueur;
        await handleSalary(currentPlayer, valeurDe, posArrivee);
    } else {
        setTimeout(() => handleLanding(posArrivee), 300);
    }
}

// ============================================================
// MODE PHYSIQUE : Modal graphique pour l'h√¥te
// ============================================================
// Remplace l'ancien prompt() par un modal avec 6 boutons visuels

function demanderValeurDePhysique(nomJoueur) {
    return new Promise((resolve) => {
        showModal(`
            <h3>üé≤ D√© physique</h3>
            <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 12px;">
                C'est le tour de <strong>${nomJoueur}</strong>.
                <br>Encodez la valeur du d√© physique :
            </p>

            <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin: 15px 0;">
                ${[1,2,3,4,5,6].map(v => `
                    <button onclick="window.__callbackDePhysique(${v})"
                            style="width: 60px; height: 60px; font-size: 1.8rem;
                                   border: 3px solid #e5e7eb; border-radius: 12px;
                                   background: white; cursor: pointer;
                                   transition: all 0.15s;"
                            onmouseover="this.style.borderColor='#f59e0b'; this.style.transform='scale(1.1)'"
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='scale(1)'">
                        ${emojiDe(v)}
                    </button>
                `).join('')}
            </div>
        `, `
            <button class="btn" style="background: #f3f4f6; color: var(--gray);"
                    onclick="window.__callbackDePhysique(null)">Annuler</button>
        `);

        window.__callbackDePhysique = (val) => {
            closeModal();
            window.__callbackDePhysique = null;
            resolve(val);
        };
    });
}

// ============================================================
// √âCOUTE DES DEMANDES DE D√â (mode PHYSIQUE, c√¥t√© h√¥te)
// ============================================================
// L'h√¥te √©coute `state/demandeDe` : quand un joueur non-h√¥te
// clique sur "Lancer", une demande est cr√©√©e dans Firebase.
// L'h√¥te re√ßoit alors un modal pour encoder la valeur.

function ecouterDemandesDe() {
    if (!gameRef) {
        setTimeout(ecouterDemandesDe, 2000);
        return;
    }
    gameRef.child('state/demandeDe').off();
    gameRef.child('state/demandeDe').on('value', async (snap) => {
        if (!isHost) return;
        if (!snap.exists()) return;
        const demande = snap.val();
        if (!demande || !demande.playerId) return;
        const valeurDe = await demanderValeurDePhysique(demande.playerName || 'Joueur');
        if (valeurDe === null) {
            await gameRef.child('state/demandeDe').remove();
            return;
        }
        await gameRef.child('state/reponseDe').set({
            playerId: demande.playerId,
            valeur: valeurDe,
            reponduLe: Date.now()
        });
        await gameRef.child('state/demandeDe').remove();
    });
}
// ============================================================
// √âCOUTE DES R√âPONSES DE D√â (mode PHYSIQUE, c√¥t√© joueur)
// ============================================================
// Le joueur non-h√¥te √©coute `state/reponseDe` pour savoir
// quelle valeur l'h√¥te a encod√©e, puis effectue le d√©placement.

function ecouterReponsesDe() {
    if (!gameRef) return;

    gameRef.child('state/reponseDe').on('value', async (snap) => {
        if (!snap.exists()) return;

        const reponse = snap.val();
        if (!reponse || !reponse.playerId || !reponse.valeur) return;

        // C'est pertinent uniquement si c'est le tour de ce joueur
        const listeJoueurs = getOrderedPlayers();
        const indexActuel = gameState?.currentPlayerIndex || 0;
        const joueurActuel = listeJoueurs[indexActuel];

        if (!joueurActuel || joueurActuel.id !== reponse.playerId) return;

        // Seul le joueur concern√© (ou l'h√¥te pour un bot) traite la r√©ponse
        const estMoi = (reponse.playerId === myPlayerId);
        const estBotEtHote = (isHost && joueurActuel.isBot);

        if (!estMoi && !estBotEtHote) return;

        const valeurDe = reponse.valeur;

        // Animer le d√©
        await animerDe(valeurDe);
        document.getElementById('diceMessage').textContent =
            `${joueurActuel.avatar} ${joueurActuel.name} : ${emojiDe(valeurDe)} (${valeurDe})`;

       // Le sens a d√©j√† √©t√© choisi avant le lancer
        const sens = getSensJoueur(joueurActuel.id);
        await effectuerDeplacement(joueurActuel, valeurDe, sens);

        // Nettoyer la r√©ponse trait√©e
        try { await gameRef.child('state/reponseDe').remove(); } catch(e) {}
    });
}

// [lancerDeBot supprim√© ‚Äî code mort, les bots utilisent playBotTurn]

// ============================================================
// INDICATEUR DE SENS DANS LA BARRE DE STATUT
// ============================================================

function mettreAJourIndicateurSens() {
    const el = document.getElementById('sensIndicator');
    if (!el || !gameState) return;

    const listeJoueurs = getOrderedPlayers()
    const indexActuel = gameState.currentPlayerIndex || 0;
    const joueurActuel = listeJoueurs[indexActuel];

    if (!joueurActuel) { el.textContent = ''; return; }

    const sens = getSensJoueur(joueurActuel.id);
    if (sens === 1) {
        el.textContent = '‚û°Ô∏è Horaire';
        el.style.color = '#3b82f6';
    } else if (sens === -1) {
        el.textContent = '‚¨ÖÔ∏è Anti-horaire';
        el.style.color = '#f59e0b';
    } else {
        el.textContent = 'üß≠ √Ä choisir';
        el.style.color = '#6b7280';
    }
}

// ============================================================
// INITIALISATION : √† appeler apr√®s subscribeToGame()
// ============================================================

function initSystemeDe() {
        ecouterDemandesDe();
        ecouterReponsesDe();
        console.log('üé≤ Syst√®me de d√© initialis√©');
    }

      
        
        
        // Animer le passage sur chaque case (avec protection contre le blocage)
        async function animatePassingCases(startPos, steps, sens) {
            try {
                const casesCount = CASES.length;
                for (let i = 1; i <= steps; i++) {
                    let passPos;
                    if (sens === 1) {
                        passPos = (startPos + i) % casesCount;
                    } else {
                        passPos = (startPos - i + casesCount) % casesCount;
                    }
                    
                    // Trouver l'√©l√©ment de la case
                    const caseEl = document.querySelector(`[data-case-id="${passPos}"]`);
                    if (caseEl) {
                        caseEl.classList.add('passing');
                        // Retirer la classe apr√®s l'animation
                        setTimeout(() => caseEl.classList.remove('passing'), 150);
                    }
                    
                    // Attendre entre chaque case
                    await new Promise(resolve => setTimeout(resolve, 120));
                }
            } catch (e) {
                console.error('Erreur animation passage:', e);
            }
        }
        
        
        // [executerLancerDe supprim√© ‚Äî code mort remplac√© par effectuerDeplacement]
        
        
        // Bonus AAA : 50# cr√©√©s dans le Pot √† chaque lancer d'un membre
        async function comptaBonusAAALancer(joueurId) {
            const bonusAAA = 50;
            
            // Cr√©ation mon√©taire : le Pot AAA augmente
            COMPTABILITE.potAAA.solde += bonusAAA;
            
            // √âcriture comptable
            enregistrerEcriture({
                joueurId, 
                libelle: `Bonus AAA lancer d√© (+${bonusAAA}#)`,
                compteDebit: 580,   // Caisse Pot AAA
                compteCredit: 135,  // Fonds Pot AAA (cr√©ation)
                montantEspoyr: bonusAAA,
                contexte: 'potAAA',
                details: { type: 'bonus_lancer_membre' }
            });
            
            await syncComptabiliteToFirebase();
            return bonusAAA;
        }
        
        // ========== SALAIRE ==========
        async function handleSalary(player, deSalaire, landingPosition) {
            const phase = gameState.phase || 1;
            const profil = player.profil || 'contributif';
            let salaire = CONFIG.salaireBase;
            let salaireAvantErosion = 0;
            let complementAAA = 0;
            
            // Pourcentage selon profil
            let pourcentage;
            if (profil === 'creatif') {
                pourcentage = SALARY_CREATIF[deSalaire] || 1;
            } else {
                pourcentage = SALARY_CONTRIBUTIF[deSalaire] || 1;  // Toujours 100%
            }
            salaire = Math.floor(salaire * pourcentage);
            salaireAvantErosion = salaire;  // Garder pour calcul compl√©ment
            
            // √ârosion phases 2 et 3
            if (phase >= 2) {
                const passagesP2 = (player.passagesDepuisPhase2 || 0) + 1;
                const facteurErosion = Math.pow(0.92, passagesP2);
                salaire = Math.floor(salaire * facteurErosion);
                
                await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/passagesDepuisPhase2`).set(passagesP2);
                
                if (phase === 3) {
                    salaire = Math.floor(salaire * 0.80);
                }
            }
            
            salaire = Math.max(100, salaire);
            
            // ========== COMPL√âMENT AAA EN # ==========
            // Si membre AAA et en Phase 2+, compensation de l'√©rosion en #
            const isMembre = COMPTABILITE.potAAA.membres?.includes(myPlayerId);
            if (isMembre && phase >= 2) {
                // Compl√©ment = perte due √† l'√©rosion
                complementAAA = Math.max(0, salaireAvantErosion - salaire);
                
                // V√©rifier que le Pot AAA a assez
                const potDisponible = COMPTABILITE.potAAA.solde || 0;
                complementAAA = Math.min(complementAAA, potDisponible);
                
                if (complementAAA > 0) {
                    // Verser le compl√©ment en #
                    initCaisseJoueur(myPlayerId);
                    COMPTABILITE.caisseJoueurs[myPlayerId].espoyr += complementAAA;
                    COMPTABILITE.potAAA.solde -= complementAAA;
                    COMPTABILITE.potAAA.circulationHash += complementAAA;
                    
                    // √âcriture comptable
                    enregistrerEcriture({
                        joueurId: myPlayerId,
                        libelle: `Compl√©ment AAA Phase ${phase}`,
                        compteDebit: 501,   // Caisse # (+)
                        compteCredit: 468,   // Subventions (produit +)
                        montantEspoyr: complementAAA,
                        contexte: 'potAAA',
                        details: { phase, salaireAvantErosion, salaireApresErosion: salaire }
                    });
                    
                    enregistrerEcriture({
                        joueurId: 'POT_AAA',
                        libelle: `Compl√©ment solidarit√© ${player.name}`,
                        compteDebit: 671,   // Charges exceptionnelles
                        compteCredit: 580,  // Caisse Pot AAA (-)
                        montantEspoyr: complementAAA,
                        contexte: 'potAAA'
                    });
                    
                    // MAJ Firebase #
                    await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`)
                        .set(COMPTABILITE.caisseJoueurs[myPlayerId].espoyr);
                }
            }
            
            // Comptabilit√© salaire ‚Ç¨
            const ecriture = await comptaSalaire(myPlayerId, salaire, deSalaire);
            
            // LOG EVENT: PAY_SALARY
            logEvent('PAY_SALARY', myPlayerId, {
                salaire,
                profil,
                pourcentage,
                deSalaire,
                phase,
                payeur: profil === 'creatif' ? 'Exportation' : '√âtat',
                complementAAA,
                isMembre
            }, ecriture?.ledgerEntryId ? [ecriture.ledgerEntryId] : []);
            
            // Mise √† jour Firebase
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/euro`).set(caisse.euro);
            
            const passages = (player.passagesDepart || 0) + 1;
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/passagesDepart`).set(passages);
            
            // Incr√©menter le compteur global de passages Ligne 1
            const totalPassages = (gameState.passagesLigne1Total || 0) + 1;
            await gameRef.child('state/passagesLigne1Total').set(totalPassages);
            
            // ========== INT√âR√äTS + REMBOURSEMENT AU PASSAGE LIGNE 1 ==========
            // Variables pour le r√©capitulatif modale
            let interetPaye = 0, interetCapitalise = 0, interetTotal = 0;
            let remboursementEffectue = 0;
            let detteAvant = 0, detteApres = 0;
            
            // V√©rifier emprunt dans COMPTABILITE ou dans Firebase (player)
            const empruntActuel = caisse.emprunt || player.emprunt || 0;
            detteAvant = empruntActuel;
            
            if (empruntActuel > 0) {
                // Synchroniser emprunt dans la caisse si n√©cessaire
                if (!caisse.emprunt && player.emprunt) {
                    caisse.emprunt = player.emprunt;
                }
                
                // 1) Int√©r√™ts
                const tauxInteret = gameConfig?.tauxInteret ?? CONFIG.tauxInteret;
                interetTotal = Math.floor(empruntActuel * tauxInteret);
                if (interetTotal > 0) {
                    const resInterets = await comptaInterets(myPlayerId, interetTotal);
                    interetPaye = resInterets.montantPaye || 0;
                    interetCapitalise = resInterets.montantImpaye || 0;
                    
                    if (resInterets.montantImpaye > 0) {
                        sendSystemMessage(`üìà ${myName} : int√©r√™ts ${fmt(interetTotal)}‚Ç¨ (pay√©s: ${fmt(resInterets.montantPaye)}‚Ç¨, capitalis√©s: ${fmt(resInterets.montantImpaye)}‚Ç¨)`);
                    } else {
                        sendSystemMessage(`üìâ ${myName} : int√©r√™ts pay√©s ${fmt(interetTotal)}‚Ç¨`);
                    }
                }
                
                // 2) Remboursement automatique d'une partie du capital (ind√©pendant des int√©r√™ts)
                const pct = (gameConfig?.remboursementAutoCapitalPct ?? CONFIG.remboursementAutoCapitalPct ?? 0);
                const cible = Math.floor(caisse.emprunt * pct);
                if (cible > 0 && caisse.euro > 0) {
                    const remboursement = Math.min(cible, caisse.euro, caisse.emprunt);
                    if (remboursement > 0) {
                        remboursementEffectue = remboursement;
                        await comptaRemboursement(myPlayerId, remboursement);
                        sendSystemMessage(`üí≥ ${myName} : remboursement capital ${fmt(remboursement)}‚Ç¨ (dette: ${fmt(caisse.emprunt)}‚Ç¨)`);
                    }
                }
                
                detteApres = caisse.emprunt || 0;
                
                // Mise √† jour Firebase
                await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/euro`).set(caisse.euro);
                await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/emprunt`).set(caisse.emprunt);
            }
            
            // ========== 3. MENSUALIT√âS BIENS PERSONNELS ==========
            let mensualitesResult = { totalPaye: 0, totalImpaye: 0, details: [] };
            if (caisse.dettesPersonnelles && caisse.dettesPersonnelles.length > 0) {
                mensualitesResult = await payerMensualitesPersonnelles(myPlayerId);
                if (mensualitesResult.totalPaye > 0) {
                    sendSystemMessage(`üè† ${myName} : mensualit√©s ${fmt(mensualitesResult.totalPaye)}‚Ç¨`);
                }
                if (mensualitesResult.totalImpaye > 0) {
                    sendSystemMessage(`‚ö†Ô∏è ${myName} : mensualit√©s impay√©es ${fmt(mensualitesResult.totalImpaye)}‚Ç¨ ‚Üí arri√©r√©s`);
                }
            }
            
            // ========== 5. REMBOURSEMENT CR√âANCES AAA ==========
            const detteAAA = COMPTABILITE.potAAA?.creances?.[myPlayerId] || 0;
            let detteAAAPayee = 0;
            if (detteAAA > 0 && (caisse.espoyr || 0) >= detteAAA) {
                caisse.espoyr -= detteAAA;
                COMPTABILITE.potAAA.solde += detteAAA;
                COMPTABILITE.potAAA.creances[myPlayerId] = 0;
                detteAAAPayee = detteAAA;
                await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(caisse.espoyr);
                
                // √âcriture joueur: rembourse sa dette AAA en #
                enregistrerEcriture({
                    joueurId: myPlayerId,
                    libelle: `Remboursement cr√©ance AAA (${fmt(detteAAA)}#)`,
                    compteDebit: 44,    // Dette Coop AAA (passif -) = dette diminue
                    compteCredit: 501,  // Caisse # (actif -) = # sortent
                    montantEspoyr: detteAAA,
                    contexte: 'potAAA'
                });
                
                // √âcriture Pot AAA: re√ßoit le remboursement
                enregistrerEcriture({
                    joueurId: 'POT_AAA',
                    libelle: `Remboursement cr√©ance de ${playersData[myPlayerId]?.name || myPlayerId}`,
                    compteDebit: 580,   // Caisse Pot AAA (actif +) = # entrent
                    compteCredit: 48,   // Cr√©ances Pot AAA (actif -) = cr√©ance diminue
                    montantEspoyr: detteAAA,
                    contexte: 'potAAA'
                });
                
                sendSystemMessage(`${LOGO_AAA} ${myName} rembourse ${fmt(detteAAA)}# au Pot AAA`);
            }
            
            // ========== 6. REMBOURSEMENT DETTES ENTRE JOUEURS ==========
            let reportResult = { total: 0, rembourse: 0, restant: 0, details: [] };
            const mesDettes = (COMPTABILITE.dettesEntreJoueurs || []).filter(d => d.debiteurId === myPlayerId);
            if (mesDettes.length > 0) {
                reportResult = await rembourserDettesEntreJoueurs(myPlayerId);
            }
            
            // ========== 7. SMART CONTRACTS ==========
            let scResult = { rembourse: [], arrieres: [] };
            const mesSmartContracts = (COMPTABILITE.smartContracts || []).filter(sc => sc.debiteurId === myPlayerId && !sc.rembourse);
            if (mesSmartContracts.length > 0) {
                scResult = await rembourserSmartContracts(myPlayerId);
            }
            
            // ========== 8. ARRI√âR√âS ==========
            let arrieresResult = { avant: 0, paye: 0, apres: 0 };
            if ((caisse.impaye || 0) > 0) {
                arrieresResult = await payerArrieres(myPlayerId);
            }
            
            await syncComptabiliteToFirebase();
            
            const profilIcon = profil === 'creatif' ? 'üé®' : 'üèõÔ∏è';
            const payeur = profil === 'creatif' ? 'Exportation' : '√âtat';
            
            // Message syst√®me avec compl√©ment AAA
            if (complementAAA > 0) {
                sendSystemMessage(`üí∞ ${myName} ${profilIcon} re√ßoit ${fmt(salaire)}‚Ç¨ + ${LOGO_AAA}${fmt(complementAAA)}# (compl√©ment AAA)`);
            } else {
                sendSystemMessage(`üí∞ ${myName} ${profilIcon} re√ßoit ${fmt(salaire)}‚Ç¨ (${payeur})`);
            }
            
            // V√©rifier phase
            await checkPhaseTransition();
            
            // Soldes finaux pour le r√©capitulatif
            const soldeFinalEuro = caisse.euro || 0;
            const soldeFinalHash = caisse.espoyr || 0;
            
            // ========== MODALE R√âCAPITULATIF PASSAGE LIGNE 1 ==========
            let modalHtml = `<h3>üìã Passage Ligne 1</h3>`;
            
            // --- Salaire ---
            modalHtml += `
                <div style="background: #dcfce7; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${profilIcon} <strong>Salaire</strong> (${payeur})</span>
                        <span style="font-size: 1.2rem; font-weight: bold; color: #059669;">+${fmt(salaire)}‚Ç¨</span>
                    </div>
                    <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6b7280;">
                        ${profil === 'creatif' ? `D√© ${deSalaire} = ${Math.round(pourcentage * 100)}%` : 'Salaire fixe'}
                    </p>
                </div>`;
            
            // --- √ârosion ---
            if (phase >= 2) {
                modalHtml += `
                    <div style="background: #fef3c7; padding: 8px; border-radius: 8px; margin-bottom: 8px;">
                        <span style="color: #b45309;">‚ö†Ô∏è Phase ${phase} : √©rosion ${fmt(salaireAvantErosion)}‚Ç¨ ‚Üí ${fmt(salaire)}‚Ç¨</span>
                    </div>`;
            }
            
            // --- Dette banque : int√©r√™ts + remboursement ---
            if (detteAvant > 0) {
                modalHtml += `
                    <div style="background: #fee2e2; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                        <p style="margin: 0; font-weight: bold; color: #dc2626;">üè¶ Dette Banque : ${fmt(detteAvant)}‚Ç¨</p>`;
                
                if (interetTotal > 0) {
                    modalHtml += `
                        <div style="display: flex; justify-content: space-between; margin-top: 6px;">
                            <span style="font-size: 0.9rem;">üìà Int√©r√™ts</span>
                            <span style="color: #dc2626; font-weight: 600;">-${fmt(interetPaye)}‚Ç¨</span>
                        </div>`;
                    if (interetCapitalise > 0) {
                        modalHtml += `
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-size: 0.85rem; color: #b45309;">‚ö†Ô∏è Capitalis√©s (ajout√©s √† la dette)</span>
                                <span style="color: #b45309; font-weight: 600;">+${fmt(interetCapitalise)}‚Ç¨</span>
                            </div>`;
                    }
                }
                
                if (remboursementEffectue > 0) {
                    modalHtml += `
                        <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                            <span style="font-size: 0.9rem;">üí≥ Remboursement 10%</span>
                            <span style="color: #dc2626; font-weight: 600;">-${fmt(remboursementEffectue)}‚Ç¨</span>
                        </div>`;
                }
                
                modalHtml += `
                        <div style="display: flex; justify-content: space-between; margin-top: 6px; padding-top: 6px; border-top: 1px solid #fca5a5;">
                            <span style="font-size: 0.9rem; font-weight: bold;">Dette restante</span>
                            <span style="font-weight: bold;">${fmt(detteApres)}‚Ç¨</span>
                        </div>
                    </div>`;
            }
            
            // --- Dette AAA ---
            if (detteAAA > 0) {
                const aAssez = detteAAAPayee > 0;
                modalHtml += `
                    <div style="background: ${aAssez ? '#d1fae5' : '#fef3c7'}; padding: 8px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>${LOGO_AAA} Cr√©dit AAA (pr√™t relance)</span>
                            <span style="font-weight: 600;">${aAssez ? '‚úÖ Rembours√© -'+fmt(detteAAAPayee)+'#' : '‚è≥ '+fmt(detteAAA)+'# (pas assez de #)'}</span>
                        </div>
                        <p style="margin: 2px 0 0 0; font-size: 0.8rem; color: #6b7280;">Sans int√©r√™ts (0%)</p>
                    </div>`;
            }
            
            // --- Compl√©ment AAA ---
            if (complementAAA > 0) {
                modalHtml += `
                    <div style="background: #dcfce7; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #86efac;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: bold; color: #059669;">${LOGO_AAA} Compl√©ment AAA</span>
                            <span style="font-weight: bold; color: #059669;">+${fmt(complementAAA)}#</span>
                        </div>
                        <p style="margin: 2px 0 0 0; font-size: 0.8rem; color: #6b7280;">Solidarit√© : compensation de l'√©rosion</p>
                    </div>`;
            }
            if (isMembre && phase >= 2 && complementAAA === 0) {
                modalHtml += `<p style="color: #dc2626; font-size: 0.85rem;">‚ö†Ô∏è Pot AAA vide - pas de compl√©ment</p>`;
            }
            
            // --- 3. Mensualit√©s biens personnels ---
            if (mensualitesResult.totalPaye > 0 || mensualitesResult.totalImpaye > 0) {
                modalHtml += `
                    <div style="background: #fef3c7; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                        <p style="margin: 0; font-weight: bold; color: #92400e;">üè† Mensualit√©s biens personnels</p>`;
                
                for (const d of mensualitesResult.details) {
                    modalHtml += `
                        <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                            <span style="font-size: 0.9rem;">${d.paye ? '‚úÖ' : '‚ùå'} ${d.icon} ${d.nom}</span>
                            <span style="font-weight: 600; color: ${d.paye ? '#dc2626' : '#b45309'};">-${fmt(d.montant)}‚Ç¨ ${d.paye ? '' : '(arri√©r√©)'}</span>
                        </div>`;
                    if (d.paye && d.restant > 0) {
                        modalHtml += `<p style="margin:0;font-size:0.75rem;color:#6b7280;text-align:right;">Reste: ${fmt(d.restant)}‚Ç¨</p>`;
                    }
                }
                modalHtml += `</div>`;
            }
            
            // --- 6. Dettes entre joueurs ---
            if (reportResult.total > 0) {
                modalHtml += `
                    <div style="background: #e0e7ff; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                        <p style="margin: 0; font-weight: bold; color: #3730a3;">üìú Dettes entre joueurs</p>`;
                
                for (const d of reportResult.details) {
                    modalHtml += `
                        <div style="display: flex; justify-content: space-between; margin-top: 4px;">
                            <span style="font-size: 0.9rem;">${d.paye ? '‚úÖ' : '‚è≥'} ${d.caseName} ‚Üí ${d.createurName}</span>
                            <span style="font-weight: 600; color: ${d.paye ? '#dc2626' : '#b45309'};">${d.paye ? '-' : ''}${fmt(d.montant)}‚Ç¨</span>
                        </div>`;
                }
                
                if (reportResult.restant > 0) {
                    modalHtml += `<p style="margin: 6px 0 0 0; font-size: 0.85rem; color: #dc2626;">‚ö†Ô∏è ${fmt(reportResult.restant)}‚Ç¨ non rembours√©</p>`;
                }
                modalHtml += `</div>`;
            }
            
            // --- 7. Smart Contracts ---
            if (scResult.rembourse.length > 0 || scResult.arrieres.length > 0) {
                modalHtml += `
                    <div style="background: #ede9fe; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                        <p style="margin: 0; font-weight: bold; color: #5b21b6;">üìú Smart Contracts</p>`;
                
                for (const sc of scResult.rembourse) {
                    modalHtml += `<div style="display:flex;justify-content:space-between;margin-top:4px;">
                        <span style="font-size:0.9rem;">‚úÖ ‚Üí ${sc.creancierName}</span>
                        <span style="color:#dc2626;font-weight:600;">${sc.euro > 0 ? '-'+fmt(sc.euro)+'‚Ç¨' : ''}${sc.hash > 0 ? ' -'+fmt(sc.hash)+'#' : ''}</span>
                    </div>`;
                }
                for (const sc of scResult.arrieres) {
                    modalHtml += `<div style="display:flex;justify-content:space-between;margin-top:4px;">
                        <span style="font-size:0.9rem;">‚ùå ‚Üí ${sc.creancierName} (arri√©r√©)</span>
                        <span style="color:#b45309;font-weight:600;">${sc.euro > 0 ? fmt(sc.euro)+'‚Ç¨' : ''}${sc.hash > 0 ? ' '+fmt(sc.hash)+'#' : ''}</span>
                    </div>`;
                }
                modalHtml += `</div>`;
            }
            
            // --- 8. Arri√©r√©s ---
            if (arrieresResult.avant > 0) {
                modalHtml += `
                    <div style="background: #fee2e2; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #fca5a5;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: bold; color: #dc2626;">‚ö†Ô∏è Arri√©r√©s</span>
                            <span style="font-weight: 600;">
                                ${arrieresResult.paye > 0 ? '-'+fmt(arrieresResult.paye)+'‚Ç¨ pay√©' : ''}
                                ${arrieresResult.apres > 0 ? ' (reste: '+fmt(arrieresResult.apres)+'‚Ç¨)' : ' ‚úÖ sold√©'}
                            </span>
                        </div>
                    </div>`;
            }
            
            // --- Solde final ---
            modalHtml += `
                <div style="background: #f3f4f6; padding: 10px; border-radius: 8px; margin-top: 10px; border: 2px solid #d1d5db;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: bold;">üí∞ Solde</span>
                        <span style="font-size: 1.1rem; font-weight: bold; color: ${soldeFinalEuro >= 0 ? '#059669' : '#dc2626'};">
                            ${fmt(soldeFinalEuro)}‚Ç¨ / ${fmt(soldeFinalHash)}#
                        </span>
                    </div>
                </div>`;
            
            showModal(modalHtml, `<button class="btn btn-primary" onclick="closeModal(); ${landingPosition !== undefined ? 'handleLanding(' + landingPosition + ')' : ''}">‚úÖ OK</button>`);
        }
        
        // ========== PHASES ==========
        async function checkPhaseTransition() {
            const players = getOrderedPlayers();
            const phase = gameState.phase || 1;
            const passagesTotal = gameState.passagesLigne1Total || 0;
            
            const activitesSnap = await gameRef.child('activites').once('value');
            const activites = activitesSnap.val() || {};
            const proprietaires = new Set(Object.values(activites));
            const tauxEmploi = Math.round((proprietaires.size / players.length) * 100);
            
            const detteTotale = Object.values(COMPTABILITE.caisseJoueurs).reduce((s, c) => s + (c.emprunt || 0), 0);
            
            // Seuils configurables (bas√©s sur les passages Ligne 1)
            const seuilPhase2 = gameConfig?.phase2_passagesMin ?? CONFIG.phase2_passagesMin;
            const seuilPhase3Passages = gameConfig?.phase3_passagesMin ?? CONFIG.phase3_passagesMin;
            const seuilPhase3Emploi = gameConfig?.phase3_tauxEmploiMin ?? CONFIG.phase3_tauxEmploiMin;
            const seuilPhase3Dette = gameConfig?.phase3_detteMax ?? CONFIG.phase3_detteMax;
            
            if (phase === 1 && passagesTotal >= seuilPhase2) {
                await gameRef.child('state/phase').set(2);
                sendSystemMessage(`üìä PHASE 2 ! L'√©rosion commence... (${passagesTotal} passages Ligne 1)`);
            } else if (phase === 2 && (tauxEmploi < seuilPhase3Emploi || detteTotale > seuilPhase3Dette || passagesTotal >= seuilPhase3Passages)) {
                await gameRef.child('state/phase').set(3);
                sendSystemMessage(`üåç PHASE 3 ! Effondrement...`);
            }
        }
        
        // ========== ARRIV√âE SUR CASE ==========
        async function handleLanding(position) {
            const c = CASES[position];
            // Utiliser la caisse comptable OU le solde Firebase comme fallback
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const player = playersData[myPlayerId] || {};
            const currentEuro = caisse.euro || player.euro || 0;
            const currentEspoyr = caisse.espoyr || player.espoyr || 0;
            
            if (c.type === 'activite') {
                const activitesSnap = await gameRef.child('activites').once('value');
                const activites = activitesSnap.val() || {};
                const owner = activites[position];
                
                if (!owner) {
                    showBuyModal(c, currentEuro);
                } else if (owner !== myPlayerId) {
                    showPayOrNegotiateModal(c, owner, currentEuro);
                } else {
                    // Ma propri√©t√© - √©quipement ?
                    const act = COMPTABILITE.caisseActivites?.[position] || {};
                    const nbA = act.equipementA || 0;
                    const nbB = act.equipementB || 0;
                    const totalEquip = nbA + nbB;
                    const eqList = [...Array(nbA).fill('A'), ...Array(nbB).fill('B')];
                    const minCout = getPrixB(position);
                    
                    if (totalEquip < 3 && currentEuro >= minCout) {
                        showEquipModal(c, totalEquip, currentEuro);
                    } else {
                        sendSystemMessage(`${myName} est sur son ${c.icon}`);
                        nextTurn();
                    }
                }
            } else if (c.type === 'chance') {
                await handleChance();
            } else if (c.type === 'malchance') {
                await handleMalchance();
            } else if (c.type === 'frais') {
                await handleFrais(c);
            } else if (c.type === 'taxe') {
                await handleTaxe();
            } else if (c.type === 'ligne2') {
                await handleLigne2(c);
            } else {
                nextTurn();
            }
        }
        
        // ========== ACHAT ACTIVIT√â ==========
        function showBuyModal(c, currentEuro) {
            const canBuy = currentEuro >= c.prix;
            const bonusHash = Math.floor(c.prix * 0.1);
            const profil = playersData[myPlayerId]?.profil || 'contributif';
            
            // ========== √âTAPE 5a : Facture d√©taill√©e ==========
            const facture = calculerFacture('activite_libre', c.prix);
            const nbJoueurs = Object.keys(playersData).length || 1;
            const partHorsCircuit = facture.ht;
            const partParJoueur = 0; // Redistribution supprim√©e
            
            // G√©n√©rer le HTML de la facture
            const factureHTML = genererHTMLFacture(facture, `Achat ${c.name}`);
            
            showModal(`
                <div id="modalTimer" style="text-align: center; margin-bottom: 10px;"></div>
                <h3>${c.icon} ${c.name}</h3>
                <p>Activit√© disponible !</p>
                
                ${factureHTML}
                
                <div style="background: #f0fdf4; padding: 8px; border-radius: 6px; margin: 10px 0; font-size: 0.85rem;">
                    <p style="margin: 0; font-weight: bold;">R√©partition :</p>
                    <p style="margin: 4px 0 0 0;">üèõÔ∏è √âtat : ${facture.destinationEtat.toFixed(2)}‚Ç¨ (TVA + Droits)</p>
                    <p style="margin: 2px 0 0 0;">üåç Export : ${facture.destinationExport.toFixed(2)}‚Ç¨ (TVA + Droits)</p>
                    <p style="margin: 2px 0 0 0;">üõ∞Ô∏è Hors circuit : ${partHorsCircuit.toFixed(2)}‚Ç¨ (√©conomie sp√©culative / importation)</p>
                </div>
                
                <p><strong>Facture/passage :</strong> ${fmt(calculerFactureActivite(c.id, []))}‚Ç¨ <span style="font-size:0.8rem; color:#6b7280;">(5% de ${fmt(c.prix)}‚Ç¨)</span></p>
                <hr style="margin: 10px 0;">
                <p>Tu as : <strong>${fmt(currentEuro)}‚Ç¨</strong></p>
                ${!canBuy ? '<p style="color: #ef4444;">‚ùå Pas assez</p>' : ''}
            `, `
                ${canBuy ? `<button class="btn btn-primary" onclick="buyActivity(${c.id}, ${c.prix})">üõí Acheter ${c.prix}‚Ç¨</button>` : ''}
                <button class="btn btn-secondary" onclick="passerTour()">‚è≠Ô∏è Passer</button>
            `);
            
            // D√©marrer le timer
            startDecisionTimer(gameConfig.timingDecision, () => {
                // Timeout : passer automatiquement
                sendSystemMessage(`‚è±Ô∏è Temps √©coul√© - ${myName} passe automatiquement`);
                passerTour();
            });
        }
        
        // Fonction pour passer son tour proprement
        async function passerTour() {
            stopDecisionTimer();
            closeModal();
            console.log('passerTour appel√© - nextTurn...');
            try {
                await nextTurn();
                console.log('nextTurn termin√©');
            } catch (e) {
                console.error('Erreur nextTurn:', e);
            }
        }
        
        async function buyActivity(caseId, prix) {
            stopDecisionTimer();
            closeModal();
            const c = CASES[caseId];
            const profil = playersData[myPlayerId]?.profil || 'contributif';
            
            // Comptabilit√© (avec r√©partition)
            const result = await comptaAchatActivite(myPlayerId, caseId, prix);
            
            // LOG EVENT: BUY_ACTIVITY
            logEvent('BUY_ACTIVITY', myPlayerId, {
                caseId,
                actName: c.name,
                prix,
                bonusEspoyr: Math.floor(prix * 0.1),
                partEtat: result.partEtat,
                partExport: result.partExport,
                partRedistrib: result.partRedistrib,
                partParJoueur: result.partParJoueur,
                partHorsCircuit: result.partHorsCircuit,
                profil
            }, result.ledgerEntryIds || []);
            
            // Firebase - mettre √† jour tous les joueurs (redistribution)
            for (const p of Object.values(playersData)) {
                const caisse = COMPTABILITE.caisseJoueurs[p.id];
                if (caisse) {
                    await db.ref(`parties/${currentGameCode}/players/${p.id}/euro`).set(caisse.euro);
                    await db.ref(`parties/${currentGameCode}/players/${p.id}/espoyr`).set(caisse.espoyr || 0);
                }
            }
            await gameRef.child(`activites/${caseId}`).set(myPlayerId);
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üè™ ${myName} ach√®te ${c.icon} (-${fmt(prix)}‚Ç¨) ‚Üí üõ∞Ô∏è hors circuit ${fmt(result.partHorsCircuit || 0)}‚Ç¨`);
            
            // V√©rifier si on peut √©quiper imm√©diatement
            const currentEuro = COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0;
            if (currentEuro >= getPrixB(caseId)) {
                // Proposer d'√©quiper imm√©diatement
                showEquipAfterBuyModal(c, currentEuro, profil);
            } else {
                // Pas assez pour √©quiper - message normal
                showProfilMessageModal(profil, c.name);
            }
        }
        
        // Modal pour √©quiper imm√©diatement apr√®s achat
        function showEquipAfterBuyModal(c, currentEuro, profil) {
            const phase = gameState?.phase || 1;
            const equipList = []; // Vient d'√™tre achet√©, 0 √©quipements
            
            const checkA = peutAcheterA(c.id, equipList, myPlayerId);
            const checkB = peutAcheterB(c.id, equipList, myPlayerId);
            
            const coutA = checkA.ok ? checkA.cout : getPrixA(c.id);
            const bonusA = getBonusHash(c.id, 'A_FIRST');
            const coutB = getPrixB(c.id);
            
            let buttonsHtml = '';
            
            // Bouton A ‚Äî toujours visible
            if (checkA.ok) {
                buttonsHtml += `<button class="btn" style="background:#dcfce7; color:#059669; width:100%; padding:12px; margin-bottom:6px; text-align:left; border-radius:8px;" 
                    onclick="buyEquipementA(${c.id})">
                    <strong>üåø A √âcolo ‚Äî ${fmt(coutA)}‚Ç¨</strong><br>
                    <span style="font-size:0.85rem;">‚ú® +${fmt(bonusA)}# du pot AAA</span>
                </button>`;
            } else {
                buttonsHtml += `<div style="background:#f3f4f6; padding:12px; border-radius:8px; margin-bottom:6px; opacity:0.6;">
                    <strong>üåø A √âcolo ‚Äî ${fmt(coutA)}‚Ç¨</strong><br>
                    <span style="font-size:0.85rem; color:#dc2626;">‚ùå ${checkA.raison}</span>
                </div>`;
            }
            
            // Bouton B
            if (checkB.ok) {
                buttonsHtml += `<button class="btn" style="background:#fee2e2; color:#dc2626; width:100%; padding:12px; margin-bottom:6px; text-align:left; border-radius:8px;" 
                    onclick="buyEquipementB(${c.id})">
                    <strong>‚ùÑÔ∏è B Classique ‚Äî ${fmt(coutB)}‚Ç¨</strong><br>
                    <span style="font-size:0.85rem;">Pas de bonus #</span>
                </button>`;
            } else {
                buttonsHtml += `<div style="background:#f3f4f6; padding:12px; border-radius:8px; margin-bottom:6px; opacity:0.6;">
                    <strong>‚ùÑÔ∏è B Classique ‚Äî ${fmt(coutB)}‚Ç¨</strong><br>
                    <span style="font-size:0.85rem; color:#dc2626;">‚ùå ${checkB.raison}</span>
                </div>`;
            }
            
            showModal(`
                <div id="modalTimer" style="text-align: center; margin-bottom: 10px;"></div>
                <h3>‚úÖ ${c.icon} ${c.name} achet√© !</h3>
                <p style="margin-bottom: 10px;">Tu as <strong>${fmt(currentEuro)}‚Ç¨</strong> restants.</p>
                
                <div style="background: #f0fdf4; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <p style="margin: 0; font-weight: bold; color: #059669;">
                        üí° Tu peux √©quiper imm√©diatement !
                    </p>
                </div>
                
                ${buttonsHtml}
            `, `
                <button class="btn" style="background:#fef3c7;color:#b45309;" onclick="closeModal(); showQuickEmprunter();">üí∞ Emprunter</button>
                <button class="btn btn-primary" onclick="safeNextTurn();">Suivant ‚û°Ô∏è</button>
            `);
            
            startDecisionTimer(gameConfig.timingDecision, () => {
                sendSystemMessage(`‚è±Ô∏è Temps √©coul√© - ${myName} passe automatiquement`);
                safeNextTurn();
            });
        }
        
        // Message apr√®s achat selon profil (sans possibilit√© d'√©quiper - pas assez d'argent)
        function showProfilMessageModal(profil, activiteName) {
            if (profil === 'creatif') {
                showModal(`
                    <div id="modalTimer" style="text-align: center; margin-bottom: 10px;"></div>
                    <h3>üé® F√©licitations !</h3>
                    <p style="font-size: 0.95rem; line-height: 1.5;">
                        Tu n'ach√®tes pas un capital. <strong>Tu acceptes une responsabilit√©.</strong>
                    </p>
                    <p style="font-size: 0.9rem; line-height: 1.5;">
                        Ta richesse viendra de ton travail, de tes choix de gestion 
                        et de ta contribution aux objectifs AAA.
                    </p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">
                        Nous esp√©rons que tu comprendras que ces valeurs sont importantes :
                    </p>
                    <ul style="font-size: 0.85rem; color: #059669; margin: 8px 0;">
                        <li>Am√©liorer le bien-√™tre humain</li>
                        <li>Adopter des pratiques durables</li>
                        <li>Anticiper les impacts environnementaux</li>
                    </ul>
                `, `
                    <button class="btn" style="background:#fef3c7;color:#b45309;" onclick="closeModal(); showQuickEmprunter();">üí∞ Emprunter</button>
                    <button class="btn btn-primary" onclick="safeNextTurn();">Suivant ‚û°Ô∏è</button>
                `);
            } else {
                showModal(`
                    <div id="modalTimer" style="text-align: center; margin-bottom: 10px;"></div>
                    <h3>üèõÔ∏è Bienvenue dans l'√©quipe !</h3>
                    <p style="font-size: 0.95rem; line-height: 1.5;">
                        Ici, ton r√¥le n'est pas de poss√©der, mais de <strong>contribuer</strong>.
                    </p>
                    <p style="font-size: 0.9rem; line-height: 1.5;">
                        Chaque comp√©tence compte. Chaque action a un impact.
                    </p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">
                        Forme-toi pour :
                    </p>
                    <ul style="font-size: 0.85rem; color: #2563eb; margin: 8px 0;">
                        <li>Am√©liorer le bien-√™tre humain</li>
                        <li>Renforcer des pratiques durables</li>
                        <li>Pr√©server l'avenir collectif</li>
                    </ul>
                `, `
                    <button class="btn" style="background:#fef3c7;color:#b45309;" onclick="closeModal(); showQuickEmprunter();">üí∞ Emprunter</button>
                    <button class="btn btn-primary" onclick="safeNextTurn();">Suivant ‚û°Ô∏è</button>
                `);
            }
            
            // Timer de d√©cision
            startDecisionTimer(gameConfig.timingDecision, () => {
                sendSystemMessage(`‚è±Ô∏è Temps √©coul√© - ${myName} passe automatiquement`);
                safeNextTurn();
            });
        }
        
        // Wrapper pour appeler nextTurn de fa√ßon s√ªre
        async function safeNextTurn() {
            stopDecisionTimer();  // Arr√™ter le timer quand on passe
            closeModal();
            try {
                await nextTurn();
            } catch (err) {
                console.error('Erreur nextTurn:', err);
                nextTurnInProgress = false;  // Reset en cas d'erreur
            }
        }
        
        // ========== TERMINOLOGIE √âQUIPEMENT/FORMATION ==========
        // Contributif = Formation (investissement dans les personnes)
        // Cr√©atif = √âquipement (investissement dans les outils)
        function getEquipmentTerms(profil) {
            if (profil === 'contributif') {
                return {
                    term: 'Formation',
                    termPlural: 'Formations',
                    typeA: 'Formation durabilit√©',
                    typeAShort: 'Formation A',
                    typeB: 'Formation basique',
                    typeBShort: 'Formation B',
                    iconA: 'üìó',
                    iconB: 'üìò',
                    descA: 'Apprentissage approfondi (√©conomie durable)',
                    descB: 'Apprentissage standard',
                    resultText: '2 formations = facture √ó2'
                };
            } else {
                return {
                    term: '√âquipement',
                    termPlural: '√âquipements',
                    typeA: '√âquipement durable',
                    typeAShort: '√âquipement A',
                    typeB: '√âquipement classique',
                    typeBShort: '√âquipement B',
                    iconA: 'üåø',
                    iconB: '‚ö°',
                    descA: 'Investissement durable',
                    descB: 'Investissement classique',
                    resultText: '2 √©quipements = facture √ó2'
                };
            }
        }
        
        // ========== √âQUIPEMENT / FORMATION ==========
        function showEquipModal(c, nbEquip, currentEuro) {
            const profil = playersData[myPlayerId]?.profil || 'contributif';
            const terms = getEquipmentTerms(profil);
            const phase = gameState?.phase || 1;
            
            // V√©rifier si on a d√©j√† √©quip√© cette case ce tour complet
            const tourActuel = gameState?.toursComplets || 0;
            const dernierEquipTour = equipementsCeTour[c.id];
            const dejaEquipeCeTour = (dernierEquipTour === tourActuel);
            
            if (dejaEquipeCeTour) {
                showModal(`
                    <h3>${c.icon} ${c.name}</h3>
                    <p>‚ö†Ô∏è Tu as d√©j√† √©quip√© cette activit√© ce tour.</p>
                `, `<button class="btn btn-primary" onclick="passerTour()">Continuer ‚û°Ô∏è</button>`);
                return;
            }
            
            // R√©cup√©rer les types d'√©quipements
            const act = COMPTABILITE.caisseActivites?.[c.id] || {};
            const nbA = act.equipementA || 0;
            const nbB = act.equipementB || 0;
            const equipList = [...Array(nbA).fill('A'), ...Array(nbB).fill('B')];
            const total = nbA + nbB;
            const factureActuelle = calculerFactureActivite(c.id, equipList);
            
            // V√©rifications
            const checkA = peutAcheterA(c.id, equipList, myPlayerId);
            const checkB = peutAcheterB(c.id, equipList, myPlayerId);
            const checkConv = peutConvertirBtoA(c.id, equipList, myPlayerId);
            
            // Afficher l'√©tat actuel
            const equipDisplay = total === 0 ? 'Aucun' : equipList.join('');
            
            let buttonsHtml = '';
            
            // Bouton A ‚Äî toujours visible
            const coutA = checkA.ok ? checkA.cout : getCoutEquipement(c.id, 'A', nbA);
            const bonusA = nbA === 0 ? getBonusHash(c.id, 'A_FIRST') : getBonusHash(c.id, 'A_ADDITIONAL');
            if (checkA.ok) {
                buttonsHtml += `<button class="btn" style="background:#dcfce7; color:#059669; width:100%; padding:12px; margin-bottom:6px; text-align:left; border-radius:8px;" 
                    onclick="buyEquipementA(${c.id})">
                    <strong>üåø A √âcolo ‚Äî ${fmt(coutA)}‚Ç¨</strong><br>
                    <span style="font-size:0.85rem;">‚ú® +${fmt(bonusA)}# du pot AAA</span>
                </button>`;
            } else {
                buttonsHtml += `<div style="background:#f3f4f6; padding:12px; border-radius:8px; margin-bottom:6px; opacity:0.6;">
                    <strong>üåø A √âcolo ‚Äî ${fmt(coutA)}‚Ç¨</strong><br>
                    <span style="font-size:0.85rem; color:#dc2626;">‚ùå ${checkA.raison}</span>
                </div>`;
            }
            
            // Bouton conversion B‚ÜíA
            if (nbB > 0) {
                const coutConv = getDifferenceAB(c.id);
                const bonusConv = getBonusHash(c.id, 'B_TO_A');
                if (checkConv.ok) {
                    buttonsHtml += `<button class="btn" style="background:#fef3c7; color:#92400e; width:100%; padding:12px; margin-bottom:6px; text-align:left; border-radius:8px;" 
                        onclick="convertirBtoA(${c.id})">
                        <strong>üîÑ Convertir B‚ÜíA ‚Äî ${fmt(coutConv)}‚Ç¨</strong><br>
                        <span style="font-size:0.85rem;">‚ú® +${fmt(bonusConv)}# (50%)</span>
                    </button>`;
                } else {
                    buttonsHtml += `<div style="background:#f3f4f6; padding:12px; border-radius:8px; margin-bottom:6px; opacity:0.6;">
                        <strong>üîÑ Convertir B‚ÜíA ‚Äî ${fmt(coutConv)}‚Ç¨</strong><br>
                        <span style="font-size:0.85rem; color:#dc2626;">‚ùå ${checkConv.raison}</span>
                    </div>`;
                }
            }
            
            // Bouton B
            const coutB = getPrixB(c.id);
            if (checkB.ok) {
                buttonsHtml += `<button class="btn" style="background:#fee2e2; color:#dc2626; width:100%; padding:12px; margin-bottom:6px; text-align:left; border-radius:8px;" 
                    onclick="buyEquipementB(${c.id})">
                    <strong>‚ùÑÔ∏è B Classique ‚Äî ${fmt(coutB)}‚Ç¨</strong><br>
                    <span style="font-size:0.85rem;">Pas de bonus #</span>
                </button>`;
            } else {
                buttonsHtml += `<div style="background:#f3f4f6; padding:12px; border-radius:8px; margin-bottom:6px; opacity:0.6;">
                    <strong>‚ùÑÔ∏è B Classique ‚Äî ${fmt(coutB)}‚Ç¨</strong><br>
                    <span style="font-size:0.85rem; color:#dc2626;">‚ùå ${checkB.raison}</span>
                </div>`;
            }
            
            showModal(`
                <div id="modalTimer" style="text-align: center; margin-bottom: 10px;"></div>
                <h3>${c.icon} ${c.name} - Ta propri√©t√©</h3>
                <p><strong>√âquipements :</strong> ${equipDisplay} (${total}/3 max)</p>
                <p><strong>Facture actuelle :</strong> ${fmt(factureActuelle)}‚Ç¨ <span style="font-size:0.8rem; color:#6b7280;">(5% de ${fmt(Math.floor(factureActuelle / 0.05))}‚Ç¨ investi)</span></p>
                <p>Tu as : <strong>${fmt(currentEuro)}‚Ç¨</strong></p>
                <hr style="margin: 10px 0;">
                ${buttonsHtml}
            `, `
                <button class="btn" style="background:#fef3c7;color:#b45309;" onclick="closeModal(); showQuickEmprunter();">üí∞ Emprunter</button>
                <button class="btn btn-secondary" onclick="passerTour()">‚è≠Ô∏è Passer</button>
            `);
            
            // Timer de d√©cision
            startDecisionTimer(gameConfig.timingDecision, () => {
                sendSystemMessage(`‚è±Ô∏è Temps √©coul√© - ${myName} passe automatiquement`);
                passerTour();
            });
        }
        
        async function buyEquipementA(caseId) {
            stopDecisionTimer();
            closeModal();
            const c = CASES[caseId];
            
            const tourActuel = gameState?.toursComplets || 0;
            equipementsCeTour[caseId] = tourActuel;
            
            const result = await comptaAchatEquipementA(myPlayerId, caseId);
            
            logEvent('BUY_EQUIPMENT_A', myPlayerId, {
                caseId, actName: c.name, cout: result.cout, bonusHash: result.bonusHash
            }, result.ledgerEntryIds || []);
            
            // Firebase
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, espoyr: caisse.espoyr
            });
            
            // Mettre √† jour √©quipements dans Firebase
            const act = COMPTABILITE.caisseActivites[caseId] || {};
            const nbA = act.equipementA || 0;
            const nbB = act.equipementB || 0;
            const equipTypes = [...Array(nbA).fill('A'), ...Array(nbB).fill('B')];
            await gameRef.child(`equipements/${caseId}`).set(nbA + nbB);
            await gameRef.child(`equipementTypes/${caseId}`).set(equipTypes);
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üåø ${myName} ach√®te √©quipement A sur ${c.icon} ${c.name} (${fmt(result.cout)}‚Ç¨) +${fmt(result.bonusHash)}#`);
            nextTurn();
        }
        
        async function buyEquipementB(caseId) {
            stopDecisionTimer();
            closeModal();
            const c = CASES[caseId];
            
            const tourActuel = gameState?.toursComplets || 0;
            equipementsCeTour[caseId] = tourActuel;
            
            const result = await comptaAchatEquipementB(myPlayerId, caseId);
            
            logEvent('BUY_EQUIPMENT_B', myPlayerId, {
                caseId, actName: c.name, cout: result.cout
            }, result.ledgerEntryIds || []);
            
            // Firebase
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, espoyr: caisse.espoyr
            });
            
            const act = COMPTABILITE.caisseActivites[caseId] || {};
            const nbA = act.equipementA || 0;
            const nbB = act.equipementB || 0;
            const equipTypes = [...Array(nbA).fill('A'), ...Array(nbB).fill('B')];
            await gameRef.child(`equipements/${caseId}`).set(nbA + nbB);
            await gameRef.child(`equipementTypes/${caseId}`).set(equipTypes);
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`‚ùÑÔ∏è ${myName} ach√®te √©quipement B sur ${c.icon} ${c.name} (${fmt(result.cout)}‚Ç¨)`);
            nextTurn();
        }
        
        async function convertirBtoA(caseId) {
            stopDecisionTimer();
            closeModal();
            const c = CASES[caseId];
            
            const tourActuel = gameState?.toursComplets || 0;
            equipementsCeTour[caseId] = tourActuel;
            
            const result = await comptaConversionBtoA(myPlayerId, caseId);
            
            logEvent('CONVERT_B_TO_A', myPlayerId, {
                caseId, actName: c.name, cout: result.cout, bonusHash: result.bonusHash
            }, result.ledgerEntryIds || []);
            
            // Firebase
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, espoyr: caisse.espoyr
            });
            
            const act = COMPTABILITE.caisseActivites[caseId] || {};
            const nbA = act.equipementA || 0;
            const nbB = act.equipementB || 0;
            const equipTypes = [...Array(nbA).fill('A'), ...Array(nbB).fill('B')];
            await gameRef.child(`equipements/${caseId}`).set(nbA + nbB);
            await gameRef.child(`equipementTypes/${caseId}`).set(equipTypes);
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üîÑ ${myName} convertit B‚ÜíA sur ${c.icon} ${c.name} (${fmt(result.cout)}‚Ç¨) +${fmt(result.bonusHash)}#`);
            nextTurn();
        }
        
        // Legacy fonction (gard√©e pour compatibilit√©)
        async function buyEquipement(caseId, prix) {
            closeModal();
            await comptaAchatEquipement(myPlayerId, caseId, prix);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, espoyr: caisse.espoyr
            });
            const equipSnap = await gameRef.child(`equipements/${caseId}`).once('value');
            await gameRef.child(`equipements/${caseId}`).set((equipSnap.val() || 0) + 1);
            await syncComptabiliteToFirebase();
            nextTurn();
        }
        
        // ========== VENTE D'√âQUIPEMENT AU POT AAA ==========
        
        // Comptabilit√© vente √©quipement au Pot AAA (75% en #)
        async function comptaVenteEquipementAAA(joueurId, actId) {
            initCaisseJoueur(joueurId);
            initCaisseActivite(actId);
            
            const actCompta = COMPTABILITE.caisseActivites[actId];
            const nbEquipA = actCompta.equipementA || 0;
            const nbEquipB = actCompta.equipementB || 0;
            
            // Vendre A en priorit√©, sinon B
            let prixAchat;
            let typeVendu;
            if (nbEquipA > 0) {
                prixAchat = nbEquipA === 1 ? getPrixA(actId) : getPrixB(actId);
                typeVendu = 'A';
            } else {
                prixAchat = getPrixB(actId);
                typeVendu = 'B';
            }
            const prixRachat = Math.floor(prixAchat * 0.75);
            
            COMPTABILITE.caisseJoueurs[joueurId].espoyr += prixRachat;
            COMPTABILITE.potAAA.solde -= prixRachat;
            COMPTABILITE.potAAA.circulationHash += prixRachat;
            
            COMPTABILITE.caisseActivites[actId].equipements = Math.max(0, (actCompta.equipements || 1) - 1);
            if (typeVendu === 'A') {
                COMPTABILITE.caisseActivites[actId].equipementA = nbEquipA - 1;
            } else {
                COMPTABILITE.caisseActivites[actId].equipementB = nbEquipB - 1;
            }
            
            enregistrerEcriture({
                joueurId, libelle: `Vente √©quipement ${typeVendu} au Pot AAA (75%)`,
                compteDebit: 501, compteCredit: 580, montantEspoyr: prixRachat, activiteId: actId,
                contexte: 'potAAA',
                details: { type: 'vente_equipement', typeVendu, prixRachat }
            });
            
            return { prixRachat, typeVendu };
        }
        
        // Interface vente √©quipement
        async function showVenteEquipementModal(actId) {
            const c = CASES[actId];
            const actCompta = COMPTABILITE.caisseActivites[actId] || {};
            const nbA = actCompta.equipementA || 0;
            const nbB = actCompta.equipementB || 0;
            const total = nbA + nbB;
            
            if (total === 0) {
                showModal(`<h3>‚ùå Pas d'√©quipement</h3><p>Cette activit√© n'a pas d'√©quipement √† vendre.</p>`,
                    `<button class="btn btn-secondary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            const typeVendu = nbA > 0 ? 'A' : 'B';
            const prixAchat = typeVendu === 'A' ? (nbA === 1 ? getPrixA(actId) : getPrixB(actId)) : getPrixB(actId);
            const prixRachat = Math.floor(prixAchat * 0.75);
            const equipDisplay = [...Array(nbA).fill('A'), ...Array(nbB).fill('B')].join('');
            
            showModal(`
                <h3>${LOGO_AAA} Vendre √©quipement au Pot AAA</h3>
                <p><strong>${c.icon} ${c.name}</strong> [${equipDisplay}]</p>
                <hr style="margin: 10px 0;">
                <p>Le Pot AAA rach√®te √† <strong>75%</strong> du prix d'achat</p>
                <p>√âquipement vendu : <strong>${typeVendu === 'A' ? 'üåø A' : '‚ùÑÔ∏è B'}</strong></p>
                <p style="font-size: 1.2rem; font-weight: bold; color: #059669;">
                    Tu recevras : ${prixRachat}#
                </p>
                <p style="font-size: 0.85rem; color: #6b7280;">
                    (Prix achat: ${fmt(prixAchat)}‚Ç¨ √ó 75% = ${prixRachat}#)
                </p>
            `, `
                <button class="btn btn-primary" onclick="vendreEquipementAAA(${actId})">${LOGO_AAA} Vendre ${typeVendu}</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            `);
        }
        
        async function vendreEquipementAAA(actId) {
            closeModal();
            const c = CASES[actId];
            
            const result = await comptaVenteEquipementAAA(myPlayerId, actId);
            
            // Firebase
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(caisse.espoyr);
            
            const act = COMPTABILITE.caisseActivites[actId] || {};
            const types = [...Array(act.equipementA || 0).fill('A'), ...Array(act.equipementB || 0).fill('B')];
            await gameRef.child(`equipements/${actId}`).set(types.length);
            await gameRef.child(`equipementTypes/${actId}`).set(types);
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`${LOGO_AAA} ${myName} vend 1 √©quipement ${result.typeVendu} de ${c.icon} au Pot AAA (+${fmt(result.prixRachat)}#)`);
            
            showModal(`
                <h3>‚úÖ √âquipement ${result.typeVendu} vendu !</h3>
                <p>Tu as re√ßu <strong>${fmt(result.prixRachat)}#</strong> du Pot AAA.</p>
            `, `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
        }
        
        // ========== VENTE D'ACTIVIT√â AUX ENCH√àRES ==========
        
        // √âtat des ench√®res en cours
        let enchereEnCours = null;
        
        // V√©rifier si on peut vendre une activit√©
        function canSellActivity(joueurId, actId) {
            const actCompta = COMPTABILITE.caisseActivites[actId] || {};
            const nbEquip = actCompta.equipements || 0;
            
            // Compter les activit√©s du joueur
            const activitesJoueur = Object.entries(COMPTABILITE.caisseActivites)
                .filter(([id, a]) => a.proprietaireId === joueurId);
            
            // Conditions
            if (nbEquip > 0) {
                return { canSell: false, reason: "Vous devez d'abord vendre les √©quipements" };
            }
            if (activitesJoueur.length <= 1) {
                return { canSell: false, reason: "Vous ne pouvez pas vendre votre derni√®re activit√©" };
            }
            
            return { canSell: true };
        }
        
        // Interface vente activit√©
        async function showVenteActiviteModal(actId) {
            const c = CASES[actId];
            const actCompta = COMPTABILITE.caisseActivites[actId] || {};
            
            const check = canSellActivity(myPlayerId, actId);
            if (!check.canSell) {
                showModal(`
                    <h3>‚ùå Vente impossible</h3>
                    <p>${check.reason}</p>
                `, `<button class="btn btn-secondary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            const prixAchat = actCompta.capital || c.prix;
            const prixDepart = Math.floor(prixAchat * 0.5);  // 50% du prix d'achat
            
            showModal(`
                <h3>üè∑Ô∏è Vendre ${c.icon} ${c.name}</h3>
                <p><strong>Prix d'achat :</strong> ${fmt(prixAchat)}‚Ç¨</p>
                <p><strong>Prix de d√©part ench√®res :</strong> ${fmt(prixDepart)}‚Ç¨ (50%)</p>
                <hr style="margin: 10px 0;">
                <p style="font-size: 0.85rem; color: #6b7280;">
                    L'ench√®re sera ouverte √† tous les joueurs.<br>
                    Tu recevras 100% du prix final.
                </p>
            `, `
                <button class="btn btn-primary" onclick="lancerEnchere(${actId}, ${prixDepart})">üî® Lancer l'ench√®re</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            `);
        }
        
        async function lancerEnchere(actId, prixDepart) {
            closeModal();
            const c = CASES[actId];
            
            enchereEnCours = {
                actId,
                vendeurId: myPlayerId,
                vendeurName: myName,
                prixActuel: prixDepart,
                prixDepart,
                dernierEncherisseur: null,
                dernierEncherisseurName: null,
                participants: [],
                termine: false
            };
            
            // Sauvegarder en Firebase pour synchroniser
            await gameRef.child('enchere').set(enchereEnCours);
            
            sendSystemMessage(`üî® ENCH√àRES : ${myName} vend ${c.icon} ${c.name} √† partir de ${fmt(prixDepart)}‚Ç¨ !`);
            
            // Afficher le modal d'ench√®res pour tous
            showEnchereModal();
        }
        
        function showEnchereModal() {
            if (!enchereEnCours) return;
            
            const c = CASES[enchereEnCours.actId];
            const isVendeur = enchereEnCours.vendeurId === myPlayerId;
            const maCaisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const monEuro = maCaisse.euro || 0;
            const prochaineEnchere = enchereEnCours.prixActuel + 10;
            
            // ========== √âTAPE 5c : Calcul droits 6% ==========
            const droitsActuels = Math.round(enchereEnCours.prixActuel * 0.06 * 100) / 100;
            const totalActuel = enchereEnCours.prixActuel + droitsActuels;
            const droitsProchaineEnchere = Math.round(prochaineEnchere * 0.06 * 100) / 100;
            const totalProchaineEnchere = prochaineEnchere + droitsProchaineEnchere;
            
            const canEncherir = !isVendeur && monEuro >= totalProchaineEnchere;
            
            showModal(`
                <h3>üî® Ench√®res en cours</h3>
                <p><strong>${c.icon} ${c.name}</strong></p>
                <p>Vendeur : ${enchereEnCours.vendeurName}</p>
                <hr style="margin: 10px 0;">
                <p style="font-size: 1.5rem; font-weight: bold; color: #2563eb;">
                    ${enchereEnCours.prixActuel}‚Ç¨
                </p>
                <p style="font-size: 0.85rem; color: #6b7280;">
                    + ${fmt(droitsActuels)}‚Ç¨ droits (6%) = <strong>${fmt(totalActuel)}‚Ç¨</strong> total acheteur
                </p>
                ${enchereEnCours.dernierEncherisseurName ? 
                    `<p style="color: #059669;">Derni√®re ench√®re : ${enchereEnCours.dernierEncherisseurName}</p>` :
                    `<p style="color: #6b7280;">Aucune ench√®re encore</p>`
                }
                <hr style="margin: 10px 0;">
                <p>Tu as : <strong>${fmt(monEuro)}‚Ç¨</strong></p>
                ${!canEncherir && !isVendeur ? `<p style="color: #ef4444;">Il faut ${fmt(totalProchaineEnchere)}‚Ç¨ pour ench√©rir</p>` : ''}
            `, `
                ${canEncherir ? `<button class="btn btn-primary" onclick="faireEnchere(${prochaineEnchere})">üìà Ench√©rir ${fmt(prochaineEnchere)}‚Ç¨ (total: ${fmt(totalProchaineEnchere)}‚Ç¨)</button>` : ''}
                ${isVendeur && enchereEnCours.dernierEncherisseur ? 
                    `<button class="btn" style="background:#dcfce7;color:#059669;" onclick="accepterEnchere()">‚úÖ Accepter ${fmt(enchereEnCours.prixActuel)}‚Ç¨</button>` : ''
                }
                <button class="btn btn-secondary" onclick="closeModal(); passerEnchere();">Passer</button>
            `);
        }
        
        async function faireEnchere(montant) {
            closeModal();
            
            enchereEnCours.prixActuel = montant;
            enchereEnCours.dernierEncherisseur = myPlayerId;
            enchereEnCours.dernierEncherisseurName = myName;
            
            await gameRef.child('enchere').set(enchereEnCours);
            
            const c = CASES[enchereEnCours.actId];
            sendSystemMessage(`üìà ${myName} ench√©rit ${fmt(montant)}‚Ç¨ pour ${c.icon}`);
            
            // Afficher √† nouveau le modal (pour les autres joueurs via listener)
            showEnchereModal();
        }
        
        async function passerEnchere() {
            // Le joueur passe son tour d'ench√®re
            sendSystemMessage(`‚è≠Ô∏è ${myName} passe`);
        }
        
        async function accepterEnchere() {
            if (!enchereEnCours || !enchereEnCours.dernierEncherisseur) return;
            closeModal();
            
            const c = CASES[enchereEnCours.actId];
            const acheteurId = enchereEnCours.dernierEncherisseur;
            const vendeurId = enchereEnCours.vendeurId;
            const prixVente = enchereEnCours.prixActuel;  // Prix n√©goci√©
            
            // ========== √âTAPE 5c : 6% droits vente entre joueurs ==========
            const facture = calculerFacture('vente_joueur', prixVente);
            const prixTotal = facture.total;      // Prix + 6%
            const droits = facture.droits;        // 6% ‚Üí √âtat
            const ledgerEntryIds = [];
            
            // Comptabilit√© : transfert d'argent
            initCaisseJoueur(acheteurId);
            initCaisseJoueur(vendeurId);
            
            // Acheteur paie prix + droits
            COMPTABILITE.caisseJoueurs[acheteurId].euro -= prixTotal;
            
            // Vendeur re√ßoit le prix (sans les droits)
            COMPTABILITE.caisseJoueurs[vendeurId].euro += prixVente;
            
            // √âtat re√ßoit les droits
            COMPTABILITE.etat.tresor += droits;
            COMPTABILITE.etat.recettes.droits += droits;
            COMPTABILITE.etat.recettes.total += droits;
            COMPTABILITE.etat.grandLivre[500] += droits;
            COMPTABILITE.etat.grandLivre[705] += droits;
            
            // Transfert de propri√©t√©
            COMPTABILITE.caisseActivites[enchereEnCours.actId].proprietaireId = acheteurId;
            
            // √âcriture 1: Acheteur - Achat immobilisation
            let e = enregistrerEcriture({
                joueurId: acheteurId, libelle: `Achat ench√®re ${c.name}`,
                compteDebit: 200, compteCredit: 500, montantEuro: prixVente, activiteId: enchereEnCours.actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 2: Acheteur - Droits d'enregistrement
            e = enregistrerEcriture({
                joueurId: acheteurId, libelle: `Droits enregistrement ${c.name}`,
                compteDebit: 640, compteCredit: 500, montantEuro: droits, activiteId: enchereEnCours.actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 3: Vendeur - Vente immobilisation
            e = enregistrerEcriture({
                joueurId: vendeurId, libelle: `Vente ench√®re ${c.name}`,
                compteDebit: 500, compteCredit: 260, montantEuro: prixVente, activiteId: enchereEnCours.actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // √âcriture 4: √âtat - Recette droits
            e = enregistrerEcriture({
                joueurId: 'ETAT', 
                libelle: `Recette Droits vente ${c.name}`,
                compteDebit: 500, compteCredit: 705, montantEuro: droits,
                contexte: 'etat', activiteId: enchereEnCours.actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // Firebase
            await db.ref(`parties/${currentGameCode}/players/${acheteurId}/euro`).set(
                COMPTABILITE.caisseJoueurs[acheteurId].euro
            );
            await db.ref(`parties/${currentGameCode}/players/${vendeurId}/euro`).set(
                COMPTABILITE.caisseJoueurs[vendeurId].euro
            );
            await gameRef.child(`activites/${enchereEnCours.actId}`).set(acheteurId);
            await gameRef.child('enchere').remove();
            await syncComptabiliteToFirebase();
            
            const acheteurPlayer = playersData[acheteurId];
            sendSystemMessage(`üî® VENDU ! ${c.icon} ${c.name} √† ${acheteurPlayer?.name} pour ${fmt(prixVente)}‚Ç¨ (+${fmt(droits)}‚Ç¨ droits ‚Üí üèõÔ∏è)`);
            
            enchereEnCours = null;
            
            showModal(`
                <h3>‚úÖ Vente conclue !</h3>
                <p><strong>${c.icon} ${c.name}</strong> vendu pour ${fmt(prixVente)}‚Ç¨</p>
                <div style="background: #fef3c7; padding: 8px; border-radius: 6px; margin-top: 10px; font-size: 0.9rem;">
                    <p style="margin: 0;">Acheteur paie : ${fmt(prixTotal)}‚Ç¨ (${fmt(prixVente)}‚Ç¨ + ${fmt(droits)}‚Ç¨ droits)</p>
                    <p style="margin: 4px 0 0 0;">Vendeur re√ßoit : ${fmt(prixVente)}‚Ç¨</p>
                    <p style="margin: 4px 0 0 0;">üèõÔ∏è √âtat re√ßoit : ${fmt(droits)}‚Ç¨ (droits 6%)</p>
                </div>
            `, `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
        }

        // ========== FAILLITE ET INTERVENTION AAA ==========
        
        // V√©rifier si un joueur est en situation de faillite
        function checkFaillite(joueurId) {
            const caisse = COMPTABILITE.caisseJoueurs[joueurId] || {};
            const euro = caisse.euro || 0;
            const espoyr = caisse.espoyr || 0;
            const emprunt = caisse.emprunt || 0;
            
            // Calculer la limite d'emprunt
        const players = getOrderedPlayers();
            const nbJoueurs = players.length || 1;
            let masseMonetaire = 0;
            players.forEach(p => {
                const c = COMPTABILITE.caisseJoueurs[p.id] || {};
                masseMonetaire += (c.euro || 0);
            });
            const limiteEmprunt = Math.max(750, Math.floor(masseMonetaire / nbJoueurs));
            
            // Capacit√© d'emprunt restante
            const capaciteEmprunt = Math.max(0, limiteEmprunt - emprunt);
            
            // En faillite si : pas d'‚Ç¨, pas de # et ne peut plus emprunter
            const enFaillite = euro <= 0 && espoyr <= 0 && capaciteEmprunt <= 0;
            
            return {
                enFaillite,
                euro,
                espoyr,
                emprunt,
                limiteEmprunt,
                capaciteEmprunt,
                isMembre: COMPTABILITE.potAAA.membres?.includes(joueurId)
            };
        }
        
        // Comptabilit√© : R√©duction de valeur sur cr√©ance (perte attendue)
        async function comptaReductionValeur(joueurId, montant) {
            // La banque constate une perte attendue sur le pr√™t
            COMPTABILITE.banque.reductionValeur += montant;
            
            // √âcriture : D:634 (Dotation RDV) C:2919 (RDV act√©e)
            enregistrerEcriture({
                joueurId, libelle: `R√©duction de valeur cr√©ance (perte attendue)`,
                compteDebit: 634, compteCredit: 2919, montantEuro: montant,
                contexte: 'banque',
                details: { type: 'reduction_valeur' }
            });
            
            return montant;
        }
        
        // Comptabilit√© : D√©faut effectif (consommer la RDV)
        async function comptaDefautEffectif(joueurId, montant) {
            // Consommer la r√©duction de valeur sans nouvelle charge
            // D:2919 (RDV act√©e) C:291 (Pr√™ts client√®le)
            enregistrerEcriture({
                joueurId, libelle: `D√©faut effectif - annulation cr√©ance`,
                compteDebit: 2919, compteCredit: 291, montantEuro: montant,
                contexte: 'banque',
                details: { type: 'defaut_effectif' }
            });
            
            // R√©duire les cr√©ances de la banque
            COMPTABILITE.banque.creancesJoueurs = Math.max(0, COMPTABILITE.banque.creancesJoueurs - montant);
            COMPTABILITE.banque.reductionValeur = Math.max(0, COMPTABILITE.banque.reductionValeur - montant);
            
            return montant;
        }
        
        // Intervention du Pot AAA pour un membre en faillite
        async function interventionAAA(joueurId) {
            const caisse = COMPTABILITE.caisseJoueurs[joueurId] || {};
            const emprunt = caisse.emprunt || 0;
            const player = playersData[joueurId];
            
            if (!COMPTABILITE.potAAA.membres?.includes(joueurId)) {
                return { success: false, reason: "Non membre du Pot AAA" };
            }
            
            // 1. Constater la r√©duction de valeur (perte attendue)
            await comptaReductionValeur(joueurId, emprunt);
            
            // 2. D√©faut effectif - annuler la dette
            await comptaDefautEffectif(joueurId, emprunt);
            
            // 3. Annuler la dette du joueur
            COMPTABILITE.caisseJoueurs[joueurId].emprunt = 0;
            
            // √âcriture annulation dette c√¥t√© joueur
            enregistrerEcriture({
                joueurId, libelle: `Annulation dette par Pot AAA`,
                compteDebit: 110, compteCredit: 778, montantEuro: emprunt,
                details: { type: 'annulation_dette_aaa' }
            });
            
            // 4. Pr√™t de relance en # (250#)
            const pretRelance = 250;
            COMPTABILITE.caisseJoueurs[joueurId].espoyr += pretRelance;
            COMPTABILITE.potAAA.solde -= pretRelance;
            COMPTABILITE.potAAA.circulationHash += pretRelance;
            
            // Enregistrer comme cr√©ance AAA (sera rembours√© au passage Ligne 1, 0%)
            if (!COMPTABILITE.potAAA.creances) COMPTABILITE.potAAA.creances = {};
            COMPTABILITE.potAAA.creances[joueurId] = (COMPTABILITE.potAAA.creances[joueurId] || 0) + pretRelance;
            
            // √âcriture joueur: re√ßoit les # et reconna√Æt la dette AAA
            enregistrerEcriture({
                joueurId, libelle: `Pr√™t de relance AAA (cr√©ance 0%)`,
                compteDebit: 501,   // Caisse # (actif +) = # re√ßus
                compteCredit: 44,   // Dette Coop AAA (passif +) = dette reconnue
                montantEspoyr: pretRelance,
                contexte: 'potAAA',
                details: { type: 'pret_relance' }
            });
            
            // √âcriture Pot AAA: donne les # et reconna√Æt la cr√©ance
            enregistrerEcriture({
                joueurId: 'POT_AAA', libelle: `Pr√™t relance √† ${playersData[joueurId]?.name || joueurId}`,
                compteDebit: 48,    // Cr√©ances Pot AAA (actif +) = cr√©ance cr√©√©e
                compteCredit: 580,  // Caisse Pot AAA (actif -) = # sortent
                montantEspoyr: pretRelance,
                contexte: 'potAAA',
                details: { type: 'pret_relance', joueurId }
            });
            
            return {
                success: true,
                detteAnnulee: emprunt,
                pretRelance
            };
        }
        
        // Interface : Modal de d√©claration de faillite
        function showFailliteModal() {
            const status = checkFaillite(myPlayerId);
            const player = playersData[myPlayerId];
            
            if (!status.enFaillite) {
                showModal(`
                    <h3>üìä Situation financi√®re</h3>
                    <p>Tu n'es pas en situation de faillite.</p>
                    <p><strong>Caisse :</strong> ${fmt(status.euro)}‚Ç¨ / ${fmt(status.espoyr)}#</p>
                    <p><strong>Dette :</strong> ${fmt(status.emprunt)}‚Ç¨</p>
                    <p><strong>Capacit√© d'emprunt :</strong> ${fmt(status.capaciteEmprunt)}‚Ç¨</p>
                `, `<button class="btn btn-secondary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            // En faillite
            if (status.isMembre) {
                showModal(`
                    <h3>‚ö†Ô∏è Faillite - Membre AAA</h3>
                    <p style="color: #dc2626;">Tu es en situation de faillite !</p>
                    <p><strong>Caisse :</strong> ${fmt(status.euro)}‚Ç¨ / ${fmt(status.espoyr)}#</p>
                    <p><strong>Dette :</strong> ${fmt(status.emprunt)}‚Ç¨</p>
                    <hr style="margin: 10px 0;">
                    <div style="background: #dcfce7; padding: 10px; border-radius: 8px;">
                        <p style="margin: 0; font-weight: bold;">${LOGO_AAA} Intervention du Pot AAA</p>
                        <p style="margin: 4px 0 0 0; font-size: 0.9rem;">
                            En tant que membre, tu b√©n√©ficies de :
                        </p>
                        <ul style="font-size: 0.85rem; margin: 8px 0;">
                            <li>Annulation de ta dette de ${fmt(status.emprunt)}‚Ç¨</li>
                            <li>Pr√™t de relance de 250# (remboursable au passage Ligne 1, 0%)</li>
                        </ul>
                    </div>
                `, `
                    <button class="btn btn-primary" onclick="declarerFailliteAAA()">${LOGO_AAA} Accepter l'aide AAA</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                `);
            } else {
                showModal(`
                    <h3>‚ö†Ô∏è Faillite</h3>
                    <p style="color: #dc2626;">Tu es en situation de faillite !</p>
                    <p><strong>Caisse :</strong> ${fmt(status.euro)}‚Ç¨ / ${fmt(status.espoyr)}#</p>
                    <p><strong>Dette :</strong> ${fmt(status.emprunt)}‚Ç¨</p>
                    <hr style="margin: 10px 0;">
                    <div style="background: #fee2e2; padding: 10px; border-radius: 8px;">
                        <p style="margin: 0; font-weight: bold;">‚ùå Non membre du Pot AAA</p>
                        <p style="margin: 4px 0 0 0; font-size: 0.9rem;">
                            Tu ne peux pas b√©n√©ficier de l'aide du Pot AAA.
                        </p>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #6b7280;">
                            Options : vendre des activit√©s ou d√©clarer faillite totale.
                        </p>
                    </div>
                `, `
                    <button class="btn" style="background:#fee2e2;color:#dc2626;" onclick="declarerFailliteTotale()">üíÄ Faillite totale</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                `);
            }
        }
        
        // D√©clarer faillite avec intervention AAA
        async function declarerFailliteAAA() {
            closeModal();
            
            const result = await interventionAAA(myPlayerId);
            
            if (!result.success) {
                showModal(`<h3>‚ùå Erreur</h3><p>${result.reason}</p>`,
                    `<button class="btn btn-secondary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            // Mettre √† jour Firebase
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro,
                espoyr: caisse.espoyr,
                emprunt: 0
            });
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`${LOGO_AAA} ${myName} a √©t√© sauv√© par le Pot AAA ! Dette annul√©e: ${fmt(result.detteAnnulee)}‚Ç¨, Pr√™t: +${fmt(result.pretRelance)}#`);
            
            showModal(`
                <h3>${LOGO_AAA} Intervention AAA r√©ussie !</h3>
                <p><strong>Dette annul√©e :</strong> ${fmt(result.detteAnnulee)}‚Ç¨</p>
                <p><strong>Pr√™t de relance :</strong> +${fmt(result.pretRelance)}#</p>
                <p style="font-size: 0.85rem; color: #4338ca; margin-top: 8px;">
                    üìú Remboursement au passage Ligne 1, sans int√©r√™ts (0%)
                </p>
                <p style="font-size: 0.9rem; color: #059669; margin-top: 10px;">
                    Tu repars avec une nouvelle chance. Utilise-la bien !
                </p>
            `, `<button class="btn btn-primary" onclick="closeModal(); nextTurn();">Merci AAA ! ${LOGO_AAA}</button>`);
        }
        
        // D√©clarer faillite totale (non-membre AAA)
        async function declarerFailliteTotale() {
            closeModal();
            
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const emprunt = caisse.emprunt || 0;
            
            // 1. Constater la r√©duction de valeur et le d√©faut
            await comptaReductionValeur(myPlayerId, emprunt);
            await comptaDefautEffectif(myPlayerId, emprunt);
            
            // 2. Remettre le joueur √† z√©ro
            COMPTABILITE.caisseJoueurs[myPlayerId].euro = 0;
            COMPTABILITE.caisseJoueurs[myPlayerId].espoyr = 0;
            COMPTABILITE.caisseJoueurs[myPlayerId].emprunt = 0;
            COMPTABILITE.caisseJoueurs[myPlayerId].apportsActivites = 0;
            
            // 3. Perdre toutes les activit√©s (elles redeviennent libres)
            const activitesALiberer = [];
            for (const [actId, act] of Object.entries(COMPTABILITE.caisseActivites)) {
                if (act.proprietaireId === myPlayerId) {
                    activitesALiberer.push(actId);
                    COMPTABILITE.caisseActivites[actId].proprietaireId = null;
                }
            }
            
            // 4. Mettre √† jour Firebase
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: 0, espoyr: 0, emprunt: 0
            });
            
            for (const actId of activitesALiberer) {
                await gameRef.child(`activites/${actId}`).remove();
                await gameRef.child(`equipements/${actId}`).remove();
            }
            
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üíÄ ${myName} a fait faillite totale ! ${activitesALiberer.length} activit√©s lib√©r√©es.`);
            
            showModal(`
                <h3>üíÄ Faillite totale</h3>
                <p>Tu as tout perdu.</p>
                <p><strong>Activit√©s perdues :</strong> ${activitesALiberer.length}</p>
                <p style="font-size: 0.9rem; color: #dc2626; margin-top: 10px;">
                    Tu repars de z√©ro. Rejoins le Pot AAA pour te prot√©ger √† l'avenir !
                </p>
            `, `<button class="btn btn-primary" onclick="closeModal(); nextTurn();">Recommencer üí™</button>`);
        }
        
        // V√©rifier automatiquement la faillite quand on ne peut pas payer
        async function checkAndHandleFaillite(montantAPayer) {
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const euro = caisse.euro || 0;
            const espoyr = caisse.espoyr || 0;
            
            // Peut-on payer ?
            if (euro + espoyr >= montantAPayer) {
                return false; // Pas en faillite
            }
            
            // Peut-on emprunter le reste ?
            const manque = montantAPayer - euro - espoyr;
            const status = checkFaillite(myPlayerId);
            
            if (status.capaciteEmprunt >= manque) {
                return false; // Peut emprunter
            }
            
            // Faillite !
            showFailliteModal();
            return true;
        }

        // ========== PAIEMENT / N√âGOCIATION ==========
        async function showPayOrNegotiateModal(c, ownerId, currentEuro) {
            const players = Object.values(playersData);
            const ownerPlayer = players.find(p => p.id === ownerId);
            
            const equipSnap = await gameRef.child(`equipements/${c.id}`).once('value');
            const nbEquip = equipSnap.val() || 0;
            const equipTypesSnap = await gameRef.child(`equipementTypes/${c.id}`).once('value');
            const equipTypes = equipTypesSnap.val() || [];
            
            // Prix personnalis√© ou calcul√©
            const prixPersoSnap = await gameRef.child(`prixPersonnalises/${c.id}`).once('value');
            const prixPerso = prixPersoSnap.val();
            
            // Calcul facture = 5% du total investi (activit√© + tous √©quipements)
            const factureBase = calculerFactureActivite(c.id, equipTypes);
            const facture = prixPerso !== null ? prixPerso : factureBase;
            
            const myEspoyr = COMPTABILITE.caisseJoueurs[myPlayerId]?.espoyr || 0;
            const canPayEuro = currentEuro >= facture;
            const canPayHash = myEspoyr >= facture;  // Paiement 100% #
            const canPayMixed = (currentEuro + myEspoyr) >= facture;
            
            // Phase actuelle
            const phase = gameState?.phase || 1;
            
            // V√©rifier si en faillite potentielle
            const status = checkFaillite(myPlayerId);
            const cannotPayAtAll = !canPayEuro && !canPayMixed && status.capaciteEmprunt < (facture - currentEuro - myEspoyr);
            
            let content = `
                <h3>${c.icon} ${c.name}</h3>
                <p>Propri√©taire : <strong>${ownerPlayer?.avatar} ${ownerPlayer?.name}</strong></p>
                
                <div style="background: #f3f4f6; padding: 10px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0;"><strong>Facture :</strong> <span style="font-size: 1.2rem; color: #dc2626;">${fmt(facture)}‚Ç¨</span></p>
                    ${prixPerso !== null ? `<p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6b7280;">(Prix ajust√©, base: ${fmt(factureBase)}‚Ç¨)</p>` : ''}
                    ${equipTypes.length > 0 ? `<p style="margin: 4px 0 0 0; font-size: 0.8rem;">√âquipements: <strong>${equipTypes.join('+')}</strong> (5% total investi)</p>` : ''}
                </div>
                
                <div style="background: #dbeafe; padding: 10px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0;"><strong>Ton solde :</strong> ${fmt(currentEuro)}‚Ç¨ / ${fmt(myEspoyr)}#</p>
                </div>
                
                ${cannotPayAtAll ? '<p style="color: #dc2626; font-weight: bold; text-align: center;">üíÄ Tu ne peux pas payer cette facture !</p>' : ''}
            `;
            
            let buttons = '';
            
            // Option 1: Payer en ‚Ç¨ (si assez)
            if (canPayEuro) {
                buttons += `<button class="btn btn-primary" onclick="payOwner(${c.id}, '${ownerId}', ${facture}, 0)">üí∂ Payer ${facture}‚Ç¨</button>`;
            }
            
            // Option 2: Payer en # (Phase 1+ et si assez de #)
            if (canPayHash && c.hash) {
                buttons += `<button class="btn" style="background:#dcfce7;color:#059669;" onclick="payOwner(${c.id}, '${ownerId}', 0, ${facture})">${LOGO_AAA} Payer ${facture}#</button>`;
            }
            
            // Option 3: Paiement mixte (n√©gociation)
            if (myEspoyr > 0 && c.hash) {
                buttons += `<button class="btn" style="background:#fef3c7;color:#92400e;" onclick="showNegoModal(${c.id}, '${ownerId}', ${facture})">ü§ù Paiement mixte</button>`;
            }
            
            // Option 4: Action Contributive (Phase 2+ uniquement, max 2/tour)
            const actionContribCeTour = playersData[myPlayerId]?.actionContribCeTour || 0;
            const potAAADispo = COMPTABILITE.potAAA?.solde || 0;
            if (phase >= 2 && actionContribCeTour < 2 && potAAADispo >= 190) {
                buttons += `<button class="btn" style="background:#dbeafe;color:#1d4ed8;" onclick="showActionContributiveModal(${c.id}, '${ownerId}', ${facture})">ü§ù Action Contributive</button>`;
            } else if (phase >= 2 && actionContribCeTour < 2 && potAAADispo < 190) {
                buttons += `<button class="btn" style="background:#dbeafe;color:#1d4ed8;" onclick="showVoteAugmentationPotAAA(${c.id}, '${ownerId}', ${facture})">ü§ù Action Contributive (Pot AAA insuffisant)</button>`;
            }
            
            // Option 4b: Surplus ‚Ç¨‚Üí# (si le payeur a plus que la facture ET le propri√©taire a des #)
            const ownerEspoyr = COMPTABILITE.caisseJoueurs[ownerId]?.espoyr || 0;
            if (canPayEuro && currentEuro > facture && ownerEspoyr > 0) {
                buttons += `<button class="btn" style="background:#d1fae5;color:#065f46;" onclick="showSurplusModal(${c.id}, '${ownerId}', ${facture})">üí± Surplus ‚Ç¨‚Üí#</button>`;
            }
            
            // Option 5: Emprunter (TOUJOURS visible si capacit√© disponible)
            if (status.capaciteEmprunt > 0) {
                buttons += `<button class="btn" style="background:#fef3c7;color:#b45309;" onclick="showDiffereModal(${c.id}, '${ownerId}', ${facture})">üí∞ Emprunter</button>`;
            }
            
            // Option 5b: Vendre une activit√© aux ench√®res
            const mesActivites = Object.entries(COMPTABILITE.caisseActivites || {})
                .filter(([id, a]) => a.proprietaireId === myPlayerId);
            if (mesActivites.length > 1) {
                buttons += `<button class="btn" style="background:#fce7f3;color:#9d174d;" onclick="showVenteActivitePourPayer(${c.id}, '${ownerId}', ${facture})">üî® Vendre aux ench√®res</button>`;
            }
            
            // Option 6: Reporter le paiement (si ne peut pas payer du tout)
            if (!canPayEuro && !canPayHash) {
                buttons += `<button class="btn" style="background:#e0e7ff;color:#3730a3;" onclick="showReportModal(${c.id}, '${ownerId}', ${facture})">üìú Reporter le paiement</button>`;
            }
            
            // Option 7: D√©couvert (filet ultime ‚Äî payer en n√©gatif)
            if (!canPayEuro) {
                buttons += `<button class="btn" style="background:#fee2e2;color:#991b1b;" onclick="payerEnDecouvert(${c.id}, '${ownerId}', ${facture})">‚ö†Ô∏è Accepter le d√©couvert</button>`;
            }
            
            // Option 8: Abandonner (volontaire)
            buttons += `<button class="btn" style="background:#fef9c3;color:#854d0e;font-size:0.8rem;margin-top:6px;" onclick="closeModal(); showAbandonModal();">üö™ Abandonner la partie</button>`;
            
            showModal(content, buttons);
        }
        
        // Modal de paiement diff√©r√©
        function showDiffereModal(caseId, ownerId, facture) {
            closeModal();
            const c = CASES[caseId];
            const players = Object.values(playersData);
            const ownerPlayer = players.find(p => p.id === ownerId);
            const myEuro = COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0;
            const status = checkFaillite(myPlayerId);
            
            const manque = facture - myEuro;
            const peutEmprunter = status.capaciteEmprunt >= manque;
            
            showModal(`
                <h3>üìã Paiement Diff√©r√©</h3>
                <p>${c.icon} ${c.name} - Facture : ${fmt(facture)}‚Ç¨</p>
                <p>Propri√©taire : ${ownerPlayer?.avatar} ${ownerPlayer?.name}</p>
                <hr style="margin: 10px 0;">
                <p>Tu as : <strong>${fmt(myEuro)}‚Ç¨</strong></p>
                <p>Il te manque : <strong style="color: #dc2626;">${fmt(manque)}‚Ç¨</strong></p>
                
                <div style="background: #fef3c7; padding: 10px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0; font-weight: bold;">üí∞ Emprunter ${fmt(manque)}‚Ç¨ √† la banque ?</p>
                    <p style="margin: 4px 0 0 0; font-size: 0.85rem;">Capacit√© d'emprunt: ${fmt(status.capaciteEmprunt)}‚Ç¨</p>
                    <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #dc2626;">‚ö†Ô∏è Int√©r√™ts: 10% par tour</p>
                </div>
                
                ${!peutEmprunter ? '<p style="color: #dc2626;">‚ùå Capacit√© d\'emprunt insuffisante</p>' : ''}
            `, `
                ${peutEmprunter ? `<button class="btn btn-primary" onclick="emprunterEtPayer(${caseId}, '${ownerId}', ${facture}, ${manque})">üí≥ Emprunter et payer</button>` : ''}
                <button class="btn btn-secondary" onclick="showPayOrNegotiateModal(CASES[${caseId}], '${ownerId}', ${myEuro})">‚¨ÖÔ∏è Retour</button>
            `);
        }
        
        // Emprunter puis payer
        async function emprunterEtPayer(caseId, ownerId, facture, montantEmprunt) {
            closeModal();
            
            // 1. Emprunter √† la banque
            await comptaEmprunt(myPlayerId, montantEmprunt);
            
            // Firebase - maj emprunt
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, emprunt: caisse.emprunt
            });
            
            // LOG EVENT
            logEvent('BANK_LOAN', myPlayerId, { 
                amount: montantEmprunt, 
                newDebt: caisse.emprunt,
                reason: 'payment_defer'
            });
            
            // 2. Payer le propri√©taire
            await payOwner(caseId, ownerId, facture, 0);
        }
        
        // ========== REPORT DE PAIEMENT ENTRE JOUEURS ==========
        // Le joueur demande au propri√©taire de reporter la facture.
        // Remboursement au prochain passage Ligne 1, sans int√©r√™ts.
        
        function showReportModal(caseId, ownerId, facture) {
            closeModal();
            const c = CASES[caseId];
            const players = Object.values(playersData);
            const ownerPlayer = players.find(p => p.id === ownerId);
            const myEuro = COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0;
            const myHash = COMPTABILITE.caisseJoueurs[myPlayerId]?.espoyr || 0;
            
            // Dettes d√©j√† en cours vers ce cr√©ancier
            const dettesExistantes = (COMPTABILITE.dettesEntreJoueurs || [])
                .filter(d => d.debiteurId === myPlayerId && d.createurId === ownerId);
            const totalDetteExistante = dettesExistantes.reduce((s, d) => s + d.montant, 0);
            
            showModal(`
                <h3>üìú Demander un report de paiement</h3>
                <p>${c.icon} <strong>${c.name}</strong> ‚Äî Facture : <span style="color:#dc2626;font-weight:bold;">${fmt(facture)}‚Ç¨</span></p>
                <p>Propri√©taire : ${ownerPlayer?.avatar} <strong>${ownerPlayer?.name}</strong></p>
                
                <div style="background:#e0e7ff;padding:10px;border-radius:8px;margin:10px 0;">
                    <p style="margin:0;font-size:0.9rem;">Tu demandes √† <strong>${ownerPlayer?.name}</strong> de te faire cr√©dit.</p>
                    <p style="margin:4px 0 0 0;font-size:0.85rem;color:#4338ca;">üí° Remboursement au prochain passage Ligne 1</p>
                    <p style="margin:4px 0 0 0;font-size:0.85rem;color:#4338ca;">‚úÖ Sans int√©r√™ts (solidarit√©)</p>
                </div>
                
                <div style="background:#f3f4f6;padding:8px;border-radius:8px;margin:8px 0;">
                    <p style="margin:0;font-size:0.85rem;">Ton solde : <strong>${fmt(myEuro)}‚Ç¨ / ${fmt(myHash)}#</strong></p>
                    ${totalDetteExistante > 0 ? `<p style="margin:4px 0 0 0;font-size:0.85rem;color:#dc2626;">‚ö†Ô∏è Tu dois d√©j√† ${fmt(totalDetteExistante)}‚Ç¨ √† ${ownerPlayer?.name}</p>` : ''}
                </div>
            `, `
                <button class="btn btn-primary" onclick="reporterPaiement(${caseId}, '${ownerId}', ${facture})">üìú Demander le report</button>
                <button class="btn btn-secondary" onclick="showPayOrNegotiateModal(CASES[${caseId}], '${ownerId}', ${myEuro})">‚¨ÖÔ∏è Retour</button>
            `);
        }
        
        async function reporterPaiement(caseId, ownerId, facture) {
            closeModal();
            const c = CASES[caseId];
            const ownerPlayer = Object.values(playersData).find(p => p.id === ownerId);
            
            // D√©cision du propri√©taire (bot ou humain)
            let accepte = false;
            
            if (ownerPlayer?.isBot) {
                // Bot : d√©cision selon profil IA
                const profil = ownerPlayer.profilIA || 'PREDATEUR';
                if (profil === 'COOPERATIF' || profil === 'SOLIDAIRE') {
                    accepte = true;  // Toujours solidaire
                } else if (profil === 'EQUILIBRE') {
                    // Accepte si pas trop de dettes d√©j√†
                    const dettesExistantes = (COMPTABILITE.dettesEntreJoueurs || [])
                        .filter(d => d.createurId === ownerId && d.debiteurId === myPlayerId);
                    accepte = dettesExistantes.length < 2;
                } else if (profil === 'PRUDENT') {
                    accepte = Math.random() > 0.5;  // 50/50
                } else {
                    // PREDATEUR, INVESTISSEUR : refuse
                    accepte = false;
                }
                
                // Message
                if (accepte) {
                    sendSystemMessage(`ü§ù ${ownerPlayer.avatar} ${ownerPlayer.name} accepte le report de ${fmt(facture)}‚Ç¨`);
                } else {
                    sendSystemMessage(`‚ùå ${ownerPlayer.avatar} ${ownerPlayer.name} refuse le report`);
                }
            } else {
                // Joueur humain : pour l'instant auto-accepte (mode solo)
                // TODO: en multijoueur, envoyer une demande via Firebase
                accepte = true;
                sendSystemMessage(`ü§ù ${ownerPlayer?.avatar || ''} ${ownerPlayer?.name || 'Propri√©taire'} accepte le report de ${fmt(facture)}‚Ç¨`);
            }
            
            if (accepte) {
                // Enregistrer la dette
                const dette = {
                    debiteurId: myPlayerId,
                    createurId: ownerId,
                    montant: facture,
                    caseId: caseId,
                    caseName: c.name,
                    tour: gameState?.toursComplets || 0,
                    timestamp: Date.now()
                };
                
                COMPTABILITE.dettesEntreJoueurs.push(dette);
                
                // √âcriture comptable d√©biteur: reconna√Æt la dette
                enregistrerEcriture({
                    joueurId: myPlayerId,
                    libelle: `Report paiement ${c.name} ‚Üí ${ownerPlayer?.name} (${fmt(facture)}‚Ç¨)`,
                    compteDebit: 613,   // Frais divers (charge +) = la facture est une charge
                    compteCredit: 401,  // Fournisseurs (passif +) = dette reconnue
                    montantEuro: facture,
                    contexte: 'reportPaiement',
                    details: { type: 'report', createurId: ownerId, caseId }
                });
                
                // √âcriture comptable cr√©ancier: reconna√Æt la cr√©ance
                enregistrerEcriture({
                    joueurId: ownerId,
                    libelle: `Cr√©ance report ${c.name} de ${playersData[myPlayerId]?.name} (${fmt(facture)}‚Ç¨)`,
                    compteDebit: 411,   // Clients (actif +) = cr√©ance reconnue
                    compteCredit: 700,  // Ventes/Factures (produit +) = revenu reconnu
                    montantEuro: facture,
                    contexte: 'reportPaiement',
                    details: { type: 'report', debiteurId: myPlayerId, caseId }
                });
                
                await syncComptabiliteToFirebase();
                
                logEvent('REPORT_PAIEMENT', myPlayerId, {
                    createurId: ownerId,
                    montant: facture,
                    caseId,
                    caseName: c.name
                });
                
                showModal(`
                    <h3>üìú Paiement report√©</h3>
                    <div style="background:#dcfce7;padding:12px;border-radius:8px;">
                        <p style="margin:0;font-size:1.1rem;text-align:center;">
                            ${ownerPlayer?.avatar} ${ownerPlayer?.name} t'accorde un cr√©dit de <strong>${fmt(facture)}‚Ç¨</strong>
                        </p>
                        <p style="margin:8px 0 0 0;text-align:center;font-size:0.9rem;color:#059669;">
                            √Ä rembourser au prochain passage Ligne 1
                        </p>
                    </div>
                `, `<button class="btn btn-primary" onclick="closeModal(); nextTurn();">‚úÖ OK</button>`);
            } else {
                // Refus√© ‚Äî retour au modal de paiement
                const myEuro = COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0;
                showModal(`
                    <h3>‚ùå Report refus√©</h3>
                    <p>${ownerPlayer?.avatar} ${ownerPlayer?.name} refuse de reporter le paiement de ${fmt(facture)}‚Ç¨.</p>
                    <p style="font-size:0.9rem;color:#6b7280;">Tu dois trouver un autre moyen de payer.</p>
                `, `<button class="btn btn-primary" onclick="showPayOrNegotiateModal(CASES[${caseId}], '${ownerId}', ${myEuro})">‚¨ÖÔ∏è Retour aux options</button>`);
            }
        }
        
        // Rembourser toutes les dettes entre joueurs pour un joueur donn√©
        async function rembourserDettesEntreJoueurs(joueurId) {
            const dettes = (COMPTABILITE.dettesEntreJoueurs || []).filter(d => d.debiteurId === joueurId);
            if (dettes.length === 0) return { total: 0, rembourse: 0, restant: 0, details: [] };
            
            const caisse = COMPTABILITE.caisseJoueurs[joueurId];
            if (!caisse) return { total: 0, rembourse: 0, restant: 0, details: [] };
            
            let totalRembourse = 0;
            const details = [];
            const dettesRestantes = [];
            
            for (const dette of dettes) {
                const creancier = playersData[dette.createurId];
                const disponible = caisse.euro || 0;
                
                if (disponible >= dette.montant) {
                    // Peut rembourser int√©gralement
                    caisse.euro -= dette.montant;
                    
                    // Cr√©diter le cr√©ancier
                    initCaisseJoueur(dette.createurId);
                    COMPTABILITE.caisseJoueurs[dette.createurId].euro += dette.montant;
                    
                    // √âcriture comptable d√©biteur: paie sa dette fournisseur
                    enregistrerEcriture({
                        joueurId: joueurId,
                        libelle: `Remboursement report ${dette.caseName} ‚Üí ${creancier?.name || dette.createurId}`,
                        compteDebit: 401,   // Fournisseurs (passif -) = dette diminue
                        compteCredit: 500,  // Caisse ‚Ç¨ (actif -) = cash sort
                        montantEuro: dette.montant,
                        contexte: 'remboursementReport',
                        details: { createurId: dette.createurId, caseId: dette.caseId }
                    });
                    
                    // √âcriture comptable cr√©ancier: re√ßoit le paiement
                    enregistrerEcriture({
                        joueurId: dette.createurId,
                        libelle: `Re√ßu remboursement report ${dette.caseName} de ${playersData[joueurId]?.name || joueurId}`,
                        compteDebit: 500,   // Caisse ‚Ç¨ (actif +) = cash entre
                        compteCredit: 411,  // Clients (actif -) = cr√©ance diminue
                        montantEuro: dette.montant,
                        contexte: 'remboursementReport',
                        details: { debiteurId: joueurId, caseId: dette.caseId }
                    });
                    
                    // MAJ Firebase cr√©ancier
                    await db.ref(`parties/${currentGameCode}/players/${dette.createurId}/euro`)
                        .set(COMPTABILITE.caisseJoueurs[dette.createurId].euro);
                    
                    totalRembourse += dette.montant;
                    details.push({ createurName: creancier?.name || '?', montant: dette.montant, caseName: dette.caseName, paye: true });
                    
                    sendSystemMessage(`üìú ${playersData[joueurId]?.name || joueurId} rembourse ${fmt(dette.montant)}‚Ç¨ √† ${creancier?.avatar || ''} ${creancier?.name || '?'} (${dette.caseName})`);
                } else {
                    // Pas assez ‚Üí la dette reste
                    dettesRestantes.push(dette);
                    details.push({ createurName: creancier?.name || '?', montant: dette.montant, caseName: dette.caseName, paye: false });
                }
            }
            
            // Mettre √† jour la liste: garder les non-rembours√©es + celles d'autres joueurs
            COMPTABILITE.dettesEntreJoueurs = [
                ...COMPTABILITE.dettesEntreJoueurs.filter(d => d.debiteurId !== joueurId),
                ...dettesRestantes
            ];
            
            // MAJ Firebase d√©biteur
            await db.ref(`parties/${currentGameCode}/players/${joueurId}/euro`).set(caisse.euro);
            await syncComptabiliteToFirebase();
            
            const totalRestant = dettesRestantes.reduce((s, d) => s + d.montant, 0);
            return { total: totalRembourse + totalRestant, rembourse: totalRembourse, restant: totalRestant, details };
        }
        
        // ========== MENSUALIT√âS BIENS PERSONNELS (au passage Ligne 1) ==========
        async function payerMensualitesPersonnelles(joueurId) {
            initCaisseJoueur(joueurId);
            const caisse = COMPTABILITE.caisseJoueurs[joueurId];
            if (!caisse.dettesPersonnelles || caisse.dettesPersonnelles.length === 0) {
                return { totalPaye: 0, totalImpaye: 0, details: [] };
            }
            
            let totalPaye = 0;
            let totalImpaye = 0;
            const details = [];
            
            for (const dette of caisse.dettesPersonnelles) {
                if (dette.toursRestants <= 0 || dette.capitalRestant <= 0) continue;
                
                const mensualite = dette.mensualite;
                
                if ((caisse.euro || 0) >= mensualite) {
                    // Peut payer
                    caisse.euro -= mensualite;
                    dette.capitalRestant -= mensualite;
                    dette.toursRestants--;
                    totalPaye += mensualite;
                    
                    if (dette.capitalRestant <= 0) {
                        dette.capitalRestant = 0;
                        dette.toursRestants = 0;
                    }
                    
                    details.push({ nom: dette.nom, icon: dette.icon, montant: mensualite, paye: true, restant: dette.capitalRestant });
                } else {
                    // Pas assez ‚Üí arri√©r√©
                    caisse.impaye = (caisse.impaye || 0) + mensualite;
                    totalImpaye += mensualite;
                    details.push({ nom: dette.nom, icon: dette.icon, montant: mensualite, paye: false, restant: dette.capitalRestant });
                }
            }
            
            // Nettoyer les dettes termin√©es
            caisse.dettesPersonnelles = caisse.dettesPersonnelles.filter(d => d.toursRestants > 0 && d.capitalRestant > 0);
            
            if (totalPaye > 0) {
                // √âcriture joueur: rembourse sa dette personnelle
                enregistrerEcriture({
                    joueurId, libelle: `Mensualit√©s biens personnels (${fmt(totalPaye)}‚Ç¨)`,
                    compteDebit: 400, compteCredit: 500, montantEuro: totalPaye,
                    contexte: 'mensualiteBien'
                });
                
                // Contrepartie: l'argent va hors circuit (biens de consommation)
                COMPTABILITE.horsCircuit = COMPTABILITE.horsCircuit || { solde: 0, recettes: 0 };
                COMPTABILITE.horsCircuit.solde += totalPaye;
                COMPTABILITE.horsCircuit.recettes += totalPaye;
                
                enregistrerEcriture({
                    joueurId: 'HORS_CIRCUIT', libelle: `Mensualit√©s re√ßues de ${playersData[joueurId]?.name || joueurId}`,
                    compteDebit: 550, compteCredit: 758, montantEuro: totalPaye,
                    contexte: 'mensualiteBien'
                });
            }
            
            await db.ref(`parties/${currentGameCode}/players/${joueurId}/euro`).set(caisse.euro);
            await syncComptabiliteToFirebase();
            
            return { totalPaye, totalImpaye, details };
        }
        
        // ========== ARRI√âR√âS (paiement au passage Ligne 1) ==========
        async function payerArrieres(joueurId) {
            initCaisseJoueur(joueurId);
            const caisse = COMPTABILITE.caisseJoueurs[joueurId];
            const impayeAvant = caisse.impaye || 0;
            if (impayeAvant <= 0) return { avant: 0, paye: 0, apres: 0 };
            
            // Garder minimum 50‚Ç¨
            const disponible = Math.max(0, (caisse.euro || 0) - 50);
            const aPayer = Math.min(disponible, impayeAvant);
            
            if (aPayer > 0) {
                caisse.euro -= aPayer;
                caisse.impaye -= aPayer;
                
                // √âcriture joueur: paie ses arri√©r√©s
                enregistrerEcriture({
                    joueurId, libelle: `Paiement arri√©r√©s (${fmt(aPayer)}‚Ç¨)`,
                    compteDebit: 401, compteCredit: 500, montantEuro: aPayer,
                    contexte: 'arrieres'
                });
                
                // Contrepartie: l'argent des arri√©r√©s va hors circuit (cr√©anciers divers non trac√©s)
                COMPTABILITE.horsCircuit = COMPTABILITE.horsCircuit || { solde: 0, recettes: 0 };
                COMPTABILITE.horsCircuit.solde += aPayer;
                COMPTABILITE.horsCircuit.recettes += aPayer;
                
                enregistrerEcriture({
                    joueurId: 'HORS_CIRCUIT', libelle: `Arri√©r√©s re√ßus de ${playersData[joueurId]?.name || joueurId}`,
                    compteDebit: 550, compteCredit: 758, montantEuro: aPayer,
                    contexte: 'arrieres'
                });
                
                await db.ref(`parties/${currentGameCode}/players/${joueurId}/euro`).set(caisse.euro);
                await syncComptabiliteToFirebase();
                
                sendSystemMessage(`üí∏ ${playersData[joueurId]?.name || joueurId} paie ${fmt(aPayer)}‚Ç¨ d'arri√©r√©s`);
            }
            
            return { avant: impayeAvant, paye: aPayer, apres: caisse.impaye || 0 };
        }
        
        // ========== SMART CONTRACTS (Pr√™ts entre joueurs ‚Äî Phase 3 uniquement) ==========
        function showSmartContractModal() {
            const phase = gameState?.phase || 1;
            if (phase < 3) {
                showModal(`<h3>üìú Smart Contract</h3><p>Les Smart Contracts ne sont disponibles qu'en Phase 3.</p>`,
                    `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            initCaisseJoueur(myPlayerId);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            
            // V√©rifier si arri√©r√©s
            if ((caisse.impaye || 0) > 0) {
                showModal(`<h3>üìú Smart Contract</h3><p>‚ùå Tu as <strong>${fmt(caisse.impaye)}‚Ç¨ d'arri√©r√©s</strong>. Tu dois d'abord les rembourser avant de demander un pr√™t.</p>`,
                    `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            // V√©rifier si d√©j√† un smart contract actif non rembours√©
            const scActifs = (COMPTABILITE.smartContracts || []).filter(sc => sc.debiteurId === myPlayerId && !sc.rembourse);
            if (scActifs.length > 0) {
                showModal(`<h3>üìú Smart Contract</h3><p>‚ö†Ô∏è Tu as d√©j√† un pr√™t en cours. Rembourse-le d'abord au passage Ligne 1.</p>`,
                    `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            // Lister les joueurs avec des fonds
            const players = Object.values(playersData).filter(p => p.id !== myPlayerId);
            let playersHTML = '';
            
            for (const p of players) {
                const pCaisse = COMPTABILITE.caisseJoueurs[p.id] || {};
                const euroDisp = pCaisse.euro || p.euro || 0;
                const hashDisp = pCaisse.espoyr || p.espoyr || 0;
                
                if (euroDisp > 0 || hashDisp > 0) {
                    playersHTML += `
                        <div style="background:#f3f4f6;padding:8px;border-radius:8px;margin:6px 0;cursor:pointer;border:2px solid transparent;"
                             onclick="showSmartContractDemande('${p.id}', ${euroDisp}, ${hashDisp})"
                             onmouseover="this.style.borderColor='#6366f1'" onmouseout="this.style.borderColor='transparent'">
                            <span>${p.avatar} <strong>${p.name}</strong></span>
                            <span style="float:right;font-size:0.9rem;">${fmt(euroDisp)}‚Ç¨ / ${fmt(hashDisp)}#</span>
                        </div>`;
                }
            }
            
            if (!playersHTML) {
                showModal(`<h3>üìú Smart Contract</h3><p>Aucun joueur n'a de fonds √† pr√™ter.</p>`,
                    `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            showModal(`
                <h3>üìú Smart Contract ‚Äî Demander un pr√™t</h3>
                <p style="font-size:0.9rem;color:#6b7280;">Choisis √† qui tu veux demander un pr√™t. Remboursement au prochain passage Ligne 1, sans int√©r√™ts.</p>
                ${playersHTML}
            `, `<button class="btn btn-secondary" onclick="closeModal()">Annuler</button>`);
        }
        
        function showSmartContractDemande(preteurId, euroDisp, hashDisp) {
            const preteur = playersData[preteurId];
            
            showModal(`
                <h3>üìú Pr√™t √† ${preteur?.avatar} ${preteur?.name}</h3>
                <div style="margin:10px 0;">
                    <label style="font-size:0.9rem;">Montant en ‚Ç¨ :</label>
                    <input type="number" id="scMontantEuro" min="0" max="${euroDisp}" value="0" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;margin:4px 0;">
                    <p style="font-size:0.8rem;color:#6b7280;">Max disponible: ${fmt(euroDisp)}‚Ç¨</p>
                </div>
                <div style="margin:10px 0;">
                    <label style="font-size:0.9rem;">Montant en # :</label>
                    <input type="number" id="scMontantHash" min="0" max="${hashDisp}" value="0" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:6px;margin:4px 0;">
                    <p style="font-size:0.8rem;color:#6b7280;">Max disponible: ${fmt(hashDisp)}#</p>
                </div>
                <p style="font-size:0.85rem;color:#4338ca;">üí° Remboursement au prochain passage Ligne 1, 0% int√©r√™ts</p>
            `, `
                <button class="btn btn-primary" onclick="demanderSmartContract('${preteurId}')">üìú Demander</button>
                <button class="btn btn-secondary" onclick="showSmartContractModal()">‚¨ÖÔ∏è Retour</button>
            `);
        }
        
        async function demanderSmartContract(preteurId) {
            const montantEuro = parseInt(document.getElementById('scMontantEuro')?.value || 0);
            const montantHash = parseInt(document.getElementById('scMontantHash')?.value || 0);
            
            if (montantEuro <= 0 && montantHash <= 0) {
                alert('Choisis un montant !');
                return;
            }
            
            closeModal();
            const preteur = playersData[preteurId];
            
            // D√©cision du pr√™teur (bot ou auto-accept en solo)
            let accepte = false;
            
            if (preteur?.isBot) {
                const profil = preteur.profilIA || 'PREDATEUR';
                if (profil === 'SOLIDAIRE' || profil === 'COOPERATIF') {
                    accepte = true;
                } else if (profil === 'EQUILIBRE') {
                    accepte = Math.random() > 0.3;  // 70% chance
                } else if (profil === 'PRUDENT') {
                    accepte = Math.random() > 0.6;  // 40% chance
                } else {
                    // PREDATEUR, INVESTISSEUR : refusent
                    accepte = false;
                }
            } else {
                accepte = true;  // Joueur humain: auto-accept en mode solo
            }
            
            if (accepte) {
                initCaisseJoueur(myPlayerId);
                initCaisseJoueur(preteurId);
                const maCaisse = COMPTABILITE.caisseJoueurs[myPlayerId];
                const preteurCaisse = COMPTABILITE.caisseJoueurs[preteurId];
                
                // Transf√©rer les fonds
                if (montantEuro > 0) {
                    preteurCaisse.euro -= montantEuro;
                    maCaisse.euro += montantEuro;
                }
                if (montantHash > 0) {
                    preteurCaisse.espoyr = (preteurCaisse.espoyr || 0) - montantHash;
                    maCaisse.espoyr = (maCaisse.espoyr || 0) + montantHash;
                }
                
                // Enregistrer le smart contract
                COMPTABILITE.smartContracts.push({
                    debiteurId: myPlayerId,
                    createurId: preteurId,
                    montantEuro, montantHash,
                    tourAccorde: gameState?.toursComplets || 0,
                    rembourse: false
                });
                
                // √âcriture emprunteur: re√ßoit le pr√™t, reconna√Æt la dette
                enregistrerEcriture({
                    joueurId: myPlayerId,
                    libelle: `Smart Contract re√ßu de ${preteur?.name} (${montantEuro > 0 ? fmt(montantEuro)+'‚Ç¨' : ''}${montantHash > 0 ? ' '+fmt(montantHash)+'#' : ''})`,
                    compteDebit: 500, compteCredit: 410, montantEuro,
                    contexte: 'smartContract', details: { preteurId, montantEuro, montantHash }
                });
                if (montantHash > 0) {
                    enregistrerEcriture({
                        joueurId: myPlayerId,
                        libelle: `Smart Contract re√ßu # de ${preteur?.name}`,
                        compteDebit: 501, compteCredit: 410, montantEspoyr: montantHash,
                        contexte: 'smartContract', details: { preteurId }
                    });
                }
                
                // √âcriture pr√™teur: donne le pr√™t, reconna√Æt la cr√©ance
                enregistrerEcriture({
                    joueurId: preteurId,
                    libelle: `Smart Contract pr√™t√© √† ${myName} (${montantEuro > 0 ? fmt(montantEuro)+'‚Ç¨' : ''}${montantHash > 0 ? ' '+fmt(montantHash)+'#' : ''})`,
                    compteDebit: 411, compteCredit: 500, montantEuro,
                    contexte: 'smartContract', details: { debiteurId: myPlayerId, montantEuro, montantHash }
                });
                if (montantHash > 0) {
                    enregistrerEcriture({
                        joueurId: preteurId,
                        libelle: `Smart Contract pr√™t√© # √† ${myName}`,
                        compteDebit: 411, compteCredit: 501, montantEspoyr: montantHash,
                        contexte: 'smartContract', details: { debiteurId: myPlayerId }
                    });
                }
                
                await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({ euro: maCaisse.euro, espoyr: maCaisse.espoyr || 0 });
                await db.ref(`parties/${currentGameCode}/players/${preteurId}`).update({ euro: preteurCaisse.euro, espoyr: preteurCaisse.espoyr || 0 });
                await syncComptabiliteToFirebase();
                
                logEvent('SMART_CONTRACT', myPlayerId, { preteurId, montantEuro, montantHash });
                sendSystemMessage(`üìú ${preteur?.avatar} ${preteur?.name} pr√™te ${montantEuro > 0 ? fmt(montantEuro)+'‚Ç¨' : ''}${montantHash > 0 ? ' '+fmt(montantHash)+'#' : ''} √† ${myName}`);
                
                showModal(`<h3>‚úÖ Smart Contract sign√©</h3>
                    <p>${preteur?.avatar} ${preteur?.name} te pr√™te <strong>${montantEuro > 0 ? fmt(montantEuro)+'‚Ç¨' : ''}${montantHash > 0 ? ' '+fmt(montantHash)+'#' : ''}</strong></p>
                    <p style="font-size:0.85rem;color:#4338ca;">Remboursement au prochain passage Ligne 1</p>`,
                    `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
            } else {
                sendSystemMessage(`‚ùå ${preteur?.avatar} ${preteur?.name} refuse le pr√™t √† ${myName}`);
                showModal(`<h3>‚ùå Pr√™t refus√©</h3><p>${preteur?.avatar} ${preteur?.name} refuse de pr√™ter.</p>`,
                    `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
            }
        }
        
        // Rembourser Smart Contracts au passage Ligne 1
        async function rembourserSmartContracts(joueurId) {
            const scs = (COMPTABILITE.smartContracts || []).filter(sc => sc.debiteurId === joueurId && !sc.rembourse);
            if (scs.length === 0) return { rembourse: [], arrieres: [] };
            
            initCaisseJoueur(joueurId);
            const caisse = COMPTABILITE.caisseJoueurs[joueurId];
            const result = { rembourse: [], arrieres: [] };
            
            for (const sc of scs) {
                const creancier = playersData[sc.createurId];
                initCaisseJoueur(sc.createurId);
                const creancierCaisse = COMPTABILITE.caisseJoueurs[sc.createurId];
                
                let payeEuro = 0, payeHash = 0;
                let impayeEuro = 0, impayeHash = 0;
                
                // Rembourser ‚Ç¨
                if (sc.montantEuro > 0) {
                    if ((caisse.euro || 0) >= sc.montantEuro) {
                        caisse.euro -= sc.montantEuro;
                        creancierCaisse.euro += sc.montantEuro;
                        payeEuro = sc.montantEuro;
                    } else {
                        impayeEuro = sc.montantEuro;
                        caisse.impaye = (caisse.impaye || 0) + sc.montantEuro;
                    }
                }
                
                // Rembourser #
                if (sc.montantHash > 0) {
                    if ((caisse.espoyr || 0) >= sc.montantHash) {
                        caisse.espoyr -= sc.montantHash;
                        creancierCaisse.espoyr = (creancierCaisse.espoyr || 0) + sc.montantHash;
                        payeHash = sc.montantHash;
                    } else {
                        impayeHash = sc.montantHash;
                        caisse.impaye = (caisse.impaye || 0) + sc.montantHash;
                    }
                }
                
                sc.rembourse = true;
                
                if (payeEuro > 0 || payeHash > 0) {
                    // √âcritures d√©biteur: rembourse sa dette SC
                    if (payeEuro > 0) {
                        enregistrerEcriture({
                            joueurId, libelle: `Remboursement SC ‚Üí ${creancier?.name || sc.createurId} (${fmt(payeEuro)}‚Ç¨)`,
                            compteDebit: 410, compteCredit: 500, montantEuro: payeEuro,
                            contexte: 'remboursementSC', details: { createurId: sc.createurId }
                        });
                    }
                    if (payeHash > 0) {
                        enregistrerEcriture({
                            joueurId, libelle: `Remboursement SC # ‚Üí ${creancier?.name || sc.createurId} (${fmt(payeHash)}#)`,
                            compteDebit: 410, compteCredit: 501, montantEspoyr: payeHash,
                            contexte: 'remboursementSC', details: { createurId: sc.createurId }
                        });
                    }
                    
                    // √âcritures cr√©ancier: re√ßoit le remboursement
                    if (payeEuro > 0) {
                        enregistrerEcriture({
                            joueurId: sc.createurId, libelle: `Re√ßu remboursement SC de ${playersData[joueurId]?.name || joueurId} (${fmt(payeEuro)}‚Ç¨)`,
                            compteDebit: 500, compteCredit: 411, montantEuro: payeEuro,
                            contexte: 'remboursementSC', details: { debiteurId: joueurId }
                        });
                    }
                    if (payeHash > 0) {
                        enregistrerEcriture({
                            joueurId: sc.createurId, libelle: `Re√ßu remboursement SC # de ${playersData[joueurId]?.name || joueurId} (${fmt(payeHash)}#)`,
                            compteDebit: 501, compteCredit: 411, montantEspoyr: payeHash,
                            contexte: 'remboursementSC', details: { debiteurId: joueurId }
                        });
                    }
                    
                    result.rembourse.push({ creancierName: creancier?.name || '?', euro: payeEuro, hash: payeHash });
                    await db.ref(`parties/${currentGameCode}/players/${sc.createurId}`).update({ euro: creancierCaisse.euro, espoyr: creancierCaisse.espoyr || 0 });
                    sendSystemMessage(`üìú ${playersData[joueurId]?.name} rembourse ${payeEuro > 0 ? fmt(payeEuro)+'‚Ç¨' : ''}${payeHash > 0 ? ' '+fmt(payeHash)+'#' : ''} √† ${creancier?.avatar} ${creancier?.name}`);
                }
                
                if (impayeEuro > 0 || impayeHash > 0) {
                    result.arrieres.push({ creancierName: creancier?.name || '?', euro: impayeEuro, hash: impayeHash });
                    sendSystemMessage(`‚ö†Ô∏è ${playersData[joueurId]?.name} ne peut rembourser ${impayeEuro > 0 ? fmt(impayeEuro)+'‚Ç¨' : ''}${impayeHash > 0 ? ' '+fmt(impayeHash)+'#' : ''} ‚Üí arri√©r√©s`);
                }
            }
            
            await db.ref(`parties/${currentGameCode}/players/${joueurId}`).update({ euro: caisse.euro, espoyr: caisse.espoyr || 0 });
            await syncComptabiliteToFirebase();
            
            return result;
        }
        
        async function payOwner(caseId, ownerId, euroAmount, hashAmount) {
            closeModal();
            const c = CASES[caseId];
            
            // Comptabilit√©
            const result = await comptaPaiementFacture(myPlayerId, ownerId, caseId, euroAmount, hashAmount);
            
            // LOG EVENT: PAY_INVOICE
            logEvent('PAY_INVOICE', myPlayerId, {
                caseId,
                actName: c.name,
                ownerId,
                euroAmount,
                hashAmount,
                total: euroAmount + hashAmount
            }, result.ledgerEntryIds || []);
            
            // Firebase
            const maCaisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            const ownerCaisse = COMPTABILITE.caisseJoueurs[ownerId];
            
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: maCaisse.euro, espoyr: maCaisse.espoyr
            });
            
            // Propri√©taire re√ßoit dans activit√©
            const caisseAct = COMPTABILITE.caisseActivites[caseId];
            await db.ref(`parties/${currentGameCode}/players/${ownerId}`).update({
                euro: (playersData[ownerId]?.euro || 0) + euroAmount,
                espoyr: (playersData[ownerId]?.espoyr || 0) + hashAmount
            });
            
            await syncComptabiliteToFirebase();
            
            const players = Object.values(playersData);
            const ownerPlayer = players.find(p => p.id === ownerId);
            
            let msg = `üí∏ ${myName} paie `;
            if (euroAmount > 0) msg += `${euroAmount}‚Ç¨`;
            if (hashAmount > 0) msg += `${euroAmount > 0 ? '+' : ''}${hashAmount}#`;
            msg += ` √† ${ownerPlayer?.name}`;
            sendSystemMessage(msg);
            
            nextTurn();
        }
        
        // ========== N√âGOCIATION ==========
        function showNegoModal(caseId, ownerId, facture) {
            closeModal();
            const c = CASES[caseId];
            const myEuro = COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0;
            const myEspoyr = COMPTABILITE.caisseJoueurs[myPlayerId]?.espoyr || 0;
            const players = Object.values(playersData);
            const ownerPlayer = players.find(p => p.id === ownerId);
            
            // Calcul limites du curseur
            const maxPctHash = Math.min(100, Math.floor(myEspoyr / facture * 100));
            const minPctHash = Math.max(0, Math.ceil((facture - myEuro) / facture * 100));
            const defaultPct = Math.max(minPctHash, Math.min(50, maxPctHash));
            
            showModal(`
                <h3>ü§ù Paiement Mixte</h3>
                <p>${c.icon} ${c.name} ‚Äî Propri√©taire : ${ownerPlayer?.avatar} ${ownerPlayer?.name}</p>
                <p style="font-size: 1.1rem;"><strong>Facture :</strong> <span style="color: #dc2626;">${fmt(facture)}‚Ç¨</span></p>
                
                <div style="background: #dbeafe; padding: 10px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0;"><strong>Ton solde :</strong> ${fmt(myEuro)}‚Ç¨ / ${fmt(myEspoyr)}#</p>
                </div>
                
                <div style="margin: 18px 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px;">
                        <span>üí∂ 100% ‚Ç¨</span>
                        <span>${LOGO_AAA} 100% #</span>
                    </div>
                    <input type="range" id="negoMixSlider" min="${minPctHash}" max="${maxPctHash}" value="${defaultPct}" 
                           oninput="updateMixDisplay(${facture})" style="width: 100%; accent-color: #059669;">
                    <div style="text-align: center; margin-top: 6px;">
                        <span id="negoPctLabel" style="font-size: 1.1rem; font-weight: bold; color: #065f46;">${defaultPct}% en #</span>
                    </div>
                </div>
                
                <div id="negoMixResult" style="text-align: center; padding: 12px; background: #f0fdf4; border-radius: 8px; border: 2px solid #059669;">
                </div>
                
                <div id="negoMixStatus" style="text-align: center; margin-top: 8px; font-size: 0.9rem;"></div>
            `, `
                <button class="btn btn-primary" id="negoSubmitBtn" onclick="sendNegoOffer(${caseId}, '${ownerId}', ${facture})">üí∏ Payer</button>
                <button class="btn btn-secondary" onclick="showPayOrNegotiateModal(CASES[${caseId}], '${ownerId}', ${myEuro})">‚¨ÖÔ∏è Retour</button>
            `);
            
            updateMixDisplay(facture);
        }
        
        function updateMixDisplay(facture) {
            const pct = parseInt(document.getElementById('negoMixSlider').value) || 0;
            const hashAmount = Math.round(facture * pct / 100);
            const euroAmount = facture - hashAmount;
            
            document.getElementById('negoPctLabel').textContent = `${pct}% en #`;
            
            document.getElementById('negoMixResult').innerHTML = `
                <p style="margin: 0; font-size: 1.2rem;">
                    <strong>üí∂ ${fmt(euroAmount)}‚Ç¨</strong>  +  <strong style="color: #059669;">${LOGO_AAA} ${fmt(hashAmount)}#</strong>
                </p>
                <p style="margin: 4px 0 0 0; font-size: 0.95rem; color: #374151;">
                    = ${fmt(euroAmount + hashAmount)} / ${fmt(facture)} ‚úÖ
                </p>
            `;
            
            // Stocker pour sendNegoOffer
            document.getElementById('negoMixSlider').dataset.euroAmount = euroAmount;
            document.getElementById('negoMixSlider').dataset.hashAmount = hashAmount;
        }
        
        async function sendNegoOffer(caseId, ownerId, facture) {
            const slider = document.getElementById('negoMixSlider');
            const euroOffer = parseInt(slider.dataset.euroAmount) || 0;
            const hashOffer = parseInt(slider.dataset.hashAmount) || 0;
            const total = euroOffer + hashOffer;
            
            if (total <= 0) {
                alert('Montant invalide');
                return;
            }
            
            if (total >= facture) {
                // Paiement direct accept√©
                await payOwner(caseId, ownerId, euroOffer, hashOffer);
            } else {
                // Demander validation au propri√©taire
                closeModal();
                
                // Cr√©er une demande de n√©gociation dans Firebase
                const negoId = 'nego_' + Date.now();
                await gameRef.child(`negotiations/${negoId}`).set({
                    id: negoId,
                    caseId,
                    caseName: CASES[caseId].name,
                    payerId: myPlayerId,
                    payerName: myName,
                    ownerId,
                    ownerName: playersData[ownerId]?.name,
                    facture,
                    euroOffer,
                    hashOffer,
                    total,
                    status: 'pending',
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                sendSystemMessage(`ü§ù ${myName} propose ${fmt(euroOffer)}‚Ç¨+${fmt(hashOffer)}# (${fmt(total)}/${fmt(facture)}) √† ${playersData[ownerId]?.name}`);
                
                // Attendre la r√©ponse du propri√©taire
                showModal(`
                    <h3>‚è≥ En attente...</h3>
                    <p>Proposition envoy√©e √† ${playersData[ownerId]?.name}</p>
                    <p><strong>${fmt(euroOffer)}‚Ç¨ + ${fmt(hashOffer)}# = ${fmt(total)}</strong> (facture: ${fmt(facture)})</p>
                    <p style="color: #6b7280;">Le propri√©taire doit accepter ou refuser.</p>
                `, ``);
                
                // √âcouter la r√©ponse
                gameRef.child(`negotiations/${negoId}/status`).on('value', async (snap) => {
                    const status = snap.val();
                    if (status === 'accepted') {
                        gameRef.child(`negotiations/${negoId}`).off();
                        await payOwner(caseId, ownerId, euroOffer, hashOffer);
                    } else if (status === 'rejected') {
                        gameRef.child(`negotiations/${negoId}`).off();
                        closeModal();
                        sendSystemMessage(`‚ùå ${playersData[ownerId]?.name} a refus√© la proposition`);
                        showPayOrNegotiateModal(CASES[caseId], ownerId, COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0);
                    }
                });
            }
        }
        
        // √âcouter les demandes de n√©gociation entrantes
        function listenForNegotiations() {
            if (!gameRef) return;
            
            gameRef.child('negotiations').on('child_added', (snap) => {
                const nego = snap.val();
                if (nego && nego.ownerId === myPlayerId && nego.status === 'pending') {
                    if (nego.type === 'surplus') {
                        showSurplusRequestModal(nego);
                    } else {
                        showNegotiationRequestModal(nego);
                    }
                }
            });
        }
        
        function showNegotiationRequestModal(nego) {
            const discount = Math.round((1 - nego.total / nego.facture) * 100);
            
            showModal(`
                <h3>ü§ù Demande de Paiement</h3>
                <p><strong>${nego.payerName}</strong> veut payer ${nego.caseName}</p>
                
                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center;">
                    <p style="margin: 0; font-size: 1.3rem;">
                        <strong>${fmt(nego.euroOffer)}‚Ç¨ + ${fmt(nego.hashOffer)}#</strong>
                    </p>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem;">
                        Total: ${nego.total} / Facture: ${nego.facture}
                    </p>
                    <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #dc2626;">
                        R√©duction: -${discount}%
                    </p>
                </div>
                
                <p style="color: #6b7280; font-size: 0.85rem;">
                    üí° Accepter te donnera ${nego.euroOffer}‚Ç¨ et ${nego.hashOffer}#
                </p>
            `, `
                <button class="btn btn-primary" onclick="respondToNegotiation('${nego.id}', true)">‚úÖ Accepter</button>
                <button class="btn" style="background:#fee2e2;color:#dc2626;" onclick="respondToNegotiation('${nego.id}', false)">‚ùå Refuser</button>
            `);
        }
        
        async function respondToNegotiation(negoId, accept) {
            closeModal();
            await gameRef.child(`negotiations/${negoId}/status`).set(accept ? 'accepted' : 'rejected');
            
            if (accept) {
                sendSystemMessage(`‚úÖ ${myName} accepte la proposition`);
            } else {
                sendSystemMessage(`‚ùå ${myName} refuse la proposition`);
            }
        }
        
        function showSurplusRequestModal(nego) {
            const myEspoyr = COMPTABILITE.caisseJoueurs[myPlayerId]?.espoyr || 0;
            const canAccept = myEspoyr >= nego.surplus;
            
            showModal(`
                <h3>üí± Demande de Surplus ‚Ç¨‚Üí#</h3>
                <p><strong>${nego.payerName}</strong> veut acheter des bons # chez toi</p>
                
                <div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center;">
                    <p style="margin: 0; font-size: 1.1rem;">
                        Facture : <strong>${fmt(nego.facture)}‚Ç¨</strong>
                    </p>
                    <p style="margin: 8px 0 0 0; font-size: 1.3rem; color: #065f46;">
                        + Surplus : <strong>${fmt(nego.surplus)}‚Ç¨ ‚Üí ${fmt(nego.surplus)}#</strong>
                    </p>
                </div>
                
                <div style="background: #f3f4f6; padding: 10px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0;">Tu re√ßois : <strong style="color: #2563eb;">${fmt(nego.surplus)}‚Ç¨ en plus</strong></p>
                    <p style="margin: 4px 0 0 0;">Tu donnes : <strong style="color: #dc2626;">${fmt(nego.surplus)}# de tes bons</strong></p>
                    <p style="margin: 4px 0 0 0;">Ton solde # actuel : <strong>${fmt(myEspoyr)}#</strong></p>
                </div>
                
                ${!canAccept ? '<p style="color: #dc2626; font-weight: bold;">‚ö†Ô∏è Tu n\'as pas assez de # !</p>' : ''}
            `, `
                ${canAccept ? `<button class="btn btn-primary" onclick="respondToNegotiation('${nego.id}', true)">‚úÖ Accepter (+${fmt(nego.surplus)}‚Ç¨ / -${fmt(nego.surplus)}#)</button>` : ''}
                <button class="btn" style="background:#fee2e2;color:#dc2626;" onclick="respondToNegotiation('${nego.id}', false)">‚ùå Refuser</button>
            `);
        }
        
        // ========== TRAVAIL COOP√âRATIF ==========
        // ========== ACTION CONTRIBUTIVE (ex-Travail Coop√©ratif) ==========
        function showActionContributiveModal(caseId, ownerId, facture) {
            closeModal();
            const c = CASES[caseId];
            const ownerPlayer = Object.values(playersData).find(p => p.id === ownerId);
            const actionContribCeTour = playersData[myPlayerId]?.actionContribCeTour || 0;
            const potDispo = COMPTABILITE.potAAA?.solde || 0;
            
            // Phase 2+ : condition d'accepter le paiement mixte
            let conditionHtml = '';
            const phase = gameState?.phase || 1;
            if (phase === 2) {
                conditionHtml = `
                    <div style="background:#fef3c7;padding:10px;border-radius:8px;margin:10px 0;">
                        <p style="margin:0;font-weight:bold;color:#92400e;">‚ö†Ô∏è Condition</p>
                        <p style="margin:4px 0 0 0;font-size:0.9rem;">En acceptant, toutes tes activit√©s accepteront le paiement mixte ‚Ç¨/#. Le logo # sera affich√©.</p>
                    </div>`;
            }
            
            let listeHtml = '<div style="max-height:300px;overflow-y:auto;">';
            TRAVAUX_COOP.forEach(t => {
                const dispo = potDispo >= t.gain;
                listeHtml += `
                    <button class="btn" style="width:100%;margin:3px 0;text-align:left;padding:8px 12px;
                        background:${dispo ? '#f0fdf4' : '#f3f4f6'};color:${dispo ? '#065f46' : '#9ca3af'};
                        font-size:0.85rem;border:1px solid ${dispo ? '#86efac' : '#e5e7eb'};"
                        ${dispo ? `onclick="executerActionContributive(${caseId}, '${ownerId}', ${facture}, ${t.id}, ${t.gain})"` : 'disabled'}
                    >
                        ${t.nom} ‚Äî <strong>${t.gain}#</strong>${!dispo ? ' (pot insuffisant)' : ''}
                    </button>`;
            });
            listeHtml += '</div>';
            
            showModal(`
                <h3>ü§ù Action Contributive</h3>
                <p>Facture : <strong>${fmt(facture)}‚Ç¨</strong> ‚Üí ${ownerPlayer?.avatar} ${ownerPlayer?.name}</p>
                <p style="font-size:0.85rem;color:#6b7280;">Tu recevras des # du Pot AAA pour payer la facture en #.</p>
                <p style="font-size:0.85rem;color:#dc2626;">‚è≠Ô∏è Tu passeras ton prochain tour. (${actionContribCeTour + 1}/2 ce tour)</p>
                ${conditionHtml}
                <hr style="margin:10px 0;">
                <p style="font-weight:bold;">Choisis une action :</p>
                ${listeHtml}
            `, `
                <button class="btn btn-secondary" onclick="showPayOrNegotiateModal(CASES[${caseId}], '${ownerId}', COMPTABILITE.caisseJoueurs['${myPlayerId}']?.euro || 0)">‚¨ÖÔ∏è Retour</button>
            `);
        }
        
        async function executerActionContributive(caseId, ownerId, facture, travailId, gainHash) {
            closeModal();
            const c = CASES[caseId];
            const ownerPlayer = Object.values(playersData).find(p => p.id === ownerId);
            const phase = gameState?.phase || 1;
            
            // 1. Recevoir les # du Pot AAA
            initCaisseJoueur(myPlayerId);
            const maCaisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            maCaisse.espoyr += gainHash;
            COMPTABILITE.potAAA.solde -= gainHash;
            COMPTABILITE.potAAA.circulationHash += gainHash;
            
            const travail = TRAVAUX_COOP.find(t => t.id === travailId);
            enregistrerEcriture({
                joueurId: myPlayerId, libelle: `Action contributive: ${travail?.nom || 'Travail'}`,
                compteDebit: 501, compteCredit: 468, montantEspoyr: gainHash, activiteId: caseId
            });
            
            sendSystemMessage(`ü§ù ${myName} effectue "${travail?.nom}" ‚Üí +${fmt(gainHash)}#`);
            
            // 2. Payer la facture en # au propri√©taire (pas de TVA sur #)
            const montantPaye = Math.min(gainHash, facture);
            initCaisseJoueur(ownerId);
            maCaisse.espoyr -= montantPaye;
            COMPTABILITE.caisseJoueurs[ownerId].espoyr += montantPaye;
            
            enregistrerEcriture({
                joueurId: myPlayerId, libelle: `Paiement # ${c.name}`,
                compteDebit: 468, compteCredit: 501, montantEspoyr: montantPaye, activiteId: caseId
            });
            enregistrerEcriture({
                joueurId: ownerId, libelle: `Recette # ${c.name}`,
                compteDebit: 501, compteCredit: 468, montantEspoyr: montantPaye, activiteId: caseId
            });
            
            sendSystemMessage(`${LOGO_AAA} ${myName} paie ${fmt(montantPaye)}# √† ${ownerPlayer?.name} (${c.icon})`);
            
            // 3. Si pas assez pour couvrir toute la facture, le reste va en d√©couvert ‚Ç¨
            let resteEnEuro = 0;
            if (gainHash < facture) {
                resteEnEuro = facture - gainHash;
                maCaisse.euro -= resteEnEuro;
                COMPTABILITE.caisseJoueurs[ownerId].euro += Math.round(resteEnEuro / 1.21 * 100) / 100; // HT
                const tvaReste = resteEnEuro - Math.round(resteEnEuro / 1.21 * 100) / 100;
                COMPTABILITE.etat.tresor += tvaReste;
                sendSystemMessage(`‚ö†Ô∏è Compl√©ment ${fmt(resteEnEuro)}‚Ç¨ (d√©couvert)`);
            }
            
            // 4. Phase 2 : accepter paiement mixte sur toutes ses activit√©s + logo #
            if (phase === 2) {
                const mesActs = Object.entries(COMPTABILITE.caisseActivites || {})
                    .filter(([id, a]) => a.proprietaireId === myPlayerId);
                for (const [actId, act] of mesActs) {
                    await gameRef.child(`activites_hash/${actId}`).set(true);
                    CASES[actId].hash = true;
                }
                sendSystemMessage(`${LOGO_AAA} ${myName} accepte le paiement mixte sur toutes ses activit√©s`);
            }
            
            // 5. Skip tour suivant
            const skipSnap = await gameRef.child(`skipTurns/${myPlayerId}`).once('value');
            const currentSkip = skipSnap.val() || 0;
            await gameRef.child(`skipTurns/${myPlayerId}`).set(currentSkip + 1);
            
            // 6. Compteur d'actions ce tour
            const newCount = (playersData[myPlayerId]?.actionContribCeTour || 0) + 1;
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/actionContribCeTour`).set(newCount);
            
            // 7. Firebase sync
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/euro`).set(maCaisse.euro);
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(maCaisse.espoyr);
            await db.ref(`parties/${currentGameCode}/players/${ownerId}/espoyr`).set(COMPTABILITE.caisseJoueurs[ownerId].espoyr);
            if (resteEnEuro > 0) {
                await db.ref(`parties/${currentGameCode}/players/${ownerId}/euro`).set(COMPTABILITE.caisseJoueurs[ownerId].euro);
            }
            await syncComptabiliteToFirebase();
            
            // 8. LOG EVENT
            logEvent('ACTION_CONTRIBUTIVE', myPlayerId, {
                caseId, travailId, gainHash, facture, montantPaye, resteEnEuro,
                ownerId, ownerName: ownerPlayer?.name, skipTurns: currentSkip + 1
            });
            
            // 9. Modal r√©cap
            showModal(`
                <h3>‚úÖ Action Contributive effectu√©e !</h3>
                <p>ü§ù ${travail?.nom}</p>
                <div style="background:#dcfce7;padding:10px;border-radius:8px;margin:8px 0;">
                    <p style="margin:0;">Re√ßu : <strong>+${fmt(gainHash)}#</strong> du Pot AAA</p>
                    <p style="margin:4px 0 0 0;">Pay√© : <strong>${fmt(montantPaye)}#</strong> √† ${ownerPlayer?.avatar} ${ownerPlayer?.name}</p>
                    ${resteEnEuro > 0 ? `<p style="margin:4px 0 0 0;color:#dc2626;">Compl√©ment d√©couvert : -${fmt(resteEnEuro)}‚Ç¨</p>` : ''}
                </div>
                <div style="background:#dbeafe;padding:10px;border-radius:8px;margin:8px 0;">
                    <p style="margin:0;">‚è≠Ô∏è Tu passeras ton prochain tour.</p>
                </div>
                <p style="font-size:0.85rem;color:#6b7280;">Solde: ${fmt(maCaisse.euro)}‚Ç¨ / ${fmt(maCaisse.espoyr)}#</p>
            `, `<button class="btn btn-primary" onclick="closeModal(); nextTurn();">OK</button>`);
        }
        
        // ========== D√âCOUVERT (filet ultime) ==========
        async function payerEnDecouvert(caseId, ownerId, facture) {
            closeModal();
            const c = CASES[caseId];
            const ownerPlayer = Object.values(playersData).find(p => p.id === ownerId);
            
            showModal(`
                <h3>‚ö†Ô∏è Accepter le d√©couvert</h3>
                <p>Facture : <strong>${fmt(facture)}‚Ç¨</strong> ‚Üí ${ownerPlayer?.avatar} ${ownerPlayer?.name}</p>
                <div style="background:#fee2e2;padding:12px;border-radius:8px;margin:10px 0;">
                    <p style="margin:0;font-weight:bold;color:#991b1b;">üìâ Ton solde passera en n√©gatif</p>
                    <p style="margin:6px 0 0 0;font-size:0.9rem;">Solde actuel : <strong>${fmt(COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0)}‚Ç¨</strong></p>
                    <p style="margin:4px 0 0 0;font-size:0.9rem;">Apr√®s paiement : <strong style="color:#dc2626;">${fmt((COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0) - facture)}‚Ç¨</strong></p>
                    <hr style="margin:8px 0;border-color:#fca5a5;">
                    <p style="margin:0;font-size:0.85rem;color:#991b1b;">
                        ‚ö†Ô∏è <strong>Int√©r√™ts 3%</strong> sur le d√©couvert √† <strong>chaque lanc√© de d√©</strong>
                    </p>
                    <p style="margin:4px 0 0 0;font-size:0.85rem;color:#6b7280;">
                        üí° Tu peux transformer ton d√©couvert en pr√™t bancaire (10%/passage Ligne 1) √† tout moment.
                    </p>
                </div>
            `, `
                <button class="btn" style="background:#dc2626;color:white;" onclick="confirmerDecouvert(${caseId}, '${ownerId}', ${facture})">üìâ Confirmer le d√©couvert</button>
                <button class="btn btn-secondary" onclick="showPayOrNegotiateModal(CASES[${caseId}], '${ownerId}', COMPTABILITE.caisseJoueurs['${myPlayerId}']?.euro || 0)">‚¨ÖÔ∏è Retour</button>
            `);
        }
        
        async function confirmerDecouvert(caseId, ownerId, facture) {
            closeModal();
            
            // Payer normalement ‚Äî le solde passe en n√©gatif
            await payOwner(caseId, ownerId, facture, 0);
            
            // Compteur de difficult√©s (d√©clencheur social Phase 2)
            const diffSnap = await gameRef.child(`difficulteConsecutive/${myPlayerId}`).once('value');
            await gameRef.child(`difficulteConsecutive/${myPlayerId}`).set((diffSnap.val() || 0) + 1);
        }
        
        // ========== VOTE AUGMENTATION POT AAA ==========
        async function showVoteAugmentationPotAAA(caseId, ownerId, facture) {
            closeModal();
            const potActuel = COMPTABILITE.potAAA?.solde || 0;
            
            showModal(`
                <h3>üó≥Ô∏è Vote : Augmenter le Pot AAA</h3>
                <p>Le Pot AAA est insuffisant (<strong>${fmt(potActuel)}#</strong>) pour une action contributive.</p>
                <div style="background:#dbeafe;padding:12px;border-radius:8px;margin:10px 0;">
                    <p style="margin:0;font-weight:bold;">Proposition : ajouter +500# au Pot AAA</p>
                    <p style="margin:6px 0 0 0;font-size:0.9rem;color:#6b7280;">
                        Cette d√©cision doit √™tre valid√©e par <strong>tous les joueurs humains</strong>.
                    </p>
                </div>
            `, `
                <button class="btn btn-primary" onclick="lancerVoteAugmentationPot(${caseId}, '${ownerId}', ${facture})">üó≥Ô∏è Soumettre au vote</button>
                <button class="btn btn-secondary" onclick="showPayOrNegotiateModal(CASES[${caseId}], '${ownerId}', COMPTABILITE.caisseJoueurs['${myPlayerId}']?.euro || 0)">‚¨ÖÔ∏è Retour</button>
            `);
        }
        
        async function lancerVoteAugmentationPot(caseId, ownerId, facture) {
            closeModal();
            // Simuler un vote unanime (pour les parties avec bots, auto-accept√© selon profil)
            const players = getOrderedPlayers();
            let tousAcceptent = true;
            const votes = [];
            
            for (const p of players) {
                if (p.id === myPlayerId) {
                    votes.push({ name: p.name, vote: '‚úÖ' });
                    continue;
                }
                if (p.isBot) {
                    const profil = PROFILS_IA[p.botProfil] || PROFILS_IA.EQUILIBRE;
                    const accepte = ['COOPERATIF', 'SOLIDAIRE', 'EQUILIBRE'].includes(profil.id);
                    votes.push({ name: p.name, vote: accepte ? '‚úÖ' : '‚ùå' });
                    if (!accepte) tousAcceptent = false;
                } else {
                    // Joueur humain ‚Äî auto-accept√© pour simplifier (en multijoueur r√©el, un syst√®me de vote Firebase serait n√©cessaire)
                    votes.push({ name: p.name, vote: '‚úÖ' });
                }
            }
            
            let votesHtml = votes.map(v => `<p style="margin:2px 0;">${v.vote} ${v.name}</p>`).join('');
            
            if (tousAcceptent) {
                COMPTABILITE.potAAA.solde += 500;
                await syncComptabiliteToFirebase();
                sendSystemMessage(`üó≥Ô∏è Vote unanime : +500# ajout√©s au Pot AAA (total: ${fmt(COMPTABILITE.potAAA.solde)}#)`);
                
                showModal(`
                    <h3>‚úÖ Vote accept√© !</h3>
                    ${votesHtml}
                    <p style="margin-top:10px;font-weight:bold;color:#059669;">+500# ajout√©s au Pot AAA</p>
                `, `<button class="btn btn-primary" onclick="showActionContributiveModal(${caseId}, '${ownerId}', ${facture})">ü§ù Continuer</button>`);
            } else {
                showModal(`
                    <h3>‚ùå Vote refus√©</h3>
                    ${votesHtml}
                    <p style="margin-top:10px;color:#dc2626;">L'augmentation n'a pas √©t√© accept√©e √† l'unanimit√©.</p>
                `, `<button class="btn btn-secondary" onclick="showPayOrNegotiateModal(CASES[${caseId}], '${ownerId}', COMPTABILITE.caisseJoueurs['${myPlayerId}']?.euro || 0)">‚¨ÖÔ∏è Retour</button>`);
            }
        }
        
        // ========== VENTE AUX ENCH√àRES POUR PAYER ==========
        async function showVenteActivitePourPayer(caseId, ownerId, facture) {
            closeModal();
            const mesActs = Object.entries(COMPTABILITE.caisseActivites || {})
                .filter(([id, a]) => a.proprietaireId === myPlayerId);
            
            let listeHtml = '';
            for (const [actId, act] of mesActs) {
                const ca = CASES[actId];
                if (!ca) continue;
                const check = canSellActivity(myPlayerId, parseInt(actId));
                const prixDepart = Math.floor((act.capital || ca.prix) * 0.5);
                listeHtml += `
                    <button class="btn" style="width:100%;margin:3px 0;text-align:left;padding:8px 12px;
                        background:${check.canSell ? '#fdf2f8' : '#f3f4f6'};color:${check.canSell ? '#9d174d' : '#9ca3af'};
                        border:1px solid ${check.canSell ? '#f9a8d4' : '#e5e7eb'};font-size:0.85rem;"
                        ${check.canSell ? `onclick="showVenteActiviteModal(${actId})"` : 'disabled'}
                    >
                        ${ca.icon} ${ca.name} ‚Äî d√©part ${fmt(prixDepart)}‚Ç¨
                        ${!check.canSell ? `<br><span style="font-size:0.75rem;">${check.reason}</span>` : ''}
                    </button>`;
            }
            
            showModal(`
                <h3>üî® Vendre une activit√© aux ench√®res</h3>
                <p style="font-size:0.9rem;color:#6b7280;">Vends une activit√© pour lever des fonds et payer ta facture de ${fmt(facture)}‚Ç¨.</p>
                <hr style="margin:10px 0;">
                ${listeHtml}
            `, `
                <button class="btn btn-secondary" onclick="showPayOrNegotiateModal(CASES[${caseId}], '${ownerId}', COMPTABILITE.caisseJoueurs['${myPlayerId}']?.euro || 0)">‚¨ÖÔ∏è Retour</button>
            `);
        }
        
        // ========== ABANDON (ex-Faillite) ==========
        function showAbandonModal() {
            showModal(`
                <h3>üö™ Abandonner la partie</h3>
                <div style="background:#fee2e2;padding:12px;border-radius:8px;margin:10px 0;">
                    <p style="margin:0;font-weight:bold;color:#991b1b;">‚ö†Ô∏è Cette action est irr√©versible</p>
                    <p style="margin:6px 0 0 0;font-size:0.9rem;">
                        Toutes tes activit√©s seront lib√©r√©es.<br>
                        Ton solde sera remis √† z√©ro.<br>
                        Tu ne pourras plus jouer cette partie.
                    </p>
                </div>
            `, `
                <button class="btn" style="background:#dc2626;color:white;" onclick="confirmerAbandon()">üö™ Confirmer l'abandon</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            `);
        }
        
        async function confirmerAbandon() {
            closeModal();
            // Lib√©rer toutes les activit√©s
            const mesActs = Object.entries(COMPTABILITE.caisseActivites || {})
                .filter(([id, a]) => a.proprietaireId === myPlayerId);
            for (const [actId, act] of mesActs) {
                await gameRef.child(`activites/${actId}`).remove();
                delete COMPTABILITE.caisseActivites[actId].proprietaireId;
            }
            // Remettre soldes √† 0
            if (COMPTABILITE.caisseJoueurs[myPlayerId]) {
                COMPTABILITE.caisseJoueurs[myPlayerId].euro = 0;
                COMPTABILITE.caisseJoueurs[myPlayerId].espoyr = 0;
                COMPTABILITE.caisseJoueurs[myPlayerId].emprunt = 0;
            }
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/euro`).set(0);
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(0);
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/emprunt`).set(0);
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/abandon`).set(true);
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üö™ ${myName} a abandonn√© la partie.`);
            nextTurn();
        }
        
        // ========== SURPLUS ‚Ç¨‚Üí# ==========
        function showSurplusModal(caseId, ownerId, facture) {
            closeModal();
            const c = CASES[caseId];
            const players = Object.values(playersData);
            const ownerPlayer = players.find(p => p.id === ownerId);
            const myEuro = COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0;
            const ownerEspoyr = COMPTABILITE.caisseJoueurs[ownerId]?.espoyr || 0;
            const maxSurplus = arrondir2(Math.min(myEuro - facture, ownerEspoyr));
            
            showModal(`
                <h3>üí± Surplus ‚Ç¨‚Üí#</h3>
                <p>${c.icon} ${c.name} ‚Äî Facture : ${fmt(facture)}‚Ç¨</p>
                <p>Propri√©taire : ${ownerPlayer?.avatar} ${ownerPlayer?.name}</p>
                <hr style="margin: 10px 0;">
                
                <div style="background: #d1fae5; padding: 12px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        üí° Tu paies la facture <strong>+ un surplus en ‚Ç¨</strong> et tu re√ßois l'√©quivalent en <strong>bons #</strong> du propri√©taire.
                    </p>
                </div>
                
                <div style="background: #f3f4f6; padding: 10px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0;">Ton solde : <strong>${fmt(myEuro)}‚Ç¨</strong></p>
                    <p style="margin: 4px 0 0 0;"># disponibles chez ${ownerPlayer?.name} : <strong>${fmt(ownerEspoyr)}#</strong></p>
                    <p style="margin: 4px 0 0 0;">Surplus max : <strong>${fmt(maxSurplus)}‚Ç¨</strong></p>
                </div>
                
                <div style="text-align: center; margin: 15px 0;">
                    <label style="font-size: 0.9rem; font-weight: bold; display: block; margin-bottom: 8px;">Montant du surplus :</label>
                    <input type="number" id="surplusAmount" min="0.5" max="${maxSurplus}" step="0.5" value="${Math.min(arrondir2(maxSurplus / 2), maxSurplus)}" 
                           oninput="updateSurplusDisplay(${facture}, ${myEuro}, ${ownerEspoyr})"
                           style="width: 120px; text-align: center; font-size: 1.3rem; font-weight: bold; padding: 8px;">
                    <p id="surplusInfo" style="margin: 8px 0 0 0; font-size: 0.9rem; color: #065f46;"></p>
                </div>
                
                <div id="surplusSummary" style="background: #ecfdf5; padding: 12px; border-radius: 8px; text-align: center;">
                </div>
            `, `
                <button class="btn btn-primary" id="surplusSubmitBtn" onclick="submitSurplus(${caseId}, '${ownerId}', ${facture})">üí± Payer avec surplus</button>
                <button class="btn btn-secondary" onclick="showPayOrNegotiateModal(CASES[${caseId}], '${ownerId}', ${myEuro})">‚¨ÖÔ∏è Retour</button>
            `);
            
            updateSurplusDisplay(facture, myEuro, ownerEspoyr);
        }
        
        function updateSurplusDisplay(facture, myEuro, ownerEspoyr) {
            const input = document.getElementById('surplusAmount');
            let surplus = parseFloat(input.value) || 0;
            // Arrondir √† 0.5
            surplus = Math.round(surplus * 2) / 2;
            surplus = arrondir2(surplus);
            
            const maxSurplus = arrondir2(Math.min(myEuro - facture, ownerEspoyr));
            const infoEl = document.getElementById('surplusInfo');
            const summaryEl = document.getElementById('surplusSummary');
            const submitBtn = document.getElementById('surplusSubmitBtn');
            
            const totalPaye = arrondir2(facture + surplus);
            const valid = surplus >= 0.5 && surplus <= maxSurplus;
            
            if (valid) {
                infoEl.textContent = `Tu re√ßois ${fmt(surplus)}# en retour`;
                infoEl.style.color = '#065f46';
                summaryEl.innerHTML = `
                    <p style="margin: 0;"><strong>Total pay√© :</strong> ${fmt(totalPaye)}‚Ç¨</p>
                    <p style="margin: 4px 0 0 0;">Facture : ${fmt(facture)}‚Ç¨ + Surplus : ${fmt(surplus)}‚Ç¨</p>
                    <p style="margin: 4px 0 0 0; color: #059669; font-weight: bold;">‚Üí Tu re√ßois ${fmt(surplus)}# en bons d'achat</p>
                `;
                submitBtn.disabled = false;
            } else if (surplus > maxSurplus) {
                infoEl.textContent = `‚ö†Ô∏è Maximum ${fmt(maxSurplus)}‚Ç¨`;
                infoEl.style.color = '#dc2626';
                summaryEl.innerHTML = '';
                submitBtn.disabled = true;
            } else {
                infoEl.textContent = 'Minimum 0,50‚Ç¨';
                infoEl.style.color = '#6b7280';
                summaryEl.innerHTML = '';
                submitBtn.disabled = true;
            }
        }
        
        async function submitSurplus(caseId, ownerId, facture) {
            let surplus = parseFloat(document.getElementById('surplusAmount').value) || 0;
            surplus = Math.round(surplus * 2) / 2; // Arrondi 0.5
            surplus = arrondir2(surplus);
            
            if (surplus < 0.5) { alert('Montant minimum : 0,50‚Ç¨'); return; }
            
            const ownerEspoyr = COMPTABILITE.caisseJoueurs[ownerId]?.espoyr || 0;
            const myEuro = COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0;
            if (surplus > ownerEspoyr) { alert(`Le propri√©taire n'a que ${fmt(ownerEspoyr)}#`); return; }
            if (facture + surplus > myEuro) { alert(`Tu n'as que ${fmt(myEuro)}‚Ç¨`); return; }
            
            const ownerPlayer = Object.values(playersData).find(p => p.id === ownerId);
            const isBot = ownerPlayer?.isBot;
            
            if (isBot) {
                // Robot propri√©taire : auto-d√©cision bas√©e sur le profil
                const profilId = ownerPlayer?.profilIA || 'PREDATEUR';
                const accepte = ['COOPERATIF', 'SOLIDAIRE', 'EQUILIBRE'].includes(profilId);
                
                if (accepte) {
                    await executerSurplus(caseId, ownerId, facture, surplus);
                } else {
                    closeModal();
                    sendSystemMessage(`‚ùå ${ownerPlayer.name} (${PROFILS_IA[profilId]?.nom || profilId}) refuse l'√©change ‚Ç¨‚Üí#`);
                    showPayOrNegotiateModal(CASES[caseId], ownerId, myEuro);
                }
            } else {
                // Propri√©taire humain : demande via Firebase
                closeModal();
                const surplusNegoId = 'surplus_' + Date.now();
                await gameRef.child(`negotiations/${surplusNegoId}`).set({
                    id: surplusNegoId,
                    type: 'surplus',
                    caseId,
                    caseName: CASES[caseId].name,
                    payerId: myPlayerId,
                    payerName: myName,
                    ownerId,
                    ownerName: ownerPlayer?.name,
                    facture,
                    surplus,
                    status: 'pending',
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                sendSystemMessage(`üí± ${myName} propose un surplus de ${fmt(surplus)}‚Ç¨‚Üí# √† ${ownerPlayer?.name}`);
                
                showModal(`
                    <h3>‚è≥ En attente...</h3>
                    <p>Demande de surplus envoy√©e √† ${ownerPlayer?.name}</p>
                    <p>Facture : <strong>${fmt(facture)}‚Ç¨</strong> + Surplus : <strong>${fmt(surplus)}‚Ç¨‚Üí${fmt(surplus)}#</strong></p>
                    <p style="color: #6b7280;">Le propri√©taire doit accepter de rendre ${fmt(surplus)}# contre ${fmt(surplus)}‚Ç¨.</p>
                `, ``);
                
                // √âcouter la r√©ponse
                gameRef.child(`negotiations/${surplusNegoId}/status`).on('value', async (snap) => {
                    const status = snap.val();
                    if (status === 'accepted') {
                        gameRef.child(`negotiations/${surplusNegoId}`).off();
                        await executerSurplus(caseId, ownerId, facture, surplus);
                    } else if (status === 'rejected') {
                        gameRef.child(`negotiations/${surplusNegoId}`).off();
                        closeModal();
                        sendSystemMessage(`‚ùå ${ownerPlayer?.name} refuse l'√©change surplus ‚Ç¨‚Üí#`);
                        showPayOrNegotiateModal(CASES[caseId], ownerId, COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0);
                    }
                });
            }
        }
        
        async function executerSurplus(caseId, ownerId, facture, surplus) {
            closeModal();
            const c = CASES[caseId];
            
            // 1) Paiement normal de la facture
            const resultFacture = await comptaPaiementFacture(myPlayerId, ownerId, caseId, facture, 0);
            
            // 2) √âchange surplus ‚Ç¨‚Üí#
            const resultSurplus = await comptaSurplusEuroHash(myPlayerId, ownerId, caseId, surplus);
            
            // Firebase ‚Äî mettre √† jour les deux joueurs
            const maCaisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            const ownerCaisse = COMPTABILITE.caisseJoueurs[ownerId];
            
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: maCaisse.euro, espoyr: maCaisse.espoyr
            });
            await db.ref(`parties/${currentGameCode}/players/${ownerId}`).update({
                euro: ownerCaisse.euro, espoyr: ownerCaisse.espoyr
            });
            await syncComptabiliteToFirebase();
            
            const ownerPlayer = Object.values(playersData).find(p => p.id === ownerId);
            
            // LOG EVENT
            logEvent('PAY_SURPLUS', myPlayerId, {
                caseId, actName: c.name, ownerId,
                facture, surplus,
                totalEuroPaye: facture + surplus,
                hashRecu: surplus
            }, [...(resultFacture.ledgerEntryIds || []), ...(resultSurplus.ledgerEntryIds || [])]);
            
            sendSystemMessage(`üí± ${myName} paie ${fmt(facture)}‚Ç¨ + surplus ${fmt(surplus)}‚Ç¨‚Üí${fmt(surplus)}# √† ${ownerPlayer?.name}`);
            
            nextTurn();
        }
        
        // ========== DETTE ==========
        async function createDebt(ownerId, amount) {
            closeModal();
            
            // Comptabilit√© - emprunt forc√© √† la banque pour payer
            const ecritureEmprunt = await comptaEmprunt(myPlayerId, amount);
            
            // Le propri√©taire re√ßoit quand m√™me
            initCaisseJoueur(ownerId);
            COMPTABILITE.caisseJoueurs[ownerId].euro += amount;
            
            // Firebase
            const maCaisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: maCaisse.euro, emprunt: maCaisse.emprunt
            });
            await db.ref(`parties/${currentGameCode}/players/${ownerId}/euro`).set(
                (playersData[ownerId]?.euro || 0) + amount
            );
            await syncComptabiliteToFirebase();
            
            // LOG EVENT: FORCED_LOAN
            logEvent('FORCED_LOAN', myPlayerId, {
                ownerId,
                ownerName: playersData[ownerId]?.name,
                amount,
                newDebt: maCaisse.emprunt
            }, ecritureEmprunt?.ledgerEntryIds || []);
            
            sendSystemMessage(`üìã ${myName} s'endette de ${fmt(amount)}‚Ç¨ (banque)`);
            
            nextTurn();
        }
        
        // ========== CASES SP√âCIALES ==========
        async function handleChance() {
            const card = CHANCE_CARDS[Math.floor(Math.random() * CHANCE_CARDS.length)];
            const ledgerEntryIds = [];
            
            if (card.all) {
                const players = Object.values(playersData);
                for (const p of players) {
                    const ecriture = await comptaChance(p.id, card.amount, true);
                    if (ecriture?.ledgerEntryId) ledgerEntryIds.push(ecriture.ledgerEntryId);
                    const caisse = COMPTABILITE.caisseJoueurs[p.id];
                    await db.ref(`parties/${currentGameCode}/players/${p.id}/euro`).set(caisse.euro);
                }
                sendSystemMessage(`üçÄ CHANCE: ${card.text}`);
            } else {
                const ecriture = await comptaChance(myPlayerId, card.amount, true);
                if (ecriture?.ledgerEntryId) ledgerEntryIds.push(ecriture.ledgerEntryId);
                const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
                await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/euro`).set(caisse.euro);
                sendSystemMessage(`üçÄ ${myName}: ${card.text}`);
            }
            
            await syncComptabiliteToFirebase();
            
            // LOG EVENT: CHANCE_CARD
            logEvent('CHANCE_CARD', myPlayerId, {
                cardText: card.text,
                amount: card.amount,
                affectsAll: card.all || false
            }, ledgerEntryIds);
            
            showModal(`<h3>üçÄ Chance !</h3><p>${card.text}</p>`,
                `<button class="btn btn-primary" onclick="safeNextTurn();">OK</button>`);
        }
        
        async function handleMalchance() {
            // Tirage du d√© pour d√©terminer le bien √† acqu√©rir
            const de = Math.floor(Math.random() * 6) + 1;
            const bien = BIENS_MALCHANCE[de - 1];
            
            sendSystemMessage(`üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${myName} tire un ${de} ‚Üí ${bien.icon} ${bien.nom}`);
            
            showModal(`
                <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Merci ‚Äî Acquisition obligatoire</h3>
                <p style="font-style:italic;color:#6b7280;">${bien.description}</p>
                
                <div style="background:#fef3c7;padding:12px;border-radius:8px;margin:10px 0;">
                    <p style="margin:0;font-size:1.1rem;">${bien.icon} <strong>${bien.nom}</strong></p>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:8px;font-size:0.9rem;">
                        <span>Valeur :</span><span style="font-weight:bold;">${fmt(bien.valeur)}‚Ç¨</span>
                        <span>Int√©r√™ts :</span><span style="color:#dc2626;">${bien.interets}%</span>
                        <span>Total √† payer :</span><span style="font-weight:bold;color:#dc2626;">${fmt(bien.total)}‚Ç¨</span>
                        <span>Mensualit√© :</span><span>${fmt(bien.mensualite)}‚Ç¨/tour</span>
                        <span>Dur√©e :</span><span>${bien.duree} tours</span>
                    </div>
                </div>
                
                <p style="font-size:0.85rem;color:#dc2626;">‚ö†Ô∏è Mensualit√© d√©duite √† chaque passage Ligne 1</p>
            `, `<button class="btn btn-primary" onclick="confirmerAcquisitionBien(${bien.id})">‚úÖ J'ai compris</button>`);
        }
        
        async function confirmerAcquisitionBien(bienId) {
            closeModal();
            const bien = BIENS_MALCHANCE[bienId - 1];
            
            initCaisseJoueur(myPlayerId);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            
            // Ajouter le bien et la dette
            caisse.biensPersonnels.push({
                bienId: bien.id, nom: bien.nom, icon: bien.icon,
                valeur: bien.valeur, tourAchat: gameState?.toursComplets || 0
            });
            
            caisse.dettesPersonnelles.push({
                bienId: bien.id, nom: bien.nom, icon: bien.icon,
                mensualite: bien.mensualite, toursRestants: bien.duree,
                capitalRestant: bien.total, tauxInteret: bien.interets
            });
            
            // √âcriture comptable
            enregistrerEcriture({
                joueurId: myPlayerId,
                libelle: `Acquisition ${bien.icon} ${bien.nom} (dette: ${fmt(bien.total)}‚Ç¨)`,
                compteDebit: 231,   // Immobilisations corporelles
                compteCredit: 400,  // Dettes perso (passif +)
                montantEuro: bien.total,
                contexte: 'bienPersonnel',
                details: { bienId: bien.id, nom: bien.nom, valeur: bien.valeur, total: bien.total }
            });
            
            logEvent('ACHAT_BIEN_PERSONNEL', myPlayerId, { bienId: bien.id, nom: bien.nom, valeur: bien.valeur, total: bien.total, mensualite: bien.mensualite });
            
            await syncComptabiliteToFirebase();
            sendSystemMessage(`üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${myName} acquiert ${bien.icon} ${bien.nom} (${fmt(bien.mensualite)}‚Ç¨/tour)`);
            safeNextTurn();
        }
        
        async function handleFrais(c) {
            const soldeBefore = COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0;
            
            // ========== √âTAPE 3 : Affichage facture avant paiement ==========
            // Calculer la facture pour affichage
            const facturePreview = calculerFacture('frais', c.cout);
            const factureHTML = genererHTMLFacture(facturePreview, `${c.icon} ${c.name}`);
            
            // Afficher le modal avec facture (obligatoire, pas d'annulation)
            showModal(`
                <h3>${c.icon} ${c.name}</h3>
                <p style="font-size: 0.9rem; color: #6b7280; font-style: italic; margin: 6px 0 10px 0;">
                    ${c.description || ''}
                </p>
                ${factureHTML}
            `, `<button class="btn btn-primary" onclick="confirmerPaiementFrais('${c.id}', ${c.cout}, '${c.name}', '${c.icon}')">Payer ${c.cout}‚Ç¨</button>`);
        }
        
        // Fonction de confirmation du paiement des frais
        async function confirmerPaiementFrais(caseId, cout, caseName, caseIcon) {
            closeModal();
            
            const soldeBefore = COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0;
            const result = await comptaFrais(myPlayerId, cout, caseName);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/euro`).set(Math.max(0, caisse.euro));
            await syncComptabiliteToFirebase();
            
            // LOG EVENT: PAY_FEE
            logEvent('PAY_FEE', myPlayerId, {
                caseId: parseInt(caseId),
                caseName: caseName,
                amount: cout,
                factureHT: result.facture.ht,
                factureTVA: result.facture.tva,
                destinationEtat: result.facture.destinationEtat,
                soldeBefore,
                soldeAfter: caisse.euro
            }, result.ledgerEntryIds || []);
            
            sendSystemMessage(`${caseIcon} ${myName} paie ${fmt(cout)}‚Ç¨ de ${caseName}`);
            
            // Confirmation rapide
            showModal(`
                <h3>‚úÖ Paiement effectu√©</h3>
                <p><strong>${fmt(cout)}‚Ç¨</strong> de ${caseName} pay√©s</p>
                <p style="font-size: 0.85rem; color: #6b7280;">
                    HT: ${result.facture.ht.toFixed(2)}‚Ç¨ | TVA: ${result.facture.tva.toFixed(2)}‚Ç¨
                </p>
            `, `<button class="btn btn-primary" onclick="safeNextTurn();">OK</button>`);
        }
        
        async function handleTaxe() {
            // Case 13 = D√©claration fiscale
            const patrimoine = calculerPatrimoine(myPlayerId);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const phase = gameState?.phase || 1;
            const taxeEstimee = Math.floor(patrimoine * 0.10);
            
            // D√©tail du patrimoine
            let detailHtml = '';
            let totalActivites = 0;
            let totalEquipements = 0;
            
            Object.entries(COMPTABILITE.caisseActivites || {}).forEach(([actId, act]) => {
                if (act.proprietaireId === myPlayerId) {
                    const c = CASES[actId];
                    const valAct = act.capital || c?.prix || 0;
                    const nbEquip = act.equipements || 0;
                    const valEquip = nbEquip * 100;
                    totalActivites += valAct;
                    totalEquipements += valEquip;
                    detailHtml += `<p style="margin: 2px 0; font-size: 0.85rem;">
                        ${c?.icon || 'üè™'} ${c?.name || actId} : ${fmt(valAct)}‚Ç¨
                        ${nbEquip > 0 ? `+ ${nbEquip} √©quip. (${fmt(valEquip)}‚Ç¨)` : ''}
                    </p>`;
                }
            });
            
            if (!detailHtml) {
                detailHtml = '<p style="margin: 2px 0; font-size: 0.85rem; color: #6b7280;">Aucune activit√© poss√©d√©e</p>';
            }
            
            if (phase >= 3) {
                // Phase 3 : pas de taxe, juste informatif
                showModal(`
                    <h3>üèõÔ∏è Case Taxe</h3>
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; margin: 10px 0;">
                        <p style="margin: 0; text-align: center; color: #059669;">
                            Phase 3 : taxe Ligne 3 <strong>supprim√©e</strong> ‚úÖ
                        </p>
                    </div>
                `, `<button class="btn btn-primary" onclick="safeNextTurn();">OK ‚úì</button>`);
                return;
            }
            
            // Modal NON fermable par overlay (pas de onclick sur overlay)
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal-overlay">
                    <div class="modal">
                        <h3>üèõÔ∏è Case Taxe ‚Äî D√©claration fiscale</h3>
                        <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin: 10px 0;">
                            <p style="margin: 0; font-weight: bold;">üìä D√©tail de ton patrimoine :</p>
                            ${detailHtml}
                            <hr style="margin: 8px 0; border-color: #fbbf24;">
                            <p style="margin: 4px 0;">Activit√©s : <strong>${fmt(totalActivites)}‚Ç¨</strong></p>
                            <p style="margin: 4px 0;">√âquipements : <strong>${fmt(totalEquipements)}‚Ç¨</strong></p>
                            <p style="margin: 4px 0; font-weight: bold; font-size: 1.05rem;">
                                Total patrimoine : <strong>${fmt(patrimoine)}‚Ç¨</strong>
                            </p>
                            <p style="margin: 8px 0 0 0; text-align: center;">
                                üèõÔ∏è Taxe estim√©e (10%) : <strong>${fmt(taxeEstimee)}‚Ç¨</strong>
                            </p>
                        </div>
                        <div style="background: #fef2f2; padding: 10px; border-radius: 8px; margin: 8px 0;">
                            <p style="margin: 0; text-align: center; font-size: 0.85rem; color: #92400e;">
                                üìã <strong>Validez votre d√©claration</strong> pour payer la taxe normale.<br>
                                Si vous ne validez pas et franchissez la Ligne 3,<br>
                                tirage de d√© : üé≤ 1,3,4,6 = <strong>p√©nalit√© +50%</strong> | üé≤ 2,5 = <strong>r√©duction -20%</strong>
                            </p>
                        </div>
                        <div class="modal-buttons">
                            <div style="display: flex; flex-direction: column; gap: 8px; width: 100%;">
                                <button class="btn btn-primary" style="width: 100%;" 
                                    onclick="validerDeclarationFiscale();">
                                    ‚úÖ Valider ma d√©claration
                                </button>
                                <button class="btn" style="width: 100%; background: #f3f4f6; color: #6b7280;" 
                                    onclick="refuserDeclarationFiscale();">
                                    ‚ùå Passer (je prends le risque)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }
        
        async function validerDeclarationFiscale() {
            closeModal();
            try {
                await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/declarationFiscale`).set(true);
                if (playersData[myPlayerId]) playersData[myPlayerId].declarationFiscale = true;
                sendSystemMessage(`üìã ${myName} valide sa d√©claration fiscale ‚úÖ`);
            } catch(e) {
                console.error('Erreur validation fiscale:', e);
            }
            // Toujours passer au tour suivant
            await nextTurn();
        }
        
        async function refuserDeclarationFiscale() {
            closeModal();
            try {
                await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/declarationFiscale`).set(false);
                if (playersData[myPlayerId]) playersData[myPlayerId].declarationFiscale = false;
                sendSystemMessage(`üìã ${myName} refuse de valider sa d√©claration fiscale ‚ö†Ô∏è`);
            } catch(e) {
                console.error('Erreur refus fiscal:', e);
            }
            // Toujours passer au tour suivant
            await nextTurn();
        }
        
        // ========== LIGNE 3 : Taxe 10% patrimoine au franchissement ==========
        async function handleLigne3(joueurId) {
            const player = playersData[joueurId];
            const caisseBefore = { ...(COMPTABILITE.caisseJoueurs[joueurId] || {}) };
            
            // V√©rifier la d√©claration fiscale
            const declarationFiscale = player?.declarationFiscale === true;
            let modificateur = 1.0;
            let resultatDe = null;
            let deMessage = '';
            
            if (!declarationFiscale) {
                // Pas de d√©claration valid√©e ‚Üí tirage de d√©
                resultatDe = Math.floor(Math.random() * 6) + 1;
                if ([1, 3, 4, 6].includes(resultatDe)) {
                    modificateur = 1.5; // P√©nalit√© +50%
                    deMessage = `üé≤ D√© = ${resultatDe} ‚Üí P√©nalit√© +50% !`;
                } else {
                    modificateur = 0.8; // R√©duction -20%
                    deMessage = `üé≤ D√© = ${resultatDe} ‚Üí Chance ! R√©duction -20%`;
                }
            }
            
            const result = await comptaTaxeLigne3(joueurId, modificateur);
            
            await db.ref(`parties/${currentGameCode}/players/${joueurId}/euro`)
                .set(COMPTABILITE.caisseJoueurs[joueurId].euro);
            // Reset la d√©claration fiscale apr√®s franchissement
            await db.ref(`parties/${currentGameCode}/players/${joueurId}/declarationFiscale`).set(null);
            if (player) player.declarationFiscale = null;
            await syncComptabiliteToFirebase();
            
            logEvent('LIGNE_3_TAX', joueurId, {
                patrimoine: result.patrimoine,
                taxeBase: result.taxeBase,
                taxe: result.taxe,
                modificateur,
                declarationFiscale,
                resultatDe,
                paye: result.paye,
                impaye: result.impaye
            });
            
            // Messages syst√®me
            if (result.taxe > 0) {
                const modLabel = modificateur > 1 ? ' (p√©nalit√© +50%)' : modificateur < 1 ? ' (r√©duction -20%)' : '';
                sendSystemMessage(`üèõÔ∏è ${player?.name} franchit la Ligne 3 : taxe ${fmt(result.taxe)}‚Ç¨${modLabel}`);
                if (result.impaye > 0) {
                    sendSystemMessage(`‚ö†Ô∏è ${player?.name} : taxe impay√©e ${fmt(result.impaye)}‚Ç¨ ‚Üí arri√©r√©s`);
                }
            } else {
                sendSystemMessage(`üèõÔ∏è ${player?.name} franchit la Ligne 3 (patrimoine: ${fmt(0)}‚Ç¨, pas de taxe)`);
            }
            
            // Modal d√©taill√© pour le joueur humain
            if (joueurId === myPlayerId) {
                // D√©tail du patrimoine
                let detailHtml = '';
                let totalActivites = 0;
                let totalEquipements = 0;
                
                Object.entries(COMPTABILITE.caisseActivites || {}).forEach(([actId, act]) => {
                    if (act.proprietaireId === joueurId) {
                        const c = CASES[actId];
                        const valAct = act.capital || c?.prix || 0;
                        const nbEquip = act.equipements || 0;
                        const valEquip = nbEquip * 100;
                        totalActivites += valAct;
                        totalEquipements += valEquip;
                        detailHtml += `<p style="margin: 2px 0; font-size: 0.85rem;">
                            ${c?.icon || 'üè™'} ${c?.name || actId} : ${fmt(valAct)}‚Ç¨
                            ${nbEquip > 0 ? `+ ${nbEquip} √©quip. (${fmt(valEquip)}‚Ç¨)` : ''}
                        </p>`;
                    }
                });
                
                if (!detailHtml) {
                    detailHtml = '<p style="margin: 2px 0; font-size: 0.85rem; color: #6b7280;">Aucune activit√© poss√©d√©e</p>';
                }
                
                // Section d√©claration fiscale
                let fiscalHtml = '';
                if (declarationFiscale) {
                    fiscalHtml = `<div style="background: #f0fdf4; padding: 8px; border-radius: 6px; margin: 8px 0;">
                        <p style="margin: 0; text-align: center; color: #059669;">
                            ‚úÖ D√©claration fiscale valid√©e ‚Üí taxe normale
                        </p>
                    </div>`;
                } else {
                    const deColor = modificateur > 1 ? '#dc2626' : '#059669';
                    const deLabel = modificateur > 1 ? '‚ö†Ô∏è P√©nalit√© +50%' : 'üçÄ R√©duction -20%';
                    fiscalHtml = `<div style="background: #fef2f2; padding: 8px; border-radius: 6px; margin: 8px 0;">
                        <p style="margin: 0; text-align: center;">
                            ‚ùå D√©claration non valid√©e ‚Üí tirage de d√©
                        </p>
                        <p style="margin: 4px 0 0 0; text-align: center; font-size: 1.2rem; font-weight: bold; color: ${deColor};">
                            ${deMessage}
                        </p>
                        <p style="margin: 2px 0 0 0; text-align: center; font-size: 0.85rem; color: ${deColor};">
                            ${deLabel}
                        </p>
                    </div>`;
                }
                
                return new Promise(resolve => {
                    window.__ligne3Resolve = resolve;
                    showModal(`
                        <h3>üèõÔ∏è Ligne 3 ‚Äî Taxe sur le patrimoine</h3>
                        
                        ${fiscalHtml}
                        
                        <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin: 10px 0;">
                            <p style="margin: 0; font-weight: bold;">üìä Calcul du patrimoine :</p>
                            ${detailHtml}
                            <hr style="margin: 8px 0; border-color: #fbbf24;">
                            <p style="margin: 4px 0;">Activit√©s : <strong>${fmt(totalActivites)}‚Ç¨</strong></p>
                            <p style="margin: 4px 0;">√âquipements : <strong>${fmt(totalEquipements)}‚Ç¨</strong></p>
                            <p style="margin: 4px 0; font-weight: bold;">
                                Patrimoine : <strong>${fmt(result.patrimoine)}‚Ç¨</strong>
                            </p>
                        </div>
                        
                        <div style="background: ${result.taxe > 0 ? '#dbeafe' : '#f0fdf4'}; padding: 12px; border-radius: 8px; margin: 8px 0;">
                            <p style="margin: 0;">Taxe base (10%) : <strong>${fmt(result.taxeBase)}‚Ç¨</strong></p>
                            ${modificateur !== 1.0 ? `
                                <p style="margin: 4px 0; color: ${modificateur > 1 ? '#dc2626' : '#059669'};">
                                    ${modificateur > 1 ? '‚ö†Ô∏è +50% p√©nalit√©' : 'üçÄ -20% r√©duction'} ‚Üí <strong>${fmt(result.taxe)}‚Ç¨</strong>
                                </p>
                            ` : ''}
                            ${result.taxe > 0 ? `
                                <hr style="margin: 8px 0; border-color: #93c5fd;">
                                <p style="margin: 4px 0; font-size: 0.9rem;">
                                    üí∞ Cash avant : <strong>${fmt(caisseBefore.euro || 0)}‚Ç¨</strong>
                                </p>
                                ${result.paye > 0 ? `
                                    <p style="margin: 4px 0; color: #059669;">
                                        ‚úÖ Pay√© : <strong>${fmt(result.paye)}‚Ç¨</strong>
                                    </p>
                                ` : ''}
                                ${result.impaye > 0 ? `
                                    <p style="margin: 4px 0; color: #dc2626;">
                                        ‚ö†Ô∏è Arri√©r√©s : <strong>${fmt(result.impaye)}‚Ç¨</strong>
                                    </p>
                                ` : ''}
                                <p style="margin: 4px 0; font-size: 0.9rem;">
                                    üí∞ Cash apr√®s : <strong>${fmt(COMPTABILITE.caisseJoueurs[joueurId]?.euro || 0)}‚Ç¨</strong>
                                </p>
                            ` : `
                                <p style="margin: 4px 0; color: #059669;">‚úÖ Pas de taxe √† payer</p>
                            `}
                        </div>
                    `, `<button class="btn btn-primary" onclick="closeModal(); if(window.__ligne3Resolve){window.__ligne3Resolve(); window.__ligne3Resolve=null;}">OK ‚úì</button>`);
                });
            }
        }
        
        async function handleLigne2(c) {
            const players = Object.values(playersData);
            
            // Charger la comptabilit√© la plus r√©cente depuis Firebase
            await ensurePlayerComptaLoaded();
            
            const ledgerEntryIds = [];
            const playerEffects = [];
            
            for (const p of players) {
                // S'assurer que la caisse du joueur existe avec le bon solde
                if (!COMPTABILITE.caisseJoueurs[p.id]) {
                    initCaisseJoueur(p.id);
                    COMPTABILITE.caisseJoueurs[p.id].euro = p.euro || CONFIG.capitalInitial;
                    console.log(`‚ö†Ô∏è Caisse joueur ${p.name} initialis√©e avec ${COMPTABILITE.caisseJoueurs[p.id].euro}‚Ç¨`);
                }
                
                const soldeBefore = COMPTABILITE.caisseJoueurs[p.id].euro;
                const result = await comptaFrais(p.id, c.cout, c.name);
                if (result?.ledgerEntryIds) ledgerEntryIds.push(...result.ledgerEntryIds);
                
                const soldeAfter = COMPTABILITE.caisseJoueurs[p.id].euro;
                playerEffects.push({ playerId: p.id, name: p.name, before: soldeBefore, after: soldeAfter, paid: c.cout });
                
                await db.ref(`parties/${currentGameCode}/players/${p.id}/euro`).set(soldeAfter);
            }
            await syncComptabiliteToFirebase();
            
            // LOG EVENT: LINE_2_FEE
            logEvent('LINE_2_FEE', myPlayerId, {
                caseId: c.id,
                caseName: c.name,
                amount: c.cout,
                playersAffected: playerEffects.length,
                effects: playerEffects
            }, ledgerEntryIds);
            
            sendSystemMessage(`${c.icon} ${c.name} ! Tout le monde paie ${fmt(c.cout)}‚Ç¨`);
            
            // Afficher le modal avec un timer qui passe au tour suivant automatiquement
            let countdown = 3;
            showModal(`
                <h3>${c.icon} ${c.name}</h3>
                <p style="font-size: 0.9rem; color: #6b7280; font-style: italic; margin: 4px 0 8px 0;">
                    ${c.description || ''}
                </p>
                <p>Tous les joueurs paient <strong>${fmt(c.cout)}‚Ç¨</strong></p>
                <div style="background: #fef3c7; padding: 10px; border-radius: 8px; margin: 10px 0;">
                    ${playerEffects.map(e => `<p style="margin: 3px 0;">${playersData[e.playerId]?.avatar || 'üë§'} ${e.name}: ${fmt(e.before)}‚Ç¨ ‚Üí ${fmt(e.after)}‚Ç¨</p>`).join('')}
                </div>
                <p id="ligne2Countdown" style="text-align: center; color: #6b7280; font-size: 0.9rem;">Tour suivant dans ${countdown}s...</p>
            `, `
                <button class="btn btn-primary" onclick="safeNextTurn();">OK ‚úì</button>
            `);
            
            // Timer auto-nextTurn
            const countdownInterval = setInterval(() => {
                countdown--;
                const el = document.getElementById('ligne2Countdown');
                if (el) el.textContent = `Tour suivant dans ${countdown}s...`;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    closeModal();
                    nextTurn();
                }
            }, 1000);
        }
        
        // ========== TOUR SUIVANT ==========
        let nextTurnInProgress = false;
        let turnActionInProgress = false; // Protection anti-double-lancer
        
        async function nextTurn() {
            // Protection contre les appels multiples avec timeout de s√©curit√©
            if (nextTurnInProgress) {
                console.log('nextTurn d√©j√† en cours, ignor√©');
                return;
            }
            nextTurnInProgress = true;
            
            // Timeout de s√©curit√© - reset apr√®s 10 secondes si bloqu√©
            const safetyTimeout = setTimeout(() => {
                console.warn('‚ö†Ô∏è nextTurn timeout - reset forc√©');
                nextTurnInProgress = false;
                turnActionInProgress = false;
            }, 10000);
            
            try {
                const players = getOrderedPlayers();
                const currentIdx = gameState.currentPlayerIndex || 0;
                const nextIdx = (currentIdx + 1) % players.length;
                
                const isNewRound = nextIdx === 0;
                const newTurn = isNewRound ? (gameState.turn || 1) + 1 : gameState.turn;
                const toursComplets = isNewRound ? (gameState.toursComplets || 0) + 1 : (gameState.toursComplets || 0);
                
                // Int√©r√™ts si nouveau tour complet
                if (isNewRound) {
                    await applyInterests();
                    
                    // LOG EVENT: NEW_ROUND
                    logEvent('NEW_ROUND', null, {
                        turn: newTurn,
                        toursComplets
                    });
                    
                    // Cr√©er un snapshot √† chaque fin de tour complet
                    createSnapshot();
                    console.log(`üì∏ Snapshot cr√©√©: Tour ${newTurn}`);
                }
                
                // Reset compteur actions contributives du joueur qui vient de jouer
                const currentPlayer = players[currentIdx];
                if (currentPlayer) {
                    await db.ref(`parties/${currentGameCode}/players/${currentPlayer.id}/actionContribCeTour`).set(0);
                }
                
                await gameRef.child('state').update({
                    currentPlayerIndex: nextIdx,
                    turn: newTurn,
                    toursComplets: toursComplets
                });
                
                if (isNewRound) {
                    await checkPhaseTransition();
                }
            } catch (err) {
                console.error('Erreur dans nextTurn:', err);
            } finally {
                clearTimeout(safetyTimeout);
                nextTurnInProgress = false;
                turnActionInProgress = false; // D√©verrouiller pour le prochain joueur
            }
        }
        
        // ========== INT√âR√äTS ==========
        async function applyInterests() {
            // ========== √âTAPE 6 : M√©canisme complet fin de tour √âtat ==========
            
            // 1. Comblement d√©couvert Exportation
            await comblerDecouvertExport();
            
            // 2. Int√©r√™ts joueurs : D√âPLAC√â vers handleSalary() et botPlayTurn()
            // Les int√©r√™ts sont maintenant pay√©s individuellement au passage de la Ligne 1
            // (en m√™me temps que le salaire), et non plus collectivement en fin de tour.

            // 3. Emprunt automatique √âtat si tr√©sor n√©gatif
            await empruntAutomatiqueEtat();
            
            // 4. Int√©r√™ts sur dette √âtat
            await calculerEtPayerInteretsEtat();
            
            // 5. V√©rification spirale de dette
            await verifierSpiraleEtat();
            
            await syncComptabiliteToFirebase();
        }
        
        // ========== √âTAPE 6a : Comblement d√©couvert Exportation ==========
        async function comblerDecouvertExport() {
            const soldeExport = COMPTABILITE.exportation.solde || 0;
            
            if (soldeExport < 0) {
                const decouvert = Math.abs(soldeExport);
                
                // L'√âtat comble le d√©couvert
                COMPTABILITE.etat.tresor -= decouvert;
                COMPTABILITE.etat.depenses.comblementExport += decouvert;
                COMPTABILITE.etat.depenses.total += decouvert;
                COMPTABILITE.etat.grandLivre[500] -= decouvert;
                COMPTABILITE.etat.grandLivre[658] += decouvert;
                
                // L'Exportation revient √† 0
                COMPTABILITE.exportation.solde = 0;
                
                // √âcritures
                enregistrerEcriture({
                    joueurId: 'ETAT',
                    libelle: `Comblement d√©couvert Export ${decouvert}‚Ç¨`,
                    compteDebit: 658,   // Charges comblement
                    compteCredit: 500,  // Caisse √âtat
                    montantEuro: decouvert,
                    contexte: 'etat'
                });
                
                enregistrerEcriture({
                    joueurId: 'EXPORTATION',
                    libelle: `Recette comblement √âtat ${decouvert}‚Ç¨`,
                    compteDebit: 540,   // Caisse Export
                    compteCredit: 758,  // Produits divers
                    montantEuro: decouvert,
                    contexte: 'exportation'
                });
                
                sendSystemMessage(`üèõÔ∏è L'√âtat comble le d√©couvert Export: ${fmt(decouvert)}‚Ç¨`);
                
                // Journal √âtat
                COMPTABILITE.etat.journalEtat.push({
                    type: 'COMBLEMENT_EXPORT',
                    montant: decouvert,
                    timestamp: Date.now(),
                    tour: gameState.toursComplets || gameState.turn || 1
                });
            }
        }
        
        // ========== √âTAPE 6b : Emprunt automatique √âtat ==========
        async function empruntAutomatiqueEtat() {
            const tresor = COMPTABILITE.etat.tresor || 0;
            
            if (tresor < 0) {
                const deficit = Math.abs(tresor);
                
                // ========== UTILISER LE CIRCUIT BANCAIRE UNIFI√â ==========
                // M√™me circuit que les joueurs
                const loanId = `LOAN_ETAT_${Date.now()}`;
                
                // 1. Cr√©er le pr√™t via le syst√®me bancaire unifi√©
                banqueCreerPret('ETAT', deficit, loanId);
                
                // 2. MAJ comptabilit√© √âtat
                COMPTABILITE.etat.tresor = 0;  // Revient √† 0
                COMPTABILITE.etat.dette.capital += deficit;
                COMPTABILITE.etat.grandLivre[500] += deficit;
                COMPTABILITE.etat.grandLivre[165] += deficit;
                
                // √âcriture c√¥t√© √âtat
                enregistrerEcriture({
                    joueurId: 'ETAT',
                    libelle: `Emprunt automatique ${deficit}‚Ç¨`,
                    compteDebit: 500,   // Caisse √âtat (+)
                    compteCredit: 165,  // Dette bancaire (+)
                    montantEuro: deficit,
                    contexte: 'etat'
                });
                
                sendSystemMessage(`üèõÔ∏èüí∞ L'√âtat emprunte ${fmt(deficit)}‚Ç¨ √† la banque (dette: ${fmt(COMPTABILITE.etat.dette.capital)}‚Ç¨)`);
                
                // Journal √âtat
                COMPTABILITE.etat.journalEtat.push({
                    type: 'EMPRUNT_AUTO',
                    montant: deficit,
                    detteTotale: COMPTABILITE.etat.dette.capital,
                    timestamp: Date.now(),
                    tour: gameState.toursComplets || gameState.turn || 1
                });
            }
        }
        
        // ========== √âTAPE 6c : Int√©r√™ts sur dette √âtat ==========
        async function calculerEtPayerInteretsEtat() {
            const dette = COMPTABILITE.etat.dette.capital || 0;
            
            if (dette > 0) {
                const tauxInteret = gameConfig?.tauxInteret ?? CONFIG.tauxInteret;
                const interets = Math.floor(dette * tauxInteret);
                
                if (interets > 0) {
                    // V√©rifier si l'√âtat peut payer
                    if (COMPTABILITE.etat.tresor < interets) {
                        // L'√âtat doit emprunter pour payer les int√©r√™ts
                        const manque = interets - COMPTABILITE.etat.tresor;
                        
                        // Utiliser le circuit bancaire unifi√© pour l'emprunt suppl√©mentaire
                        const loanId = `LOAN_ETAT_INT_${Date.now()}`;
                        banqueCreerPret('ETAT', manque, loanId);
                        
                        // MAJ √âtat
                        COMPTABILITE.etat.dette.capital += manque;
                        COMPTABILITE.etat.tresor += manque;
                        COMPTABILITE.etat.grandLivre[500] += manque;
                        COMPTABILITE.etat.grandLivre[165] += manque;
                        
                        enregistrerEcriture({
                            joueurId: 'ETAT',
                            libelle: `Emprunt pour int√©r√™ts ${manque}‚Ç¨`,
                            compteDebit: 500,
                            compteCredit: 165,
                            montantEuro: manque,
                            contexte: 'etat'
                        });
                        
                        sendSystemMessage(`‚ö†Ô∏è L'√âtat emprunte ${fmt(manque)}‚Ç¨ pour payer ses int√©r√™ts !`);
                    }
                    
                    // Paiement des int√©r√™ts - c√¥t√© √âtat
                    COMPTABILITE.etat.tresor -= interets;
                    COMPTABILITE.etat.depenses.interets += interets;
                    COMPTABILITE.etat.depenses.total += interets;
                    COMPTABILITE.etat.dette.interetsCumules += interets;
                    COMPTABILITE.etat.grandLivre[500] -= interets;
                    COMPTABILITE.etat.grandLivre[662] += interets;
                    
                    // Utiliser le circuit bancaire unifi√© pour les int√©r√™ts
                    banqueEncaisserInterets('ETAT', interets);
                    
                    // √âcriture c√¥t√© √âtat seulement (la banque est g√©r√©e par banqueEncaisserInterets)
                    enregistrerEcriture({
                        joueurId: 'ETAT',
                        libelle: `Int√©r√™ts dette √âtat ${interets}‚Ç¨`,
                        compteDebit: 662,   // Charges int√©r√™ts
                        compteCredit: 500,  // Caisse √âtat
                        montantEuro: interets,
                        contexte: 'etat'
                    });
                    
                    sendSystemMessage(`üèõÔ∏èüìà L'√âtat paie ${fmt(interets)}‚Ç¨ d'int√©r√™ts (dette: ${fmt(dette)}‚Ç¨, cumul: ${fmt(COMPTABILITE.etat.dette.interetsCumules)}‚Ç¨)`);
                    
                    // Journal √âtat - utiliser toursComplets au lieu de turn
                    COMPTABILITE.etat.journalEtat.push({
                        type: 'INTERETS_PAYES',
                        montant: interets,
                        detteTotale: COMPTABILITE.etat.dette.capital,
                        interetsCumules: COMPTABILITE.etat.dette.interetsCumules,
                        timestamp: Date.now(),
                        tour: gameState.toursComplets || gameState.turn || 1
                    });
                }
            }
        }
        
        // ========== √âTAPE 6d : V√©rification spirale de dette ==========
        let spiraleModalShown = false;  // Pour ne pas afficher plusieurs fois
        
        async function verifierSpiraleEtat() {
            const dette = COMPTABILITE.etat.dette.capital || 0;
            const interetsPrevus = Math.floor(dette * CONFIG.tauxInteret);
            const recettesMoyennes = calculerRecettesMoyennesEtat();
            
            // Spirale d√©tect√©e si int√©r√™ts > recettes moyennes
            if (interetsPrevus > recettesMoyennes && dette > 500 && !spiraleModalShown) {
                spiraleModalShown = true;
                
                // Journal √âtat
                COMPTABILITE.etat.journalEtat.push({
                    type: 'SPIRALE_DETECTEE',
                    dette,
                    interetsPrevus,
                    recettesMoyennes,
                    timestamp: Date.now(),
                    tour: gameState.turn || 1
                });
                
                // Afficher le modal pour l'h√¥te
                if (isHost) {
                    await showModalSpiraleEtat(dette, interetsPrevus, recettesMoyennes);
                }
            }
        }
        
        function calculerRecettesMoyennesEtat() {
            const tour = gameState.turn || 1;
            if (tour <= 1) return 0;
            
            const totalRecettes = COMPTABILITE.etat.recettes.total || 0;
            return Math.floor(totalRecettes / (tour - 1));
        }
        
        // Modal spirale de dette (validation h√¥te requise)
        function showModalSpiraleEtat(dette, interetsPrevus, recettesMoyennes) {
            return new Promise((resolve) => {
                showModal(`
                    <h3>‚ö†Ô∏è MESURE GOUVERNEMENTALE</h3>
                    <div style="background: #fee2e2; padding: 12px; border-radius: 8px; margin: 10px 0;">
                        <p style="font-weight: bold; color: #dc2626; margin: 0;">
                            ALERTE : La dette de l'√âtat atteint un niveau critique !
                        </p>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin: 10px 0;">
                        <p style="margin: 0 0 8px 0;"><strong>üìä Situation financi√®re :</strong></p>
                        <p style="margin: 4px 0;">‚Ä¢ Dette totale : <strong>${fmt(dette)}‚Ç¨</strong></p>
                        <p style="margin: 4px 0;">‚Ä¢ Int√©r√™ts pr√©vus : <strong>${fmt(interetsPrevus)}‚Ç¨</strong>/tour</p>
                        <p style="margin: 4px 0;">‚Ä¢ Recettes moyennes : <strong>${fmt(recettesMoyennes)}‚Ç¨</strong>/tour</p>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; margin: 10px 0;">
                        <p style="margin: 0; font-weight: bold;">üí° Explication p√©dagogique :</p>
                        <p style="margin: 8px 0 0 0; font-size: 0.9rem;">
                            Les int√©r√™ts d√©passent les recettes fiscales. L'√âtat doit 
                            <strong>emprunter pour payer ses int√©r√™ts</strong>, ce qui 
                            augmente sa dette et donc ses futurs int√©r√™ts.
                        </p>
                        <p style="margin: 8px 0 0 0; font-size: 0.9rem;">
                            C'est l'<strong>effet "boule de neige"</strong> de la dette 
                            publique avec int√©r√™ts compos√©s.
                        </p>
                    </div>
                    
                    <p style="text-align: center; font-size: 0.85rem; color: #6b7280;">
                        La partie continue, mais cette situation illustre les dangers 
                        de l'endettement public avec int√©r√™ts.
                    </p>
                `, `
                    <button class="btn btn-primary" onclick="closeModal(); window.spiraleModalResolve();">
                        J'ai compris - Continuer
                    </button>
                `);
                
                window.spiraleModalResolve = resolve;
            });
        }
        
        // Force le passage au tour suivant (bouton de debug/d√©blocage)
        async function forceNextTurn() {
            if (!isHost) {
                sendSystemMessage(`‚ö†Ô∏è Seul l'h√¥te peut forcer le tour suivant`);
                return;
            }
            
            closeModal();
            stopDecisionTimer();
            sendSystemMessage(`‚è≠Ô∏è Tour forc√© par l'h√¥te`);
            await nextTurn();
        }
        
        // ========== ROBOTS IA ==========
        async function playBotTurn(bot) {
            // Guard: v√©rifier que c'est bien le tour de ce bot
            const players = getOrderedPlayers();
            const idx = gameState?.currentPlayerIndex || 0;
            const expected = players[idx];
            if (!expected || expected.id !== bot.id) {
                console.log(`ü§ñ playBotTurn annul√©: ce n'est plus le tour de ${bot.name} (attendu: ${expected?.name})`);
                return;
            }
            console.log(`ü§ñ playBotTurn: ${bot.name} joue (index=${idx})`);
            
            // ‚îÄ‚îÄ SKIP TOUR BOT ‚îÄ‚îÄ
            const skipSnap = await gameRef.child(`skipTurns/${bot.id}`).once('value');
            const skipCount = skipSnap.val() || 0;
            if (skipCount > 0) {
                // Int√©r√™ts d√©couvert m√™me quand on passe
                const caisseSk = COMPTABILITE.caisseJoueurs[bot.id] || {};
                if ((caisseSk.euro || 0) < 0) {
                    const interetsDec = arrondir2(Math.abs(caisseSk.euro) * 0.03);
                    caisseSk.euro -= interetsDec;
                    await db.ref(`parties/${currentGameCode}/players/${bot.id}/euro`).set(caisseSk.euro);
                    sendSystemMessage(`üìâ ü§ñ ${bot.name} : int√©r√™ts d√©couvert 3% = -${fmt(interetsDec)}‚Ç¨`);
                }
                await gameRef.child(`skipTurns/${bot.id}`).set(skipCount - 1);
                sendSystemMessage(`‚è≠Ô∏è ü§ñ ${bot.name} passe son tour (action contributive)`);
                await syncComptabiliteToFirebase();
                await nextTurn();
                return;
            }
            
            // ‚îÄ‚îÄ INT√âR√äTS D√âCOUVERT 3% BOT ‚îÄ‚îÄ
            const caisseBot = COMPTABILITE.caisseJoueurs[bot.id] || {};
            if ((caisseBot.euro || 0) < 0) {
                const interetsDecBot = arrondir2(Math.abs(caisseBot.euro) * 0.03);
                caisseBot.euro -= interetsDecBot;
                await db.ref(`parties/${currentGameCode}/players/${bot.id}/euro`).set(caisseBot.euro);
                await syncComptabiliteToFirebase();
                sendSystemMessage(`üìâ ü§ñ ${bot.name} : int√©r√™ts d√©couvert 3% = -${fmt(interetsDecBot)}‚Ç¨ (solde: ${fmt(caisseBot.euro)}‚Ç¨)`);
            }
            const profil = PROFILS_IA[bot.botProfil] || PROFILS_IA.EQUILIBRE;
            
            // V√©rifier/d√©finir le sens du bot
            const sensSnap = await gameRef.child(`sensJoueurs/${bot.id}`).once('value');
            let sens = sensSnap.val();
            
            if (sens === null) {
                // Premier tour du bot - choisir un sens al√©atoirement
                sens = Math.random() > 0.5 ? 1 : -1;
                await gameRef.child(`sensJoueurs/${bot.id}`).set(sens);
                const sensText = sens === 1 ? '‚û°Ô∏è horaire' : '‚¨ÖÔ∏è anti-horaire';
                sendSystemMessage(`ü§ñ ${bot.name} choisit le sens ${sensText}`);
            }
            
            const dice = Math.floor(Math.random() * 6) + 1;
            
            // Calculer la position selon le sens du bot
            let newPosition;
            let passedStart = false;
            
            if (sens === 1) {
                newPosition = (bot.position + dice) % CASES.length;
                passedStart = (bot.position + dice) >= CASES.length;
            } else {
                newPosition = (bot.position - dice + CASES.length) % CASES.length;
                passedStart = (bot.position > 0) && (bot.position - dice) <= 0;
            }
            
            // *** BONUS AAA : Si le robot est membre, +50# dans le Pot AAA ***
            const isMembre = COMPTABILITE.potAAA.membres?.includes(bot.id) || bot.membreAAA;
            if (isMembre) {
                await comptaBonusAAALancer(bot.id);
                sendSystemMessage(`${LOGO_AAA} +50# cr√©√©s dans le Pot AAA (${bot.name} membre)`);
            }
            
            // *** ANIMATION : Passer sur chaque case ***
            await animatePassingCases(bot.position, dice, sens);
            
            await db.ref(`parties/${currentGameCode}/players/${bot.id}/position`).set(newPosition);
            
            const sensIcon = sens === 1 ? '‚û°Ô∏è' : '‚¨ÖÔ∏è';
            sendSystemMessage(`ü§ñ ${bot.name} fait ${dice} ${sensIcon} ${CASES[newPosition].name}`);
            
            // *** LIGNE 3 : Taxe 10% patrimoine au franchissement ***
            const passageLigne3Bot = aTraverseLaLigne3(bot.position, newPosition, sens);
            if (passageLigne3Bot) {
                // V√©rifier d√©claration fiscale du bot
                const botDeclaration = bot.declarationFiscale === true;
                let botModificateur = 1.0;
                if (!botDeclaration) {
                    const botDe = Math.floor(Math.random() * 6) + 1;
                    botModificateur = [1, 3, 4, 6].includes(botDe) ? 1.5 : 0.8;
                    const deLabel = botModificateur > 1 ? `p√©nalit√© +50% (üé≤${botDe})` : `r√©duction -20% (üé≤${botDe})`;
                    sendSystemMessage(`üìã ${bot.name} n'avait pas valid√© sa d√©claration ‚Üí ${deLabel}`);
                }
                
                const resultTaxe = await comptaTaxeLigne3(bot.id, botModificateur);
                
                // Reset d√©claration apr√®s franchissement
                await db.ref(`parties/${currentGameCode}/players/${bot.id}/declarationFiscale`).set(null);
                if (playersData[bot.id]) playersData[bot.id].declarationFiscale = null;
                
                if (resultTaxe.taxe > 0) {
                    await db.ref(`parties/${currentGameCode}/players/${bot.id}/euro`)
                        .set(COMPTABILITE.caisseJoueurs[bot.id].euro);
                    await syncComptabiliteToFirebase();
                    const modLabel = botModificateur !== 1.0 ? (botModificateur > 1 ? ' (p√©nalit√©)' : ' (r√©duit)') : '';
                    sendSystemMessage(`üèõÔ∏è ${bot.name} franchit Ligne 3 : taxe ${fmt(resultTaxe.taxe)}‚Ç¨${modLabel}`);
                    if (resultTaxe.impaye > 0) {
                        sendSystemMessage(`‚ö†Ô∏è ${bot.name} : taxe impay√©e ${fmt(resultTaxe.impaye)}‚Ç¨ ‚Üí arri√©r√©s`);
                    }
                }
            }
            
            // Salaire
            if (passedStart) {
                const phase = gameState.phase || 1;
                const deSalaire = Math.floor(Math.random() * 6) + 1;
                const botProfil = bot.profil || 'contributif';
                let pourcentage;
                if (botProfil === 'creatif') {
                    pourcentage = SALARY_CREATIF[deSalaire] || 1;
                } else {
                    pourcentage = SALARY_CONTRIBUTIF[deSalaire] || 1;
                }
                let salaire = Math.floor(CONFIG.salaireBase * pourcentage);
                const salaireAvantErosion = salaire;
                
                // √ârosion phases 2 et 3 (comme pour les joueurs humains)
                if (phase >= 2) {
                    const passagesP2 = (bot.passagesDepuisPhase2 || 0) + 1;
                    const facteurErosion = Math.pow(0.92, passagesP2);
                    salaire = Math.floor(salaire * facteurErosion);
                    
                    await db.ref(`parties/${currentGameCode}/players/${bot.id}/passagesDepuisPhase2`).set(passagesP2);
                    
                    if (phase === 3) {
                        salaire = Math.floor(salaire * 0.80);
                    }
                }
                
                salaire = Math.max(100, salaire);
                
                // Compl√©ment AAA pour les bots membres
                let complementAAA = 0;
                if (isMembre && phase >= 2) {
                    complementAAA = Math.max(0, salaireAvantErosion - salaire);
                    const potDisponible = COMPTABILITE.potAAA.solde || 0;
                    complementAAA = Math.min(complementAAA, potDisponible);
                    
                    if (complementAAA > 0) {
                        initCaisseJoueur(bot.id);
                        COMPTABILITE.caisseJoueurs[bot.id].espoyr += complementAAA;
                        COMPTABILITE.potAAA.solde -= complementAAA;
                        COMPTABILITE.potAAA.circulationHash += complementAAA;
                        
                        enregistrerEcriture({
                            joueurId: bot.id,
                            libelle: `Compl√©ment AAA Phase ${phase}`,
                            compteDebit: 501, compteCredit: 468,
                            montantEspoyr: complementAAA,
                            contexte: 'potAAA'
                        });
                        
                        await db.ref(`parties/${currentGameCode}/players/${bot.id}/espoyr`)
                            .set(COMPTABILITE.caisseJoueurs[bot.id].espoyr);
                    }
                }
                
                await comptaSalaire(bot.id, salaire, deSalaire);
                const caisse = COMPTABILITE.caisseJoueurs[bot.id];
                await db.ref(`parties/${currentGameCode}/players/${bot.id}/euro`).set(caisse.euro);
                
                // Incr√©menter passages individuels + compteur global
                const passagesBot = (bot.passagesDepart || 0) + 1;
                await db.ref(`parties/${currentGameCode}/players/${bot.id}/passagesDepart`).set(passagesBot);
                const totalPassages = (gameState.passagesLigne1Total || 0) + 1;
                await gameRef.child('state/passagesLigne1Total').set(totalPassages);
                
                // ========== INT√âR√äTS + REMBOURSEMENT AU PASSAGE LIGNE 1 ==========
                // V√©rifier emprunt dans COMPTABILITE ou dans Firebase (bot)
                const empruntActuel = caisse.emprunt || bot.emprunt || 0;
                if (empruntActuel > 0) {
                    // Synchroniser emprunt dans la caisse si n√©cessaire
                    if (!caisse.emprunt && bot.emprunt) {
                        caisse.emprunt = bot.emprunt;
                    }
                    
                    // 1) Int√©r√™ts
                    const tauxInteret = gameConfig?.tauxInteret ?? CONFIG.tauxInteret;
                    const interet = Math.floor(empruntActuel * tauxInteret);
                    if (interet > 0) {
                        const resInterets = await comptaInterets(bot.id, interet);
                        
                        if (resInterets.montantImpaye > 0) {
                            sendSystemMessage(`üìà ${bot.name} : int√©r√™ts ${fmt(interet)}‚Ç¨ (pay√©s: ${fmt(resInterets.montantPaye)}‚Ç¨, capitalis√©s: ${fmt(resInterets.montantImpaye)}‚Ç¨)`);
                        } else {
                            sendSystemMessage(`üìâ ${bot.name} : int√©r√™ts pay√©s ${fmt(interet)}‚Ç¨`);
                        }
                    }
                    
                    // 2) Remboursement automatique d'une partie du capital (ind√©pendant des int√©r√™ts)
                    const pct = (gameConfig?.remboursementAutoCapitalPct ?? CONFIG.remboursementAutoCapitalPct ?? 0);
                    const cible = Math.floor(caisse.emprunt * pct);
                    if (cible > 0 && caisse.euro > 0) {
                        const remboursement = Math.min(cible, caisse.euro, caisse.emprunt);
                        if (remboursement > 0) {
                            await comptaRemboursement(bot.id, remboursement);
                            sendSystemMessage(`üí≥ ${bot.name} : remboursement capital ${fmt(remboursement)}‚Ç¨ (dette: ${fmt(caisse.emprunt)}‚Ç¨)`);
                        }
                    }
                    
                    // Mise √† jour Firebase
                    await db.ref(`parties/${currentGameCode}/players/${bot.id}/euro`).set(caisse.euro);
                    await db.ref(`parties/${currentGameCode}/players/${bot.id}/emprunt`).set(caisse.emprunt);
                }
                
                // ========== REMBOURSEMENT CR√âANCES AAA (BOT) ==========
                const detteAAABot = COMPTABILITE.potAAA?.creances?.[bot.id] || 0;
                if (detteAAABot > 0) {
                    const caisseBot = COMPTABILITE.caisseJoueurs[bot.id];
                    if ((caisseBot.espoyr || 0) >= detteAAABot) {
                        caisseBot.espoyr -= detteAAABot;
                        COMPTABILITE.potAAA.solde += detteAAABot;
                        COMPTABILITE.potAAA.creances[bot.id] = 0;
                        await db.ref(`parties/${currentGameCode}/players/${bot.id}/espoyr`).set(caisseBot.espoyr);
                        
                        // √âcriture bot: rembourse sa dette AAA en #
                        enregistrerEcriture({
                            joueurId: bot.id,
                            libelle: `Remboursement cr√©ance AAA (${fmt(detteAAABot)}#)`,
                            compteDebit: 44,    // Dette Coop AAA (passif -) = dette diminue
                            compteCredit: 501,  // Caisse # (actif -) = # sortent
                            montantEspoyr: detteAAABot,
                            contexte: 'potAAA'
                        });
                        
                        // √âcriture Pot AAA: re√ßoit le remboursement
                        enregistrerEcriture({
                            joueurId: 'POT_AAA',
                            libelle: `Remboursement cr√©ance de ${bot.name}`,
                            compteDebit: 580,   // Caisse Pot AAA (actif +) = # entrent
                            compteCredit: 48,   // Cr√©ances Pot AAA (actif -) = cr√©ance diminue
                            montantEspoyr: detteAAABot,
                            contexte: 'potAAA'
                        });
                        
                        sendSystemMessage(`${LOGO_AAA} ${bot.name} rembourse ${fmt(detteAAABot)}# au Pot AAA`);
                    } else {
                        sendSystemMessage(`‚è≥ ${bot.name} : cr√©ance AAA ${fmt(detteAAABot)}# en attente (pas assez de #)`);
                    }
                }
                
                // ========== REMBOURSEMENT DETTES ENTRE JOUEURS (BOT) ==========
                const botDettes = (COMPTABILITE.dettesEntreJoueurs || []).filter(d => d.debiteurId === bot.id);
                if (botDettes.length > 0) {
                    const botReportResult = await rembourserDettesEntreJoueurs(bot.id);
                    if (botReportResult.rembourse > 0) {
                        sendSystemMessage(`üìú ${bot.name} rembourse ${fmt(botReportResult.rembourse)}‚Ç¨ de reports`);
                    }
                    if (botReportResult.restant > 0) {
                        sendSystemMessage(`‚è≥ ${bot.name} : ${fmt(botReportResult.restant)}‚Ç¨ de reports non rembours√©s`);
                    }
                }
                
                // ========== MENSUALIT√âS BIENS PERSONNELS (BOT) ==========
                if (caisse.dettesPersonnelles && caisse.dettesPersonnelles.length > 0) {
                    const botMensResult = await payerMensualitesPersonnelles(bot.id);
                    if (botMensResult.totalPaye > 0) {
                        sendSystemMessage(`üè† ${bot.name} : mensualit√©s ${fmt(botMensResult.totalPaye)}‚Ç¨`);
                    }
                    if (botMensResult.totalImpaye > 0) {
                        sendSystemMessage(`‚ö†Ô∏è ${bot.name} : mensualit√©s impay√©es ${fmt(botMensResult.totalImpaye)}‚Ç¨ ‚Üí arri√©r√©s`);
                    }
                }
                
                // ========== SMART CONTRACTS (BOT) ==========
                const botSCs = (COMPTABILITE.smartContracts || []).filter(sc => sc.debiteurId === bot.id && !sc.rembourse);
                if (botSCs.length > 0) {
                    const botSCResult = await rembourserSmartContracts(bot.id);
                    for (const r of botSCResult.rembourse) {
                        sendSystemMessage(`üìú ${bot.name} rembourse ${r.euro > 0 ? fmt(r.euro)+'‚Ç¨' : ''}${r.hash > 0 ? ' '+fmt(r.hash)+'#' : ''} √† ${r.creancierName}`);
                    }
                    for (const a of botSCResult.arrieres) {
                        sendSystemMessage(`‚ö†Ô∏è ${bot.name} ne peut rembourser ‚Üí arri√©r√©s envers ${a.creancierName}`);
                    }
                }
                
                // ========== ARRI√âR√âS (BOT) ==========
                if ((caisse.impaye || 0) > 0) {
                    const botArrResult = await payerArrieres(bot.id);
                    if (botArrResult.paye > 0) {
                        sendSystemMessage(`üí∏ ${bot.name} paie ${fmt(botArrResult.paye)}‚Ç¨ d'arri√©r√©s`);
                    }
                }
                
                await syncComptabiliteToFirebase();
                
                if (complementAAA > 0) {
                    sendSystemMessage(`üí∞ ${bot.name} re√ßoit ${fmt(salaire)}‚Ç¨ + ${LOGO_AAA}${fmt(complementAAA)}# (compl√©ment AAA)`);
                } else {
                    sendSystemMessage(`üí∞ ${bot.name} re√ßoit ${fmt(salaire)}‚Ç¨${phase >= 2 ? ' (√©rosion)' : ''}`);
                }
            }
            
            // G√©rer case
            await handleBotLanding(bot.id, newPosition, profil);
        }
        
        async function handleBotLanding(botId, position, profil) {
            const c = CASES[position];
            initCaisseJoueur(botId);  // S'assurer que la caisse existe
            const caisse = COMPTABILITE.caisseJoueurs[botId];
            const bot = playersData[botId];
            
            // Synchroniser caisse avec Firebase si n√©cessaire
            if (!caisse.euro && bot.euro) {
                caisse.euro = bot.euro;
            }
            
            if (c.type === 'activite') {
                const activitesSnap = await gameRef.child('activites').once('value');
                const activites = activitesSnap.val() || {};
                const owner = activites[position];
                
                if (!owner && (caisse.euro || 0) >= c.prix) {
                    // D√©cision achat
                    const shouldBuy = profil.acheteToujours || (caisse.euro || 0) >= c.prix * 1.5;
                    if (shouldBuy) {
                        await comptaAchatActivite(botId, position, c.prix);
                        const newCaisse = COMPTABILITE.caisseJoueurs[botId];
                        await db.ref(`parties/${currentGameCode}/players/${botId}`).update({
                            euro: newCaisse.euro, espoyr: newCaisse.espoyr
                        });
                        await gameRef.child(`activites/${position}`).set(botId);
                        await syncComptabiliteToFirebase();
                        
                        sendSystemMessage(`ü§ñ ${bot.name} ach√®te ${c.icon} ${c.name}`);
                        
                        // ========== √âQUIPER IMM√âDIATEMENT APR√àS ACHAT ==========
                        const euroApresAchat = newCaisse.euro || 0;
                        const prixEquipMin = getPrixB(position);
                        
                        if (euroApresAchat >= prixEquipMin) {
                            // Le robot peut √©quiper imm√©diatement
                            let shouldEquipNow = false;
                            
                            if (profil.id === 'PREDATEUR' || profil.id === 'INVESTISSEUR') {
                                shouldEquipNow = true;
                            } else if (profil.id === 'EQUILIBRE') {
                                shouldEquipNow = euroApresAchat >= prixEquipMin * 1.3;
                            } else if (profil.id === 'COOPERATIF' || profil.id === 'SOLIDAIRE') {
                                shouldEquipNow = Math.random() > 0.5 && euroApresAchat >= prixEquipMin * 1.5;
                            }
                            // PRUDENT n'√©quipe pas imm√©diatement
                            
                            if (shouldEquipNow) {
                                // Choix type: A si Phase 2+ et membre AAA
                                const checkANow = peutAcheterA(position, [], botId);
                                const checkBNow = peutAcheterB(position, [], botId);
                                
                                let typeEquip = null;
                                if (checkANow.ok && (profil.id !== 'PRUDENT')) typeEquip = 'A';
                                else if (checkBNow.ok) typeEquip = 'B';
                                
                                if (typeEquip === 'A') {
                                    try {
                                        const resA = await comptaAchatEquipementA(botId, position);
                                        const caisseApresEquip = COMPTABILITE.caisseJoueurs[botId];
                                        await db.ref(`parties/${currentGameCode}/players/${botId}`).update({ euro: caisseApresEquip.euro, espoyr: caisseApresEquip.espoyr });
                                        const actUp = COMPTABILITE.caisseActivites[position] || {};
                                        const types = [...Array(actUp.equipementA || 0).fill('A'), ...Array(actUp.equipementB || 0).fill('B')];
                                        await gameRef.child(`equipements/${position}`).set(types.length);
                                        await gameRef.child(`equipementTypes/${position}`).set(types);
                                        equipementsCeTour[position] = gameState?.toursComplets || 0;
                                        await syncComptabiliteToFirebase();
                                        sendSystemMessage(`ü§ñüåø ${bot.name} √©quipe imm√©diatement ${c.icon} (A: ${fmt(resA.cout)}‚Ç¨) +${fmt(resA.bonusHash)}#`);
                                    } catch(e) { console.warn('‚ö†Ô∏è comptaEquipA bot:', e); }
                                } else if (typeEquip === 'B') {
                                    try {
                                        const resB = await comptaAchatEquipementB(botId, position);
                                        const caisseApresEquip = COMPTABILITE.caisseJoueurs[botId];
                                        await db.ref(`parties/${currentGameCode}/players/${botId}/euro`).set(caisseApresEquip.euro);
                                        const actUp = COMPTABILITE.caisseActivites[position] || {};
                                        const types = [...Array(actUp.equipementA || 0).fill('A'), ...Array(actUp.equipementB || 0).fill('B')];
                                        await gameRef.child(`equipements/${position}`).set(types.length);
                                        await gameRef.child(`equipementTypes/${position}`).set(types);
                                        equipementsCeTour[position] = gameState?.toursComplets || 0;
                                        await syncComptabiliteToFirebase();
                                        sendSystemMessage(`ü§ñ‚ùÑÔ∏è ${bot.name} √©quipe imm√©diatement ${c.icon} (B: ${fmt(resB.cout)}‚Ç¨)`);
                                    } catch(e) { console.warn('‚ö†Ô∏è comptaEquipB bot:', e); }
                                }
                            }
                        }
                    }
                } else if (owner === botId) {
                    // ========== √âQUIPEMENT ROBOT ==========
                    const act = COMPTABILITE.caisseActivites?.[position] || {};
                    const nbA = act.equipementA || 0;
                    const nbB = act.equipementB || 0;
                    const total = nbA + nbB;
                    const equipList = [...Array(nbA).fill('A'), ...Array(nbB).fill('B')];
                    
                    // V√©rifier limite √©quipement par tour
                    const tourActuel = gameState?.toursComplets || 0;
                    const dernierEquipTour = equipementsCeTour[position];
                    const dejaEquipeCeTour = (dernierEquipTour === tourActuel);
                    const phase = gameState?.phase || 1;
                    
                    if (dejaEquipeCeTour) {
                        sendSystemMessage(`ü§ñ ${bot.name} sur ${c.icon} - d√©j√† √©quip√© ce tour`);
                    } else if (total >= 3) {
                        sendSystemMessage(`ü§ñ ${bot.name} sur ${c.icon} - d√©j√† 3 √©quipements`);
                    } else {
                        // D√©cision √©quipement selon profil
                        let shouldEquip = false;
                        const prixMin = getPrixB(position);
                        
                        if (profil.id === 'PREDATEUR' || profil.id === 'INVESTISSEUR') {
                            shouldEquip = (caisse.euro || 0) >= prixMin;
                        } else if (profil.id === 'PRUDENT') {
                            shouldEquip = (caisse.euro || 0) >= prixMin * 2;
                        } else if (profil.id === 'COOPERATIF' || profil.id === 'SOLIDAIRE') {
                            shouldEquip = Math.random() > 0.5 && (caisse.euro || 0) >= prixMin * 1.5;
                        } else {
                            shouldEquip = (caisse.euro || 0) >= prixMin * 1.3;
                        }
                        
                        if (shouldEquip) {
                            // Choix type: pr√©f√©rer A si possible (Phase 2+, membre AAA, etc)
                            const checkA = peutAcheterA(position, equipList, botId);
                            const checkB = peutAcheterB(position, equipList, botId);
                            const checkConv = peutConvertirBtoA(position, equipList, botId);
                            
                            let action = null;
                            if (profil.id === 'COOPERATIF' || profil.id === 'SOLIDAIRE' || profil.id === 'INVESTISSEUR') {
                                // Pr√©f√®rent A et conversion
                                if (checkConv.ok) action = 'CONV';
                                else if (checkA.ok) action = 'A';
                                else if (checkB.ok) action = 'B';
                            } else if (profil.id === 'PREDATEUR') {
                                if (checkA.ok) action = 'A';
                                else if (checkB.ok) action = 'B';
                            } else if (profil.id === 'PRUDENT') {
                                if (checkB.ok) action = 'B';  // Prudent pr√©f√®re B (moins cher)
                                else if (checkA.ok) action = 'A';
                            } else {
                                // EQUILIBRE: al√©atoire
                                if (checkA.ok && Math.random() > 0.4) action = 'A';
                                else if (checkB.ok) action = 'B';
                                else if (checkA.ok) action = 'A';
                            }
                            
                            if (action === 'A') {
                                const result = await comptaAchatEquipementA(botId, position);
                                const newCaisse = COMPTABILITE.caisseJoueurs[botId];
                                await db.ref(`parties/${currentGameCode}/players/${botId}`).update({ euro: newCaisse.euro, espoyr: newCaisse.espoyr });
                                const actUp = COMPTABILITE.caisseActivites[position] || {};
                                const types = [...Array(actUp.equipementA || 0).fill('A'), ...Array(actUp.equipementB || 0).fill('B')];
                                await gameRef.child(`equipements/${position}`).set(types.length);
                                await gameRef.child(`equipementTypes/${position}`).set(types);
                                equipementsCeTour[position] = tourActuel;
                                await syncComptabiliteToFirebase();
                                sendSystemMessage(`ü§ñüåø ${bot.name} ach√®te A sur ${c.icon} (${fmt(result.cout)}‚Ç¨) +${fmt(result.bonusHash)}#`);
                            } else if (action === 'B') {
                                const result = await comptaAchatEquipementB(botId, position);
                                const newCaisse = COMPTABILITE.caisseJoueurs[botId];
                                await db.ref(`parties/${currentGameCode}/players/${botId}/euro`).set(newCaisse.euro);
                                const actUp = COMPTABILITE.caisseActivites[position] || {};
                                const types = [...Array(actUp.equipementA || 0).fill('A'), ...Array(actUp.equipementB || 0).fill('B')];
                                await gameRef.child(`equipements/${position}`).set(types.length);
                                await gameRef.child(`equipementTypes/${position}`).set(types);
                                equipementsCeTour[position] = tourActuel;
                                await syncComptabiliteToFirebase();
                                sendSystemMessage(`ü§ñ‚ùÑÔ∏è ${bot.name} ach√®te B sur ${c.icon} (${fmt(result.cout)}‚Ç¨)`);
                            } else if (action === 'CONV') {
                                const result = await comptaConversionBtoA(botId, position);
                                const newCaisse = COMPTABILITE.caisseJoueurs[botId];
                                await db.ref(`parties/${currentGameCode}/players/${botId}`).update({ euro: newCaisse.euro, espoyr: newCaisse.espoyr });
                                const actUp = COMPTABILITE.caisseActivites[position] || {};
                                const types = [...Array(actUp.equipementA || 0).fill('A'), ...Array(actUp.equipementB || 0).fill('B')];
                                await gameRef.child(`equipements/${position}`).set(types.length);
                                await gameRef.child(`equipementTypes/${position}`).set(types);
                                equipementsCeTour[position] = tourActuel;
                                await syncComptabiliteToFirebase();
                                sendSystemMessage(`ü§ñüîÑ ${bot.name} convertit B‚ÜíA sur ${c.icon} (${fmt(result.cout)}‚Ç¨) +${fmt(result.bonusHash)}#`);
                            } else {
                                sendSystemMessage(`ü§ñ ${bot.name} sur ${c.icon} - aucune option disponible`);
                            }
                        } else {
                            sendSystemMessage(`ü§ñ ${bot.name} sur ${c.icon} - d√©cide de ne pas √©quiper`);
                        }
                    }
                } else if (owner && owner !== botId) {
                    const equipTypesSnap = await gameRef.child(`equipementTypes/${position}`).once('value');
                    const equipTypesList = equipTypesSnap.val() || [];
                    const facture = calculerFactureActivite(position, equipTypesList);
                    const phase = gameState?.phase || 1;
                    const botEuro = caisse.euro || 0;
                    const botHash = caisse.espoyr || 0;
                    
                    if (botEuro >= facture) {
                        // Cas 1: Assez d'‚Ç¨
                        await comptaPaiementFacture(botId, owner, position, facture, 0);
                        sendSystemMessage(`ü§ñ ${bot.name} paie ${fmt(facture)}‚Ç¨ √† ${playersData[owner]?.name}`);
                    } else if (phase >= 2 && botHash >= facture && CASES[position]?.hash) {
                        // Cas 2: Payer en # (Phase 2+ et activit√© accepte #)
                        await comptaPaiementFacture(botId, owner, position, 0, facture);
                        sendSystemMessage(`ü§ñ ${bot.name} paie ${fmt(facture)}# √† ${playersData[owner]?.name}`);
                    } else if (phase >= 2 && isMembre && (bot.actionContribCeTour || 0) < 2 && (COMPTABILITE.potAAA?.solde || 0) >= 190) {
                        // Cas 3: Action Contributive (Phase 2+, membre AAA)
                        const travail = TRAVAUX_COOP[Math.floor(Math.random() * TRAVAUX_COOP.length)];
                        if ((COMPTABILITE.potAAA?.solde || 0) >= travail.gain) {
                            // Recevoir # du Pot AAA
                            initCaisseJoueur(botId);
                            caisse.espoyr += travail.gain;
                            COMPTABILITE.potAAA.solde -= travail.gain;
                            COMPTABILITE.potAAA.circulationHash += travail.gain;
                            enregistrerEcriture({
                                joueurId: botId, libelle: `Action contributive: ${travail.nom}`,
                                compteDebit: 501, compteCredit: 468, montantEspoyr: travail.gain, activiteId: position
                            });
                            // Payer la facture en #
                            const montantHash = Math.min(travail.gain, facture);
                            initCaisseJoueur(owner);
                            caisse.espoyr -= montantHash;
                            COMPTABILITE.caisseJoueurs[owner].espoyr += montantHash;
                            // Compl√©ment en d√©couvert si n√©cessaire
                            if (travail.gain < facture) {
                                const resteEuro = facture - travail.gain;
                                caisse.euro -= resteEuro;
                                const montantHT = Math.round(resteEuro / 1.21 * 100) / 100;
                                COMPTABILITE.caisseJoueurs[owner].euro += montantHT;
                                COMPTABILITE.etat.tresor += (resteEuro - montantHT);
                            }
                            // Skip tour + compteur
                            const skipSnap = await gameRef.child(`skipTurns/${botId}`).once('value');
                            await gameRef.child(`skipTurns/${botId}`).set((skipSnap.val() || 0) + 1);
                            await db.ref(`parties/${currentGameCode}/players/${botId}/actionContribCeTour`).set((bot.actionContribCeTour || 0) + 1);
                            await db.ref(`parties/${currentGameCode}/players/${botId}/euro`).set(caisse.euro);
                            await db.ref(`parties/${currentGameCode}/players/${botId}/espoyr`).set(caisse.espoyr);
                            await db.ref(`parties/${currentGameCode}/players/${owner}/espoyr`).set(COMPTABILITE.caisseJoueurs[owner].espoyr);
                            sendSystemMessage(`ü§ù ü§ñ ${bot.name} : "${travail.nom}" (+${fmt(travail.gain)}#) ‚Üí paie ${fmt(Math.min(travail.gain, facture))}# (passe prochain tour)`);
                        }
                    } else {
                        // Cas 4: Emprunter si possible, sinon d√©couvert (toujours payer la totalit√©)
                        const manque = facture - Math.max(0, botEuro);
                        const nbJoueurs = Object.values(playersData).length || 1;
                        const masseMonetaire = COMPTABILITE.banque.masseMonetaire || 0;
                        const limiteEmprunt = Math.max(750, Math.floor(masseMonetaire / nbJoueurs));
                        const detteActuelle = caisse.emprunt || bot.emprunt || 0;
                        const capaciteEmprunt = limiteEmprunt - detteActuelle;
                        const peutEmprunter = profil.id !== 'PRUDENT' && capaciteEmprunt >= manque && manque > 0;
                        
                        if (peutEmprunter) {
                            await comptaEmprunt(botId, manque);
                            await comptaPaiementFacture(botId, owner, position, facture, 0);
                            sendSystemMessage(`ü§ñ ${bot.name} emprunte ${fmt(manque)}‚Ç¨ et paie ${fmt(facture)}‚Ç¨`);
                        } else {
                            // D√âCOUVERT : le bot paie la totalit√©, solde passe en n√©gatif
                            await comptaPaiementFacture(botId, owner, position, facture, 0);
                            sendSystemMessage(`ü§ñ ${bot.name} paie ${fmt(facture)}‚Ç¨ (d√©couvert: ${fmt(caisse.euro)}‚Ç¨)`);
                        }
                    }
                    
                    // ========== SURPLUS ‚Ç¨‚Üí# POUR BOTS ==========
                    // Profils Coop√©ratif/Solidaire/√âquilibr√© tentent un surplus si conditions remplies
                    const botProfilSurplus = ['COOPERATIF', 'SOLIDAIRE', 'EQUILIBRE'].includes(profil.id);
                    if (botProfilSurplus) {
                        const botCaisseApres = COMPTABILITE.caisseJoueurs[botId];
                        const excessEuro = (botCaisseApres.euro || 0);
                        const ownerPlayer = playersData[owner];
                        const ownerEspoyr = COMPTABILITE.caisseJoueurs[owner]?.espoyr || 0;
                        
                        // Le propri√©taire doit accepter : bot Coop√©ratif/Solidaire/√âquilibr√© ou humain (skip humain pour les bots)
                        let ownerAccepte = false;
                        if (ownerPlayer?.isBot) {
                            const ownerProfilId = ownerPlayer?.profilIA || 'PREDATEUR';
                            ownerAccepte = ['COOPERATIF', 'SOLIDAIRE', 'EQUILIBRE'].includes(ownerProfilId);
                        }
                        // Pas de surplus bot‚Üíhumain (n√©cessiterait n√©gociation async)
                        
                        if (ownerAccepte && excessEuro >= 1 && ownerEspoyr >= 0.5) {
                            // Montant: Coop√©ratif/Solidaire = 50% de l'exc√®s, √âquilibr√© = 25%
                            const pctSurplus = profil.id === 'EQUILIBRE' ? 0.25 : 0.50;
                            let surplusBot = Math.round(Math.min(excessEuro * pctSurplus, ownerEspoyr) * 2) / 2; // arrondi 0.5
                            surplusBot = arrondir2(surplusBot);
                            
                            if (surplusBot >= 0.5) {
                                await comptaSurplusEuroHash(botId, owner, position, surplusBot);
                                sendSystemMessage(`üí± ü§ñ ${bot.name} surplus ${fmt(surplusBot)}‚Ç¨‚Üí${fmt(surplusBot)}# avec ${ownerPlayer.name}`);
                            }
                        }
                    }
                    
                    const botCaisse = COMPTABILITE.caisseJoueurs[botId];
                    
                    await db.ref(`parties/${currentGameCode}/players/${botId}`).update({
                        euro: botCaisse.euro, espoyr: botCaisse.espoyr || 0, emprunt: botCaisse.emprunt || 0
                    });
                    if (owner !== botId) {
                        const ownerCaisseSync = COMPTABILITE.caisseJoueurs[owner];
                        await db.ref(`parties/${currentGameCode}/players/${owner}`).update({
                            euro: ownerCaisseSync?.euro ?? ((playersData[owner]?.euro || 0) + facture),
                            espoyr: ownerCaisseSync?.espoyr ?? (playersData[owner]?.espoyr || 0)
                        });
                    }
                    await syncComptabiliteToFirebase();
                }
            } else if (c.type === 'frais' || c.type === 'ligne2') {
                const cout = c.cout || 50;
                if (c.type === 'ligne2') {
                    const players = Object.values(playersData);
                    for (const p of players) {
                        await comptaFrais(p.id, cout, c.name);
                        const pCaisse = COMPTABILITE.caisseJoueurs[p.id];
                        await db.ref(`parties/${currentGameCode}/players/${p.id}/euro`).set(Math.max(0, pCaisse.euro));
                    }
                } else {
                    await comptaFrais(botId, cout, c.name);
                    const newCaisse = COMPTABILITE.caisseJoueurs[botId];
                    await db.ref(`parties/${currentGameCode}/players/${botId}/euro`).set(Math.max(0, newCaisse.euro));
                }
                await syncComptabiliteToFirebase();
            } else if (c.type === 'taxe') {
                // Case Taxe : le bot valide automatiquement sa d√©claration fiscale
                await db.ref(`parties/${currentGameCode}/players/${botId}/declarationFiscale`).set(true);
                if (playersData[botId]) playersData[botId].declarationFiscale = true;
                sendSystemMessage(`üìã ${bot.name} valide sa d√©claration fiscale ‚úÖ`);
            } else if (c.type === 'chance') {
                const card = CHANCE_CARDS[Math.floor(Math.random() * CHANCE_CARDS.length)];
                if (!card.all) {
                    await comptaChance(botId, card.amount, true);
                    const newCaisse = COMPTABILITE.caisseJoueurs[botId];
                    await db.ref(`parties/${currentGameCode}/players/${botId}/euro`).set(newCaisse.euro);
                    await syncComptabiliteToFirebase();
                }
            } else if (c.type === 'malchance') {
                // Bot: acquisition bien personnel (m√™me logique que humain)
                const de = Math.floor(Math.random() * 6) + 1;
                const bien = BIENS_MALCHANCE[de - 1];
                
                initCaisseJoueur(botId);
                const botCaisse = COMPTABILITE.caisseJoueurs[botId];
                
                botCaisse.biensPersonnels.push({
                    bienId: bien.id, nom: bien.nom, icon: bien.icon,
                    valeur: bien.valeur, tourAchat: gameState?.toursComplets || 0
                });
                
                botCaisse.dettesPersonnelles.push({
                    bienId: bien.id, nom: bien.nom, icon: bien.icon,
                    mensualite: bien.mensualite, toursRestants: bien.duree,
                    capitalRestant: bien.total, tauxInteret: bien.interets
                });
                
                enregistrerEcriture({
                    joueurId: botId,
                    libelle: `Acquisition ${bien.icon} ${bien.nom} (dette: ${fmt(bien.total)}‚Ç¨)`,
                    compteDebit: 231, compteCredit: 400, montantEuro: bien.total,
                    contexte: 'bienPersonnel',
                    details: { bienId: bien.id, nom: bien.nom }
                });
                
                await syncComptabiliteToFirebase();
                sendSystemMessage(`üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${bot.name} acquiert ${bien.icon} ${bien.nom} (${fmt(bien.mensualite)}‚Ç¨/tour)`);
            }
            
            setTimeout(() => nextTurn(), 1000);
        }
        
        // ========== MODALS COMPTABILIT√â ==========
        
        function showComptaModal() {
            const journal = COMPTABILITE.journal.slice(-20).reverse();
            
            const rows = journal.map(e => `
                <div class="journal-entry">
                    <small style="color:#9ca3af;">#${e.id} T${e.tour}</small>
                    <strong>${e.joueurNom}</strong>: ${e.libelle}<br>
                    <span style="color:#ef4444;">D:${e.debit.compte} ${e.debit.nom}</span> |
                    <span style="color:#10b981;">C:${e.credit.compte} ${e.credit.nom}</span>
                    <span style="float:right;">${fmt(e.debit.euro)}‚Ç¨ ${fmt(e.debit.espoyr)}#</span>
                </div>
            `).join('');
            
            showModal(`
                <h3>üìí Journal Comptable</h3>
                <p style="font-size: 0.8rem; color: var(--gray);">${COMPTABILITE.journal.length} √©critures au total</p>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${rows || '<p style="color: var(--gray);">Aucune √©criture</p>'}
                </div>
            `, `
                <button class="btn" style="background:#dbeafe; color:#2563eb;" onclick="exportJournalCSV()">üì• Export CSV</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `);
        }
        
        // ========== RELEV√â DE COMPTE (Entr√©es / Sorties / Solde) ==========
        function showReleveCompteModal(joueurIdCible) {
            const joueurId = joueurIdCible || myPlayerId;
            const joueurNom = playersData[joueurId]?.name || joueurId;
            const joueurAvatar = playersData[joueurId]?.avatar || '‚¨ú';
            
            // Parcourir le journal pour construire le relev√©
            // Compte 500 = Caisse ‚Ç¨ : D√©bit = entr√©e ‚Ç¨, Cr√©dit = sortie ‚Ç¨
            // Compte 501 = Caisse # : D√©bit = entr√©e #, Cr√©dit = sortie #
            const lignes = [];
            let soldeEuro = 0;
            let soldeHash = 0;
            let totalEntreesEuro = 0;
            let totalSortiesEuro = 0;
            let totalEntreesHash = 0;
            let totalSortiesHash = 0;
            
            for (const e of COMPTABILITE.journal) {
                if (e.joueurId !== joueurId) continue;
                
                let entreeEuro = 0, sortieEuro = 0, entreeHash = 0, sortieHash = 0;
                
                // ‚Ç¨ : compte 500 (Caisse)
                if (e.debit.compte === 500 && e.debit.euro > 0) {
                    entreeEuro = e.debit.euro;
                }
                if (e.credit.compte === 500 && e.credit.euro > 0) {
                    sortieEuro = e.credit.euro;
                }
                
                // # : compte 501 (Caisse #)
                if (e.debit.compte === 501 && e.debit.espoyr > 0) {
                    entreeHash = e.debit.espoyr;
                }
                if (e.credit.compte === 501 && e.credit.espoyr > 0) {
                    sortieHash = e.credit.espoyr;
                }
                
                // Ignorer les √©critures sans mouvement de caisse
                if (entreeEuro === 0 && sortieEuro === 0 && entreeHash === 0 && sortieHash === 0) continue;
                
                soldeEuro += entreeEuro - sortieEuro;
                soldeHash += entreeHash - sortieHash;
                totalEntreesEuro += entreeEuro;
                totalSortiesEuro += sortieEuro;
                totalEntreesHash += entreeHash;
                totalSortiesHash += sortieHash;
                
                lignes.push({
                    tour: e.tour,
                    libelle: e.libelle,
                    entreeEuro, sortieEuro, soldeEuro: arrondir2(soldeEuro),
                    entreeHash, sortieHash, soldeHash: arrondir2(soldeHash)
                });
            }
            
            // S√©lecteur de joueur
            const players = Object.values(playersData);
            const selectJoueur = players.map(p => 
                `<button class="btn" style="padding:4px 8px;font-size:0.8rem;margin:2px;
                    background:${p.id === joueurId ? '#3b82f6' : '#f3f4f6'};
                    color:${p.id === joueurId ? 'white' : '#374151'};"
                    onclick="showReleveCompteModal('${p.id}')">${p.avatar} ${p.name}</button>`
            ).join('');
            
            // Tableau des mouvements (derniers 50)
            const lignesAffichees = lignes.slice(-50).reverse();
            const rowsHtml = lignesAffichees.map(l => `
                <tr style="font-size:0.75rem;">
                    <td style="padding:3px 5px;border-bottom:1px solid #e5e7eb;color:#6b7280;">T${l.tour}</td>
                    <td style="padding:3px 5px;border-bottom:1px solid #e5e7eb;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${l.libelle}">${l.libelle}</td>
                    <td style="padding:3px 5px;border-bottom:1px solid #e5e7eb;text-align:right;color:#059669;font-weight:${l.entreeEuro > 0 ? 'bold' : 'normal'};">${l.entreeEuro > 0 ? '+' + fmt(l.entreeEuro) : ''}</td>
                    <td style="padding:3px 5px;border-bottom:1px solid #e5e7eb;text-align:right;color:#dc2626;font-weight:${l.sortieEuro > 0 ? 'bold' : 'normal'};">${l.sortieEuro > 0 ? '-' + fmt(l.sortieEuro) : ''}</td>
                    <td style="padding:3px 5px;border-bottom:1px solid #e5e7eb;text-align:right;font-weight:bold;color:${l.soldeEuro >= 0 ? '#059669' : '#dc2626'};">${fmt(l.soldeEuro)}‚Ç¨</td>
                    <td style="padding:3px 5px;border-bottom:1px solid #e5e7eb;text-align:right;color:#059669;">${l.entreeHash > 0 ? '+' + fmt(l.entreeHash) : ''}</td>
                    <td style="padding:3px 5px;border-bottom:1px solid #e5e7eb;text-align:right;color:#dc2626;">${l.sortieHash > 0 ? '-' + fmt(l.sortieHash) : ''}</td>
                    <td style="padding:3px 5px;border-bottom:1px solid #e5e7eb;text-align:right;font-weight:bold;color:#7c3aed;">${fmt(l.soldeHash)}#</td>
                </tr>
            `).join('');
            
            showModal(`
                <h3>üìã Relev√© d√©taill√©</h3>
                <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px;">${selectJoueur}</div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
                    <div style="background:#dcfce7;padding:8px;border-radius:6px;text-align:center;">
                        <p style="margin:0;font-size:0.75rem;color:#065f46;">Total Entr√©es</p>
                        <p style="margin:2px 0 0 0;font-weight:bold;color:#059669;">${fmt(totalEntreesEuro)}‚Ç¨ / ${fmt(totalEntreesHash)}#</p>
                    </div>
                    <div style="background:#fee2e2;padding:8px;border-radius:6px;text-align:center;">
                        <p style="margin:0;font-size:0.75rem;color:#991b1b;">Total Sorties</p>
                        <p style="margin:2px 0 0 0;font-weight:bold;color:#dc2626;">${fmt(totalSortiesEuro)}‚Ç¨ / ${fmt(totalSortiesHash)}#</p>
                    </div>
                </div>
                
                <div style="background:${soldeEuro >= 0 ? '#f0fdf4' : '#fef2f2'};padding:10px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-around;">
                    <div style="text-align:center;">
                        <p style="margin:0;font-size:0.75rem;">Solde ‚Ç¨</p>
                        <p style="margin:2px 0 0 0;font-size:1.2rem;font-weight:bold;color:${soldeEuro >= 0 ? '#059669' : '#dc2626'};">${fmt(soldeEuro)}‚Ç¨</p>
                    </div>
                    <div style="text-align:center;">
                        <p style="margin:0;font-size:0.75rem;">Solde #</p>
                        <p style="margin:2px 0 0 0;font-size:1.2rem;font-weight:bold;color:#7c3aed;">${fmt(soldeHash)}#</p>
                    </div>
                    <div style="text-align:center;">
                        <p style="margin:0;font-size:0.75rem;">Nb mouvements</p>
                        <p style="margin:2px 0 0 0;font-size:1.2rem;font-weight:bold;">${lignes.length}</p>
                    </div>
                </div>
                
                <div style="max-height:300px;overflow-y:auto;border:1px solid #e5e7eb;border-radius:6px;">
                    <table style="width:100%;border-collapse:collapse;">
                        <thead>
                            <tr style="background:#f3f4f6;font-size:0.7rem;position:sticky;top:0;">
                                <th style="padding:4px 5px;text-align:left;">Tour</th>
                                <th style="padding:4px 5px;text-align:left;">Description</th>
                                <th style="padding:4px 5px;text-align:right;color:#059669;">+‚Ç¨</th>
                                <th style="padding:4px 5px;text-align:right;color:#dc2626;">-‚Ç¨</th>
                                <th style="padding:4px 5px;text-align:right;">Solde ‚Ç¨</th>
                                <th style="padding:4px 5px;text-align:right;color:#059669;">+#</th>
                                <th style="padding:4px 5px;text-align:right;color:#dc2626;">-#</th>
                                <th style="padding:4px 5px;text-align:right;">Solde #</th>
                            </tr>
                        </thead>
                        <tbody>${rowsHtml || '<tr><td colspan="8" style="padding:20px;text-align:center;color:#9ca3af;">Aucun mouvement</td></tr>'}</tbody>
                    </table>
                </div>
                ${lignes.length > 50 ? `<p style="font-size:0.75rem;color:#6b7280;text-align:center;margin-top:4px;">Affichage limit√© aux 50 derniers mouvements (${lignes.length} au total)</p>` : ''}
            `, `
                <button class="btn" style="background:#dcfce7;color:#065f46;" onclick="exportReleveCSV('${joueurId}')">üì• Export CSV</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `);
        }
        
        // Export CSV du relev√© de compte
        function exportReleveCSV(joueurId) {
            const joueurNom = playersData[joueurId]?.name || joueurId;
            let csv = 'Tour;Description;Entr√©e ‚Ç¨;Sortie ‚Ç¨;Solde ‚Ç¨;Entr√©e #;Sortie #;Solde #\n';
            let soldeEuro = 0, soldeHash = 0;
            
            for (const e of COMPTABILITE.journal) {
                if (e.joueurId !== joueurId) continue;
                let entreeEuro = 0, sortieEuro = 0, entreeHash = 0, sortieHash = 0;
                if (e.debit.compte === 500 && e.debit.euro > 0) entreeEuro = e.debit.euro;
                if (e.credit.compte === 500 && e.credit.euro > 0) sortieEuro = e.credit.euro;
                if (e.debit.compte === 501 && e.debit.espoyr > 0) entreeHash = e.debit.espoyr;
                if (e.credit.compte === 501 && e.credit.espoyr > 0) sortieHash = e.credit.espoyr;
                if (entreeEuro === 0 && sortieEuro === 0 && entreeHash === 0 && sortieHash === 0) continue;
                soldeEuro += entreeEuro - sortieEuro;
                soldeHash += entreeHash - sortieHash;
                csv += `${e.tour};"${e.libelle}";${entreeEuro || ''};${sortieEuro || ''};${arrondir2(soldeEuro)};${entreeHash || ''};${sortieHash || ''};${arrondir2(soldeHash)}\n`;
            }
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `releve_${joueurNom}_T${gameState?.turn || 0}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function showBilanModal() {
            // Calculer le bilan actuel
            const bilan = calculerBilan();
            
            // Comparaison avec le bilan pr√©c√©dent
            const bilanPrecedent = historiqueBilans.length > 0 ? historiqueBilans[historiqueBilans.length - 1] : null;
            const comparaison = comparerBilans(bilan, bilanPrecedent);
            
            const players = Object.values(playersData);
            
            // G√©n√©rer les lignes joueurs
         const playerRows = players.map(p => {
                const bj = bilan.bilansJoueurs[p.id] || {};
                const euro = Math.round((bj.actif?.euro || 0) * 100) / 100;
                const espoyr = Math.round((bj.actif?.espoyr || 0) * 100) / 100;
                const activites = Math.round((bj.actif?.activites || 0) * 100) / 100;
                const dette = Math.round((bj.passif?.emprunt || 0) * 100) / 100;
                const net = Math.round((bj.net || 0) * 100) / 100;
                
                return `
                    <tr>
                        <td>${fmt(bilan.actif.caisseEuro)}‚Ç¨</td>
                        <td>${fmt(bilan.actif.caisseEspoyr)}#</td>
                        <td>${fmt(bilan.actif.activites)}‚Ç¨</td>
                        <td>${fmt(bilan.passif.emprunts)}‚Ç¨</td>
                        <td>${fmt(bilan.actif.total - bilan.passif.emprunts)}‚Ç¨</td>
                    </tr>
                `;
            }).join('');
            
            // Tendance et comparaison
            const tendanceHtml = comparaison ? `
                <div style="background: #f0fdf4; padding: 8px; border-radius: 6px; margin-bottom: 10px;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        ${comparaison.tendance} <strong>Score √©conomique:</strong> ${bilan.scoreEconomique}
                        <span style="color: ${comparaison.deltaScore >= 0 ? '#059669' : '#dc2626'};">
                            (${comparaison.deltaScore >= 0 ? '+' : ''}${comparaison.deltaScore} depuis tour ${bilanPrecedent.tour})
                        </span>
                    </p>
                    <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6b7280;">
                        ‚Ç¨ ${comparaison.deltaEuro >= 0 ? '+' : ''}${comparaison.deltaEuro} | 
                        # ${comparaison.deltaEspoyr >= 0 ? '+' : ''}${comparaison.deltaEspoyr} | 
                        Activit√©s ${comparaison.deltaActivites >= 0 ? '+' : ''}${comparaison.deltaActivites} | 
                        Dettes ${comparaison.deltaEmprunts >= 0 ? '+' : ''}${comparaison.deltaEmprunts}
                    </p>
                </div>
            ` : `
                <div style="background: #f0fdf4; padding: 8px; border-radius: 6px; margin-bottom: 10px;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        üìä <strong>Score √©conomique:</strong> ${bilan.scoreEconomique}
                    </p>
                </div>
            `;
            
            const bilanBanque = `
                <tr>
                    <td colspan="6" style="background:#f3f4f6;"><strong>üè¶ Banque</strong></td>
                </tr>
                <tr>
                    <td>Cr√©ances</td>
                    <td class="actif" colspan="2">${fmt(bilan.bilanBanque.actif.creancesJoueurs)}‚Ç¨</td>
                    <td>Masse ‚Ç¨</td>
                    <td class="passif" colspan="2">${fmt(bilan.bilanBanque.passif.masseMonetaire)}‚Ç¨</td>
                </tr>
                ${bilan.bilanBanque.reductionValeur > 0 ? `
                <tr>
                    <td style="font-size: 0.8rem; color: #dc2626;">RDV (pertes)</td>
                    <td class="passif" colspan="2" style="font-size: 0.8rem;">-${fmt(bilan.bilanBanque.reductionValeur)}‚Ç¨</td>
                    <td style="font-size: 0.8rem;">Cr√©ances nettes</td>
                    <td colspan="2" style="font-size: 0.8rem;">${fmt(bilan.bilanBanque.actif.creancesNettes)}‚Ç¨</td>
                </tr>
                ` : ''}
            `;
            
            const bilanAAA = `
                <tr>
                    <td colspan="6" style="background:#dcfce7;"><strong>${LOGO_AAA} Pot AAA (${bilan.bilanAAA.membres} membres)</strong></td>
                </tr>
                <tr>
                    <td>Solde</td>
                    <td class="actif" colspan="2">${fmt(bilan.bilanAAA.passif.solde)}#</td>
                    <td># en circulation</td>
                    <td colspan="2">${fmt(bilan.bilanAAA.circulationHash)}#</td>
                </tr>
            `;
            
            const bilanEtat = `
                <tr>
                    <td colspan="6" style="background:#f3e8ff;"><strong>üèõÔ∏è √âtat</strong></td>
                </tr>
                <tr>
                    <td>Tr√©sor</td>
                    <td class="actif" colspan="2">${fmt(bilan.bilanEtat.actif.tresor)}‚Ç¨</td>
                    <td>Dette</td>
                    <td class="passif" colspan="2">${fmt(COMPTABILITE.etat.dette?.capital || 0)}‚Ç¨</td>
                </tr>
                <tr style="font-size: 0.8rem;">
                    <td colspan="3" style="background:#dcfce7;">
                        <strong>Recettes:</strong> 
                        TVA ${(COMPTABILITE.etat.recettes?.tva || 0).toFixed(0)}‚Ç¨ | 
                        Droits ${(COMPTABILITE.etat.recettes?.droits || 0).toFixed(0)}‚Ç¨ | 
                        Frais ${(COMPTABILITE.etat.recettes?.frais || 0).toFixed(0)}‚Ç¨
                    </td>
                    <td colspan="3" style="background:#fee2e2;">
                        <strong>D√©penses:</strong> 
                        Salaires ${COMPTABILITE.etat.depenses?.salaires || COMPTABILITE.etat.salairesVerses || 0}‚Ç¨ | 
                        Int√©r√™ts ${COMPTABILITE.etat.depenses?.interets || 0}‚Ç¨
                    </td>
                </tr>
                ${(COMPTABILITE.etat.dette?.capital || 0) > 0 ? `
                <tr style="font-size: 0.75rem; color: #6b7280;">
                    <td colspan="6">
                        üí° Int√©r√™ts cumul√©s pay√©s: ${COMPTABILITE.etat.dette?.interetsCumules || 0}‚Ç¨ | 
                        Comblement Export: ${COMPTABILITE.etat.depenses?.comblementExport || 0}‚Ç¨
                    </td>
                </tr>
                ` : ''}
            `;
            
            const bilanExport = `
                <tr>
                    <td colspan="6" style="background:#fef9c3;"><strong>üåç Exportation</strong></td>
                </tr>
                <tr>
                    <td>Solde</td>
                    <td class="${bilan.bilanExportation?.solde >= 0 ? 'actif' : 'passif'}" colspan="2">
                        ${bilan.bilanExportation?.solde || 0}‚Ç¨
                    </td>
                    <td>Recettes</td>
                    <td colspan="2">${fmt(bilan.bilanExportation?.recettes || 0)}‚Ç¨</td>
                </tr>
                <tr>
                    <td style="font-size: 0.8rem;">Salaires vers√©s</td>
                    <td colspan="5" style="font-size: 0.8rem;">${fmt(bilan.bilanExportation?.salairesVerses || 0)}‚Ç¨</td>
                </tr>
            `;
            
            const bilanHorsCircuitHtml = `
                <tr>
                    <td colspan="6" style="background:#e0f2fe;"><strong>üõ∞Ô∏è Hors circuit</strong></td>
                </tr>
                <tr>
                    <td>Solde</td>
                    <td class="actif" colspan="2">${fmt(bilan.bilanHorsCircuit?.solde || 0)}‚Ç¨</td>
                    <td>Recettes</td>
                    <td colspan="2">${fmt(bilan.bilanHorsCircuit?.recettes || 0)}‚Ç¨</td>
                </tr>
                <tr>
                    <td colspan="6" style="font-size:0.8rem;">üí¨ √âconomie sp√©culative / importation (captation du HT des achats)</td>
                </tr>
            `;
            
            // V√©rification √©quilibre
            const equilibreHtml = Math.abs(bilan.equilibre) > 1 ? 
                `<p style="color: #dc2626; font-size: 0.8rem;">‚ö†Ô∏è D√©s√©quilibre: ${fmt(bilan.equilibre)}‚Ç¨</p>` :
                `<p style="color: #059669; font-size: 0.8rem;">‚úÖ Bilan √©quilibr√©</p>`;
            
            showModal(`
                <h3>üìä Bilan √âconomique - Tour ${bilan.tour}</h3>
                ${tendanceHtml}
                <table class="bilan-table">
                    <thead>
                        <tr>
                            <th>Joueur</th>
                            <th>Caisse ‚Ç¨</th>
                            <th>Caisse #</th>
                            <th>Activit√©s</th>
                            <th>Dette</th>
                            <th>Net</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${playerRows}
                        <tr class="total">
                            <td>TOTAL</td>
                            <td>${fmt(bilan.actif.caisseEuro)}‚Ç¨</td>
                            <td>${fmt(bilan.actif.caisseEspoyr)}#</td>
                            <td>${fmt(bilan.actif.activites)}‚Ç¨</td>
                            <td>${fmt(bilan.passif.emprunts)}‚Ç¨</td>
                            <td>${fmt(bilan.actif.total - bilan.passif.emprunts)}‚Ç¨</td>
                        </tr>
                        ${bilanBanque}
                        ${bilanAAA}
                        ${bilanEtat}
                        ${bilanExport}
                        ${bilanHorsCircuitHtml}
                    </tbody>
                </table>
                ${equilibreHtml}
                <p style="font-size: 0.75rem; color: #9ca3af;">${bilan.nbEcritures} √©critures comptables</p>
            `, `
                <button class="btn btn-primary" onclick="enregistrerBilanTour(); closeModal();">üì∏ Sauver</button>
                <button class="btn" style="background:#fef3c7; color:#92400e;" onclick="exportBilanCSV()">üì• CSV</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `);
        }
        
        // ========== COMPTE JOUEUR ==========
        function showCompteJoueur(joueurId) {
            const player = playersData[joueurId];
            if (!player) return;
            
            const caisse = COMPTABILITE.caisseJoueurs[joueurId] || {};
            const isMembre = COMPTABILITE.potAAA?.membres?.includes(joueurId);
            const creanceAAA = COMPTABILITE.potAAA?.creances?.[joueurId] || 0;
            
            // R√©cup√©rer les activit√©s du joueur
            const activites = Object.entries(COMPTABILITE.caisseActivites || {})
                .filter(([id, a]) => a.proprietaireId === joueurId);
            const valeurActivites = activites.reduce((sum, [id, a]) => sum + (a.capital || 0), 0);
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // BILAN ‚Ç¨ (Euros) ‚Äî Calculs
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const capitalInitial = 450; // Capital de d√©part fixe
            const caisseEuro = caisse.euro || 0;
            const empruntBanque = caisse.emprunt || 0;
            
            // ACTIF ‚Ç¨
            const actifEuro_500 = caisseEuro;           // 500 - Caisse ‚Ç¨
            const actifEuro_200 = valeurActivites;      // 200 - Activit√©s
            const totalActifEuro = actifEuro_500 + actifEuro_200;
            
            // PASSIF ‚Ç¨ (sans 109)
            const passifEuro_101 = capitalInitial;      // 101 - Capital initial
            const passifEuro_165 = empruntBanque;       // 165 - Emprunt banque
            
            // 109 ‚Ç¨ = Poste d'√©quilibrage pour que Actif ‚Ç¨ = Passif ‚Ç¨
            const resultatEuro_109 = totalActifEuro - passifEuro_101 - passifEuro_165;
            const totalPassifEuro = passifEuro_101 + passifEuro_165 + resultatEuro_109;
            const bilanEuroEquilibre = Math.abs(totalActifEuro - totalPassifEuro) < 0.01;
            
            // Patrimoine net ‚Ç¨ (indicateur hors bilan)
            const patrimoineNetEuro = totalActifEuro - empruntBanque;
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // BILAN # (Espoyr) ‚Äî Calculs
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const caisseEspoyr = caisse.espoyr || 0;
            
            // ACTIF #
            const actifEspoyr_501 = caisseEspoyr;       // 501 - Caisse #
            const totalActifEspoyr = actifEspoyr_501;
            
            // PASSIF # (sans 109)
            const passifEspoyr_166 = creanceAAA;        // 166 - Cr√©ance AAA
            
            // 109 # = Poste d'√©quilibrage pour que Actif # = Passif #
            const resultatEspoyr_109 = totalActifEspoyr - passifEspoyr_166;
            const totalPassifEspoyr = passifEspoyr_166 + resultatEspoyr_109;
            const bilanEspoyrEquilibre = Math.abs(totalActifEspoyr - totalPassifEspoyr) < 0.01;
            
            // Patrimoine net # (indicateur hors bilan)
            const patrimoineNetEspoyr = totalActifEspoyr - passifEspoyr_166;
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // Limite d'emprunt
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const players = Object.values(playersData);
            const nbJoueurs = players.length || 1;
            let masseMonetaire = 0;
            players.forEach(p => {
                const c = COMPTABILITE.caisseJoueurs[p.id] || {};
                masseMonetaire += (c.euro || 0);
            });
            const limiteEmprunt = Math.max(750, Math.floor(masseMonetaire / nbJoueurs));
            const capaciteEmprunt = Math.max(0, limiteEmprunt - empruntBanque);
            
            // Liste des activit√©s
            const activitesHtml = activites.length > 0 ?
                activites.map(([actId, act]) => {
                    const c = CASES[actId];
                    const equipA = act.equipementA ? 'üîßA' : '';
                    const equipB = act.equipementB ? 'üî©B' : '';
                    return `<span style="background:#e0e7ff; padding:2px 6px; border-radius:4px; font-size:0.8rem; margin:2px;">
                        ${c?.icon || 'üè™'} ${c?.name || actId} ${equipA}${equipB}
                    </span>`;
                }).join(' ') :
                '<span style="color:#9ca3af; font-size:0.85rem;">Aucune activit√©</span>';
            
            showModal(`
                <h3>${player.avatar} Compte de ${player.name} ‚Äî Tour ${gameState.turn || 1}</h3>
                <p style="font-size:0.85rem; color:#6b7280; margin-bottom:10px;">
                    Profil: <strong>${player.profil || 'contributif'}</strong> 
                    ${player.isBot ? 'ü§ñ Robot' : ''} 
                    ${isMembre ? LOGO_AAA + ' Membre AAA' : ''}
                </p>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- BOUTON RELEV√â D√âTAILL√â                                -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div style="text-align:center; margin-bottom:12px;">
                    <button class="btn" style="background:#dbeafe; color:#2563eb; width:100%; padding:10px; font-size:0.95rem;" 
                        onclick="closeModal(); showReleveCompteModal('${joueurId}');">
                        üìã Relev√© d√©taill√©
                    </button>
                </div>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- ACTIVIT√âS POSS√âD√âES                                   -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div style="background:#e0e7ff; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0 0 5px 0; font-weight:bold;">üè™ Activit√©s poss√©d√©es (${activites.length})</p>
                    <div style="display:flex; flex-wrap:wrap; gap:4px;">
                        ${activitesHtml}
                    </div>
                </div>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- CUMULES (Rentr√©es & Sorties)                          -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div style="background:#f0fdf4; padding:8px; border-radius:6px;">
                        <p style="margin:0; font-size:0.8rem; font-weight:bold; color:#059669;">üì• Rentr√©es</p>
                        <p style="margin:4px 0 0 0; font-size:0.8rem;">Salaires: ${fmt(caisse.salairesRecus || 0)}‚Ç¨</p>
                        <p style="margin:2px 0 0 0; font-size:0.8rem;">Factures re√ßues: ${fmt(caisse.facturesRecues || 0)}‚Ç¨</p>
                        <p style="margin:2px 0 0 0; font-size:0.8rem;">Apports activit√©s: ${fmt(caisse.apportsActivites || 0)}‚Ç¨</p>
                    </div>
                    <div style="background:#fef2f2; padding:8px; border-radius:6px;">
                        <p style="margin:0; font-size:0.8rem; font-weight:bold; color:#dc2626;">üì§ Sorties</p>
                        <p style="margin:4px 0 0 0; font-size:0.8rem;">Factures pay√©es: ${fmt(caisse.facturesPayees || 0)}‚Ç¨</p>
                        <p style="margin:2px 0 0 0; font-size:0.8rem;">Int√©r√™ts pay√©s: ${fmt(caisse.interetsPayes || 0)}‚Ç¨</p>
                        <p style="margin:2px 0 0 0; font-size:0.8rem;">Taxes pay√©es: ${fmt(caisse.taxesPayees || 0)}‚Ç¨</p>
                    </div>
                </div>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- CAPACIT√â D'EMPRUNT                                    -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div style="background:#fef3c7; padding:8px 12px; border-radius:8px; margin-bottom:10px; text-align:center;">
                    üè¶ <strong>Capacit√© emprunt:</strong> ${fmt(capaciteEmprunt)}‚Ç¨ disponible sur ${fmt(limiteEmprunt)}‚Ç¨ max
                </div>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- BILAN ‚Ç¨ (Euros)                                       -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div style="background:linear-gradient(135deg, #ecfdf5, #d1fae5); padding:12px; border-radius:10px; margin-bottom:12px; border:2px solid #10b981;">
                    <p style="margin:0 0 10px 0; font-weight:bold; font-size:1rem; color:#059669;">
                        üí∂ BILAN ‚Ç¨ <span style="font-weight:normal; font-size:0.8rem;">(Euros)</span>
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
                        <!-- ACTIF ‚Ç¨ -->
                        <div style="background:white; padding:10px; border-radius:8px 0 0 8px; border-right:2px solid #10b981;">
                            <p style="margin:0 0 8px 0; font-weight:bold; color:#059669; text-align:center;">ACTIF ‚Ç¨</p>
                            <table style="width:100%; font-size:0.85rem;">
                                <tr><td>500 - Caisse ‚Ç¨</td><td style="text-align:right;">${fmt(actifEuro_500)}‚Ç¨</td></tr>
                                <tr><td>200 - Activit√©s</td><td style="text-align:right;">${fmt(actifEuro_200)}‚Ç¨</td></tr>
                                <tr style="border-top:2px solid #059669;">
                                    <td><strong>TOTAL ACTIF</strong></td>
                                    <td style="text-align:right;"><strong>${fmt(totalActifEuro)}‚Ç¨</strong></td>
                                </tr>
                            </table>
                        </div>
                        
                        <!-- PASSIF ‚Ç¨ -->
                        <div style="background:white; padding:10px; border-radius:0 8px 8px 0;">
                            <p style="margin:0 0 8px 0; font-weight:bold; color:#dc2626; text-align:center;">PASSIF ‚Ç¨</p>
                            <table style="width:100%; font-size:0.85rem;">
                                <tr><td>101 - Capital initial</td><td style="text-align:right;">${fmt(passifEuro_101)}‚Ç¨</td></tr>
                                <tr>
                                    <td>109 - R√©sultat</td>
                                    <td style="text-align:right; color:${resultatEuro_109 >= 0 ? '#059669' : '#dc2626'};">
                                        ${resultatEuro_109 >= 0 ? '+' : ''}${fmt(resultatEuro_109)}‚Ç¨
                                    </td>
                                </tr>
                                <tr><td>165 - Emprunt banque</td><td style="text-align:right;">${fmt(passifEuro_165)}‚Ç¨</td></tr>
                                <tr style="border-top:2px solid #dc2626;">
                                    <td><strong>TOTAL PASSIF</strong></td>
                                    <td style="text-align:right;"><strong>${fmt(totalPassifEuro)}‚Ç¨</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin-top:10px;">
                        <div style="background:${bilanEuroEquilibre ? '#dcfce7' : '#fee2e2'}; padding:6px 12px; border-radius:6px;">
                            ${bilanEuroEquilibre ? '‚úÖ √âquilibr√©' : '‚ö†Ô∏è D√©s√©quilibr√©'}
                        </div>
                        <div style="background:#f0fdf4; padding:6px 12px; border-radius:6px;">
                            <strong>Patrimoine net ‚Ç¨:</strong> ${patrimoineNetEuro >= 0 ? '+' : ''}${fmt(patrimoineNetEuro)}‚Ç¨
                        </div>
                    </div>
                </div>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- BILAN # (Espoyr)                                      -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div style="background:linear-gradient(135deg, #f3e8ff, #ede9fe); padding:12px; border-radius:10px; margin-bottom:12px; border:2px solid #8b5cf6;">
                    <p style="margin:0 0 10px 0; font-weight:bold; font-size:1rem; color:#7c3aed;">
                        üíú BILAN # <span style="font-weight:normal; font-size:0.8rem;">(Espoyr)</span>
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
                        <!-- ACTIF # -->
                        <div style="background:white; padding:10px; border-radius:8px 0 0 8px; border-right:2px solid #8b5cf6;">
                            <p style="margin:0 0 8px 0; font-weight:bold; color:#7c3aed; text-align:center;">ACTIF #</p>
                            <table style="width:100%; font-size:0.85rem;">
                                <tr><td>501 - Caisse #</td><td style="text-align:right;">${fmt(actifEspoyr_501)}#</td></tr>
                                <tr style="border-top:2px solid #7c3aed;">
                                    <td><strong>TOTAL ACTIF</strong></td>
                                    <td style="text-align:right;"><strong>${fmt(totalActifEspoyr)}#</strong></td>
                                </tr>
                            </table>
                        </div>
                        
                        <!-- PASSIF # -->
                        <div style="background:white; padding:10px; border-radius:0 8px 8px 0;">
                            <p style="margin:0 0 8px 0; font-weight:bold; color:#dc2626; text-align:center;">PASSIF #</p>
                            <table style="width:100%; font-size:0.85rem;">
                                ${passifEspoyr_166 > 0 ? `<tr><td>166 - Cr√©ance AAA</td><td style="text-align:right;">${fmt(passifEspoyr_166)}#</td></tr>` : ''}
                                <tr>
                                    <td>109 - R√©sultat</td>
                                    <td style="text-align:right; color:${resultatEspoyr_109 >= 0 ? '#059669' : '#dc2626'};">
                                        ${resultatEspoyr_109 >= 0 ? '+' : ''}${fmt(resultatEspoyr_109)}#
                                    </td>
                                </tr>
                                <tr style="border-top:2px solid #dc2626;">
                                    <td><strong>TOTAL PASSIF</strong></td>
                                    <td style="text-align:right;"><strong>${fmt(totalPassifEspoyr)}#</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin-top:10px;">
                        <div style="background:${bilanEspoyrEquilibre ? '#dcfce7' : '#fee2e2'}; padding:6px 12px; border-radius:6px;">
                            ${bilanEspoyrEquilibre ? '‚úÖ √âquilibr√©' : '‚ö†Ô∏è D√©s√©quilibr√©'}
                        </div>
                        <div style="background:#f5f3ff; padding:6px 12px; border-radius:6px;">
                            <strong>Patrimoine net #:</strong> ${patrimoineNetEspoyr >= 0 ? '+' : ''}${fmt(patrimoineNetEspoyr)}#
                        </div>
                    </div>
                </div>
            `, `
                <button class="btn" style="background:#dbeafe; color:#2563eb;" onclick="exportCompteJoueurCSV('${joueurId}')">üì• Export CSV</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `);
        }
        
        // Export CSV du compte joueur (deux bilans s√©par√©s ‚Ç¨ et #)
        function exportCompteJoueurCSV(joueurId) {
            const player = playersData[joueurId];
            const caisse = COMPTABILITE.caisseJoueurs[joueurId] || {};
            const creanceAAA = COMPTABILITE.potAAA?.creances?.[joueurId] || 0;
            
            // Activit√©s
            const activites = Object.entries(COMPTABILITE.caisseActivites || {})
                .filter(([id, a]) => a.proprietaireId === joueurId);
            const valeurActivites = activites.reduce((sum, [id, a]) => sum + (a.capital || 0), 0);
            
            // Calculs BILAN ‚Ç¨
            const capitalInitial = 450;
            const caisseEuro = caisse.euro || 0;
            const empruntBanque = caisse.emprunt || 0;
            const totalActifEuro = caisseEuro + valeurActivites;
            const resultatEuro = totalActifEuro - capitalInitial - empruntBanque;
            const totalPassifEuro = capitalInitial + resultatEuro + empruntBanque;
            const patrimoineNetEuro = totalActifEuro - empruntBanque;
            
            // Calculs BILAN #
            const caisseEspoyr = caisse.espoyr || 0;
            const totalActifEspoyr = caisseEspoyr;
            const resultatEspoyr = totalActifEspoyr - creanceAAA;
            const totalPassifEspoyr = creanceAAA + resultatEspoyr;
            const patrimoineNetEspoyr = totalActifEspoyr - creanceAAA;
            
            let csv = `COMPTE JOUEUR - ${player?.name || joueurId} - ESPOYR V11 - Tour ${gameState.turn || 1}\n`;
            csv += `Date export;${new Date().toLocaleString('fr-FR')}\n\n`;
            
            csv += '=== BILAN ‚Ç¨ (Euros) ===\n\n';
            csv += 'ACTIF ‚Ç¨\n';
            csv += `500 - Caisse ‚Ç¨;${caisseEuro}\n`;
            csv += `200 - Activit√©s;${valeurActivites}\n`;
            csv += `TOTAL ACTIF ‚Ç¨;${totalActifEuro}\n\n`;
            csv += 'PASSIF ‚Ç¨\n';
            csv += `101 - Capital initial;${capitalInitial}\n`;
            csv += `109 - R√©sultat;${resultatEuro}\n`;
            csv += `165 - Emprunt banque;${empruntBanque}\n`;
            csv += `TOTAL PASSIF ‚Ç¨;${totalPassifEuro}\n\n`;
            csv += `√âquilibre ‚Ç¨;${Math.abs(totalActifEuro - totalPassifEuro) < 0.01 ? 'OK' : 'ERREUR'}\n`;
            csv += `Patrimoine net ‚Ç¨;${patrimoineNetEuro}\n\n`;
            
            csv += '=== BILAN # (Espoyr) ===\n\n';
            csv += 'ACTIF #\n';
            csv += `501 - Caisse #;${caisseEspoyr}\n`;
            csv += `TOTAL ACTIF #;${totalActifEspoyr}\n\n`;
            csv += 'PASSIF #\n';
            if (creanceAAA > 0) csv += `166 - Cr√©ance AAA;${creanceAAA}\n`;
            csv += `109 - R√©sultat;${resultatEspoyr}\n`;
            csv += `TOTAL PASSIF #;${totalPassifEspoyr}\n\n`;
            csv += `√âquilibre #;${Math.abs(totalActifEspoyr - totalPassifEspoyr) < 0.01 ? 'OK' : 'ERREUR'}\n`;
            csv += `Patrimoine net #;${patrimoineNetEspoyr}\n\n`;
            
            csv += '=== CUMULS (Flux historiques) ===\n';
            csv += `Salaires re√ßus;${(caisse.salairesRecus || 0)}\n`;
            csv += `Factures re√ßues;${(caisse.facturesRecues || 0)}\n`;
            csv += `Apports activit√©s;${(caisse.apportsActivites || 0)}\n`;
            csv += `Factures pay√©es;${(caisse.facturesPayees || 0)}\n`;
            csv += `Int√©r√™ts pay√©s;${(caisse.interetsPayes || 0)}\n`;
            csv += `Taxes pay√©es;${(caisse.taxesPayees || 0)}\n\n`;
            
            csv += '=== ACTIVIT√âS ===\n';
            activites.forEach(([actId, act]) => {
                const c = CASES[actId];
                csv += `${c?.name || actId};${act.capital || 0}‚Ç¨\n`;
            });
            
            csv += '\n=== JOURNAL ===\n';
            csv += 'ID;Libell√©;‚Ç¨;#\n';
            const journal = COMPTABILITE.parJoueur?.[joueurId]?.journal || [];
            journal.forEach(e => {
                // Essayer plusieurs formats de champs
                const euro = e.debit?.euro || e.debit?.montantEuro || e.credit?.euro || e.credit?.montantEuro || 0;
                const espoyr = e.debit?.espoyr || e.debit?.montantEspoyr || e.credit?.espoyr || e.credit?.montantEspoyr || 0;
                csv += `${e.id || ''};${e.libelle || ''};${euro};${espoyr}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compte_${player?.name || joueurId}_tour${gameState.turn || 1}.csv`;
            a.click();
        }

        // ========== COMPTE √âTAT ==========
        function showCompteEtat() {
            const etat = COMPTABILITE.etat || {};
            const gl = etat.grandLivre || {};
            const dette = etat.dette || {};
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // SYNCHRONISATION : s'assurer que grandLivre refl√®te les soldes
            // (certaines op√©rations modifient etat.tresor sans grandLivre)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (etat.tresor !== undefined && etat.tresor !== gl[500]) {
                console.log(`üîÑ Sync grandLivre[500]: ${gl[500]} ‚Üí ${etat.tresor}`);
                gl[500] = etat.tresor;
            }
            if (dette.capital !== undefined && dette.capital !== gl[165]) {
                console.log(`üîÑ Sync grandLivre[165]: ${gl[165]} ‚Üí ${dette.capital}`);
                gl[165] = dette.capital;
            }
            // Sync recettes depuis etat.recettes
            const rec = etat.recettes || {};
            if (rec.tva !== undefined) gl[704] = rec.tva;
            if (rec.droits !== undefined) gl[705] = rec.droits;
            if (rec.frais !== undefined) gl[702] = rec.frais;
            if (rec.taxeCase !== undefined) gl[703] = rec.taxeCase;
            // Sync d√©penses depuis etat.depenses
            const dep = etat.depenses || {};
            if (dep.salaires !== undefined) gl[641] = dep.salaires;
            if (dep.interets !== undefined) gl[662] = dep.interets;
            if (dep.comblementExport !== undefined) gl[658] = dep.comblementExport;
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // SOURCE UNIQUE DE V√âRIT√â : lecture depuis grandLivre uniquement
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            // ACTIF (classe 5)
            const tresor = gl[500] || 0;
            
            // RECETTES (classe 7 - Produits)
            const rec704_TVA = gl[704] || 0;
            const rec705_Droits = gl[705] || 0;
            const rec702_Frais = gl[702] || 0;
            const rec703_Taxe = gl[703] || 0;
            const totalRecettes = rec704_TVA + rec705_Droits + rec702_Frais + rec703_Taxe;
            
            // D√âPENSES (classe 6 - Charges)
            const dep641_Salaires = gl[641] || 0;
            const dep662_Interets = gl[662] || 0;
            const dep658_Comblement = gl[658] || 0;
            const totalDepenses = dep641_Salaires + dep662_Interets + dep658_Comblement;
            
            // PASSIF (classe 1)
            const detteCapital = gl[165] || dette.capital || 0;
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // CALCULS COMPTABLES
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            // R√©sultat de p√©riode (flux) = Produits - Charges
            const resultatPeriode = totalRecettes - totalDepenses;
            
            // Compte 109 - R√©sultat cumul√© (temps r√©el) = Actif - Dettes
            // Pour √©quilibrer : Actif = Passif ‚Üí Passif = Dette + R√©sultat
            const compte109_Resultat = tresor - detteCapital;
            
            // V√©rification √©quilibre bilan
            const totalActif = tresor;
            const totalPassif = compte109_Resultat + detteCapital;
            const bilanEquilibre = Math.abs(totalActif - totalPassif) < 0.01;
            
            // Journal √âtat (10 derni√®res √©critures)
            const journalEtat = (etat.journalEtat || []).slice(-10).reverse();
            const journalHtml = journalEtat.length > 0 ? 
                journalEtat.map(e => `
                    <tr style="font-size:0.75rem;">
                        <td>T${e.tour || '?'}</td>
                        <td>${e.type}</td>
                        <td style="text-align:right;">${fmt(e.montant || 0)}‚Ç¨</td>
                    </tr>
                `).join('') :
                '<tr><td colspan="3" style="font-size:0.75rem; color:#9ca3af;">Aucun √©v√©nement</td></tr>';
            
            showModal(`
                <h3>üèõÔ∏è Compte de l'√âtat ‚Äî Tour ${gameState.turn || 1}</h3>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- SECTION 1 : COMPTE DE R√âSULTAT (FLUX DE LA P√âRIODE)   -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div style="background:linear-gradient(135deg, #ecfdf5, #d1fae5); padding:12px; border-radius:10px; margin-bottom:12px; border:2px solid #10b981;">
                    <p style="margin:0 0 10px 0; font-weight:bold; font-size:1rem; color:#059669;">
                        üìà COMPTE DE R√âSULTAT <span style="font-weight:normal; font-size:0.8rem;">(Flux p√©riode)</span>
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background:white; padding:10px; border-radius:8px;">
                            <p style="margin:0 0 8px 0; font-weight:bold; color:#059669;">üì• RECETTES (Classe 7)</p>
                            <table style="width:100%; font-size:0.85rem;">
                                <tr><td>704 - TVA per√ßue</td><td style="text-align:right;">${rec704_TVA.toFixed(2)}‚Ç¨</td></tr>
                                <tr><td>705 - Droits per√ßus</td><td style="text-align:right;">${rec705_Droits.toFixed(2)}‚Ç¨</td></tr>
                                <tr><td>702 - Frais per√ßus</td><td style="text-align:right;">${rec702_Frais.toFixed(2)}‚Ç¨</td></tr>
                                <tr><td>703 - Taxe case</td><td style="text-align:right;">${rec703_Taxe.toFixed(2)}‚Ç¨</td></tr>
                                <tr style="border-top:2px solid #059669; font-weight:bold;">
                                    <td>TOTAL PRODUITS</td><td style="text-align:right;">${totalRecettes.toFixed(2)}‚Ç¨</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="background:white; padding:10px; border-radius:8px;">
                            <p style="margin:0 0 8px 0; font-weight:bold; color:#dc2626;">üì§ D√âPENSES (Classe 6)</p>
                            <table style="width:100%; font-size:0.85rem;">
                                <tr><td>641 - Salaires vers√©s</td><td style="text-align:right;">${dep641_Salaires.toFixed(2)}‚Ç¨</td></tr>
                                <tr><td>662 - Int√©r√™ts pay√©s</td><td style="text-align:right;">${dep662_Interets.toFixed(2)}‚Ç¨</td></tr>
                                <tr><td>658 - Comblement export</td><td style="text-align:right;">${dep658_Comblement.toFixed(2)}‚Ç¨</td></tr>
                                <tr style="border-top:2px solid #dc2626; font-weight:bold;">
                                    <td>TOTAL CHARGES</td><td style="text-align:right;">${totalDepenses.toFixed(2)}‚Ç¨</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div style="background:#fef3c7; padding:8px 12px; border-radius:6px; margin-top:10px; text-align:center;">
                        <strong style="font-size:1.1rem;">R√âSULTAT P√âRIODE = ${resultatPeriode >= 0 ? '+' : ''}${resultatPeriode.toFixed(2)}‚Ç¨</strong>
                        <span style="margin-left:8px;">${resultatPeriode >= 0 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                    </div>
                </div>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- SECTION 2 : BILAN (STOCK √Ä DATE)                      -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div style="background:linear-gradient(135deg, #f3e8ff, #ede9fe); padding:12px; border-radius:10px; margin-bottom:12px; border:2px solid #8b5cf6;">
                    <p style="margin:0 0 10px 0; font-weight:bold; font-size:1rem; color:#7c3aed;">
                        üìä BILAN <span style="font-weight:normal; font-size:0.8rem;">(Stock √† date)</span>
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
                        <!-- ACTIF -->
                        <div style="background:#dcfce7; padding:10px; border-radius:8px 0 0 8px; border-right:2px solid #8b5cf6;">
                            <p style="margin:0 0 8px 0; font-weight:bold; color:#059669; text-align:center;">ACTIF</p>
                            <table style="width:100%; font-size:0.9rem;">
                                <tr>
                                    <td>500 - Tr√©sor public</td>
                                    <td style="text-align:right; font-weight:bold;">${tresor.toFixed(2)}‚Ç¨</td>
                                </tr>
                                <tr style="border-top:2px solid #059669;">
                                    <td><strong>TOTAL ACTIF</strong></td>
                                    <td style="text-align:right;"><strong>${totalActif.toFixed(2)}‚Ç¨</strong></td>
                                </tr>
                            </table>
                        </div>
                        
                        <!-- PASSIF -->
                        <div style="background:#fee2e2; padding:10px; border-radius:0 8px 8px 0;">
                            <p style="margin:0 0 8px 0; font-weight:bold; color:#dc2626; text-align:center;">PASSIF</p>
                            <table style="width:100%; font-size:0.9rem;">
                                <tr>
                                    <td>109 - R√©sultat</td>
                                    <td style="text-align:right; font-weight:bold; color:${compte109_Resultat >= 0 ? '#059669' : '#dc2626'};">
                                        ${compte109_Resultat >= 0 ? '+' : ''}${compte109_Resultat.toFixed(2)}‚Ç¨
                                    </td>
                                </tr>
                                <tr>
                                    <td>165 - Dettes</td>
                                    <td style="text-align:right;">${detteCapital.toFixed(2)}‚Ç¨</td>
                                </tr>
                                <tr style="border-top:2px solid #dc2626;">
                                    <td><strong>TOTAL PASSIF</strong></td>
                                    <td style="text-align:right;"><strong>${totalPassif.toFixed(2)}‚Ç¨</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div style="background:${bilanEquilibre ? '#dcfce7' : '#fee2e2'}; padding:8px 12px; border-radius:6px; margin-top:10px; text-align:center;">
                        ${bilanEquilibre ? 
                            '<strong style="color:#059669;">‚úÖ Bilan √©quilibr√©</strong> <span style="font-size:0.85rem;">(Actif = Passif)</span>' : 
                            `<strong style="color:#dc2626;">‚ö†Ô∏è D√âS√âQUILIBRE</strong> <span style="font-size:0.85rem;">√âcart: ${(totalActif - totalPassif).toFixed(2)}‚Ç¨</span>`
                        }
                    </div>
                </div>
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- SECTION 3 : D√âTAIL DETTE (si existe)                  -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                ${detteCapital > 0 ? `
                <div style="background:#fef3c7; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0 0 8px 0; font-weight:bold;">üí∞ D√âTAIL DETTE</p>
                    <table style="width:100%; font-size:0.85rem;">
                        <tr><td>Capital emprunt√©</td><td style="text-align:right;">${detteCapital.toFixed(0)}‚Ç¨</td></tr>
                        <tr><td>Int√©r√™ts cumul√©s pay√©s</td><td style="text-align:right;">${(dette.interetsCumules || 0).toFixed(0)}‚Ç¨</td></tr>
                        <tr><td>Int√©r√™ts prochains (${(CONFIG.tauxInteret * 100).toFixed(0)}%)</td><td style="text-align:right;">${Math.floor(detteCapital * CONFIG.tauxInteret)}‚Ç¨</td></tr>
                    </table>
                </div>
                ` : ''}
                
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- SECTION 4 : JOURNAL DES √âV√âNEMENTS                    -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div style="background:#f3f4f6; padding:10px; border-radius:8px;">
                    <p style="margin:0 0 5px 0; font-weight:bold;">üìí Journal √âtat (10 derniers)</p>
                    <table style="width:100%; border-collapse:collapse;">
                        <tr style="font-size:0.7rem; background:#e5e7eb;">
                            <th style="text-align:left; padding:2px;">Tour</th>
                            <th style="text-align:left; padding:2px;">Type</th>
                            <th style="text-align:right; padding:2px;">Montant</th>
                        </tr>
                        ${journalHtml}
                    </table>
                </div>
            `, `
                <button class="btn" style="background:#dbeafe; color:#2563eb;" onclick="exportCompteEtatCSV()">üì• Export CSV</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `);
        }
        
        // Export CSV du compte √âtat (source: grandLivre)
        function exportCompteEtatCSV() {
            const etat = COMPTABILITE.etat || {};
            const gl = etat.grandLivre || {};
            const dette = etat.dette || {};
            
            // Lecture depuis grandLivre (source unique)
            const tresor = gl[500] || 0;
            const rec704 = gl[704] || 0;
            const rec705 = gl[705] || 0;
            const rec702 = gl[702] || 0;
            const rec703 = gl[703] || 0;
            const totalRecettes = rec704 + rec705 + rec702 + rec703;
            
            const dep641 = gl[641] || 0;
            const dep662 = gl[662] || 0;
            const dep658 = gl[658] || 0;
            const totalDepenses = dep641 + dep662 + dep658;
            
            const detteCapital = gl[165] || dette.capital || 0;
            const resultatPeriode = totalRecettes - totalDepenses;
            const compte109 = tresor - detteCapital;
            
            let csv = `COMPTE √âTAT - ESPOYR V11 - Tour ${gameState.turn || 1}\n`;
            csv += `Date export;${new Date().toLocaleString('fr-FR')}\n\n`;
            
            csv += '=== COMPTE DE R√âSULTAT (Flux p√©riode) ===\n\n';
            csv += 'RECETTES (Classe 7)\n';
            csv += `704 - TVA per√ßue;${rec704.toFixed(2)}\n`;
            csv += `705 - Droits per√ßus;${rec705.toFixed(2)}\n`;
            csv += `702 - Frais per√ßus;${rec702.toFixed(2)}\n`;
            csv += `703 - Taxe case;${rec703.toFixed(2)}\n`;
            csv += `TOTAL PRODUITS;${totalRecettes.toFixed(2)}\n\n`;
            
            csv += 'D√âPENSES (Classe 6)\n';
            csv += `641 - Salaires vers√©s;${dep641.toFixed(2)}\n`;
            csv += `662 - Int√©r√™ts pay√©s;${dep662.toFixed(2)}\n`;
            csv += `658 - Comblement export;${dep658.toFixed(2)}\n`;
            csv += `TOTAL CHARGES;${totalDepenses.toFixed(2)}\n\n`;
            
            csv += `R√âSULTAT P√âRIODE;${resultatPeriode.toFixed(2)}\n\n`;
            
            csv += '=== BILAN (Stock √† date) ===\n\n';
            csv += 'ACTIF\n';
            csv += `500 - Tr√©sor public;${tresor.toFixed(2)}\n`;
            csv += `TOTAL ACTIF;${tresor.toFixed(2)}\n\n`;
            
            csv += 'PASSIF\n';
            csv += `109 - R√©sultat;${compte109.toFixed(2)}\n`;
            csv += `165 - Dettes;${detteCapital.toFixed(2)}\n`;
            csv += `TOTAL PASSIF;${(compte109 + detteCapital).toFixed(2)}\n\n`;
            
            csv += `√âquilibre;${Math.abs(tresor - (compte109 + detteCapital)) < 0.01 ? 'OK' : 'ERREUR'}\n\n`;
            
            if (detteCapital > 0) {
                csv += '=== D√âTAIL DETTE ===\n';
                csv += `Capital emprunt√©;${detteCapital.toFixed(0)}\n`;
                csv += `Int√©r√™ts cumul√©s pay√©s;${(dette.interetsCumules || 0).toFixed(0)}\n\n`;
            }
            
            csv += '=== JOURNAL ===\n';
            csv += 'Tour;Type;Montant\n';
            (etat.journalEtat || []).forEach(e => {
                csv += `${e.tour || ''};${e.type || ''};${e.montant || 0}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compte_etat_tour${gameState.turn || 1}.csv`;
            a.click();
        }
        
        // ========== COMPTE EXPORTATION ==========
        function showCompteExportation() {
            const exp = COMPTABILITE.exportation || {};
            
            // Journal Export (10 derni√®res √©critures du journal g√©n√©ral concernant l'export)
            const journalExport = (exp.journal || []).slice(-10).reverse();
            const journalHtml = journalExport.length > 0 ? 
                journalExport.map(e => `
                    <tr style="font-size:0.75rem;">
                        <td>#${e.id || '?'}</td>
                        <td>${e.libelle || ''}</td>
                        <td style="text-align:right;">${fmt(e.debit?.montantEuro || e.credit?.montantEuro || 0)}‚Ç¨</td>
                    </tr>
                `).join('') :
                '<tr><td colspan="3" style="font-size:0.75rem; color:#9ca3af;">Aucune √©criture</td></tr>';
            
            // Calcul indicateurs
            const solde = exp.solde || 0;
            const recettes = exp.recettes || 0;
            const salaires = exp.salairesVerses || 0;
            const resultat = recettes - salaires;
            
            showModal(`
                <h3>üåç Compte Exportation</h3>
                
                <div style="background:#fef9c3; padding:12px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0; font-weight:bold;">üìä SITUATION</p>
                    <table style="width:100%; font-size:0.9rem; margin-top:8px;">
                        <tr>
                            <td>Solde actuel</td>
                            <td style="text-align:right; font-weight:bold; color:${solde >= 0 ? '#059669' : '#dc2626'};">
                                ${solde >= 0 ? '+' : ''}${solde.toFixed(0)}‚Ç¨
                                ${solde < 0 ? ' ‚ö†Ô∏è D√©couvert' : ''}
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div style="background:#dcfce7; padding:10px; border-radius:8px;">
                        <p style="margin:0; font-weight:bold; color:#059669;">üì• RECETTES</p>
                        <table style="width:100%; font-size:0.85rem; margin-top:8px;">
                            <tr><td>TVA (50%)</td><td style="text-align:right;">-</td></tr>
                            <tr><td>Droits (50%)</td><td style="text-align:right;">-</td></tr>
                            <tr style="border-top:2px solid #059669; font-weight:bold;">
                                <td>TOTAL</td><td style="text-align:right;">${recettes.toFixed(0)}‚Ç¨</td>
                            </tr>
                        </table>
                        <p style="font-size:0.75rem; color:#6b7280; margin:8px 0 0 0;">
                            üí° Recettes = 50% des taxes sur achats d'activit√©s
                        </p>
                    </div>
                    
                    <div style="background:#fee2e2; padding:10px; border-radius:8px;">
                        <p style="margin:0; font-weight:bold; color:#dc2626;">üì§ D√âPENSES</p>
                        <table style="width:100%; font-size:0.85rem; margin-top:8px;">
                            <tr><td>Salaires cr√©atifs</td><td style="text-align:right;">${salaires.toFixed(0)}‚Ç¨</td></tr>
                            <tr style="border-top:2px solid #dc2626; font-weight:bold;">
                                <td>TOTAL</td><td style="text-align:right;">${salaires.toFixed(0)}‚Ç¨</td>
                            </tr>
                        </table>
                        <p style="font-size:0.75rem; color:#6b7280; margin:8px 0 0 0;">
                            üí° Salaires des joueurs profil "cr√©atif"
                        </p>
                    </div>
                </div>
                
                <div style="background:#f3f4f6; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0; font-weight:bold;">üìà R√âSULTAT</p>
                    <table style="width:100%; font-size:0.9rem; margin-top:8px;">
                        <tr>
                            <td>Recettes - D√©penses</td>
                            <td style="text-align:right; font-weight:bold; color:${resultat >= 0 ? '#059669' : '#dc2626'};">
                                ${resultat >= 0 ? '+' : ''}${resultat.toFixed(0)}‚Ç¨
                            </td>
                        </tr>
                    </table>
                    ${solde < 0 ? `
                    <div style="background:#fee2e2; padding:8px; border-radius:6px; margin-top:8px;">
                        <p style="margin:0; font-size:0.85rem; color:#dc2626;">
                            ‚ö†Ô∏è <strong>D√©couvert de ${fmt(Math.abs(solde))}‚Ç¨</strong><br>
                            L'√âtat comblera ce d√©ficit en fin de tour.
                        </p>
                    </div>
                    ` : ''}
                </div>
                
                <div style="background:#e0e7ff; padding:10px; border-radius:8px;">
                    <p style="margin:0; font-weight:bold;">üí° Fonctionnement</p>
                    <ul style="font-size:0.8rem; margin:8px 0 0 0; padding-left:20px;">
                        <li>Re√ßoit 50% des taxes (TVA + Droits) sur les achats d'activit√©s</li>
                        <li>Paie les salaires des joueurs "cr√©atifs" (variable selon d√©)</li>
                        <li>Si d√©couvert ‚Üí l'√âtat comble en fin de tour</li>
                    </ul>
                </div>
            `, `
                <button class="btn" style="background:#dbeafe; color:#2563eb;" onclick="exportCompteExportCSV()">üì• Export CSV</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `);
        }
        
        // Export CSV du compte Exportation
        function exportCompteExportCSV() {
            const exp = COMPTABILITE.exportation || {};
            
            let csv = 'COMPTE EXPORTATION - ESPOYR V11\n\n';
            csv += 'SITUATION\n';
            csv += `Solde;${(exp.solde || 0)}\n`;
            csv += `Recettes;${(exp.recettes || 0)}\n`;
            csv += `Salaires vers√©s;${(exp.salairesVerses || 0)}\n`;
            csv += `R√©sultat;${(exp.recettes || 0) - (exp.salairesVerses || 0)}\n`;
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compte_export_tour${gameState.turn || 1}.csv`;
            a.click();
        }
        
        
        // ========== COMPTE HORS CIRCUIT ==========
        function showCompteHorsCircuit() {
            const hc = COMPTABILITE.horsCircuit || {};
            const journalHC = (hc.journal || []).slice(-10).reverse();
            const journalHtml = journalHC.length > 0 ?
                journalHC.map(e => `
                    <tr style="font-size:0.75rem;">
                        <td>#${e.id || '?'}<\/td>
                        <td>${e.libelle || ''}<\/td>
                        <td style="text-align:right;">${fmt(e.debit?.montantEuro || e.credit?.montantEuro || 0)}‚Ç¨<\/td>
                    <\/tr>
                `).join('') :
                '<tr><td colspan="3" style="font-size:0.75rem; color:#9ca3af;">Aucune √©criture<\/td><\/tr>';

            const solde = hc.solde || 0;
            const recettes = hc.recettes || 0;

            showModal(`
                <h3>üõ∞Ô∏è Argents hors circuit<\/h3>
                <div style="background:#e0f2fe; padding:12px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0; font-weight:bold;">üìä SITUATION<\/p>
                    <table style="width:100%; font-size:0.9rem; margin-top:8px;">
                        <tr>
                            <td>Solde actuel<\/td>
                            <td style="text-align:right; font-weight:bold; color:#0369a1;">+${solde.toFixed(0)}‚Ç¨<\/td>
                        <\/tr>
                        <tr>
                            <td>Recettes cumul√©es<\/td>
                            <td style="text-align:right;">${recettes.toFixed(0)}‚Ç¨<\/td>
                        <\/tr>
                    <\/table>
                    <p style="font-size:0.75rem; color:#6b7280; margin:8px 0 0 0;">
                        üí¨ Captation du <strong>HT<\/strong> des achats d'activit√©s (remplace la redistribution).
                        Libell√© comptable : <em>√âconomie sp√©culative / importation<\/em>.
                    <\/p>
                <\/div>

                <div style="background:#f8fafc; padding:10px; border-radius:8px;">
                    <p style="margin:0 0 8px 0; font-weight:bold;">üßæ 10 derni√®res √©critures<\/p>
                    <table style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="font-size:0.75rem; color:#6b7280;">
                                <th style="text-align:left;">#<\/th>
                                <th style="text-align:left;">Libell√©<\/th>
                                <th style="text-align:right;">Montant<\/th>
                            <\/tr>
                        <\/thead>
                        <tbody>
                            ${journalHtml}
                        <\/tbody>
                    <\/table>
                <\/div>
            `, `
                <button class="btn" style="background:#dbeafe; color:#2563eb;" onclick="exportCompteHorsCircuitCSV()">üì• Export CSV<\/button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer<\/button>
            `);
        }

        function exportCompteHorsCircuitCSV() {
            const hc = COMPTABILITE.horsCircuit || {};
            let csv = 'ARGENTS HORS CIRCUIT - ESPOYR V11\n\n';
            csv += 'SITUATION\n';
            csv += `Solde;${(hc.solde || 0)}\n`;
            csv += `Recettes;${(hc.recettes || 0)}\n`;
            csv += '\n10 DERNI√àRES √âCRITURES\n';
            (hc.journal || []).slice(-10).forEach(e => {
                const m = (e.debit?.montantEuro || e.credit?.montantEuro || 0);
                csv += `#${e.id || ''};${(e.libelle || '').replace(/;/g, ',')};${m}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compte_hors_circuit_tour${gameState.turn || 1}.csv`;
            a.click();
        }

// ========== COMPTE BANQUE ==========
        function showCompteBanque() {
            const banque = COMPTABILITE.banque || {};
            const gl = banque.grandLivre || {};
            
            // M√©triques bancaires
            const E = (gl[1200] ?? banque.E ?? 0);  // Encours cr√©dits (source: ledger si possible)
            const C = gl[3000] || 0;  // Capital
            const P = gl[2290] || 0;  // Provisions
            // R√©sultat courant (flux) issu du ledger
            const produitsInterets = (gl[4000] || 0);
            const dotationProvision = (gl[5000] || 0);
            const resultatNet = produitsInterets - dotationProvision;
            // Capitaux propres affich√©s = r√©serves/r√©sultat cumul√©s + r√©sultat courant
            const cpAffiche = (gl[3100] || 0) + resultatNet;
            const ratioCapital = E > 0 ? ((C / E) * 100).toFixed(1) : 0;
            const ratioProvision = E > 0 ? ((P / E) * 100).toFixed(1) : 0;
            
            // Journal banque (10 derni√®res)
            const journalBanque = (banque.journalBanque || []).slice(-10).reverse();
            const journalHtml = journalBanque.length > 0 ? 
                journalBanque.map(e => `
                    <tr style="font-size:0.75rem;">
                        <td>#${e.id || '?'}</td>
                        <td>${e.libelle || ''}</td>
                        <td style="text-align:right;">${fmt(e.montant || 0)}‚Ç¨</td>
                    </tr>
                `).join('') :
                '<tr><td colspan="3" style="font-size:0.75rem; color:#9ca3af;">Aucune √©criture</td></tr>';
            
            showModal(`
                <h3>üè¶ Compte Banque</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div style="background:#dbeafe; padding:10px; border-radius:8px;">
                        <p style="margin:0; font-weight:bold; color:#2563eb;">üìä ACTIF</p>
                        <table style="width:100%; font-size:0.85rem; margin-top:8px;">
                            <tr><td>1010 - R√©serves</td><td style="text-align:right;">${(gl[1010] || 0).toFixed(0)}‚Ç¨</td></tr>
                            <tr><td>1200 - Encours cr√©dits (E)</td><td style="text-align:right;">${E.toFixed(0)}‚Ç¨</td></tr>
                            <tr><td>1300 - Int√©r√™ts √† recevoir</td><td style="text-align:right;">${(gl[1300] || 0).toFixed(0)}‚Ç¨</td></tr>
                            <tr style="border-top:2px solid #2563eb; font-weight:bold;">
                                <td>TOTAL ACTIF</td><td style="text-align:right;">${((gl[1010] || 0) + E + (gl[1300] || 0)).toFixed(0)}‚Ç¨</td>
                            </tr>
                        </table>
                    </div>
                    
                    <div style="background:#fee2e2; padding:10px; border-radius:8px;">
                        <p style="margin:0; font-weight:bold; color:#dc2626;">üìä PASSIF + CAPITAUX</p>
                        <table style="width:100%; font-size:0.85rem; margin-top:8px;">
                            <tr><td>2290 - Provisions (P)</td><td style="text-align:right;">${P.toFixed(0)}‚Ç¨</td></tr>
                            <tr style="background:#fee2e2;"><td>3000 - Capital banque</td><td style="text-align:right;">${C.toFixed(0)}‚Ç¨</td></tr>
                            <tr style="background:#fee2e2;"><td>3100 - R√©serves / R√©sultat</td><td style="text-align:right;">${cpAffiche.toFixed(0)}‚Ç¨</td></tr>
                            <tr style="border-top:2px solid #dc2626; font-weight:bold;">
                                <td>TOTAL</td><td style="text-align:right;">${(P + C + cpAffiche).toFixed(0)}‚Ç¨</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <div style="background:#fef3c7; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0; font-weight:bold;">üìê RATIOS PRUDENTIELS</p>
                    <table style="width:100%; font-size:0.9rem; margin-top:8px;">
                        <tr>
                            <td>Capital / Encours (C/E)</td>
                            <td style="text-align:right;">
                                <strong>${ratioCapital}%</strong>
                                ${parseFloat(ratioCapital) >= 10 ? ' ‚úÖ' : ' ‚ö†Ô∏è'}
                                <span style="font-size:0.75rem; color:#6b7280;"> (requis: 10%)</span>
                            </td>
                        </tr>
                        <tr>
                            <td>Provisions / Encours (P/E)</td>
                            <td style="text-align:right;">
                                <strong>${ratioProvision}%</strong>
                                ${parseFloat(ratioProvision) >= 5 ? ' ‚úÖ' : ' ‚ö†Ô∏è'}
                                <span style="font-size:0.75rem; color:#6b7280;"> (requis: 5%)</span>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div style="background:#dcfce7; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0; font-weight:bold;">üí∞ R√âSULTAT</p>
                    <table style="width:100%; font-size:0.85rem; margin-top:8px;">
                        <tr><td>4000 - Produits int√©r√™ts</td><td style="text-align:right;">${(produitsInterets).toFixed(0)}‚Ç¨</td></tr>
                        <tr><td>5000 - Dotation provisions</td><td style="text-align:right;">-${(dotationProvision).toFixed(0)}‚Ç¨</td></tr>
                        <tr style="border-top:1px solid #059669;">
                            <td><strong>R√©sultat net</strong></td>
                            <td style="text-align:right;"><strong>${resultatNet.toFixed(0)}‚Ç¨</strong></td>
                        </tr>
                    </table>
                </div>
                
                <div style="background:#f3f4f6; padding:10px; border-radius:8px;">
                    <p style="margin:0 0 5px 0; font-weight:bold;">üìí Statistiques</p>
                    <table style="width:100%; font-size:0.85rem;">
                        <tr><td>Total pr√™ts accord√©s</td><td style="text-align:right;">${(banque.totalPretsAccordes || 0).toFixed(0)}‚Ç¨</td></tr>
                        <tr><td>Total rembours√©</td><td style="text-align:right;">${(banque.totalRembourse || 0).toFixed(0)}‚Ç¨</td></tr>
                        <tr><td>Int√©r√™ts cumul√©s re√ßus</td><td style="text-align:right;">${(banque.cumInterets || 0).toFixed(0)}‚Ç¨</td></tr>
                        <tr><td>D√©fauts</td><td style="text-align:right;">${(banque.defauts || 0).toFixed(0)}‚Ç¨</td></tr>
                    </table>
                </div>
            `, `
                <button class="btn" style="background:#dbeafe; color:#2563eb;" onclick="showExportJournalBanque()">üì• Export</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `);
        }

        // ========== POT AAA ==========
        function showAAAModal() {
            const isMembre = COMPTABILITE.potAAA.membres?.includes(myPlayerId);
            const myEspoyr = COMPTABILITE.caisseJoueurs[myPlayerId]?.espoyr || 0;
            const maCreance = COMPTABILITE.potAAA.creances?.[myPlayerId] || 0;
            const potAAA = COMPTABILITE.potAAA || {};
            
            // Journal du Pot AAA (5 derni√®res √©critures)
            const journalAAA = (potAAA.journal || []).slice(-5).reverse();
            const journalHtml = journalAAA.length > 0 ? 
                journalAAA.map(e => `<tr><td style="font-size:0.7rem;">#${e.id}</td><td style="font-size:0.7rem;">${e.libelle}</td><td style="font-size:0.7rem;">${fmt(e.debit?.montantEspoyr || e.credit?.montantEspoyr || 0)}#</td></tr>`).join('') :
                '<tr><td colspan="3" style="font-size:0.7rem; color:#9ca3af;">Aucune √©criture</td></tr>';
            
            // Liste des cr√©ances
            const creances = Object.entries(potAAA.creances || {});
            const totalCreances = creances.reduce((s, [_, v]) => s + v, 0);
            
            showModal(`
                <h3>${LOGO_AAA} Pot AAA (Aide Amicale Autonome)</h3>
                
                <div style="background:#dcfce7; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0; font-weight:bold;">üìä Bilan du Pot AAA</p>
                    <table style="width:100%; font-size:0.85rem; margin-top:8px;">
                        <tr>
                            <td><strong>ACTIF</strong></td>
                            <td><strong>PASSIF</strong></td>
                        </tr>
                        <tr>
                            <td>48 - Cr√©ances : ${fmt(totalCreances)}#</td>
                            <td>135 - Fonds : ${fmt(potAAA.solde || 0)}#</td>
                        </tr>
                        <tr>
                            <td>580 - Caisse : ${fmt(potAAA.solde || 0)}#</td>
                            <td></td>
                        </tr>
                        <tr style="border-top:1px solid #ccc;">
                            <td colspan="2"># en circulation : ${fmt(potAAA.circulationHash || 0)}#</td>
                        </tr>
                        <tr>
                            <td colspan="2">Membres : ${potAAA.membres?.length || 0}</td>
                        </tr>
                    </table>
                </div>
                
                <div style="background:#f3f4f6; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0 0 5px 0; font-weight:bold;">üìí Journal (5 derni√®res)</p>
                    <table style="width:100%; border-collapse:collapse;">
                        ${journalHtml}
                    </table>
                </div>
                
                <hr style="margin: 10px 0;">
                ${!isMembre ? `
                    <p>‚ùå Tu n'es pas encore membre.</p>
                    <div style="background:#fffbeb; padding:10px; border-radius:8px; margin:8px 0; font-size:0.85rem; line-height:1.4; color:#78350f;">
                        <p style="margin:0; font-style:italic;">"Tout humain, par le simple fait de son existence, cr√©e une m√™me masse de valeur d'√©change."</p>
                        <p style="margin:6px 0 0 0;">Les # financent ce que la communaut√© consid√®re comme utile : eau, nourriture, soins, √©cole, justice, culture‚Ä¶</p>
                        <p style="margin:4px 0 0 0; font-size:0.8rem;">üåê <a href="https://espoyr.com" target="_blank" style="color:#2563eb;">espoyr.com</a></p>
                    </div>
                ` : `
                    <p>‚úÖ <strong>Tu es membre</strong></p>
                    <p>Ton solde # : <strong>${fmt(myEspoyr)}#</strong></p>
                    ${maCreance > 0 ? `<p style="color:var(--orange);">Cr√©dit en cours : ${fmt(maCreance)}#</p>` : ''}
                    <div style="background:#fffbeb;padding:8px;border-radius:6px;margin:8px 0;font-size:0.85rem;">
                        <p style="margin:0;">üí° Les cr√©dits sont soumis au <strong>vote des membres</strong>.</p>
                        <p style="margin:4px 0 0 0;">Pot disponible : <strong>${fmt(potAAA.solde || 0)}#</strong></p>
                    </div>
                    <div style="display: flex; gap: 10px; margin: 10px 0;">
                        <input type="number" id="aaaAmount" min="1" max="${potAAA.solde || 0}" value="10" placeholder="Montant #">
                    </div>
                `}
            `, `
                ${!isMembre ? `<button class="btn btn-primary" onclick="joinAAA()">${LOGO_AAA} Devenir membre</button>` : `
                    <button class="btn btn-primary" onclick="contributeAAA()">‚¨ÜÔ∏è Cotiser</button>
                    <button class="btn btn-secondary" onclick="creditAAA()">üó≥Ô∏è Demander cr√©dit</button>
                `}
                <button class="btn" style="background:#f3f4f6;" onclick="closeModal()">Fermer</button>
            `);
        }
        
        async function joinAAA() {
            COMPTABILITE.potAAA.membres = COMPTABILITE.potAAA.membres || [];
            if (!COMPTABILITE.potAAA.membres.includes(myPlayerId)) {
                COMPTABILITE.potAAA.membres.push(myPlayerId);
            }
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/membreAAA`).set(true);
            await syncComptabiliteToFirebase();
            
            closeModal();
            sendSystemMessage(`${LOGO_AAA} ${myName} rejoint le Pot AAA !`);
            showAAAModal();
        }
        
        async function contributeAAA() {
            const amount = parseInt(document.getElementById('aaaAmount').value) || 0;
            if (amount <= 0) return;
            
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            if ((caisse?.espoyr || 0) < amount) {
                alert('Pas assez de # !');
                return;
            }
            
            await comptaCotisationAAA(myPlayerId, amount);
            
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(caisse.espoyr);
            await syncComptabiliteToFirebase();
            
            closeModal();
            sendSystemMessage(`${LOGO_AAA} ${myName} cotise ${fmt(amount)}# au Pot AAA`);
            showAAAModal();
        }
        
        async function creditAAA() {
            const amount = parseInt(document.getElementById('aaaAmount').value) || 0;
            if (amount <= 0) return;
            
            if (COMPTABILITE.potAAA.solde < amount) {
                alert(`Pas assez dans le pot ! Disponible : ${fmt(COMPTABILITE.potAAA.solde)}#`);
                return;
            }
            
            // Les autres membres doivent valider la demande de cr√©dit
            closeModal();
            await lancerVoteCreditAAA(amount);
        }
        
        // Vote des membres AAA pour valider un cr√©dit
        async function lancerVoteCreditAAA(amount) {
            const membres = COMPTABILITE.potAAA.membres || [];
            const autresMembres = membres.filter(id => id !== myPlayerId);
            
            // Si seul membre, cr√©dit auto-accord√©
            if (autresMembres.length === 0) {
                await executerCreditAAA(amount);
                return;
            }
            
            const players = getOrderedPlayers();
            const votes = [];
            let nbPour = 1; // Le demandeur vote pour
            let nbContre = 0;
            
            votes.push({ name: playersData[myPlayerId]?.name || 'Moi', vote: '‚úÖ', detail: 'Demandeur' });
            
            for (const membreId of autresMembres) {
                const p = playersData[membreId];
                if (!p) continue;
                
                if (p.isBot) {
                    const profil = PROFILS_IA[p.botProfil] || PROFILS_IA.EQUILIBRE;
                    // Bots coop√©ratifs/solidaires acceptent, pr√©dateurs refusent, autres selon montant
                    let accepte = false;
                    if (['COOPERATIF', 'SOLIDAIRE'].includes(profil.id)) {
                        accepte = true;
                    } else if (['EQUILIBRE', 'PRUDENT'].includes(profil.id)) {
                        // Accepte si montant raisonnable (< 30% du pot)
                        accepte = amount <= COMPTABILITE.potAAA.solde * 0.3;
                    } else {
                        // PREDATEUR, INVESTISSEUR: refuse
                        accepte = false;
                    }
                    votes.push({ name: p.name, vote: accepte ? '‚úÖ' : '‚ùå' });
                    if (accepte) nbPour++; else nbContre++;
                } else {
                    // Joueur humain ‚Äî auto-accept√© pour simplifier (en multijoueur r√©el, syst√®me Firebase)
                    votes.push({ name: p.name, vote: '‚úÖ', detail: 'Humain' });
                    nbPour++;
                }
            }
            
            // Majorit√© simple (> 50% des membres)
            const totalVotants = nbPour + nbContre;
            const accepte = nbPour > totalVotants / 2;
            
            let votesHtml = votes.map(v => `<p style="margin:2px 0;">${v.vote} ${v.name}</p>`).join('');
            
            if (accepte) {
                await executerCreditAAA(amount);
                
                showModal(`
                    <h3>‚úÖ Cr√©dit AAA approuv√© !</h3>
                    <div style="background:#dcfce7;padding:10px;border-radius:8px;margin:10px 0;">
                        <p style="margin:0;font-weight:bold;">Votes des membres :</p>
                        ${votesHtml}
                    </div>
                    <p style="font-weight:bold;color:#059669;">
                        ${fmt(amount)}# accord√©s √† ${myName}
                    </p>
                    <p style="font-size:0.85rem;color:#6b7280;">
                        Pot restant : ${fmt(COMPTABILITE.potAAA.solde)}#
                    </p>
                `, `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
            } else {
                sendSystemMessage(`${LOGO_AAA} Demande de cr√©dit de ${fmt(amount)}# refus√©e par les membres (${nbPour}/${totalVotants})`);
                
                showModal(`
                    <h3>‚ùå Cr√©dit refus√©</h3>
                    <div style="background:#fee2e2;padding:10px;border-radius:8px;margin:10px 0;">
                        <p style="margin:0;font-weight:bold;">Votes des membres :</p>
                        ${votesHtml}
                    </div>
                    <p style="color:#dc2626;">
                        La majorit√© des membres n'a pas approuv√© le cr√©dit de ${fmt(amount)}#.
                    </p>
                `, `
                    <button class="btn btn-secondary" onclick="showAAAModal()">‚¨ÖÔ∏è Retour</button>
                `);
            }
        }
        
        // Ex√©cuter le cr√©dit apr√®s approbation
        async function executerCreditAAA(amount) {
            await comptaCreditAAA(myPlayerId, amount);
            
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(caisse.espoyr);
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`${LOGO_AAA} ${myName} emprunte ${fmt(amount)}# au Pot AAA (approuv√© par les membres)`);
        }
        
        // ========== BANQUE ==========
        function showBankModal() {
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const dette = caisse.emprunt || 0;
            
            // Limite emprunt
            const players = Object.values(playersData);
            const masseMonetaire = Object.values(COMPTABILITE.caisseJoueurs).reduce((s, c) => s + (c.euro || 0), 0);
            const limiteCalculee = Math.max(CONFIG.limiteEmpruntMin, Math.floor(masseMonetaire / players.length));
            const disponible = Math.max(0, limiteCalculee - dette);
            
            // Bilan comptable de la banque - √âQUILIBR√â
            const banque = COMPTABILITE.banque || {};
            normalizeComptabilite();
            
            // Ancien syst√®me (pour compatibilit√©)
            const reductionValeur = banque.reductionValeur || 0;
            const creances = banque.creancesJoueurs || 0;
            const creancesNettes = creances - reductionValeur;
            const capitalBancaire = banque.capital || 0;
            const interets = banque.interetsRecus || 0;
            
            // ===== NOUVEAU: Syst√®me formalis√© =====
            const bilanBanque = calculerBilanBanque();
            const gl = banque.grandLivre || {};
            const E = (gl[1200] || 0);
            const C_requis = arrondir2(0.10 * E);
            const P_requis = arrondir2(0.05 * E);
            const verifPret = banquePeutPreter(100); // Test avec 100‚Ç¨
            
            // Journal bancaire formalis√© (5 derni√®res √©critures)
            const journalBanqueF = (banque.journalBanque || []).filter(e => e && e.debit_account && e.credit_account && e.amount != null).slice(-5).reverse();
            const journalFHtml = journalBanqueF.length > 0 ? 
                journalBanqueF.map(e => `<tr>
                    <td style="font-size:0.65rem; color:#6b7280;">${e.event_type}</td>
                    <td style="font-size:0.65rem;">D:${e.debit_account ?? '?'}</td>
                    <td style="font-size:0.65rem;">C:${e.credit_account ?? '?'}</td>
                    <td style="font-size:0.65rem; text-align:right; font-weight:bold;">${fmt(e.amount ?? 0)}‚Ç¨</td>
                </tr>`).join('') :
                '<tr><td colspan="4" style="font-size:0.7rem; color:#9ca3af;">Aucune √©criture</td></tr>';
            
            // Journal ancien syst√®me (5 derni√®res √©critures)
            const journalBanque = (banque.journal || []).slice(-5).reverse();
            const journalHtml = journalBanque.length > 0 ? 
                journalBanque.map(e => `<tr>
                    <td style="font-size:0.7rem;">#${e.id}</td>
                    <td style="font-size:0.7rem;">${e.libelle}</td>
                    <td style="font-size:0.7rem; text-align:right;">${fmt(e.debit?.euro || 0)}‚Ç¨</td>
                </tr>`).join('') :
                '<tr><td colspan="3" style="font-size:0.7rem; color:#9ca3af;">Aucune √©criture</td></tr>';
            
            showModal(`
                <h3>üè¶ Banque - Comptabilit√© Formalis√©e</h3>
                
                <!-- NOUVEAU BILAN FORMALIS√â -->
                <div style="background: linear-gradient(135deg, #dbeafe, #e0e7ff); padding:12px; border-radius:8px; margin-bottom:10px; border: 2px solid #3b82f6;">
                    <p style="margin:0 0 8px 0; font-weight:bold; color:#1e40af;">üìä Bilan Bancaire (Norme BCE)</p>
                    
                    <!-- Variables cl√©s -->
                    <div style="background: white; padding: 8px; border-radius: 6px; margin-bottom: 8px;">
                        <p style="margin: 0; font-size: 0.8rem; font-weight: bold;">Variables prudentielles:</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px;">
                            <div style="background: #f0f9ff; padding: 4px; border-radius: 4px; text-align: center;">
                                <p style="margin: 0; font-size: 0.7rem; color: #6b7280;">E (Encours)</p>
                                <p style="margin: 0; font-weight: bold; color: #1e40af;">${E.toFixed(0)}‚Ç¨</p>
                            </div>
                            <div style="background: #f0fdf4; padding: 4px; border-radius: 4px; text-align: center;">
                                <p style="margin: 0; font-size: 0.7rem; color: #6b7280;">C (10% E)</p>
                                <p style="margin: 0; font-weight: bold; color: #059669;">${C_requis.toFixed(0)}‚Ç¨</p>
                            </div>
                            <div style="background: #fef3c7; padding: 4px; border-radius: 4px; text-align: center;">
                                <p style="margin: 0; font-size: 0.7rem; color: #6b7280;">P (5% E)</p>
                                <p style="margin: 0; font-weight: bold; color: #d97706;">${P_requis.toFixed(0)}‚Ç¨</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <!-- ACTIF -->
                        <div style="background: #bfdbfe; padding: 8px; border-radius: 6px;">
                            <p style="margin: 0; font-weight: bold; color: #1e40af; font-size: 0.9rem;">ACTIF</p>
                            <table style="width: 100%; font-size: 0.75rem; margin-top: 5px;">
                                <tr><td>1010 R√©serves</td><td style="text-align:right;">${(gl[1010] || 0).toFixed(0)}‚Ç¨</td></tr>
                                <tr><td><strong>1200 Encours (E)</strong></td><td style="text-align:right;"><strong>${E.toFixed(0)}‚Ç¨</strong></td></tr>
                                <tr><td>1300 Int. √† recevoir</td><td style="text-align:right;">${(gl[1300] || 0).toFixed(0)}‚Ç¨</td></tr>
                            </table>
                            <hr style="margin: 5px 0; border-color: #93c5fd;">
                            <p style="margin: 0; font-weight: bold; font-size: 0.85rem; text-align: right;">
                                Total: ${bilanBanque.actif.totalActif.toFixed(0)}‚Ç¨
                            </p>
                        </div>
                        <!-- PASSIF + CAPITAUX -->
                        <div style="background: #fecaca; padding: 8px; border-radius: 6px;">
                            <p style="margin: 0; font-weight: bold; color: #991b1b; font-size: 0.9rem;">PASSIF + CP</p>
                            <table style="width: 100%; font-size: 0.75rem; margin-top: 5px;">
                                <tr><td>2290 Provision</td><td style="text-align:right;">${(gl[2290] || 0).toFixed(0)}‚Ç¨</td></tr>
                                <tr style="background: #fee2e2;"><td>3000 Capital banque</td><td style="text-align:right;">${(gl[3000] || 0).toFixed(0)}‚Ç¨</td></tr>
                                <tr style="background: #fee2e2;"><td>3100 R√©serves / R√©sultat</td><td style="text-align:right;">${(gl[3100] || 0).toFixed(0)}‚Ç¨</td></tr>
                            </table>
                            <hr style="margin: 5px 0; border-color: #fca5a5;">
                            <p style="margin: 0; font-weight: bold; font-size: 0.85rem; text-align: right;">
                                Total: ${bilanBanque.equilibre.totalPassifCapitaux.toFixed(0)}‚Ç¨
                            </p>
                        </div>
                    </div>
                    
                    <!-- R√©sultat -->
                    <div style="background: white; padding: 6px 8px; border-radius: 6px; margin-top: 8px;">
                        <p style="margin: 0; font-size: 0.8rem;">
                            <strong>R√©sultat:</strong> 
                            4000 Produits int√©r√™ts: <span style="color: #059669;">+${(gl[4000] || 0).toFixed(0)}‚Ç¨</span>
                            | 5000 Dotation provision: <span style="color: #dc2626;">-${(gl[5000] || 0).toFixed(0)}‚Ç¨</span>
                            = <strong>${bilanBanque.resultat.resultatNet.toFixed(0)}‚Ç¨</strong>
                        </p>
                    </div>
                    
                    <!-- √âquilibre -->
                    <p style="margin: 8px 0 0 0; text-align: center; font-weight: bold; font-size: 0.85rem; color: ${Math.abs(bilanBanque.equilibre.ecart) < 1 ? '#059669' : '#dc2626'};">
                        ${Math.abs(bilanBanque.equilibre.ecart) < 1 ? '‚úÖ Bilan √©quilibr√©' : '‚ö†Ô∏è √âcart: ' + bilanBanque.equilibre.ecart.toFixed(2) + '‚Ç¨'}
                    </p>
                    
                    <!-- Capacit√© de pr√™t -->
                    <div style="background: ${verifPret.peutPreter ? '#dcfce7' : '#fee2e2'}; padding: 6px 8px; border-radius: 6px; margin-top: 8px;">
                        <p style="margin: 0; font-size: 0.8rem;">
                            ${verifPret.peutPreter ? 
                                '‚úÖ Banque peut pr√™ter (Capital suffisant)' : 
                                `‚ö†Ô∏è Capital insuffisant (d√©ficit: ${verifPret.deficit.toFixed(0)}‚Ç¨)`}
                        </p>
                    </div>
                </div>
                
                <!-- Journal formalis√© -->
                <div style="background:#f0f9ff; padding:8px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0 0 5px 0; font-weight:bold; font-size: 0.85rem;">üìí Journal Banque (format replay)</p>
                    <table style="width:100%; border-collapse:collapse;">
                        <tr style="background: #dbeafe;">
                            <th style="text-align:left; padding:2px; font-size:0.65rem;">Event</th>
                            <th style="text-align:left; padding:2px; font-size:0.65rem;">D√©bit</th>
                            <th style="text-align:left; padding:2px; font-size:0.65rem;">Cr√©dit</th>
                            <th style="text-align:right; padding:2px; font-size:0.65rem;">‚Ç¨</th>
                        </tr>
                        ${journalFHtml}
                    </table>
                </div>
                
                <hr style="margin: 10px 0;">
                <p style="font-weight:bold;">üí≥ Ton compte</p>
                <p><strong>Ta dette :</strong> ${fmt(dette)}‚Ç¨</p>
                <p><strong>Limite d'emprunt :</strong> ${fmt(limiteCalculee)}‚Ç¨</p>
                <p style="font-size: 0.8rem; color: var(--gray);">= max(${CONFIG.limiteEmpruntMin}‚Ç¨, ${fmt(masseMonetaire)}‚Ç¨ √∑ ${players.length})</p>
                <p><strong style="color: ${disponible > 0 ? 'var(--green)' : 'var(--red)'};">Disponible : ${fmt(disponible)}‚Ç¨</strong></p>
                ${disponible > 0 ? `
                    <label>Montant √† emprunter :</label>
                    <input type="number" id="bankLoanAmount" min="10" max="${disponible}" value="${Math.min(100, disponible)}" step="10">
                    <p style="font-size: 0.8rem; color: var(--orange);">‚ö†Ô∏è Int√©r√™ts : ${CONFIG.tauxInteret * 100}% par tour</p>
                ` : `<p style="color: var(--red);">‚ùå Limite atteinte</p>`}
                ${dette > 0 && (caisse.euro || 0) > 0 ? `
                    <hr style="margin: 10px 0;">
                    <label>Rembourser :</label>
                    <input type="number" id="bankRepayAmount" min="10" max="${Math.min(dette, caisse.euro || 0)}" value="${Math.min(dette, caisse.euro || 0)}" step="10">
                ` : ''}
            `, `
                ${disponible > 0 ? `<button class="btn btn-primary" onclick="takeBankLoan()">üí∞ Emprunter</button>` : ''}
                ${dette > 0 && (caisse.euro || 0) > 0 ? `<button class="btn btn-secondary" onclick="repayBankLoan()">üí∏ Rembourser</button>` : ''}
                <button class="btn" style="background:#e0e7ff; color:#3730a3;" onclick="showExportJournalBanque()">üì§ Export</button>
                <button class="btn" style="background:#f3f4f6;" onclick="closeModal()">Fermer</button>
            `);
        }
        
        // Fonction pour exporter le journal banque
        function showExportJournalBanque() {
            const exportData = exporterJournalBanque();
            const jsonStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ESPOYR_Journal_Banque_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            sendSystemMessage('üì§ Journal banque export√©');
        }
        
        async function takeBankLoan() {
            const amount = parseInt(document.getElementById('bankLoanAmount').value) || 0;
            if (amount <= 0) return;
            
            await comptaEmprunt(myPlayerId, amount);
            
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, emprunt: caisse.emprunt
            });
            await syncComptabiliteToFirebase();
            
            closeModal();
            sendSystemMessage(`üè¶ ${myName} emprunte ${fmt(amount)}‚Ç¨`);
        }
        
        async function repayBankLoan() {
            const amount = parseInt(document.getElementById('bankRepayAmount').value) || 0;
            if (amount <= 0) return;
            
            await comptaRemboursement(myPlayerId, amount);
            
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, emprunt: caisse.emprunt
            });
            await syncComptabiliteToFirebase();
            
            closeModal();
            sendSystemMessage(`üí∏ ${myName} rembourse ${fmt(amount)}‚Ç¨`);
        }
        
        // ========== INFO CASE ==========
        async function showCaseInfo(caseId) {
            const c = CASES[caseId];
            if (!c || c.type !== 'activite') {
                showModal(`<h3>${c.icon} ${c.name}</h3><p>${c.type}</p>`,
                    `<button class="btn btn-secondary" onclick="closeModal()">Fermer</button>`);
                return;
            }
            
            const activitesSnap = await gameRef.child('activites').once('value');
            const activites = activitesSnap.val() || {};
            const equipSnap = await gameRef.child('equipements').once('value');
            const equipements = equipSnap.val() || {};
            const equipTypesSnap = await gameRef.child('equipementTypes').once('value');
            const equipTypes = equipTypesSnap.val() || {};
            
            const owner = activites[caseId];
            const nbEquip = equipements[caseId] || 0;
            const equipList = equipTypes[caseId] || [];  // ['A', 'B'] ou ['A', 'A'] etc.
            const equipDisplay = equipList.length > 0 ? equipList.join('+') : 'Aucun';
            
            // Calcul facture = 5% du total investi
            const factureActuelle = calculerFactureActivite(caseId, equipList);
            const caisseAct = COMPTABILITE.caisseActivites[caseId] || {};
            
            const players = Object.values(playersData);
            const ownerPlayer = owner ? players.find(p => p.id === owner) : null;
            const isMine = owner === myPlayerId;
            
            // Journal comptable de l'activit√©
            const journal = caisseAct.journal || [];
            const derniers5 = journal.slice(-5).reverse();
            
            // Calculer le bilan
            const nbAInfo = equipList.filter(e => e === 'A').length;
            const nbBInfo = equipList.filter(e => e === 'B').length;
            let valeurEquipements = 0;
            if (nbAInfo > 0) valeurEquipements += getPrixA(caseId);
            if (nbAInfo > 1) valeurEquipements += getPrixB(caseId) * (nbAInfo - 1);
            valeurEquipements += getPrixB(caseId) * nbBInfo;
            const resultat = (caisseAct.recettes || 0) - (caisseAct.depenses || 0);
            
            const bilan = {
                actif: {
                    immobilisation: c.prix || 0,
                    equipements: valeurEquipements,
                    tresorerie: resultat  // Tr√©sorerie = R√©sultat
                },
                passif: {
                    capitalInitial: c.prix || 0,
                    apportsEquipements: valeurEquipements,  // Apports en capital pour √©quipements
                    resultat: resultat
                }
            };
            bilan.actif.total = bilan.actif.immobilisation + bilan.actif.equipements + bilan.actif.tresorerie;
            bilan.passif.total = bilan.passif.capitalInitial + bilan.passif.apportsEquipements + bilan.passif.resultat;
            
            // V√©rification √©quilibre
            const equilibre = Math.abs(bilan.actif.total - bilan.passif.total) < 1;
            
            let content = `
                <h3>${c.icon} ${c.name}</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <!-- Infos g√©n√©rales -->
                    <div style="background: #f3f4f6; padding: 10px; border-radius: 8px;">
                        <p style="font-weight: bold; margin: 0 0 8px 0;">üìä Informations</p>
                        <p style="margin: 4px 0;"><strong>Prix achat :</strong> ${fmt(c.prix)}‚Ç¨</p>
                        <p style="margin: 4px 0;"><strong>Facture base :</strong> ${fmt(calculerFactureActivite(caseId, []))}‚Ç¨ (5% de ${fmt(c.prix)}‚Ç¨)</p>
                        <p style="margin: 4px 0;"><strong>√âquipements :</strong> ${equipDisplay}</p>
                        <p style="margin: 4px 0; font-size: 1.1rem;"><strong>Facture actuelle :</strong> <span style="color: #059669;">${fmt(factureActuelle)}‚Ç¨</span> <span style="font-size:0.8rem;">(5% total investi)</span></p>
                    </div>
                    
                    <!-- Bilan en format horizontal -->
                    <div style="background: #dbeafe; padding: 10px; border-radius: 8px;">
                        <p style="font-weight: bold; margin: 0 0 8px 0; text-align: center;">üìã Bilan ${equilibre ? '‚úÖ' : '‚ö†Ô∏è'}</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <!-- ACTIF -->
                            <div style="background: #bfdbfe; padding: 6px; border-radius: 6px;">
                                <p style="margin: 0 0 6px 0; font-weight: bold; text-align: center; color: #1e40af;">ACTIF</p>
                                <div style="font-size: 0.8rem;">
                                    <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                        <span>Immobilisation</span><span>${fmt(bilan.actif.immobilisation)}‚Ç¨</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                        <span>√âquipements</span><span>${fmt(bilan.actif.equipements)}‚Ç¨</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                        <span>Tr√©sorerie</span><span style="color: ${bilan.actif.tresorerie >= 0 ? '#059669' : '#dc2626'};">${fmt(bilan.actif.tresorerie)}‚Ç¨</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 4px 0; margin-top: 4px; border-top: 2px solid #3b82f6; font-weight: bold;">
                                        <span>TOTAL</span><span>${fmt(bilan.actif.total)}‚Ç¨</span>
                                    </div>
                                </div>
                            </div>
                            <!-- PASSIF -->
                            <div style="background: #fecaca; padding: 6px; border-radius: 6px;">
                                <p style="margin: 0 0 6px 0; font-weight: bold; text-align: center; color: #991b1b;">PASSIF</p>
                                <div style="font-size: 0.8rem;">
                                    <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                        <span>Capital initial</span><span>${fmt(bilan.passif.capitalInitial)}‚Ç¨</span>
                                    </div>
                                    ${bilan.passif.apportsEquipements > 0 ? `
                                    <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                        <span>Apports √©quip.</span><span>${fmt(bilan.passif.apportsEquipements)}‚Ç¨</span>
                                    </div>
                                    ` : `<div style="padding: 2px 0;">&nbsp;</div>`}
                                    <div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                        <span>R√©sultat</span><span style="color: ${bilan.passif.resultat >= 0 ? '#059669' : '#dc2626'};">${fmt(bilan.passif.resultat)}‚Ç¨</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 4px 0; margin-top: 4px; border-top: 2px solid #ef4444; font-weight: bold;">
                                        <span>TOTAL</span><span>${fmt(bilan.passif.total)}‚Ç¨</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Propri√©taire -->
                <div style="margin: 10px 0; padding: 8px; background: ${ownerPlayer ? '#dcfce7' : '#fef3c7'}; border-radius: 6px;">
                    ${ownerPlayer 
                        ? `<strong>Propri√©taire :</strong> ${ownerPlayer.avatar} ${ownerPlayer.name}` 
                        : `<span style="color: var(--orange);">üè∑Ô∏è Disponible √† l'achat</span>`
                    }
                </div>
                
                <!-- Journal comptable -->
                <div style="background: #fefce8; padding: 10px; border-radius: 8px; margin-top: 10px;">
                    <p style="font-weight: bold; margin: 0 0 8px 0;">üìí Journal comptable (5 derni√®res)</p>
                    ${derniers5.length > 0 ? `
                        <div style="max-height: 120px; overflow-y: auto; font-size: 0.8rem;">
                            ${derniers5.map(e => `
                                <div style="padding: 3px 0; border-bottom: 1px solid #fef08a;">
                                    <span style="color: #6b7280;">#${e.id}</span>
                                    ${e.libelle} 
                                    <span style="float: right;">D:${e.debit?.compte || '?'} C:${e.credit?.compte || '?'} | ${fmt(e.debit?.euro || 0)}‚Ç¨${e.debit?.espoyr > 0 ? '+' + e.debit.espoyr + '#' : ''}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #6b7280; font-size: 0.85rem;">Aucune √©criture</p>'}
                </div>
            `;
            
            // Boutons
            let buttons = `
                <button class="btn" style="background:#e0e7ff;color:#4338ca;" onclick="closeModal(); showPlanComptableModal(${caseId});">üìö Plan comptable</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `;
            
            if (isMine) {
                // Bouton ajuster prix
                buttons = `
                    <button class="btn" style="background:#fef3c7;color:#92400e;" onclick="closeModal(); showAjusterPrixModal(${caseId});">üí∞ Ajuster prix</button>
                    ${buttons}
                `;
                
                // Bouton vente √©quipement
                if (nbEquip > 0) {
                    buttons = `
                        <button class="btn" style="background:#dcfce7;color:#059669;" onclick="closeModal(); showVenteEquipementModal(${caseId});">${LOGO_AAA} Vendre √©quipement</button>
                        ${buttons}
                    `;
                }
                
                // Bouton vente activit√©
                const check = canSellActivity(myPlayerId, caseId);
                if (check.canSell) {
                    buttons = `
                        <button class="btn" style="background:#fee2e2;color:#dc2626;" onclick="closeModal(); showVenteActiviteModal(${caseId});">üè∑Ô∏è Vendre activit√©</button>
                        ${buttons}
                    `;
                }
            }
            
            showModal(content, buttons);
        }
        
        // Afficher le plan comptable complet pour une activit√©
        function showPlanComptableModal(caseId) {
            const c = CASES[caseId];
            const caisseAct = COMPTABILITE.caisseActivites[caseId] || {};
            const journal = caisseAct.journal || [];
            
            // Construire les balances par compte
            const balances = {};
            journal.forEach(e => {
                if (e.debit?.compte) {
                    if (!balances[e.debit.compte]) balances[e.debit.compte] = { debit: 0, credit: 0, debitHash: 0, creditHash: 0 };
                    balances[e.debit.compte].debit += e.debit.euro || 0;
                    balances[e.debit.compte].debitHash += e.debit.espoyr || 0;
                }
                if (e.credit?.compte) {
                    if (!balances[e.credit.compte]) balances[e.credit.compte] = { debit: 0, credit: 0, debitHash: 0, creditHash: 0 };
                    balances[e.credit.compte].credit += e.credit.euro || 0;
                    balances[e.credit.compte].creditHash += e.credit.espoyr || 0;
                }
            });
            
            // Grouper par classe
            const parClasse = { 1: [], 2: [], 4: [], 5: [], 6: [], 7: [] };
            Object.entries(balances).forEach(([compte, soldes]) => {
                const classe = Math.floor(parseInt(compte) / 100) || parseInt(compte.charAt(0));
                const info = PLAN_COMPTABLE[compte] || { nom: 'Compte ' + compte, type: '?' };
                const solde = soldes.debit - soldes.credit;
                const soldeHash = soldes.debitHash - soldes.creditHash;
                if (soldes.debit > 0 || soldes.credit > 0 || soldes.debitHash > 0 || soldes.creditHash > 0) {
                    if (!parClasse[classe]) parClasse[classe] = [];
                    parClasse[classe].push({ compte, nom: info.nom, type: info.type, ...soldes, solde, soldeHash });
                }
            });
            
            let content = `
                <h3>üìö Plan Comptable - ${c.icon} ${c.name}</h3>
                <div style="max-height: 450px; overflow-y: auto;">
            `;
            
            const classNames = {
                1: 'üíº Classe 1 - Capitaux',
                2: 'üè† Classe 2 - Immobilisations',
                4: 'ü§ù Classe 4 - Tiers',
                5: 'üí∞ Classe 5 - Financiers',
                6: 'üìâ Classe 6 - Charges',
                7: 'üìà Classe 7 - Produits'
            };
            
            for (const [classe, comptes] of Object.entries(parClasse)) {
                if (comptes.length === 0) continue;
                
                content += `
                    <div style="margin-bottom: 15px;">
                        <p style="font-weight: bold; background: #f3f4f6; padding: 6px 10px; border-radius: 6px; margin: 0 0 8px 0;">
                            ${classNames[classe] || 'Classe ' + classe}
                        </p>
                        <table style="width: 100%; font-size: 0.8rem; border-collapse: collapse;">
                            <tr style="background: #e5e7eb;">
                                <th style="text-align: left; padding: 4px;">Compte</th>
                                <th style="text-align: left; padding: 4px;">Libell√©</th>
                                <th style="text-align: right; padding: 4px;">D√©bit</th>
                                <th style="text-align: right; padding: 4px;">Cr√©dit</th>
                                <th style="text-align: right; padding: 4px;">Solde</th>
                            </tr>
                            ${comptes.map(cp => `
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 3px 4px; font-family: monospace;">${cp.compte}</td>
                                    <td style="padding: 3px 4px;">${cp.nom}</td>
                                    <td style="padding: 3px 4px; text-align: right;">${cp.debit > 0 ? cp.debit + '‚Ç¨' : ''}${cp.debitHash > 0 ? (cp.debit > 0 ? '+' : '') + cp.debitHash + '#' : (cp.debit === 0 ? '-' : '')}</td>
                                    <td style="padding: 3px 4px; text-align: right;">${cp.credit > 0 ? cp.credit + '‚Ç¨' : ''}${cp.creditHash > 0 ? (cp.credit > 0 ? '+' : '') + cp.creditHash + '#' : (cp.credit === 0 ? '-' : '')}</td>
                                    <td style="padding: 3px 4px; text-align: right; font-weight: bold; color: ${cp.solde >= 0 ? '#059669' : '#dc2626'};">
                                        ${cp.solde}‚Ç¨${cp.soldeHash !== 0 ? (cp.soldeHash > 0 ? '+' : '') + cp.soldeHash + '#' : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                `;
            }
            
            // Journal complet
            content += `
                <div style="margin-top: 20px;">
                    <p style="font-weight: bold; background: #fefce8; padding: 6px 10px; border-radius: 6px; margin: 0 0 8px 0;">
                        üìí Journal complet (${journal.length} √©critures)
                    </p>
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table style="width: 100%; font-size: 0.75rem; border-collapse: collapse;">
                            <tr style="background: #fef08a;">
                                <th style="padding: 3px;">ID</th>
                                <th style="padding: 3px;">Tour</th>
                                <th style="padding: 3px;">Libell√©</th>
                                <th style="padding: 3px;">D</th>
                                <th style="padding: 3px;">C</th>
                                <th style="padding: 3px;">Montant</th>
                            </tr>
                            ${journal.map(e => `
                                <tr style="border-bottom: 1px solid #fef08a;">
                                    <td style="padding: 2px 3px; font-family: monospace;">${e.id || '?'}</td>
                                    <td style="padding: 2px 3px;">${e.tour || '?'}</td>
                                    <td style="padding: 2px 3px;">${e.libelle || '-'}</td>
                                    <td style="padding: 2px 3px; font-family: monospace;">${e.debit?.compte || '-'}</td>
                                    <td style="padding: 2px 3px; font-family: monospace;">${e.credit?.compte || '-'}</td>
                                    <td style="padding: 2px 3px; text-align: right;">${fmt(e.debit?.euro || 0)}‚Ç¨${e.debit?.espoyr > 0 ? '+' + e.debit.espoyr + '#' : ''}</td>
                                </tr>
                            `).join('')}
                        </table>
                    </div>
                </div>
            `;
            
            content += `</div>`;
            
            showModal(content, `
                <button class="btn" onclick="closeModal(); showCaseInfo(${caseId});">‚¨ÖÔ∏è Retour</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `);
        }
        
        // Modal pour ajuster le prix de passage
        async function showAjusterPrixModal(caseId) {
            const c = CASES[caseId];
            const equipSnap = await gameRef.child('equipements').once('value');
            const equipements = equipSnap.val() || {};
            const nbEquip = equipements[caseId] || 0;
            const equipTypesSnapP = await gameRef.child(`equipementTypes/${caseId}`).once('value');
            const equipTypesP = equipTypesSnapP.val() || [];
            
            // Prix personnalis√© ou d√©faut
            const prixPersoSnap = await gameRef.child(`prixPersonnalises/${caseId}`).once('value');
            const prixPerso = prixPersoSnap.val();
            const prixBase = calculerFactureActivite(caseId, equipTypesP);
            const prixActuel = prixPerso !== null ? prixPerso : prixBase;
            
            showModal(`
                <h3>üí∞ Ajuster le prix de passage</h3>
                <p><strong>${c.icon} ${c.name}</strong></p>
                <p>Prix de base : ${fmt(prixBase)}‚Ç¨</p>
                
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0;">
                    <button class="btn" style="font-size: 1.5rem; padding: 10px 20px;" onclick="ajusterPrix(${caseId}, -10)">‚ûñ</button>
                    <div style="font-size: 2rem; font-weight: bold; min-width: 100px; text-align: center;" id="prixAjuste">${fmt(prixActuel)}‚Ç¨</div>
                    <button class="btn" style="font-size: 1.5rem; padding: 10px 20px;" onclick="ajusterPrix(${caseId}, +10)">‚ûï</button>
                </div>
                
                <p style="font-size: 0.85rem; color: #6b7280;">
                    Tu peux ajuster le prix entre 0‚Ç¨ et ${prixBase * 2}‚Ç¨
                </p>
            `, `
                <button class="btn btn-primary" onclick="validerPrixAjuste(${caseId})">‚úÖ Valider</button>
                <button class="btn" onclick="resetPrix(${caseId})">üîÑ R√©initialiser</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            `);
            
            window.prixAjusteTemp = prixActuel;
            window.prixBaseTemp = prixBase;
        }
        
        function ajusterPrix(caseId, delta) {
            const min = 0;
            const max = window.prixBaseTemp * 2;
            window.prixAjusteTemp = Math.max(min, Math.min(max, window.prixAjusteTemp + delta));
            document.getElementById('prixAjuste').textContent = window.prixAjusteTemp + '‚Ç¨';
        }
        
        async function validerPrixAjuste(caseId) {
            await gameRef.child(`prixPersonnalises/${caseId}`).set(window.prixAjusteTemp);
            closeModal();
            sendSystemMessage(`üí∞ ${myName} a ajust√© le prix de ${CASES[caseId].name} √† ${fmt(window.prixAjusteTemp)}‚Ç¨`);
        }
        
        async function resetPrix(caseId) {
            await gameRef.child(`prixPersonnalises/${caseId}`).remove();
            window.prixAjusteTemp = window.prixBaseTemp;
            document.getElementById('prixAjuste').textContent = window.prixAjusteTemp + '‚Ç¨';
        }
        
        // ========== SAUVEGARDE ==========
        // ========== SAUVEGARDE COMPL√àTE AUDIT + REPLAY ==========
        
        // Construire l'√©tat complet du jeu
        function buildGameState() {
            const players = Object.values(playersData);
            const positions = {};
            const playersState = {};
            
            players.forEach(p => {
                positions[p.id] = p.position;
                const caisse = COMPTABILITE.caisseJoueurs[p.id] || {};
                playersState[p.id] = {
                    name: p.name,
                    avatar: p.avatar,
                    profil: p.profil || 'contributif',
                    isBot: p.isBot || false,
                    botProfil: p.botProfil || null,
                    wallet: { 
                        euro: caisse.euro || 0, 
                        espoyr: caisse.espoyr || 0 
                    },
                    debts: { 
                        bankEuro: caisse.emprunt || 0, 
                        potAAAEspoyr: COMPTABILITE.potAAA.creances?.[p.id] || 0 
                    },
                    assets: {
                        activities: Object.entries(COMPTABILITE.caisseActivites)
                            .filter(([id, act]) => act.proprietaireId === p.id)
                            .map(([id]) => id),
                        equipments: []  // √Ä remplir
                    },
                    membreAAA: COMPTABILITE.potAAA.membres?.includes(p.id) || false
                };
            });
            
            return {
                turn: gameState?.turn || 1,
                phase: gameState?.phase || 1,
                currentPlayerIndex: gameState?.currentPlayerIndex || 0,
                toursComplets: gameState?.toursComplets || 0,
                board: { positions },
                players: playersState,
                entities: {
                    etat: { 
                        soldeEuro: COMPTABILITE.etat.tresor || 0, 
                        taxesRecues: COMPTABILITE.etat.taxesRecues || 0, 
                        salairesVerses: COMPTABILITE.etat.salairesVerses || 0 
                    },
                    exportation: { 
                        soldeEuro: COMPTABILITE.exportation?.solde || 0, 
                        recettes: COMPTABILITE.exportation?.recettes || 0, 
                        salairesVerses: COMPTABILITE.exportation?.salairesVerses || 0 
                    },
                    potAAA: { 
                        soldeEspoyr: COMPTABILITE.potAAA.solde || 0, 
                        circulationHash: COMPTABILITE.potAAA.circulationHash || 0, 
                        membres: COMPTABILITE.potAAA.membres || [] 
                    },
                    banque: { 
                        creancesJoueursEuro: COMPTABILITE.banque.creancesJoueurs || 0, 
                        interetsRecusEuro: COMPTABILITE.banque.interetsRecus || 0,
                        masseMonetaire: COMPTABILITE.banque.masseMonetaire || 0,
                        reductionValeur: COMPTABILITE.banque.reductionValeur || 0
                    }
                },
                markets: {
                    auctions: enchereEnCours ? [enchereEnCours] : [],
                    forSale: []
                }
            };
        }
        
        // Valider le ledger (toutes les √©critures √©quilibr√©es)
        function validateLedger() {
            const errors = [];
            
            GAME_SAVE.ledger.forEach(entry => {
                const totalDebit = entry.debit.reduce((sum, d) => sum + d.amount, 0);
                const totalCredit = entry.credit.reduce((sum, c) => sum + c.amount, 0);
                
                if (totalDebit !== totalCredit) {
                    errors.push({
                        ledgerEntryId: entry.ledgerEntryId,
                        error: `D√©s√©quilibre: D=${totalDebit} C=${totalCredit}`,
                        currency: entry.currency
                    });
                }
            });
            
            return { valid: errors.length === 0, errors };
        }
        
        // Exporter la sauvegarde compl√®te
        async function saveGame() {
            // Mettre √† jour l'√©tat
            GAME_SAVE.gameId = `ESPOYR_${currentGameCode}`;
            GAME_SAVE.lastSavedAt = new Date().toISOString();
            if (!GAME_SAVE.createdAt) GAME_SAVE.createdAt = GAME_SAVE.lastSavedAt;
            
            // Construire l'√©tat actuel
            GAME_SAVE.state = buildGameState();
            
            // Cr√©er un snapshot
            createSnapshot();
            
            // Valider le ledger
            const validation = validateLedger();
            if (!validation.valid) {
                console.warn('‚ö†Ô∏è Ledger non √©quilibr√©:', validation.errors);
            }
            
            // R√©cup√©rer les donn√©es Firebase
            const gameSnap = await gameRef.once('value');
            const firebaseData = gameSnap.val();
            
            // Construire la sauvegarde compl√®te
            const saveData = {
                schemaVersion: SCHEMA_VERSION,
                gameId: GAME_SAVE.gameId,
                createdAt: GAME_SAVE.createdAt,
                lastSavedAt: GAME_SAVE.lastSavedAt,
                
                rng: GAME_SAVE.rng,
                
                state: GAME_SAVE.state,
                
                events: GAME_SAVE.events,
                eventCounter: GAME_SAVE.eventCounter,
                
                ledger: GAME_SAVE.ledger,
                ledgerCounter: GAME_SAVE.ledgerCounter,
                
                snapshots: GAME_SAVE.snapshots,
                
                indexes: GAME_SAVE.indexes,
                
                // Donn√©es brutes Firebase (backup)
                firebase: {
                    code: currentGameCode,
                    data: firebaseData
                },
                
                // Comptabilit√© d√©taill√©e
                comptabilite: COMPTABILITE,
                
                // Config
                config: gameConfig,
                
                // Validation
                validation: validation
            };
            
            const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ESPOYR_${currentGameCode}_T${gameState?.turn || 1}_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            sendSystemMessage(`üíæ Sauvegarde compl√®te par ${myName} (${GAME_SAVE.events.length} events, ${GAME_SAVE.ledger.length} √©critures)`);
        }
        
        // Charger une sauvegarde
        async function loadGameFromFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const saveData = JSON.parse(e.target.result);
                        
                        // V√©rifier la version
                        if (saveData.schemaVersion && saveData.schemaVersion !== SCHEMA_VERSION) {
                            console.warn(`‚ö†Ô∏è Version diff√©rente: ${saveData.schemaVersion} vs ${SCHEMA_VERSION}`);
                        }
                        
                        // Restaurer GAME_SAVE
                        if (saveData.events) GAME_SAVE.events = saveData.events;
                        if (saveData.ledger) GAME_SAVE.ledger = saveData.ledger;
                        if (saveData.snapshots) GAME_SAVE.snapshots = saveData.snapshots;
                        if (saveData.indexes) GAME_SAVE.indexes = saveData.indexes;
                        if (saveData.rng) GAME_SAVE.rng = saveData.rng;
                        if (saveData.eventCounter) GAME_SAVE.eventCounter = saveData.eventCounter;
                        if (saveData.ledgerCounter) GAME_SAVE.ledgerCounter = saveData.ledgerCounter;
                        GAME_SAVE.gameId = saveData.gameId;
                        GAME_SAVE.createdAt = saveData.createdAt;
                        
                        // Restaurer la comptabilit√©
                        if (saveData.comptabilite) {
                            COMPTABILITE = saveData.comptabilite;
                            normalizeComptabilite();
                        }
                        
                        // Restaurer la config
                        if (saveData.config) {
                            gameConfig = { ...CONFIG, ...saveData.config };
                        }
                        
                        resolve(saveData);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        
        // Reprendre √† partir d'un eventId
        function replayFromEvent(targetEventId) {
            const snapshot = findSnapshotBefore(targetEventId);
            if (!snapshot) {
                console.error('Aucun snapshot trouv√© avant', targetEventId);
                return false;
            }
            
            // Restaurer l'√©tat du snapshot
            const state = snapshot.state;
            gameState = state.gameState;
            playersData = state.playersData;
            COMPTABILITE = state.COMPTABILITE;
            gameConfig = state.gameConfig;
            normalizeComptabilite();
            
            // Trouver les events √† rejouer
            const snapshotEventIndex = GAME_SAVE.events.findIndex(e => e.eventId === snapshot.eventCursor);
            const targetEventIndex = GAME_SAVE.events.findIndex(e => e.eventId === targetEventId);
            
            console.log(`üìº Replay depuis snapshot ${snapshot.snapshotId} (event ${snapshotEventIndex}) jusqu'√† ${targetEventId} (event ${targetEventIndex})`);
            
            // Note: Le replay r√©el n√©cessiterait d'ex√©cuter les actions
            // Pour l'instant, on restaure juste l'√©tat du snapshot
            
            return true;
        }
        
        // ========== ACTIONS RAPIDES ==========
        
        // Action rapide : Devenir membre AAA
        function showQuickAdhererAAA() {
            const isMembre = COMPTABILITE.potAAA.membres?.includes(myPlayerId);
            
            if (isMembre) {
                showModal(`
                    <h3>${LOGO_AAA} Tu es membre AAA</h3>
                    <p>Tes avantages actifs :</p>
                    <ul style="font-size: 0.9rem;">
                        <li>+50# cr√©√©s dans le Pot √† chaque lancer de d√©</li>
                        <li>Demander un cr√©dit en # (0%, valid√© par les membres)</li>
                        <li>Compl√©ment de salaire en # si √©rosion (Phase 2+)</li>
                        <li>Aide en cas de faillite</li>
                    </ul>
                `, `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
            } else {
                showModal(`
                    <h3>${LOGO_AAA} Devenir membre AAA</h3>
                    <div style="background:#fffbeb; padding:12px; border-radius:10px; margin:10px 0; font-size:0.88rem; line-height:1.5; color:#78350f;">
                        <p style="margin:0;">Les membres AAA sont des citoyens qui pensent que la cr√©ation de valeur d'√©change doit r√©pondre √† une <strong>loi universelle</strong> :</p>
                        <p style="margin:8px 0; font-style:italic; font-weight:bold; color:#92400e;">
                            "Tout humain, par le simple fait de son existence, cr√©e une m√™me masse de valeur d'√©change."
                        </p>
                        <p style="margin:0;">Ici, ces <strong>#</strong> ne peuvent servir qu'√† financer les <strong>actions AAA</strong> : tout ce que chaque communaut√© consid√®re comme utile √† la collectivit√© pour satisfaire les besoins de base les plus √©lev√©s ‚Äî eau, nourriture, s√©curit√©, soins, √©cole, justice, information, culture‚Ä¶</p>
                        <p style="margin:8px 0 0 0; font-size:0.8rem;">
                            üåê En savoir plus : <a href="https://espoyr.com" target="_blank" style="color:#2563eb;">espoyr.com</a>
                        </p>
                    </div>
                    <div style="background:#f0fdf4; padding:10px; border-radius:8px; margin-top:10px;">
                        <p style="margin:0 0 6px 0; font-weight:bold; color:#059669;">‚ú® En pratique dans le jeu :</p>
                        <ul style="font-size:0.85rem; margin:0; padding-left:20px;">
                            <li>+50# cr√©√©s dans le Pot AAA √† chaque lancer de d√©</li>
                            <li>Demander un cr√©dit en # (0%, valid√© par les membres)</li>
                            <li>Compl√©ment de salaire en # si √©rosion (Phase 2+)</li>
                            <li>Aide en cas de faillite (dette annul√©e + pr√™t de relance)</li>
                        </ul>
                        <p style="margin:8px 0 0 0; color:#059669; font-weight:bold;">Adh√©sion gratuite et libre !</p>
                    </div>
                `, `
                    <button class="btn btn-primary" onclick="adhererPotAAA()">${LOGO_AAA} Devenir membre</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Plus tard</button>
                `);
            }
        }
        
        async function adhererPotAAA() {
            closeModal();
            
            if (!COMPTABILITE.potAAA.membres) COMPTABILITE.potAAA.membres = [];
            if (!COMPTABILITE.potAAA.membres.includes(myPlayerId)) {
                COMPTABILITE.potAAA.membres.push(myPlayerId);
                await syncComptabiliteToFirebase();
                
                logEvent('JOIN_AAA', myPlayerId, {});
                
                sendSystemMessage(`${LOGO_AAA} ${myName} est devenu membre AAA !`);
                showModal(`<h3>üéâ Bienvenue !</h3><p>Tu es maintenant membre AAA. √Ä chaque lancer de d√©, <strong>+50#</strong> seront cr√©√©s dans le Pot !</p>`,
                    `<button class="btn btn-primary" onclick="closeModal()">Super !</button>`);
            }
        }
        
        // Action rapide : Emprunter
        function showQuickEmprunter() {
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const currentEuro = caisse.euro !== undefined ? caisse.euro : (playersData[myPlayerId]?.euro || CONFIG.capitalInitial);
            const players = Object.values(playersData);
            const masse = Object.values(COMPTABILITE.caisseJoueurs).reduce((sum, c) => sum + (c.euro || 0), 0) || (players.length * CONFIG.capitalInitial);
            const limiteEmprunt = Math.max(CONFIG.limiteEmpruntMin, Math.floor(masse / players.length));
            const empruntActuel = caisse.emprunt || 0;
            const capacite = Math.max(0, limiteEmprunt - empruntActuel);
            
            // Calcul des int√©r√™ts par tour
            const tauxInteret = gameConfig.tauxInteret || CONFIG.tauxInteret;
            const interetParTour = Math.floor(empruntActuel * tauxInteret);
            
            const isMembre = COMPTABILITE.potAAA.membres?.includes(myPlayerId);
            const potSolde = COMPTABILITE.potAAA.solde || 0;
            const detteAAA = COMPTABILITE.potAAA.creances?.[myPlayerId] || 0;
            
            showModal(`
                <h3>üí∂ Emprunter</h3>
                <p style="background: #f3f4f6; padding: 8px; border-radius: 6px; margin-bottom: 10px;">
                    üí∞ Ton solde actuel : <strong>${fmt(currentEuro)}‚Ç¨</strong>
                </p>
                
                <div style="background: #fee2e2; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <p style="margin: 0; font-weight: bold;">üè¶ Banque (en ‚Ç¨)</p>
                    <p style="margin: 4px 0 0 0;">Limite : ${fmt(limiteEmprunt)}‚Ç¨ | Dette actuelle : <strong>${fmt(empruntActuel)}‚Ç¨</strong></p>
                    <p style="margin: 4px 0 0 0; color: #059669;">Capacit√© disponible : <strong>${fmt(capacite)}‚Ç¨</strong></p>
                    <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #92400e; font-style: italic;">üí° L'argent co√ªte de l'argent</p>
                    
                    <div style="background: #fef2f2; padding: 6px; border-radius: 4px; margin-top: 8px;">
                        <p style="margin: 0; font-size: 0.85rem; color: #dc2626;">
                            ‚ö†Ô∏è <strong>Int√©r√™ts : ${tauxInteret * 100}% par tour complet</strong>
                        </p>
                        ${empruntActuel > 0 ? `
                            <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #dc2626;">
                                ‚Üí Tu paies actuellement <strong>${fmt(interetParTour)}‚Ç¨/tour</strong> d'int√©r√™ts
                            </p>
                        ` : ''}
                    </div>
                    
                    ${capacite > 0 ? `
                        <div style="margin-top: 10px;">
                            <label style="font-size: 0.85rem;">Montant √† emprunter :</label>
                            <input type="number" id="empruntEuroMontant" value="${Math.min(100, capacite)}" min="10" max="${capacite}" step="10" 
                                   style="width: 100%; padding: 8px; margin-top: 4px; font-size: 1rem;"
                                   onchange="updateInteretPreview()">
                            <p id="interetPreview" style="font-size: 0.8rem; color: #6b7280; margin-top: 4px;">
                                ‚Üí Int√©r√™ts apr√®s emprunt : ${Math.floor((empruntActuel + 100) * tauxInteret)}‚Ç¨/tour
                            </p>
                            <button class="btn" style="background: #dc2626; color: white; width: 100%; margin-top: 8px; padding: 10px;" onclick="executeEmprunterEuro()">
                                üí∂ Emprunter √† la Banque
                            </button>
                        </div>
                    ` : '<p style="color: #dc2626; margin-top: 8px; font-weight: bold;">‚ùå Capacit√© d\'emprunt √©puis√©e</p>'}
                </div>
                
                ${isMembre ? `
                <div style="background: #dcfce7; padding: 10px; border-radius: 8px;">
                    <p style="margin: 0; font-weight: bold;">${LOGO_AAA} Pot AAA (en #)</p>
                    <p style="margin: 4px 0 0 0;">Solde du Pot : ${fmt(potSolde)}# | Ta dette AAA : ${fmt(detteAAA)}#</p>
                    <p style="margin: 4px 0 0 0; color: #059669; font-weight: bold;">‚ú® Sans int√©r√™ts !</p>
                    ${potSolde > 0 ? `
                        <input type="number" id="empruntHashMontant" value="${Math.min(100, potSolde)}" min="10" max="${potSolde}" step="10" style="width: 100%; padding: 8px; margin-top: 8px;">
                        <button class="btn" style="background: #059669; color: white; width: 100%; margin-top: 6px; padding: 10px;" onclick="executeEmprunterHash()">
                            ${LOGO_AAA} Emprunter au Pot AAA
                        </button>
                    ` : '<p style="color: #6b7280; margin-top: 6px;">Le Pot est vide</p>'}
                </div>
                ` : `
                <div style="background: #f0fdf4; padding: 10px; border-radius: 8px; border: 1px dashed #059669;">
                    <p style="margin: 0; color: #059669;">üí° <strong>Astuce :</strong> Deviens membre AAA pour emprunter en # <strong>sans int√©r√™ts</strong> !</p>
                    <button class="btn" style="background: #dcfce7; color: #059669; width: 100%; margin-top: 8px;" onclick="closeModal(); showQuickAdhererAAA();">
                        ${LOGO_AAA} Devenir membre
                    </button>
                </div>
                `}
            `, `<button class="btn btn-secondary" onclick="closeModal()">Fermer</button>`);
        }
        
        // Mettre √† jour l'aper√ßu des int√©r√™ts
        function updateInteretPreview() {
            const montant = parseInt(document.getElementById('empruntEuroMontant')?.value) || 0;
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const empruntActuel = caisse.emprunt || 0;
            const tauxInteret = gameConfig.tauxInteret || CONFIG.tauxInteret;
            const nouvelInteret = Math.floor((empruntActuel + montant) * tauxInteret);
            
            const previewEl = document.getElementById('interetPreview');
            if (previewEl) {
                previewEl.textContent = `‚Üí Int√©r√™ts apr√®s emprunt : ${nouvelInteret}‚Ç¨/tour`;
            }
        }
        
        async function executeEmprunterEuro() {
            const montant = parseInt(document.getElementById('empruntEuroMontant').value) || 0;
            if (montant <= 0) return;
            
            closeModal();
            const ecriture = await comptaEmprunt(myPlayerId, montant);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            
            // Mettre √† jour Firebase
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, 
                emprunt: caisse.emprunt
            });
            await syncComptabiliteToFirebase();
            
            // Mettre √† jour l'UI
            updatePlayersUI();
            
            logEvent('BANK_LOAN', myPlayerId, { 
                montant, 
                currency: 'EUR', 
                nouvelleDetteTotal: caisse.emprunt 
            }, ecriture?.ledgerEntryId ? [ecriture.ledgerEntryId] : []);
            
            const tauxInteret = gameConfig.tauxInteret || CONFIG.tauxInteret;
            const interetParTour = Math.floor(caisse.emprunt * tauxInteret);
            sendSystemMessage(`üè¶ ${myName} emprunte ${fmt(montant)}‚Ç¨ (dette: ${fmt(caisse.emprunt)}‚Ç¨, int√©r√™ts: ${fmt(interetParTour)}‚Ç¨/tour)`);
        }
        
        async function executeEmprunterHash() {
            const montant = parseInt(document.getElementById('empruntHashMontant').value) || 0;
            if (montant <= 0) return;
            
            closeModal();
            const ecriture = await comptaEmpruntAAA(myPlayerId, montant);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            
            // Mettre √† jour Firebase
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(caisse.espoyr);
            await syncComptabiliteToFirebase();
            
            // Mettre √† jour l'UI
            updatePlayersUI();
            
            logEvent('AAA_LOAN', myPlayerId, { 
                montant, 
                currency: 'ESP',
                nouvelleDetteAAA: COMPTABILITE.potAAA.creances?.[myPlayerId] || 0
            }, ecriture?.ledgerEntryId ? [ecriture.ledgerEntryId] : []);
            
            sendSystemMessage(`${LOGO_AAA} ${myName} emprunte ${fmt(montant)}# au Pot AAA (sans int√©r√™ts)`);
        }
        
        // Action rapide : √âquiper
        async function showQuickEquiper() {
            const activitesSnap = await gameRef.child('activites').once('value');
            const activites = activitesSnap.val() || {};
            const phase = gameState?.phase || 1;
            
            const profil = playersData[myPlayerId]?.profil || 'contributif';
            
            // Trouver mes activit√©s
            const mesActivites = Object.entries(activites)
                .filter(([id, owner]) => owner === myPlayerId)
                .map(([id]) => parseInt(id));
            
            if (mesActivites.length === 0) {
                showModal(`<h3>üîß √âquipement</h3><p>Tu n'as pas encore d'activit√©.</p>`,
                    `<button class="btn btn-secondary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const currentEuro = caisse.euro || 0;
            
            let html = `<h3>üîß √âquipements</h3>
                <p>Tu as : <strong>${fmt(currentEuro)}‚Ç¨</strong> | Phase ${phase}</p>
                <p style="font-size:0.8rem; color:#6b7280;">üí° Investir A = compensation en # | Facture = 5% total investi</p>`;
            
            for (const actId of mesActivites) {
                const c = CASES[actId];
                const act = COMPTABILITE.caisseActivites?.[actId] || {};
                const nbA = act.equipementA || 0;
                const nbB = act.equipementB || 0;
                const total = nbA + nbB;
                const equipList = [...Array(nbA).fill('A'), ...Array(nbB).fill('B')];
                const equipDisplay = total === 0 ? '‚àÖ' : equipList.join('');
                const factureAct = calculerFactureActivite(actId, equipList);
                
                if (total >= 3) {
                    html += `<div style="background: #f3f4f6; padding: 8px; border-radius: 6px; margin: 6px 0;">
                        <p style="margin: 0;">${c.icon} ${c.name} [${equipDisplay}] ‚Äî ‚úÖ Complet (3/3) ‚Äî Facture: ${fmt(factureAct)}‚Ç¨</p>
                    </div>`;
                } else {
                    const checkA = peutAcheterA(actId, equipList, myPlayerId);
                    const checkB = peutAcheterB(actId, equipList, myPlayerId);
                    const checkConv = peutConvertirBtoA(actId, equipList, myPlayerId);
                    
                    html += `<div style="background: #fef3c7; padding: 10px; border-radius: 6px; margin: 6px 0;">
                        <p style="margin: 0; font-weight: bold;">${c.icon} ${c.name} [${equipDisplay}] (${total}/3) ‚Äî Facture: ${fmt(factureAct)}‚Ç¨</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                            ${checkA.ok ? `<button class="btn" style="flex:1; background:#dcfce7; color:#059669; font-size:0.8rem;" onclick="buyEquipementA(${actId})">üåø A ${fmt(checkA.cout)}‚Ç¨</button>` : ''}
                            ${checkConv.ok ? `<button class="btn" style="flex:1; background:#fef3c7; color:#92400e; font-size:0.8rem; border:1px solid #fbbf24;" onclick="convertirBtoA(${actId})">üîÑ B‚ÜíA ${fmt(checkConv.cout)}‚Ç¨</button>` : ''}
                            ${checkB.ok ? `<button class="btn" style="flex:1; background:#fee2e2; color:#dc2626; font-size:0.8rem;" onclick="buyEquipementB(${actId})">‚ùÑÔ∏è B ${fmt(checkB.cout)}‚Ç¨</button>` : ''}
                            ${!checkA.ok && !checkB.ok && !checkConv.ok ? `<p style="color:#6b7280; font-size:0.8rem;">${phase < 2 && nbB >= 2 ? 'Max 2B en Phase 1' : 'Aucune option disponible'}</p>` : ''}
                        </div>
                    </div>`;
                }
            }
            
            showModal(html, `<button class="btn btn-secondary" onclick="closeModal()">Fermer</button>`);
        }
        
        // Action rapide : Vendre
        async function showQuickVendre() {
            const activitesSnap = await gameRef.child('activites').once('value');
            const activites = activitesSnap.val() || {};
            
            const mesActivites = Object.entries(activites)
                .filter(([id, owner]) => owner === myPlayerId)
                .map(([id]) => parseInt(id));
            
            if (mesActivites.length === 0) {
                showModal(`<h3>üè∑Ô∏è Vendre</h3><p>Tu n'as pas d'activit√© √† vendre.</p>`,
                    `<button class="btn btn-secondary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            let html = `<h3>üè∑Ô∏è Vendre une activit√©</h3>
                <p style="font-size: 0.85rem; color: #6b7280;">Mets en vente aux ench√®res pour les autres joueurs.</p>`;
            
            for (const actId of mesActivites) {
                const c = CASES[actId];
                html += `<div style="background: #fef3c7; padding: 10px; border-radius: 6px; margin: 6px 0;">
                    <p style="margin: 0; font-weight: bold;">${c.icon} ${c.name}</p>
                    <p style="margin: 4px 0 0 0; font-size: 0.85rem;">Valeur : ${fmt(c.prix)}‚Ç¨</p>
                    <button class="btn" style="width:100%; margin-top:8px; background:#f59e0b; color:white;" onclick="lancerEnchere(${actId})">üî® Mettre aux ench√®res</button>
                </div>`;
            }
            
            showModal(html, `<button class="btn btn-secondary" onclick="closeModal()">Fermer</button>`);
        }
        
        // Action rapide : Rembourser
        function showQuickRembourser() {
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const dette = caisse.emprunt || 0;
            const detteAAA = COMPTABILITE.potAAA.creances?.[myPlayerId] || 0;
            const currentEuro = caisse.euro || 0;
            const currentHash = caisse.espoyr || 0;
            
            if (dette === 0 && detteAAA === 0) {
                showModal(`<h3>üí≥ Rembourser</h3><p>Tu n'as pas de dette √† rembourser ! üéâ</p>`,
                    `<button class="btn btn-primary" onclick="closeModal()">Super !</button>`);
                return;
            }
            
            showModal(`
                <h3>üí≥ Rembourser</h3>
                <p>Tu as : <strong>${fmt(currentEuro)}‚Ç¨</strong> et <strong>${fmt(currentHash)}#</strong></p>
                
                ${dette > 0 ? `
                <div style="background: #fee2e2; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <p style="margin: 0; font-weight: bold;">üè¶ Dette Banque : ${fmt(dette)}‚Ç¨</p>
                    <input type="number" id="remboursEuroMontant" value="${Math.min(dette, currentEuro)}" min="0" max="${Math.min(dette, currentEuro)}" step="10" style="width: 100%; padding: 6px; margin-top: 8px;">
                    <button class="btn" style="background: #fee2e2; color: #dc2626; width: 100%; margin-top: 6px;" onclick="executeRemboursEuro()">Rembourser ‚Ç¨</button>
                </div>
                ` : ''}
                
                ${detteAAA > 0 ? `
                <div style="background: #dcfce7; padding: 10px; border-radius: 8px;">
                    <p style="margin: 0; font-weight: bold;">${LOGO_AAA} Dette AAA : ${fmt(detteAAA)}#</p>
                    <input type="number" id="remboursHashMontant" value="${Math.min(detteAAA, currentHash)}" min="0" max="${Math.min(detteAAA, currentHash)}" step="10" style="width: 100%; padding: 6px; margin-top: 8px;">
                    <button class="btn" style="background: #dcfce7; color: #059669; width: 100%; margin-top: 6px;" onclick="executeRemboursHash()">Rembourser #</button>
                </div>
                ` : ''}
            `, `<button class="btn btn-secondary" onclick="closeModal()">Fermer</button>`);
        }
        
        async function executeRemboursEuro() {
            const montant = parseInt(document.getElementById('remboursEuroMontant').value) || 0;
            if (montant <= 0) return;
            
            closeModal();
            const ecriture = await comptaRemboursement(myPlayerId, montant);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, emprunt: caisse.emprunt
            });
            await syncComptabiliteToFirebase();
            
            logEvent('REPAY_LOAN', myPlayerId, { 
                montant, 
                currency: 'EUR',
                detteRestante: caisse.emprunt
            }, ecriture?.ledgerEntryId ? [ecriture.ledgerEntryId] : []);
            
            sendSystemMessage(`üí≥ ${myName} rembourse ${fmt(montant)}‚Ç¨ √† la banque`);
        }
        
        async function executeRemboursHash() {
            const montant = parseInt(document.getElementById('remboursHashMontant').value) || 0;
            if (montant <= 0) return;
            
            closeModal();
            const ecriture = await comptaRemboursementAAA(myPlayerId, montant);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(caisse.espoyr);
            await syncComptabiliteToFirebase();
            
            logEvent('REPAY_AAA', myPlayerId, { 
                montant, 
                currency: 'ESP',
                detteRestante: COMPTABILITE.potAAA.creances?.[myPlayerId] || 0
            }, ecriture?.ledgerEntryId ? [ecriture.ledgerEntryId] : []);
            
            sendSystemMessage(`${LOGO_AAA} ${myName} rembourse ${fmt(montant)}# au Pot AAA`);
        }
        
        // Afficher le modal d'analyse de sauvegarde
        function showSaveAnalysisModal() {
            const validation = validateLedger();
            const nbEvents = GAME_SAVE.events.length;
            const nbLedger = GAME_SAVE.ledger.length;
            const nbSnapshots = GAME_SAVE.snapshots.length;
            
            // Statistiques par action
            const actionStats = {};
            GAME_SAVE.events.forEach(e => {
                actionStats[e.action] = (actionStats[e.action] || 0) + 1;
            });
            
            const actionStatsHtml = Object.entries(actionStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([action, count]) => `<tr><td>${action}</td><td>${count}</td></tr>`)
                .join('');
            
            showModal(`
                <h3>üìä Analyse de la sauvegarde</h3>
                
                <div style="background: #f3f4f6; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <p style="margin: 0;"><strong>Version:</strong> ${SCHEMA_VERSION}</p>
                    <p style="margin: 4px 0 0 0;"><strong>Game ID:</strong> ${GAME_SAVE.gameId || 'N/A'}</p>
                    <p style="margin: 4px 0 0 0;"><strong>Tour:</strong> ${gameState?.turn || 1}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div style="background: #dbeafe; padding: 10px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; font-size: 1.5rem; font-weight: bold;">${nbEvents}</p>
                        <p style="margin: 0; font-size: 0.8rem;">Events</p>
                    </div>
                    <div style="background: #dcfce7; padding: 10px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; font-size: 1.5rem; font-weight: bold;">${nbLedger}</p>
                        <p style="margin: 0; font-size: 0.8rem;">√âcritures</p>
                    </div>
                    <div style="background: #fef3c7; padding: 10px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; font-size: 1.5rem; font-weight: bold;">${nbSnapshots}</p>
                        <p style="margin: 0; font-size: 0.8rem;">Snapshots</p>
                    </div>
                    <div style="background: ${validation.valid ? '#dcfce7' : '#fee2e2'}; padding: 10px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; font-size: 1.5rem;">${validation.valid ? '‚úÖ' : '‚ùå'}</p>
                        <p style="margin: 0; font-size: 0.8rem;">Ledger</p>
                    </div>
                </div>
                
                <div style="background: #f3f4f6; padding: 10px; border-radius: 8px;">
                    <p style="margin: 0 0 8px 0; font-weight: bold;">Top 10 Actions:</p>
                    <table style="width: 100%; font-size: 0.8rem;">
                        ${actionStatsHtml || '<tr><td>Aucune action</td></tr>'}
                    </table>
                </div>
            `, `
                <button class="btn btn-primary" onclick="saveGame()">üíæ Sauvegarder</button>
                <button class="btn btn-secondary" onclick="exportEventsCSV()">üì• Events CSV</button>
                <button class="btn btn-secondary" onclick="exportLedgerCSV()">üì• Ledger CSV</button>
                <button class="btn" style="background:#f3f4f6;" onclick="closeModal()">Fermer</button>
            `);
        }
        
        // Export Events en CSV
        function exportEventsCSV() {
            const headers = ['eventId', 'timestamp', 'tour', 'phase', 'actorId', 'action', 'payload', 'ledgerEntryIds'];
            const rows = GAME_SAVE.events.map(e => [
                e.eventId,
                e.ts,
                e.turn,
                e.phase,
                e.actorId,
                e.action,
                JSON.stringify(e.payload),
                e.ledgerEntryIds.join(';')
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
            downloadCSV(csv, `ESPOYR_${currentGameCode}_events.csv`);
        }
        
        // Export Ledger en CSV
        function exportLedgerCSV() {
            const headers = ['ledgerEntryId', 'timestamp', 'tour', 'phase', 'currency', 'label', 'entityId', 'debitAccount', 'debitAmount', 'creditAccount', 'creditAmount'];
            const rows = GAME_SAVE.ledger.map(e => [
                e.ledgerEntryId,
                e.ts,
                e.turn,
                e.phase,
                e.currency,
                e.label,
                e.entity?.id || '',
                e.debit[0]?.account || '',
                e.debit[0]?.amount || 0,
                e.credit[0]?.account || '',
                e.credit[0]?.amount || 0
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
            downloadCSV(csv, `ESPOYR_${currentGameCode}_ledger.csv`);
        }
        
        // ========== CHARGER UNE PARTIE SAUVEGARD√âE ==========
        
        async function handleLoadGame(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const saveData = await loadGameFromFile(file);
                
                // Afficher le modal de confirmation
                showLoadGameConfirmModal(saveData);
            } catch (err) {
                console.error('Erreur chargement:', err);
                showError('Erreur lors du chargement du fichier');
            }
            
            // Reset input pour pouvoir recharger le m√™me fichier
            event.target.value = '';
        }
        
        function showLoadGameConfirmModal(saveData) {
            const gameId = saveData.gameId || 'Inconnu';
            const turn = saveData.state?.turn || saveData.firebase?.data?.state?.turn || 1;
            const phase = saveData.state?.phase || saveData.firebase?.data?.state?.phase || 1;
            const nbPlayers = Object.keys(saveData.state?.players || saveData.firebase?.data?.players || {}).length;
            const nbEvents = saveData.events?.length || 0;
            const savedAt = saveData.lastSavedAt ? new Date(saveData.lastSavedAt).toLocaleString() : 'Inconnu';
            
            showModal(`
                <h3>üìÇ Charger cette partie ?</h3>
                
                <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin: 15px 0;">
                    <p style="margin: 0;"><strong>üéÆ Partie :</strong> ${gameId}</p>
                    <p style="margin: 6px 0 0 0;"><strong>üîÑ Tour :</strong> ${turn} | <strong>üìä Phase :</strong> ${phase}</p>
                    <p style="margin: 6px 0 0 0;"><strong>üë• Joueurs :</strong> ${nbPlayers}</p>
                    <p style="margin: 6px 0 0 0;"><strong>üìú Events :</strong> ${nbEvents}</p>
                    <p style="margin: 6px 0 0 0;"><strong>üíæ Sauvegard√© :</strong> ${savedAt}</p>
                </div>
                
                <p style="font-size: 0.9rem; color: #6b7280;">
                    Une nouvelle partie sera cr√©√©e avec ces donn√©es.
                    Tu pourras naviguer dans l'historique avec les boutons ‚óÄÔ∏è ‚ñ∂Ô∏è
                </p>
            `, `
                <button class="btn btn-primary" onclick="confirmLoadGame()">‚úÖ Charger</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            `);
            
            // Stocker temporairement les donn√©es
            window.pendingLoadData = saveData;
        }
        
        async function confirmLoadGame() {
            closeModal();
            const saveData = window.pendingLoadData;
            if (!saveData) return;
            
            myName = document.getElementById('playerName').value.trim() || 'Host';
            
            // G√©n√©rer un nouveau code de partie
            const code = generateCode();
            currentGameCode = code;
            isHost = true;
            myPlayerId = 'p_' + Date.now() + '_' + Math.floor(Math.random()*1000);
                const secret = generateSecret(24);
                const secretHash = await sha256Hex(secret);
            
            // Restaurer GAME_SAVE
            if (saveData.events) GAME_SAVE.events = saveData.events;
            if (saveData.ledger) GAME_SAVE.ledger = saveData.ledger;
            if (saveData.snapshots) GAME_SAVE.snapshots = saveData.snapshots;
            if (saveData.indexes) GAME_SAVE.indexes = saveData.indexes;
            if (saveData.rng) GAME_SAVE.rng = saveData.rng;
            if (saveData.eventCounter) GAME_SAVE.eventCounter = saveData.eventCounter;
            if (saveData.ledgerCounter) GAME_SAVE.ledgerCounter = saveData.ledgerCounter;
            GAME_SAVE.gameId = saveData.gameId;
            GAME_SAVE.createdAt = saveData.createdAt;
            
            // Restaurer la comptabilit√©
            if (saveData.comptabilite) {
                COMPTABILITE = saveData.comptabilite;
                normalizeComptabilite();
            }
            
            // Restaurer la config
            if (saveData.config) {
                gameConfig = { ...CONFIG, ...saveData.config };
            }
            
            // Restaurer les donn√©es Firebase
            const fbData = saveData.firebase?.data || {};
            
            // Cr√©er la partie dans Firebase avec les donn√©es restaur√©es
            await db.ref(`parties/${code}`).set({
                code,
                hostId: myPlayerId,
                status: 'playing',
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                config: gameConfig,
                state: fbData.state || { turn: 1, phase: 1, currentPlayerIndex: 0, started: true, toursComplets: 0 },
                activites: fbData.activites || {},
                equipements: fbData.equipements || {},
                comptabilite: COMPTABILITE,
                players: {}  // On va recr√©er les joueurs
            });
            
            // Recr√©er les joueurs
            const savedPlayers = fbData.players || saveData.state?.players || {};
            for (const [pid, pdata] of Object.entries(savedPlayers)) {
                // Garder le premier joueur comme host
                const isFirst = Object.keys(savedPlayers).indexOf(pid) === 0;
                
                await db.ref(`parties/${code}/players/${pid}`).set({
                    ...pdata,
                    id: pid,
                    isHost: isFirst,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP,
                    isConnected: true,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP,
                    secretHash: secretHash
                });
                
                if (isFirst) {
                    myPlayerId = pid;
                    myName = pdata.name || myName;
                }
            }
            
            // Activer le mode replay
            replayMode = true;
            currentEventIndex = GAME_SAVE.events.length - 1;
            
            // S'abonner et d√©marrer
            subscribeToGame(code);
            showScreen('gameScreen');
            
            sendSystemMessage(`üìÇ Partie charg√©e ! ${GAME_SAVE.events.length} events restaur√©s.`);
            sendSystemMessage(`üí° Utilisez ‚óÄÔ∏è ‚ñ∂Ô∏è pour naviguer dans l'historique.`);
            
            // LOG EVENT
            logEvent('GAME_LOADED', myPlayerId, {
                originalGameId: saveData.gameId,
                nbEvents: GAME_SAVE.events.length
            });
            
            window.pendingLoadData = null;
        }
        
        // ========== NAVIGATION DANS L'HISTORIQUE ==========
        
        function updateEventPositionDisplay() {
            const posEl = document.getElementById('eventPosition');
            const forkBtn = document.getElementById('forkBtn');
            if (!posEl) return;
            
            const total = GAME_SAVE.events.length;
            const current = currentEventIndex === -1 ? total : currentEventIndex + 1;
            
            posEl.textContent = `${current}/${total}`;
            posEl.style.background = replayMode ? '#fef3c7' : 'white';
            posEl.style.fontWeight = replayMode ? 'bold' : 'normal';
            
            // Afficher le bouton Fork uniquement en mode replay
            if (forkBtn) {
                forkBtn.style.display = replayMode ? 'inline-block' : 'none';
            }
        }
        
        // ========== FORK : Reprendre √† partir d'un point ==========
        function showForkConfirmModal() {
            if (currentEventIndex === -1) {
                sendSystemMessage(`‚ö†Ô∏è D√©j√† en temps r√©el`);
                return;
            }
            
            const eventsToDelete = GAME_SAVE.events.length - currentEventIndex - 1;
            const event = GAME_SAVE.events[currentEventIndex];
            
            showModal(`
                <h3>üîÄ Reprendre √† partir d'ici ?</h3>
                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0;"><strong>Position actuelle :</strong></p>
                    <p style="margin: 4px 0;">Event #${currentEventIndex + 1} : ${event.action}</p>
                    <p style="margin: 4px 0;">Tour ${event.turn}</p>
                </div>
                
                <div style="background: #fee2e2; padding: 12px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0; font-weight: bold; color: #dc2626;">‚ö†Ô∏è Attention !</p>
                    <p style="margin: 8px 0 0 0;">Cette action va <strong>effacer d√©finitivement</strong> :</p>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                        <li><strong>${eventsToDelete}</strong> √©v√©nements apr√®s ce point</li>
                        <li>Toutes les √©critures comptables associ√©es</li>
                        <li>Les snapshots post√©rieurs</li>
                    </ul>
                    <p style="margin: 0; font-size: 0.85rem;">üí° Pensez √† sauvegarder avant si vous voulez conserver l'historique actuel.</p>
                </div>
            `, `
                <button class="btn" style="background: #fee2e2; color: #dc2626;" onclick="closeModal()">‚ùå Annuler</button>
                <button class="btn" style="background: #fbbf24; color: #78350f;" onclick="forkFromCurrentEvent()">üîÄ Confirmer Fork</button>
            `);
        }
        
        async function forkFromCurrentEvent() {
            if (currentEventIndex === -1) return;
            
            closeModal();
            
            const keepIndex = currentEventIndex;
            const eventsToDelete = GAME_SAVE.events.length - keepIndex - 1;
            
            // 1. Effacer les events apr√®s l'index actuel
            GAME_SAVE.events = GAME_SAVE.events.slice(0, keepIndex + 1);
            
            // 2. Effacer les √©critures du journal apr√®s cet event
            const lastEvent = GAME_SAVE.events[keepIndex];
            const lastEventId = lastEvent?.id || '';
            
            // Trouver les ledger entries associ√©es aux events supprim√©s
            // et les supprimer du journal global
            // (Simplification : on garde le journal tel quel, car il est li√© aux events)
            
            // 3. Effacer les snapshots post√©rieurs
            const eventTurn = lastEvent?.turn || 0;
            GAME_SAVE.snapshots = GAME_SAVE.snapshots.filter(s => s.turn <= eventTurn);
            
            // 4. Restaurer l'√©tat au point de fork
            restoreToEvent(keepIndex);
            
            // 5. Sortir du mode replay et permettre de jouer
            replayMode = false;
            currentEventIndex = -1;
            
            // 6. Mettre √† jour l'affichage
            updateEventPositionDisplay();
            updateGameUI();
            await updateBoard();
            
            // 7. Message syst√®me
            sendSystemMessage(`üîÄ Fork ! ${eventsToDelete} √©v√©nements effac√©s. Reprise au Tour ${eventTurn}.`);
            
            // 8. Logger l'√©v√©nement de fork
            logEvent('FORK_HISTORY', myPlayerId, {
                forkFromEvent: keepIndex,
                eventsDeleted: eventsToDelete,
                forkTurn: eventTurn
            });
        }
        
        function goToFirstEvent() {
            if (GAME_SAVE.events.length === 0) {
                sendSystemMessage(`‚ö†Ô∏è Aucun √©v√©nement enregistr√©`);
                return;
            }
            
            replayMode = true;
            currentEventIndex = 0;
            
            // Trouver le premier snapshot
            if (GAME_SAVE.snapshots.length > 0) {
                restoreSnapshot(GAME_SAVE.snapshots[0]);
            }
            
            updateEventPositionDisplay();
            updateGameUI();
            
            const event = GAME_SAVE.events[0];
            sendSystemMessage(`‚èÆÔ∏è D√©but: ${event.action} (Tour ${event.turn})`);
        }
        
        function goToLastEvent() {
            replayMode = false;
            currentEventIndex = -1;
            
            // Restaurer le dernier snapshot
            if (GAME_SAVE.snapshots.length > 0) {
                restoreSnapshot(GAME_SAVE.snapshots[GAME_SAVE.snapshots.length - 1]);
            }
            
            updateEventPositionDisplay();
            updateGameUI();
            sendSystemMessage(`‚è≠Ô∏è Retour au temps r√©el`);
        }
        
        function goBackOneEvent() {
            if (GAME_SAVE.events.length === 0) {
                sendSystemMessage(`‚ö†Ô∏è Aucun √©v√©nement enregistr√©`);
                return;
            }
            
            replayMode = true;
            
            // Si on est en temps r√©el, aller au dernier event
            if (currentEventIndex === -1) {
                currentEventIndex = GAME_SAVE.events.length - 1;
            } else if (currentEventIndex > 0) {
                currentEventIndex--;
            } else {
                sendSystemMessage(`‚ö†Ô∏è D√©j√† au premier √©v√©nement`);
                return;
            }
            
            restoreToEvent(currentEventIndex);
            updateEventPositionDisplay();
            updateGameUI();
            
            const event = GAME_SAVE.events[currentEventIndex];
            if (event) {
                sendSystemMessage(`‚óÄÔ∏è Event ${currentEventIndex + 1}/${GAME_SAVE.events.length}: ${event.action} (Tour ${event.turn})`);
            }
        }
        
        function goForwardOneEvent() {
            if (GAME_SAVE.events.length === 0) return;
            
            // Si d√©j√† au temps r√©el, ne rien faire
            if (currentEventIndex === -1) {
                sendSystemMessage(`‚ö†Ô∏è D√©j√† en temps r√©el`);
                return;
            }
            
            if (currentEventIndex < GAME_SAVE.events.length - 1) {
                currentEventIndex++;
                restoreToEvent(currentEventIndex);
                
                const event = GAME_SAVE.events[currentEventIndex];
                sendSystemMessage(`‚ñ∂Ô∏è Event ${currentEventIndex + 1}/${GAME_SAVE.events.length}: ${event.action} (Tour ${event.turn})`);
            } else {
                // Retour au temps r√©el
                replayMode = false;
                currentEventIndex = -1;
                
                if (GAME_SAVE.snapshots.length > 0) {
                    restoreSnapshot(GAME_SAVE.snapshots[GAME_SAVE.snapshots.length - 1]);
                }
                sendSystemMessage(`‚è≠Ô∏è Retour au temps r√©el`);
            }
            
            updateEventPositionDisplay();
            updateGameUI();
        }
        
        function restoreToEvent(eventIndex) {
            const targetEvent = GAME_SAVE.events[eventIndex];
            if (!targetEvent) {
                console.warn(`Event ${eventIndex} non trouv√©`);
                return;
            }
            
            // Chercher le meilleur snapshot AVANT ou AU NIVEAU de cet event
            let bestSnapshot = null;
            let bestSnapIndex = -1;
            
            for (let i = 0; i < GAME_SAVE.snapshots.length; i++) {
                const snap = GAME_SAVE.snapshots[i];
                const snapEventIndex = snap.eventIndex !== undefined ? snap.eventIndex : 
                    GAME_SAVE.events.findIndex(e => e.eventId === snap.eventCursor);
                
                if (snapEventIndex <= eventIndex) {
                    bestSnapshot = snap;
                    bestSnapIndex = snapEventIndex;
                }
            }
            
            if (bestSnapshot) {
                restoreSnapshot(bestSnapshot);
                console.log(`üìç Restaur√© snapshot √† event ${bestSnapIndex}, cible event ${eventIndex}`);
                console.log(`üìç Event: ${targetEvent.action} - ${JSON.stringify(targetEvent.payload).substring(0, 100)}...`);
            } else {
                console.warn(`Aucun snapshot trouv√© pour event ${eventIndex}`);
            }
        }
        
        function restoreSnapshot(snapshot) {
            if (!snapshot || !snapshot.state) {
                console.warn('Snapshot invalide:', snapshot);
                return;
            }
            
            const state = snapshot.state;
            
            // Restaurer gameState
            if (state.gameState) {
                gameState = JSON.parse(JSON.stringify(state.gameState));
            }
            
            // Restaurer playersData
            if (state.playersData) {
                playersData = JSON.parse(JSON.stringify(state.playersData));
            }
            
            // Restaurer COMPTABILITE
            if (state.COMPTABILITE) {
                COMPTABILITE = JSON.parse(JSON.stringify(state.COMPTABILITE));
                normalizeComptabilite();
            }
            
            // Restaurer gameConfig
            if (state.gameConfig) {
                gameConfig = JSON.parse(JSON.stringify(state.gameConfig));
            }
            
            // Mettre √† jour l'affichage
            updatePlayersUI();
            updateBoard();
            
            console.log(`‚úÖ Snapshot ${snapshot.snapshotId} restaur√© (Tour ${snapshot.turn})`);
        }
        
        // Aller directement √† un tour sp√©cifique
        function goToTurn(turnNumber) {
            // Trouver le premier event de ce tour
            const eventIndex = GAME_SAVE.events.findIndex(e => e.turn === turnNumber);
            if (eventIndex === -1) {
                sendSystemMessage(`‚ö†Ô∏è Tour ${turnNumber} non trouv√©`);
                return;
            }
            
            replayMode = true;
            currentEventIndex = eventIndex;
            restoreToEvent(eventIndex);
            updateEventPositionDisplay();
            updateGameUI();
            
            sendSystemMessage(`üîÑ Saut au Tour ${turnNumber}`);
        }
        
        // Afficher l'historique complet des events
        function showHistoryModal() {
            showTimelineModal();
        }
        
        function showTimelineModal() {
            const events = GAME_SAVE.events;
            const snapshots = GAME_SAVE.snapshots;
            
            if (events.length === 0) {
                showModal(`<h3>üìú Timeline</h3><p>Aucun √©v√©nement enregistr√©.</p>`,
                    `<button class="btn btn-secondary" onclick="closeModal()">Fermer</button>`);
                return;
            }
            
            // Trouver les tours distincts
            const tours = [...new Set(events.map(e => e.turn))].sort((a, b) => a - b);
            const maxTurn = Math.max(...tours);
            const currentTurn = gameState?.turn || 1;
            
            // Grouper par tour
            const byTurn = {};
            events.forEach((e, i) => {
                const turn = e.turn || 0;
                if (!byTurn[turn]) byTurn[turn] = [];
                byTurn[turn].push({ ...e, index: i });
            });
            
            // Cr√©er la barre de timeline
            let timelineHtml = `
                <div style="background: #f3f4f6; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="margin: 0 0 8px 0; font-weight: bold;">üéöÔ∏è Naviguer par tour</p>
                    <input type="range" id="timelineSlider" min="1" max="${maxTurn}" value="${currentEventIndex === -1 ? maxTurn : (events[currentEventIndex]?.turn || 1)}" 
                           style="width: 100%;" onchange="jumpToTurnFromSlider(this.value)">
                    <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #6b7280;">
                        <span>Tour 1</span>
                        <span id="sliderTurnDisplay">Tour ${currentEventIndex === -1 ? currentTurn : (events[currentEventIndex]?.turn || 1)}</span>
                        <span>Tour ${maxTurn}</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <div style="background: #dbeafe; padding: 8px; border-radius: 6px; flex: 1; text-align: center;">
                        <p style="margin: 0; font-size: 1.5rem; font-weight: bold;">${events.length}</p>
                        <p style="margin: 0; font-size: 0.75rem; color: #6b7280;">Events</p>
                    </div>
                    <div style="background: #dcfce7; padding: 8px; border-radius: 6px; flex: 1; text-align: center;">
                        <p style="margin: 0; font-size: 1.5rem; font-weight: bold;">${snapshots.length}</p>
                        <p style="margin: 0; font-size: 0.75rem; color: #6b7280;">Snapshots</p>
                    </div>
                    <div style="background: ${replayMode ? '#fef3c7' : '#f3f4f6'}; padding: 8px; border-radius: 6px; flex: 1; text-align: center;">
                        <p style="margin: 0; font-size: 1rem; font-weight: bold;">${replayMode ? '‚è™ Replay' : '‚ñ∂Ô∏è Live'}</p>
                        <p style="margin: 0; font-size: 0.75rem; color: #6b7280;">Mode</p>
                    </div>
                </div>
            `;
            
            // Liste des √©v√©nements par tour
            let eventsHtml = `<div style="max-height: 300px; overflow-y: auto;">`;
            
            for (const turn of tours.reverse()) {
                const turnEvents = byTurn[turn] || [];
                const isCurrentTurn = (currentEventIndex !== -1 && events[currentEventIndex]?.turn === turn);
                
                eventsHtml += `
                    <div style="margin-bottom: 8px; border-left: 3px solid ${isCurrentTurn ? '#f59e0b' : '#e5e7eb'}; padding-left: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; background: ${isCurrentTurn ? '#fef3c7' : '#f9fafb'}; padding: 4px 8px; border-radius: 4px; cursor: pointer;" onclick="goToTurn(${turn}); closeModal();">
                            <span style="font-weight: bold;">üîÑ Tour ${turn}</span>
                            <span style="font-size: 0.75rem; color: #6b7280;">${turnEvents.length} events</span>
                        </div>
                        <div style="margin-left: 10px;">
                `;
                
                for (const e of turnEvents) {
                    const isCurrentEvent = e.index === currentEventIndex;
                    const actionIcon = getActionIcon(e.action);
                    const playerName = e.actorId ? (playersData[e.actorId]?.name || e.actorId) : '';
                    
                    eventsHtml += `
                        <div style="background: ${isCurrentEvent ? '#fef3c7' : 'white'}; padding: 4px 8px; margin: 2px 0; border-radius: 4px; font-size: 0.8rem; cursor: pointer; border-left: 2px solid ${isCurrentEvent ? '#f59e0b' : 'transparent'};" 
                             onclick="jumpToEvent(${e.index}); closeModal();">
                            <span style="color: #9ca3af;">#${e.index + 1}</span>
                            ${actionIcon} ${e.action.replace(/_/g, ' ')}
                            ${playerName ? `<span style="color: #6b7280;"> - ${playerName}</span>` : ''}
                        </div>
                    `;
                }
                
                eventsHtml += `</div></div>`;
            }
            
            eventsHtml += `</div>`;
            
            showModal(`
                <h3>üìú Timeline du Jeu</h3>
                ${timelineHtml}
                ${eventsHtml}
            `, `
                <button class="btn" style="background: #fee2e2; color: #dc2626;" onclick="goToFirstEvent(); closeModal();">‚èÆÔ∏è D√©but</button>
                <button class="btn" style="background: #fecaca; color: #dc2626;" onclick="goBackOneEvent(); closeModal();">‚óÄÔ∏è -1</button>
                <button class="btn" style="background: #bbf7d0; color: #059669;" onclick="goForwardOneEvent(); closeModal();">‚ñ∂Ô∏è +1</button>
                <button class="btn" style="background: #dcfce7; color: #059669;" onclick="goToLastEvent(); closeModal();">‚è≠Ô∏è Live</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `);
        }
        
        function jumpToTurnFromSlider(turnNumber) {
            const displayEl = document.getElementById('sliderTurnDisplay');
            if (displayEl) displayEl.textContent = `Tour ${turnNumber}`;
            goToTurn(parseInt(turnNumber));
        }
        
        function getActionIcon(action) {
            const icons = {
                'GAME_CREATE': 'üéÆ',
                'GAME_START': 'üöÄ',
                'GAME_LOADED': 'üìÇ',
                'ROLL_DICE': 'üé≤',
                'BUY_ACTIVITY': 'üè™',
                'BUY_EQUIPMENT_A': 'üåø',
                'BUY_EQUIPMENT_B': '‚ö°',
                'PAY_SALARY': 'üí∞',
                'PAY_INVOICE': 'üßæ',
                'PAY_FEE': 'üí∏',
                'PAY_TAX': 'üèõÔ∏è',
                'LINE_2_FEE': 'üìö',
                'CHANCE_CARD': 'üçÄ',
                'MALCHANCE_CARD': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                'BANK_LOAN': 'üè¶',
                'AAA_LOAN': LOGO_AAA,
                'REPAY_LOAN': 'üí≥',
                'REPAY_AAA': LOGO_AAA,
                'JOIN_AAA': LOGO_AAA,
                'NEW_ROUND': 'üîÑ',
                'AUCTION_START': 'üî®',
                'AUCTION_BID': 'üí∞',
                'BANKRUPTCY': '‚ö†Ô∏è',
                'COOP_WORK': 'ü§ù',
                'FORCED_LOAN': 'üìã',
                'FORK_HISTORY': 'üîÄ'
            };
            return icons[action] || 'üìç';
        }
        
        function jumpToEvent(index) {
            closeModal();
            replayMode = true;
            currentEventIndex = index;
            restoreToEvent(index);
            updateEventPositionDisplay();
            updateGameUI();
            updateBoard();
            
            const event = GAME_SAVE.events[index];
            if (event) {
                sendSystemMessage(`üìç Saut vers Event ${index + 1}: ${event.action} (Tour ${event.turn})`);
            }
        }

 


  
       
        
    </script>
</body>
</html>
