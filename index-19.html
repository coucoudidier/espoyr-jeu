<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title># ESPOYR Multijoueur V3 - Comptabilit√© compl√®te</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --green: #10b981; --green-dark: #059669;
            --orange: #f59e0b; --red: #ef4444;
            --blue: #3b82f6; --purple: #8b5cf6; --gray: #6b7280;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            min-height: 100vh; padding: 10px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .card {
            background: white; border-radius: 16px;
            padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        h1 { color: var(--green); text-align: center; margin-bottom: 8px; font-size: 1.8rem; }
        h2 { color: var(--green-dark); margin-bottom: 12px; font-size: 1.2rem; }
        .subtitle { text-align: center; color: var(--gray); margin-bottom: 20px; font-size: 0.9rem; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 10px;
            font-size: 0.95rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: linear-gradient(135deg, var(--green), var(--green-dark)); color: white; }
        .btn-secondary { background: linear-gradient(135deg, var(--blue), #2563eb); color: white; }
        .btn-orange { background: linear-gradient(135deg, var(--orange), #d97706); color: white; }
        .btn-full { width: 100%; justify-content: center; }
        input, select {
            width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb;
            border-radius: 10px; font-size: 1rem; margin-bottom: 12px;
        }
        input:focus, select:focus { outline: none; border-color: var(--green); }
        .code-display {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 3px solid var(--orange); border-radius: 12px;
            padding: 15px; text-align: center; margin: 15px 0;
        }
        .code-display .code {
            font-size: 2rem; font-weight: bold; color: #92400e;
            letter-spacing: 6px; font-family: monospace;
        }
        .players-list { display: flex; flex-direction: column; gap: 8px; margin: 10px 0; }
        .player-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; background: #f3f4f6;
            border-radius: 10px; font-size: 0.9rem;
        }
        .player-item.me { background: #dcfce7; border: 2px solid var(--green); }
        .player-item.current-turn {
            background: #fef3c7; border: 2px solid var(--orange);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
        }
        .player-avatar { font-size: 1.5rem; }
        .player-info { flex: 1; }
        .player-name { font-weight: 600; color: #1f2937; }
        .player-stats { font-size: 0.8rem; color: var(--gray); }
        .player-badge { padding: 3px 8px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
        .badge-host { background: var(--purple); color: white; }
        .badge-ready { background: var(--green); color: white; }
        
        /* PLATEAU */
        .board-container {
            display: flex; flex-wrap: wrap; gap: 6px; justify-content: center;
            padding: 10px; background: #f9fafb; border-radius: 12px; margin: 10px 0;
        }
        .case {
            width: calc(14.28% - 6px); min-width: 70px; max-width: 90px;
            aspect-ratio: 1; background: white; border: 2px solid #e5e7eb;
            border-radius: 8px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 0.65rem;
            position: relative; cursor: pointer; transition: all 0.2s;
        }
        .case:hover { transform: scale(1.08); box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10; }
        .case.start { background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-color: var(--green); }
        .case.activite { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .case.activite.owned { border-width: 3px; }
        .case.chance { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-color: var(--blue); }
        .case.frais { background: linear-gradient(135deg, #fee2e2, #fecaca); border-color: var(--red); }
        .case.taxe { background: linear-gradient(135deg, #f3e8ff, #e9d5ff); border-color: var(--purple); }
        .case.malchance { background: linear-gradient(135deg, #fef3c7, #fde68a); border-color: var(--orange); }
        .case.ligne2 { background: linear-gradient(135deg, #fce7f3, #fbcfe8); border-color: #ec4899; }
        .case-number { position: absolute; top: 2px; left: 4px; font-size: 0.55rem; color: #9ca3af; font-weight: bold; }
        .case-icon { font-size: 1.3rem; }
        .case-name { font-size: 0.55rem; text-align: center; color: #4b5563; line-height: 1.1; margin-top: 2px; }
        .case-price { font-size: 0.5rem; color: var(--green-dark); font-weight: bold; }
        .case-hash {
            position: absolute; top: 2px; right: 3px; background: var(--green);
            color: white; font-size: 0.5rem; padding: 1px 3px; border-radius: 3px; font-weight: bold;
        }
        .players-on-case {
            position: absolute; bottom: 1px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 2px;
        }
        .player-marker {
            width: 10px; height: 10px; border-radius: 50%;
            border: 1px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.4);
        }
        .owner-indicator { position: absolute; bottom: 2px; right: 2px; font-size: 0.6rem; }
        .case.current {
            transform: scale(1.08);
            box-shadow: 0 0 30px rgba(245,158,11,0.8), 0 0 60px rgba(245,158,11,0.4);
            border-color: var(--orange) !important;
            z-index: 10;
            animation: casePulse 0.3s ease-in-out;
        }
        @keyframes casePulse {
            0% { transform: scale(1); box-shadow: 0 0 10px rgba(245,158,11,0.3); }
            50% { transform: scale(1.12); box-shadow: 0 0 40px rgba(245,158,11,1); }
            100% { transform: scale(1.08); box-shadow: 0 0 30px rgba(245,158,11,0.8); }
        }
        
        /* LAYOUT JEU */
        .game-layout { display: grid; grid-template-columns: 1fr 300px; gap: 15px; }
        @media (max-width: 900px) {
            .game-layout { grid-template-columns: 1fr; }
            .case { width: calc(16.66% - 6px); min-width: 55px; }
        }
        
        .dice-area { text-align: center; padding: 15px; background: #f9fafb; border-radius: 12px; margin: 10px 0; }
        .dice { font-size: 3.5rem; margin: 8px 0; display: inline-block; }
        .dice.rolling { animation: roll 0.1s infinite; }
        @keyframes roll {
            0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); }
            75% { transform: rotate(-10deg); } 100% { transform: rotate(0deg); }
        }
        
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; background: #f3f4f6; border-radius: 10px;
            margin-bottom: 10px; font-size: 0.85rem;
        }
        .turn-indicator { font-weight: 600; color: var(--green-dark); }
        
        /* JOURNAL COMPTABLE */
        .journal-box {
            height: 200px; overflow-y: auto; border: 2px solid #e5e7eb;
            border-radius: 10px; padding: 8px; background: #fafafa;
            font-size: 0.75rem; font-family: monospace;
        }
        .journal-entry {
            padding: 4px 6px; margin-bottom: 4px; background: white;
            border-radius: 4px; border-left: 3px solid var(--green);
        }
        .journal-entry.debit { border-left-color: var(--red); }
        .journal-entry.credit { border-left-color: var(--green); }
        
        /* CHAT */
        .chat-box {
            height: 120px; overflow-y: auto; border: 2px solid #e5e7eb;
            border-radius: 10px; padding: 8px; margin-bottom: 8px;
            background: #fafafa; font-size: 0.85rem;
        }
        .chat-message { margin-bottom: 6px; padding: 6px 10px; background: white; border-radius: 8px; }
        .chat-message .sender { font-weight: 600; color: var(--green-dark); }
        .chat-message.system { background: #fef3c7; font-style: italic; color: #92400e; }
        .chat-input { display: flex; gap: 8px; }
        .chat-input input { flex: 1; margin-bottom: 0; font-size: 0.85rem; padding: 8px 10px; }
        
        .hidden { display: none !important; }
        .connection-status {
            position: fixed; top: 8px; right: 8px; padding: 6px 12px;
            border-radius: 20px; font-size: 0.75rem; font-weight: 600; z-index: 100;
        }
        .connection-status.connected { background: #dcfce7; color: var(--green-dark); }
        .connection-status.disconnected { background: #fee2e2; color: var(--red); }
        
        .divider { display: flex; align-items: center; margin: 20px 0; color: var(--gray); }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: #e5e7eb; }
        .divider span { padding: 0 12px; font-size: 0.85rem; }
        
        .error-message {
            background: #fee2e2; color: #dc2626; padding: 10px 12px;
            border-radius: 10px; margin-bottom: 12px; display: none; font-size: 0.9rem;
        }
        .loading {
            display: inline-block; width: 18px; height: 18px;
            border: 3px solid #f3f3f3; border-top: 3px solid var(--green);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal {
            background: white; border-radius: 16px; padding: 20px;
            max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        .modal h3 { color: var(--green-dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .modal-buttons .btn { flex: 1; min-width: 100px; }
        
        /* TABS */
        .tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab {
            padding: 8px 15px; background: #f3f4f6; border: none;
            border-radius: 8px 8px 0 0; cursor: pointer; font-size: 0.85rem;
        }
        .tab.active { background: var(--green); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .avatar-btn {
            width: 45px; height: 45px; font-size: 1.6rem;
            border: 3px solid #e5e7eb; border-radius: 10px;
            background: white; cursor: pointer; transition: all 0.2s;
        }
        .avatar-btn:hover { transform: scale(1.1); }
        .avatar-btn.selected { border-color: var(--green); background: #dcfce7; }
        
        /* BILAN */
        .bilan-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
        .bilan-table th, .bilan-table td { padding: 5px 8px; border: 1px solid #e5e7eb; }
        .bilan-table th { background: #f3f4f6; text-align: left; }
        .bilan-table .actif { background: #dcfce7; }
        .bilan-table .passif { background: #fee2e2; }
        .bilan-table .total { font-weight: bold; background: #fef3c7; }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">‚ö™ D√©connect√©</div>
    
    <div class="container">
        <!-- √âCRAN ACCUEIL -->
        <div id="homeScreen" class="card">
            <h1><img src="logo__g1_jaune_rond.png" alt="Logo ESPOYR" style="height: 1.5em; vertical-align: middle; margin-right: 8px;">ESPOYR</h1>
            <p class="subtitle">Jeu collaboratif d'√©conomie - V3 Comptabilit√© compl√®te</p>
            <div class="error-message" id="errorMessage"></div>
            
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 6px; font-size: 0.9rem;">Ton nom :</label>
                <input type="text" id="playerName" placeholder="Entre ton pr√©nom..." maxlength="15">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 6px; font-size: 0.9rem;">Ton avatar :</label>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="avatar-btn selected" data-avatar="üë®">üë®</button>
                    <button class="avatar-btn" data-avatar="üë©">üë©</button>
                    <button class="avatar-btn" data-avatar="üë¶">üë¶</button>
                    <button class="avatar-btn" data-avatar="üëß">üëß</button>
                    <button class="avatar-btn" data-avatar="üßë">üßë</button>
                    <button class="avatar-btn" data-avatar="üë¥">üë¥</button>
                    <button class="avatar-btn" data-avatar="üëµ">üëµ</button>
                    <button class="avatar-btn" data-avatar="ü¶ä">ü¶ä</button>
                </div>
            </div>
            
            <button class="btn btn-primary btn-full" onclick="createGame()" style="margin-bottom: 12px;">
                ‚ûï Cr√©er une nouvelle partie
            </button>
            
            <div class="divider"><span>ou rejoindre</span></div>
            
            <div style="margin-top: 12px;">
                <input type="text" id="gameCode" placeholder="Code (ex: ABC123)" maxlength="6" 
                       style="text-transform: uppercase; text-align: center; font-size: 1.2rem; letter-spacing: 3px;">
                <button class="btn btn-secondary btn-full" onclick="joinGame()">üö™ Rejoindre une partie</button>
            </div>
        </div>
        
        <!-- √âCRAN LOBBY -->
        <div id="lobbyScreen" class="card hidden">
            <h2>üéÆ Salle d'attente</h2>
            <div class="code-display">
                <div style="font-size: 0.85rem; color: #92400e; margin-bottom: 4px;">Code de la partie :</div>
                <div class="code" id="lobbyCode">------</div>
            </div>
            <h3 style="color: var(--gray); margin-bottom: 8px; font-size: 0.95rem;">Joueurs (<span id="playerCount">0</span>/4)</h3>
            <div class="players-list" id="lobbyPlayers"></div>
            <div id="hostControls" class="hidden" style="margin-top: 15px;">
                <button class="btn btn-primary btn-full" onclick="startGame()" id="startGameBtn" disabled>üöÄ Lancer</button>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button class="btn" style="flex:1; background: #dbeafe; color: #2563eb;" onclick="showAddBotModal()">ü§ñ Robot</button>
                    <button class="btn" style="flex:1; background: #fef3c7; color: #92400e;" onclick="showConfigModal()">‚öôÔ∏è Config</button>
                </div>
            </div>
            <div id="waitingMessage" style="text-align: center; margin-top: 15px; color: var(--gray);">
                <div class="loading"></div>
                <p style="margin-top: 8px; font-size: 0.9rem;">En attente du lancement...</p>
            </div>
            <button class="btn" onclick="leaveGame()" style="margin-top: 15px; background: #f3f4f6; color: var(--gray); font-size: 0.85rem;">‚Üê Quitter</button>
        </div>
        
        <!-- √âCRAN JEU -->
        <div id="gameScreen" class="card hidden">
            <div class="status-bar">
                <div>üîÑ Tour <strong id="turnNumber">1</strong></div>
                <div class="turn-indicator" id="turnIndicator">üéØ ...</div>
                <div>üìä Phase <strong id="phaseNumber">1</strong></div>
                <div id="sensIndicator" style="font-size: 0.8rem;">‚û°Ô∏è</div>
                <button class="btn" style="padding: 4px 8px; font-size: 0.7rem; background: #f3f4f6;" onclick="saveGame()">üíæ</button>
            </div>
            
            <div class="game-layout">
                <div class="main-area">
                    <div class="board-container" id="gameBoard"></div>
                    <div class="dice-area" id="diceArea">
                        <div id="diceMessage" style="font-size: 0.9rem;">Lance le d√© !</div>
                        <div class="dice" id="dice">üé≤</div>
                        <button class="btn btn-orange" id="rollDiceBtn" onclick="rollDice()">üé≤ Lancer</button>
                    </div>
                    
                    <!-- ACTIONS RAPIDES -->
                    <div style="background: #f8fafc; padding: 8px; border-radius: 8px; margin: 10px 0;">
                        <p style="margin: 0 0 6px 0; font-size: 0.75rem; color: #64748b; font-weight: bold;">‚ö° ACTIONS</p>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <button class="btn" style="background: #dcfce7; color: #059669; flex: 1; font-size: 0.75rem; padding: 6px;" onclick="showQuickAdhererAAA()">üíö Adh√©rer AAA</button>
                            <button class="btn" style="background: #dbeafe; color: #2563eb; flex: 1; font-size: 0.75rem; padding: 6px;" onclick="showQuickEmprunter()">üí∂ Emprunter</button>
                            <button class="btn" style="background: #fef3c7; color: #92400e; flex: 1; font-size: 0.75rem; padding: 6px;" onclick="showQuickEquiper()">üîß √âquiper</button>
                        </div>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px;">
                            <button class="btn" style="background: #e0e7ff; color: #4338ca; flex: 1; font-size: 0.75rem; padding: 6px;" onclick="showQuickVendre()">üè∑Ô∏è Vendre</button>
                            <button class="btn" style="background: #fce7f3; color: #be185d; flex: 1; font-size: 0.75rem; padding: 6px;" onclick="showQuickRembourser()">üí≥ Rembourser</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0;">
                        <button class="btn" style="background: #dcfce7; color: #059669; flex: 1;" onclick="showAAAModal()">üíö Pot AAA</button>
                        <button class="btn" style="background: #fee2e2; color: #dc2626; flex: 1;" onclick="showBankModal()">üè¶ Banque</button>
                        <button class="btn" style="background: #fef9c3; color: #854d0e; flex: 1;" onclick="showFailliteModal()">‚ö†Ô∏è Faillite</button>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn" style="background: #dbeafe; color: #2563eb; flex: 1;" onclick="showComptaModal()">üìí Compta</button>
                        <button class="btn" style="background: #fef3c7; color: #92400e; flex: 1;" onclick="showBilanModal()">üìä Bilan</button>
                        <button class="btn" style="background: #f3e8ff; color: #7c3aed; flex: 1;" onclick="showSaveAnalysisModal()">üìà Audit</button>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                        <button class="btn" id="configBtn" style="background: #e5e7eb; color: #374151; flex: 1; display: none;" onclick="showConfigModal()">‚öôÔ∏è Config</button>
                    </div>
                </div>
                
                <div class="side-panel">
                    <h3 style="color: var(--gray); margin-bottom: 8px; font-size: 0.9rem;">üë• Joueurs</h3>
                    <div class="players-list" id="gamePlayers"></div>
                    <h3 style="color: var(--gray); margin: 12px 0 6px; font-size: 0.9rem;">üí¨ Chat</h3>
                    <div class="chat-box" id="chatBox"></div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Message..." onkeypress="if(event.key==='Enter')sendChat()">
                        <button class="btn btn-primary" onclick="sendChat()" style="padding: 8px 12px; font-size: 0.8rem;">‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="modalContainer"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // ========== FIREBASE CONFIG ==========
        const firebaseConfig = {
            apiKey: "AIzaSyC5hPhmhgQNY1qrFQ63XOIFNXhdy5EsDMM",
            authDomain: "espoyr--game.firebaseapp.com",
            databaseURL: "https://espoyr--game-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "espoyr--game",
            storageBucket: "espoyr--game.firebasestorage.app",
            messagingSenderId: "689112154741",
            appId: "1:689112154741:web:a471dadae9becbaf3ca3eb"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // ========== PLAN COMPTABLE ==========
        const PLAN_COMPTABLE = {
            // Classe 1 - Capitaux
            100: { nom: 'Capital activit√©', classe: 1, type: 'passif' },
            101: { nom: 'Capital joueur', classe: 1, type: 'passif' },
            109: { nom: 'R√©sultat exercice', classe: 1, type: 'passif' },
            110: { nom: 'Emprunt bancaire', classe: 1, type: 'passif' },
            130: { nom: 'Pr√™t de relance', classe: 1, type: 'passif' },
            135: { nom: 'Fonds Pot AAA', classe: 1, type: 'passif' },
            160: { nom: 'Annulation emprunt', classe: 1, type: 'passif' },
            164: { nom: 'Emprunt bancaire (alias)', classe: 1, type: 'passif' },
            // Classe 2 - Immobilisations
            200: { nom: 'Immobilisation activit√©', classe: 2, type: 'actif' },
            210: { nom: '√âquipement A (durable)', classe: 2, type: 'actif' },
            211: { nom: 'Activit√©s (alias)', classe: 2, type: 'actif' },
            218: { nom: '√âquipements (alias)', classe: 2, type: 'actif' },
            220: { nom: '√âquipement B (classique)', classe: 2, type: 'actif' },
            260: { nom: 'Apports activit√©s', classe: 2, type: 'actif' },
            291: { nom: 'Pr√™ts √† la client√®le', classe: 2, type: 'actif' },
            2919: { nom: 'R√©duction de valeur act√©e', classe: 2, type: 'actif' },
            // Classe 4 - Tiers
            44: { nom: 'Dette Coop AAA / ASBL', classe: 4, type: 'passif' },
            400: { nom: 'Dettes perso', classe: 4, type: 'passif' },
            401: { nom: 'Fournisseurs', classe: 4, type: 'passif' },
            410: { nom: 'Smart contract', classe: 4, type: 'passif' },
            411: { nom: 'Clients', classe: 4, type: 'actif' },
            421: { nom: 'Personnel', classe: 4, type: 'passif' },
            431: { nom: '√âtat - Taxes', classe: 4, type: 'passif' },
            48: { nom: 'Cr√©ances Pot AAA', classe: 4, type: 'actif' },
            480: { nom: 'Cr√©ances Pot AAA d√©tail', classe: 4, type: 'actif' },
            489: { nom: 'Dette Pot AAA activit√©', classe: 4, type: 'passif' },
            // Classe 5 - Financiers
            500: { nom: 'Caisse ‚Ç¨', classe: 5, type: 'actif' },
            501: { nom: 'Caisse #', classe: 5, type: 'actif' },
            510: { nom: 'Caisse # activit√©', classe: 5, type: 'actif' },
            512: { nom: 'Banque', classe: 5, type: 'actif' },
            540: { nom: 'Compte Exportation', classe: 5, type: 'actif' },
            541: { nom: 'Compte √âtat', classe: 5, type: 'actif' },
            580: { nom: 'Caisse Pot AAA', classe: 5, type: 'actif' },
            // Classe 6 - Charges
            601: { nom: 'Achats activit√©s', classe: 6, type: 'charge' },
            602: { nom: 'Achats √©quipements', classe: 6, type: 'charge' },
            613: { nom: 'Frais divers', classe: 6, type: 'charge' },
            634: { nom: 'Dotation r√©duction valeur', classe: 6, type: 'charge' },
            635: { nom: 'Taxes et imp√¥ts', classe: 6, type: 'charge' },
            640: { nom: 'Taxes activit√©', classe: 6, type: 'charge' },
            641: { nom: 'Salaires bruts', classe: 6, type: 'charge' },
            645: { nom: 'Charges patronales', classe: 6, type: 'charge' },
            650: { nom: 'Int√©r√™ts bancaires', classe: 6, type: 'charge' },
            661: { nom: 'Int√©r√™ts bancaires (alias)', classe: 6, type: 'charge' },
            671: { nom: 'Charges exceptionnelles', classe: 6, type: 'charge' },
            678: { nom: 'Pertes sur cr√©ances', classe: 6, type: 'charge' },
            680: { nom: 'Moins-value vente', classe: 6, type: 'charge' },
            // Classe 7 - Produits
            700: { nom: 'Ventes / Factures', classe: 7, type: 'produit' },
            701: { nom: 'Salaires re√ßus', classe: 7, type: 'produit' },
            706: { nom: 'Travail coop√©ratif', classe: 7, type: 'produit' },
            730: { nom: 'Produit travail coop', classe: 7, type: 'produit' },
            74: { nom: 'Subventions re√ßues (bonus #)', classe: 7, type: 'produit' },
            758: { nom: 'Produits divers', classe: 7, type: 'produit' },
            760: { nom: 'Plus-value vente', classe: 7, type: 'produit' },
            771: { nom: 'Produits exceptionnels', classe: 7, type: 'produit' },
            778: { nom: 'Produit exceptionnel annulation', classe: 7, type: 'produit' },
            791: { nom: 'Redistribution bien commun', classe: 7, type: 'produit' }
        };
        
        // Table de correspondance V3 ‚Üí Comptes canoniques (alias)
        const COMPTE_ALIAS = {
            // Permet d'utiliser les anciens num√©ros V3 tout en ayant les nouveaux
            // Pour l'instant vide car les deux sont dans PLAN_COMPTABLE
        };
        
        // ========== PLATEAU ESPOYR (23 cases) ==========
        const CASES = [
            { id: 0, type: 'start', name: 'D√©part', icon: 'üèÅ' },
            { id: 1, type: 'activite', name: 'V√™tements', icon: 'üëî', prix: 200, facture: 40, hash: true, prixEquip: 100 },
            { id: 2, type: 'ligne2', name: 'Ligne 2', icon: 'üöå', cout: 50 },
            { id: 3, type: 'activite', name: 'Pharmacie', icon: 'üíä', prix: 220, facture: 45, hash: true, prixEquip: 110 },
            { id: 4, type: 'chance', name: 'Chance', icon: 'üçÄ' },
            { id: 5, type: 'activite', name: 'Jardin', icon: 'üåª', prix: 240, facture: 50, hash: true, prixEquip: 120 },
            { id: 6, type: 'activite', name: 'Librairie', icon: 'üìö', prix: 180, facture: 35, hash: true, prixEquip: 90 },
            { id: 7, type: 'activite', name: 'Boulangerie', icon: 'ü•ñ', prix: 200, facture: 45, hash: true, prixEquip: 100 },
            { id: 8, type: 'activite', name: 'Coiffeur', icon: '‚úÇÔ∏è', prix: 160, facture: 30, hash: true, prixEquip: 80 },
            { id: 9, type: 'frais', name: 'Alimentaire', icon: 'üõí', cout: 50 },
            { id: 10, type: 'activite', name: 'Fleuriste', icon: 'üå∏', prix: 150, facture: 28, hash: true, prixEquip: 75 },
            { id: 11, type: 'activite', name: 'Caf√©', icon: '‚òï', prix: 200, facture: 40, hash: true, prixEquip: 100 },
            { id: 12, type: 'activite', name: 'Restaurant', icon: 'üçΩÔ∏è', prix: 280, facture: 55, hash: true, prixEquip: 140 },
            { id: 13, type: 'taxe', name: 'Taxe', icon: 'üèõÔ∏è' },
            { id: 14, type: 'activite', name: 'Garage', icon: 'üîß', prix: 300, facture: 60, hash: true, prixEquip: 150 },
            { id: 15, type: 'activite', name: 'Cordonnier', icon: 'üëü', prix: 320, facture: 60, hash: true, prixEquip: 160 },
            { id: 16, type: 'activite', name: 'Bijouterie', icon: 'üíé', prix: 260, facture: 52, hash: true, prixEquip: 130 },
            { id: 17, type: 'activite', name: '√âlectricien', icon: '‚ö°', prix: 220, facture: 44, hash: true, prixEquip: 110 },
            { id: 18, type: 'malchance', name: 'Merci', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
            { id: 19, type: 'activite', name: 'Plombier', icon: 'üî©', prix: 240, facture: 48, hash: true, prixEquip: 120 },
            { id: 20, type: 'frais', name: 'M√©dical', icon: 'üè•', cout: 75 },
            { id: 21, type: 'activite', name: 'Entrepreneur', icon: 'üõ†Ô∏è', prix: 320, facture: 65, hash: true, prixEquip: 160 },
            { id: 22, type: 'activite', name: 'Ferme', icon: 'üêÑ', prix: 350, facture: 70, hash: true, prixEquip: 175 }
        ];
        
        const CHANCE_CARDS = [
            { text: "üéâ F√™te du village ! Tous re√ßoivent 60‚Ç¨", amount: 60, all: true },
            { text: "üå± Bonus √©cologique collectif +45‚Ç¨", amount: 45, all: true },
            { text: "üì¶ Bonne r√©colte ! Tous +75‚Ç¨", amount: 75, all: true },
            { text: "üéÅ Don anonyme +150‚Ç¨", amount: 150, all: false },
            { text: "üì∞ Bonne nouvelle +105‚Ç¨", amount: 105, all: false },
            { text: "üçÄ Coup de chance +150‚Ç¨", amount: 150, all: false }
        ];
        
        const MALCHANCE_CARDS = [
            { text: "üí∏ Int√©r√™ts impr√©vus -50‚Ç¨", amount: 50 },
            { text: "üè¶ Frais bancaires -120‚Ç¨", amount: 120 },
            { text: "‚è∞ P√©nalit√©s retard -150‚Ç¨", amount: 150 },
            { text: "üìã Amendes -100‚Ç¨", amount: 100 },
            { text: "üìâ D√©couvert -50‚Ç¨", amount: 50 },
            { text: "üí± Frais change -75‚Ç¨", amount: 75 }
        ];
        
        const PROFILS_IA = {
            PREDATEUR: { id: 'PREDATEUR', nom: 'ü¶à Pr√©dateur', acheteToujours: true },
            PRUDENT: { id: 'PRUDENT', nom: 'üê¢ Prudent', acheteToujours: false },
            COOPERATIF: { id: 'COOPERATIF', nom: 'ü§ù Coop√©ratif', membreAAA: true },
            EQUILIBRE: { id: 'EQUILIBRE', nom: '‚öñÔ∏è √âquilibr√©' },
            INVESTISSEUR: { id: 'INVESTISSEUR', nom: 'üìà Investisseur' },
            SOLIDAIRE: { id: 'SOLIDAIRE', nom: 'üíö Solidaire', membreAAA: true }
        };
        
        const PLAYER_COLORS = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b'];
        
        // Pourcentages salaire CONTRIBUTIF (fixe)
        const SALARY_CONTRIBUTIF = { 1: 1.00, 2: 1.00, 3: 1.00, 4: 1.00, 5: 1.00, 6: 1.00 };
        
        // Pourcentages salaire CR√âATIF (variable selon d√©)
        const SALARY_CREATIF = { 1: 1.50, 2: 0.70, 3: 1.00, 4: 0.80, 5: 1.10, 6: 0.45 };
        
        // Ancien (gard√© pour compatibilit√©)
        const SALARY_PERCENT = { 1: 0.50, 2: 0.75, 3: 1.00, 4: 1.00, 5: 1.25, 6: 1.50 };
        
        const CONFIG = {
            salaireBase: 350,  // Net pay√© au joueur
            capitalInitial: 450,
            potAAAInitial: 1000,
            tauxInteret: 0.10, // 10% par tour
            limiteEmpruntMin: 750,
            // Timings (en secondes) - param√©trables par l'host
            timingDecision: 30,      // Temps pour d√©cider (acheter/passer)
            timingEnchere: 60,       // Temps par tour d'ench√®re
            timingNegociation: 45,   // Temps pour n√©gocier
            timingBot: 2             // D√©lai avant action robot
        };
        
        // Config modifiable par l'host
        let gameConfig = { ...CONFIG };
        
        // ========== √âTAT LOCAL ==========
        let myPlayerId = null;
        let myName = '';
        let myAvatar = 'üë®';
        let currentGameCode = null;
        let isHost = false;
        let gameRef = null;
        let gameState = null;
        let playersData = {};
        
        // ========== SYST√àME DE SAUVEGARDE AUDIT + REPLAY ==========
        const SCHEMA_VERSION = "4.0.0";
        
        // Structure de sauvegarde compl√®te
        let GAME_SAVE = {
            schemaVersion: SCHEMA_VERSION,
            gameId: null,
            createdAt: null,
            lastSavedAt: null,
            
            // RNG pour reproductibilit√©
            rng: {
                mode: "seeded",
                seed: null,
                consumed: 0,
                rolls: []  // Historique des lancers
            },
            
            // √âtat actuel du jeu (reprise imm√©diate)
            state: null,
            
            // Event Log append-only (chronologie)
            events: [],
            eventCounter: 0,
            
            // Journal comptable append-only (double √©critures)
            ledger: [],
            ledgerCounter: 0,
            
            // Snapshots (points de reprise)
            snapshots: [],
            
            // Indexes pour recherche rapide
            indexes: {
                byTurn: {},
                byPlayer: {},
                byEntity: {},
                byAction: {}
            }
        };
        
        // G√©n√©rer un seed al√©atoire
        function generateSeed() {
            return 'seed_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // RNG seed√© pour reproductibilit√©
        function seededRandom() {
            if (!GAME_SAVE.rng.seed) {
                GAME_SAVE.rng.seed = generateSeed();
            }
            // Simple LCG (Linear Congruential Generator)
            const a = 1664525;
            const c = 1013904223;
            const m = Math.pow(2, 32);
            
            let seed = GAME_SAVE.rng.consumed;
            seed = (a * seed + c) % m;
            GAME_SAVE.rng.consumed++;
            
            return seed / m;
        }
        
        // Lancer de d√© avec enregistrement
        function rollDiceValue() {
            const random = seededRandom();
            const result = Math.floor(random * 6) + 1;
            GAME_SAVE.rng.rolls.push({
                index: GAME_SAVE.rng.consumed - 1,
                value: result,
                timestamp: new Date().toISOString()
            });
            return result;
        }
        
        // ========== EVENT LOG ==========
        function logEvent(action, actorId, payload = {}, ledgerEntryIds = []) {
            const eventId = `EVT_${String(GAME_SAVE.eventCounter++).padStart(6, '0')}`;
            const event = {
                eventId,
                ts: new Date().toISOString(),
                turn: gameState?.turn || 0,
                phase: gameState?.phase || 1,
                actorId,
                action,
                payload,
                ledgerEntryIds,
                hash: null  // Calcul√© apr√®s
            };
            
            // Hash simple pour int√©grit√©
            event.hash = simpleHash(JSON.stringify({
                eventId: event.eventId,
                action: event.action,
                payload: event.payload
            }));
            
            GAME_SAVE.events.push(event);
            
            // Indexer
            indexEvent(event);
            
            return eventId;
        }
        
        // Indexer un event
        function indexEvent(event) {
            const turn = event.turn;
            const player = event.actorId;
            const action = event.action;
            
            // Index par tour
            if (!GAME_SAVE.indexes.byTurn[turn]) {
                GAME_SAVE.indexes.byTurn[turn] = { eventIds: [], ledgerIds: [] };
            }
            GAME_SAVE.indexes.byTurn[turn].eventIds.push(event.eventId);
            event.ledgerEntryIds.forEach(lid => {
                if (!GAME_SAVE.indexes.byTurn[turn].ledgerIds.includes(lid)) {
                    GAME_SAVE.indexes.byTurn[turn].ledgerIds.push(lid);
                }
            });
            
            // Index par joueur
            if (player) {
                if (!GAME_SAVE.indexes.byPlayer[player]) {
                    GAME_SAVE.indexes.byPlayer[player] = { eventIds: [], ledgerIds: [] };
                }
                GAME_SAVE.indexes.byPlayer[player].eventIds.push(event.eventId);
                event.ledgerEntryIds.forEach(lid => {
                    GAME_SAVE.indexes.byPlayer[player].ledgerIds.push(lid);
                });
            }
            
            // Index par action
            if (!GAME_SAVE.indexes.byAction[action]) {
                GAME_SAVE.indexes.byAction[action] = [];
            }
            GAME_SAVE.indexes.byAction[action].push(event.eventId);
        }
        
        // Hash simple pour int√©grit√©
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'H' + Math.abs(hash).toString(16).padStart(8, '0');
        }
        
        // ========== SNAPSHOTS ==========
        function createSnapshot() {
            const snapshotId = `SNP_T${gameState?.turn || 0}`;
            const snapshot = {
                snapshotId,
                ts: new Date().toISOString(),
                turn: gameState?.turn || 0,
                phase: gameState?.phase || 1,
                eventCursor: GAME_SAVE.events.length > 0 ? GAME_SAVE.events[GAME_SAVE.events.length - 1].eventId : null,
                ledgerCursor: GAME_SAVE.ledger.length > 0 ? GAME_SAVE.ledger[GAME_SAVE.ledger.length - 1].ledgerEntryId : null,
                state: JSON.parse(JSON.stringify({
                    gameState,
                    playersData,
                    COMPTABILITE,
                    gameConfig
                }))
            };
            
            GAME_SAVE.snapshots.push(snapshot);
            return snapshotId;
        }
        
        // Trouver le snapshot le plus proche avant un eventId
        function findSnapshotBefore(eventId) {
            const eventIndex = GAME_SAVE.events.findIndex(e => e.eventId === eventId);
            if (eventIndex === -1) return null;
            
            // Chercher le snapshot avec eventCursor < eventId
            for (let i = GAME_SAVE.snapshots.length - 1; i >= 0; i--) {
                const snap = GAME_SAVE.snapshots[i];
                const snapEventIndex = GAME_SAVE.events.findIndex(e => e.eventId === snap.eventCursor);
                if (snapEventIndex < eventIndex) {
                    return snap;
                }
            }
            return GAME_SAVE.snapshots[0] || null;
        }
        
        // ========== COMPTABILIT√â LOCALE (synchronis√©e Firebase) ==========
        let COMPTABILITE = {
            journal: [],
            numeroEcriture: 0,
            grandLivre: {},
            caisseJoueurs: {},
            caisseActivites: {},
            parJoueur: {},  // Grand-livre par joueur (journal + balances)
            banque: {
                creancesJoueurs: 0,
                masseMonetaire: 0,
                interetsRecus: 0,
                capital: 0,
                reductionValeur: 0,  // RDV pour cr√©ances douteuses
                journal: []  // Journal des op√©rations bancaires
            },
            potAAA: {
                solde: CONFIG.potAAAInitial,
                circulationHash: 0,
                membres: [],
                creances: {},
                journal: []  // Journal du Pot AAA
            },
            etat: {
                tresor: 0,
                taxesRecues: 0,
                salairesVerses: 0,
                journal: []  // Journal de l'√âtat
            },
            exportation: {
                solde: 0,  // Peut √™tre n√©gatif (d√©couvert)
                recettes: 0,
                salairesVerses: 0,
                journal: []  // Journal de l'Exportation
            }
        };
        
        // S'assurer que tous les champs de COMPTABILITE existent
        function normalizeComptabilite() {
            if (!COMPTABILITE.journal) COMPTABILITE.journal = [];
            if (!COMPTABILITE.grandLivre) COMPTABILITE.grandLivre = {};
            if (!COMPTABILITE.caisseJoueurs) COMPTABILITE.caisseJoueurs = {};
            if (!COMPTABILITE.caisseActivites) COMPTABILITE.caisseActivites = {};
            if (!COMPTABILITE.parJoueur) COMPTABILITE.parJoueur = {};
            if (!COMPTABILITE.banque) COMPTABILITE.banque = { creancesJoueurs: 0, masseMonetaire: 0, interetsRecus: 0, capital: 0, reductionValeur: 0, journal: [] };
            if (!COMPTABILITE.banque.journal) COMPTABILITE.banque.journal = [];
            if (!COMPTABILITE.banque.reductionValeur === undefined) COMPTABILITE.banque.reductionValeur = 0;
            if (!COMPTABILITE.potAAA) COMPTABILITE.potAAA = { solde: CONFIG.potAAAInitial, circulationHash: 0, membres: [], creances: {}, journal: [] };
            if (!COMPTABILITE.potAAA.membres) COMPTABILITE.potAAA.membres = [];
            if (!COMPTABILITE.potAAA.creances) COMPTABILITE.potAAA.creances = {};
            if (!COMPTABILITE.potAAA.journal) COMPTABILITE.potAAA.journal = [];
            if (!COMPTABILITE.etat) COMPTABILITE.etat = { tresor: 0, taxesRecues: 0, salairesVerses: 0, journal: [] };
            if (!COMPTABILITE.etat.journal) COMPTABILITE.etat.journal = [];
            if (COMPTABILITE.etat.salairesVerses === undefined) COMPTABILITE.etat.salairesVerses = 0;
            if (!COMPTABILITE.exportation) COMPTABILITE.exportation = { solde: 0, recettes: 0, salairesVerses: 0, journal: [] };
            if (!COMPTABILITE.exportation.journal) COMPTABILITE.exportation.journal = [];
            if (COMPTABILITE.exportation.solde === undefined) COMPTABILITE.exportation.solde = 0;
        }
        
        // ========== FONCTIONS COMPTABLES ==========
        
        // Initialiser caisse joueur
        function initCaisseJoueur(joueurId) {
            if (!COMPTABILITE.caisseJoueurs[joueurId]) {
                COMPTABILITE.caisseJoueurs[joueurId] = {
                    euro: 0, espoyr: 0, capital: 0,
                    emprunt: 0, interetsDus: 0,
                    apportsActivites: 0,
                    journal: []
                };
            }
        }
        
        // Initialiser comptabilit√© compl√®te joueur (grand-livre)
        function initComptabiliteJoueur(joueurId) {
            if (!COMPTABILITE.parJoueur[joueurId]) {
                COMPTABILITE.parJoueur[joueurId] = {
                    journal: [],
                    balances: {}  // { 500: { euro: 0, espoyr: 0 }, ... }
                };
            }
        }
        
        // Initialiser caisse activit√©
        function initCaisseActivite(actId) {
            if (!COMPTABILITE.caisseActivites[actId]) {
                const c = CASES[actId];
                COMPTABILITE.caisseActivites[actId] = {
                    euro: 0, espoyr: 0,
                    proprietaireId: null,
                    capital: c?.prix || 0,
                    equipements: 0,
                    recettes: 0, depenses: 0,
                    journal: []
                };
            }
        }
        
        // Enregistrer √©criture comptable (C≈íUR DU SYST√àME)
        function enregistrerEcriture(params) {
            let {
                joueurId, libelle, compteDebit, compteCredit,
                montantEuro = 0, montantEspoyr = 0,
                activiteId = null, details = {}, contexte = null
            } = params;
            
            // R√©soudre les alias si n√©cessaire
            compteDebit = COMPTE_ALIAS[compteDebit] || compteDebit;
            compteCredit = COMPTE_ALIAS[compteCredit] || compteCredit;
            
            if (!PLAN_COMPTABLE[compteDebit] || !PLAN_COMPTABLE[compteCredit]) {
                console.warn(`‚ö†Ô∏è Compte invalide: D${compteDebit} C${compteCredit}`);
                return null;
            }
            
            COMPTABILITE.numeroEcriture++;
            const ecriture = {
                id: COMPTABILITE.numeroEcriture,
                timestamp: new Date().toISOString(),
                tour: gameState?.turn || 1,
                phase: gameState?.phase || 1,
                joueurId, joueurNom: playersData[joueurId]?.name || joueurId,
                libelle,
                debit: { compte: compteDebit, nom: PLAN_COMPTABLE[compteDebit].nom, euro: montantEuro, espoyr: montantEspoyr },
                credit: { compte: compteCredit, nom: PLAN_COMPTABLE[compteCredit].nom, euro: montantEuro, espoyr: montantEspoyr },
                activiteId, details, contexte
            };
            
            COMPTABILITE.journal.push(ecriture);
            
            // ===== AJOUT AU LEDGER GAME_SAVE =====
            const ledgerEntryId = `LED_${String(GAME_SAVE.ledgerCounter++).padStart(6, '0')}`;
            
            // Cr√©er entr√©e(s) ledger (s√©par√©es par devise)
            if (montantEuro > 0) {
                const ledgerEntryEUR = {
                    ledgerEntryId: ledgerEntryId + '_EUR',
                    ts: ecriture.timestamp,
                    turn: ecriture.tour,
                    phase: ecriture.phase,
                    type: 'COMPTA',
                    label: libelle,
                    currency: 'EUR',
                    entity: { kind: joueurId?.startsWith('bot_') ? 'BOT' : 'PLAYER', id: joueurId },
                    debit: [{ account: String(compteDebit), name: PLAN_COMPTABLE[compteDebit].nom, amount: montantEuro }],
                    credit: [{ account: String(compteCredit), name: PLAN_COMPTABLE[compteCredit].nom, amount: montantEuro }],
                    links: { ecritureId: ecriture.id, actId: activiteId, contexte },
                    balanced: true  // Auto-√©quilibr√©
                };
                GAME_SAVE.ledger.push(ledgerEntryEUR);
            }
            
            if (montantEspoyr > 0) {
                const ledgerEntryESP = {
                    ledgerEntryId: ledgerEntryId + '_ESP',
                    ts: ecriture.timestamp,
                    turn: ecriture.tour,
                    phase: ecriture.phase,
                    type: 'COMPTA',
                    label: libelle,
                    currency: 'ESP',
                    entity: { kind: joueurId?.startsWith('bot_') ? 'BOT' : 'PLAYER', id: joueurId },
                    debit: [{ account: String(compteDebit), name: PLAN_COMPTABLE[compteDebit].nom, amount: montantEspoyr }],
                    credit: [{ account: String(compteCredit), name: PLAN_COMPTABLE[compteCredit].nom, amount: montantEspoyr }],
                    links: { ecritureId: ecriture.id, actId: activiteId, contexte },
                    balanced: true
                };
                GAME_SAVE.ledger.push(ledgerEntryESP);
            }
            // ===== FIN AJOUT LEDGER =====
            
            // Grand livre
            if (!COMPTABILITE.grandLivre[compteDebit]) COMPTABILITE.grandLivre[compteDebit] = [];
            if (!COMPTABILITE.grandLivre[compteCredit]) COMPTABILITE.grandLivre[compteCredit] = [];
            COMPTABILITE.grandLivre[compteDebit].push({ ...ecriture, sens: 'debit' });
            COMPTABILITE.grandLivre[compteCredit].push({ ...ecriture, sens: 'credit' });
            
            // Journal joueur (caisseJoueurs)
            if (joueurId) {
                initCaisseJoueur(joueurId);
                COMPTABILITE.caisseJoueurs[joueurId].journal.push(ecriture);
                
                // Grand-livre joueur (parJoueur)
                initComptabiliteJoueur(joueurId);
                COMPTABILITE.parJoueur[joueurId].journal.push(ecriture);
                
                // Mise √† jour balances joueur
                if (!COMPTABILITE.parJoueur[joueurId].balances[compteDebit]) {
                    COMPTABILITE.parJoueur[joueurId].balances[compteDebit] = { euro: 0, espoyr: 0 };
                }
                if (!COMPTABILITE.parJoueur[joueurId].balances[compteCredit]) {
                    COMPTABILITE.parJoueur[joueurId].balances[compteCredit] = { euro: 0, espoyr: 0 };
                }
                COMPTABILITE.parJoueur[joueurId].balances[compteDebit].euro += montantEuro;
                COMPTABILITE.parJoueur[joueurId].balances[compteDebit].espoyr += montantEspoyr;
                COMPTABILITE.parJoueur[joueurId].balances[compteCredit].euro -= montantEuro;
                COMPTABILITE.parJoueur[joueurId].balances[compteCredit].espoyr -= montantEspoyr;
            }
            
            // Journal activit√©
            if (activiteId !== null) {
                initCaisseActivite(activiteId);
                COMPTABILITE.caisseActivites[activiteId].journal.push(ecriture);
                
                // Maj totaux analytiques
                if (PLAN_COMPTABLE[compteCredit].classe === 7) {
                    COMPTABILITE.caisseActivites[activiteId].recettes += montantEuro + montantEspoyr;
                }
                if (PLAN_COMPTABLE[compteDebit].classe === 6) {
                    COMPTABILITE.caisseActivites[activiteId].depenses += montantEuro + montantEspoyr;
                }
            }
            
            // Journaux par contexte (entit√©s)
            if (contexte === 'banque' || compteDebit === 512 || compteCredit === 512 || 
                compteDebit === 164 || compteCredit === 164 || compteDebit === 110 || compteCredit === 110) {
                COMPTABILITE.banque.journal.push(ecriture);
            }
            if (contexte === 'potAAA' || compteDebit === 580 || compteCredit === 580 || 
                compteDebit === 135 || compteCredit === 135 || compteDebit === 48 || compteCredit === 48) {
                COMPTABILITE.potAAA.journal.push(ecriture);
            }
            if (contexte === 'etat' || compteDebit === 635 || compteCredit === 635 || 
                compteDebit === 431 || compteCredit === 431 || compteDebit === 640 || compteCredit === 640 ||
                compteDebit === 541 || compteCredit === 541) {
                COMPTABILITE.etat.journal.push(ecriture);
            }
            if (contexte === 'exportation' || compteDebit === 540 || compteCredit === 540) {
                COMPTABILITE.exportation.journal.push(ecriture);
            }
            
            console.log(`üìí #${ecriture.id}: ${libelle} | D:${compteDebit} C:${compteCredit} | ${montantEuro}‚Ç¨ ${montantEspoyr}#`);
            
            // Retourner l'√©criture avec le ledgerEntryId
            ecriture.ledgerEntryId = ledgerEntryId;
            return ecriture;
        }
        
        // V√©rifier que tous les comptes utilis√©s sont d√©clar√©s dans PLAN_COMPTABLE
        function checkPlanComptableCoverage() {
            const comptesUtilises = new Set();
            
            // Scanner journal global
            COMPTABILITE.journal.forEach(e => {
                if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
            });
            
            // Scanner grand livre
            Object.keys(COMPTABILITE.grandLivre).forEach(c => comptesUtilises.add(parseInt(c)));
            
            // Scanner journaux joueurs (caisseJoueurs)
            Object.values(COMPTABILITE.caisseJoueurs).forEach(c => {
                c.journal?.forEach(e => {
                    if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                    if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
                });
            });
            
            // Scanner journaux activit√©s
            Object.values(COMPTABILITE.caisseActivites).forEach(c => {
                c.journal?.forEach(e => {
                    if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                    if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
                });
            });
            
            // Scanner parJoueur
            Object.values(COMPTABILITE.parJoueur).forEach(p => {
                p.journal?.forEach(e => {
                    if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                    if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
                });
                Object.keys(p.balances || {}).forEach(c => comptesUtilises.add(parseInt(c)));
            });
            
            // Scanner journaux entit√©s
            COMPTABILITE.banque.journal?.forEach(e => {
                if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
            });
            COMPTABILITE.potAAA.journal?.forEach(e => {
                if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
            });
            COMPTABILITE.etat.journal?.forEach(e => {
                if (e.debit?.compte) comptesUtilises.add(e.debit.compte);
                if (e.credit?.compte) comptesUtilises.add(e.credit.compte);
            });
            
            // Comparer avec PLAN_COMPTABLE
            const manquants = [...comptesUtilises].filter(c => !PLAN_COMPTABLE[c] && c);
            
            if (manquants.length > 0) {
                console.warn('‚ö†Ô∏è COMPTES MANQUANTS DANS PLAN_COMPTABLE:', manquants);
            } else {
                console.log('‚úÖ Tous les comptes utilis√©s sont d√©clar√©s dans PLAN_COMPTABLE');
            }
            
            return { 
                comptesUtilises: [...comptesUtilises].filter(c => c).sort((a,b) => a-b), 
                manquants,
                declares: Object.keys(PLAN_COMPTABLE).map(Number).sort((a,b) => a-b)
            };
        }
        
        // Historique des bilans (pour comparaison tour par tour)
        let historiqueBilans = [];
        
        // Calculer le bilan complet de l'√©conomie
        function calculerBilan() {
            const players = Object.values(playersData);
            const tour = gameState?.turn || 1;
            const phase = gameState?.phase || 1;
            
            // Actifs
            let totalCaisseEuro = 0;
            let totalCaisseEspoyr = 0;
            let totalActivites = 0;
            let totalEquipements = 0;
            let totalCreancesAAA = 0;
            
            // Passifs
            let totalEmprunts = 0;
            let totalCapitaux = 0;
            
            // Par joueur
            const bilansJoueurs = {};
            
            players.forEach(p => {
                const caisse = COMPTABILITE.caisseJoueurs[p.id] || {};
                const euro = caisse.euro || p.euro || 0;
                const espoyr = caisse.espoyr || p.espoyr || 0;
                const emprunt = caisse.emprunt || p.emprunt || 0;
                const capital = caisse.capital || 0;
                const apportsActivites = caisse.apportsActivites || 0;
                
                totalCaisseEuro += euro;
                totalCaisseEspoyr += espoyr;
                totalActivites += apportsActivites;
                totalEmprunts += emprunt;
                totalCapitaux += capital;
                
                // Cr√©ances AAA
                const creanceAAA = COMPTABILITE.potAAA.creances?.[p.id] || 0;
                totalCreancesAAA += creanceAAA;
                
                bilansJoueurs[p.id] = {
                    nom: p.name,
                    actif: { euro, espoyr, activites: apportsActivites },
                    passif: { emprunt, capital },
                    net: euro + espoyr + apportsActivites - emprunt,
                    creanceAAA
                };
            });
            
            // Calcul √©quipements
            Object.values(COMPTABILITE.caisseActivites).forEach(act => {
                totalEquipements += (act.equipements || 0) * 100; // Estimation valeur √©quipements
            });
            
            // Bilan global
            const actifTotal = totalCaisseEuro + totalCaisseEspoyr + totalActivites + totalEquipements;
            const passifTotal = totalEmprunts + totalCapitaux;
            
            // Bilan Banque (avec RDV)
            const reductionValeur = COMPTABILITE.banque.reductionValeur || 0;
            const bilanBanque = {
                actif: { 
                    creancesJoueurs: COMPTABILITE.banque.creancesJoueurs,
                    creancesNettes: COMPTABILITE.banque.creancesJoueurs - reductionValeur
                },
                passif: { masseMonetaire: COMPTABILITE.banque.masseMonetaire },
                interetsRecus: COMPTABILITE.banque.interetsRecus,
                reductionValeur: reductionValeur
            };
            
            // Bilan Pot AAA
            const bilanAAA = {
                actif: { creances: totalCreancesAAA },
                passif: { solde: COMPTABILITE.potAAA.solde },
                circulationHash: COMPTABILITE.potAAA.circulationHash,
                membres: COMPTABILITE.potAAA.membres?.length || 0
            };
            
            // Bilan √âtat
            const bilanEtat = {
                actif: { tresor: COMPTABILITE.etat.tresor },
                taxesRecues: COMPTABILITE.etat.taxesRecues,
                salairesVerses: COMPTABILITE.etat.salairesVerses || 0
            };
            
            // Bilan Exportation
            const bilanExportation = {
                solde: COMPTABILITE.exportation?.solde || 0,
                recettes: COMPTABILITE.exportation?.recettes || 0,
                salairesVerses: COMPTABILITE.exportation?.salairesVerses || 0
            };
            
            // Score √©conomique (indicateur de sant√©)
            const scoreEconomique = Math.round(
                (totalCaisseEuro + totalCaisseEspoyr + totalActivites) - 
                (totalEmprunts * 1.5) + 
                (COMPTABILITE.potAAA.circulationHash * 0.5)
            );
            
            const bilan = {
                timestamp: new Date().toISOString(),
                tour, phase,
                actif: {
                    caisseEuro: totalCaisseEuro,
                    caisseEspoyr: totalCaisseEspoyr,
                    activites: totalActivites,
                    equipements: totalEquipements,
                    total: actifTotal
                },
                passif: {
                    emprunts: totalEmprunts,
                    capitaux: totalCapitaux,
                    total: passifTotal
                },
                equilibre: actifTotal - passifTotal,
                bilansJoueurs,
                bilanBanque,
                bilanAAA,
                bilanEtat,
                bilanExportation,
                scoreEconomique,
                nbEcritures: COMPTABILITE.journal.length
            };
            
            return bilan;
        }
        
        // V√©rifier l'√©quilibre du bilan (Actif = Passif)
        function verifierEquilibreBilan() {
            const bilan = calculerBilan();
            const equilibre = bilan.equilibre;
            
            if (Math.abs(equilibre) > 1) { // Tol√©rance de 1‚Ç¨ pour arrondis
                console.warn(`‚ö†Ô∏è D√âS√âQUILIBRE BILAN: Actif ${bilan.actif.total}‚Ç¨ ‚â† Passif ${bilan.passif.total}‚Ç¨ (√©cart: ${equilibre}‚Ç¨)`);
                return { equilibre: false, ecart: equilibre, bilan };
            } else {
                console.log(`‚úÖ Bilan √©quilibr√©: ${bilan.actif.total}‚Ç¨`);
                return { equilibre: true, ecart: 0, bilan };
            }
        }
        
        // Enregistrer le bilan du tour (pour historique)
        function enregistrerBilanTour() {
            const bilan = calculerBilan();
            historiqueBilans.push(bilan);
            
            // Garder les 50 derniers bilans max
            if (historiqueBilans.length > 50) {
                historiqueBilans = historiqueBilans.slice(-50);
            }
            
            console.log(`üìä Bilan Tour ${bilan.tour} enregistr√© (score: ${bilan.scoreEconomique})`);
            return bilan;
        }
        
        // Comparer deux bilans
        function comparerBilans(bilanActuel, bilanPrecedent) {
            if (!bilanPrecedent) return null;
            
            return {
                deltaTour: bilanActuel.tour - bilanPrecedent.tour,
                deltaEuro: bilanActuel.actif.caisseEuro - bilanPrecedent.actif.caisseEuro,
                deltaEspoyr: bilanActuel.actif.caisseEspoyr - bilanPrecedent.actif.caisseEspoyr,
                deltaActivites: bilanActuel.actif.activites - bilanPrecedent.actif.activites,
                deltaEmprunts: bilanActuel.passif.emprunts - bilanPrecedent.passif.emprunts,
                deltaScore: bilanActuel.scoreEconomique - bilanPrecedent.scoreEconomique,
                tendance: bilanActuel.scoreEconomique > bilanPrecedent.scoreEconomique ? 'üìà' : 
                          bilanActuel.scoreEconomique < bilanPrecedent.scoreEconomique ? 'üìâ' : '‚û°Ô∏è'
            };
        }
        
        // ========== EXPORT CSV ==========
        
        // Exporter le journal comptable en CSV
        function exportJournalCSV() {
            const headers = ['ID', 'Date', 'Tour', 'Joueur', 'Libell√©', 'Compte D√©bit', 'Nom D√©bit', 'Compte Cr√©dit', 'Nom Cr√©dit', 'Montant ‚Ç¨', 'Montant #'];
            const rows = COMPTABILITE.journal.map(e => [
                e.id,
                e.timestamp,
                e.tour,
                e.joueurNom || '',
                e.libelle || '',
                e.debit?.compte || '',
                e.debit?.nom || '',
                e.credit?.compte || '',
                e.credit?.nom || '',
                e.debit?.euro || 0,
                e.debit?.espoyr || 0
            ]);
            
            return downloadCSV('espoyr_journal.csv', headers, rows);
        }
        
        // Exporter le bilan en CSV
        function exportBilanCSV() {
            const bilan = calculerBilan();
            const players = Object.values(playersData);
            
            const headers = ['Entit√©', 'Type', 'Caisse ‚Ç¨', 'Caisse #', 'Activit√©s', 'Emprunts', 'Net'];
            const rows = [];
            
            // Lignes joueurs
            players.forEach(p => {
                const bj = bilan.bilansJoueurs[p.id] || {};
                rows.push([
                    p.name,
                    'Joueur',
                    bj.actif?.euro || 0,
                    bj.actif?.espoyr || 0,
                    bj.actif?.activites || 0,
                    bj.passif?.emprunt || 0,
                    bj.net || 0
                ]);
            });
            
            // Ligne totaux
            rows.push([
                'TOTAL JOUEURS',
                'Total',
                bilan.actif.caisseEuro,
                bilan.actif.caisseEspoyr,
                bilan.actif.activites,
                bilan.passif.emprunts,
                bilan.actif.total - bilan.passif.emprunts
            ]);
            
            // Banque
            rows.push([
                'Banque',
                'Institution',
                bilan.bilanBanque.actif.creancesJoueurs,
                0,
                0,
                bilan.bilanBanque.passif.masseMonetaire,
                bilan.bilanBanque.actif.creancesJoueurs - bilan.bilanBanque.passif.masseMonetaire
            ]);
            
            // Pot AAA
            rows.push([
                'Pot AAA',
                'Institution',
                0,
                bilan.bilanAAA.passif.solde,
                0,
                0,
                bilan.bilanAAA.passif.solde
            ]);
            
            // √âtat
            rows.push([
                '√âtat',
                'Institution',
                bilan.bilanEtat.actif.tresor,
                0,
                0,
                0,
                bilan.bilanEtat.actif.tresor
            ]);
            
            return downloadCSV('espoyr_bilan.csv', headers, rows);
        }
        
        // Exporter l'historique des bilans en CSV
        function exportHistoriqueBilansCSV() {
            if (historiqueBilans.length === 0) {
                alert('Aucun historique de bilan. Cliquez sur "üì∏ Sauver ce bilan" d\'abord.');
                return;
            }
            
            const headers = ['Tour', 'Date', 'Caisse ‚Ç¨', 'Caisse #', 'Activit√©s', '√âquipements', 'Emprunts', 'Score √©conomique'];
            const rows = historiqueBilans.map(b => [
                b.tour,
                b.timestamp,
                b.actif.caisseEuro,
                b.actif.caisseEspoyr,
                b.actif.activites,
                b.actif.equipements,
                b.passif.emprunts,
                b.scoreEconomique
            ]);
            
            return downloadCSV('espoyr_historique.csv', headers, rows);
        }
        
        // Fonction utilitaire pour t√©l√©charger un CSV
        function downloadCSV(filename, headers, rows) {
            const csvContent = [
                headers.join(';'),
                ...rows.map(row => row.map(cell => 
                    typeof cell === 'string' && cell.includes(';') ? `"${cell}"` : cell
                ).join(';'))
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`üì• Export CSV: ${filename}`);
            return true;
        }
        
        // ========== √âCRITURES SP√âCIFIQUES ==========
        
        // Capital initial joueur (D:500 C:101)
        async function comptaCapitalInitial(joueurId, montant) {
            initCaisseJoueur(joueurId);
            COMPTABILITE.caisseJoueurs[joueurId].euro = montant;
            COMPTABILITE.caisseJoueurs[joueurId].capital = montant;
            
            // Cr√©ation mon√©taire par la banque
            COMPTABILITE.banque.masseMonetaire += montant;
            
            return enregistrerEcriture({
                joueurId, libelle: `Capital initial ${montant}‚Ç¨`,
                compteDebit: 500, compteCredit: 101, montantEuro: montant
            });
        }
        
        // Salaire selon profil (Contributif = √âtat, Cr√©atif = Exportation)
        async function comptaSalaire(joueurId, montant, deSalaire = 0) {
            initCaisseJoueur(joueurId);
            const player = playersData[joueurId];
            const profil = player?.profil || 'contributif';
            
            COMPTABILITE.caisseJoueurs[joueurId].euro += montant;
            
            if (profil === 'creatif') {
                // Cr√©atif : pay√© par l'Exportation (cr√©ation mon√©taire)
                COMPTABILITE.exportation.solde -= montant;
                COMPTABILITE.exportation.salairesVerses += montant;
                
                return enregistrerEcriture({
                    joueurId, libelle: `Salaire cr√©atif ${montant}‚Ç¨ (d√©:${deSalaire})`,
                    compteDebit: 500, compteCredit: 540, montantEuro: montant,
                    details: { deSalaire, profil: 'creatif' },
                    contexte: 'exportation'
                });
            } else {
                // Contributif : pay√© par l'√âtat (cr√©ation mon√©taire)
                COMPTABILITE.etat.tresor -= montant;
                COMPTABILITE.etat.salairesVerses += montant;
                
                return enregistrerEcriture({
                    joueurId, libelle: `Salaire contributif ${montant}‚Ç¨`,
                    compteDebit: 500, compteCredit: 541, montantEuro: montant,
                    details: { deSalaire, profil: 'contributif' },
                    contexte: 'etat'
                });
            }
        }
        
        // Achat activit√© (D:200 C:500) + r√©partition 10% √âtat, 10% Export, 80% redistribu√©
        async function comptaAchatActivite(joueurId, actId, prix) {
            initCaisseJoueur(joueurId);
            initCaisseActivite(actId);
            
            const players = Object.values(playersData);
            const nbJoueurs = players.length || 1;
            const ledgerEntryIds = [];  // Collecter les IDs des √©critures
            
            // Calcul r√©partition
            const partEtat = Math.floor(prix * 0.10);  // 10%
            const partExport = Math.floor(prix * 0.10);  // 10%
            const partRedistrib = prix - partEtat - partExport;  // 80%
            const partParJoueur = Math.floor(partRedistrib / nbJoueurs);
            
            // L'acheteur paie le prix total
            COMPTABILITE.caisseJoueurs[joueurId].euro -= prix;
            COMPTABILITE.caisseJoueurs[joueurId].apportsActivites += prix;
            COMPTABILITE.caisseActivites[actId].proprietaireId = joueurId;
            COMPTABILITE.caisseActivites[actId].capital = prix;
            
            // √âcriture principale : achat activit√©
            let e = enregistrerEcriture({
                joueurId, libelle: `Achat ${CASES[actId]?.name || actId}`,
                compteDebit: 200, compteCredit: 500, montantEuro: prix, activiteId: actId
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // 10% ‚Üí √âtat
            COMPTABILITE.etat.tresor += partEtat;
            COMPTABILITE.etat.taxesRecues += partEtat;
            e = enregistrerEcriture({
                joueurId, libelle: `Taxe achat activit√© (10%)`,
                compteDebit: 635, compteCredit: 541, montantEuro: partEtat, activiteId: actId,
                contexte: 'etat'
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // 10% ‚Üí Exportation
            COMPTABILITE.exportation.solde += partExport;
            COMPTABILITE.exportation.recettes += partExport;
            e = enregistrerEcriture({
                joueurId, libelle: `Part exportation (10%)`,
                compteDebit: 613, compteCredit: 540, montantEuro: partExport, activiteId: actId,
                contexte: 'exportation'
            });
            if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            
            // 80% ‚Üí Redistribu√© √† tous les joueurs
            for (const p of players) {
                initCaisseJoueur(p.id);
                COMPTABILITE.caisseJoueurs[p.id].euro += partParJoueur;
                
                e = enregistrerEcriture({
                    joueurId: p.id, libelle: `Redistribution bien commun`,
                    compteDebit: 500, compteCredit: 791, montantEuro: partParJoueur, activiteId: actId,
                    details: { source: 'achat_activite', acheteur: joueurId }
                });
                if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            }
            
            // Bonus # (10% du prix) du Pot AAA
            const bonusHash = Math.floor(prix * 0.1);
            if (bonusHash > 0) {
                COMPTABILITE.caisseJoueurs[joueurId].espoyr += bonusHash;
                COMPTABILITE.potAAA.solde -= bonusHash;
                COMPTABILITE.potAAA.circulationHash += bonusHash;
                
                e = enregistrerEcriture({
                    joueurId, libelle: `Bonus # achat activit√©`,
                    compteDebit: 501, compteCredit: 580, montantEspoyr: bonusHash, activiteId: actId,
                    contexte: 'potAAA'
                });
                if (e?.ledgerEntryId) ledgerEntryIds.push(e.ledgerEntryId);
            }
            
            return { partEtat, partExport, partRedistrib, partParJoueur, bonusHash, ledgerEntryIds };
        }
        
        // Achat √©quipement (D:218 C:500)
        // Achat √©quipement A - DURABLE (D:210 C:500 + bonus # compte 74)
        // Prix = prixEquip √ó 1.2, Bonus # = prixEquip √ó 0.10
        async function comptaAchatEquipementA(joueurId, actId) {
            initCaisseJoueur(joueurId);
            initCaisseActivite(actId);
            
            const c = CASES[actId];
            const prixBase = c?.prixEquip || 100;
            const prixA = Math.floor(prixBase * 1.2);  // +20%
            const bonusHash = Math.floor(prixBase * 0.10);  // 10% du prix de base
            
            COMPTABILITE.caisseJoueurs[joueurId].euro -= prixA;
            COMPTABILITE.caisseActivites[actId].equipements++;
            COMPTABILITE.caisseActivites[actId].equipementA = (COMPTABILITE.caisseActivites[actId].equipementA || 0) + 1;
            
            // √âcriture achat √©quipement A
            enregistrerEcriture({
                joueurId, libelle: `√âquipement A (durable) ${c?.name || actId}`,
                compteDebit: 210, compteCredit: 500, montantEuro: prixA, activiteId: actId,
                details: { type: 'equipementA', prixBase }
            });
            
            // Bonus # (subvention du Pot AAA)
            if (bonusHash > 0) {
                COMPTABILITE.caisseJoueurs[joueurId].espoyr += bonusHash;
                COMPTABILITE.potAAA.solde -= bonusHash;
                COMPTABILITE.potAAA.circulationHash += bonusHash;
                
                enregistrerEcriture({
                    joueurId, libelle: `Bonus # √©quipement A`,
                    compteDebit: 501, compteCredit: 74, montantEspoyr: bonusHash, activiteId: actId,
                    contexte: 'potAAA'
                });
            }
            
            return { prixA, bonusHash };
        }
        
        // Achat √©quipement B - CLASSIQUE (D:220 C:500, pas de bonus)
        // Prix = prixEquip √ó 0.8, Bonus # = 0
        async function comptaAchatEquipementB(joueurId, actId) {
            initCaisseJoueur(joueurId);
            initCaisseActivite(actId);
            
            const c = CASES[actId];
            const prixBase = c?.prixEquip || 100;
            const prixB = Math.floor(prixBase * 0.8);  // -20%
            
            COMPTABILITE.caisseJoueurs[joueurId].euro -= prixB;
            COMPTABILITE.caisseActivites[actId].equipements++;
            COMPTABILITE.caisseActivites[actId].equipementB = (COMPTABILITE.caisseActivites[actId].equipementB || 0) + 1;
            
            // √âcriture achat √©quipement B (pas de bonus)
            return enregistrerEcriture({
                joueurId, libelle: `√âquipement B (classique) ${c?.name || actId}`,
                compteDebit: 220, compteCredit: 500, montantEuro: prixB, activiteId: actId,
                details: { type: 'equipementB', prixBase }
            });
        }
        
        // Fonction legacy pour compatibilit√© (redirige vers A par d√©faut)
        async function comptaAchatEquipement(joueurId, actId, prix) {
            initCaisseJoueur(joueurId);
            initCaisseActivite(actId);
            
            COMPTABILITE.caisseJoueurs[joueurId].euro -= prix;
            COMPTABILITE.caisseActivites[actId].equipements++;
            
            // Bonus # (legacy)
            const bonusHash = Math.floor(prix * 0.1);
            if (bonusHash > 0) {
                COMPTABILITE.caisseJoueurs[joueurId].espoyr += bonusHash;
                COMPTABILITE.potAAA.solde -= bonusHash;
                COMPTABILITE.potAAA.circulationHash += bonusHash;
            }
            
            return enregistrerEcriture({
                joueurId, libelle: `√âquipement ${CASES[actId]?.name || actId}`,
                compteDebit: 218, compteCredit: 500, montantEuro: prix, activiteId: actId
            });
        }
        
        // Paiement facture (D:613 C:500 payeur + D:500 C:700 propri√©taire)
        async function comptaPaiementFacture(payeurId, proprietaireId, actId, montantEuro, montantEspoyr = 0) {
            initCaisseJoueur(payeurId);
            initCaisseJoueur(proprietaireId);
            initCaisseActivite(actId);
            
            const total = montantEuro + montantEspoyr;
            const c = CASES[actId];
            
            // Sortie payeur
            COMPTABILITE.caisseJoueurs[payeurId].euro -= montantEuro;
            COMPTABILITE.caisseJoueurs[payeurId].espoyr -= montantEspoyr;
            
            enregistrerEcriture({
                joueurId: payeurId, libelle: `Paiement ${c?.name || actId}`,
                compteDebit: 613, compteCredit: 500, montantEuro, montantEspoyr, activiteId: actId
            });
            
            // Entr√©e propri√©taire (dans caisse activit√©)
            COMPTABILITE.caisseActivites[actId].euro += montantEuro;
            COMPTABILITE.caisseActivites[actId].espoyr += montantEspoyr;
            COMPTABILITE.caisseActivites[actId].recettes += total;
            
            return enregistrerEcriture({
                joueurId: proprietaireId, libelle: `Recette ${c?.name || actId}`,
                compteDebit: 500, compteCredit: 700, montantEuro, montantEspoyr, activiteId: actId
            });
        }
        
        // Travail coop√©ratif (D:501 C:706 pour les deux)
        async function comptaTravailCoop(travailleurId, proprietaireId, actId, gainHash) {
            initCaisseJoueur(travailleurId);
            initCaisseJoueur(proprietaireId);
            
            // Travailleur gagne #
            COMPTABILITE.caisseJoueurs[travailleurId].espoyr += gainHash;
            COMPTABILITE.potAAA.solde -= gainHash;
            COMPTABILITE.potAAA.circulationHash += gainHash;
            
            enregistrerEcriture({
                joueurId: travailleurId, libelle: `Travail coop (gain)`,
                compteDebit: 501, compteCredit: 706, montantEspoyr: gainHash, activiteId: actId
            });
            
            // Propri√©taire gagne aussi #
            COMPTABILITE.caisseJoueurs[proprietaireId].espoyr += gainHash;
            COMPTABILITE.potAAA.solde -= gainHash;
            COMPTABILITE.potAAA.circulationHash += gainHash;
            
            return enregistrerEcriture({
                joueurId: proprietaireId, libelle: `Travail coop (bonus)`,
                compteDebit: 501, compteCredit: 706, montantEspoyr: gainHash, activiteId: actId
            });
        }
        
        // Emprunt bancaire (D:512 C:164)
        async function comptaEmprunt(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            COMPTABILITE.caisseJoueurs[joueurId].euro += montant;
            COMPTABILITE.caisseJoueurs[joueurId].emprunt += montant;
            COMPTABILITE.banque.creancesJoueurs += montant;
            COMPTABILITE.banque.masseMonetaire += montant; // Cr√©ation mon√©taire
            
            return enregistrerEcriture({
                joueurId, libelle: `Emprunt bancaire ${montant}‚Ç¨`,
                compteDebit: 512, compteCredit: 164, montantEuro: montant
            });
        }
        
        // Int√©r√™ts (D:661 C:512)
        async function comptaInterets(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            COMPTABILITE.caisseJoueurs[joueurId].interetsDus += montant;
            COMPTABILITE.banque.interetsRecus += montant;
            
            return enregistrerEcriture({
                joueurId, libelle: `Int√©r√™ts bancaires ${montant}‚Ç¨`,
                compteDebit: 661, compteCredit: 512, montantEuro: montant
            });
        }
        
        // Remboursement emprunt (D:164 C:500)
        async function comptaRemboursement(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            COMPTABILITE.caisseJoueurs[joueurId].euro -= montant;
            COMPTABILITE.caisseJoueurs[joueurId].emprunt -= montant;
            COMPTABILITE.banque.creancesJoueurs -= montant;
            COMPTABILITE.banque.masseMonetaire -= montant; // Destruction mon√©taire
            
            return enregistrerEcriture({
                joueurId, libelle: `Remboursement ${montant}‚Ç¨`,
                compteDebit: 164, compteCredit: 500, montantEuro: montant
            });
        }
        
        // Emprunt AAA en # (D:501 C:580 - sans int√©r√™ts)
        async function comptaEmpruntAAA(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            if (COMPTABILITE.potAAA.solde < montant) {
                console.warn('Pot AAA insuffisant');
                return null;
            }
            
            COMPTABILITE.caisseJoueurs[joueurId].espoyr += montant;
            COMPTABILITE.potAAA.solde -= montant;
            COMPTABILITE.potAAA.circulationHash += montant;
            
            // Enregistrer la cr√©ance AAA
            if (!COMPTABILITE.potAAA.creances) COMPTABILITE.potAAA.creances = {};
            COMPTABILITE.potAAA.creances[joueurId] = (COMPTABILITE.potAAA.creances[joueurId] || 0) + montant;
            
            return enregistrerEcriture({
                joueurId, libelle: `Emprunt AAA ${montant}#`,
                compteDebit: 501, compteCredit: 580, montantEspoyr: montant,
                contexte: 'potAAA'
            });
        }
        
        // Remboursement AAA en # (D:580 C:501)
        async function comptaRemboursementAAA(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            const detteAAA = COMPTABILITE.potAAA.creances?.[joueurId] || 0;
            const montantReel = Math.min(montant, detteAAA, COMPTABILITE.caisseJoueurs[joueurId].espoyr || 0);
            
            if (montantReel <= 0) return null;
            
            COMPTABILITE.caisseJoueurs[joueurId].espoyr -= montantReel;
            COMPTABILITE.potAAA.solde += montantReel;
            COMPTABILITE.potAAA.circulationHash -= montantReel;
            COMPTABILITE.potAAA.creances[joueurId] -= montantReel;
            
            return enregistrerEcriture({
                joueurId, libelle: `Remboursement AAA ${montantReel}#`,
                compteDebit: 580, compteCredit: 501, montantEspoyr: montantReel,
                contexte: 'potAAA'
            });
        }
        
        // Taxe (D:635 C:500)
        async function comptaTaxe(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            COMPTABILITE.caisseJoueurs[joueurId].euro -= montant;
            COMPTABILITE.etat.tresor += montant;
            COMPTABILITE.etat.taxesRecues += montant;
            
            return enregistrerEcriture({
                joueurId, libelle: `Taxe 10%`,
                compteDebit: 635, compteCredit: 500, montantEuro: montant
            });
        }
        
        // Frais divers (D:613 C:500)
        async function comptaFrais(joueurId, montant, libelle) {
            initCaisseJoueur(joueurId);
            
            COMPTABILITE.caisseJoueurs[joueurId].euro -= montant;
            
            return enregistrerEcriture({
                joueurId, libelle: libelle || `Frais ${montant}‚Ç¨`,
                compteDebit: 613, compteCredit: 500, montantEuro: montant
            });
        }
        
        // Chance/Malchance (D:500 C:771 ou D:671 C:500)
        async function comptaChance(joueurId, montant, isChance) {
            initCaisseJoueur(joueurId);
            
            if (isChance) {
                COMPTABILITE.caisseJoueurs[joueurId].euro += montant;
                COMPTABILITE.banque.masseMonetaire += montant;
                return enregistrerEcriture({
                    joueurId, libelle: `Chance +${montant}‚Ç¨`,
                    compteDebit: 500, compteCredit: 771, montantEuro: montant
                });
            } else {
                COMPTABILITE.caisseJoueurs[joueurId].euro -= montant;
                return enregistrerEcriture({
                    joueurId, libelle: `Malchance -${montant}‚Ç¨`,
                    compteDebit: 671, compteCredit: 500, montantEuro: montant
                });
            }
        }
        
        // Cotisation AAA (D:580 C:501)
        async function comptaCotisationAAA(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            COMPTABILITE.caisseJoueurs[joueurId].espoyr -= montant;
            COMPTABILITE.potAAA.solde += montant;
            COMPTABILITE.potAAA.circulationHash -= montant;
            
            return enregistrerEcriture({
                joueurId, libelle: `Cotisation AAA ${montant}#`,
                compteDebit: 580, compteCredit: 501, montantEspoyr: montant
            });
        }
        
        // Cr√©dit AAA (D:501 C:580 + cr√©ance)
        async function comptaCreditAAA(joueurId, montant) {
            initCaisseJoueur(joueurId);
            
            COMPTABILITE.caisseJoueurs[joueurId].espoyr += montant;
            COMPTABILITE.potAAA.solde -= montant;
            COMPTABILITE.potAAA.circulationHash += montant;
            
            // Cr√©ance
            if (!COMPTABILITE.potAAA.creances[joueurId]) COMPTABILITE.potAAA.creances[joueurId] = 0;
            COMPTABILITE.potAAA.creances[joueurId] += montant;
            
            return enregistrerEcriture({
                joueurId, libelle: `Cr√©dit AAA ${montant}#`,
                compteDebit: 501, compteCredit: 580, montantEspoyr: montant
            });
        }
        
        // ========== SYNCHRONISATION FIREBASE ==========
        
        async function syncComptabiliteToFirebase() {
            if (!gameRef) return;
            await gameRef.child('comptabilite').set(COMPTABILITE);
        }
        
        async function loadComptabiliteFromFirebase() {
            if (!gameRef) return;
            const snap = await gameRef.child('comptabilite').once('value');
            if (snap.exists()) {
                COMPTABILITE = snap.val();
                normalizeComptabilite();
            }
        }
        
        // ========== UI HELPERS ==========
        
        function showScreen(screenId) {
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }
        
        function showError(msg) {
            const el = document.getElementById('errorMessage');
            el.textContent = msg; el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }
        
        function showModal(content, buttons = '') {
            document.getElementById('modalContainer').innerHTML = `
                <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                    <div class="modal">
                        ${content}
                        ${buttons ? `<div class="modal-buttons">${buttons}</div>` : ''}
                    </div>
                </div>`;
        }
        
        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }
        
        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            return Array.from({length: 6}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
        }
        
        // Avatar selection
        document.querySelectorAll('.avatar-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.avatar-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                myAvatar = btn.dataset.avatar;
            });
        });
        
        // ========== CR√âER PARTIE ==========
        async function createGame() {
            myName = document.getElementById('playerName').value.trim();
            if (!myName) { showError('Entre ton nom !'); return; }
            
            // Demander le profil √©conomique
            showProfilChoiceModal(async (profil) => {
                const code = generateCode();
                currentGameCode = code;
                isHost = true;
                myPlayerId = 'p_' + Date.now();
                myProfil = profil;
                
                // Initialiser GAME_SAVE pour audit + replay
                GAME_SAVE = {
                    schemaVersion: SCHEMA_VERSION,
                    gameId: `ESPOYR_${code}`,
                    createdAt: new Date().toISOString(),
                    lastSavedAt: null,
                    rng: {
                        mode: "seeded",
                        seed: generateSeed(),
                        consumed: 0,
                        rolls: []
                    },
                    state: null,
                    events: [],
                    eventCounter: 0,
                    ledger: [],
                    ledgerCounter: 0,
                    snapshots: [],
                    indexes: { byTurn: {}, byPlayer: {}, byEntity: {}, byAction: {} }
                };
                
                // Initialiser comptabilit√© avec exportation
                COMPTABILITE = {
                    journal: [], numeroEcriture: 0, grandLivre: {},
                    caisseJoueurs: {}, caisseActivites: {}, parJoueur: {},
                    banque: { creancesJoueurs: 0, masseMonetaire: 0, interetsRecus: 0, capital: 0, reductionValeur: 0, journal: [] },
                    potAAA: { solde: CONFIG.potAAAInitial, circulationHash: 0, membres: [], creances: {}, journal: [] },
                    etat: { tresor: 0, taxesRecues: 0, salairesVerses: 0, journal: [] },
                    exportation: { solde: 0, recettes: 0, salairesVerses: 0, journal: [] }
                };
                
                await db.ref(`parties/${code}`).set({
                    code, hostId: myPlayerId, status: 'waiting',
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    config: CONFIG,
                    state: { turn: 1, phase: 1, currentPlayerIndex: 0, started: false, toursComplets: 0 },
                    activites: {}, equipements: {},
                    comptabilite: COMPTABILITE
                });
                
                await db.ref(`parties/${code}/players/${myPlayerId}`).set({
                    id: myPlayerId, name: myName, avatar: myAvatar,
                    position: 0, euro: CONFIG.capitalInitial, espoyr: 0, emprunt: 0,
                    isHost: true, isBot: false, membreAAA: false,
                    profil: profil,  // NOUVEAU : profil √©conomique
                    passagesDepart: 0, passagesDepuisPhase2: 0,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // √âcriture capital initial
                const capitalEcriture = await comptaCapitalInitial(myPlayerId, CONFIG.capitalInitial);
                await syncComptabiliteToFirebase();
                
                // LOG EVENT: GAME_CREATE
                logEvent('GAME_CREATE', myPlayerId, {
                    gameCode: code,
                    playerName: myName,
                    profil,
                    config: CONFIG,
                    rngSeed: GAME_SAVE.rng.seed
                }, capitalEcriture?.ledgerEntryId ? [capitalEcriture.ledgerEntryId] : []);
                
                // Cr√©er snapshot initial
                createSnapshot();
                
                subscribeToGame(code);
                showScreen('lobbyScreen');
                document.getElementById('lobbyCode').textContent = code;
                document.getElementById('hostControls').classList.remove('hidden');
                document.getElementById('waitingMessage').classList.add('hidden');
                
                sendSystemMessage(`${myName} (${profil === 'creatif' ? 'üé® Cr√©atif' : 'üèõÔ∏è Contributif'}) a cr√©√© la partie !`);
            });
        }
        
        // Variable pour stocker le profil du joueur
        let myProfil = 'contributif';
        
        // Modal de choix du profil √©conomique
        function showProfilChoiceModal(callback) {
            showModal(`
                <h3>Quel est ton profil √©conomique ?</h3>
                <p style="font-size: 0.9rem; color: var(--gray); margin-bottom: 15px;">
                    Ce choix d√©termine qui paie ton salaire et comment tu es r√©mun√©r√©.
                </p>
                
                <div style="background: #dbeafe; padding: 12px; border-radius: 8px; margin-bottom: 12px; cursor: pointer; border: 2px solid transparent;" 
                     onclick="this.style.borderColor='#2563eb'" id="profilContributif">
                    <p style="margin: 0; font-weight: bold;">üèõÔ∏è CONTRIBUTIF</p>
                    <p style="margin: 4px 0 0 0; font-size: 0.85rem;">Salaire fixe de 350‚Ç¨ pay√© par l'√âtat</p>
                    <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6b7280;">Stable et s√©curis√©</p>
                </div>
                
                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;" 
                     onclick="this.style.borderColor='#f59e0b'" id="profilCreatif">
                    <p style="margin: 0; font-weight: bold;">üé® CR√âATIF</p>
                    <p style="margin: 4px 0 0 0; font-size: 0.85rem;">Salaire variable (45%-150%) pay√© par l'Exportation</p>
                    <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6b7280;">Risqu√© mais potentiellement plus rentable</p>
                </div>
            `, `
                <button class="btn" style="background: #dbeafe; color: #2563eb;" onclick="selectProfil('contributif')">üèõÔ∏è Contributif</button>
                <button class="btn" style="background: #fef3c7; color: #92400e;" onclick="selectProfil('creatif')">üé® Cr√©atif</button>
            `);
            
            // Stocker le callback
            window.profilCallback = callback;
        }
        
        function selectProfil(profil) {
            closeModal();
            if (window.profilCallback) {
                window.profilCallback(profil);
                window.profilCallback = null;
            }
        }
        
        // ========== REJOINDRE PARTIE ==========
        async function joinGame() {
            myName = document.getElementById('playerName').value.trim();
            if (!myName) { showError('Entre ton nom !'); return; }
            
            const code = document.getElementById('gameCode').value.trim().toUpperCase();
            if (!code || code.length !== 6) { showError('Code invalide !'); return; }
            
            const gameSnap = await db.ref(`parties/${code}`).once('value');
            if (!gameSnap.exists()) { showError('Partie introuvable !'); return; }
            
            const gameData = gameSnap.val();
            const playersSnap = await db.ref(`parties/${code}/players`).once('value');
            const existingPlayers = playersSnap.val() || {};
            
            // Reconnexion ?
            const existingPlayer = Object.values(existingPlayers).find(p => p.name === myName);
            if (existingPlayer) {
                currentGameCode = code;
                myPlayerId = existingPlayer.id;
                myAvatar = existingPlayer.avatar;
                isHost = existingPlayer.isHost;
                myProfil = existingPlayer.profil || 'contributif';
                
                await loadComptabiliteFromFirebase();
                subscribeToGame(code);
                
                if (gameData.status === 'playing') {
                    showScreen('gameScreen');
                    sendSystemMessage(`üîÑ ${myName} reconnect√© !`);
                } else {
                    showScreen('lobbyScreen');
                    document.getElementById('lobbyCode').textContent = code;
                    document.getElementById('hostControls').classList.toggle('hidden', !isHost);
                    document.getElementById('waitingMessage').classList.toggle('hidden', isHost);
                }
                return;
            }
            
            if (gameData.status !== 'waiting') { showError('Partie d√©j√† commenc√©e !'); return; }
            if (playersSnap.numChildren() >= 4) { showError('Partie compl√®te !'); return; }
            
            // Demander le profil avant de rejoindre
            showProfilChoiceModal(async (profil) => {
                currentGameCode = code;
                isHost = false;
                myPlayerId = 'p_' + Date.now();
                myProfil = profil;
                
                await db.ref(`parties/${code}/players/${myPlayerId}`).set({
                    id: myPlayerId, name: myName, avatar: myAvatar,
                    position: 0, euro: CONFIG.capitalInitial, espoyr: 0, emprunt: 0,
                    isHost: false, isBot: false, membreAAA: false,
                    profil: profil,  // NOUVEAU : profil √©conomique
                    passagesDepart: 0, passagesDepuisPhase2: 0,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Charger et mettre √† jour comptabilit√©
                await loadComptabiliteFromFirebase();
                await comptaCapitalInitial(myPlayerId, CONFIG.capitalInitial);
                await syncComptabiliteToFirebase();
                
                subscribeToGame(code);
                showScreen('lobbyScreen');
                document.getElementById('lobbyCode').textContent = code;
                document.getElementById('hostControls').classList.add('hidden');
                document.getElementById('waitingMessage').classList.remove('hidden');
                
                sendSystemMessage(`${myName} (${profil === 'creatif' ? 'üé® Cr√©atif' : 'üèõÔ∏è Contributif'}) a rejoint !`);
            });
        }
        
        // ========== ABONNEMENT FIREBASE ==========
        function subscribeToGame(code) {
            gameRef = db.ref(`parties/${code}`);
            
            // √âtat
            gameRef.child('state').on('value', (snap) => {
                gameState = snap.val();
                
                // Mettre √† jour le sens de d√©placement
                if (gameState?.sensDeplacent) {
                    sensDeplacementGlobal = gameState.sensDeplacent;
                }
                
                if (gameState?.started && document.getElementById('gameScreen').classList.contains('hidden')) {
                    loadComptabiliteFromFirebase();
                    showScreen('gameScreen');
                }
                updateGameUI();
            });
            
            // Joueurs
            gameRef.child('players').on('value', (snap) => {
                playersData = snap.val() || {};
                updatePlayersUI();
                if (Object.keys(playersData).length > 0) updateBoard();
                
                const count = Object.keys(playersData).length;
                const countEl = document.getElementById('playerCount');
                if (countEl) countEl.textContent = count;
                
                const startBtn = document.getElementById('startGameBtn');
                if (startBtn) startBtn.disabled = count < 2;
            });
            
            // Chat
            gameRef.child('chat').orderByChild('timestamp').limitToLast(50).on('child_added', (snap) => {
                const msg = snap.val();
                addChatMessage(msg);
            });
            
            // Comptabilit√© (sync)
            gameRef.child('comptabilite').on('value', (snap) => {
                if (snap.exists()) {
                    COMPTABILITE = snap.val();
                    normalizeComptabilite();
                }
            });
            
            // Ench√®res
            gameRef.child('enchere').on('value', (snap) => {
                if (snap.exists()) {
                    enchereEnCours = snap.val();
                    // Afficher le modal d'ench√®res si pas d√©j√† affich√©
                    if (enchereEnCours && !enchereEnCours.termine) {
                        // Ne pas afficher automatiquement pour ne pas interrompre
                        // Le vendeur et les acheteurs verront via les boutons
                    }
                } else {
                    enchereEnCours = null;
                }
            });
            
            // Configuration (sync)
            gameRef.child('config').on('value', (snap) => {
                if (snap.exists()) {
                    const savedConfig = snap.val();
                    gameConfig = { ...CONFIG, ...savedConfig };
                    console.log('Config charg√©e:', gameConfig);
                }
            });
            
            // Connexion
            db.ref('.info/connected').on('value', (snap) => {
                const el = document.getElementById('connectionStatus');
                if (snap.val()) {
                    el.textContent = 'üü¢ Connect√©';
                    el.className = 'connection-status connected';
                } else {
                    el.textContent = 'üî¥ D√©connect√©';
                    el.className = 'connection-status disconnected';
                }
            });
        }
        
        // ========== CHAT ==========
        function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            
            gameRef.child('chat').push({
                sender: myName, avatar: myAvatar, message: msg,
                timestamp: firebase.database.ServerValue.TIMESTAMP, isSystem: false
            });
            input.value = '';
        }
        
        function sendSystemMessage(msg) {
            if (!gameRef) return;
            gameRef.child('chat').push({
                sender: 'Syst√®me', avatar: 'üì¢', message: msg,
                timestamp: firebase.database.ServerValue.TIMESTAMP, isSystem: true
            });
        }
        
        function addChatMessage(msg) {
            const chatBox = document.getElementById('chatBox');
            if (!chatBox) return;
            
            const div = document.createElement('div');
            div.className = `chat-message ${msg.isSystem ? 'system' : ''}`;
            div.innerHTML = msg.isSystem 
                ? msg.message 
                : `<span class="sender">${msg.avatar} ${msg.sender}:</span> ${msg.message}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        
        // ========== UI JOUEURS ==========
        function updatePlayersUI() {
            const playerArray = Object.values(playersData).sort((a, b) => (a.joinedAt || 0) - (b.joinedAt || 0));
            
            // Lobby
            const lobbyEl = document.getElementById('lobbyPlayers');
            if (lobbyEl) {
                lobbyEl.innerHTML = playerArray.map(p => `
                    <div class="player-item ${p.id === myPlayerId ? 'me' : ''}">
                        <span class="player-avatar">${p.avatar}</span>
                        <div class="player-info">
                            <div class="player-name">${p.name} ${p.isBot ? 'ü§ñ' : ''}</div>
                            <div class="player-stats">${p.isHost ? 'üëë H√¥te' : 'Joueur'}</div>
                        </div>
                        ${p.isHost ? '<span class="player-badge badge-host">HOST</span>' : ''}
                    </div>
                `).join('');
            }
            
            // Game
            const gameEl = document.getElementById('gamePlayers');
            if (gameEl && gameState) {
                const currentIdx = gameState.currentPlayerIndex || 0;
                gameEl.innerHTML = playerArray.map((p, idx) => {
                    const caisse = (COMPTABILITE && COMPTABILITE.caisseJoueurs && COMPTABILITE.caisseJoueurs[p.id]) || {};
                    return `
                    <div class="player-item ${p.id === myPlayerId ? 'me' : ''} ${idx === currentIdx ? 'current-turn' : ''}">
                        <span style="width: 12px; height: 12px; border-radius: 50%; background: ${PLAYER_COLORS[idx]}; flex-shrink: 0;"></span>
                        <span class="player-avatar">${p.avatar}</span>
                        <div class="player-info">
                            <div class="player-name">${p.name} ${p.membreAAA ? 'üíö' : ''} ${p.isBot ? 'ü§ñ' : ''}</div>
                            <div class="player-stats">
                                üí∞${caisse.euro || p.euro || 0}‚Ç¨ 
                                üíö${caisse.espoyr || p.espoyr || 0}# 
                                ${(caisse.emprunt || p.emprunt || 0) > 0 ? `<span style="color:#ef4444">üìã${caisse.emprunt || p.emprunt}‚Ç¨</span>` : ''}
                            </div>
                        </div>
                        ${idx === currentIdx ? '<span class="player-badge badge-ready">üéØ</span>' : ''}
                    </div>
                `}).join('');
            }
        }
        
        // ========== LANCEMENT PARTIE ==========
        async function startGame() {
            if (!isHost) return;
            
            // Demander le sens de d√©placement
            showModal(`
                <h3>üéØ Choisir le sens de d√©placement</h3>
                <p style="font-size: 0.9rem; color: var(--gray); margin-bottom: 15px;">
                    Dans quel sens les joueurs se d√©placeront-ils sur le plateau ?
                </p>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <div onclick="confirmStartGame(1)" style="cursor: pointer; background: #dcfce7; padding: 20px; border-radius: 12px; text-align: center; flex: 1; border: 2px solid transparent; transition: all 0.2s;" onmouseover="this.style.borderColor='#059669'" onmouseout="this.style.borderColor='transparent'">
                        <p style="font-size: 2rem; margin: 0;">‚û°Ô∏è</p>
                        <p style="margin: 10px 0 0 0; font-weight: bold; color: #059669;">Sens horaire</p>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6b7280;">1 ‚Üí 2 ‚Üí 3 ‚Üí ...</p>
                    </div>
                    
                    <div onclick="confirmStartGame(-1)" style="cursor: pointer; background: #dbeafe; padding: 20px; border-radius: 12px; text-align: center; flex: 1; border: 2px solid transparent; transition: all 0.2s;" onmouseover="this.style.borderColor='#2563eb'" onmouseout="this.style.borderColor='transparent'">
                        <p style="font-size: 2rem; margin: 0;">‚¨ÖÔ∏è</p>
                        <p style="margin: 10px 0 0 0; font-weight: bold; color: #2563eb;">Sens anti-horaire</p>
                        <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6b7280;">... ‚Üí 3 ‚Üí 2 ‚Üí 1</p>
                    </div>
                </div>
            `, ``);
        }
        
        // Variable pour le sens de d√©placement
        let sensDeplacementGlobal = 1;  // 1 = horaire, -1 = anti-horaire
        
        async function confirmStartGame(sens) {
            closeModal();
            sensDeplacementGlobal = sens;
            
            // Sauvegarder le sens dans Firebase
            await gameRef.child('state/sensDeplacent').set(sens);
            await gameRef.child('state/started').set(true);
            await gameRef.child('status').set('playing');
            
            const sensText = sens === 1 ? '‚û°Ô∏è Sens horaire (1‚Üí2‚Üí3)' : '‚¨ÖÔ∏è Sens anti-horaire (3‚Üí2‚Üí1)';
            sendSystemMessage(`üöÄ La partie commence ! ${sensText}`);
            
            // LOG EVENT: GAME_START
            logEvent('GAME_START', myPlayerId, {
                sensDeplacent: sens,
                nbJoueurs: Object.keys(playersData).length
            });
        }
        
        function leaveGame() {
            if (gameRef && myPlayerId) {
                gameRef.child(`players/${myPlayerId}`).remove();
            }
            showScreen('homeScreen');
        }
        
        // ========== ROBOTS IA ==========
        function showAddBotModal() {
            if (Object.keys(playersData).length >= 4) { alert('Partie compl√®te !'); return; }
            
            const profilsList = Object.values(PROFILS_IA).map(p => 
                `<button class="btn" style="margin: 3px; font-size: 0.8rem;" onclick="addBot('${p.id}')">${p.nom}</button>`
            ).join('');
            
            showModal(`<h3>ü§ñ Ajouter Robot</h3><div style="display:flex;flex-wrap:wrap;">${profilsList}</div>`,
                `<button class="btn btn-secondary" onclick="closeModal()">Annuler</button>`);
        }
        
        // ========== CONFIGURATION PARTIE ==========
        function showConfigModal() {
            showModal(`
                <h3>‚öôÔ∏è Configuration de la partie</h3>
                <p style="font-size: 0.85rem; color: var(--gray); margin-bottom: 15px;">
                    Ces param√®tres s'appliquent √† tous les joueurs.
                </p>
                
                <div style="display: grid; gap: 12px;">
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">‚è±Ô∏è Temps de d√©cision (secondes)</label>
                        <input type="number" id="configTimingDecision" value="${gameConfig.timingDecision}" min="10" max="120" step="5" style="width: 100%; padding: 8px; margin-top: 4px;">
                        <p style="font-size: 0.75rem; color: #6b7280;">Temps pour acheter/passer sur une case</p>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">üî® Temps par ench√®re (secondes)</label>
                        <input type="number" id="configTimingEnchere" value="${gameConfig.timingEnchere}" min="30" max="180" step="10" style="width: 100%; padding: 8px; margin-top: 4px;">
                        <p style="font-size: 0.75rem; color: #6b7280;">Temps pour ench√©rir lors d'une vente</p>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">ü§ù Temps de n√©gociation (secondes)</label>
                        <input type="number" id="configTimingNego" value="${gameConfig.timingNegociation}" min="20" max="120" step="5" style="width: 100%; padding: 8px; margin-top: 4px;">
                        <p style="font-size: 0.75rem; color: #6b7280;">Temps pour n√©gocier un paiement</p>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">ü§ñ D√©lai robot (secondes)</label>
                        <input type="number" id="configTimingBot" value="${gameConfig.timingBot}" min="1" max="10" step="0.5" style="width: 100%; padding: 8px; margin-top: 4px;">
                        <p style="font-size: 0.75rem; color: #6b7280;">Pause avant action des robots</p>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">üí∞ Capital initial (‚Ç¨)</label>
                        <input type="number" id="configCapital" value="${gameConfig.capitalInitial}" min="100" max="1000" step="50" style="width: 100%; padding: 8px; margin-top: 4px;">
                    </div>
                    
                    <div>
                        <label style="font-size: 0.85rem; font-weight: bold;">üìà Taux d'int√©r√™t (%)</label>
                        <input type="number" id="configInteret" value="${gameConfig.tauxInteret * 100}" min="0" max="50" step="5" style="width: 100%; padding: 8px; margin-top: 4px;">
                    </div>
                </div>
            `, `
                <button class="btn btn-primary" onclick="saveConfig()">üíæ Sauvegarder</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            `);
        }
        
        async function saveConfig() {
            gameConfig.timingDecision = parseInt(document.getElementById('configTimingDecision').value) || 30;
            gameConfig.timingEnchere = parseInt(document.getElementById('configTimingEnchere').value) || 60;
            gameConfig.timingNegociation = parseInt(document.getElementById('configTimingNego').value) || 45;
            gameConfig.timingBot = parseFloat(document.getElementById('configTimingBot').value) || 2;
            gameConfig.capitalInitial = parseInt(document.getElementById('configCapital').value) || 450;
            gameConfig.tauxInteret = (parseInt(document.getElementById('configInteret').value) || 10) / 100;
            
            // Sauvegarder dans Firebase
            await db.ref(`parties/${currentGameCode}/config`).set(gameConfig);
            
            closeModal();
            sendSystemMessage(`‚öôÔ∏è Configuration mise √† jour par ${myName}`);
        }
        
        // Variable pour le timer de d√©cision
        let decisionTimer = null;
        let decisionTimeLeft = 0;
        
        // D√©marrer un timer de d√©cision
        function startDecisionTimer(seconds, onTimeout) {
            stopDecisionTimer();
            decisionTimeLeft = seconds;
            
            // Afficher le timer dans le modal
            updateTimerDisplay();
            
            decisionTimer = setInterval(() => {
                decisionTimeLeft--;
                updateTimerDisplay();
                
                if (decisionTimeLeft <= 0) {
                    stopDecisionTimer();
                    if (onTimeout) onTimeout();
                }
            }, 1000);
        }
        
        function stopDecisionTimer() {
            if (decisionTimer) {
                clearInterval(decisionTimer);
                decisionTimer = null;
            }
        }
        
        function updateTimerDisplay() {
            const timerEl = document.getElementById('modalTimer');
            if (timerEl) {
                const color = decisionTimeLeft <= 10 ? '#dc2626' : decisionTimeLeft <= 20 ? '#f59e0b' : '#10b981';
                timerEl.innerHTML = `<span style="color: ${color}; font-weight: bold;">‚è±Ô∏è ${decisionTimeLeft}s</span>`;
            }
        }
        
        async function addBot(profilId) {
            closeModal();
            const profil = PROFILS_IA[profilId];
            const botId = 'bot_' + Date.now();
            const botNames = ['Robot-A', 'Robot-B', 'Robot-C', 'Robot-D'];
            const botName = botNames[Object.keys(playersData).length - 1] || 'Robot';
            
            // Choisir un profil √©conomique al√©atoire pour le robot
            const botEcoProfil = Math.random() > 0.5 ? 'creatif' : 'contributif';
            
            await db.ref(`parties/${currentGameCode}/players/${botId}`).set({
                id: botId, name: botName, avatar: 'ü§ñ',
                position: 0, euro: CONFIG.capitalInitial, espoyr: 0, emprunt: 0,
                isHost: false, isBot: true, botProfil: profilId,
                profil: botEcoProfil,  // Profil √©conomique du robot
                membreAAA: profil.membreAAA || false,
                passagesDepart: 0, passagesDepuisPhase2: 0,
                joinedAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Si le profil est membre AAA, l'ajouter √† la liste comptable
            if (profil.membreAAA) {
                COMPTABILITE.potAAA.membres = COMPTABILITE.potAAA.membres || [];
                if (!COMPTABILITE.potAAA.membres.includes(botId)) {
                    COMPTABILITE.potAAA.membres.push(botId);
                }
            }
            
            await comptaCapitalInitial(botId, CONFIG.capitalInitial);
            await syncComptabiliteToFirebase();
            
            const profilIcon = botEcoProfil === 'creatif' ? 'üé®' : 'üèõÔ∏è';
            sendSystemMessage(`ü§ñ ${botName} (${profil.nom} ${profilIcon}) a rejoint !${profil.membreAAA ? ' üíö Membre AAA' : ''}`);
        }
        
        // ========== UI JEU ==========
        function updateGameUI() {
            if (!gameState) return;
            
            document.getElementById('turnNumber').textContent = gameState.turn || 1;
            
            const phase = gameState.phase || 1;
            const phaseEl = document.getElementById('phaseNumber');
            phaseEl.textContent = phase;
            phaseEl.style.color = { 1: '#10b981', 2: '#f59e0b', 3: '#ef4444' }[phase];
            
            // Indicateur du sens de d√©placement
            const sensEl = document.getElementById('sensIndicator');
            if (sensEl) {
                const sens = gameState?.sensDeplacent || sensDeplacementGlobal || 1;
                sensEl.textContent = sens === 1 ? '‚û°Ô∏è' : '‚¨ÖÔ∏è';
                sensEl.title = sens === 1 ? 'Sens horaire (1‚Üí2‚Üí3)' : 'Sens anti-horaire (3‚Üí2‚Üí1)';
            }
            
            // Afficher/masquer le bouton Config pour l'host
            const configBtn = document.getElementById('configBtn');
            if (configBtn) {
                configBtn.style.display = isHost ? 'block' : 'none';
            }
            
            const players = Object.values(playersData);
            const currentIdx = gameState.currentPlayerIndex || 0;
            const currentPlayer = players[currentIdx];
            
            if (currentPlayer) {
                const isMyTurn = currentPlayer.id === myPlayerId;
                const isBot = currentPlayer.isBot;
                
                document.getElementById('turnIndicator').textContent = 
                    isMyTurn ? 'üéØ TON TOUR !' : `‚è≥ ${currentPlayer.name}${isBot ? ' ü§ñ' : ''}`;
                
                const diceBtn = document.getElementById('rollDiceBtn');
                diceBtn.disabled = !isMyTurn;
                diceBtn.style.opacity = isMyTurn ? '1' : '0.5';
                
                document.getElementById('diceMessage').textContent = 
                    isMyTurn ? 'Lance le d√© !' : `${currentPlayer.name} joue...`;
                
                // Robot joue avec le timing configurable
                if (isBot && isHost) {
                    const delaiBot = (gameConfig.timingBot || 2) * 1000;
                    setTimeout(() => playBotTurn(currentPlayer), delaiBot);
                }
            }
            
            updateBoard();
        }
        
        // ========== PLATEAU ==========
        async function updateBoard() {
            const boardEl = document.getElementById('gameBoard');
            if (!boardEl) return;
            
            const players = Object.values(playersData);
            const activitesSnap = await gameRef.child('activites').once('value');
            const activites = activitesSnap.val() || {};
            const equipSnap = await gameRef.child('equipements').once('value');
            const equipements = equipSnap.val() || {};
            
            // Identifier la position du joueur actuel
            const currentIdx = gameState?.currentPlayerIndex || 0;
            const currentPlayer = players[currentIdx];
            const currentPos = Number.isFinite(currentPlayer?.position) ? currentPlayer.position : null;
            
            boardEl.innerHTML = CASES.map(c => {
                const playersHere = players.filter(p => p.position === c.id);
                const owner = activites[c.id];
                const ownerPlayer = owner ? players.find(p => p.id === owner) : null;
                const nbEquip = equipements[c.id] || 0;
                const isCurrent = (currentPos !== null && c.id === currentPos);
                
                let ownerStyle = '';
                if (ownerPlayer) {
                    const idx = players.findIndex(p => p.id === owner);
                    ownerStyle = `border-color: ${PLAYER_COLORS[idx]}`;
                }
                
                const equipIndicator = '‚öô'.repeat(nbEquip);
                
                return `
                    <div class="case ${c.type} ${owner ? 'owned' : ''} ${isCurrent ? 'current' : ''}" style="${ownerStyle}"
                         onclick="showCaseInfo(${c.id})" title="${c.name}">
                        <span class="case-number">${c.id}</span>
                        ${c.hash ? '<span class="case-hash">#</span>' : ''}
                        <span class="case-icon">${c.icon}</span>
                        <span class="case-name">${c.name}</span>
                        ${c.prix ? `<span class="case-price">${c.prix}‚Ç¨${equipIndicator}</span>` : ''}
                        ${ownerPlayer ? `<span class="owner-indicator">${ownerPlayer.avatar}</span>` : ''}
                        ${playersHere.length > 0 ? `
                            <div class="players-on-case">
                                ${playersHere.map(p => {
                                    const idx = players.findIndex(pl => pl.id === p.id);
                                    return `<div class="player-marker" style="background: ${PLAYER_COLORS[idx]}" title="${p.name}"></div>`;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // ========== LANCER D√â ==========
        async function rollDice() {
            const players = Object.values(playersData);
            const currentIdx = gameState.currentPlayerIndex || 0;
            const currentPlayer = players[currentIdx];
            
            if (!currentPlayer || currentPlayer.id !== myPlayerId) return;
            
            const diceEl = document.getElementById('dice');
            const diceBtn = document.getElementById('rollDiceBtn');
            diceBtn.disabled = true;
            diceEl.classList.add('rolling');
            
            const faces = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
            let rolls = 0;
            const rollInterval = setInterval(async () => {
                diceEl.textContent = faces[Math.floor(Math.random() * 6)];
                rolls++;
                if (rolls > 15) {
                    clearInterval(rollInterval);
                    
                    // Utiliser le RNG seed√© pour reproductibilit√©
                    const result = rollDiceValue();
                    diceEl.textContent = faces[result - 1];
                    diceEl.classList.remove('rolling');
                    
                    // Calculer la nouvelle position selon le sens
                    const sens = gameState?.sensDeplacent || sensDeplacementGlobal || 1;
                    let newPosition;
                    let passedStart = false;
                    
                    if (sens === 1) {
                        // Sens horaire : 0 ‚Üí 1 ‚Üí 2 ‚Üí ... ‚Üí 23 ‚Üí 0
                        newPosition = (currentPlayer.position + result) % CASES.length;
                        passedStart = (currentPlayer.position + result) >= CASES.length;
                    } else {
                        // Sens anti-horaire : 0 ‚Üí 23 ‚Üí 22 ‚Üí ... ‚Üí 1 ‚Üí 0
                        newPosition = (currentPlayer.position - result + CASES.length) % CASES.length;
                        // Passage par d√©part si on passe en dessous de 0 (position initiale)
                        passedStart = (currentPlayer.position - result) < 0;
                    }
                    
                    // LOG EVENT: ROLL_DICE
                    const ledgerIds = [];
                    
                    // *** BONUS AAA : Si membre, cr√©ation de 50# dans le Pot AAA ***
                    const isMembre = COMPTABILITE.potAAA.membres?.includes(myPlayerId);
                    if (isMembre) {
                        const ecriture = await comptaBonusAAALancer(myPlayerId);
                        if (ecriture?.ledgerEntryId) ledgerIds.push(ecriture.ledgerEntryId);
                        sendSystemMessage(`üíö +50# cr√©√©s dans le Pot AAA (bonus membre)`);
                    }
                    
                    logEvent('ROLL_DICE', myPlayerId, {
                        diceValue: result,
                        fromPosition: currentPlayer.position,
                        toPosition: newPosition,
                        passedStart,
                        sens,
                        bonusAAA: isMembre ? 50 : 0
                    }, ledgerIds);
                    
                    await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/position`).set(newPosition);
                    
                    const sensIcon = sens === 1 ? '‚û°Ô∏è' : '‚¨ÖÔ∏è';
                    sendSystemMessage(`üé≤ ${myName} fait ${result} ${sensIcon} ${CASES[newPosition].name}`);
                    
                    if (passedStart) {
                        await handleSalary(currentPlayer, result);
                    }
                    
                    setTimeout(() => handleLanding(newPosition), 800);
                }
            }, 80);
        }
        
        // Bonus AAA : 50# cr√©√©s dans le Pot √† chaque lancer d'un membre
        async function comptaBonusAAALancer(joueurId) {
            const bonusAAA = 50;
            
            // Cr√©ation mon√©taire : le Pot AAA augmente
            COMPTABILITE.potAAA.solde += bonusAAA;
            
            // √âcriture comptable
            enregistrerEcriture({
                joueurId, 
                libelle: `Bonus AAA lancer d√© (+${bonusAAA}#)`,
                compteDebit: 580,   // Caisse Pot AAA
                compteCredit: 135,  // Fonds Pot AAA (cr√©ation)
                montantEspoyr: bonusAAA,
                contexte: 'potAAA',
                details: { type: 'bonus_lancer_membre' }
            });
            
            await syncComptabiliteToFirebase();
            return bonusAAA;
        }
        
        // ========== SALAIRE ==========
        async function handleSalary(player, deSalaire) {
            const phase = gameState.phase || 1;
            const profil = player.profil || 'contributif';
            let salaire = CONFIG.salaireBase;
            
            // Pourcentage selon profil
            let pourcentage;
            if (profil === 'creatif') {
                pourcentage = SALARY_CREATIF[deSalaire] || 1;
            } else {
                pourcentage = SALARY_CONTRIBUTIF[deSalaire] || 1;  // Toujours 100%
            }
            salaire = Math.floor(salaire * pourcentage);
            
            // √ârosion phases 2 et 3
            if (phase >= 2) {
                const passagesP2 = (player.passagesDepuisPhase2 || 0) + 1;
                const facteurErosion = Math.pow(0.92, passagesP2);
                salaire = Math.floor(salaire * facteurErosion);
                
                await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/passagesDepuisPhase2`).set(passagesP2);
                
                if (phase === 3) {
                    salaire = Math.floor(salaire * 0.80);
                }
            }
            
            salaire = Math.max(100, salaire);
            
            // Comptabilit√©
            await comptaSalaire(myPlayerId, salaire, deSalaire);
            
            // Mise √† jour Firebase
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/euro`).set(caisse.euro);
            
            const passages = (player.passagesDepart || 0) + 1;
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/passagesDepart`).set(passages);
            
            await syncComptabiliteToFirebase();
            
            const profilIcon = profil === 'creatif' ? 'üé®' : 'üèõÔ∏è';
            const payeur = profil === 'creatif' ? 'Exportation' : '√âtat';
            sendSystemMessage(`üí∞ ${myName} ${profilIcon} re√ßoit ${salaire}‚Ç¨ (${payeur})`);
            
            // V√©rifier phase
            await checkPhaseTransition();
            
            showModal(`
                <h3>üí∞ Salaire ${profilIcon}</h3>
                <p>Tu passes la case D√©part :</p>
                <p style="font-size: 1.5rem; font-weight: bold; color: var(--green);">${salaire}‚Ç¨</p>
                <p style="color: var(--gray);">
                    ${profil === 'creatif' ? `D√© ${deSalaire} = ${Math.round(pourcentage * 100)}%` : 'Salaire fixe'}
                </p>
                <p style="font-size: 0.85rem; color: #6b7280;">Pay√© par : ${payeur}</p>
                ${phase >= 2 ? `<p style="color: var(--orange);">‚ö†Ô∏è Phase ${phase} : √©rosion</p>` : ''}
            `, `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
        }
        
        // ========== PHASES ==========
        async function checkPhaseTransition() {
            const players = Object.values(playersData);
            const phase = gameState.phase || 1;
            const toursComplets = gameState.toursComplets || 0;
            
            const activitesSnap = await gameRef.child('activites').once('value');
            const activites = activitesSnap.val() || {};
            const proprietaires = new Set(Object.values(activites));
            const tauxEmploi = Math.round((proprietaires.size / players.length) * 100);
            
            const detteTotale = Object.values(COMPTABILITE.caisseJoueurs).reduce((s, c) => s + (c.emprunt || 0), 0);
            
            if (phase === 1 && toursComplets >= 4) {
                await gameRef.child('state/phase').set(2);
                sendSystemMessage(`üìä PHASE 2 ! L'√©rosion commence...`);
            } else if (phase === 2 && (tauxEmploi < 50 || detteTotale > 1500 || toursComplets >= 8)) {
                await gameRef.child('state/phase').set(3);
                sendSystemMessage(`üåç PHASE 3 ! Effondrement...`);
            }
        }
        
        // ========== ARRIV√âE SUR CASE ==========
        async function handleLanding(position) {
            const c = CASES[position];
            // Utiliser la caisse comptable OU le solde Firebase comme fallback
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const player = playersData[myPlayerId] || {};
            const currentEuro = caisse.euro || player.euro || 0;
            const currentEspoyr = caisse.espoyr || player.espoyr || 0;
            
            if (c.type === 'activite') {
                const activitesSnap = await gameRef.child('activites').once('value');
                const activites = activitesSnap.val() || {};
                const owner = activites[position];
                
                if (!owner) {
                    showBuyModal(c, currentEuro);
                } else if (owner !== myPlayerId) {
                    showPayOrNegotiateModal(c, owner, currentEuro);
                } else {
                    // Ma propri√©t√© - √©quipement ?
                    const equipSnap = await gameRef.child(`equipements/${position}`).once('value');
                    const nbEquip = equipSnap.val() || 0;
                    
                    if (nbEquip < 2 && currentEuro >= c.prixEquip) {
                        showEquipModal(c, nbEquip, currentEuro);
                    } else {
                        sendSystemMessage(`${myName} est sur son ${c.icon}`);
                        nextTurn();
                    }
                }
            } else if (c.type === 'chance') {
                await handleChance();
            } else if (c.type === 'malchance') {
                await handleMalchance();
            } else if (c.type === 'frais') {
                await handleFrais(c);
            } else if (c.type === 'taxe') {
                await handleTaxe();
            } else if (c.type === 'ligne2') {
                await handleLigne2(c);
            } else {
                nextTurn();
            }
        }
        
        // ========== ACHAT ACTIVIT√â ==========
        function showBuyModal(c, currentEuro) {
            const canBuy = currentEuro >= c.prix;
            const bonusHash = Math.floor(c.prix * 0.1);
            const profil = playersData[myPlayerId]?.profil || 'contributif';
            
            // R√©partition du prix
            const partEtat = Math.floor(c.prix * 0.10);
            const partExport = Math.floor(c.prix * 0.10);
            const partRedistrib = c.prix - partEtat - partExport;
            const nbJoueurs = Object.keys(playersData).length || 1;
            const partParJoueur = Math.floor(partRedistrib / nbJoueurs);
            
            showModal(`
                <div id="modalTimer" style="text-align: center; margin-bottom: 10px;"></div>
                <h3>${c.icon} ${c.name}</h3>
                <p>Activit√© disponible !</p>
                <p><strong>Prix :</strong> ${c.prix}‚Ç¨</p>
                <p><strong>Facture :</strong> ${c.facture}‚Ç¨/passage</p>
                <p><strong>Bonus :</strong> +${bonusHash}# √† l'achat</p>
                
                <div style="background: #f0fdf4; padding: 8px; border-radius: 6px; margin: 10px 0; font-size: 0.85rem;">
                    <p style="margin: 0; font-weight: bold;">R√©partition du prix :</p>
                    <p style="margin: 4px 0 0 0;">üèõÔ∏è √âtat : ${partEtat}‚Ç¨ (10%)</p>
                    <p style="margin: 2px 0 0 0;">üåç Exportation : ${partExport}‚Ç¨ (10%)</p>
                    <p style="margin: 2px 0 0 0;">üë• Redistribu√© : ${partRedistrib}‚Ç¨ (${partParJoueur}‚Ç¨/joueur)</p>
                </div>
                
                <hr style="margin: 10px 0;">
                <p>Tu as : <strong>${currentEuro}‚Ç¨</strong></p>
                ${!canBuy ? '<p style="color: #ef4444;">‚ùå Pas assez</p>' : ''}
            `, `
                ${canBuy ? `<button class="btn btn-primary" onclick="buyActivity(${c.id}, ${c.prix})">üõí Acheter</button>` : ''}
                <button class="btn btn-secondary" onclick="passerTour()">‚è≠Ô∏è Passer</button>
            `);
            
            // D√©marrer le timer
            startDecisionTimer(gameConfig.timingDecision, () => {
                // Timeout : passer automatiquement
                sendSystemMessage(`‚è±Ô∏è Temps √©coul√© - ${myName} passe automatiquement`);
                passerTour();
            });
        }
        
        // Fonction pour passer son tour proprement
        async function passerTour() {
            stopDecisionTimer();
            closeModal();
            console.log('passerTour appel√© - nextTurn...');
            try {
                await nextTurn();
                console.log('nextTurn termin√©');
            } catch (e) {
                console.error('Erreur nextTurn:', e);
            }
        }
        
        async function buyActivity(caseId, prix) {
            stopDecisionTimer();
            closeModal();
            const c = CASES[caseId];
            const profil = playersData[myPlayerId]?.profil || 'contributif';
            
            // Comptabilit√© (avec r√©partition)
            const result = await comptaAchatActivite(myPlayerId, caseId, prix);
            
            // LOG EVENT: BUY_ACTIVITY
            logEvent('BUY_ACTIVITY', myPlayerId, {
                caseId,
                actName: c.name,
                prix,
                bonusEspoyr: Math.floor(prix * 0.1),
                partEtat: result.partEtat,
                partExport: result.partExport,
                partRedistrib: result.partRedistrib,
                partParJoueur: result.partParJoueur,
                profil
            }, result.ledgerEntryIds || []);
            
            // Firebase - mettre √† jour tous les joueurs (redistribution)
            for (const p of Object.values(playersData)) {
                const caisse = COMPTABILITE.caisseJoueurs[p.id];
                if (caisse) {
                    await db.ref(`parties/${currentGameCode}/players/${p.id}/euro`).set(caisse.euro);
                    await db.ref(`parties/${currentGameCode}/players/${p.id}/espoyr`).set(caisse.espoyr || 0);
                }
            }
            await gameRef.child(`activites/${caseId}`).set(myPlayerId);
            await syncComptabiliteToFirebase();
            
            const bonusHash = Math.floor(prix * 0.1);
            sendSystemMessage(`üè™ ${myName} ach√®te ${c.icon} (-${prix}‚Ç¨ +${bonusHash}#) ‚Üí ${result.partParJoueur}‚Ç¨/joueur`);
            
            // Message selon profil
            showProfilMessageModal(profil, c.name);
        }
        
        // Message apr√®s achat selon profil
        function showProfilMessageModal(profil, activiteName) {
            if (profil === 'creatif') {
                showModal(`
                    <h3>üé® F√©licitations !</h3>
                    <p style="font-size: 0.95rem; line-height: 1.5;">
                        Tu n'ach√®tes pas un capital. <strong>Tu acceptes une responsabilit√©.</strong>
                    </p>
                    <p style="font-size: 0.9rem; line-height: 1.5;">
                        Ta richesse viendra de ton travail, de tes choix de gestion 
                        et de ta contribution aux objectifs AAA.
                    </p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">
                        Nous esp√©rons que tu comprendras que ces valeurs sont importantes :
                    </p>
                    <ul style="font-size: 0.85rem; color: #059669; margin: 8px 0;">
                        <li>Am√©liorer le bien-√™tre humain</li>
                        <li>Adopter des pratiques durables</li>
                        <li>Anticiper les impacts environnementaux</li>
                    </ul>
                `, `<button class="btn btn-primary" onclick="closeModal(); nextTurn();">Je m'engage ‚ú®</button>`);
            } else {
                showModal(`
                    <h3>üèõÔ∏è Bienvenue dans l'√©quipe !</h3>
                    <p style="font-size: 0.95rem; line-height: 1.5;">
                        Ici, ton r√¥le n'est pas de poss√©der, mais de <strong>contribuer</strong>.
                    </p>
                    <p style="font-size: 0.9rem; line-height: 1.5;">
                        Chaque comp√©tence compte. Chaque action a un impact.
                    </p>
                    <p style="font-size: 0.9rem; margin-top: 10px;">
                        Forme-toi pour :
                    </p>
                    <ul style="font-size: 0.85rem; color: #2563eb; margin: 8px 0;">
                        <li>Am√©liorer le bien-√™tre humain</li>
                        <li>Renforcer des pratiques durables</li>
                        <li>Pr√©server l'avenir collectif</li>
                    </ul>
                `, `<button class="btn btn-primary" onclick="closeModal(); nextTurn();">Je contribue üí™</button>`);
            }
        }
        
        // ========== √âQUIPEMENT ==========
        function showEquipModal(c, nbEquip, currentEuro) {
            const prixA = Math.floor(c.prixEquip * 1.2);  // +20%
            const prixB = Math.floor(c.prixEquip * 0.8);  // -20%
            const bonusA = Math.floor(c.prixEquip * 0.10);  // 10% bonus #
            
            const canBuyA = currentEuro >= prixA;
            const canBuyB = currentEuro >= prixB;
            
            showModal(`
                <div id="modalTimer" style="text-align: center; margin-bottom: 10px;"></div>
                <h3>${c.icon} ${c.name} - Ta propri√©t√©</h3>
                <p><strong>√âquipements :</strong> ${nbEquip}/2</p>
                <p><strong>Facture actuelle :</strong> ${c.facture * (nbEquip === 2 ? 2 : 1)}‚Ç¨</p>
                <hr style="margin: 10px 0;">
                <p style="font-weight: bold; margin-bottom: 8px;">Choisir un √©quipement :</p>
                
                <div style="background: #dcfce7; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                    <p style="margin: 0;"><strong>üåø √âquipement A (durable)</strong></p>
                    <p style="margin: 4px 0; font-size: 0.9rem;">Prix : ${prixA}‚Ç¨ (+20%)</p>
                    <p style="margin: 0; font-size: 0.85rem; color: #059669;">‚ú® Bonus : +${bonusA}# offerts par le Pot AAA</p>
                </div>
                
                <div style="background: #fee2e2; padding: 10px; border-radius: 8px;">
                    <p style="margin: 0;"><strong>‚ö° √âquipement B (classique)</strong></p>
                    <p style="margin: 4px 0; font-size: 0.9rem;">Prix : ${prixB}‚Ç¨ (-20%)</p>
                    <p style="margin: 0; font-size: 0.85rem; color: #dc2626;">‚ùå Pas de bonus #</p>
                </div>
                
                <hr style="margin: 10px 0;">
                <p>Tu as : <strong>${currentEuro}‚Ç¨</strong></p>
                <p style="font-size: 0.85rem; color: var(--gray);">2 √©quipements = facture √ó2</p>
            `, `
                ${canBuyA ? `<button class="btn" style="background: #dcfce7; color: #059669;" onclick="buyEquipementA(${c.id})">üåø A (${prixA}‚Ç¨)</button>` : ''}
                ${canBuyB ? `<button class="btn" style="background: #fee2e2; color: #dc2626;" onclick="buyEquipementB(${c.id})">‚ö° B (${prixB}‚Ç¨)</button>` : ''}
                <button class="btn btn-secondary" onclick="passerTour()">‚è≠Ô∏è Passer</button>
            `);
            
            // Timer de d√©cision
            startDecisionTimer(gameConfig.timingDecision, () => {
                sendSystemMessage(`‚è±Ô∏è Temps √©coul√© - ${myName} passe automatiquement`);
                passerTour();
            });
        }
        
        async function buyEquipementA(caseId) {
            stopDecisionTimer();
            closeModal();
            const c = CASES[caseId];
            
            // Comptabilit√© √©quipement A
            const result = await comptaAchatEquipementA(myPlayerId, caseId);
            
            // Firebase
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, espoyr: caisse.espoyr
            });
            
            const equipSnap = await gameRef.child(`equipements/${caseId}`).once('value');
            const nbEquip = (equipSnap.val() || 0) + 1;
            await gameRef.child(`equipements/${caseId}`).set(nbEquip);
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üåø ${myName} √©quipe ${c.icon} (A durable) +${result.bonusHash}#`);
            
            nextTurn();
        }
        
        async function buyEquipementB(caseId) {
            stopDecisionTimer();
            closeModal();
            const c = CASES[caseId];
            
            // Comptabilit√© √©quipement B
            await comptaAchatEquipementB(myPlayerId, caseId);
            
            // Firebase
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, espoyr: caisse.espoyr
            });
            
            const equipSnap = await gameRef.child(`equipements/${caseId}`).once('value');
            const nbEquip = (equipSnap.val() || 0) + 1;
            await gameRef.child(`equipements/${caseId}`).set(nbEquip);
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`‚ö° ${myName} √©quipe ${c.icon} (B classique)`);
            
            nextTurn();
        }
        
        // Legacy fonction (gard√©e pour compatibilit√©)
        async function buyEquipement(caseId, prix) {
            closeModal();
            const c = CASES[caseId];
            
            // Comptabilit√©
            await comptaAchatEquipement(myPlayerId, caseId, prix);
            
            // Firebase
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, espoyr: caisse.espoyr
            });
            
            const equipSnap = await gameRef.child(`equipements/${caseId}`).once('value');
            const nbEquip = (equipSnap.val() || 0) + 1;
            await gameRef.child(`equipements/${caseId}`).set(nbEquip);
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`‚öôÔ∏è ${myName} √©quipe ${c.icon} (${nbEquip}/2)`);
            
            nextTurn();
        }
        
        // ========== VENTE D'√âQUIPEMENT AU POT AAA ==========
        
        // Comptabilit√© vente √©quipement au Pot AAA (75% en #)
        async function comptaVenteEquipementAAA(joueurId, actId) {
            initCaisseJoueur(joueurId);
            initCaisseActivite(actId);
            
            const c = CASES[actId];
            const actCompta = COMPTABILITE.caisseActivites[actId];
            
            // Calculer le prix de rachat (75% du prix d'achat moyen)
            const nbEquipA = actCompta.equipementA || 0;
            const nbEquipB = actCompta.equipementB || 0;
            const prixBase = c?.prixEquip || 100;
            const prixMoyenAchat = nbEquipA > 0 ? Math.floor(prixBase * 1.2) : Math.floor(prixBase * 0.8);
            const prixRachat = Math.floor(prixMoyenAchat * 0.75);
            
            // Le joueur re√ßoit des # (pas des ‚Ç¨)
            COMPTABILITE.caisseJoueurs[joueurId].espoyr += prixRachat;
            COMPTABILITE.potAAA.solde -= prixRachat;
            COMPTABILITE.potAAA.circulationHash += prixRachat;
            
            // R√©duire le nombre d'√©quipements
            COMPTABILITE.caisseActivites[actId].equipements = Math.max(0, (actCompta.equipements || 1) - 1);
            if (nbEquipA > 0) {
                COMPTABILITE.caisseActivites[actId].equipementA = nbEquipA - 1;
            } else if (nbEquipB > 0) {
                COMPTABILITE.caisseActivites[actId].equipementB = nbEquipB - 1;
            }
            
            // √âcriture comptable
            enregistrerEcriture({
                joueurId, libelle: `Vente √©quipement au Pot AAA (75%)`,
                compteDebit: 501, compteCredit: 580, montantEspoyr: prixRachat, activiteId: actId,
                contexte: 'potAAA',
                details: { type: 'vente_equipement', prixRachat }
            });
            
            return { prixRachat };
        }
        
        // Interface vente √©quipement
        async function showVenteEquipementModal(actId) {
            const c = CASES[actId];
            const actCompta = COMPTABILITE.caisseActivites[actId] || {};
            const nbEquip = actCompta.equipements || 0;
            
            if (nbEquip === 0) {
                showModal(`<h3>‚ùå Pas d'√©quipement</h3><p>Cette activit√© n'a pas d'√©quipement √† vendre.</p>`,
                    `<button class="btn btn-secondary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            const prixBase = c?.prixEquip || 100;
            const nbEquipA = actCompta.equipementA || 0;
            const prixMoyen = nbEquipA > 0 ? Math.floor(prixBase * 1.2) : Math.floor(prixBase * 0.8);
            const prixRachat = Math.floor(prixMoyen * 0.75);
            
            showModal(`
                <h3>üíö Vendre √©quipement au Pot AAA</h3>
                <p><strong>${c.icon} ${c.name}</strong></p>
                <p>√âquipements : ${nbEquip}/2</p>
                <hr style="margin: 10px 0;">
                <p>Le Pot AAA rach√®te √† <strong>75%</strong> du prix d'achat</p>
                <p style="font-size: 1.2rem; font-weight: bold; color: #059669;">
                    Tu recevras : ${prixRachat}#
                </p>
                <p style="font-size: 0.85rem; color: #6b7280;">
                    (Prix achat ‚âà ${prixMoyen}‚Ç¨ √ó 75% = ${prixRachat}#)
                </p>
            `, `
                <button class="btn btn-primary" onclick="vendreEquipementAAA(${actId})">üíö Vendre 1 √©quipement</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            `);
        }
        
        async function vendreEquipementAAA(actId) {
            closeModal();
            const c = CASES[actId];
            
            const result = await comptaVenteEquipementAAA(myPlayerId, actId);
            
            // Firebase
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(caisse.espoyr);
            
            const equipSnap = await gameRef.child(`equipements/${actId}`).once('value');
            const newNbEquip = Math.max(0, (equipSnap.val() || 1) - 1);
            await gameRef.child(`equipements/${actId}`).set(newNbEquip);
            
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üíö ${myName} vend 1 √©quipement de ${c.icon} au Pot AAA (+${result.prixRachat}#)`);
            
            showModal(`
                <h3>‚úÖ √âquipement vendu !</h3>
                <p>Tu as re√ßu <strong>${result.prixRachat}#</strong> du Pot AAA.</p>
            `, `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
        }
        
        // ========== VENTE D'ACTIVIT√â AUX ENCH√àRES ==========
        
        // √âtat des ench√®res en cours
        let enchereEnCours = null;
        
        // V√©rifier si on peut vendre une activit√©
        function canSellActivity(joueurId, actId) {
            const actCompta = COMPTABILITE.caisseActivites[actId] || {};
            const nbEquip = actCompta.equipements || 0;
            
            // Compter les activit√©s du joueur
            const activitesJoueur = Object.entries(COMPTABILITE.caisseActivites)
                .filter(([id, a]) => a.proprietaireId === joueurId);
            
            // Conditions
            if (nbEquip > 0) {
                return { canSell: false, reason: "Vous devez d'abord vendre les √©quipements" };
            }
            if (activitesJoueur.length <= 1) {
                return { canSell: false, reason: "Vous ne pouvez pas vendre votre derni√®re activit√©" };
            }
            
            return { canSell: true };
        }
        
        // Interface vente activit√©
        async function showVenteActiviteModal(actId) {
            const c = CASES[actId];
            const actCompta = COMPTABILITE.caisseActivites[actId] || {};
            
            const check = canSellActivity(myPlayerId, actId);
            if (!check.canSell) {
                showModal(`
                    <h3>‚ùå Vente impossible</h3>
                    <p>${check.reason}</p>
                `, `<button class="btn btn-secondary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            const prixAchat = actCompta.capital || c.prix;
            const prixDepart = Math.floor(prixAchat * 0.5);  // 50% du prix d'achat
            
            showModal(`
                <h3>üè∑Ô∏è Vendre ${c.icon} ${c.name}</h3>
                <p><strong>Prix d'achat :</strong> ${prixAchat}‚Ç¨</p>
                <p><strong>Prix de d√©part ench√®res :</strong> ${prixDepart}‚Ç¨ (50%)</p>
                <hr style="margin: 10px 0;">
                <p style="font-size: 0.85rem; color: #6b7280;">
                    L'ench√®re sera ouverte √† tous les joueurs.<br>
                    Tu recevras 100% du prix final.
                </p>
            `, `
                <button class="btn btn-primary" onclick="lancerEnchere(${actId}, ${prixDepart})">üî® Lancer l'ench√®re</button>
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            `);
        }
        
        async function lancerEnchere(actId, prixDepart) {
            closeModal();
            const c = CASES[actId];
            
            enchereEnCours = {
                actId,
                vendeurId: myPlayerId,
                vendeurName: myName,
                prixActuel: prixDepart,
                prixDepart,
                dernierEncherisseur: null,
                dernierEncherisseurName: null,
                participants: [],
                termine: false
            };
            
            // Sauvegarder en Firebase pour synchroniser
            await gameRef.child('enchere').set(enchereEnCours);
            
            sendSystemMessage(`üî® ENCH√àRES : ${myName} vend ${c.icon} ${c.name} √† partir de ${prixDepart}‚Ç¨ !`);
            
            // Afficher le modal d'ench√®res pour tous
            showEnchereModal();
        }
        
        function showEnchereModal() {
            if (!enchereEnCours) return;
            
            const c = CASES[enchereEnCours.actId];
            const isVendeur = enchereEnCours.vendeurId === myPlayerId;
            const maCaisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const monEuro = maCaisse.euro || 0;
            const prochaineEnchere = enchereEnCours.prixActuel + 10;
            const canEncherir = !isVendeur && monEuro >= prochaineEnchere;
            
            showModal(`
                <h3>üî® Ench√®res en cours</h3>
                <p><strong>${c.icon} ${c.name}</strong></p>
                <p>Vendeur : ${enchereEnCours.vendeurName}</p>
                <hr style="margin: 10px 0;">
                <p style="font-size: 1.5rem; font-weight: bold; color: #2563eb;">
                    ${enchereEnCours.prixActuel}‚Ç¨
                </p>
                ${enchereEnCours.dernierEncherisseurName ? 
                    `<p style="color: #059669;">Derni√®re ench√®re : ${enchereEnCours.dernierEncherisseurName}</p>` :
                    `<p style="color: #6b7280;">Aucune ench√®re encore</p>`
                }
                <hr style="margin: 10px 0;">
                <p>Tu as : <strong>${monEuro}‚Ç¨</strong></p>
                ${!canEncherir && !isVendeur ? '<p style="color: #ef4444;">Pas assez pour ench√©rir</p>' : ''}
            `, `
                ${canEncherir ? `<button class="btn btn-primary" onclick="faireEnchere(${prochaineEnchere})">üìà Ench√©rir ${prochaineEnchere}‚Ç¨</button>` : ''}
                ${isVendeur && enchereEnCours.dernierEncherisseur ? 
                    `<button class="btn" style="background:#dcfce7;color:#059669;" onclick="accepterEnchere()">‚úÖ Accepter</button>` : ''
                }
                <button class="btn btn-secondary" onclick="closeModal(); passerEnchere();">Passer</button>
            `);
        }
        
        async function faireEnchere(montant) {
            closeModal();
            
            enchereEnCours.prixActuel = montant;
            enchereEnCours.dernierEncherisseur = myPlayerId;
            enchereEnCours.dernierEncherisseurName = myName;
            
            await gameRef.child('enchere').set(enchereEnCours);
            
            const c = CASES[enchereEnCours.actId];
            sendSystemMessage(`üìà ${myName} ench√©rit ${montant}‚Ç¨ pour ${c.icon}`);
            
            // Afficher √† nouveau le modal (pour les autres joueurs via listener)
            showEnchereModal();
        }
        
        async function passerEnchere() {
            // Le joueur passe son tour d'ench√®re
            sendSystemMessage(`‚è≠Ô∏è ${myName} passe`);
        }
        
        async function accepterEnchere() {
            if (!enchereEnCours || !enchereEnCours.dernierEncherisseur) return;
            closeModal();
            
            const c = CASES[enchereEnCours.actId];
            const acheteurId = enchereEnCours.dernierEncherisseur;
            const vendeurId = enchereEnCours.vendeurId;
            const prixFinal = enchereEnCours.prixActuel;
            
            // Comptabilit√© : transfert d'argent
            initCaisseJoueur(acheteurId);
            initCaisseJoueur(vendeurId);
            
            // Acheteur paie
            COMPTABILITE.caisseJoueurs[acheteurId].euro -= prixFinal;
            
            // Vendeur re√ßoit
            COMPTABILITE.caisseJoueurs[vendeurId].euro += prixFinal;
            
            // Transfert de propri√©t√©
            COMPTABILITE.caisseActivites[enchereEnCours.actId].proprietaireId = acheteurId;
            
            // √âcritures comptables
            enregistrerEcriture({
                joueurId: acheteurId, libelle: `Achat ench√®re ${c.name}`,
                compteDebit: 200, compteCredit: 500, montantEuro: prixFinal, activiteId: enchereEnCours.actId
            });
            
            enregistrerEcriture({
                joueurId: vendeurId, libelle: `Vente ench√®re ${c.name}`,
                compteDebit: 500, compteCredit: 260, montantEuro: prixFinal, activiteId: enchereEnCours.actId
            });
            
            // Firebase
            await db.ref(`parties/${currentGameCode}/players/${acheteurId}/euro`).set(
                COMPTABILITE.caisseJoueurs[acheteurId].euro
            );
            await db.ref(`parties/${currentGameCode}/players/${vendeurId}/euro`).set(
                COMPTABILITE.caisseJoueurs[vendeurId].euro
            );
            await gameRef.child(`activites/${enchereEnCours.actId}`).set(acheteurId);
            await gameRef.child('enchere').remove();
            await syncComptabiliteToFirebase();
            
            const acheteurPlayer = playersData[acheteurId];
            sendSystemMessage(`üî® VENDU ! ${c.icon} ${c.name} √† ${acheteurPlayer?.name} pour ${prixFinal}‚Ç¨`);
            
            enchereEnCours = null;
            
            showModal(`
                <h3>‚úÖ Vente conclue !</h3>
                <p><strong>${c.icon} ${c.name}</strong> vendu pour ${prixFinal}‚Ç¨</p>
            `, `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
        }

        // ========== FAILLITE ET INTERVENTION AAA ==========
        
        // V√©rifier si un joueur est en situation de faillite
        function checkFaillite(joueurId) {
            const caisse = COMPTABILITE.caisseJoueurs[joueurId] || {};
            const euro = caisse.euro || 0;
            const espoyr = caisse.espoyr || 0;
            const emprunt = caisse.emprunt || 0;
            
            // Calculer la limite d'emprunt
            const players = Object.values(playersData);
            const nbJoueurs = players.length || 1;
            let masseMonetaire = 0;
            players.forEach(p => {
                const c = COMPTABILITE.caisseJoueurs[p.id] || {};
                masseMonetaire += (c.euro || 0);
            });
            const limiteEmprunt = Math.max(750, Math.floor(masseMonetaire / nbJoueurs));
            
            // Capacit√© d'emprunt restante
            const capaciteEmprunt = Math.max(0, limiteEmprunt - emprunt);
            
            // En faillite si : pas d'‚Ç¨, pas de # et ne peut plus emprunter
            const enFaillite = euro <= 0 && espoyr <= 0 && capaciteEmprunt <= 0;
            
            return {
                enFaillite,
                euro,
                espoyr,
                emprunt,
                limiteEmprunt,
                capaciteEmprunt,
                isMembre: COMPTABILITE.potAAA.membres?.includes(joueurId)
            };
        }
        
        // Comptabilit√© : R√©duction de valeur sur cr√©ance (perte attendue)
        async function comptaReductionValeur(joueurId, montant) {
            // La banque constate une perte attendue sur le pr√™t
            COMPTABILITE.banque.reductionValeur += montant;
            
            // √âcriture : D:634 (Dotation RDV) C:2919 (RDV act√©e)
            enregistrerEcriture({
                joueurId, libelle: `R√©duction de valeur cr√©ance (perte attendue)`,
                compteDebit: 634, compteCredit: 2919, montantEuro: montant,
                contexte: 'banque',
                details: { type: 'reduction_valeur' }
            });
            
            return montant;
        }
        
        // Comptabilit√© : D√©faut effectif (consommer la RDV)
        async function comptaDefautEffectif(joueurId, montant) {
            // Consommer la r√©duction de valeur sans nouvelle charge
            // D:2919 (RDV act√©e) C:291 (Pr√™ts client√®le)
            enregistrerEcriture({
                joueurId, libelle: `D√©faut effectif - annulation cr√©ance`,
                compteDebit: 2919, compteCredit: 291, montantEuro: montant,
                contexte: 'banque',
                details: { type: 'defaut_effectif' }
            });
            
            // R√©duire les cr√©ances de la banque
            COMPTABILITE.banque.creancesJoueurs = Math.max(0, COMPTABILITE.banque.creancesJoueurs - montant);
            COMPTABILITE.banque.reductionValeur = Math.max(0, COMPTABILITE.banque.reductionValeur - montant);
            
            return montant;
        }
        
        // Intervention du Pot AAA pour un membre en faillite
        async function interventionAAA(joueurId) {
            const caisse = COMPTABILITE.caisseJoueurs[joueurId] || {};
            const emprunt = caisse.emprunt || 0;
            const player = playersData[joueurId];
            
            if (!COMPTABILITE.potAAA.membres?.includes(joueurId)) {
                return { success: false, reason: "Non membre du Pot AAA" };
            }
            
            // 1. Constater la r√©duction de valeur (perte attendue)
            await comptaReductionValeur(joueurId, emprunt);
            
            // 2. D√©faut effectif - annuler la dette
            await comptaDefautEffectif(joueurId, emprunt);
            
            // 3. Annuler la dette du joueur
            COMPTABILITE.caisseJoueurs[joueurId].emprunt = 0;
            
            // √âcriture annulation dette c√¥t√© joueur
            enregistrerEcriture({
                joueurId, libelle: `Annulation dette par Pot AAA`,
                compteDebit: 110, compteCredit: 778, montantEuro: emprunt,
                details: { type: 'annulation_dette_aaa' }
            });
            
            // 4. Pr√™t de relance en # (250#)
            const pretRelance = 250;
            COMPTABILITE.caisseJoueurs[joueurId].espoyr += pretRelance;
            COMPTABILITE.potAAA.solde -= pretRelance;
            COMPTABILITE.potAAA.circulationHash += pretRelance;
            
            enregistrerEcriture({
                joueurId, libelle: `Pr√™t de relance AAA`,
                compteDebit: 501, compteCredit: 580, montantEspoyr: pretRelance,
                contexte: 'potAAA',
                details: { type: 'pret_relance' }
            });
            
            return {
                success: true,
                detteAnnulee: emprunt,
                pretRelance
            };
        }
        
        // Interface : Modal de d√©claration de faillite
        function showFailliteModal() {
            const status = checkFaillite(myPlayerId);
            const player = playersData[myPlayerId];
            
            if (!status.enFaillite) {
                showModal(`
                    <h3>üìä Situation financi√®re</h3>
                    <p>Tu n'es pas en situation de faillite.</p>
                    <p><strong>Caisse :</strong> ${status.euro}‚Ç¨ / ${status.espoyr}#</p>
                    <p><strong>Dette :</strong> ${status.emprunt}‚Ç¨</p>
                    <p><strong>Capacit√© d'emprunt :</strong> ${status.capaciteEmprunt}‚Ç¨</p>
                `, `<button class="btn btn-secondary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            // En faillite
            if (status.isMembre) {
                showModal(`
                    <h3>‚ö†Ô∏è Faillite - Membre AAA</h3>
                    <p style="color: #dc2626;">Tu es en situation de faillite !</p>
                    <p><strong>Caisse :</strong> ${status.euro}‚Ç¨ / ${status.espoyr}#</p>
                    <p><strong>Dette :</strong> ${status.emprunt}‚Ç¨</p>
                    <hr style="margin: 10px 0;">
                    <div style="background: #dcfce7; padding: 10px; border-radius: 8px;">
                        <p style="margin: 0; font-weight: bold;">üíö Intervention du Pot AAA</p>
                        <p style="margin: 4px 0 0 0; font-size: 0.9rem;">
                            En tant que membre, tu b√©n√©ficies de :
                        </p>
                        <ul style="font-size: 0.85rem; margin: 8px 0;">
                            <li>Annulation de ta dette de ${status.emprunt}‚Ç¨</li>
                            <li>Pr√™t de relance de 250#</li>
                        </ul>
                    </div>
                `, `
                    <button class="btn btn-primary" onclick="declarerFailliteAAA()">üíö Accepter l'aide AAA</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                `);
            } else {
                showModal(`
                    <h3>‚ö†Ô∏è Faillite</h3>
                    <p style="color: #dc2626;">Tu es en situation de faillite !</p>
                    <p><strong>Caisse :</strong> ${status.euro}‚Ç¨ / ${status.espoyr}#</p>
                    <p><strong>Dette :</strong> ${status.emprunt}‚Ç¨</p>
                    <hr style="margin: 10px 0;">
                    <div style="background: #fee2e2; padding: 10px; border-radius: 8px;">
                        <p style="margin: 0; font-weight: bold;">‚ùå Non membre du Pot AAA</p>
                        <p style="margin: 4px 0 0 0; font-size: 0.9rem;">
                            Tu ne peux pas b√©n√©ficier de l'aide du Pot AAA.
                        </p>
                        <p style="margin: 4px 0 0 0; font-size: 0.85rem; color: #6b7280;">
                            Options : vendre des activit√©s ou d√©clarer faillite totale.
                        </p>
                    </div>
                `, `
                    <button class="btn" style="background:#fee2e2;color:#dc2626;" onclick="declarerFailliteTotale()">üíÄ Faillite totale</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                `);
            }
        }
        
        // D√©clarer faillite avec intervention AAA
        async function declarerFailliteAAA() {
            closeModal();
            
            const result = await interventionAAA(myPlayerId);
            
            if (!result.success) {
                showModal(`<h3>‚ùå Erreur</h3><p>${result.reason}</p>`,
                    `<button class="btn btn-secondary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            // Mettre √† jour Firebase
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro,
                espoyr: caisse.espoyr,
                emprunt: 0
            });
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üíö ${myName} a √©t√© sauv√© par le Pot AAA ! Dette annul√©e: ${result.detteAnnulee}‚Ç¨, Pr√™t: +${result.pretRelance}#`);
            
            showModal(`
                <h3>üíö Intervention AAA r√©ussie !</h3>
                <p><strong>Dette annul√©e :</strong> ${result.detteAnnulee}‚Ç¨</p>
                <p><strong>Pr√™t de relance :</strong> +${result.pretRelance}#</p>
                <p style="font-size: 0.9rem; color: #059669; margin-top: 10px;">
                    Tu repars avec une nouvelle chance. Utilise-la bien !
                </p>
            `, `<button class="btn btn-primary" onclick="closeModal()">Merci AAA ! üíö</button>`);
        }
        
        // D√©clarer faillite totale (non-membre AAA)
        async function declarerFailliteTotale() {
            closeModal();
            
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const emprunt = caisse.emprunt || 0;
            
            // 1. Constater la r√©duction de valeur et le d√©faut
            await comptaReductionValeur(myPlayerId, emprunt);
            await comptaDefautEffectif(myPlayerId, emprunt);
            
            // 2. Remettre le joueur √† z√©ro
            COMPTABILITE.caisseJoueurs[myPlayerId].euro = 0;
            COMPTABILITE.caisseJoueurs[myPlayerId].espoyr = 0;
            COMPTABILITE.caisseJoueurs[myPlayerId].emprunt = 0;
            COMPTABILITE.caisseJoueurs[myPlayerId].apportsActivites = 0;
            
            // 3. Perdre toutes les activit√©s (elles redeviennent libres)
            const activitesALiberer = [];
            for (const [actId, act] of Object.entries(COMPTABILITE.caisseActivites)) {
                if (act.proprietaireId === myPlayerId) {
                    activitesALiberer.push(actId);
                    COMPTABILITE.caisseActivites[actId].proprietaireId = null;
                }
            }
            
            // 4. Mettre √† jour Firebase
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: 0, espoyr: 0, emprunt: 0
            });
            
            for (const actId of activitesALiberer) {
                await gameRef.child(`activites/${actId}`).remove();
                await gameRef.child(`equipements/${actId}`).remove();
            }
            
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üíÄ ${myName} a fait faillite totale ! ${activitesALiberer.length} activit√©s lib√©r√©es.`);
            
            showModal(`
                <h3>üíÄ Faillite totale</h3>
                <p>Tu as tout perdu.</p>
                <p><strong>Activit√©s perdues :</strong> ${activitesALiberer.length}</p>
                <p style="font-size: 0.9rem; color: #dc2626; margin-top: 10px;">
                    Tu repars de z√©ro. Rejoins le Pot AAA pour te prot√©ger √† l'avenir !
                </p>
            `, `<button class="btn btn-primary" onclick="closeModal()">Recommencer üí™</button>`);
        }
        
        // V√©rifier automatiquement la faillite quand on ne peut pas payer
        async function checkAndHandleFaillite(montantAPayer) {
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const euro = caisse.euro || 0;
            const espoyr = caisse.espoyr || 0;
            
            // Peut-on payer ?
            if (euro + espoyr >= montantAPayer) {
                return false; // Pas en faillite
            }
            
            // Peut-on emprunter le reste ?
            const manque = montantAPayer - euro - espoyr;
            const status = checkFaillite(myPlayerId);
            
            if (status.capaciteEmprunt >= manque) {
                return false; // Peut emprunter
            }
            
            // Faillite !
            showFailliteModal();
            return true;
        }

        // ========== PAIEMENT / N√âGOCIATION ==========
        async function showPayOrNegotiateModal(c, ownerId, currentEuro) {
            const players = Object.values(playersData);
            const ownerPlayer = players.find(p => p.id === ownerId);
            
            const equipSnap = await gameRef.child(`equipements/${c.id}`).once('value');
            const nbEquip = equipSnap.val() || 0;
            const facture = c.facture * (nbEquip === 2 ? 2 : 1);
            
            const canPay = currentEuro >= facture;
            const myEspoyr = COMPTABILITE.caisseJoueurs[myPlayerId]?.espoyr || 0;
            
            // V√©rifier si en faillite potentielle
            const status = checkFaillite(myPlayerId);
            const cannotPayAtAll = !canPay && myEspoyr < facture && status.capaciteEmprunt < (facture - currentEuro - myEspoyr);
            
            showModal(`
                <h3>${c.icon} ${c.name}</h3>
                <p>Propri√©taire : <strong>${ownerPlayer?.avatar} ${ownerPlayer?.name}</strong></p>
                <p>Facture : <strong>${facture}‚Ç¨</strong> ${nbEquip === 2 ? '(√ó2)' : ''}</p>
                <hr style="margin: 10px 0;">
                <p>Tu as : ${currentEuro}‚Ç¨ / ${myEspoyr}#</p>
                ${!canPay && myEspoyr === 0 ? '<p style="color: #ef4444;">‚ö†Ô∏è Pas assez !</p>' : ''}
                ${cannotPayAtAll ? '<p style="color: #dc2626; font-weight: bold;">üíÄ Tu ne peux pas payer cette facture !</p>' : ''}
            `, `
                ${canPay ? `<button class="btn btn-primary" onclick="payOwner(${c.id}, '${ownerId}', ${facture}, 0)">üí∂ Payer ${facture}‚Ç¨</button>` : ''}
                ${myEspoyr > 0 ? `<button class="btn btn-secondary" onclick="showNegoModal(${c.id}, '${ownerId}', ${facture})">ü§ù N√©gocier</button>` : ''}
                <button class="btn" style="background:#dcfce7;color:#059669;" onclick="showWorkModal(${c.id}, '${ownerId}', ${facture})">üë∑ Travailler</button>
                ${!canPay && myEspoyr === 0 && !cannotPayAtAll ? `<button class="btn" style="background:#fee2e2;color:#dc2626;" onclick="createDebt('${ownerId}', ${facture})">üìã Dette</button>` : ''}
                ${cannotPayAtAll ? `<button class="btn" style="background:#fef9c3;color:#854d0e;" onclick="closeModal(); showFailliteModal();">‚ö†Ô∏è Faillite</button>` : ''}
            `);
        }
        
        async function payOwner(caseId, ownerId, euroAmount, hashAmount) {
            closeModal();
            const c = CASES[caseId];
            
            // Comptabilit√©
            await comptaPaiementFacture(myPlayerId, ownerId, caseId, euroAmount, hashAmount);
            
            // Firebase
            const maCaisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            const ownerCaisse = COMPTABILITE.caisseJoueurs[ownerId];
            
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: maCaisse.euro, espoyr: maCaisse.espoyr
            });
            
            // Propri√©taire re√ßoit dans activit√©
            const caisseAct = COMPTABILITE.caisseActivites[caseId];
            await db.ref(`parties/${currentGameCode}/players/${ownerId}`).update({
                euro: (playersData[ownerId]?.euro || 0) + euroAmount,
                espoyr: (playersData[ownerId]?.espoyr || 0) + hashAmount
            });
            
            await syncComptabiliteToFirebase();
            
            const players = Object.values(playersData);
            const ownerPlayer = players.find(p => p.id === ownerId);
            
            let msg = `üí∏ ${myName} paie `;
            if (euroAmount > 0) msg += `${euroAmount}‚Ç¨`;
            if (hashAmount > 0) msg += `${euroAmount > 0 ? '+' : ''}${hashAmount}#`;
            msg += ` √† ${ownerPlayer?.name}`;
            sendSystemMessage(msg);
            
            nextTurn();
        }
        
        // ========== N√âGOCIATION ==========
        function showNegoModal(caseId, ownerId, facture) {
            closeModal();
            const c = CASES[caseId];
            const myEuro = COMPTABILITE.caisseJoueurs[myPlayerId]?.euro || 0;
            const myEspoyr = COMPTABILITE.caisseJoueurs[myPlayerId]?.espoyr || 0;
            
            showModal(`
                <h3>ü§ù N√©gociation</h3>
                <p>${c.icon} ${c.name} - Facture : ${facture}‚Ç¨</p>
                <p>Tu as : ${myEuro}‚Ç¨ / ${myEspoyr}#</p>
                <hr style="margin: 10px 0;">
                <div style="display: flex; gap: 10px;">
                    <div style="flex:1;">
                        <label style="font-size: 0.8rem;">Euros ‚Ç¨</label>
                        <input type="number" id="negoEuro" min="0" max="${Math.min(myEuro, facture)}" value="${Math.min(myEuro, Math.floor(facture/2))}">
                    </div>
                    <div style="flex:1;">
                        <label style="font-size: 0.8rem;">Espoyr #</label>
                        <input type="number" id="negoHash" min="0" max="${myEspoyr}" value="${Math.min(myEspoyr, Math.ceil(facture/2))}">
                    </div>
                </div>
                <p style="font-size: 0.8rem; color: var(--gray);">Total ‚â• ${facture} accept√© auto</p>
            `, `
                <button class="btn btn-primary" onclick="sendNego(${caseId}, '${ownerId}', ${facture})">üì§ Payer</button>
                <button class="btn btn-secondary" onclick="closeModal(); nextTurn();">Annuler</button>
            `);
        }
        
        async function sendNego(caseId, ownerId, facture) {
            const euroOffer = parseInt(document.getElementById('negoEuro').value) || 0;
            const hashOffer = parseInt(document.getElementById('negoHash').value) || 0;
            
            if (euroOffer + hashOffer >= facture) {
                await payOwner(caseId, ownerId, euroOffer, hashOffer);
            } else {
                alert('Le total doit √™tre ‚â• ' + facture);
            }
        }
        
        // ========== TRAVAIL COOP√âRATIF ==========
        function showWorkModal(caseId, ownerId, facture) {
            closeModal();
            const c = CASES[caseId];
            const players = Object.values(playersData);
            const ownerPlayer = players.find(p => p.id === ownerId);
            const gainHash = Math.ceil(facture / 2);
            
            showModal(`
                <h3>üë∑ Travail Coop√©ratif</h3>
                <p>Tu proposes de travailler chez ${ownerPlayer?.avatar} ${ownerPlayer?.name}</p>
                <p>${c.icon} ${c.name}</p>
                <hr style="margin: 10px 0;">
                <p>En √©change :</p>
                <ul style="padding-left: 20px; margin: 10px 0;">
                    <li>Tu gagnes <strong style="color: #059669;">${gainHash}#</strong></li>
                    <li>Le propri√©taire gagne <strong style="color: #059669;">${gainHash}#</strong></li>
                    <li>Pas de facture √† payer</li>
                </ul>
            `, `
                <button class="btn btn-primary" onclick="doWorkCoop(${caseId}, '${ownerId}', ${gainHash})">üë∑ Travailler</button>
                <button class="btn btn-secondary" onclick="showPayOrNegotiateModal(CASES[${caseId}], '${ownerId}', COMPTABILITE.caisseJoueurs['${myPlayerId}']?.euro || 0)">Retour</button>
            `);
        }
        
        async function doWorkCoop(caseId, ownerId, gainHash) {
            closeModal();
            const c = CASES[caseId];
            
            // Comptabilit√©
            await comptaTravailCoop(myPlayerId, ownerId, caseId, gainHash);
            
            // Firebase
            const maCaisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            const ownerCaisse = COMPTABILITE.caisseJoueurs[ownerId];
            
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(maCaisse.espoyr);
            await db.ref(`parties/${currentGameCode}/players/${ownerId}/espoyr`).set(ownerCaisse.espoyr);
            await syncComptabiliteToFirebase();
            
            const players = Object.values(playersData);
            const ownerPlayer = players.find(p => p.id === ownerId);
            
            sendSystemMessage(`üë∑ ${myName} travaille chez ${ownerPlayer?.name} (${c.icon}) : +${gainHash}# chacun !`);
            
            nextTurn();
        }
        
        // ========== DETTE ==========
        async function createDebt(ownerId, amount) {
            closeModal();
            
            // Comptabilit√© - emprunt forc√© √† la banque pour payer
            await comptaEmprunt(myPlayerId, amount);
            
            // Le propri√©taire re√ßoit quand m√™me
            initCaisseJoueur(ownerId);
            COMPTABILITE.caisseJoueurs[ownerId].euro += amount;
            
            // Firebase
            const maCaisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: maCaisse.euro, emprunt: maCaisse.emprunt
            });
            await db.ref(`parties/${currentGameCode}/players/${ownerId}/euro`).set(
                (playersData[ownerId]?.euro || 0) + amount
            );
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üìã ${myName} s'endette de ${amount}‚Ç¨ (banque)`);
            
            nextTurn();
        }
        
        // ========== CASES SP√âCIALES ==========
        async function handleChance() {
            const card = CHANCE_CARDS[Math.floor(Math.random() * CHANCE_CARDS.length)];
            
            if (card.all) {
                const players = Object.values(playersData);
                for (const p of players) {
                    await comptaChance(p.id, card.amount, true);
                    const caisse = COMPTABILITE.caisseJoueurs[p.id];
                    await db.ref(`parties/${currentGameCode}/players/${p.id}/euro`).set(caisse.euro);
                }
                sendSystemMessage(`üçÄ CHANCE: ${card.text}`);
            } else {
                await comptaChance(myPlayerId, card.amount, true);
                const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
                await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/euro`).set(caisse.euro);
                sendSystemMessage(`üçÄ ${myName}: ${card.text}`);
            }
            
            await syncComptabiliteToFirebase();
            
            showModal(`<h3>üçÄ Chance !</h3><p>${card.text}</p>`,
                `<button class="btn btn-primary" onclick="closeModal(); nextTurn();">OK</button>`);
        }
        
        async function handleMalchance() {
            const card = MALCHANCE_CARDS[Math.floor(Math.random() * MALCHANCE_CARDS.length)];
            
            await comptaChance(myPlayerId, card.amount, false);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/euro`).set(Math.max(0, caisse.euro));
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${myName}: ${card.text}`);
            
            showModal(`<h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Merci</h3><p>${card.text}</p>`,
                `<button class="btn btn-primary" onclick="closeModal(); nextTurn();">OK</button>`);
        }
        
        async function handleFrais(c) {
            await comptaFrais(myPlayerId, c.cout, c.name);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/euro`).set(Math.max(0, caisse.euro));
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`${c.icon} ${myName} paie ${c.cout}‚Ç¨ (${c.name})`);
            
            showModal(`<h3>${c.icon} ${c.name}</h3><p>Frais : <strong>${c.cout}‚Ç¨</strong></p>`,
                `<button class="btn btn-primary" onclick="closeModal(); nextTurn();">OK</button>`);
        }
        
        async function handleTaxe() {
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const taxe = Math.floor((caisse.euro || 0) * 0.1);
            
            await comptaTaxe(myPlayerId, taxe);
            const newCaisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/euro`).set(newCaisse.euro);
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üèõÔ∏è ${myName} paie ${taxe}‚Ç¨ de taxe (10%)`);
            
            showModal(`<h3>üèõÔ∏è Taxe</h3><p>10% du capital : <strong>${taxe}‚Ç¨</strong></p>`,
                `<button class="btn btn-primary" onclick="closeModal(); nextTurn();">OK</button>`);
        }
        
        async function handleLigne2(c) {
            const players = Object.values(playersData);
            
            for (const p of players) {
                await comptaFrais(p.id, c.cout, 'Ligne 2');
                const caisse = COMPTABILITE.caisseJoueurs[p.id];
                await db.ref(`parties/${currentGameCode}/players/${p.id}/euro`).set(Math.max(0, caisse.euro));
            }
            await syncComptabiliteToFirebase();
            
            sendSystemMessage(`üöå LIGNE 2 ! Tout le monde paie ${c.cout}‚Ç¨`);
            
            showModal(`<h3>üöå Ligne 2</h3><p>Tous les joueurs paient <strong>${c.cout}‚Ç¨</strong></p>`,
                `<button class="btn btn-primary" onclick="closeModal(); nextTurn();">OK</button>`);
        }
        
        // ========== TOUR SUIVANT ==========
        async function nextTurn() {
            const players = Object.values(playersData);
            const currentIdx = gameState.currentPlayerIndex || 0;
            const nextIdx = (currentIdx + 1) % players.length;
            
            const isNewRound = nextIdx === 0;
            const newTurn = isNewRound ? (gameState.turn || 1) + 1 : gameState.turn;
            const toursComplets = isNewRound ? (gameState.toursComplets || 0) + 1 : (gameState.toursComplets || 0);
            
            // Int√©r√™ts si nouveau tour complet
            if (isNewRound) {
                await applyInterests();
                
                // LOG EVENT: NEW_ROUND
                logEvent('NEW_ROUND', null, {
                    turn: newTurn,
                    toursComplets
                });
                
                // Cr√©er un snapshot √† chaque fin de tour complet
                createSnapshot();
                console.log(`üì∏ Snapshot cr√©√©: Tour ${newTurn}`);
            }
            
            await gameRef.child('state').update({
                currentPlayerIndex: nextIdx,
                turn: newTurn,
                toursComplets: toursComplets
            });
            
            if (isNewRound) {
                await checkPhaseTransition();
            }
        }
        
        // ========== INT√âR√äTS ==========
        async function applyInterests() {
            const players = Object.values(playersData);
            
            for (const p of players) {
                const caisse = COMPTABILITE.caisseJoueurs[p.id];
                if (caisse && caisse.emprunt > 0) {
                    const interet = Math.floor(caisse.emprunt * CONFIG.tauxInteret);
                    if (interet > 0) {
                        await comptaInterets(p.id, interet);
                        
                        // Ajouter √† la dette
                        caisse.emprunt += interet;
                        await db.ref(`parties/${currentGameCode}/players/${p.id}/emprunt`).set(caisse.emprunt);
                        
                        sendSystemMessage(`üìà ${p.name} : int√©r√™ts +${interet}‚Ç¨ (dette: ${caisse.emprunt}‚Ç¨)`);
                    }
                }
            }
            await syncComptabiliteToFirebase();
        }
        
        // ========== ROBOTS IA ==========
        async function playBotTurn(bot) {
            const profil = PROFILS_IA[bot.botProfil] || PROFILS_IA.EQUILIBRE;
            
            const dice = Math.floor(Math.random() * 6) + 1;
            
            // Calculer la position selon le sens
            const sens = gameState?.sensDeplacent || sensDeplacementGlobal || 1;
            let newPosition;
            let passedStart = false;
            
            if (sens === 1) {
                newPosition = (bot.position + dice) % CASES.length;
                passedStart = (bot.position + dice) >= CASES.length;
            } else {
                newPosition = (bot.position - dice + CASES.length) % CASES.length;
                passedStart = (bot.position - dice) < 0;
            }
            
            // *** BONUS AAA : Si le robot est membre, +50# dans le Pot AAA ***
            const isMembre = COMPTABILITE.potAAA.membres?.includes(bot.id) || bot.membreAAA;
            if (isMembre) {
                await comptaBonusAAALancer(bot.id);
                sendSystemMessage(`üíö +50# cr√©√©s dans le Pot AAA (${bot.name} membre)`);
            }
            
            await db.ref(`parties/${currentGameCode}/players/${bot.id}/position`).set(newPosition);
            
            const sensIcon = sens === 1 ? '‚û°Ô∏è' : '‚¨ÖÔ∏è';
            sendSystemMessage(`ü§ñ ${bot.name} fait ${dice} ${sensIcon} ${CASES[newPosition].name}`);
            
            // Salaire
            if (passedStart) {
                const deSalaire = Math.floor(Math.random() * 6) + 1;
                const botProfil = bot.profil || 'contributif';
                let pourcentage;
                if (botProfil === 'creatif') {
                    pourcentage = SALARY_CREATIF[deSalaire] || 1;
                } else {
                    pourcentage = SALARY_CONTRIBUTIF[deSalaire] || 1;
                }
                let salaire = Math.floor(CONFIG.salaireBase * pourcentage);
                salaire = Math.max(100, salaire);
                
                await comptaSalaire(bot.id, salaire, deSalaire);
                const caisse = COMPTABILITE.caisseJoueurs[bot.id];
                await db.ref(`parties/${currentGameCode}/players/${bot.id}/euro`).set(caisse.euro);
                await syncComptabiliteToFirebase();
                
                sendSystemMessage(`üí∞ ${bot.name} re√ßoit ${salaire}‚Ç¨`);
            }
            
            // G√©rer case
            await handleBotLanding(bot.id, newPosition, profil);
        }
        
        async function handleBotLanding(botId, position, profil) {
            const c = CASES[position];
            const caisse = COMPTABILITE.caisseJoueurs[botId] || {};
            const bot = playersData[botId];
            
            if (c.type === 'activite') {
                const activitesSnap = await gameRef.child('activites').once('value');
                const activites = activitesSnap.val() || {};
                const owner = activites[position];
                
                if (!owner && (caisse.euro || 0) >= c.prix) {
                    // D√©cision achat
                    const shouldBuy = profil.acheteToujours || (caisse.euro || 0) >= c.prix * 1.5;
                    if (shouldBuy) {
                        await comptaAchatActivite(botId, position, c.prix);
                        const newCaisse = COMPTABILITE.caisseJoueurs[botId];
                        await db.ref(`parties/${currentGameCode}/players/${botId}`).update({
                            euro: newCaisse.euro, espoyr: newCaisse.espoyr
                        });
                        await gameRef.child(`activites/${position}`).set(botId);
                        await syncComptabiliteToFirebase();
                        
                        sendSystemMessage(`ü§ñ ${bot.name} ach√®te ${c.icon} ${c.name}`);
                    }
                } else if (owner && owner !== botId) {
                    const equipSnap = await gameRef.child(`equipements/${position}`).once('value');
                    const nbEquip = equipSnap.val() || 0;
                    const facture = c.facture * (nbEquip === 2 ? 2 : 1);
                    
                    if ((caisse.euro || 0) >= facture) {
                        await comptaPaiementFacture(botId, owner, position, facture, 0);
                    } else {
                        // Robot emprunte d'abord, puis paie via comptaPaiementFacture
                        const manque = facture - (caisse.euro || 0);
                        await comptaEmprunt(botId, manque);
                        await comptaPaiementFacture(botId, owner, position, facture, 0);
                    }
                    
                    const botCaisse = COMPTABILITE.caisseJoueurs[botId];
                    const ownerCaisse = COMPTABILITE.caisseJoueurs[owner];
                    
                    await db.ref(`parties/${currentGameCode}/players/${botId}`).update({
                        euro: botCaisse.euro, emprunt: botCaisse.emprunt || 0
                    });
                    await db.ref(`parties/${currentGameCode}/players/${owner}/euro`).set(
                        (playersData[owner]?.euro || 0) + facture
                    );
                    await syncComptabiliteToFirebase();
                    
                    sendSystemMessage(`ü§ñ ${bot.name} paie ${facture}‚Ç¨`);
                }
            } else if (c.type === 'frais' || c.type === 'ligne2') {
                const cout = c.cout || 50;
                if (c.type === 'ligne2') {
                    const players = Object.values(playersData);
                    for (const p of players) {
                        await comptaFrais(p.id, cout, c.name);
                        const pCaisse = COMPTABILITE.caisseJoueurs[p.id];
                        await db.ref(`parties/${currentGameCode}/players/${p.id}/euro`).set(Math.max(0, pCaisse.euro));
                    }
                } else {
                    await comptaFrais(botId, cout, c.name);
                    const newCaisse = COMPTABILITE.caisseJoueurs[botId];
                    await db.ref(`parties/${currentGameCode}/players/${botId}/euro`).set(Math.max(0, newCaisse.euro));
                }
                await syncComptabiliteToFirebase();
            } else if (c.type === 'taxe') {
                const taxe = Math.floor((caisse.euro || 0) * 0.1);
                await comptaTaxe(botId, taxe);
                const newCaisse = COMPTABILITE.caisseJoueurs[botId];
                await db.ref(`parties/${currentGameCode}/players/${botId}/euro`).set(newCaisse.euro);
                await syncComptabiliteToFirebase();
            } else if (c.type === 'chance') {
                const card = CHANCE_CARDS[Math.floor(Math.random() * CHANCE_CARDS.length)];
                if (!card.all) {
                    await comptaChance(botId, card.amount, true);
                    const newCaisse = COMPTABILITE.caisseJoueurs[botId];
                    await db.ref(`parties/${currentGameCode}/players/${botId}/euro`).set(newCaisse.euro);
                    await syncComptabiliteToFirebase();
                }
            } else if (c.type === 'malchance') {
                const card = MALCHANCE_CARDS[Math.floor(Math.random() * MALCHANCE_CARDS.length)];
                await comptaChance(botId, card.amount, false);
                const newCaisse = COMPTABILITE.caisseJoueurs[botId];
                await db.ref(`parties/${currentGameCode}/players/${botId}/euro`).set(Math.max(0, newCaisse.euro));
                await syncComptabiliteToFirebase();
            }
            
            setTimeout(() => nextTurn(), 1000);
        }
        
        // ========== MODALS COMPTABILIT√â ==========
        
        function showComptaModal() {
            const journal = COMPTABILITE.journal.slice(-20).reverse();
            
            const rows = journal.map(e => `
                <div class="journal-entry">
                    <small style="color:#9ca3af;">#${e.id} T${e.tour}</small>
                    <strong>${e.joueurNom}</strong>: ${e.libelle}<br>
                    <span style="color:#ef4444;">D:${e.debit.compte} ${e.debit.nom}</span> |
                    <span style="color:#10b981;">C:${e.credit.compte} ${e.credit.nom}</span>
                    <span style="float:right;">${e.debit.euro}‚Ç¨ ${e.debit.espoyr}#</span>
                </div>
            `).join('');
            
            showModal(`
                <h3>üìí Journal Comptable</h3>
                <p style="font-size: 0.8rem; color: var(--gray);">${COMPTABILITE.journal.length} √©critures au total</p>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${rows || '<p style="color: var(--gray);">Aucune √©criture</p>'}
                </div>
            `, `
                <button class="btn" style="background:#dbeafe; color:#2563eb;" onclick="exportJournalCSV()">üì• Export CSV</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `);
        }
        
        function showBilanModal() {
            // Calculer le bilan actuel
            const bilan = calculerBilan();
            
            // Comparaison avec le bilan pr√©c√©dent
            const bilanPrecedent = historiqueBilans.length > 0 ? historiqueBilans[historiqueBilans.length - 1] : null;
            const comparaison = comparerBilans(bilan, bilanPrecedent);
            
            const players = Object.values(playersData);
            
            // G√©n√©rer les lignes joueurs
            const playerRows = players.map(p => {
                const bj = bilan.bilansJoueurs[p.id] || {};
                const euro = bj.actif?.euro || 0;
                const espoyr = bj.actif?.espoyr || 0;
                const activites = bj.actif?.activites || 0;
                const dette = bj.passif?.emprunt || 0;
                const net = bj.net || 0;
                
                return `
                    <tr>
                        <td>${p.avatar} ${p.name}</td>
                        <td class="actif">${euro}‚Ç¨</td>
                        <td class="actif">${espoyr}#</td>
                        <td class="actif">${activites}‚Ç¨</td>
                        <td class="passif">${dette}‚Ç¨</td>
                        <td style="font-weight:bold;">${net}‚Ç¨</td>
                    </tr>
                `;
            }).join('');
            
            // Tendance et comparaison
            const tendanceHtml = comparaison ? `
                <div style="background: #f0fdf4; padding: 8px; border-radius: 6px; margin-bottom: 10px;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        ${comparaison.tendance} <strong>Score √©conomique:</strong> ${bilan.scoreEconomique}
                        <span style="color: ${comparaison.deltaScore >= 0 ? '#059669' : '#dc2626'};">
                            (${comparaison.deltaScore >= 0 ? '+' : ''}${comparaison.deltaScore} depuis tour ${bilanPrecedent.tour})
                        </span>
                    </p>
                    <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6b7280;">
                        ‚Ç¨ ${comparaison.deltaEuro >= 0 ? '+' : ''}${comparaison.deltaEuro} | 
                        # ${comparaison.deltaEspoyr >= 0 ? '+' : ''}${comparaison.deltaEspoyr} | 
                        Activit√©s ${comparaison.deltaActivites >= 0 ? '+' : ''}${comparaison.deltaActivites} | 
                        Dettes ${comparaison.deltaEmprunts >= 0 ? '+' : ''}${comparaison.deltaEmprunts}
                    </p>
                </div>
            ` : `
                <div style="background: #f0fdf4; padding: 8px; border-radius: 6px; margin-bottom: 10px;">
                    <p style="margin: 0; font-size: 0.9rem;">
                        üìä <strong>Score √©conomique:</strong> ${bilan.scoreEconomique}
                    </p>
                </div>
            `;
            
            const bilanBanque = `
                <tr>
                    <td colspan="6" style="background:#f3f4f6;"><strong>üè¶ Banque</strong></td>
                </tr>
                <tr>
                    <td>Cr√©ances</td>
                    <td class="actif" colspan="2">${bilan.bilanBanque.actif.creancesJoueurs}‚Ç¨</td>
                    <td>Masse ‚Ç¨</td>
                    <td class="passif" colspan="2">${bilan.bilanBanque.passif.masseMonetaire}‚Ç¨</td>
                </tr>
                ${bilan.bilanBanque.reductionValeur > 0 ? `
                <tr>
                    <td style="font-size: 0.8rem; color: #dc2626;">RDV (pertes)</td>
                    <td class="passif" colspan="2" style="font-size: 0.8rem;">-${bilan.bilanBanque.reductionValeur}‚Ç¨</td>
                    <td style="font-size: 0.8rem;">Cr√©ances nettes</td>
                    <td colspan="2" style="font-size: 0.8rem;">${bilan.bilanBanque.actif.creancesNettes}‚Ç¨</td>
                </tr>
                ` : ''}
            `;
            
            const bilanAAA = `
                <tr>
                    <td colspan="6" style="background:#dcfce7;"><strong>üíö Pot AAA (${bilan.bilanAAA.membres} membres)</strong></td>
                </tr>
                <tr>
                    <td>Solde</td>
                    <td class="actif" colspan="2">${bilan.bilanAAA.passif.solde}#</td>
                    <td># en circulation</td>
                    <td colspan="2">${bilan.bilanAAA.circulationHash}#</td>
                </tr>
            `;
            
            const bilanEtat = `
                <tr>
                    <td colspan="6" style="background:#f3e8ff;"><strong>üèõÔ∏è √âtat</strong></td>
                </tr>
                <tr>
                    <td>Tr√©sor</td>
                    <td class="actif" colspan="2">${bilan.bilanEtat.actif.tresor}‚Ç¨</td>
                    <td>Taxes re√ßues</td>
                    <td colspan="2">${bilan.bilanEtat.taxesRecues}‚Ç¨</td>
                </tr>
                <tr>
                    <td style="font-size: 0.8rem;">Salaires vers√©s</td>
                    <td colspan="5" style="font-size: 0.8rem;">${bilan.bilanEtat.salairesVerses || 0}‚Ç¨</td>
                </tr>
            `;
            
            const bilanExport = `
                <tr>
                    <td colspan="6" style="background:#fef9c3;"><strong>üåç Exportation</strong></td>
                </tr>
                <tr>
                    <td>Solde</td>
                    <td class="${bilan.bilanExportation?.solde >= 0 ? 'actif' : 'passif'}" colspan="2">
                        ${bilan.bilanExportation?.solde || 0}‚Ç¨
                    </td>
                    <td>Recettes</td>
                    <td colspan="2">${bilan.bilanExportation?.recettes || 0}‚Ç¨</td>
                </tr>
                <tr>
                    <td style="font-size: 0.8rem;">Salaires vers√©s</td>
                    <td colspan="5" style="font-size: 0.8rem;">${bilan.bilanExportation?.salairesVerses || 0}‚Ç¨</td>
                </tr>
            `;
            
            // V√©rification √©quilibre
            const equilibreHtml = Math.abs(bilan.equilibre) > 1 ? 
                `<p style="color: #dc2626; font-size: 0.8rem;">‚ö†Ô∏è D√©s√©quilibre: ${bilan.equilibre}‚Ç¨</p>` : 
                `<p style="color: #059669; font-size: 0.8rem;">‚úÖ Bilan √©quilibr√©</p>`;
            
            showModal(`
                <h3>üìä Bilan √âconomique - Tour ${bilan.tour}</h3>
                ${tendanceHtml}
                <table class="bilan-table">
                    <thead>
                        <tr>
                            <th>Joueur</th>
                            <th>Caisse ‚Ç¨</th>
                            <th>Caisse #</th>
                            <th>Activit√©s</th>
                            <th>Dette</th>
                            <th>Net</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${playerRows}
                        <tr class="total">
                            <td>TOTAL</td>
                            <td>${bilan.actif.caisseEuro}‚Ç¨</td>
                            <td>${bilan.actif.caisseEspoyr}#</td>
                            <td>${bilan.actif.activites}‚Ç¨</td>
                            <td>${bilan.passif.emprunts}‚Ç¨</td>
                            <td>${bilan.actif.total - bilan.passif.emprunts}‚Ç¨</td>
                        </tr>
                        ${bilanBanque}
                        ${bilanAAA}
                        ${bilanEtat}
                        ${bilanExport}
                    </tbody>
                </table>
                ${equilibreHtml}
                <p style="font-size: 0.75rem; color: #9ca3af;">${bilan.nbEcritures} √©critures comptables</p>
            `, `
                <button class="btn btn-primary" onclick="enregistrerBilanTour(); closeModal();">üì∏ Sauver</button>
                <button class="btn" style="background:#fef3c7; color:#92400e;" onclick="exportBilanCSV()">üì• CSV</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            `);
        }
        
        // ========== POT AAA ==========
        function showAAAModal() {
            const isMembre = COMPTABILITE.potAAA.membres?.includes(myPlayerId);
            const myEspoyr = COMPTABILITE.caisseJoueurs[myPlayerId]?.espoyr || 0;
            const maCreance = COMPTABILITE.potAAA.creances?.[myPlayerId] || 0;
            const potAAA = COMPTABILITE.potAAA || {};
            
            // Journal du Pot AAA (5 derni√®res √©critures)
            const journalAAA = (potAAA.journal || []).slice(-5).reverse();
            const journalHtml = journalAAA.length > 0 ? 
                journalAAA.map(e => `<tr><td style="font-size:0.7rem;">#${e.id}</td><td style="font-size:0.7rem;">${e.libelle}</td><td style="font-size:0.7rem;">${e.debit?.montantEspoyr || e.credit?.montantEspoyr || 0}#</td></tr>`).join('') :
                '<tr><td colspan="3" style="font-size:0.7rem; color:#9ca3af;">Aucune √©criture</td></tr>';
            
            // Liste des cr√©ances
            const creances = Object.entries(potAAA.creances || {});
            const totalCreances = creances.reduce((s, [_, v]) => s + v, 0);
            
            showModal(`
                <h3>üíö Pot AAA (Aide Amicale Autonome)</h3>
                
                <div style="background:#dcfce7; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0; font-weight:bold;">üìä Bilan du Pot AAA</p>
                    <table style="width:100%; font-size:0.85rem; margin-top:8px;">
                        <tr>
                            <td><strong>ACTIF</strong></td>
                            <td><strong>PASSIF</strong></td>
                        </tr>
                        <tr>
                            <td>48 - Cr√©ances : ${totalCreances}#</td>
                            <td>135 - Fonds : ${potAAA.solde || 0}#</td>
                        </tr>
                        <tr>
                            <td>580 - Caisse : ${potAAA.solde || 0}#</td>
                            <td></td>
                        </tr>
                        <tr style="border-top:1px solid #ccc;">
                            <td colspan="2"># en circulation : ${potAAA.circulationHash || 0}#</td>
                        </tr>
                        <tr>
                            <td colspan="2">Membres : ${potAAA.membres?.length || 0}</td>
                        </tr>
                    </table>
                </div>
                
                <div style="background:#f3f4f6; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0 0 5px 0; font-weight:bold;">üìí Journal (5 derni√®res)</p>
                    <table style="width:100%; border-collapse:collapse;">
                        ${journalHtml}
                    </table>
                </div>
                
                <hr style="margin: 10px 0;">
                ${!isMembre ? `
                    <p>‚ùå Tu n'es pas membre.</p>
                    <p style="font-size:0.9rem;">Adh√®re pour :</p>
                    <ul style="font-size:0.85rem; margin:5px 0;">
                        <li>Cotiser des # et recevoir des bonus</li>
                        <li>Emprunter des # sans int√©r√™ts</li>
                        <li>B√©n√©ficier de l'aide en cas de faillite</li>
                    </ul>
                ` : `
                    <p>‚úÖ <strong>Tu es membre</strong></p>
                    <p>Ton solde # : <strong>${myEspoyr}#</strong></p>
                    ${maCreance > 0 ? `<p style="color:var(--orange);">Cr√©dit en cours : ${maCreance}#</p>` : ''}
                    <div style="display: flex; gap: 10px; margin: 10px 0;">
                        <input type="number" id="aaaAmount" min="1" max="100" value="10" placeholder="Montant #">
                    </div>
                `}
            `, `
                ${!isMembre ? `<button class="btn btn-primary" onclick="joinAAA()">üíö Adh√©rer</button>` : `
                    <button class="btn btn-primary" onclick="contributeAAA()">‚¨ÜÔ∏è Cotiser</button>
                    <button class="btn btn-secondary" onclick="creditAAA()">‚¨áÔ∏è Emprunter</button>
                `}
                <button class="btn" style="background:#f3f4f6;" onclick="closeModal()">Fermer</button>
            `);
        }
        
        async function joinAAA() {
            COMPTABILITE.potAAA.membres = COMPTABILITE.potAAA.membres || [];
            if (!COMPTABILITE.potAAA.membres.includes(myPlayerId)) {
                COMPTABILITE.potAAA.membres.push(myPlayerId);
            }
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/membreAAA`).set(true);
            await syncComptabiliteToFirebase();
            
            closeModal();
            sendSystemMessage(`üíö ${myName} rejoint le Pot AAA !`);
            showAAAModal();
        }
        
        async function contributeAAA() {
            const amount = parseInt(document.getElementById('aaaAmount').value) || 0;
            if (amount <= 0) return;
            
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            if ((caisse?.espoyr || 0) < amount) {
                alert('Pas assez de # !');
                return;
            }
            
            await comptaCotisationAAA(myPlayerId, amount);
            
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(caisse.espoyr);
            await syncComptabiliteToFirebase();
            
            closeModal();
            sendSystemMessage(`üíö ${myName} cotise ${amount}# au Pot AAA`);
            showAAAModal();
        }
        
        async function creditAAA() {
            const amount = parseInt(document.getElementById('aaaAmount').value) || 0;
            if (amount <= 0) return;
            
            if (COMPTABILITE.potAAA.solde < amount) {
                alert('Pas assez dans le pot !');
                return;
            }
            
            await comptaCreditAAA(myPlayerId, amount);
            
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(caisse.espoyr);
            await syncComptabiliteToFirebase();
            
            closeModal();
            sendSystemMessage(`üíö ${myName} emprunte ${amount}# au Pot AAA`);
            showAAAModal();
        }
        
        // ========== BANQUE ==========
        function showBankModal() {
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const dette = caisse.emprunt || 0;
            
            // Limite emprunt
            const players = Object.values(playersData);
            const masseMonetaire = Object.values(COMPTABILITE.caisseJoueurs).reduce((s, c) => s + (c.euro || 0), 0);
            const limiteCalculee = Math.max(CONFIG.limiteEmpruntMin, Math.floor(masseMonetaire / players.length));
            const disponible = Math.max(0, limiteCalculee - dette);
            
            // Bilan comptable de la banque
            const banque = COMPTABILITE.banque || {};
            const reductionValeur = banque.reductionValeur || 0;
            const creancesNettes = (banque.creancesJoueurs || 0) - reductionValeur;
            
            // Journal bancaire (5 derni√®res √©critures)
            const journalBanque = (banque.journal || []).slice(-5).reverse();
            const journalHtml = journalBanque.length > 0 ? 
                journalBanque.map(e => `<tr><td style="font-size:0.7rem;">#${e.id}</td><td style="font-size:0.7rem;">${e.libelle}</td><td style="font-size:0.7rem;">${e.debit?.montantEuro || 0}‚Ç¨</td></tr>`).join('') :
                '<tr><td colspan="3" style="font-size:0.7rem; color:#9ca3af;">Aucune √©criture</td></tr>';
            
            showModal(`
                <h3>üè¶ Banque - Plan Comptable</h3>
                
                <div style="background:#fee2e2; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0; font-weight:bold;">üìä Bilan Bancaire</p>
                    <table style="width:100%; font-size:0.85rem; margin-top:8px;">
                        <tr>
                            <td><strong>ACTIF</strong></td>
                            <td><strong>PASSIF</strong></td>
                        </tr>
                        <tr>
                            <td>291 - Cr√©ances : ${banque.creancesJoueurs || 0}‚Ç¨</td>
                            <td>489 - D√©p√¥ts : ${banque.masseMonetaire || 0}‚Ç¨</td>
                        </tr>
                        ${reductionValeur > 0 ? `
                        <tr>
                            <td style="color:#dc2626;">2919 - RDV : -${reductionValeur}‚Ç¨</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><em>Net : ${creancesNettes}‚Ç¨</em></td>
                            <td></td>
                        </tr>
                        ` : ''}
                        <tr style="border-top:1px solid #ccc;">
                            <td colspan="2">650 - Int√©r√™ts re√ßus : ${banque.interetsRecus || 0}‚Ç¨</td>
                        </tr>
                    </table>
                </div>
                
                <div style="background:#f3f4f6; padding:10px; border-radius:8px; margin-bottom:10px;">
                    <p style="margin:0 0 5px 0; font-weight:bold;">üìí Journal (5 derni√®res)</p>
                    <table style="width:100%; border-collapse:collapse;">
                        ${journalHtml}
                    </table>
                </div>
                
                <hr style="margin: 10px 0;">
                <p style="font-weight:bold;">üí≥ Ton compte</p>
                <p><strong>Ta dette :</strong> ${dette}‚Ç¨</p>
                <p><strong>Limite d'emprunt :</strong> ${limiteCalculee}‚Ç¨</p>
                <p style="font-size: 0.8rem; color: var(--gray);">= max(${CONFIG.limiteEmpruntMin}‚Ç¨, ${masseMonetaire}‚Ç¨ √∑ ${players.length})</p>
                <p><strong style="color: ${disponible > 0 ? 'var(--green)' : 'var(--red)'};">Disponible : ${disponible}‚Ç¨</strong></p>
                ${disponible > 0 ? `
                    <label>Montant √† emprunter :</label>
                    <input type="number" id="bankLoanAmount" min="10" max="${disponible}" value="${Math.min(100, disponible)}" step="10">
                    <p style="font-size: 0.8rem; color: var(--orange);">‚ö†Ô∏è Int√©r√™ts : ${CONFIG.tauxInteret * 100}% par tour</p>
                ` : `<p style="color: var(--red);">‚ùå Limite atteinte</p>`}
                ${dette > 0 && (caisse.euro || 0) > 0 ? `
                    <hr style="margin: 10px 0;">
                    <label>Rembourser :</label>
                    <input type="number" id="bankRepayAmount" min="10" max="${Math.min(dette, caisse.euro || 0)}" value="${Math.min(dette, caisse.euro || 0)}" step="10">
                ` : ''}
            `, `
                ${disponible > 0 ? `<button class="btn btn-primary" onclick="takeBankLoan()">üí∞ Emprunter</button>` : ''}
                ${dette > 0 && (caisse.euro || 0) > 0 ? `<button class="btn btn-secondary" onclick="repayBankLoan()">üí∏ Rembourser</button>` : ''}
                <button class="btn" style="background:#f3f4f6;" onclick="closeModal()">Fermer</button>
            `);
        }
        
        async function takeBankLoan() {
            const amount = parseInt(document.getElementById('bankLoanAmount').value) || 0;
            if (amount <= 0) return;
            
            await comptaEmprunt(myPlayerId, amount);
            
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, emprunt: caisse.emprunt
            });
            await syncComptabiliteToFirebase();
            
            closeModal();
            sendSystemMessage(`üè¶ ${myName} emprunte ${amount}‚Ç¨`);
        }
        
        async function repayBankLoan() {
            const amount = parseInt(document.getElementById('bankRepayAmount').value) || 0;
            if (amount <= 0) return;
            
            await comptaRemboursement(myPlayerId, amount);
            
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, emprunt: caisse.emprunt
            });
            await syncComptabiliteToFirebase();
            
            closeModal();
            sendSystemMessage(`üí∏ ${myName} rembourse ${amount}‚Ç¨`);
        }
        
        // ========== INFO CASE ==========
        async function showCaseInfo(caseId) {
            const c = CASES[caseId];
            if (!c || c.type !== 'activite') {
                showModal(`<h3>${c.icon} ${c.name}</h3><p>${c.type}</p>`,
                    `<button class="btn btn-secondary" onclick="closeModal()">Fermer</button>`);
                return;
            }
            
            const activitesSnap = await gameRef.child('activites').once('value');
            const activites = activitesSnap.val() || {};
            const equipSnap = await gameRef.child('equipements').once('value');
            const equipements = equipSnap.val() || {};
            
            const owner = activites[caseId];
            const nbEquip = equipements[caseId] || 0;
            const factureActuelle = c.facture * (nbEquip === 2 ? 2 : 1);
            const caisseAct = COMPTABILITE.caisseActivites[caseId] || {};
            
            const players = Object.values(playersData);
            const ownerPlayer = owner ? players.find(p => p.id === owner) : null;
            const isMine = owner === myPlayerId;
            
            let content = `
                <h3>${c.icon} ${c.name}</h3>
                <p><strong>Prix :</strong> ${c.prix}‚Ç¨</p>
                <p><strong>Facture base :</strong> ${c.facture}‚Ç¨</p>
                <p><strong>√âquipements :</strong> ${nbEquip}/2 ${'‚öôÔ∏è'.repeat(nbEquip)}</p>
                <p><strong>Facture actuelle :</strong> ${factureActuelle}‚Ç¨ ${nbEquip === 2 ? '(√ó2)' : ''}</p>
                <hr style="margin: 10px 0;">
                <p><strong>Caisse activit√© :</strong> ${caisseAct.euro || 0}‚Ç¨ / ${caisseAct.espoyr || 0}#</p>
                <p><strong>Recettes totales :</strong> ${caisseAct.recettes || 0}</p>
            `;
            
            if (ownerPlayer) {
                content += `<p><strong>Propri√©taire :</strong> ${ownerPlayer.avatar} ${ownerPlayer.name}</p>`;
            } else {
                content += `<p style="color: var(--orange);">üè∑Ô∏è Disponible</p>`;
            }
            
            // Boutons de vente si c'est ma propri√©t√©
            let buttons = `<button class="btn btn-secondary" onclick="closeModal()">Fermer</button>`;
            
            if (isMine) {
                // Bouton vente √©quipement si il y a des √©quipements
                if (nbEquip > 0) {
                    buttons = `
                        <button class="btn" style="background:#dcfce7;color:#059669;" onclick="closeModal(); showVenteEquipementModal(${caseId});">üíö Vendre √©quipement</button>
                        ${buttons}
                    `;
                }
                
                // Bouton vente activit√© (si pas d'√©quipement et pas la derni√®re)
                const check = canSellActivity(myPlayerId, caseId);
                if (check.canSell) {
                    buttons = `
                        <button class="btn" style="background:#fee2e2;color:#dc2626;" onclick="closeModal(); showVenteActiviteModal(${caseId});">üè∑Ô∏è Vendre activit√©</button>
                        ${buttons}
                    `;
                }
            }
            
            showModal(content, buttons);
        }
        
        // ========== SAUVEGARDE ==========
        // ========== SAUVEGARDE COMPL√àTE AUDIT + REPLAY ==========
        
        // Construire l'√©tat complet du jeu
        function buildGameState() {
            const players = Object.values(playersData);
            const positions = {};
            const playersState = {};
            
            players.forEach(p => {
                positions[p.id] = p.position;
                const caisse = COMPTABILITE.caisseJoueurs[p.id] || {};
                playersState[p.id] = {
                    name: p.name,
                    avatar: p.avatar,
                    profil: p.profil || 'contributif',
                    isBot: p.isBot || false,
                    botProfil: p.botProfil || null,
                    wallet: { 
                        euro: caisse.euro || 0, 
                        espoyr: caisse.espoyr || 0 
                    },
                    debts: { 
                        bankEuro: caisse.emprunt || 0, 
                        potAAAEspoyr: COMPTABILITE.potAAA.creances?.[p.id] || 0 
                    },
                    assets: {
                        activities: Object.entries(COMPTABILITE.caisseActivites)
                            .filter(([id, act]) => act.proprietaireId === p.id)
                            .map(([id]) => id),
                        equipments: []  // √Ä remplir
                    },
                    membreAAA: COMPTABILITE.potAAA.membres?.includes(p.id) || false
                };
            });
            
            return {
                turn: gameState?.turn || 1,
                phase: gameState?.phase || 1,
                currentPlayerIndex: gameState?.currentPlayerIndex || 0,
                toursComplets: gameState?.toursComplets || 0,
                board: { positions },
                players: playersState,
                entities: {
                    etat: { 
                        soldeEuro: COMPTABILITE.etat.tresor || 0, 
                        taxesRecues: COMPTABILITE.etat.taxesRecues || 0, 
                        salairesVerses: COMPTABILITE.etat.salairesVerses || 0 
                    },
                    exportation: { 
                        soldeEuro: COMPTABILITE.exportation?.solde || 0, 
                        recettes: COMPTABILITE.exportation?.recettes || 0, 
                        salairesVerses: COMPTABILITE.exportation?.salairesVerses || 0 
                    },
                    potAAA: { 
                        soldeEspoyr: COMPTABILITE.potAAA.solde || 0, 
                        circulationHash: COMPTABILITE.potAAA.circulationHash || 0, 
                        membres: COMPTABILITE.potAAA.membres || [] 
                    },
                    banque: { 
                        creancesJoueursEuro: COMPTABILITE.banque.creancesJoueurs || 0, 
                        interetsRecusEuro: COMPTABILITE.banque.interetsRecus || 0,
                        masseMonetaire: COMPTABILITE.banque.masseMonetaire || 0,
                        reductionValeur: COMPTABILITE.banque.reductionValeur || 0
                    }
                },
                markets: {
                    auctions: enchereEnCours ? [enchereEnCours] : [],
                    forSale: []
                }
            };
        }
        
        // Valider le ledger (toutes les √©critures √©quilibr√©es)
        function validateLedger() {
            const errors = [];
            
            GAME_SAVE.ledger.forEach(entry => {
                const totalDebit = entry.debit.reduce((sum, d) => sum + d.amount, 0);
                const totalCredit = entry.credit.reduce((sum, c) => sum + c.amount, 0);
                
                if (totalDebit !== totalCredit) {
                    errors.push({
                        ledgerEntryId: entry.ledgerEntryId,
                        error: `D√©s√©quilibre: D=${totalDebit} C=${totalCredit}`,
                        currency: entry.currency
                    });
                }
            });
            
            return { valid: errors.length === 0, errors };
        }
        
        // Exporter la sauvegarde compl√®te
        async function saveGame() {
            // Mettre √† jour l'√©tat
            GAME_SAVE.gameId = `ESPOYR_${currentGameCode}`;
            GAME_SAVE.lastSavedAt = new Date().toISOString();
            if (!GAME_SAVE.createdAt) GAME_SAVE.createdAt = GAME_SAVE.lastSavedAt;
            
            // Construire l'√©tat actuel
            GAME_SAVE.state = buildGameState();
            
            // Cr√©er un snapshot
            createSnapshot();
            
            // Valider le ledger
            const validation = validateLedger();
            if (!validation.valid) {
                console.warn('‚ö†Ô∏è Ledger non √©quilibr√©:', validation.errors);
            }
            
            // R√©cup√©rer les donn√©es Firebase
            const gameSnap = await gameRef.once('value');
            const firebaseData = gameSnap.val();
            
            // Construire la sauvegarde compl√®te
            const saveData = {
                schemaVersion: SCHEMA_VERSION,
                gameId: GAME_SAVE.gameId,
                createdAt: GAME_SAVE.createdAt,
                lastSavedAt: GAME_SAVE.lastSavedAt,
                
                rng: GAME_SAVE.rng,
                
                state: GAME_SAVE.state,
                
                events: GAME_SAVE.events,
                eventCounter: GAME_SAVE.eventCounter,
                
                ledger: GAME_SAVE.ledger,
                ledgerCounter: GAME_SAVE.ledgerCounter,
                
                snapshots: GAME_SAVE.snapshots,
                
                indexes: GAME_SAVE.indexes,
                
                // Donn√©es brutes Firebase (backup)
                firebase: {
                    code: currentGameCode,
                    data: firebaseData
                },
                
                // Comptabilit√© d√©taill√©e
                comptabilite: COMPTABILITE,
                
                // Config
                config: gameConfig,
                
                // Validation
                validation: validation
            };
            
            const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ESPOYR_${currentGameCode}_T${gameState?.turn || 1}_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            sendSystemMessage(`üíæ Sauvegarde compl√®te par ${myName} (${GAME_SAVE.events.length} events, ${GAME_SAVE.ledger.length} √©critures)`);
        }
        
        // Charger une sauvegarde
        async function loadGameFromFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const saveData = JSON.parse(e.target.result);
                        
                        // V√©rifier la version
                        if (saveData.schemaVersion && saveData.schemaVersion !== SCHEMA_VERSION) {
                            console.warn(`‚ö†Ô∏è Version diff√©rente: ${saveData.schemaVersion} vs ${SCHEMA_VERSION}`);
                        }
                        
                        // Restaurer GAME_SAVE
                        if (saveData.events) GAME_SAVE.events = saveData.events;
                        if (saveData.ledger) GAME_SAVE.ledger = saveData.ledger;
                        if (saveData.snapshots) GAME_SAVE.snapshots = saveData.snapshots;
                        if (saveData.indexes) GAME_SAVE.indexes = saveData.indexes;
                        if (saveData.rng) GAME_SAVE.rng = saveData.rng;
                        if (saveData.eventCounter) GAME_SAVE.eventCounter = saveData.eventCounter;
                        if (saveData.ledgerCounter) GAME_SAVE.ledgerCounter = saveData.ledgerCounter;
                        GAME_SAVE.gameId = saveData.gameId;
                        GAME_SAVE.createdAt = saveData.createdAt;
                        
                        // Restaurer la comptabilit√©
                        if (saveData.comptabilite) {
                            COMPTABILITE = saveData.comptabilite;
                            normalizeComptabilite();
                        }
                        
                        // Restaurer la config
                        if (saveData.config) {
                            gameConfig = { ...CONFIG, ...saveData.config };
                        }
                        
                        resolve(saveData);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        
        // Reprendre √† partir d'un eventId
        function replayFromEvent(targetEventId) {
            const snapshot = findSnapshotBefore(targetEventId);
            if (!snapshot) {
                console.error('Aucun snapshot trouv√© avant', targetEventId);
                return false;
            }
            
            // Restaurer l'√©tat du snapshot
            const state = snapshot.state;
            gameState = state.gameState;
            playersData = state.playersData;
            COMPTABILITE = state.COMPTABILITE;
            gameConfig = state.gameConfig;
            normalizeComptabilite();
            
            // Trouver les events √† rejouer
            const snapshotEventIndex = GAME_SAVE.events.findIndex(e => e.eventId === snapshot.eventCursor);
            const targetEventIndex = GAME_SAVE.events.findIndex(e => e.eventId === targetEventId);
            
            console.log(`üìº Replay depuis snapshot ${snapshot.snapshotId} (event ${snapshotEventIndex}) jusqu'√† ${targetEventId} (event ${targetEventIndex})`);
            
            // Note: Le replay r√©el n√©cessiterait d'ex√©cuter les actions
            // Pour l'instant, on restaure juste l'√©tat du snapshot
            
            return true;
        }
        
        // ========== ACTIONS RAPIDES ==========
        
        // Action rapide : Adh√©rer au Pot AAA
        function showQuickAdhererAAA() {
            const isMembre = COMPTABILITE.potAAA.membres?.includes(myPlayerId);
            
            if (isMembre) {
                showModal(`
                    <h3>üíö D√©j√† membre du Pot AAA</h3>
                    <p>Tu es d√©j√† membre du Pot AAA !</p>
                    <p>Avantages actifs :</p>
                    <ul style="font-size: 0.9rem;">
                        <li>+50# cr√©√©s dans le Pot √† chaque lancer de d√©</li>
                        <li>Emprunter en # sans int√©r√™ts</li>
                        <li>Aide en cas de faillite</li>
                    </ul>
                `, `<button class="btn btn-primary" onclick="closeModal()">OK</button>`);
            } else {
                showModal(`
                    <h3>üíö Adh√©rer au Pot AAA</h3>
                    <p>Devenir membre te donne acc√®s √† :</p>
                    <ul style="font-size: 0.9rem;">
                        <li>‚ú® +50# cr√©√©s dans le Pot √† chaque lancer de d√©</li>
                        <li>üíµ Emprunter en # sans int√©r√™ts</li>
                        <li>üõü Aide en cas de faillite (dette annul√©e + 250#)</li>
                    </ul>
                    <p style="margin-top: 10px; color: #059669; font-weight: bold;">Adh√©sion gratuite !</p>
                `, `
                    <button class="btn btn-primary" onclick="adhererPotAAA()">üíö Adh√©rer maintenant</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Plus tard</button>
                `);
            }
        }
        
        async function adhererPotAAA() {
            closeModal();
            
            if (!COMPTABILITE.potAAA.membres) COMPTABILITE.potAAA.membres = [];
            if (!COMPTABILITE.potAAA.membres.includes(myPlayerId)) {
                COMPTABILITE.potAAA.membres.push(myPlayerId);
                await syncComptabiliteToFirebase();
                
                logEvent('JOIN_AAA', myPlayerId, {});
                
                sendSystemMessage(`üíö ${myName} a rejoint le Pot AAA !`);
                showModal(`<h3>üéâ Bienvenue !</h3><p>Tu es maintenant membre du Pot AAA.</p>`,
                    `<button class="btn btn-primary" onclick="closeModal()">Super !</button>`);
            }
        }
        
        // Action rapide : Emprunter
        function showQuickEmprunter() {
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const players = Object.values(playersData);
            const masse = Object.values(COMPTABILITE.caisseJoueurs).reduce((sum, c) => sum + (c.euro || 0), 0);
            const limiteEmprunt = Math.max(CONFIG.limiteEmpruntMin, Math.floor(masse / players.length));
            const empruntActuel = caisse.emprunt || 0;
            const capacite = Math.max(0, limiteEmprunt - empruntActuel);
            
            const isMembre = COMPTABILITE.potAAA.membres?.includes(myPlayerId);
            const potSolde = COMPTABILITE.potAAA.solde || 0;
            
            showModal(`
                <h3>üí∂ Emprunter</h3>
                
                <div style="background: #fee2e2; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <p style="margin: 0; font-weight: bold;">üè¶ Banque (en ‚Ç¨)</p>
                    <p style="margin: 4px 0 0 0;">Limite : ${limiteEmprunt}‚Ç¨ | Dette actuelle : ${empruntActuel}‚Ç¨</p>
                    <p style="margin: 4px 0 0 0; color: #dc2626;">Capacit√© : ${capacite}‚Ç¨</p>
                    <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #6b7280;">Int√©r√™ts : ${CONFIG.tauxInteret * 100}% par tour</p>
                    ${capacite > 0 ? `
                        <input type="number" id="empruntEuroMontant" value="${Math.min(100, capacite)}" min="10" max="${capacite}" step="10" style="width: 100%; padding: 6px; margin-top: 8px;">
                        <button class="btn" style="background: #fee2e2; color: #dc2626; width: 100%; margin-top: 6px;" onclick="executeEmprunterEuro()">Emprunter ‚Ç¨</button>
                    ` : '<p style="color: #dc2626; margin-top: 6px;">‚ùå Capacit√© √©puis√©e</p>'}
                </div>
                
                ${isMembre ? `
                <div style="background: #dcfce7; padding: 10px; border-radius: 8px;">
                    <p style="margin: 0; font-weight: bold;">üíö Pot AAA (en #)</p>
                    <p style="margin: 4px 0 0 0;">Solde du Pot : ${potSolde}#</p>
                    <p style="margin: 4px 0 0 0; color: #059669; font-size: 0.8rem;">Sans int√©r√™ts !</p>
                    ${potSolde > 0 ? `
                        <input type="number" id="empruntHashMontant" value="${Math.min(100, potSolde)}" min="10" max="${potSolde}" step="10" style="width: 100%; padding: 6px; margin-top: 8px;">
                        <button class="btn" style="background: #dcfce7; color: #059669; width: 100%; margin-top: 6px;" onclick="executeEmprunterHash()">Emprunter #</button>
                    ` : '<p style="color: #059669; margin-top: 6px;">Pot vide</p>'}
                </div>
                ` : `
                <div style="background: #f3f4f6; padding: 10px; border-radius: 8px;">
                    <p style="margin: 0; color: #6b7280;">üí° Adh√®re au Pot AAA pour emprunter en # sans int√©r√™ts !</p>
                </div>
                `}
            `, `<button class="btn btn-secondary" onclick="closeModal()">Fermer</button>`);
        }
        
        async function executeEmprunterEuro() {
            const montant = parseInt(document.getElementById('empruntEuroMontant').value) || 0;
            if (montant <= 0) return;
            
            closeModal();
            await comptaEmprunt(myPlayerId, montant);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, emprunt: caisse.emprunt
            });
            await syncComptabiliteToFirebase();
            
            logEvent('BANK_LOAN', myPlayerId, { montant, currency: 'EUR' });
            
            sendSystemMessage(`üè¶ ${myName} emprunte ${montant}‚Ç¨ √† la banque`);
        }
        
        async function executeEmprunterHash() {
            const montant = parseInt(document.getElementById('empruntHashMontant').value) || 0;
            if (montant <= 0) return;
            
            closeModal();
            await comptaEmpruntAAA(myPlayerId, montant);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(caisse.espoyr);
            await syncComptabiliteToFirebase();
            
            logEvent('AAA_LOAN', myPlayerId, { montant, currency: 'ESP' });
            
            sendSystemMessage(`üíö ${myName} emprunte ${montant}# au Pot AAA`);
        }
        
        // Action rapide : √âquiper
        async function showQuickEquiper() {
            const activitesSnap = await gameRef.child('activites').once('value');
            const activites = activitesSnap.val() || {};
            const equipSnap = await gameRef.child('equipements').once('value');
            const equipements = equipSnap.val() || {};
            
            // Trouver mes activit√©s
            const mesActivites = Object.entries(activites)
                .filter(([id, owner]) => owner === myPlayerId)
                .map(([id]) => parseInt(id));
            
            if (mesActivites.length === 0) {
                showModal(`<h3>üîß √âquiper</h3><p>Tu n'as pas encore d'activit√© √† √©quiper.</p>`,
                    `<button class="btn btn-secondary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const currentEuro = caisse.euro || 0;
            
            let html = `<h3>üîß √âquiper une activit√©</h3><p>Tu as : <strong>${currentEuro}‚Ç¨</strong></p>`;
            
            for (const actId of mesActivites) {
                const c = CASES[actId];
                const nbEquip = equipements[actId] || 0;
                
                if (nbEquip >= 2) {
                    html += `<div style="background: #f3f4f6; padding: 8px; border-radius: 6px; margin: 6px 0;">
                        <p style="margin: 0;">${c.icon} ${c.name} - <span style="color: #059669;">‚úÖ Complet (2/2)</span></p>
                    </div>`;
                } else {
                    const prixA = Math.floor(c.prixEquip * 1.2);
                    const prixB = Math.floor(c.prixEquip * 0.8);
                    const canA = currentEuro >= prixA;
                    const canB = currentEuro >= prixB;
                    
                    html += `<div style="background: #fef3c7; padding: 10px; border-radius: 6px; margin: 6px 0;">
                        <p style="margin: 0; font-weight: bold;">${c.icon} ${c.name} (${nbEquip}/2)</p>
                        <div style="display: flex; gap: 6px; margin-top: 8px;">
                            ${canA ? `<button class="btn" style="flex:1; background:#dcfce7; color:#059669; font-size:0.8rem;" onclick="buyEquipementA(${actId})">üåø A ${prixA}‚Ç¨</button>` : ''}
                            ${canB ? `<button class="btn" style="flex:1; background:#fee2e2; color:#dc2626; font-size:0.8rem;" onclick="buyEquipementB(${actId})">‚ö° B ${prixB}‚Ç¨</button>` : ''}
                            ${!canA && !canB ? `<p style="color:#dc2626; font-size:0.85rem;">Pas assez d'‚Ç¨</p>` : ''}
                        </div>
                    </div>`;
                }
            }
            
            showModal(html, `<button class="btn btn-secondary" onclick="closeModal()">Fermer</button>`);
        }
        
        // Action rapide : Vendre
        async function showQuickVendre() {
            const activitesSnap = await gameRef.child('activites').once('value');
            const activites = activitesSnap.val() || {};
            
            const mesActivites = Object.entries(activites)
                .filter(([id, owner]) => owner === myPlayerId)
                .map(([id]) => parseInt(id));
            
            if (mesActivites.length === 0) {
                showModal(`<h3>üè∑Ô∏è Vendre</h3><p>Tu n'as pas d'activit√© √† vendre.</p>`,
                    `<button class="btn btn-secondary" onclick="closeModal()">OK</button>`);
                return;
            }
            
            let html = `<h3>üè∑Ô∏è Vendre une activit√©</h3>
                <p style="font-size: 0.85rem; color: #6b7280;">Mets en vente aux ench√®res pour les autres joueurs.</p>`;
            
            for (const actId of mesActivites) {
                const c = CASES[actId];
                html += `<div style="background: #fef3c7; padding: 10px; border-radius: 6px; margin: 6px 0;">
                    <p style="margin: 0; font-weight: bold;">${c.icon} ${c.name}</p>
                    <p style="margin: 4px 0 0 0; font-size: 0.85rem;">Valeur : ${c.prix}‚Ç¨</p>
                    <button class="btn" style="width:100%; margin-top:8px; background:#f59e0b; color:white;" onclick="lancerEnchere(${actId})">üî® Mettre aux ench√®res</button>
                </div>`;
            }
            
            showModal(html, `<button class="btn btn-secondary" onclick="closeModal()">Fermer</button>`);
        }
        
        // Action rapide : Rembourser
        function showQuickRembourser() {
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId] || {};
            const dette = caisse.emprunt || 0;
            const detteAAA = COMPTABILITE.potAAA.creances?.[myPlayerId] || 0;
            const currentEuro = caisse.euro || 0;
            const currentHash = caisse.espoyr || 0;
            
            if (dette === 0 && detteAAA === 0) {
                showModal(`<h3>üí≥ Rembourser</h3><p>Tu n'as pas de dette √† rembourser ! üéâ</p>`,
                    `<button class="btn btn-primary" onclick="closeModal()">Super !</button>`);
                return;
            }
            
            showModal(`
                <h3>üí≥ Rembourser</h3>
                <p>Tu as : <strong>${currentEuro}‚Ç¨</strong> et <strong>${currentHash}#</strong></p>
                
                ${dette > 0 ? `
                <div style="background: #fee2e2; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <p style="margin: 0; font-weight: bold;">üè¶ Dette Banque : ${dette}‚Ç¨</p>
                    <input type="number" id="remboursEuroMontant" value="${Math.min(dette, currentEuro)}" min="0" max="${Math.min(dette, currentEuro)}" step="10" style="width: 100%; padding: 6px; margin-top: 8px;">
                    <button class="btn" style="background: #fee2e2; color: #dc2626; width: 100%; margin-top: 6px;" onclick="executeRemboursEuro()">Rembourser ‚Ç¨</button>
                </div>
                ` : ''}
                
                ${detteAAA > 0 ? `
                <div style="background: #dcfce7; padding: 10px; border-radius: 8px;">
                    <p style="margin: 0; font-weight: bold;">üíö Dette AAA : ${detteAAA}#</p>
                    <input type="number" id="remboursHashMontant" value="${Math.min(detteAAA, currentHash)}" min="0" max="${Math.min(detteAAA, currentHash)}" step="10" style="width: 100%; padding: 6px; margin-top: 8px;">
                    <button class="btn" style="background: #dcfce7; color: #059669; width: 100%; margin-top: 6px;" onclick="executeRemboursHash()">Rembourser #</button>
                </div>
                ` : ''}
            `, `<button class="btn btn-secondary" onclick="closeModal()">Fermer</button>`);
        }
        
        async function executeRemboursEuro() {
            const montant = parseInt(document.getElementById('remboursEuroMontant').value) || 0;
            if (montant <= 0) return;
            
            closeModal();
            await comptaRemboursement(myPlayerId, montant);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}`).update({
                euro: caisse.euro, emprunt: caisse.emprunt
            });
            await syncComptabiliteToFirebase();
            
            logEvent('REPAY_LOAN', myPlayerId, { montant, currency: 'EUR' });
            
            sendSystemMessage(`üí≥ ${myName} rembourse ${montant}‚Ç¨ √† la banque`);
        }
        
        async function executeRemboursHash() {
            const montant = parseInt(document.getElementById('remboursHashMontant').value) || 0;
            if (montant <= 0) return;
            
            closeModal();
            await comptaRemboursementAAA(myPlayerId, montant);
            const caisse = COMPTABILITE.caisseJoueurs[myPlayerId];
            await db.ref(`parties/${currentGameCode}/players/${myPlayerId}/espoyr`).set(caisse.espoyr);
            await syncComptabiliteToFirebase();
            
            logEvent('REPAY_AAA', myPlayerId, { montant, currency: 'ESP' });
            
            sendSystemMessage(`üíö ${myName} rembourse ${montant}# au Pot AAA`);
        }
        
        // Afficher le modal d'analyse de sauvegarde
        function showSaveAnalysisModal() {
            const validation = validateLedger();
            const nbEvents = GAME_SAVE.events.length;
            const nbLedger = GAME_SAVE.ledger.length;
            const nbSnapshots = GAME_SAVE.snapshots.length;
            
            // Statistiques par action
            const actionStats = {};
            GAME_SAVE.events.forEach(e => {
                actionStats[e.action] = (actionStats[e.action] || 0) + 1;
            });
            
            const actionStatsHtml = Object.entries(actionStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([action, count]) => `<tr><td>${action}</td><td>${count}</td></tr>`)
                .join('');
            
            showModal(`
                <h3>üìä Analyse de la sauvegarde</h3>
                
                <div style="background: #f3f4f6; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <p style="margin: 0;"><strong>Version:</strong> ${SCHEMA_VERSION}</p>
                    <p style="margin: 4px 0 0 0;"><strong>Game ID:</strong> ${GAME_SAVE.gameId || 'N/A'}</p>
                    <p style="margin: 4px 0 0 0;"><strong>Tour:</strong> ${gameState?.turn || 1}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div style="background: #dbeafe; padding: 10px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; font-size: 1.5rem; font-weight: bold;">${nbEvents}</p>
                        <p style="margin: 0; font-size: 0.8rem;">Events</p>
                    </div>
                    <div style="background: #dcfce7; padding: 10px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; font-size: 1.5rem; font-weight: bold;">${nbLedger}</p>
                        <p style="margin: 0; font-size: 0.8rem;">√âcritures</p>
                    </div>
                    <div style="background: #fef3c7; padding: 10px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; font-size: 1.5rem; font-weight: bold;">${nbSnapshots}</p>
                        <p style="margin: 0; font-size: 0.8rem;">Snapshots</p>
                    </div>
                    <div style="background: ${validation.valid ? '#dcfce7' : '#fee2e2'}; padding: 10px; border-radius: 8px; text-align: center;">
                        <p style="margin: 0; font-size: 1.5rem;">${validation.valid ? '‚úÖ' : '‚ùå'}</p>
                        <p style="margin: 0; font-size: 0.8rem;">Ledger</p>
                    </div>
                </div>
                
                <div style="background: #f3f4f6; padding: 10px; border-radius: 8px;">
                    <p style="margin: 0 0 8px 0; font-weight: bold;">Top 10 Actions:</p>
                    <table style="width: 100%; font-size: 0.8rem;">
                        ${actionStatsHtml || '<tr><td>Aucune action</td></tr>'}
                    </table>
                </div>
            `, `
                <button class="btn btn-primary" onclick="saveGame()">üíæ Sauvegarder</button>
                <button class="btn btn-secondary" onclick="exportEventsCSV()">üì• Events CSV</button>
                <button class="btn btn-secondary" onclick="exportLedgerCSV()">üì• Ledger CSV</button>
                <button class="btn" style="background:#f3f4f6;" onclick="closeModal()">Fermer</button>
            `);
        }
        
        // Export Events en CSV
        function exportEventsCSV() {
            const headers = ['eventId', 'timestamp', 'tour', 'phase', 'actorId', 'action', 'payload', 'ledgerEntryIds'];
            const rows = GAME_SAVE.events.map(e => [
                e.eventId,
                e.ts,
                e.turn,
                e.phase,
                e.actorId,
                e.action,
                JSON.stringify(e.payload),
                e.ledgerEntryIds.join(';')
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
            downloadCSV(csv, `ESPOYR_${currentGameCode}_events.csv`);
        }
        
        // Export Ledger en CSV
        function exportLedgerCSV() {
            const headers = ['ledgerEntryId', 'timestamp', 'tour', 'phase', 'currency', 'label', 'entityId', 'debitAccount', 'debitAmount', 'creditAccount', 'creditAmount'];
            const rows = GAME_SAVE.ledger.map(e => [
                e.ledgerEntryId,
                e.ts,
                e.turn,
                e.phase,
                e.currency,
                e.label,
                e.entity?.id || '',
                e.debit[0]?.account || '',
                e.debit[0]?.amount || 0,
                e.credit[0]?.account || '',
                e.credit[0]?.amount || 0
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
            downloadCSV(csv, `ESPOYR_${currentGameCode}_ledger.csv`);
        }
        
    </script>
</body>
</html>
